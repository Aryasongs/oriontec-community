<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional AI Voice Interviewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #2d3748;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 1000px;
            width: 100%;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .ai-avatar.speaking {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .ai-avatar.roasting {
            animation: roastShake 0.5s ease-in-out;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        @keyframes roastShake {
            0%, 100% { transform: rotate(0deg) scale(1.1); }
            25% { transform: rotate(-5deg) scale(1.15); }
            75% { transform: rotate(5deg) scale(1.15); }
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
            font-weight: 400;
        }

        .status {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .status h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .status p {
            color: #4a5568;
            line-height: 1.6;
            font-size: 1em;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-success {
            background: #38a169;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .transcript {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .transcript h3 {
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        .ai-message {
            background: #667eea;
            color: white;
            margin-right: auto;
        }

        .ai-message.roast {
            background: #e53e3e;
            animation: roastMessage 0.5s ease-in-out;
        }

        @keyframes roastMessage {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .user-message {
            background: #e2e8f0;
            color: #2d3748;
            margin-left: auto;
        }

        .listening {
            background: #38a169;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: inline-block;
            margin: 10px 0;
            font-weight: 500;
            animation: listeningPulse 1s infinite;
        }

        @keyframes listeningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress {
            background: #e2e8f0;
            border-radius: 8px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: #667eea;
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 8px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            font-size: 12px;
            z-index: 1000;
        }

        .connected {
            background: #38a169;
        }

        .disconnected {
            background: #e53e3e;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2.2em;
            }
            
            .ai-avatar {
                width: 120px;
                height: 120px;
                font-size: 48px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Custom scrollbar */
        .transcript::-webkit-scrollbar {
            width: 8px;
        }

        .transcript::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .transcript::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border-radius: 10px;
        }
    </style>
</head>
<body>


    <!-- Connection Status -->
    <div class="connection-status connected" id="connectionStatus">
        üîó Firebase Connected
    </div>

    <div class="container">
        <div class="ai-avatar" id="aiAvatar">ü§ñ</div>
        <h1>AI Voice Interviewer</h1>
        <p class="subtitle">Advanced AI-powered interview system with real-time data recording</p>
        
        <div class="status" id="statusPanel">
            <h3>üöÄ System Ready</h3>
            <p>Click "Start Listening" and say your badge number to begin your personalized interview experience</p>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="controls">
            <button id="startBtn" onclick="startInterview()">üé§ Start Interview</button>
            <button id="stopBtn" onclick="stopListening()" disabled>‚èπÔ∏è Stop</button>
            <button id="repeatBtn" onclick="repeatQuestion()" disabled>üîÑ Repeat</button>
            <button id="restartMicBtn" onclick="restartMicrophone()" disabled class="btn-danger">üé§ Restart Mic</button>
            <button onclick="testSpeech()" class="btn-success">üîä Test Voice</button>
        </div>

        <div class="transcript" id="transcript">
            <h3>üìù Live Interview Transcript</h3>
            <div id="messages"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyD5-7ODvVwWNeCEihvtHvPXmRecDaEsDJI",
            authDomain: "game-e12a6.firebaseapp.com",
            databaseURL: "https://game-e12a6-default-rtdb.firebaseio.com",
            projectId: "game-e12a6",
            storageBucket: "game-e12a6.firebasestorage.app",
            messagingSenderId: "907247974950",
            appId: "1:907247974950:web:bd79b4c4850ce9c33204e7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Interview system state
        let recognition;
        let synthesis = window.speechSynthesis;
        let currentUser = null;
        let currentQuestionIndex = 0;
        let isListening = false;
        let currentQuestion = '';
        let sessionId = null;
        let startTime = null;
        let wrongAnswers = 0;
        let correctAnswers = 0;

        // Roasting messages for wrong answers
        const roastMessages = [
            "Pehla galat! ü§£ Hahaha! Are you even trying?",
            "Seriously? That's your second wrong answer! Maybe Google kar lena chahiye tha!",
            "Third strike! I'm starting to think you applied for the wrong job! üòÇ",
            "Four wrong answers! Bhai, kya kar rahe ho? Interview hai ya comedy show?",
            "Five wrong! At this point, I'm more qualified than you! üî•",
            "Six wrong answers! Even my calculator would do better! üíÄ",
            "Seven wrong! Are you sure you didn't fake your resume? üò≠",
            "Eight wrong answers! I've seen toasters with better performance! ü§ñüí•"
        ];

        // User profiles and questions
        const userProfiles = {
            'BDG101086': {
                name: 'Jasmeen',
                status: 'processing',
                field: 'graphic-design',
                questions: [
                    { q: "Where are you from?", a: null, type: 'open' },
                    { q: "What is your age?", a: null, type: 'open' },
                    { q: "What are the primary colors in design?", a: "red blue yellow", type: 'technical' },
                    { q: "What does RGB stand for?", a: "red green blue", type: 'technical' },
                    { q: "What is the difference between serif and sans-serif fonts?", a: "serif has decorative strokes sans serif does not", type: 'technical' },
                    { q: "What is the golden ratio in design?", a: "1.618", type: 'technical' },
                    { q: "What does CMYK stand for?", a: "cyan magenta yellow black", type: 'technical' },
                    { q: "What is kerning in typography?", a: "spacing between characters", type: 'technical' },
                    { q: "What is the difference between raster and vector graphics?", a: "raster uses pixels vector uses paths", type: 'technical' },
                    { q: "What is white space in design?", a: "empty space around elements", type: 'technical' }
                ]
            },
            'BDG626316': {
                name: 'Anmol',
                status: 'review',
                field: 'web-development',
                questions: [
                    { q: "Where are you from?", a: null, type: 'open' },
                    { q: "What is your age?", a: null, type: 'open' },
                    { q: "What does HTML stand for?", a: "hypertext markup language", type: 'technical' },
                    { q: "What are the three main web technologies?", a: "html css javascript", type: 'technical' },
                    { q: "What is the difference between margin and padding in CSS?", a: "margin is outside padding is inside", type: 'technical' },
                    { q: "What does API stand for?", a: "application programming interface", type: 'technical' },
                    { q: "What is the difference between GET and POST requests?", a: "get retrieves data post sends data", type: 'technical' },
                    { q: "What is responsive design?", a: "design that adapts to different screen sizes", type: 'technical' },
                    { q: "What is the DOM in web development?", a: "document object model", type: 'technical' },
                    { q: "What is the difference between var let and const in JavaScript?", a: "var function scoped let const block scoped", type: 'technical' }
                ]
            }
        };

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Firebase functions
        function initializeSession() {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            startTime = new Date().toISOString();
            
            const sessionData = {
                sessionId: sessionId,
                startTime: startTime,
                status: 'started',
                userAgent: navigator.userAgent,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref('interviews/' + sessionId).set(sessionData)
                .then(() => {
                    console.log('Session initialized in Firebase');
                    updateConnectionStatus(true);
                })
                .catch((error) => {
                    console.error('Error initializing session:', error);
                    updateConnectionStatus(false);
                });
        }

        function saveUserData(userData) {
            if (!sessionId) return;
            
            database.ref('interviews/' + sessionId + '/user').set(userData)
                .then(() => {
                    console.log('User data saved to Firebase');
                })
                .catch((error) => {
                    console.error('Error saving user data:', error);
                });
        }

        function saveQuestionAnswer(questionIndex, question, userAnswer, correctAnswer, isCorrect, responseTime) {
            if (!sessionId) return;
            
            const qaData = {
                questionIndex: questionIndex,
                question: question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                responseTime: responseTime,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref('interviews/' + sessionId + '/questions/' + questionIndex).set(qaData)
                .then(() => {
                    console.log('Q&A saved to Firebase');
                })
                .catch((error) => {
                    console.error('Error saving Q&A:', error);
                });
        }

        function saveInterviewComplete(score, totalQuestions) {
            if (!sessionId) return;
            
            const completionData = {
                endTime: new Date().toISOString(),
                status: 'completed',
                score: score,
                totalQuestions: totalQuestions,
                duration: Date.now() - new Date(startTime).getTime(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref('interviews/' + sessionId + '/completion').set(completionData)
                .then(() => {
                    console.log('Interview completion saved to Firebase');
                })
                .catch((error) => {
                    console.error('Error saving completion data:', error);
                });
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = 'üîó Firebase Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '‚ùå Connection Error';
            }
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            } else {
                alert('Speech recognition not supported in this browser. Please use Chrome or Edge.');
                return false;
            }

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                updateUI();
                showListening();
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.toLowerCase().trim();
                addMessage(transcript, 'user');
                processUserInput(transcript);
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                hideListening();
                if (event.error === 'no-speech') {
                    speak("I couldn't hear you clearly. Could you please speak a bit louder?");
                } else if (event.error === 'network') {
                    speak("There seems to be a connection issue. Please try again.");
                } else {
                    speak("I'm having trouble understanding. Could you please repeat that?");
                }
            };

            recognition.onend = function() {
                console.log('Recognition ended');
                isListening = false;
                updateUI();
                hideListening();
                
                // Auto-restart listening if we're in an interview
                if (currentUser && currentQuestionIndex <= userProfiles[currentUser].questions.length) {
                    setTimeout(() => {
                        if (!isListening && !synthesis.speaking) {
                            console.log('Auto-restarting microphone after recognition end...');
                            startListening();
                        }
                    }, 1500);
                }
            };

            return true;
        }

        // Text-to-speech function
        function speak(text, isRoast = false) {
            // Cancel any ongoing speech
            if (synthesis.speaking) {
                synthesis.cancel();
            }
            
            // Wait a moment before speaking
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = isRoast ? 1.1 : 0.9;
                utterance.pitch = isRoast ? 1.3 : 1.1;
                utterance.volume = 1;
                utterance.lang = 'en-US';
                
                // Get available voices
                const voices = synthesis.getVoices();
                console.log('Available voices:', voices.length);
                
                if (voices.length > 0) {
                    // Try to find a good English voice
                    let selectedVoice = voices.find(voice => 
                        voice.lang === 'en-US' && voice.name.includes('Female')
                    ) || voices.find(voice => 
                        voice.lang === 'en-US'
                    ) || voices.find(voice => 
                        voice.lang.startsWith('en')
                    ) || voices[0];
                    
                    utterance.voice = selectedVoice;
                    console.log('Selected voice:', selectedVoice.name);
                }

                utterance.onstart = function() {
                    console.log('Speech started');
                    const avatar = document.getElementById('aiAvatar');
                    avatar.classList.add('speaking');
                    if (isRoast) {
                        avatar.classList.add('roasting');
                    }
                };

                utterance.onend = function() {
                    console.log('Speech ended');
                    const avatar = document.getElementById('aiAvatar');
                    avatar.classList.remove('speaking', 'roasting');
                    if (currentUser && currentQuestionIndex <= userProfiles[currentUser].questions.length) {
                        setTimeout(() => {
                            if (!isListening && recognition) {
                                console.log('Restarting microphone...');
                                startListening();
                            }
                        }, 1000);
                    }
                };

                utterance.onerror = function(event) {
                    console.error('Speech error:', event.error);
                    const avatar = document.getElementById('aiAvatar');
                    avatar.classList.remove('speaking', 'roasting');
                };

                // Speak the text
                synthesis.speak(utterance);
                console.log('Speaking:', text);
                
            }, 100);
            
            addMessage(text, 'ai', isRoast);
        }

        // Process user input
        function processUserInput(input) {
            if (!currentUser) {
                if (input.includes('101086') || input.includes('bdg101086')) {
                    currentUser = 'BDG101086';
                    initializeInterview();
                } else if (input.includes('626316') || input.includes('bdg626316')) {
                    currentUser = 'BDG626316';
                    initializeInterview();
                } else {
                    speak("I didn't recognize that badge number. Please say your badge number clearly.");
                    setTimeout(startListening, 2000);
                }
            } else {
                processAnswer(input);
            }
        }

        // Initialize interview for recognized user
        function initializeInterview() {
            const profile = userProfiles[currentUser];
            const greeting = `Hi ${profile.name}, I am checking... your application is in ${profile.status}. Let's start some questions.`;
            
            // Save user data to Firebase
            saveUserData({
                badgeNumber: currentUser,
                name: profile.name,
                status: profile.status,
                field: profile.field,
                interviewStarted: new Date().toISOString()
            });
            
            updateStatus(`üéØ Interview Started - ${profile.name}`, `Application status: ${profile.status} | Field: ${profile.field}`);
            updateProgress(0);
            
            speak(greeting);
            
            setTimeout(() => {
                askNextQuestion();
            }, 4000);
        }

        // Ask the next question
        function askNextQuestion() {
            if (currentQuestionIndex < userProfiles[currentUser].questions.length) {
                currentQuestion = userProfiles[currentUser].questions[currentQuestionIndex].q;
                speak(currentQuestion);
                updateProgress((currentQuestionIndex / userProfiles[currentUser].questions.length) * 100);
            } else {
                finishInterview();
            }
        }

        // Process user's answer
        function processAnswer(answer) {
            const question = userProfiles[currentUser].questions[currentQuestionIndex];
            const responseTime = Date.now();
            let isCorrect = null;
            let response = '';
            let isRoast = false;
            
            if (question.a === null) {
                response = "Thank you for your answer.";
                isCorrect = true; // Open-ended questions are always "correct"
                correctAnswers++;
            } else {
                const correctAnswer = question.a.toLowerCase();
                const userAnswer = answer.toLowerCase();
                
                // Check if answer contains key words from correct answer
                const correctWords = correctAnswer.split(' ');
                const userWords = userAnswer.split(' ');
                const matchCount = correctWords.filter(word => 
                    userWords.some(userWord => userWord.includes(word) || word.includes(userWord))
                ).length;
                
                if (matchCount >= Math.ceil(correctWords.length * 0.6)) {
                    response = "Correct! Well done.";
                    isCorrect = true;
                    correctAnswers++;
                } else {
                    response = `Incorrect. The correct answer is: ${question.a}`;
                    isCorrect = false;
                    wrongAnswers++;
                    
                    // Add roasting if enough wrong answers
                    if (wrongAnswers > 0 && wrongAnswers <= roastMessages.length) {
                        response += ` ${roastMessages[wrongAnswers - 1]}`;
                        isRoast = true;
                    }
                }
            }
            
            // Save Q&A to Firebase
            saveQuestionAnswer(
                currentQuestionIndex,
                question.q,
                answer,
                question.a,
                isCorrect,
                responseTime
            );
            
            currentQuestionIndex++;
            speak(response, isRoast);
            
            setTimeout(() => {
                askNextQuestion();
            }, isRoast ? 4000 : 3000);
        }

        // Finish the interview
        function finishInterview() {
            const totalQuestions = userProfiles[currentUser].questions.length;
            const score = Math.round((correctAnswers / totalQuestions) * 100);
            
            let finalMessage = "";
            let isRoast = false;
            
            if (wrongAnswers >= 5) {
                finalMessage = `Interview complete! You got ${correctAnswers} out of ${totalQuestions} correct. Score: ${score}%. Honestly, I've seen better performance from a broken calculator! ü§ñüíÄ Maybe try a different career? Your report has been sent to the team... good luck explaining this! üòÇ`;
                isRoast = true;
            } else if (wrongAnswers >= 3) {
                finalMessage = `Interview complete! You got ${correctAnswers} out of ${totalQuestions} correct. Score: ${score}%. Not terrible, but not great either! Room for improvement, my friend. Your report has been sent to the team.`;
            } else {
                finalMessage = `Excellent work! You got ${correctAnswers} out of ${totalQuestions} correct. Score: ${score}%. Well done! Your report has been sent to the team.`;
            }
            
            saveInterviewComplete(score, totalQuestions);
            speak(finalMessage, isRoast);
            
            updateStatus("‚úÖ Interview Complete", `Final Score: ${score}% (${correctAnswers}/${totalQuestions} correct)`);
            updateProgress(100);
            
            setTimeout(() => {
                resetInterview();
            }, 8000);
        }

        // Reset interview state
        function resetInterview() {
            currentUser = null;
            currentQuestionIndex = 0;
            currentQuestion = '';
            sessionId = null;
            startTime = null;
            wrongAnswers = 0;
            correctAnswers = 0;
            updateStatus("üöÄ Ready for Next Interview", "Click 'Start Interview' and say your badge number to begin");
            updateProgress(0);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('messages').innerHTML = '';
        }

        // UI helper functions
        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(title, description) {
            document.getElementById('statusPanel').innerHTML = `
                <h3>${title}</h3>
                <p>${description}</p>
            `;
        }

        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        function showListening() {
            const statusPanel = document.getElementById('statusPanel');
            statusPanel.innerHTML = `
                <h3>üëÇ Listening...</h3>
                <p class="listening">üé§ Speak now - I'm all ears!</p>
            `;
        }

        function hideListening() {
            if (!currentUser) {
                updateStatus("üöÄ Ready to Start", "Click 'Start Listening' and say your badge number");
            } else {
                updateStatus(`üéØ Interview in Progress`, `Question ${currentQuestionIndex + 1} of ${userProfiles[currentUser].questions.length}`);
            }
        }

        function updateUI() {
            document.getElementById('startBtn').disabled = isListening || currentUser !== null;
            document.getElementById('stopBtn').disabled = !isListening;
            document.getElementById('repeatBtn').disabled = !currentUser || currentQuestion === '';
            document.getElementById('restartMicBtn').disabled = !currentUser;
        }

        // Restart microphone function
        function restartMicrophone() {
            console.log('Manual microphone restart requested');
            if (recognition) {
                if (isListening) {
                    recognition.stop();
                }
                setTimeout(() => {
                    startListening();
                }, 500);
            }
        }

        // Control functions
        function startInterview() {
            initializeSession();
            if (initSpeechRecognition()) {
                startListening();
            }
        }

        function startListening() {
            if (recognition && !isListening) {
                recognition.start();
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
        }

        function repeatQuestion() {
            if (currentQuestion) {
                speak(currentQuestion);
            }
        }

        // Initialize voices
        function initializeVoices() {
            const voices = synthesis.getVoices();
            console.log('Voices loaded:', voices.length);
            if (voices.length > 0) {
                console.log('First voice:', voices[0].name, voices[0].lang);
            }
        }

        // Test speech function
        function testSpeech() {
            console.log('Testing speech...');
            const testUtterance = new SpeechSynthesisUtterance('Testing voice');
            testUtterance.volume = 1;
            testUtterance.rate = 1;
            testUtterance.pitch = 1;
            
            testUtterance.onstart = () => console.log('Test speech started');
            testUtterance.onend = () => console.log('Test speech ended');
            testUtterance.onerror = (e) => console.error('Test speech error:', e);
            
            synthesis.speak(testUtterance);
        }

        // Initialize on page load
        window.onload = function() {
            createParticles();
            
            // Test Firebase connection
            database.ref('.info/connected').on('value', function(snapshot) {
                updateConnectionStatus(snapshot.val() === true);
            });
            
            // Initialize voices
            if (synthesis.onvoiceschanged !== undefined) {
                synthesis.onvoiceschanged = initializeVoices;
            }
            
            // Load voices immediately if available
            setTimeout(initializeVoices, 100);
            
            updateUI();
            
            // Add a test speech button temporarily
            console.log('Speech synthesis supported:', 'speechSynthesis' in window);
            console.log('Synthesis object:', synthesis);
            
            // Delayed welcome message to ensure voices are loaded
            setTimeout(() => {
                console.log('Attempting welcome message...');
                speak("Welcome to the advanced AI Voice Interviewer. I'm ready to conduct your personalized interview with real-time data recording. Please click Start Listening and say your badge number to begin.");
            }, 2000);
        };
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e76d7da30b5512',t:'MTc1NTA3OTg3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
