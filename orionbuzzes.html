<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OrioBuzz - Social Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --instagram-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            --instagram-blue: #0095f6;
            --instagram-dark-blue: #00376b;
            --instagram-light-gray: #fafafa;
            --instagram-border: #dbdbdb;
            --instagram-text: #262626;
            --instagram-secondary-text: #8e8e8e;
            --instagram-error: #ed4956;
            --instagram-success: #00c851;
        }
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background-color: var(--instagram-light-gray);
            color: var(--instagram-text);
        }
        
        .instagram-gradient {
            background: var(--instagram-gradient);
        }
        
        .instagram-gradient-text {
            background: var(--instagram-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .instagram-button {
            background: var(--instagram-blue);
            transition: all 0.2s ease;
        }
        
        .instagram-button:hover {
            background: var(--instagram-dark-blue);
            transform: translateY(-1px);
        }
        
        .instagram-card {
            background: white;
            border: 1px solid var(--instagram-border);
            border-radius: 8px;
        }
        
        .nav-item {
            transition: all 0.2s ease;
            border-radius: 12px;
        }
        
        .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .nav-item.active {
            background-color: rgba(0, 149, 246, 0.1);
            color: var(--instagram-blue);
        }
        
        .buzz-button {
            background: var(--instagram-gradient);
            border: none;
            border-radius: 24px;
            color: white;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .buzz-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .buzz-button:disabled {
            background: #ccc;
            transform: none;
            box-shadow: none;
        }
        
        .mobile-nav {
            background: white;
            border-top: 1px solid var(--instagram-border);
            backdrop-filter: blur(10px);
        }
        
        .mobile-nav-item {
            transition: all 0.2s ease;
        }
        
        .mobile-nav-item:hover {
            color: var(--instagram-blue);
        }
        
        .mobile-nav-item.active {
            color: var(--instagram-blue);
        }
        
        .coming-soon-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .interest-card {
            background: white;
            border: 2px solid var(--instagram-border);
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .interest-card:hover {
            border-color: var(--instagram-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .interest-card.selected {
            border-color: var(--instagram-blue);
            background: rgba(0, 149, 246, 0.1);
        }
        
        .notification-badge {
            background: var(--instagram-gradient);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .desktop-nav {
                display: none !important;
            }
            
            .mobile-nav {
                display: flex !important;
            }
            
            .main-content {
                padding-bottom: 80px;
            }
        }
        
        @media (min-width: 769px) {
            .desktop-nav {
                display: block !important;
            }
            
            .mobile-nav {
                display: none !important;
            }
            
            .main-content {
                margin-left: 250px;
            }
        }
        
        .dark-mode {
            --instagram-light-gray: #000;
            --instagram-text: #fff;
            --instagram-secondary-text: #a8a8a8;
            --instagram-border: #262626;
        }
        
        .dark-mode body {
            background-color: #000;
            color: #fff;
        }
        
        .dark-mode .instagram-card {
            background: #262626;
            border-color: #363636;
        }
        
        .dark-mode .mobile-nav {
            background: #262626;
            border-color: #363636;
        }
        
        .verification-badge {
            width: 16px;
            height: 16px;
            background: var(--instagram-blue);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
        }
        
        .verification-badge::after {
            content: '✓';
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp, writeBatch, getDocs, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, push, set, onValue, off, serverTimestamp as rtdbServerTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCWB4adPUSrSW2cSd9I3oqYIw65ZnStj4",
            authDomain: "twitter-1903a.firebaseapp.com",
            databaseURL: "https://twitter-1903a-default-rtdb.firebaseio.com",
            projectId: "twitter-1903a",
            storageBucket: "twitter-1903a.firebasestorage.app",
            messagingSenderId: "37758914989",
            appId: "1:37758914989:web:6c364d74288a8b08f8d124"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentUserProfile = null;
        let feedListener = null;
        let notificationListener = null;
        let activeChat = null;
        let activeChatListener = null;
        let typingTimeout = null;
        let chatListListener = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let selectedInterests = [];

        // Available interests for onboarding
        const AVAILABLE_INTERESTS = [
            { id: 'technology', name: 'Technology', icon: 'fas fa-laptop-code' },
            { id: 'music', name: 'Music', icon: 'fas fa-music' },
            { id: 'sports', name: 'Sports', icon: 'fas fa-football-ball' },
            { id: 'gaming', name: 'Gaming', icon: 'fas fa-gamepad' },
            { id: 'art', name: 'Art & Design', icon: 'fas fa-palette' },
            { id: 'food', name: 'Food & Cooking', icon: 'fas fa-utensils' },
            { id: 'travel', name: 'Travel', icon: 'fas fa-plane' },
            { id: 'fitness', name: 'Fitness & Health', icon: 'fas fa-dumbbell' },
            { id: 'photography', name: 'Photography', icon: 'fas fa-camera' },
            { id: 'movies', name: 'Movies & TV', icon: 'fas fa-film' },
            { id: 'books', name: 'Books & Reading', icon: 'fas fa-book' },
            { id: 'business', name: 'Business', icon: 'fas fa-briefcase' },
            { id: 'science', name: 'Science', icon: 'fas fa-flask' },
            { id: 'fashion', name: 'Fashion', icon: 'fas fa-tshirt' },
            { id: 'news', name: 'News & Politics', icon: 'fas fa-newspaper' }
        ];

        // Special admin UIDs for auto-verification
        const ADMIN_UIDS = {
            'gursharn-arya-oriontec': 'admin-uid-1',
            'anmol-sunda': 'admin-uid-2'
        };

        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const signupSection = document.getElementById('signupSection');
        const onboardingSection = document.getElementById('onboardingSection');
        const mainApp = document.getElementById('mainApp');
        const profileSection = document.getElementById('profileSection');
        const messagesSection = document.getElementById('messagesSection');
        const verificationSection = document.getElementById('verificationSection');
        const editProfileModal = document.getElementById('editProfileModal');
        const reportModal = document.getElementById('reportModal');
        const notificationDropdown = document.getElementById('notificationDropdown');

        // Initialize dark mode
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
        }

        // Authentication state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile();
                
                // Check if user is suspended
                if (currentUserProfile?.isSuspended) {
                    alert('Your account has been suspended. Please contact support.');
                    await auth.signOut();
                    return;
                }
                
                // Check if user needs onboarding
                if (!currentUserProfile?.hasCompletedOnboarding) {
                    showOnboardingSection();
                } else {
                    showMainApp();
                    loadUserFeed();
                    setupNotificationListener();
                    setupPresence();
                }
            } else {
                showLoginSection();
            }
        });

        // Setup user presence
        function setupPresence() {
            const userStatusRef = ref(rtdb, `/status/${currentUser.uid}`);
            const isOfflineForDatabase = {
                state: 'offline',
                last_changed: rtdbServerTimestamp(),
            };
            const isOnlineForDatabase = {
                state: 'online',
                last_changed: rtdbServerTimestamp(),
            };

            onDisconnect(userStatusRef).set(isOfflineForDatabase);
            set(userStatusRef, isOnlineForDatabase);
        }

        // Generate chat ID from two user IDs
        function generateChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        // Show different sections
        function showLoginSection() {
            hideAllSections();
            loginSection.classList.remove('hidden');
        }

        function showSignupSection() {
            hideAllSections();
            signupSection.classList.remove('hidden');
        }

        function showMainApp() {
            hideAllSections();
            mainApp.classList.remove('hidden');
            updateUserInfo();
        }

        function showProfileSection() {
            hideAllSections();
            profileSection.classList.remove('hidden');
        }

        function showMessagesSection() {
            hideAllSections();
            messagesSection.classList.remove('hidden');
            loadChatList();
        }

        function showVerificationSection() {
            hideAllSections();
            verificationSection.classList.remove('hidden');
            loadVerificationForm();
        }

        function showOnboardingSection() {
            hideAllSections();
            onboardingSection.classList.remove('hidden');
            loadInterestSelection();
        }

        function hideAllSections() {
            loginSection.classList.add('hidden');
            signupSection.classList.add('hidden');
            onboardingSection.classList.add('hidden');
            mainApp.classList.add('hidden');
            profileSection.classList.add('hidden');
            messagesSection.classList.add('hidden');
            verificationSection.classList.add('hidden');
        }

        // Load interest selection for onboarding
        function loadInterestSelection() {
            const interestsGrid = document.getElementById('interestsGrid');
            interestsGrid.innerHTML = '';
            selectedInterests = [];
            
            AVAILABLE_INTERESTS.forEach(interest => {
                const interestCard = document.createElement('div');
                interestCard.className = 'interest-card p-4 text-center';
                interestCard.onclick = () => toggleInterest(interest.id, interestCard);
                
                interestCard.innerHTML = `
                    <i class="${interest.icon} text-2xl mb-2 text-gray-600"></i>
                    <p class="font-medium text-sm">${interest.name}</p>
                `;
                
                interestsGrid.appendChild(interestCard);
            });
            
            updateOnboardingButton();
        }

        // Toggle interest selection
        window.toggleInterest = (interestId, cardElement) => {
            if (selectedInterests.includes(interestId)) {
                selectedInterests = selectedInterests.filter(id => id !== interestId);
                cardElement.classList.remove('selected');
            } else {
                selectedInterests.push(interestId);
                cardElement.classList.add('selected');
            }
            
            updateOnboardingButton();
        };

        // Update onboarding button state
        function updateOnboardingButton() {
            const button = document.getElementById('completeOnboardingButton');
            const count = document.getElementById('selectedCount');
            
            count.textContent = `${selectedInterests.length}/3`;
            
            if (selectedInterests.length >= 3) {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                button.classList.add('instagram-button');
            } else {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                button.classList.remove('instagram-button');
            }
        }

        // Complete onboarding
        window.completeOnboarding = async () => {
            if (selectedInterests.length < 3) {
                alert('Please select at least 3 interests to continue.');
                return;
            }
            
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    interests: selectedInterests,
                    hasCompletedOnboarding: true
                });
                
                currentUserProfile.interests = selectedInterests;
                currentUserProfile.hasCompletedOnboarding = true;
                
                showMainApp();
                loadUserFeed();
                setupNotificationListener();
                setupPresence();
                
            } catch (error) {
                console.error('Error completing onboarding:', error);
                alert('Error saving your interests. Please try again.');
            }
        };

        // Load verification form
        function loadVerificationForm() {
            document.getElementById('verificationUsername').value = currentUserProfile.username;
            
            // Check if user already has a pending or approved request
            checkExistingVerificationRequest();
        }

        // Check for existing verification request
        async function checkExistingVerificationRequest() {
            try {
                const q = query(
                    collection(db, 'verificationRequests'),
                    where('uid', '==', currentUser.uid)
                );
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const request = snapshot.docs[0].data();
                    const status = request.status;
                    
                    const statusDiv = document.getElementById('verificationStatus');
                    const formDiv = document.getElementById('verificationForm');
                    
                    if (status === 'pending') {
                        statusDiv.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                                <div class="text-yellow-600 mb-4">
                                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Verification Pending</h3>
                                <p class="text-yellow-700">Your verification request is being reviewed by our team. This process typically takes 3-5 business days.</p>
                                <p class="text-sm text-yellow-600 mt-2">Submitted: ${formatDate(request.submittedAt)}</p>
                            </div>
                        `;
                        formDiv.classList.add('hidden');
                        statusDiv.classList.remove('hidden');
                    } else if (status === 'approved') {
                        statusDiv.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                                <div class="text-green-600 mb-4">
                                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-green-800 mb-2">Verification Approved!</h3>
                                <p class="text-green-700">Congratulations! Your account has been verified. Your verification badge is now visible across the platform.</p>
                            </div>
                        `;
                        formDiv.classList.add('hidden');
                        statusDiv.classList.remove('hidden');
                    } else if (status === 'rejected') {
                        statusDiv.innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                                <div class="text-red-600 mb-4">
                                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-red-800 mb-2">Verification Rejected</h3>
                                <p class="text-red-700">Your verification request was not approved. ${request.rejectionReason || 'Please ensure all information is accurate and try again.'}</p>
                                <button onclick="resubmitVerification()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Submit New Request
                                </button>
                            </div>
                        `;
                        formDiv.classList.add('hidden');
                        statusDiv.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error checking verification status:', error);
            }
        }

        // Resubmit verification (clear existing request)
        window.resubmitVerification = () => {
            document.getElementById('verificationStatus').classList.add('hidden');
            document.getElementById('verificationForm').classList.remove('hidden');
        };

        // Validate age (13+ requirement)
        function validateAge(dateOfBirth) {
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            const age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age >= 13;
        }

        // Validate article link format
        function validateArticleLink(link, fullName) {
            // Check if link follows oriontec.xyz/date/userkanaam format
            const linkPattern = /^https?:\/\/oriontec\.xyz\/\d{4}-\d{2}-\d{2}\/([a-z-]+)$/i;
            const match = link.match(linkPattern);
            
            if (!match) {
                return {
                    valid: false,
                    error: 'Article link must follow the format: oriontec.xyz/YYYY-MM-DD/user-name'
                };
            }
            
            const userkanaam = match[1];
            const normalizedName = fullName.toLowerCase()
                .replace(/[^a-z\s]/g, '')
                .replace(/\s+/g, '-');
            
            // Check if userkanaam closely matches the full name
            const similarity = calculateSimilarity(userkanaam, normalizedName);
            
            if (similarity < 0.7) { // 70% similarity threshold
                return {
                    valid: false,
                    error: 'The username in the article link does not match your full name closely enough'
                };
            }
            
            return { valid: true };
        }

        // Calculate string similarity (simple Levenshtein-based)
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // Levenshtein distance calculation
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // Submit verification request
        window.submitVerificationRequest = async () => {
            const fullName = document.getElementById('verificationFullName').value.trim();
            const username = document.getElementById('verificationUsername').value.trim();
            const category = document.getElementById('verificationCategory').value;
            const country = document.getElementById('verificationCountry').value.trim();
            const dateOfBirth = document.getElementById('verificationDOB').value;
            const articleLink = document.getElementById('verificationArticleLink').value.trim();
            
            // Clear previous errors
            document.getElementById('verificationError').classList.add('hidden');
            
            // Validate required fields
            if (!fullName || !category || !country || !dateOfBirth || !articleLink) {
                showVerificationError('Please fill in all required fields');
                return;
            }
            
            // Validate age
            if (!validateAge(dateOfBirth)) {
                showVerificationError('You must be at least 13 years old to request verification');
                return;
            }
            
            // Validate article link
            const linkValidation = validateArticleLink(articleLink, fullName);
            if (!linkValidation.valid) {
                showVerificationError(linkValidation.error);
                return;
            }
            
            try {
                // Show loading state
                const submitButton = document.querySelector('#verificationForm button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Submitting...';
                submitButton.disabled = true;
                
                // Create verification request
                const verificationRequest = {
                    uid: currentUser.uid,
                    fullName: fullName,
                    username: username,
                    category: category,
                    country: country,
                    dateOfBirth: dateOfBirth,
                    articleLink: articleLink,
                    status: 'pending',
                    submittedAt: serverTimestamp(),
                    reviewedAt: null,
                    reviewedBy: null,
                    rejectionReason: null
                };
                
                await addDoc(collection(db, 'verificationRequests'), verificationRequest);
                
                // Check if user is admin for auto-approval
                await checkAutoApproval(currentUser.uid);
                
                // Show success message
                document.getElementById('verificationForm').innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                        <div class="text-green-600 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-green-800 mb-2">Request Submitted!</h3>
                        <p class="text-green-700">Your verification request has been submitted successfully. We'll review it within 3-5 business days.</p>
                        <button onclick="showMainApp()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Back to Home
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error submitting verification request:', error);
                showVerificationError('Failed to submit verification request. Please try again.');
                
                // Reset button
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        };

        // Check for auto-approval (simulates Cloud Function)
        async function checkAutoApproval(uid) {
            // In a real implementation, this would be handled by a Cloud Function
            // For demo purposes, we'll check if the user is in our admin list
            const isAdmin = Object.values(ADMIN_UIDS).includes(uid) || 
                           currentUserProfile.username === 'gursharn-arya-oriontec' ||
                           currentUserProfile.username === 'anmol-sunda';
            
            if (isAdmin) {
                // Auto-approve and set verification badge
                await updateDoc(doc(db, 'users', uid), {
                    isVerified: true,
                    customVerificationBadgeUrl: 'https://api.dicebear.com/7.x/shapes/svg?seed=verified&backgroundColor=3b82f6'
                });
                
                // Update the verification request status
                const q = query(
                    collection(db, 'verificationRequests'),
                    where('uid', '==', uid)
                );
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    await updateDoc(snapshot.docs[0].ref, {
                        status: 'approved',
                        reviewedAt: serverTimestamp(),
                        reviewedBy: 'auto-system'
                    });
                }
                
                // Update current user profile
                currentUserProfile.isVerified = true;
                currentUserProfile.customVerificationBadgeUrl = 'https://api.dicebear.com/7.x/shapes/svg?seed=verified&backgroundColor=3b82f6';
            }
        }

        // Show verification error
        function showVerificationError(message) {
            const errorDiv = document.getElementById('verificationError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Report content or user
        let reportTarget = null;
        let reportType = null;

        window.showReportModal = (targetId, type, targetName = '') => {
            reportTarget = targetId;
            reportType = type;
            
            document.getElementById('reportTargetName').textContent = 
                type === 'user' ? `@${targetName}` : 'this buzz';
            document.getElementById('reportReason').value = '';
            reportModal.classList.remove('hidden');
        };

        window.hideReportModal = () => {
            reportModal.classList.add('hidden');
            reportTarget = null;
            reportType = null;
        };

        window.submitReport = async () => {
            const reason = document.getElementById('reportReason').value.trim();
            
            if (!reason) {
                alert('Please provide a reason for the report');
                return;
            }
            
            try {
                await addDoc(collection(db, 'reports'), {
                    reporterId: currentUser.uid,
                    reporterUsername: currentUserProfile.username,
                    reportedContentId: reportTarget,
                    reportType: reportType, // 'user' or 'buzz'
                    reason: reason,
                    timestamp: serverTimestamp(),
                    status: 'pending',
                    reviewedAt: null,
                    reviewedBy: null,
                    action: null
                });
                
                hideReportModal();
                alert('Report submitted successfully. Thank you for helping keep OrioBuzz safe.');
                
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Failed to submit report. Please try again.');
            }
        };

        // Load current user's profile
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    currentUserProfile = userDoc.data();
                } else {
                    await createDemoProfile();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // Create demo profile for anonymous users
        async function createDemoProfile() {
            const randomId = Math.random().toString(36).substring(2, 8);
            const profile = {
                uid: currentUser.uid,
                username: `user${randomId}`,
                displayName: `User ${randomId}`,
                email: currentUser.email || `user${randomId}@demo.com`,
                bio: 'New to OrioBuzz!',
                profileImageUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.uid}`,
                createdAt: serverTimestamp(),
                followers: [],
                following: [],
                isPrivate: false,
                isVerified: false,
                isSuspended: false,
                customVerificationBadgeUrl: null,
                blockedUsers: [],
                hasCompletedOnboarding: false,
                interests: []
            };

            await setDoc(doc(db, 'users', currentUser.uid), profile);
            currentUserProfile = profile;
        }

        // Toggle dark mode
        window.toggleDarkMode = () => {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode.toString());
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        };

        // Logout function
        window.logout = async () => {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    // Clear any local data
                    localStorage.removeItem('selectedInterests');
                    selectedInterests = [];
                    currentUser = null;
                    currentUserProfile = null;
                    
                    // Clean up listeners
                    if (feedListener) feedListener();
                    if (notificationListener) notificationListener();
                    if (activeChatListener) activeChatListener();
                    if (chatListListener) chatListListener();
                    
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        };

        // Update user info display
        function updateUserInfo() {
            if (currentUserProfile) {
                // Desktop navigation
                const desktopAvatar = document.getElementById('desktopUserAvatar');
                const desktopName = document.getElementById('desktopUserName');
                const desktopHandle = document.getElementById('desktopUserHandle');
                
                if (desktopAvatar) desktopAvatar.src = currentUserProfile.profileImageUrl;
                if (desktopName) desktopName.textContent = currentUserProfile.displayName;
                if (desktopHandle) desktopHandle.textContent = `@${currentUserProfile.username}`;
                
                // Post avatar
                const postAvatar = document.getElementById('userAvatarPost');
                if (postAvatar) postAvatar.src = currentUserProfile.profileImageUrl;
                
                // Textarea placeholder
                const textarea = document.getElementById('buzzTextarea');
                if (textarea) textarea.placeholder = `What's buzzing, ${currentUserProfile.displayName}?`;
            }
        }

        // Create verification badge HTML
        function createVerificationBadge(user) {
            if (!user.isVerified) return '';
            
            const badgeUrl = user.customVerificationBadgeUrl || 
                           'https://api.dicebear.com/7.x/shapes/svg?seed=verified&backgroundColor=3b82f6';
            
            return `<img src="${badgeUrl}" alt="Verified" class="w-4 h-4 inline-block ml-1" title="Verified Account">`;
        }

        // Setup notification listener
        function setupNotificationListener() {
            const notificationsRef = collection(db, 'users', currentUser.uid, 'notifications');
            const q = query(notificationsRef, orderBy('timestamp', 'desc'));

            notificationListener = onSnapshot(q, (snapshot) => {
                const notifications = [];
                snapshot.forEach((doc) => {
                    notifications.push({ id: doc.id, ...doc.data() });
                });
                updateNotificationBadge(notifications);
                renderNotifications(notifications);
            });
        }

        // Update notification badge
        function updateNotificationBadge(notifications) {
            const unreadCount = notifications.filter(n => !n.isRead).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Toggle notification dropdown
        window.toggleNotifications = async () => {
            notificationDropdown.classList.toggle('hidden');
            
            if (!notificationDropdown.classList.contains('hidden')) {
                // Mark all notifications as read
                const notificationsRef = collection(db, 'users', currentUser.uid, 'notifications');
                const unreadQuery = query(notificationsRef, where('isRead', '==', false));
                const unreadSnapshot = await getDocs(unreadQuery);
                
                const batch = writeBatch(db);
                unreadSnapshot.forEach((doc) => {
                    batch.update(doc.ref, { isRead: true });
                });
                
                if (!unreadSnapshot.empty) {
                    await batch.commit();
                }
            }
        };

        // Render notifications
        function renderNotifications(notifications) {
            const container = document.getElementById('notificationList');
            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }

            notifications.slice(0, 10).forEach(notification => {
                const notificationElement = createNotificationElement(notification);
                container.appendChild(notificationElement);
            });
        }

        // Create notification element
        function createNotificationElement(notification) {
            const div = document.createElement('div');
            div.className = `p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 ${!notification.isRead ? 'bg-blue-50' : ''}`;
            
            let message = '';
            let action = '';
            
            switch (notification.type) {
                case 'follow':
                    message = `${notification.senderDisplayName} started following you`;
                    action = `viewProfile('${notification.senderUsername}')`;
                    break;
                case 'like':
                    message = `${notification.senderDisplayName} liked your buzz`;
                    action = `viewBuzz('${notification.buzzId}')`;
                    break;
                case 'comment':
                    message = `${notification.senderDisplayName} commented on your buzz`;
                    action = `viewBuzz('${notification.buzzId}')`;
                    break;
                case 'mention':
                    message = `${notification.senderDisplayName} mentioned you in a buzz`;
                    action = `viewBuzz('${notification.buzzId}')`;
                    break;
            }

            div.onclick = () => {
                notificationDropdown.classList.add('hidden');
                eval(action);
            };

            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 ${notification.isRead ? 'opacity-0' : ''}"></div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800">${message}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatTimeAgo(notification.timestamp?.toDate())}</p>
                    </div>
                </div>
            `;

            return div;
        }

        // Create notification
        async function createNotification(recipientId, type, data) {
            try {
                const notification = {
                    type: type,
                    senderId: currentUser.uid,
                    senderDisplayName: currentUserProfile.displayName,
                    senderUsername: currentUserProfile.username,
                    timestamp: serverTimestamp(),
                    isRead: false,
                    ...data
                };

                await addDoc(collection(db, 'users', recipientId, 'notifications'), notification);
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Load chat list
        function loadChatList() {
            const chatListRef = ref(rtdb, 'chats');
            
            if (chatListListener) {
                off(chatListRef, 'value', chatListListener);
            }

            chatListListener = onValue(chatListRef, (snapshot) => {
                const chats = [];
                const data = snapshot.val();
                
                if (data) {
                    Object.keys(data).forEach(chatId => {
                        if (chatId.includes(currentUser.uid)) {
                            const chat = data[chatId];
                            const otherUserId = chatId.split('_').find(id => id !== currentUser.uid);
                            chats.push({
                                id: chatId,
                                otherUserId: otherUserId,
                                lastMessage: chat.lastMessage,
                                lastMessageTime: chat.lastMessageTime
                            });
                        }
                    });
                }

                renderChatList(chats);
            });
        }

        // Render chat list
        async function renderChatList(chats) {
            const container = document.getElementById('chatList');
            container.innerHTML = '';

            if (chats.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>No conversations yet</p>
                        <p class="text-sm mt-2">Start a conversation from a user's profile</p>
                    </div>
                `;
                return;
            }

            // Sort by last message time
            chats.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));

            for (const chat of chats) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', chat.otherUserId));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const chatElement = createChatListItem(chat, userData);
                        container.appendChild(chatElement);
                    }
                } catch (error) {
                    console.error('Error loading chat user data:', error);
                }
            }
        }

        // Create chat list item
        function createChatListItem(chat, userData) {
            const div = document.createElement('div');
            div.className = `p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 ${activeChat === chat.id ? 'bg-blue-50' : ''}`;
            div.onclick = () => openChat(chat.id, userData);

            const lastMessageText = chat.lastMessage ? 
                (chat.lastMessage.length > 50 ? chat.lastMessage.substring(0, 50) + '...' : chat.lastMessage) : 
                'No messages yet';

            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${userData.profileImageUrl}" alt="${userData.displayName}" class="w-12 h-12 rounded-full">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <h3 class="font-semibold text-gray-900 truncate">${userData.displayName}</h3>
                            ${createVerificationBadge(userData)}
                        </div>
                        <p class="text-sm text-gray-500 truncate">@${userData.username}</p>
                        <p class="text-sm text-gray-600 truncate mt-1">${lastMessageText}</p>
                    </div>
                </div>
            `;

            return div;
        }

        // Open chat
        function openChat(chatId, otherUser) {
            activeChat = chatId;
            
            // Update UI
            document.getElementById('chatHeader').innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${otherUser.profileImageUrl}" alt="${otherUser.displayName}" class="w-10 h-10 rounded-full">
                    <div>
                        <div class="flex items-center">
                            <h3 class="font-semibold text-gray-900">${otherUser.displayName}</h3>
                            ${createVerificationBadge(otherUser)}
                        </div>
                        <p class="text-sm text-gray-500">@${otherUser.username}</p>
                    </div>
                </div>
            `;

            // Show chat area
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('emptyChatState').classList.add('hidden');

            // Load messages
            loadChatMessages(chatId);
            
            // Update chat list selection
            loadChatList();
        }

        // Load chat messages
        function loadChatMessages(chatId) {
            const messagesRef = ref(rtdb, `chats/${chatId}/messages`);
            const typingRef = ref(rtdb, `chats/${chatId}/metadata/typing`);
            
            if (activeChatListener) {
                off(messagesRef, 'value', activeChatListener);
            }

            // Listen for messages
            activeChatListener = onValue(messagesRef, (snapshot) => {
                const messages = [];
                const data = snapshot.val();
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        messages.push({ id: key, ...data[key] });
                    });
                }

                messages.sort((a, b) => a.timestamp - b.timestamp);
                renderMessages(messages);
                updateSeenStatus(chatId);
            });

            // Listen for typing indicator
            onValue(typingRef, (snapshot) => {
                const typingData = snapshot.val();
                const typingIndicator = document.getElementById('typingIndicator');
                
                if (typingData && typingData[currentUser.uid] !== true) {
                    const otherUserTyping = Object.keys(typingData).some(uid => 
                        uid !== currentUser.uid && typingData[uid] === true
                    );
                    
                    if (otherUserTyping) {
                        typingIndicator.classList.remove('hidden');
                    } else {
                        typingIndicator.classList.add('hidden');
                    }
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });
        }

        // Render messages
        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            messages.forEach(message => {
                const messageElement = createMessageElement(message);
                container.appendChild(messageElement);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Create message element
        function createMessageElement(message) {
            const div = document.createElement('div');
            const isOwnMessage = message.senderId === currentUser.uid;
            
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-4`;
            
            div.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                    isOwnMessage 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-800'
                }">
                    <p class="text-sm">${message.text}</p>
                    <p class="text-xs mt-1 ${isOwnMessage ? 'text-blue-100' : 'text-gray-500'}">
                        ${formatTime(new Date(message.timestamp))}
                    </p>
                </div>
            `;

            return div;
        }

        // Send message
        window.sendMessage = async () => {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !activeChat) return;

            try {
                const messagesRef = ref(rtdb, `chats/${activeChat}/messages`);
                const chatRef = ref(rtdb, `chats/${activeChat}`);
                
                const message = {
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now()
                };

                // Add message
                await push(messagesRef, message);
                
                // Update chat metadata
                await set(ref(rtdb, `chats/${activeChat}/lastMessage`), text);
                await set(ref(rtdb, `chats/${activeChat}/lastMessageTime`), Date.now());
                
                // Clear typing indicator
                await set(ref(rtdb, `chats/${activeChat}/metadata/typing/${currentUser.uid}`), false);
                
                // Clear input
                input.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
            }
        };

        // Handle typing
        window.handleTyping = () => {
            if (!activeChat) return;
            
            // Set typing indicator
            set(ref(rtdb, `chats/${activeChat}/metadata/typing/${currentUser.uid}`), true);
            
            // Clear previous timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Set timeout to clear typing indicator
            typingTimeout = setTimeout(() => {
                set(ref(rtdb, `chats/${activeChat}/metadata/typing/${currentUser.uid}`), false);
            }, 2000);
        };

        // Update seen status
        function updateSeenStatus(chatId) {
            set(ref(rtdb, `chats/${chatId}/metadata/lastSeen/${currentUser.uid}`), Date.now());
        }

        // Start chat with user
        window.startChat = async (otherUserId) => {
            const chatId = generateChatId(currentUser.uid, otherUserId);
            
            try {
                // Get other user's data
                const userDoc = await getDoc(doc(db, 'users', otherUserId));
                if (!userDoc.exists()) {
                    alert('User not found');
                    return;
                }
                
                const userData = userDoc.data();
                
                // Initialize chat if it doesn't exist
                const chatRef = ref(rtdb, `chats/${chatId}`);
                const chatSnapshot = await new Promise(resolve => {
                    onValue(chatRef, resolve, { onlyOnce: true });
                });
                
                if (!chatSnapshot.exists()) {
                    await set(chatRef, {
                        participants: [currentUser.uid, otherUserId],
                        createdAt: Date.now(),
                        lastMessage: '',
                        lastMessageTime: Date.now()
                    });
                }
                
                // Switch to messages view and open chat
                showMessagesSection();
                setTimeout(() => openChat(chatId, userData), 100);
                
            } catch (error) {
                console.error('Error starting chat:', error);
                alert('Error starting chat');
            }
        };

        // Sign in existing user
        window.signIn = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        };

        // Show signup form
        window.showSignup = () => {
            showSignupSection();
        };

        // Show login form
        window.showLogin = () => {
            showLoginSection();
        };

        // Sign up new user
        window.signUp = async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const username = document.getElementById('signupUsername').value.toLowerCase();
            const displayName = document.getElementById('signupDisplayName').value;

            if (!email || !password || !username || !displayName) {
                alert('Please fill in all fields');
                return;
            }

            if (!/^[a-z0-9_.]+$/.test(username)) {
                alert('Username can only contain lowercase letters, numbers, underscores, and periods');
                return;
            }

            try {
                const usernameQuery = query(collection(db, 'users'), where('username', '==', username));
                const usernameSnapshot = await getDocs(usernameQuery);
                
                if (!usernameSnapshot.empty) {
                    alert('Username is already taken');
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const profile = {
                    uid: user.uid,
                    username: username,
                    displayName: displayName,
                    email: email,
                    bio: '',
                    profileImageUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`,
                    createdAt: serverTimestamp(),
                    followers: [],
                    following: [],
                    isPrivate: false,
                    isVerified: false,
                    isSuspended: false,
                    customVerificationBadgeUrl: null,
                    blockedUsers: []
                };

                await setDoc(doc(db, 'users', user.uid), profile);
                console.log('User created successfully');

            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed: ' + error.message);
            }
        };

        // View profile
        window.viewProfile = async (username) => {
            try {
                let targetUser;
                
                if (!username || username === currentUserProfile.username) {
                    targetUser = currentUserProfile;
                } else {
                    const userQuery = query(collection(db, 'users'), where('username', '==', username));
                    const userSnapshot = await getDocs(userQuery);
                    
                    if (userSnapshot.empty) {
                        alert('User not found');
                        return;
                    }
                    
                    targetUser = userSnapshot.docs[0].data();
                }

                await displayProfile(targetUser);
                showProfileSection();

            } catch (error) {
                console.error('Error viewing profile:', error);
                alert('Error loading profile');
            }
        };

        // Display profile information
        async function displayProfile(userProfile) {
            const isOwnProfile = userProfile.uid === currentUser.uid;
            const isFollowing = currentUserProfile.following.includes(userProfile.uid);
            const isBlocked = currentUserProfile.blockedUsers.includes(userProfile.uid) || 
                             userProfile.blockedUsers.includes(currentUser.uid);

            const buzzQuery = query(collection(db, 'buzzes'), where('authorId', '==', userProfile.uid));
            const buzzSnapshot = await getDocs(buzzQuery);
            const buzzCount = buzzSnapshot.size;

            document.getElementById('profileImage').src = userProfile.profileImageUrl;
            
            // Display name with verification badge
            const displayNameContainer = document.getElementById('profileDisplayName');
            displayNameContainer.innerHTML = `${userProfile.displayName} ${createVerificationBadge(userProfile)}`;
            
            document.getElementById('profileUsername').textContent = `@${userProfile.username}`;
            document.getElementById('profileBio').textContent = userProfile.bio || 'No bio yet';
            document.getElementById('profileJoinDate').textContent = `Joined ${formatDate(userProfile.createdAt)}`;
            document.getElementById('profileBuzzCount').textContent = buzzCount;
            document.getElementById('profileFollowerCount').textContent = userProfile.followers.length;
            document.getElementById('profileFollowingCount').textContent = userProfile.following.length;

            const editButton = document.getElementById('editProfileButton');
            const followButton = document.getElementById('followButton');
            const blockButton = document.getElementById('blockButton');
            const messageButton = document.getElementById('messageButton');
            const reportButton = document.getElementById('reportProfileButton');
            const verifyButton = document.getElementById('verifyButton');

            if (isOwnProfile) {
                editButton.classList.remove('hidden');
                followButton.classList.add('hidden');
                blockButton.classList.add('hidden');
                messageButton.classList.add('hidden');
                reportButton.classList.add('hidden');
                
                // Show verification button if not verified
                if (!userProfile.isVerified) {
                    verifyButton.classList.remove('hidden');
                } else {
                    verifyButton.classList.add('hidden');
                }
            } else {
                editButton.classList.add('hidden');
                verifyButton.classList.add('hidden');
                followButton.classList.remove('hidden');
                blockButton.classList.remove('hidden');
                messageButton.classList.remove('hidden');
                reportButton.classList.remove('hidden');

                followButton.textContent = isFollowing ? 'Unfollow' : 'Follow';
                followButton.onclick = () => toggleFollow(userProfile.uid, isFollowing);
                blockButton.onclick = () => blockUser(userProfile.uid);
                messageButton.onclick = () => startChat(userProfile.uid);
                reportButton.onclick = () => showReportModal(userProfile.uid, 'user', userProfile.username);
            }

            const canViewBuzzes = !isBlocked && (!userProfile.isPrivate || isOwnProfile || isFollowing);
            await loadUserBuzzes(userProfile.uid, canViewBuzzes);
        }

        // Toggle follow/unfollow
        async function toggleFollow(targetUserId, isCurrentlyFollowing) {
            try {
                const batch = writeBatch(db);
                const currentUserRef = doc(db, 'users', currentUser.uid);
                const targetUserRef = doc(db, 'users', targetUserId);

                if (isCurrentlyFollowing) {
                    batch.update(currentUserRef, {
                        following: arrayRemove(targetUserId)
                    });
                    batch.update(targetUserRef, {
                        followers: arrayRemove(currentUser.uid)
                    });
                } else {
                    batch.update(currentUserRef, {
                        following: arrayUnion(targetUserId)
                    });
                    batch.update(targetUserRef, {
                        followers: arrayUnion(currentUser.uid)
                    });
                    
                    // Create follow notification
                    await createNotification(targetUserId, 'follow', {});
                }

                await batch.commit();
                
                if (isCurrentlyFollowing) {
                    currentUserProfile.following = currentUserProfile.following.filter(id => id !== targetUserId);
                } else {
                    currentUserProfile.following.push(targetUserId);
                }

                const userQuery = query(collection(db, 'users'), where('uid', '==', targetUserId));
                const userSnapshot = await getDocs(userQuery);
                const updatedProfile = userSnapshot.docs[0].data();
                await displayProfile(updatedProfile);

            } catch (error) {
                console.error('Error toggling follow:', error);
                alert('Error updating follow status');
            }
        }

        // Block user
        async function blockUser(targetUserId) {
            if (confirm('Are you sure you want to block this user?')) {
                try {
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        blockedUsers: arrayUnion(targetUserId)
                    });
                    
                    currentUserProfile.blockedUsers.push(targetUserId);
                    alert('User blocked successfully');
                    showMainApp();
                    
                } catch (error) {
                    console.error('Error blocking user:', error);
                    alert('Error blocking user');
                }
            }
        }

        // Load user's buzzes
        async function loadUserBuzzes(userId, canView) {
            const userBuzzesContainer = document.getElementById('userBuzzes');
            
            if (!canView) {
                userBuzzesContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">This account is private</p>
                        <p class="text-sm mt-2">Follow to see their buzzes</p>
                    </div>
                `;
                return;
            }

            try {
                const q = query(
                    collection(db, 'buzzes'),
                    where('authorId', '==', userId),
                    orderBy('timestamp', 'desc')
                );

                const querySnapshot = await getDocs(q);
                const buzzes = [];
                querySnapshot.forEach((doc) => {
                    buzzes.push({ id: doc.id, ...doc.data() });
                });

                if (buzzes.length === 0) {
                    userBuzzesContainer.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <p class="text-lg">No buzzes yet</p>
                        </div>
                    `;
                } else {
                    userBuzzesContainer.innerHTML = '';
                    buzzes.forEach(buzz => {
                        const buzzElement = createBuzzElement(buzz);
                        userBuzzesContainer.appendChild(buzzElement);
                    });
                }

            } catch (error) {
                console.error('Error loading user buzzes:', error);
            }
        }

        // Show edit profile modal
        window.showEditProfile = () => {
            document.getElementById('editDisplayName').value = currentUserProfile.displayName;
            document.getElementById('editBio').value = currentUserProfile.bio || '';
            document.getElementById('editProfileImage').value = currentUserProfile.profileImageUrl;
            document.getElementById('editIsPrivate').checked = currentUserProfile.isPrivate;
            editProfileModal.classList.remove('hidden');
        };

        // Hide edit profile modal
        window.hideEditProfile = () => {
            editProfileModal.classList.add('hidden');
        };

        // Save profile changes
        window.saveProfile = async () => {
            const displayName = document.getElementById('editDisplayName').value;
            const bio = document.getElementById('editBio').value;
            const profileImageUrl = document.getElementById('editProfileImage').value;
            const isPrivate = document.getElementById('editIsPrivate').checked;

            if (!displayName) {
                alert('Display name is required');
                return;
            }

            if (bio.length > 160) {
                alert('Bio must be 160 characters or less');
                return;
            }

            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    displayName: displayName,
                    bio: bio,
                    profileImageUrl: profileImageUrl,
                    isPrivate: isPrivate
                });

                currentUserProfile.displayName = displayName;
                currentUserProfile.bio = bio;
                currentUserProfile.profileImageUrl = profileImageUrl;
                currentUserProfile.isPrivate = isPrivate;

                hideEditProfile();
                updateUserInfo();
                await displayProfile(currentUserProfile);
                alert('Profile updated successfully!');

            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile');
            }
        };

        // Character counter for buzz textarea
        document.addEventListener('DOMContentLoaded', () => {
            const buzzTextarea = document.getElementById('buzzTextarea');
            const buzzButton = document.getElementById('buzzButton');
            const charCount = document.getElementById('charCount');
            const messageInput = document.getElementById('messageInput');

            if (buzzTextarea) {
                buzzTextarea.addEventListener('input', () => {
                    const length = buzzTextarea.value.length;
                    charCount.textContent = `${length}/280`;
                    
                    if (length > 0 && length <= 280) {
                        buzzButton.disabled = false;
                        buzzButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        buzzButton.classList.add('hover:bg-blue-700');
                    } else {
                        buzzButton.disabled = true;
                        buzzButton.classList.add('opacity-50', 'cursor-not-allowed');
                        buzzButton.classList.remove('hover:bg-blue-700');
                    }

                    if (length > 250) {
                        charCount.classList.add('text-red-500');
                        charCount.classList.remove('text-gray-500');
                    } else {
                        charCount.classList.remove('text-red-500');
                        charCount.classList.add('text-gray-500');
                    }
                });
            }

            // Message input enter key
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });

        // Post a new buzz
        window.postBuzz = async () => {
            const buzzText = document.getElementById('buzzTextarea').value.trim();
            
            if (!buzzText || buzzText.length > 280) {
                return;
            }

            try {
                const buzzDoc = await addDoc(collection(db, 'buzzes'), {
                    authorId: currentUser.uid,
                    authorDisplayName: currentUserProfile.displayName,
                    authorUsername: `@${currentUserProfile.username}`,
                    authorProfileImageUrl: currentUserProfile.profileImageUrl,
                    authorIsVerified: currentUserProfile.isVerified || false,
                    authorVerificationBadgeUrl: currentUserProfile.customVerificationBadgeUrl || null,
                    buzzText: buzzText,
                    timestamp: serverTimestamp(),
                    likes: [],
                    rebuzzOf: null,
                    commentCount: 0
                });

                // Check for mentions and create notifications
                const mentions = buzzText.match(/@(\w+)/g);
                if (mentions) {
                    for (const mention of mentions) {
                        const username = mention.substring(1);
                        const userQuery = query(collection(db, 'users'), where('username', '==', username));
                        const userSnapshot = await getDocs(userQuery);
                        
                        if (!userSnapshot.empty) {
                            const mentionedUser = userSnapshot.docs[0].data();
                            if (mentionedUser.uid !== currentUser.uid) {
                                await createNotification(mentionedUser.uid, 'mention', {
                                    buzzId: buzzDoc.id
                                });
                            }
                        }
                    }
                }

                const buzzTextarea = document.getElementById('buzzTextarea');
                const buzzButton = document.getElementById('buzzButton');
                const charCount = document.getElementById('charCount');
                
                buzzTextarea.value = '';
                charCount.textContent = '0/280';
                buzzButton.disabled = true;
                buzzButton.classList.add('opacity-50', 'cursor-not-allowed');
                buzzButton.classList.remove('hover:bg-blue-700');

            } catch (error) {
                console.error('Error posting buzz:', error);
                alert('Error posting buzz. Please try again.');
            }
        };

        // Load user's feed
        async function loadUserFeed() {
            try {
                const followingList = [...currentUserProfile.following, currentUser.uid];
                
                if (followingList.length === 0) {
                    document.getElementById('feedContainer').innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <p class="text-lg">Your feed is empty!</p>
                            <p class="text-sm mt-2">Follow some users to see their buzzes here.</p>
                        </div>
                    `;
                    return;
                }

                const q = query(
                    collection(db, 'buzzes'),
                    where('authorId', 'in', followingList),
                    orderBy('timestamp', 'desc')
                );

                if (feedListener) {
                    feedListener();
                }

                feedListener = onSnapshot(q, (querySnapshot) => {
                    const buzzes = [];
                    querySnapshot.forEach((doc) => {
                        const buzzData = doc.data();
                        if (!currentUserProfile.blockedUsers.includes(buzzData.authorId)) {
                            buzzes.push({ id: doc.id, ...buzzData });
                        }
                    });
                    renderFeed(buzzes);
                });

            } catch (error) {
                console.error('Error loading feed:', error);
            }
        }

        // Render the feed
        function renderFeed(buzzes) {
            const feedContainer = document.getElementById('feedContainer');
            feedContainer.innerHTML = '';

            if (buzzes.length === 0) {
                feedContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">No buzzes to show!</p>
                        <p class="text-sm mt-2">Follow some users or post your first buzz.</p>
                    </div>
                `;
                return;
            }

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                feedContainer.appendChild(buzzElement);
            });
        }

        // Like buzz
        window.likeBuzz = async (buzzId, buzzAuthorId) => {
            try {
                const buzzRef = doc(db, 'buzzes', buzzId);
                const buzzDoc = await getDoc(buzzRef);
                
                if (buzzDoc.exists()) {
                    const buzzData = buzzDoc.data();
                    const likes = buzzData.likes || [];
                    const isLiked = likes.includes(currentUser.uid);
                    
                    if (isLiked) {
                        await updateDoc(buzzRef, {
                            likes: arrayRemove(currentUser.uid)
                        });
                    } else {
                        await updateDoc(buzzRef, {
                            likes: arrayUnion(currentUser.uid)
                        });
                        
                        // Create like notification if not own buzz
                        if (buzzAuthorId !== currentUser.uid) {
                            await createNotification(buzzAuthorId, 'like', {
                                buzzId: buzzId
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error liking buzz:', error);
            }
        };

        // Create buzz element
        function createBuzzElement(buzz) {
            const buzzDiv = document.createElement('div');
            buzzDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow';

            const timeAgo = formatTimeAgo(buzz.timestamp?.toDate());
            const isLiked = buzz.likes && buzz.likes.includes(currentUser.uid);
            const verificationBadge = buzz.authorIsVerified ? 
                `<img src="${buzz.authorVerificationBadgeUrl || 'https://api.dicebear.com/7.x/shapes/svg?seed=verified&backgroundColor=3b82f6'}" alt="Verified" class="w-4 h-4 inline-block ml-1" title="Verified Account">` : '';

            buzzDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${buzz.authorProfileImageUrl}" alt="Profile" class="w-12 h-12 rounded-full cursor-pointer" onclick="viewProfile('${buzz.authorUsername.replace('@', '')}')">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center space-x-2">
                                <div class="flex items-center">
                                    <h3 class="font-semibold text-gray-900 truncate cursor-pointer hover:underline" onclick="viewProfile('${buzz.authorUsername.replace('@', '')}')">${buzz.authorDisplayName}</h3>
                                    ${verificationBadge}
                                </div>
                                <span class="text-gray-500 text-sm cursor-pointer hover:underline" onclick="viewProfile('${buzz.authorUsername.replace('@', '')}')">${buzz.authorUsername}</span>
                                <span class="text-gray-400 text-sm">·</span>
                                <span class="text-gray-500 text-sm">${timeAgo}</span>
                            </div>
                            <div class="relative">
                                <button onclick="toggleBuzzMenu('${buzz.id}')" class="text-gray-400 hover:text-gray-600 p-1">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                    </svg>
                                </button>
                                <div id="buzzMenu-${buzz.id}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                                    <button onclick="showReportModal('${buzz.id}', 'buzz'); toggleBuzzMenu('${buzz.id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                        Report Buzz
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-800 mb-3 whitespace-pre-wrap">${buzz.buzzText}</p>
                        <div class="flex items-center space-x-6 text-gray-500">
                            <button class="flex items-center space-x-1 hover:text-blue-500 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span class="text-sm">${buzz.commentCount}</span>
                            </button>
                            <button class="flex items-center space-x-1 hover:text-green-500 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span class="text-sm">Rebuzz</span>
                            </button>
                            <button onclick="likeBuzz('${buzz.id}', '${buzz.authorId}')" class="flex items-center space-x-1 hover:text-red-500 transition-colors ${isLiked ? 'text-red-500' : ''}">
                                <svg class="w-5 h-5" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <span class="text-sm">${buzz.likes ? buzz.likes.length : 0}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            return buzzDiv;
        }

        // Toggle buzz menu
        window.toggleBuzzMenu = (buzzId) => {
            const menu = document.getElementById(`buzzMenu-${buzzId}`);
            
            // Close all other menus
            document.querySelectorAll('[id^="buzzMenu-"]').forEach(m => {
                if (m.id !== `buzzMenu-${buzzId}`) {
                    m.classList.add('hidden');
                }
            });
            
            menu.classList.toggle('hidden');
        };

        // Format timestamp
        function formatTimeAgo(date) {
            if (!date) return 'now';
            
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return `${diffInSeconds}s ago`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }

        // Format time for messages
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Format date for join date
        function formatDate(timestamp) {
            if (!timestamp) return 'Recently';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }

        // Navigation functions
        window.goHome = () => {
            showMainApp();
            updateActiveNav('home');
        };

        window.goToMyProfile = () => {
            viewProfile(currentUserProfile.username);
            updateActiveNav('profile');
        };

        window.goToMessages = () => {
            showMessagesSection();
            updateActiveNav('messages');
        };

        window.goToVerification = () => {
            showVerificationSection();
        };

        window.goToNotifications = () => {
            toggleNotifications();
            updateActiveNav('notifications');
        };

        // Update active navigation state
        function updateActiveNav(activeItem) {
            // Desktop navigation
            document.querySelectorAll('.desktop-nav .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mobile navigation
            document.querySelectorAll('.mobile-nav .mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to current item
            const desktopItem = document.querySelector(`.desktop-nav .nav-item[data-nav="${activeItem}"]`);
            const mobileItem = document.querySelector(`.mobile-nav .mobile-nav-item[data-nav="${activeItem}"]`);
            
            if (desktopItem) desktopItem.classList.add('active');
            if (mobileItem) mobileItem.classList.add('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#notificationButton') && !e.target.closest('#notificationDropdown')) {
                notificationDropdown.classList.add('hidden');
            }
            
            // Close buzz menus
            if (!e.target.closest('[onclick^="toggleBuzzMenu"]') && !e.target.closest('[id^="buzzMenu-"]')) {
                document.querySelectorAll('[id^="buzzMenu-"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (feedListener) feedListener();
            if (notificationListener) notificationListener();
            if (activeChatListener) activeChatListener();
            if (chatListListener) chatListListener();
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Section -->
    <div id="loginSection" class="flex items-center justify-center min-h-screen px-4">
        <div class="instagram-card p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold instagram-gradient-text mb-3">OrioBuzz</h1>
                <p class="text-gray-600">Connect and share your thoughts</p>
            </div>
            <div class="space-y-4 mb-6">
                <div class="relative">
                    <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="email" id="loginEmail" placeholder="Email" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <button onclick="signIn()" class="w-full instagram-button text-white py-3 px-4 rounded-lg font-medium mb-3">
                <i class="fas fa-sign-in-alt mr-2"></i>
                Sign In
            </button>
            <button onclick="showSignup()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors font-medium">
                <i class="fas fa-user-plus mr-2"></i>
                Create Account
            </button>
        </div>
    </div>

    <!-- Signup Section -->
    <div id="signupSection" class="hidden flex items-center justify-center min-h-screen px-4">
        <div class="instagram-card p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold instagram-gradient-text mb-3">Join OrioBuzz</h1>
                <p class="text-gray-600">Create your account</p>
            </div>
            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="email" id="signupEmail" placeholder="Email" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-at absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="signupUsername" placeholder="Username (lowercase, no spaces)" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="signupDisplayName" placeholder="Display Name" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <button onclick="signUp()" class="w-full instagram-button text-white py-3 px-4 rounded-lg font-medium mt-6">
                <i class="fas fa-user-plus mr-2"></i>
                Sign Up
            </button>
            <button onclick="showLogin()" class="w-full text-gray-600 py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors font-medium mt-2">
                Already have an account? Sign In
            </button>
        </div>
    </div>

    <!-- Onboarding Section -->
    <div id="onboardingSection" class="hidden min-h-screen">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold instagram-gradient-text mb-4">Welcome to OrioBuzz!</h1>
                <p class="text-xl text-gray-600 mb-2">Let's personalize your experience</p>
                <p class="text-gray-500">Select at least 3 interests to get started</p>
            </div>
            
            <div class="instagram-card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900">Choose Your Interests</h2>
                    <div class="text-sm text-gray-500">
                        Selected: <span id="selectedCount" class="font-semibold text-blue-600">0/3</span>
                    </div>
                </div>
                
                <div id="interestsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                    <!-- Interest cards will be populated here -->
                </div>
                
                <div class="text-center">
                    <button 
                        id="completeOnboardingButton" 
                        onclick="completeOnboarding()" 
                        disabled
                        class="px-8 py-3 rounded-lg font-medium text-white opacity-50 cursor-not-allowed transition-all"
                    >
                        <i class="fas fa-arrow-right mr-2"></i>
                        Continue to OrioBuzz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Desktop Navigation -->
        <nav class="desktop-nav fixed left-0 top-0 h-full w-64 instagram-card border-r p-6 z-30">
            <div class="mb-8">
                <h1 class="text-3xl font-bold instagram-gradient-text cursor-pointer" onclick="goHome()">OrioBuzz</h1>
            </div>
            
            <div class="space-y-2">
                <div class="nav-item p-3 cursor-pointer active" data-nav="home" onclick="goHome()">
                    <i class="fas fa-home w-6 mr-4"></i>
                    <span class="font-medium">Home</span>
                </div>
                
                <div class="nav-item p-3 cursor-pointer" data-nav="notifications" onclick="goToNotifications()">
                    <div class="flex items-center">
                        <i class="fas fa-bell w-6 mr-4"></i>
                        <span class="font-medium">Notifications</span>
                        <span id="desktopNotificationBadge" class="hidden notification-badge ml-auto px-2 py-1 text-xs">0</span>
                    </div>
                </div>
                
                <div class="nav-item p-3 cursor-pointer" data-nav="messages" onclick="goToMessages()">
                    <i class="fas fa-envelope w-6 mr-4"></i>
                    <span class="font-medium">Messages</span>
                </div>
                
                <div class="nav-item p-3 cursor-pointer" data-nav="profile" onclick="goToMyProfile()">
                    <i class="fas fa-user w-6 mr-4"></i>
                    <span class="font-medium">Profile</span>
                </div>
                
                <button onclick="document.getElementById('buzzTextarea').focus()" class="w-full buzz-button py-3 px-6 mt-6 font-semibold">
                    <i class="fas fa-plus mr-2"></i>
                    Buzz
                </button>
            </div>
            
            <div class="absolute bottom-6 left-6 right-6">
                <div class="flex items-center space-x-3 mb-4">
                    <img id="desktopUserAvatar" src="" alt="Your avatar" class="w-10 h-10 rounded-full">
                    <div class="flex-1 min-w-0">
                        <p id="desktopUserName" class="font-medium text-sm truncate"></p>
                        <p id="desktopUserHandle" class="text-xs text-gray-500 truncate"></p>
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="toggleDarkMode()" class="flex-1 p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button onclick="logout()" class="flex-1 p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Mobile Header -->
        <header class="md:hidden instagram-card border-b sticky top-0 z-20">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold instagram-gradient-text cursor-pointer" onclick="goHome()">OrioBuzz</h1>
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleDarkMode()" class="p-2 text-gray-600 hover:text-blue-600 transition-colors">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button onclick="logout()" class="p-2 text-gray-600 hover:text-blue-600 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Notification Dropdown (shared) -->
        <div id="notificationDropdown" class="hidden fixed top-16 right-4 w-80 instagram-card rounded-lg shadow-lg z-30">
            <div class="p-4 border-b border-gray-200">
                <h3 class="font-semibold text-gray-900">Notifications</h3>
            </div>
            <div id="notificationList" class="max-h-96 overflow-y-auto">
                <!-- Notifications will be loaded here -->
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content max-w-2xl mx-auto px-4 py-6">
            <!-- Buzz Creation Section -->
            <div class="instagram-card p-4 mb-6">
                <div class="flex space-x-3">
                    <img id="userAvatarPost" src="" alt="Your avatar" class="w-12 h-12 rounded-full">
                    <div class="flex-1">
                        <textarea 
                            id="buzzTextarea"
                            placeholder="What's buzzing?"
                            class="w-full p-3 text-lg resize-none border-none outline-none placeholder-gray-500 bg-transparent"
                            rows="3"
                            maxlength="280"
                        ></textarea>
                        
                        <!-- Coming Soon Image Upload -->
                        <div class="coming-soon-box mb-4">
                            <i class="fas fa-image text-3xl mb-2"></i>
                            <h3 class="font-semibold mb-2">Image Upload - Coming Soon!</h3>
                            <p class="text-sm mb-3">Want to add an image to your buzz?</p>
                            <a href="https://community.oriontec.xyz/Uploadimage.html" target="_blank" class="text-white underline hover:no-underline">
                                Go here and upload your image, copy the URL and paste it below
                            </a>
                            <input type="url" id="buzzImageUrl" placeholder="Paste image URL here..." class="w-full mt-3 p-2 rounded border border-white/30 bg-white/20 text-white placeholder-white/70">
                        </div>
                        
                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                            <div class="flex items-center space-x-4">
                                <button class="p-2 text-gray-400 hover:text-blue-500 transition-colors">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-blue-500 transition-colors">
                                    <i class="fas fa-smile"></i>
                                </button>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span id="charCount" class="text-sm text-gray-500">0/280</span>
                                <button 
                                    id="buzzButton"
                                    onclick="postBuzz()"
                                    disabled
                                    class="buzz-button px-6 py-2 rounded-full font-medium opacity-50 cursor-not-allowed"
                                >
                                    Buzz
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed Section -->
            <div id="feedContainer" class="space-y-4">
                <div class="text-center py-12 text-gray-500">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p>Loading your feed...</p>
                </div>
            </div>
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav hidden fixed bottom-0 left-0 right-0 z-20">
            <div class="flex items-center justify-around py-2">
                <button class="mobile-nav-item p-3 active" data-nav="home" onclick="goHome()">
                    <i class="fas fa-home text-xl"></i>
                </button>
                
                <button class="mobile-nav-item p-3" onclick="alert('Search coming soon!')">
                    <i class="fas fa-search text-xl"></i>
                </button>
                
                <button class="mobile-nav-item p-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full" onclick="document.getElementById('buzzTextarea').focus()">
                    <i class="fas fa-plus text-xl"></i>
                </button>
                
                <button class="mobile-nav-item p-3 relative" data-nav="notifications" onclick="goToNotifications()">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="mobileNotificationBadge" class="hidden notification-badge absolute -top-1 -right-1 px-1.5 py-0.5">0</span>
                </button>
                
                <button class="mobile-nav-item p-3" data-nav="messages" onclick="goToMessages()">
                    <i class="fas fa-envelope text-xl"></i>
                </button>
            </div>
        </nav>
    </div>

    <!-- Verification Section -->
    <div id="verificationSection" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-2xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <button onclick="goHome()" class="text-blue-600 hover:text-blue-700 font-medium">← Back</button>
                    <h1 class="text-xl font-bold text-gray-900">Account Verification</h1>
                    <div></div>
                </div>
            </div>
        </header>

        <!-- Verification Content -->
        <main class="max-w-2xl mx-auto px-4 py-6">
            <!-- Verification Status (hidden by default) -->
            <div id="verificationStatus" class="hidden mb-6">
                <!-- Status content will be populated here -->
            </div>

            <!-- Verification Form -->
            <div id="verificationForm" class="bg-white border border-gray-200 rounded-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Request Verification</h2>
                    <p class="text-gray-600">Get verified to show authenticity and build trust with your audience.</p>
                </div>

                <!-- Error Message -->
                <div id="verificationError" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-red-800"></p>
                </div>

                <form onsubmit="event.preventDefault(); submitVerificationRequest();" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="verificationFullName" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="As it appears in official documents">
                        <p class="text-xs text-gray-500 mt-1">Enter your full legal name exactly as it appears on official documents</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">OrioBuzz Username</label>
                        <input type="text" id="verificationUsername" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                        <select id="verificationCategory" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select a category</option>
                            <option value="News">News & Media</option>
                            <option value="Music">Music & Entertainment</option>
                            <option value="Government">Government & Politics</option>
                            <option value="Entertainment">Entertainment & Celebrity</option>
                            <option value="Sports">Sports</option>
                            <option value="Business">Business & Finance</option>
                            <option value="Technology">Technology</option>
                            <option value="Education">Education</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country of Residence *</label>
                        <input type="text" id="verificationCountry" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., United States">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth *</label>
                        <input type="date" id="verificationDOB" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">You must be at least 13 years old to request verification</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Article Link from oriontec.xyz *</label>
                        <input type="url" id="verificationArticleLink" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://oriontec.xyz/2025-01-15/your-name">
                        <p class="text-xs text-gray-500 mt-1">Must follow format: oriontec.xyz/YYYY-MM-DD/your-name</p>
                        <p class="text-xs text-gray-500">The username in the URL must closely match your full name</p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">Verification Requirements</h3>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>• Must be at least 13 years old</li>
                            <li>• Article link must be from oriontec.xyz domain</li>
                            <li>• URL format must be: oriontec.xyz/date/username</li>
                            <li>• Username in URL must match your full name</li>
                            <li>• All information must be accurate and verifiable</li>
                        </ul>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Submit Verification Request
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Messages Section -->
    <div id="messagesSection" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <button onclick="goHome()" class="text-blue-600 hover:text-blue-700 font-medium">← Back</button>
                    <h1 class="text-xl font-bold text-gray-900">Messages</h1>
                    <div></div>
                </div>
            </div>
        </header>

        <!-- Messages Content -->
        <main class="max-w-6xl mx-auto px-4 py-6">
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden" style="height: 600px;">
                <div class="flex h-full">
                    <!-- Chat List -->
                    <div class="w-1/3 border-r border-gray-200">
                        <div class="p-4 border-b border-gray-200">
                            <h2 class="font-semibold text-gray-900">Conversations</h2>
                        </div>
                        <div id="chatList" class="overflow-y-auto" style="height: calc(100% - 60px);">
                            <!-- Chat list will be loaded here -->
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="flex-1 flex flex-col">
                        <!-- Empty State -->
                        <div id="emptyChatState" class="flex-1 flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <p class="text-lg">Select a conversation</p>
                                <p class="text-sm mt-2">Choose from your existing conversations or start a new one from a user's profile</p>
                            </div>
                        </div>

                        <!-- Active Chat -->
                        <div id="chatArea" class="hidden flex-1 flex flex-col">
                            <!-- Chat Header -->
                            <div class="p-4 border-b border-gray-200">
                                <div id="chatHeader">
                                    <!-- Chat header will be populated here -->
                                </div>
                            </div>

                            <!-- Messages -->
                            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                                <!-- Messages will be loaded here -->
                            </div>

                            <!-- Typing Indicator -->
                            <div id="typingIndicator" class="hidden px-4 py-2 text-sm text-gray-500">
                                <div class="flex items-center space-x-2">
                                    <div class="flex space-x-1">
                                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    </div>
                                    <span>typing...</span>
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="p-4 border-t border-gray-200">
                                <div class="flex space-x-3">
                                    <input 
                                        type="text" 
                                        id="messageInput" 
                                        placeholder="Type a message..." 
                                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        onkeyup="handleTyping()"
                                    >
                                    <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Section -->
    <div id="profileSection" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-2xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <button onclick="goHome()" class="text-blue-600 hover:text-blue-700 font-medium">← Back</button>
                    <h1 class="text-xl font-bold text-gray-900">Profile</h1>
                    <div></div>
                </div>
            </div>
        </header>

        <!-- Profile Content -->
        <main class="max-w-2xl mx-auto px-4 py-6">
            <!-- Profile Header -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                <div class="flex items-start space-x-4 mb-4">
                    <img id="profileImage" src="" alt="Profile" class="w-20 h-20 rounded-full">
                    <div class="flex-1">
                        <h1 id="profileDisplayName" class="text-2xl font-bold text-gray-900 mb-1"></h1>
                        <p id="profileUsername" class="text-gray-500 mb-2"></p>
                        <p id="profileBio" class="text-gray-800 mb-3"></p>
                        <p id="profileJoinDate" class="text-gray-500 text-sm"></p>
                    </div>
                </div>

                <!-- Stats -->
                <div class="flex space-x-6 mb-4">
                    <div class="text-center">
                        <div id="profileBuzzCount" class="font-bold text-lg text-gray-900">0</div>
                        <div class="text-gray-500 text-sm">Buzzes</div>
                    </div>
                    <div class="text-center">
                        <div id="profileFollowingCount" class="font-bold text-lg text-gray-900">0</div>
                        <div class="text-gray-500 text-sm">Following</div>
                    </div>
                    <div class="text-center">
                        <div id="profileFollowerCount" class="font-bold text-lg text-gray-900">0</div>
                        <div class="text-gray-500 text-sm">Followers</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3">
                    <button id="editProfileButton" onclick="showEditProfile()" class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Edit Profile
                    </button>
                    <button id="verifyButton" onclick="goToVerification()" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Get Verified
                    </button>
                    <button id="followButton" class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Follow
                    </button>
                    <button id="messageButton" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Message
                    </button>
                    <button id="blockButton" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        Block
                    </button>
                    <button id="reportProfileButton" class="hidden bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                        Report
                    </button>
                </div>
            </div>

            <!-- User's Buzzes -->
            <div id="userBuzzes" class="space-y-4">
                <div class="text-center py-12 text-gray-500">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p>Loading buzzes...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="instagram-card rounded-lg p-6 max-w-md w-full">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Edit Profile</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                    <input type="text" id="editDisplayName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bio (160 characters max)</label>
                    <textarea id="editBio" maxlength="160" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                </div>
                
                <!-- Coming Soon Profile Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Profile Image</label>
                    <div class="coming-soon-box">
                        <i class="fas fa-camera text-2xl mb-2"></i>
                        <h4 class="font-semibold mb-2">Image Upload - Coming Soon!</h4>
                        <p class="text-sm mb-3">Want to change your profile picture?</p>
                        <a href="https://community.oriontec.xyz/Uploadimage.html" target="_blank" class="text-white underline hover:no-underline text-sm">
                            Go here and upload your image, copy the URL and paste it below
                        </a>
                        <input type="url" id="editProfileImage" placeholder="Paste image URL here..." class="w-full mt-3 p-2 rounded border border-white/30 bg-white/20 text-white placeholder-white/70">
                    </div>
                </div>
                
                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                    <input type="checkbox" id="editIsPrivate" class="mr-3 w-4 h-4 text-blue-600">
                    <label for="editIsPrivate" class="text-sm text-gray-700 font-medium">Private Account</label>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button onclick="saveProfile()" class="flex-1 instagram-button text-white py-3 px-4 rounded-lg font-medium">
                    <i class="fas fa-save mr-2"></i>
                    Save Changes
                </button>
                <button onclick="hideEditProfile()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Report Content</h2>
            <p class="text-gray-600 mb-4">Why are you reporting <span id="reportTargetName"></span>?</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason for Report</label>
                    <select id="reportReason" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a reason</option>
                        <option value="spam">Spam or fake content</option>
                        <option value="harassment">Harassment or bullying</option>
                        <option value="hate-speech">Hate speech</option>
                        <option value="violence">Violence or threats</option>
                        <option value="inappropriate">Inappropriate content</option>
                        <option value="impersonation">Impersonation</option>
                        <option value="copyright">Copyright violation</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button onclick="submitReport()" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                    Submit Report
                </button>
                <button onclick="hideReportModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968b0b6d90b0a74a',t:'MTc1NDExMTE3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
