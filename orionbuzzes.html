<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OrioBuzz - Social Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --instagram-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            --instagram-blue: #0095f6;
            --instagram-dark-blue: #00376b;
            --instagram-light-gray: #fafafa;
            --instagram-border: #dbdbdb;
            --instagram-text: #262626;
            --instagram-secondary-text: #8e8e8e;
            --instagram-error: #ed4956;
            --instagram-success: #00c851;
            --verification-gold: #FFD700;
            --verification-blue: #1DA1F2;
            --verification-purple: #8B5CF6;
        }
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background-color: var(--instagram-light-gray);
            color: var(--instagram-text);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
            zoom: 1;
            -webkit-text-size-adjust: 100%;
        }
        
        .instagram-gradient {
            background: var(--instagram-gradient);
        }
        
        .instagram-gradient-text {
            background: var(--instagram-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .instagram-button {
            background: var(--instagram-blue);
            transition: all 0.2s ease;
        }
        
        .instagram-button:hover {
            background: var(--instagram-dark-blue);
            transform: translateY(-1px);
        }
        
        .instagram-card {
            background: white;
            border: 1px solid var(--instagram-border);
            border-radius: 8px;
        }
        
        .nav-item {
            transition: all 0.2s ease;
            border-radius: 12px;
        }
        
        .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .nav-item.active {
            background-color: rgba(0, 149, 246, 0.1);
            color: var(--instagram-blue);
        }
        
        .buzz-button {
            background: var(--instagram-gradient);
            border: none;
            border-radius: 24px;
            color: white;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .buzz-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .buzz-button:disabled {
            background: #ccc;
            transform: none;
            box-shadow: none;
        }
        
        .mobile-nav {
            background: white;
            border-top: 1px solid var(--instagram-border);
            backdrop-filter: blur(10px);
        }
        
        .mobile-nav-item {
            transition: all 0.2s ease;
        }
        
        .mobile-nav-item:hover {
            color: var(--instagram-blue);
        }
        
        .mobile-nav-item.active {
            color: var(--instagram-blue);
        }
        
        .verification-badge-gold {
            background: var(--verification-gold);
            color: #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .verification-badge-blue {
            background: var(--verification-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .verification-badge-purple {
            background: var(--verification-purple);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .online-indicator {
            width: 12px;
            height: 12px;
            background: #00c851;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            right: 0;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 18px;
            margin: 4px 0;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .message-seen {
            color: var(--instagram-blue);
            font-size: 12px;
        }
        
        .rebuzz-indicator {
            color: #17bf63;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .notification-badge {
            background: #ff3040;
            color: white;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .search-result-item {
            transition: all 0.2s ease;
        }
        
        .search-result-item:hover {
            background-color: rgba(0, 149, 246, 0.05);
        }
        
        @media (max-width: 768px) {
            .desktop-nav {
                display: none !important;
            }
            
            .mobile-nav {
                display: flex !important;
            }
            
            .main-content {
                padding-bottom: 80px;
            }
        }
        
        @media (min-width: 769px) {
            .desktop-nav {
                display: block !important;
            }
            
            .mobile-nav {
                display: none !important;
            }
            
            .main-content {
                margin-left: 250px;
            }
        }
        
        .dark-mode {
            --instagram-light-gray: #000;
            --instagram-text: #fff;
            --instagram-secondary-text: #a8a8a8;
            --instagram-border: #262626;
        }
        
        .dark-mode body {
            background-color: #000;
            color: #fff;
        }
        
        .dark-mode .instagram-card {
            background: #262626;
            border-color: #363636;
        }
        
        .dark-mode .mobile-nav {
            background: #262626;
            border-color: #363636;
        }
        
        /* Disable zoom */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Prevent zoom on input focus */
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea {
            font-size: 16px;
        }
        
        @media screen and (max-width: 768px) {
            input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea {
                font-size: 16px;
                transform: scale(1);
                -webkit-transform: scale(1);
            }
        }
    </style>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp, writeBatch, getDocs, arrayUnion, arrayRemove, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, push, set, onValue, off, serverTimestamp as rtdbServerTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCWB4adPUSrSW2cSd9I3oqYIw65ZnStj4",
            authDomain: "twitter-1903a.firebaseapp.com",
            databaseURL: "https://twitter-1903a-default-rtdb.firebaseio.com",
            projectId: "twitter-1903a",
            storageBucket: "twitter-1903a.firebasestorage.app",
            messagingSenderId: "37758914989",
            appId: "1:37758914989:web:6c364d74288a8b08f8d124"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        // Set persistence to keep user logged in
        setPersistence(auth, browserLocalPersistence);

        let currentUser = null;
        let currentUserProfile = null;
        let feedListener = null;
        let notificationListener = null;
        let activeChat = null;
        let activeChatListener = null;
        let typingTimeout = null;
        let chatListListener = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let selectedInterests = [];
        let userStatusListeners = {};

        // Available interests for onboarding
        const AVAILABLE_INTERESTS = [
            { id: 'technology', name: 'Technology', icon: 'fas fa-laptop-code' },
            { id: 'music', name: 'Music', icon: 'fas fa-music' },
            { id: 'sports', name: 'Sports', icon: 'fas fa-football-ball' },
            { id: 'gaming', name: 'Gaming', icon: 'fas fa-gamepad' },
            { id: 'art', name: 'Art & Design', icon: 'fas fa-palette' },
            { id: 'food', name: 'Food & Cooking', icon: 'fas fa-utensils' },
            { id: 'travel', name: 'Travel', icon: 'fas fa-plane' },
            { id: 'fitness', name: 'Fitness & Health', icon: 'fas fa-dumbbell' },
            { id: 'photography', name: 'Photography', icon: 'fas fa-camera' },
            { id: 'movies', name: 'Movies & TV', icon: 'fas fa-film' },
            { id: 'books', name: 'Books & Reading', icon: 'fas fa-book' },
            { id: 'business', name: 'Business', icon: 'fas fa-briefcase' },
            { id: 'science', name: 'Science', icon: 'fas fa-flask' },
            { id: 'fashion', name: 'Fashion', icon: 'fas fa-tshirt' },
            { id: 'news', name: 'News & Politics', icon: 'fas fa-newspaper' }
        ];

        // Verification badge types
        const VERIFICATION_TYPES = {
            gold: { color: 'gold', icon: '✓', name: 'Gold Verified' },
            blue: { color: 'blue', icon: '✓', name: 'Blue Verified' },
            purple: { color: 'purple', icon: '✓', name: 'Purple Verified' }
        };

        // DOM elements
        const welcomeSection = document.getElementById('welcomeSection');
        const loginSection = document.getElementById('loginSection');
        const signupSection = document.getElementById('signupSection');
        const onboardingSection = document.getElementById('onboardingSection');
        const mainApp = document.getElementById('mainApp');
        const profileSection = document.getElementById('profileSection');
        const messagesSection = document.getElementById('messagesSection');
        const verificationSection = document.getElementById('verificationSection');
        const settingsSection = document.getElementById('settingsSection');
        const searchSection = document.getElementById('searchSection');
        const editProfileModal = document.getElementById('editProfileModal');
        const reportModal = document.getElementById('reportModal');
        const notificationDropdown = document.getElementById('notificationDropdown');

        // Initialize dark mode
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
        }

        // Disable zoom and context menu
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        // Authentication state listener
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    currentUser = user;
                    await loadUserProfile();
                    
                    // Check if user is suspended
                    if (currentUserProfile?.isSuspended) {
                        alert('Your account has been suspended. Please contact support.');
                        await auth.signOut();
                        return;
                    }
                    
                    // Check if user needs onboarding
                    if (!currentUserProfile?.hasCompletedOnboarding) {
                        showOnboardingSection();
                    } else {
                        showMainApp();
                        loadUserFeed();
                        setupNotificationListener();
                        setupPresence();
                    }
                } else {
                    showWelcomeSection();
                }
            } catch (error) {
                console.error('Auth state change error:', error);
                showWelcomeSection();
            }
        });

        // Setup user presence
        function setupPresence() {
            const userStatusRef = ref(rtdb, `/status/${currentUser.uid}`);
            const isOfflineForDatabase = {
                state: 'offline',
                last_changed: rtdbServerTimestamp(),
            };
            const isOnlineForDatabase = {
                state: 'online',
                last_changed: rtdbServerTimestamp(),
            };

            onDisconnect(userStatusRef).set(isOfflineForDatabase);
            set(userStatusRef, isOnlineForDatabase);
        }

        // Generate chat ID from two user IDs
        function generateChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        // Show different sections
        function showWelcomeSection() {
            hideAllSections();
            welcomeSection.classList.remove('hidden');
        }

        function showLoginSection() {
            hideAllSections();
            loginSection.classList.remove('hidden');
        }

        function showSignupSection() {
            hideAllSections();
            signupSection.classList.remove('hidden');
        }

        function showMainApp() {
            hideAllSections();
            mainApp.classList.remove('hidden');
            updateUserInfo();
        }

        function showProfileSection() {
            hideAllSections();
            profileSection.classList.remove('hidden');
        }

        function showMessagesSection() {
            hideAllSections();
            messagesSection.classList.remove('hidden');
            loadChatList();
        }

        function showVerificationSection() {
            hideAllSections();
            verificationSection.classList.remove('hidden');
            loadVerificationForm();
        }

        function showSettingsSection() {
            hideAllSections();
            settingsSection.classList.remove('hidden');
            loadSettings();
        }

        function showSearchSection() {
            hideAllSections();
            searchSection.classList.remove('hidden');
            document.getElementById('searchInput').focus();
        }

        function showOnboardingSection() {
            hideAllSections();
            onboardingSection.classList.remove('hidden');
            loadInterestSelection();
        }

        function hideAllSections() {
            welcomeSection.classList.add('hidden');
            loginSection.classList.add('hidden');
            signupSection.classList.add('hidden');
            onboardingSection.classList.add('hidden');
            mainApp.classList.add('hidden');
            profileSection.classList.add('hidden');
            messagesSection.classList.add('hidden');
            verificationSection.classList.add('hidden');
            settingsSection.classList.add('hidden');
            searchSection.classList.add('hidden');
        }

        // Load interest selection for onboarding
        function loadInterestSelection() {
            const interestsGrid = document.getElementById('interestsGrid');
            interestsGrid.innerHTML = '';
            selectedInterests = [];
            
            AVAILABLE_INTERESTS.forEach(interest => {
                const interestCard = document.createElement('div');
                interestCard.className = 'interest-card p-4 text-center cursor-pointer border-2 border-gray-200 rounded-lg hover:border-blue-500 transition-all';
                interestCard.onclick = () => toggleInterest(interest.id, interestCard);
                
                interestCard.innerHTML = `
                    <i class="${interest.icon} text-2xl mb-2 text-gray-600"></i>
                    <p class="font-medium text-sm">${interest.name}</p>
                `;
                
                interestsGrid.appendChild(interestCard);
            });
            
            updateOnboardingButton();
        }

        // Toggle interest selection
        window.toggleInterest = (interestId, cardElement) => {
            if (selectedInterests.includes(interestId)) {
                selectedInterests = selectedInterests.filter(id => id !== interestId);
                cardElement.classList.remove('border-blue-500', 'bg-blue-50');
                cardElement.classList.add('border-gray-200');
            } else {
                selectedInterests.push(interestId);
                cardElement.classList.add('border-blue-500', 'bg-blue-50');
                cardElement.classList.remove('border-gray-200');
            }
            
            updateOnboardingButton();
        };

        // Update onboarding button state
        function updateOnboardingButton() {
            const button = document.getElementById('completeOnboardingButton');
            const count = document.getElementById('selectedCount');
            
            count.textContent = `${selectedInterests.length}/3`;
            
            if (selectedInterests.length >= 3) {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                button.classList.add('instagram-button');
            } else {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                button.classList.remove('instagram-button');
            }
        }

        // Complete onboarding
        window.completeOnboarding = async () => {
            if (selectedInterests.length < 3) {
                alert('Please select at least 3 interests to continue.');
                return;
            }
            
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    interests: selectedInterests,
                    hasCompletedOnboarding: true
                });
                
                currentUserProfile.interests = selectedInterests;
                currentUserProfile.hasCompletedOnboarding = true;
                
                showMainApp();
                loadUserFeed();
                setupNotificationListener();
                setupPresence();
                
            } catch (error) {
                console.error('Error completing onboarding:', error);
                alert('Error saving your interests. Please try again.');
            }
        };

        // Search functionality
        window.searchUsers = async () => {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (!searchTerm) {
                searchResults.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p class="text-lg">Search for users</p>
                        <p class="text-sm mt-2">Enter a username or display name to find people</p>
                    </div>
                `;
                return;
            }
            
            try {
                searchResults.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">Searching...</p>
                    </div>
                `;
                
                // Search by username
                const usernameQuery = query(
                    collection(db, 'users'),
                    where('username', '>=', searchTerm),
                    where('username', '<=', searchTerm + '\uf8ff'),
                    limit(20)
                );
                
                // Search by display name
                const displayNameQuery = query(
                    collection(db, 'users'),
                    where('displayName', '>=', searchTerm),
                    where('displayName', '<=', searchTerm + '\uf8ff'),
                    limit(20)
                );
                
                const [usernameSnapshot, displayNameSnapshot] = await Promise.all([
                    getDocs(usernameQuery),
                    getDocs(displayNameQuery)
                ]);
                
                const users = new Map();
                
                usernameSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (!userData.isSuspended && !currentUserProfile.blockedUsers?.includes(userData.uid)) {
                        users.set(userData.uid, userData);
                    }
                });
                
                displayNameSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (!userData.isSuspended && !currentUserProfile.blockedUsers?.includes(userData.uid)) {
                        users.set(userData.uid, userData);
                    }
                });
                
                const userList = Array.from(users.values());
                
                if (userList.length === 0) {
                    searchResults.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-user-slash text-4xl mb-4"></i>
                            <p class="text-lg">No users found</p>
                            <p class="text-sm mt-2">Try searching with a different term</p>
                        </div>
                    `;
                } else {
                    searchResults.innerHTML = '';
                    userList.forEach(user => {
                        const userElement = createSearchResultElement(user);
                        searchResults.appendChild(userElement);
                    });
                }
                
            } catch (error) {
                console.error('Error searching users:', error);
                searchResults.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p class="text-lg">Search error</p>
                        <p class="text-sm mt-2">Please try again</p>
                    </div>
                `;
            }
        };

        // Create search result element
        function createSearchResultElement(user) {
            const div = document.createElement('div');
            div.className = 'search-result-item p-4 border-b border-gray-100 cursor-pointer';
            div.onclick = () => {
                viewProfile(user.username);
            };
            
            const isFollowing = currentUserProfile.following?.includes(user.uid);
            
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img src="${user.profileImageUrl}" alt="${user.displayName}" class="w-12 h-12 rounded-full">
                            <div id="searchOnlineStatus-${user.uid}" class="hidden online-indicator"></div>
                        </div>
                        <div>
                            <div class="flex items-center">
                                <h3 class="font-semibold text-gray-900">${user.displayName}</h3>
                                ${createVerificationBadge(user)}
                            </div>
                            <p class="text-sm text-gray-500">@${user.username}</p>
                            ${user.bio ? `<p class="text-sm text-gray-600 mt-1">${user.bio.substring(0, 50)}${user.bio.length > 50 ? '...' : ''}</p>` : ''}
                        </div>
                    </div>
                    ${user.uid !== currentUser.uid ? `
                        <button 
                            onclick="event.stopPropagation(); toggleFollowFromSearch('${user.uid}', ${isFollowing})"
                            class="px-4 py-2 rounded-lg font-medium transition-colors ${
                                isFollowing 
                                    ? 'bg-gray-200 text-gray-800 hover:bg-gray-300' 
                                    : 'bg-blue-600 text-white hover:bg-blue-700'
                            }"
                        >
                            ${isFollowing ? 'Following' : 'Follow'}
                        </button>
                    ` : ''}
                </div>
            `;
            
            // Get online status
            getUserOnlineStatus(user.uid, (status) => {
                const indicator = document.getElementById(`searchOnlineStatus-${user.uid}`);
                if (indicator) {
                    if (status && status.state === 'online') {
                        indicator.classList.remove('hidden');
                    } else {
                        indicator.classList.add('hidden');
                    }
                }
            });
            
            return div;
        }

        // Toggle follow from search
        window.toggleFollowFromSearch = async (targetUserId, isCurrentlyFollowing) => {
            try {
                const batch = writeBatch(db);
                const currentUserRef = doc(db, 'users', currentUser.uid);
                const targetUserRef = doc(db, 'users', targetUserId);

                if (isCurrentlyFollowing) {
                    batch.update(currentUserRef, {
                        following: arrayRemove(targetUserId)
                    });
                    batch.update(targetUserRef, {
                        followers: arrayRemove(currentUser.uid)
                    });
                } else {
                    batch.update(currentUserRef, {
                        following: arrayUnion(targetUserId)
                    });
                    batch.update(targetUserRef, {
                        followers: arrayUnion(currentUser.uid)
                    });
                    
                    // Create follow notification
                    await createNotification(targetUserId, 'follow', {});
                }

                await batch.commit();
                
                if (isCurrentlyFollowing) {
                    currentUserProfile.following = currentUserProfile.following.filter(id => id !== targetUserId);
                } else {
                    currentUserProfile.following.push(targetUserId);
                }
                
                // Refresh search results
                searchUsers();
                
            } catch (error) {
                console.error('Error toggling follow:', error);
                alert('Error updating follow status');
            }
        };

        // Load verification form
        function loadVerificationForm() {
            document.getElementById('verificationUsername').value = currentUserProfile.username;
            
            // Check if user already has a pending or approved request
            checkExistingVerificationRequest();
        }

        // Check for existing verification request
        async function checkExistingVerificationRequest() {
            try {
                const q = query(
                    collection(db, 'verificationRequests'),
                    where('uid', '==', currentUser.uid)
                );
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const request = snapshot.docs[0].data();
                    const status = request.status;
                    
                    const statusDiv = document.getElementById('verificationStatus');
                    const formDiv = document.getElementById('verificationForm');
                    
                    if (status === 'pending') {
                        statusDiv.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                                <div class="text-yellow-600 mb-4">
                                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Verification Pending</h3>
                                <p class="text-yellow-700">Your verification request is being reviewed by our team. This process typically takes 3-5 business days.</p>
                                <p class="text-sm text-yellow-600 mt-2">Submitted: ${formatDate(request.submittedAt)}</p>
                            </div>
                        `;
                        formDiv.classList.add('hidden');
                        statusDiv.classList.remove('hidden');
                    } else if (status === 'approved') {
                        statusDiv.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                                <div class="text-green-600 mb-4">
                                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-green-800 mb-2">Verification Approved!</h3>
                                <p class="text-green-700">Congratulations! Your account has been verified. Your verification badge is now visible across the platform.</p>
                            </div>
                        `;
                        formDiv.classList.add('hidden');
                        statusDiv.classList.remove('hidden');
                    } else if (status === 'rejected') {
                        statusDiv.innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                                <div class="text-red-600 mb-4">
                                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-red-800 mb-2">Verification Rejected</h3>
                                <p class="text-red-700">Your verification request was not approved. ${request.rejectionReason || 'Please ensure all information is accurate and try again.'}</p>
                                <button onclick="resubmitVerification()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Submit New Request
                                </button>
                            </div>
                        `;
                        formDiv.classList.add('hidden');
                        statusDiv.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error checking verification status:', error);
            }
        }

        // Validate username format
        function validateUsername(username) {
            const usernameRegex = /^[a-z0-9_.]+$/;
            return usernameRegex.test(username);
        }

        // Validate age (13+ requirement)
        function validateAge(dateOfBirth) {
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age >= 13;
        }

        // Validate article link format
        function validateArticleLink(link, fullName) {
            // Check if link is from oriontec.xyz
            if (!link.includes('oriontec.xyz')) {
                return {
                    valid: false,
                    error: 'Article link must be from oriontec.xyz domain'
                };
            }

            // Check if link follows oriontec.xyz/date/userkanaam format
            const linkPattern = /^https?:\/\/oriontec\.xyz\/\d{4}-\d{2}-\d{2}\/([a-z0-9-_]+)$/i;
            const match = link.match(linkPattern);
            
            if (!match) {
                return {
                    valid: false,
                    error: 'Article link must follow the format: oriontec.xyz/YYYY-MM-DD/user-name'
                };
            }
            
            const userkanaam = match[1].toLowerCase();
            const normalizedName = fullName.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-');
            
            // Check if userkanaam closely matches the full name
            const similarity = calculateSimilarity(userkanaam, normalizedName);
            
            if (similarity < 0.6) { // 60% similarity threshold
                return {
                    valid: false,
                    error: 'The username in the article link does not match your full name'
                };
            }
            
            return { valid: true };
        }

        // Calculate string similarity
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // Levenshtein distance calculation
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // Submit verification request
        window.submitVerificationRequest = async () => {
            const fullName = document.getElementById('verificationFullName').value.trim();
            const username = document.getElementById('verificationUsername').value.trim();
            const category = document.getElementById('verificationCategory').value;
            const country = document.getElementById('verificationCountry').value.trim();
            const dateOfBirth = document.getElementById('verificationDOB').value;
            const articleLink = document.getElementById('verificationArticleLink').value.trim();
            
            // Clear previous errors
            document.getElementById('verificationError').classList.add('hidden');
            
            // Validate required fields
            if (!fullName || !category || !country || !dateOfBirth || !articleLink) {
                showVerificationError('Please fill in all required fields');
                return;
            }
            
            // Validate age
            if (!validateAge(dateOfBirth)) {
                showVerificationError('You must be at least 13 years old to request verification');
                return;
            }
            
            // Validate article link
            const linkValidation = validateArticleLink(articleLink, fullName);
            if (!linkValidation.valid) {
                showVerificationError(linkValidation.error);
                return;
            }
            
            try {
                // Show loading state
                const submitButton = document.querySelector('#verificationForm button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Submitting...';
                submitButton.disabled = true;
                
                // Create verification request
                const verificationRequest = {
                    uid: currentUser.uid,
                    fullName: fullName,
                    username: username,
                    category: category,
                    country: country,
                    dateOfBirth: dateOfBirth,
                    articleLink: articleLink,
                    status: 'pending',
                    submittedAt: serverTimestamp(),
                    reviewedAt: null,
                    reviewedBy: null,
                    rejectionReason: null
                };
                
                await addDoc(collection(db, 'verificationRequests'), verificationRequest);
                
                // Show success message
                document.getElementById('verificationForm').innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                        <div class="text-green-600 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-green-800 mb-2">Request Submitted!</h3>
                        <p class="text-green-700">Your verification request has been submitted successfully. We'll review it within 3-5 business days.</p>
                        <button onclick="showMainApp()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Back to Home
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error submitting verification request:', error);
                showVerificationError('Failed to submit verification request. Please try again.');
                
                // Reset button
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        };

        // Show verification error
        function showVerificationError(message) {
            const errorDiv = document.getElementById('verificationError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Resubmit verification
        window.resubmitVerification = () => {
            document.getElementById('verificationStatus').classList.add('hidden');
            document.getElementById('verificationForm').classList.remove('hidden');
        };

        // Load settings
        function loadSettings() {
            document.getElementById('settingsDarkMode').checked = isDarkMode;
            document.getElementById('settingsPrivateAccount').checked = currentUserProfile?.isPrivate || false;
            document.getElementById('settingsNotifications').checked = currentUserProfile?.notificationsEnabled !== false;
            document.getElementById('settingsEmailNotifications').checked = currentUserProfile?.emailNotifications !== false;
        }

        // Save settings
        window.saveSettings = async () => {
            const darkMode = document.getElementById('settingsDarkMode').checked;
            const privateAccount = document.getElementById('settingsPrivateAccount').checked;
            const notifications = document.getElementById('settingsNotifications').checked;
            const emailNotifications = document.getElementById('settingsEmailNotifications').checked;
            
            try {
                // Update dark mode
                if (darkMode !== isDarkMode) {
                    toggleDarkMode();
                }
                
                // Update other settings
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    isPrivate: privateAccount,
                    notificationsEnabled: notifications,
                    emailNotifications: emailNotifications
                });
                
                currentUserProfile.isPrivate = privateAccount;
                currentUserProfile.notificationsEnabled = notifications;
                currentUserProfile.emailNotifications = emailNotifications;
                
                alert('Settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings. Please try again.');
            }
        };

        // Report content or user
        let reportTarget = null;
        let reportType = null;

        window.showReportModal = (targetId, type, targetName = '') => {
            reportTarget = targetId;
            reportType = type;
            
            document.getElementById('reportTargetName').textContent = 
                type === 'user' ? `@${targetName}` : 'this buzz';
            document.getElementById('reportReason').value = '';
            reportModal.classList.remove('hidden');
        };

        window.hideReportModal = () => {
            reportModal.classList.add('hidden');
            reportTarget = null;
            reportType = null;
        };

        window.submitReport = async () => {
            const reason = document.getElementById('reportReason').value.trim();
            
            if (!reason) {
                alert('Please provide a reason for the report');
                return;
            }
            
            try {
                await addDoc(collection(db, 'reports'), {
                    reporterId: currentUser.uid,
                    reporterUsername: currentUserProfile.username,
                    reportedContentId: reportTarget,
                    reportType: reportType,
                    reason: reason,
                    timestamp: serverTimestamp(),
                    status: 'pending'
                });
                
                hideReportModal();
                alert('Report submitted successfully. Thank you for helping keep OrioBuzz safe.');
                
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Failed to submit report. Please try again.');
            }
        };

        // Load current user's profile
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    currentUserProfile = userDoc.data();
                } else {
                    await createDemoProfile();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                await createDemoProfile();
            }
        }

        // Create demo profile for new users
        async function createDemoProfile() {
            const randomId = Math.random().toString(36).substring(2, 8);
            const profile = {
                uid: currentUser.uid,
                username: `user${randomId}`,
                displayName: `User ${randomId}`,
                email: currentUser.email || `user${randomId}@demo.com`,
                bio: 'New to OrioBuzz!',
                profileImageUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.uid}`,
                createdAt: serverTimestamp(),
                followers: [],
                following: [],
                isPrivate: false,
                isVerified: false,
                verificationBadgeType: null,
                isSuspended: false,
                blockedUsers: [],
                hasCompletedOnboarding: false,
                interests: [],
                notificationsEnabled: true,
                emailNotifications: true
            };

            await setDoc(doc(db, 'users', currentUser.uid), profile);
            currentUserProfile = profile;
        }

        // Toggle dark mode
        window.toggleDarkMode = () => {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode.toString());
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        };

        // Toggle user menu dropdown
        window.toggleUserMenu = () => {
            const dropdown = document.getElementById('userMenuDropdown');
            const icon = document.getElementById('userMenuIcon');
            
            dropdown.classList.toggle('hidden');
            
            if (dropdown.classList.contains('hidden')) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        };

        // Logout function
        window.logout = async () => {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    // Clear any local data
                    localStorage.removeItem('selectedInterests');
                    selectedInterests = [];
                    currentUser = null;
                    currentUserProfile = null;
                    
                    // Clean up listeners
                    if (feedListener) feedListener();
                    if (notificationListener) notificationListener();
                    if (activeChatListener) activeChatListener();
                    if (chatListListener) chatListListener();
                    
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        };

        // Update user info display
        function updateUserInfo() {
            if (currentUserProfile) {
                // Desktop navigation
                const desktopAvatar = document.getElementById('desktopUserAvatar');
                const desktopName = document.getElementById('desktopUserName');
                const desktopHandle = document.getElementById('desktopUserHandle');
                
                if (desktopAvatar) desktopAvatar.src = currentUserProfile.profileImageUrl;
                if (desktopName) desktopName.textContent = currentUserProfile.displayName;
                if (desktopHandle) desktopHandle.textContent = `@${currentUserProfile.username}`;
                
                // Post avatar
                const postAvatar = document.getElementById('userAvatarPost');
                if (postAvatar) postAvatar.src = currentUserProfile.profileImageUrl;
                
                // Textarea placeholder
                const textarea = document.getElementById('buzzTextarea');
                if (textarea) textarea.placeholder = `What's buzzing, ${currentUserProfile.displayName}?`;
            }
        }

        // Create verification badge HTML
        function createVerificationBadge(user) {
            if (!user.isVerified || !user.verificationBadgeType) return '';
            
            const badgeType = user.verificationBadgeType;
            const badgeClass = `verification-badge-${badgeType}`;
            const badgeIcon = VERIFICATION_TYPES[badgeType]?.icon || '✓';
            
            return `<span class="${badgeClass}" title="${VERIFICATION_TYPES[badgeType]?.name || 'Verified'}">${badgeIcon}</span>`;
        }

        // Setup notification listener
        function setupNotificationListener() {
            const notificationsRef = collection(db, 'users', currentUser.uid, 'notifications');
            const q = query(notificationsRef, orderBy('timestamp', 'desc'), limit(50));

            notificationListener = onSnapshot(q, (snapshot) => {
                const notifications = [];
                snapshot.forEach((doc) => {
                    notifications.push({ id: doc.id, ...doc.data() });
                });
                updateNotificationBadge(notifications);
                renderNotifications(notifications);
            });
        }

        // Update notification badge
        function updateNotificationBadge(notifications) {
            const unreadCount = notifications.filter(n => !n.isRead).length;
            const desktopBadge = document.getElementById('desktopNotificationBadge');
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            
            if (unreadCount > 0) {
                const countText = unreadCount > 99 ? '99+' : unreadCount.toString();
                if (desktopBadge) {
                    desktopBadge.textContent = countText;
                    desktopBadge.classList.remove('hidden');
                }
                if (mobileBadge) {
                    mobileBadge.textContent = countText;
                    mobileBadge.classList.remove('hidden');
                }
            } else {
                if (desktopBadge) desktopBadge.classList.add('hidden');
                if (mobileBadge) mobileBadge.classList.add('hidden');
            }
        }

        // Toggle notification dropdown
        window.toggleNotifications = async () => {
            notificationDropdown.classList.toggle('hidden');
            
            if (!notificationDropdown.classList.contains('hidden')) {
                // Mark all notifications as read
                const notificationsRef = collection(db, 'users', currentUser.uid, 'notifications');
                const unreadQuery = query(notificationsRef, where('isRead', '==', false));
                const unreadSnapshot = await getDocs(unreadQuery);
                
                const batch = writeBatch(db);
                unreadSnapshot.forEach((doc) => {
                    batch.update(doc.ref, { isRead: true });
                });
                
                if (!unreadSnapshot.empty) {
                    await batch.commit();
                }
            }
        };

        // Render notifications
        function renderNotifications(notifications) {
            const container = document.getElementById('notificationList');
            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }

            notifications.slice(0, 20).forEach(notification => {
                const notificationElement = createNotificationElement(notification);
                container.appendChild(notificationElement);
            });
        }

        // Create notification element
        function createNotificationElement(notification) {
            const div = document.createElement('div');
            div.className = `p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 ${!notification.isRead ? 'bg-blue-50' : ''}`;
            
            let message = '';
            let action = '';
            
            switch (notification.type) {
                case 'follow':
                    message = `${notification.senderDisplayName} started following you`;
                    action = `viewProfile('${notification.senderUsername}')`;
                    break;
                case 'like':
                    message = `${notification.senderDisplayName} liked your buzz`;
                    action = `viewBuzz('${notification.buzzId}')`;
                    break;
                case 'rebuzz':
                    message = `${notification.senderDisplayName} rebuzzed your buzz`;
                    action = `viewBuzz('${notification.buzzId}')`;
                    break;
                case 'comment':
                    message = `${notification.senderDisplayName} commented on your buzz`;
                    action = `viewBuzz('${notification.buzzId}')`;
                    break;
                case 'mention':
                    message = `${notification.senderDisplayName} mentioned you in a buzz`;
                    action = `viewBuzz('${notification.buzzId}')`;
                    break;
            }

            div.onclick = () => {
                notificationDropdown.classList.add('hidden');
                eval(action);
            };

            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 ${notification.isRead ? 'opacity-0' : ''}"></div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800">${message}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatTimeAgo(notification.timestamp?.toDate())}</p>
                    </div>
                </div>
            `;

            return div;
        }

        // Create notification
        async function createNotification(recipientId, type, data) {
            try {
                if (recipientId === currentUser.uid) return; // Don't notify self
                
                const notification = {
                    type: type,
                    senderId: currentUser.uid,
                    senderDisplayName: currentUserProfile.displayName,
                    senderUsername: currentUserProfile.username,
                    timestamp: serverTimestamp(),
                    isRead: false,
                    ...data
                };

                await addDoc(collection(db, 'users', recipientId, 'notifications'), notification);
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Get user online status
        function getUserOnlineStatus(userId, callback) {
            const statusRef = ref(rtdb, `/status/${userId}`);
            
            if (userStatusListeners[userId]) {
                off(statusRef, 'value', userStatusListeners[userId]);
            }
            
            userStatusListeners[userId] = onValue(statusRef, (snapshot) => {
                const status = snapshot.val();
                callback(status);
            });
        }

        // Load chat list
        function loadChatList() {
            const chatListRef = ref(rtdb, 'chats');
            
            if (chatListListener) {
                off(chatListRef, 'value', chatListListener);
            }

            chatListListener = onValue(chatListRef, (snapshot) => {
                const chats = [];
                const data = snapshot.val();
                
                if (data) {
                    Object.keys(data).forEach(chatId => {
                        if (chatId.includes(currentUser.uid)) {
                            const chat = data[chatId];
                            const otherUserId = chatId.split('_').find(id => id !== currentUser.uid);
                            chats.push({
                                id: chatId,
                                otherUserId: otherUserId,
                                lastMessage: chat.lastMessage,
                                lastMessageTime: chat.lastMessageTime
                            });
                        }
                    });
                }

                renderChatList(chats);
            });
        }

        // Render chat list
        async function renderChatList(chats) {
            const container = document.getElementById('chatList');
            container.innerHTML = '';

            if (chats.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>No conversations yet</p>
                        <p class="text-sm mt-2">Start a conversation from a user's profile</p>
                    </div>
                `;
                return;
            }

            // Sort by last message time
            chats.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));

            for (const chat of chats) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', chat.otherUserId));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const chatElement = createChatListItem(chat, userData);
                        container.appendChild(chatElement);
                    }
                } catch (error) {
                    console.error('Error loading chat user data:', error);
                }
            }
        }

        // Create chat list item
        function createChatListItem(chat, userData) {
            const div = document.createElement('div');
            div.className = `p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 ${activeChat === chat.id ? 'bg-blue-50' : ''}`;
            div.onclick = () => openChat(chat.id, userData);

            const lastMessageText = chat.lastMessage ? 
                (chat.lastMessage.length > 50 ? chat.lastMessage.substring(0, 50) + '...' : chat.lastMessage) : 
                'No messages yet';

            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <img src="${userData.profileImageUrl}" alt="${userData.displayName}" class="w-12 h-12 rounded-full">
                        <div id="onlineStatus-${userData.uid}" class="hidden online-indicator"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <h3 class="font-semibold text-gray-900 truncate">${userData.displayName}</h3>
                            ${createVerificationBadge(userData)}
                        </div>
                        <p class="text-sm text-gray-500 truncate">@${userData.username}</p>
                        <p class="text-sm text-gray-600 truncate mt-1">${lastMessageText}</p>
                    </div>
                </div>
            `;

            // Get online status
            getUserOnlineStatus(userData.uid, (status) => {
                const indicator = document.getElementById(`onlineStatus-${userData.uid}`);
                if (indicator) {
                    if (status && status.state === 'online') {
                        indicator.classList.remove('hidden');
                    } else {
                        indicator.classList.add('hidden');
                    }
                }
            });

            return div;
        }

        // Open chat
        function openChat(chatId, otherUser) {
            activeChat = chatId;
            
            // Update UI
            document.getElementById('chatHeader').innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <img src="${otherUser.profileImageUrl}" alt="${otherUser.displayName}" class="w-10 h-10 rounded-full">
                        <div id="chatOnlineStatus" class="hidden online-indicator"></div>
                    </div>
                    <div>
                        <div class="flex items-center">
                            <h3 class="font-semibold text-gray-900">${otherUser.displayName}</h3>
                            ${createVerificationBadge(otherUser)}
                        </div>
                        <p class="text-sm text-gray-500">@${otherUser.username}</p>
                        <p id="userStatus" class="text-xs text-gray-400"></p>
                    </div>
                </div>
            `;

            // Get online status for chat header
            getUserOnlineStatus(otherUser.uid, (status) => {
                const indicator = document.getElementById('chatOnlineStatus');
                const statusText = document.getElementById('userStatus');
                
                if (status) {
                    if (status.state === 'online') {
                        if (indicator) indicator.classList.remove('hidden');
                        if (statusText) statusText.textContent = 'Online';
                    } else {
                        if (indicator) indicator.classList.add('hidden');
                        if (statusText) {
                            const lastSeen = new Date(status.last_changed);
                            statusText.textContent = `Last seen ${formatTimeAgo(lastSeen)}`;
                        }
                    }
                }
            });

            // Show chat area
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('emptyChatState').classList.add('hidden');

            // Load messages
            loadChatMessages(chatId);
            
            // Update chat list selection
            loadChatList();
        }

        // Load chat messages
        function loadChatMessages(chatId) {
            const messagesRef = ref(rtdb, `chats/${chatId}/messages`);
            const typingRef = ref(rtdb, `chats/${chatId}/metadata/typing`);
            
            if (activeChatListener) {
                off(messagesRef, 'value', activeChatListener);
            }

            // Listen for messages
            activeChatListener = onValue(messagesRef, (snapshot) => {
                const messages = [];
                const data = snapshot.val();
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        messages.push({ id: key, ...data[key] });
                    });
                }

                messages.sort((a, b) => a.timestamp - b.timestamp);
                renderMessages(messages);
                updateSeenStatus(chatId);
            });

            // Listen for typing indicator
            onValue(typingRef, (snapshot) => {
                const typingData = snapshot.val();
                const typingIndicator = document.getElementById('typingIndicator');
                
                if (typingData && typingData[currentUser.uid] !== true) {
                    const otherUserTyping = Object.keys(typingData).some(uid => 
                        uid !== currentUser.uid && typingData[uid] === true
                    );
                    
                    if (otherUserTyping) {
                        typingIndicator.classList.remove('hidden');
                    } else {
                        typingIndicator.classList.add('hidden');
                    }
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });
        }

        // Render messages
        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            messages.forEach((message, index) => {
                const messageElement = createMessageElement(message, messages[index + 1]);
                container.appendChild(messageElement);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Create message element
        function createMessageElement(message, nextMessage) {
            const div = document.createElement('div');
            const isOwnMessage = message.senderId === currentUser.uid;
            const isLastMessage = !nextMessage || nextMessage.senderId !== message.senderId;
            
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-2`;
            
            div.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                    isOwnMessage 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-800'
                }">
                    <p class="text-sm">${message.text}</p>
                    ${isLastMessage ? `
                        <div class="flex items-center justify-between mt-1">
                            <p class="text-xs ${isOwnMessage ? 'text-blue-100' : 'text-gray-500'}">
                                ${formatTime(new Date(message.timestamp))}
                            </p>
                            ${isOwnMessage && message.seen ? '<span class="message-seen text-xs">✓✓</span>' : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            return div;
        }

        // Send message
        window.sendMessage = async () => {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !activeChat) return;

            try {
                const messagesRef = ref(rtdb, `chats/${activeChat}/messages`);
                const chatRef = ref(rtdb, `chats/${activeChat}`);
                
                const message = {
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    seen: false
                };

                // Add message
                await push(messagesRef, message);
                
                // Update chat metadata
                await set(ref(rtdb, `chats/${activeChat}/lastMessage`), text);
                await set(ref(rtdb, `chats/${activeChat}/lastMessageTime`), Date.now());
                
                // Clear typing indicator
                await set(ref(rtdb, `chats/${activeChat}/metadata/typing/${currentUser.uid}`), false);
                
                // Clear input
                input.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
            }
        };

        // Handle typing
        window.handleTyping = () => {
            if (!activeChat) return;
            
            // Set typing indicator
            set(ref(rtdb, `chats/${activeChat}/metadata/typing/${currentUser.uid}`), true);
            
            // Clear previous timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Set timeout to clear typing indicator
            typingTimeout = setTimeout(() => {
                set(ref(rtdb, `chats/${activeChat}/metadata/typing/${currentUser.uid}`), false);
            }, 2000);
        };

        // Update seen status
        function updateSeenStatus(chatId) {
            set(ref(rtdb, `chats/${chatId}/metadata/lastSeen/${currentUser.uid}`), Date.now());
        }

        // Start chat with user
        window.startChat = async (otherUserId) => {
            const chatId = generateChatId(currentUser.uid, otherUserId);
            
            try {
                // Get other user's data
                const userDoc = await getDoc(doc(db, 'users', otherUserId));
                if (!userDoc.exists()) {
                    alert('User not found');
                    return;
                }
                
                const userData = userDoc.data();
                
                // Initialize chat if it doesn't exist
                const chatRef = ref(rtdb, `chats/${chatId}`);
                const chatSnapshot = await new Promise(resolve => {
                    onValue(chatRef, resolve, { onlyOnce: true });
                });
                
                if (!chatSnapshot.exists()) {
                    await set(chatRef, {
                        participants: [currentUser.uid, otherUserId],
                        createdAt: Date.now(),
                        lastMessage: '',
                        lastMessageTime: Date.now()
                    });
                }
                
                // Switch to messages view and open chat
                showMessagesSection();
                setTimeout(() => openChat(chatId, userData), 100);
                
            } catch (error) {
                console.error('Error starting chat:', error);
                alert('Error starting chat');
            }
        };

        // Sign in existing user
        window.signIn = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        };

        // Show signup form
        window.showSignup = () => {
            showSignupSection();
        };

        // Show login form
        window.showLogin = () => {
            showLoginSection();
        };

        // Show existing user login (from main landing)
        window.showExistingUserLogin = () => {
            showLoginSection();
        };

        // Sign up new user
        window.signUp = async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const username = document.getElementById('signupUsername').value.toLowerCase().trim();
            const displayName = document.getElementById('signupDisplayName').value.trim();
            const dateOfBirth = document.getElementById('signupDOB').value;

            if (!email || !password || !username || !displayName || !dateOfBirth) {
                alert('Please fill in all fields');
                return;
            }

            if (!validateUsername(username)) {
                alert('Username can only contain lowercase letters, numbers, underscores, and periods');
                return;
            }

            if (username.length < 3 || username.length > 20) {
                alert('Username must be between 3 and 20 characters');
                return;
            }

            if (!validateAge(dateOfBirth)) {
                alert('You must be at least 13 years old to create an account');
                return;
            }

            try {
                // Check if username is already taken
                const usernameQuery = query(collection(db, 'users'), where('username', '==', username));
                const usernameSnapshot = await getDocs(usernameQuery);
                
                if (!usernameSnapshot.empty) {
                    alert('Username is already taken');
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const profile = {
                    uid: user.uid,
                    username: username,
                    displayName: displayName,
                    email: email,
                    dateOfBirth: dateOfBirth,
                    bio: '',
                    profileImageUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`,
                    createdAt: serverTimestamp(),
                    followers: [],
                    following: [],
                    isPrivate: false,
                    isVerified: false,
                    verificationBadgeType: null,
                    isSuspended: false,
                    blockedUsers: [],
                    hasCompletedOnboarding: false,
                    interests: [],
                    notificationsEnabled: true,
                    emailNotifications: true
                };

                await setDoc(doc(db, 'users', user.uid), profile);
                console.log('User created successfully');

            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed: ' + error.message);
            }
        };

        // View profile
        window.viewProfile = async (username) => {
            try {
                let targetUser;
                
                if (!username || username === currentUserProfile.username) {
                    targetUser = currentUserProfile;
                } else {
                    const userQuery = query(collection(db, 'users'), where('username', '==', username));
                    const userSnapshot = await getDocs(userQuery);
                    
                    if (userSnapshot.empty) {
                        alert('User not found');
                        return;
                    }
                    
                    targetUser = userSnapshot.docs[0].data();
                }

                await displayProfile(targetUser);
                showProfileSection();

            } catch (error) {
                console.error('Error viewing profile:', error);
                alert('Error loading profile');
            }
        };

        // Display profile information
        async function displayProfile(userProfile) {
            const isOwnProfile = userProfile.uid === currentUser.uid;
            const isFollowing = currentUserProfile.following.includes(userProfile.uid);
            const isBlocked = currentUserProfile.blockedUsers.includes(userProfile.uid) || 
                             userProfile.blockedUsers.includes(currentUser.uid);

            const buzzQuery = query(collection(db, 'buzzes'), where('authorId', '==', userProfile.uid));
            const buzzSnapshot = await getDocs(buzzQuery);
            const buzzCount = buzzSnapshot.size;

            document.getElementById('profileImage').src = userProfile.profileImageUrl;
            
            // Display name with verification badge
            const displayNameContainer = document.getElementById('profileDisplayName');
            displayNameContainer.innerHTML = `${userProfile.displayName} ${createVerificationBadge(userProfile)}`;
            
            document.getElementById('profileUsername').textContent = `@${userProfile.username}`;
            document.getElementById('profileBio').textContent = userProfile.bio || 'No bio yet';
            document.getElementById('profileJoinDate').textContent = `Joined ${formatDate(userProfile.createdAt)}`;
            document.getElementById('profileBuzzCount').textContent = buzzCount;
            document.getElementById('profileFollowerCount').textContent = userProfile.followers.length;
            document.getElementById('profileFollowingCount').textContent = userProfile.following.length;

            const editButton = document.getElementById('editProfileButton');
            const followButton = document.getElementById('followButton');
            const blockButton = document.getElementById('blockButton');
            const messageButton = document.getElementById('messageButton');
            const reportButton = document.getElementById('reportProfileButton');
            const verifyButton = document.getElementById('verifyButton');

            if (isOwnProfile) {
                editButton.classList.remove('hidden');
                followButton.classList.add('hidden');
                blockButton.classList.add('hidden');
                messageButton.classList.add('hidden');
                reportButton.classList.add('hidden');
                
                // Show verification button if not verified
                if (!userProfile.isVerified) {
                    verifyButton.classList.remove('hidden');
                } else {
                    verifyButton.classList.add('hidden');
                }
            } else {
                editButton.classList.add('hidden');
                verifyButton.classList.add('hidden');
                followButton.classList.remove('hidden');
                blockButton.classList.remove('hidden');
                messageButton.classList.remove('hidden');
                reportButton.classList.remove('hidden');

                followButton.textContent = isFollowing ? 'Unfollow' : 'Follow';
                followButton.onclick = () => toggleFollow(userProfile.uid, isFollowing);
                blockButton.onclick = () => blockUser(userProfile.uid);
                messageButton.onclick = () => startChat(userProfile.uid);
                reportButton.onclick = () => showReportModal(userProfile.uid, 'user', userProfile.username);
            }

            const canViewBuzzes = !isBlocked && (!userProfile.isPrivate || isOwnProfile || isFollowing);
            await loadUserBuzzes(userProfile.uid, canViewBuzzes);
        }

        // Toggle follow/unfollow
        async function toggleFollow(targetUserId, isCurrentlyFollowing) {
            try {
                const batch = writeBatch(db);
                const currentUserRef = doc(db, 'users', currentUser.uid);
                const targetUserRef = doc(db, 'users', targetUserId);

                if (isCurrentlyFollowing) {
                    batch.update(currentUserRef, {
                        following: arrayRemove(targetUserId)
                    });
                    batch.update(targetUserRef, {
                        followers: arrayRemove(currentUser.uid)
                    });
                } else {
                    batch.update(currentUserRef, {
                        following: arrayUnion(targetUserId)
                    });
                    batch.update(targetUserRef, {
                        followers: arrayUnion(currentUser.uid)
                    });
                    
                    // Create follow notification
                    await createNotification(targetUserId, 'follow', {});
                }

                await batch.commit();
                
                if (isCurrentlyFollowing) {
                    currentUserProfile.following = currentUserProfile.following.filter(id => id !== targetUserId);
                } else {
                    currentUserProfile.following.push(targetUserId);
                }

                const userQuery = query(collection(db, 'users'), where('uid', '==', targetUserId));
                const userSnapshot = await getDocs(userQuery);
                const updatedProfile = userSnapshot.docs[0].data();
                await displayProfile(updatedProfile);

            } catch (error) {
                console.error('Error toggling follow:', error);
                alert('Error updating follow status');
            }
        }

        // Block user
        async function blockUser(targetUserId) {
            if (confirm('Are you sure you want to block this user?')) {
                try {
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        blockedUsers: arrayUnion(targetUserId)
                    });
                    
                    currentUserProfile.blockedUsers.push(targetUserId);
                    alert('User blocked successfully');
                    showMainApp();
                    
                } catch (error) {
                    console.error('Error blocking user:', error);
                    alert('Error blocking user');
                }
            }
        }

        // Load user's buzzes
        async function loadUserBuzzes(userId, canView) {
            const userBuzzesContainer = document.getElementById('userBuzzes');
            
            if (!canView) {
                userBuzzesContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">This account is private</p>
                        <p class="text-sm mt-2">Follow to see their buzzes</p>
                    </div>
                `;
                return;
            }

            try {
                const q = query(
                    collection(db, 'buzzes'),
                    where('authorId', '==', userId),
                    orderBy('timestamp', 'desc'),
                    limit(50)
                );

                const querySnapshot = await getDocs(q);
                const buzzes = [];
                querySnapshot.forEach((doc) => {
                    buzzes.push({ id: doc.id, ...doc.data() });
                });

                if (buzzes.length === 0) {
                    userBuzzesContainer.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <p class="text-lg">No buzzes yet</p>
                        </div>
                    `;
                } else {
                    userBuzzesContainer.innerHTML = '';
                    buzzes.forEach(buzz => {
                        const buzzElement = createBuzzElement(buzz);
                        userBuzzesContainer.appendChild(buzzElement);
                    });
                }

            } catch (error) {
                console.error('Error loading user buzzes:', error);
                userBuzzesContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">Error loading buzzes</p>
                        <button onclick="loadUserBuzzes('${userId}', true)" class="mt-2 text-blue-600 hover:underline">Try again</button>
                    </div>
                `;
            }
        }

        // Show edit profile modal
        window.showEditProfile = () => {
            document.getElementById('editDisplayName').value = currentUserProfile.displayName;
            document.getElementById('editBio').value = currentUserProfile.bio || '';
            document.getElementById('editProfileImage').value = currentUserProfile.profileImageUrl;
            document.getElementById('editIsPrivate').checked = currentUserProfile.isPrivate;
            editProfileModal.classList.remove('hidden');
        };

        // Hide edit profile modal
        window.hideEditProfile = () => {
            editProfileModal.classList.add('hidden');
        };

        // Save profile changes
        window.saveProfile = async () => {
            const displayName = document.getElementById('editDisplayName').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const profileImageUrl = document.getElementById('editProfileImage').value.trim();
            const isPrivate = document.getElementById('editIsPrivate').checked;

            if (!displayName) {
                alert('Display name is required');
                return;
            }

            if (bio.length > 160) {
                alert('Bio must be 160 characters or less');
                return;
            }

            try {
                const updates = {
                    displayName: displayName,
                    bio: bio,
                    isPrivate: isPrivate
                };

                if (profileImageUrl && profileImageUrl !== currentUserProfile.profileImageUrl) {
                    updates.profileImageUrl = profileImageUrl;
                }

                await updateDoc(doc(db, 'users', currentUser.uid), updates);

                // Update local profile
                Object.assign(currentUserProfile, updates);

                hideEditProfile();
                updateUserInfo();
                await displayProfile(currentUserProfile);
                alert('Profile updated successfully!');

            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile');
            }
        };

        // Character counter for buzz textarea
        document.addEventListener('DOMContentLoaded', () => {
            const buzzTextarea = document.getElementById('buzzTextarea');
            const buzzButton = document.getElementById('buzzButton');
            const charCount = document.getElementById('charCount');
            const messageInput = document.getElementById('messageInput');
            const searchInput = document.getElementById('searchInput');

            if (buzzTextarea) {
                buzzTextarea.addEventListener('input', () => {
                    const length = buzzTextarea.value.length;
                    charCount.textContent = `${length}/280`;
                    
                    if (length > 0 && length <= 280) {
                        buzzButton.disabled = false;
                        buzzButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        buzzButton.classList.add('hover:bg-blue-700');
                    } else {
                        buzzButton.disabled = true;
                        buzzButton.classList.add('opacity-50', 'cursor-not-allowed');
                        buzzButton.classList.remove('hover:bg-blue-700');
                    }

                    if (length > 250) {
                        charCount.classList.add('text-red-500');
                        charCount.classList.remove('text-gray-500');
                    } else {
                        charCount.classList.remove('text-red-500');
                        charCount.classList.add('text-gray-500');
                    }
                });
            }

            // Message input enter key
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                messageInput.addEventListener('input', handleTyping);
            }

            // Search input
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchInput.searchTimeout);
                    searchInput.searchTimeout = setTimeout(searchUsers, 300);
                });
            }
        });

        // Post a new buzz
        window.postBuzz = async () => {
            const buzzText = document.getElementById('buzzTextarea').value.trim();
            const imageUrl = document.getElementById('buzzImageUrl').value.trim();
            
            if (!buzzText || buzzText.length > 280) {
                return;
            }

            try {
                const buzzData = {
                    authorId: currentUser.uid,
                    authorDisplayName: currentUserProfile.displayName,
                    authorUsername: currentUserProfile.username,
                    authorProfileImageUrl: currentUserProfile.profileImageUrl,
                    authorIsVerified: currentUserProfile.isVerified || false,
                    authorVerificationBadgeType: currentUserProfile.verificationBadgeType || null,
                    buzzText: buzzText,
                    timestamp: serverTimestamp(),
                    likes: [],
                    rebuzzes: [],
                    rebuzzOf: null,
                    commentCount: 0
                };

                if (imageUrl) {
                    buzzData.imageUrl = imageUrl;
                }

                const buzzDoc = await addDoc(collection(db, 'buzzes'), buzzData);

                // Check for mentions and create notifications
                const mentions = buzzText.match(/@(\w+)/g);
                if (mentions) {
                    for (const mention of mentions) {
                        const username = mention.substring(1);
                        const userQuery = query(collection(db, 'users'), where('username', '==', username));
                        const userSnapshot = await getDocs(userQuery);
                        
                        if (!userSnapshot.empty) {
                            const mentionedUser = userSnapshot.docs[0].data();
                            if (mentionedUser.uid !== currentUser.uid) {
                                await createNotification(mentionedUser.uid, 'mention', {
                                    buzzId: buzzDoc.id
                                });
                            }
                        }
                    }
                }

                // Clear form
                const buzzTextarea = document.getElementById('buzzTextarea');
                const buzzButton = document.getElementById('buzzButton');
                const charCount = document.getElementById('charCount');
                const imageUrlInput = document.getElementById('buzzImageUrl');
                
                buzzTextarea.value = '';
                imageUrlInput.value = '';
                charCount.textContent = '0/280';
                buzzButton.disabled = true;
                buzzButton.classList.add('opacity-50', 'cursor-not-allowed');
                buzzButton.classList.remove('hover:bg-blue-700');

            } catch (error) {
                console.error('Error posting buzz:', error);
                alert('Error posting buzz. Please try again.');
            }
        };

        // Load user's feed
        async function loadUserFeed() {
            try {
                const followingList = [...(currentUserProfile.following || []), currentUser.uid];
                
                let q;
                if (followingList.length <= 10) {
                    q = query(
                        collection(db, 'buzzes'),
                        where('authorId', 'in', followingList),
                        orderBy('timestamp', 'desc'),
                        limit(50)
                    );
                } else {
                    q = query(
                        collection(db, 'buzzes'),
                        orderBy('timestamp', 'desc'),
                        limit(50)
                    );
                }

                if (feedListener) {
                    feedListener();
                }

                feedListener = onSnapshot(q, (querySnapshot) => {
                    const buzzes = [];
                    querySnapshot.forEach((doc) => {
                        const buzzData = doc.data();
                        // Show buzzes from followed users or own buzzes
                        if ((followingList.includes(buzzData.authorId) || followingList.length > 10) && 
                            !currentUserProfile.blockedUsers?.includes(buzzData.authorId)) {
                            buzzes.push({ id: doc.id, ...buzzData });
                        }
                    });
                    renderFeed(buzzes);
                }, (error) => {
                    console.error('Error in feed listener:', error);
                    loadPublicFeed();
                });

            } catch (error) {
                console.error('Error loading feed:', error);
                loadPublicFeed();
            }
        }

        // Fallback function to load public feed
        async function loadPublicFeed() {
            try {
                const q = query(
                    collection(db, 'buzzes'),
                    orderBy('timestamp', 'desc'),
                    limit(50)
                );

                const querySnapshot = await getDocs(q);
                const buzzes = [];
                querySnapshot.forEach((doc) => {
                    const buzzData = doc.data();
                    if (!currentUserProfile.blockedUsers?.includes(buzzData.authorId)) {
                        buzzes.push({ id: doc.id, ...buzzData });
                    }
                });
                renderFeed(buzzes);
            } catch (error) {
                console.error('Error loading public feed:', error);
                document.getElementById('feedContainer').innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">Unable to load feed</p>
                        <p class="text-sm mt-2">Please check your connection and try again.</p>
                        <button onclick="loadUserFeed()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Render the feed
        function renderFeed(buzzes) {
            const feedContainer = document.getElementById('feedContainer');
            feedContainer.innerHTML = '';

            if (buzzes.length === 0) {
                feedContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">No buzzes to show!</p>
                        <p class="text-sm mt-2">Follow some users or post your first buzz.</p>
                    </div>
                `;
                return;
            }

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                feedContainer.appendChild(buzzElement);
            });
        }

        // Like buzz
        window.likeBuzz = async (buzzId, buzzAuthorId) => {
            try {
                const buzzRef = doc(db, 'buzzes', buzzId);
                const buzzDoc = await getDoc(buzzRef);
                
                if (buzzDoc.exists()) {
                    const buzzData = buzzDoc.data();
                    const likes = buzzData.likes || [];
                    const isLiked = likes.includes(currentUser.uid);
                    
                    if (isLiked) {
                        await updateDoc(buzzRef, {
                            likes: arrayRemove(currentUser.uid)
                        });
                    } else {
                        await updateDoc(buzzRef, {
                            likes: arrayUnion(currentUser.uid)
                        });
                        
                        // Create like notification if not own buzz
                        if (buzzAuthorId !== currentUser.uid) {
                            await createNotification(buzzAuthorId, 'like', {
                                buzzId: buzzId
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error liking buzz:', error);
            }
        };

        // Rebuzz functionality
        window.rebuzzBuzz = async (buzzId, buzzAuthorId) => {
            try {
                const buzzRef = doc(db, 'buzzes', buzzId);
                const buzzDoc = await getDoc(buzzRef);
                
                if (buzzDoc.exists()) {
                    const buzzData = buzzDoc.data();
                    const rebuzzes = buzzData.rebuzzes || [];
                    const isRebuzzed = rebuzzes.includes(currentUser.uid);
                    
                    if (isRebuzzed) {
                        await updateDoc(buzzRef, {
                            rebuzzes: arrayRemove(currentUser.uid)
                        });
                    } else {
                        await updateDoc(buzzRef, {
                            rebuzzes: arrayUnion(currentUser.uid)
                        });
                        
                        // Create rebuzz notification if not own buzz
                        if (buzzAuthorId !== currentUser.uid) {
                            await createNotification(buzzAuthorId, 'rebuzz', {
                                buzzId: buzzId
                            });
                        }
                        
                        // Create a new rebuzz post
                        await addDoc(collection(db, 'buzzes'), {
                            authorId: currentUser.uid,
                            authorDisplayName: currentUserProfile.displayName,
                            authorUsername: currentUserProfile.username,
                            authorProfileImageUrl: currentUserProfile.profileImageUrl,
                            authorIsVerified: currentUserProfile.isVerified || false,
                            authorVerificationBadgeType: currentUserProfile.verificationBadgeType || null,
                            buzzText: buzzData.buzzText,
                            imageUrl: buzzData.imageUrl || null,
                            timestamp: serverTimestamp(),
                            likes: [],
                            rebuzzes: [],
                            rebuzzOf: buzzId,
                            originalAuthor: {
                                id: buzzData.authorId,
                                displayName: buzzData.authorDisplayName,
                                username: buzzData.authorUsername,
                                profileImageUrl: buzzData.authorProfileImageUrl,
                                isVerified: buzzData.authorIsVerified,
                                verificationBadgeType: buzzData.authorVerificationBadgeType
                            },
                            commentCount: 0
                        });
                    }
                }
            } catch (error) {
                console.error('Error rebuzzing:', error);
            }
        };

        // Create buzz element
        function createBuzzElement(buzz) {
            const buzzDiv = document.createElement('div');
            buzzDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow';

            const timeAgo = formatTimeAgo(buzz.timestamp?.toDate());
            const isLiked = buzz.likes && buzz.likes.includes(currentUser.uid);
            const isRebuzzed = buzz.rebuzzes && buzz.rebuzzes.includes(currentUser.uid);
            const verificationBadge = createVerificationBadge({
                isVerified: buzz.authorIsVerified,
                verificationBadgeType: buzz.authorVerificationBadgeType
            });

            // Check if this is a rebuzz
            const isRebuzz = buzz.rebuzzOf && buzz.originalAuthor;
            const rebuzzIndicator = isRebuzz ? `
                <div class="rebuzz-indicator mb-2">
                    <i class="fas fa-retweet mr-2"></i>
                    <span class="text-sm">${buzz.authorDisplayName} rebuzzed</span>
                </div>
            ` : '';

            // Use original author info for rebuzzes
            const displayAuthor = isRebuzz ? buzz.originalAuthor : {
                displayName: buzz.authorDisplayName,
                username: buzz.authorUsername,
                profileImageUrl: buzz.authorProfileImageUrl,
                isVerified: buzz.authorIsVerified,
                verificationBadgeType: buzz.authorVerificationBadgeType
            };

            const displayVerificationBadge = createVerificationBadge(displayAuthor);

            // Process mentions in buzz text
            const processedText = buzz.buzzText.replace(/@(\w+)/g, '<span class="text-blue-600 hover:underline cursor-pointer" onclick="viewProfile(\'$1\')">@$1</span>');

            buzzDiv.innerHTML = `
                ${rebuzzIndicator}
                <div class="flex items-start space-x-3">
                    <img src="${displayAuthor.profileImageUrl}" alt="Profile" class="w-12 h-12 rounded-full cursor-pointer" onclick="viewProfile('${displayAuthor.username}')">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center space-x-2">
                                <div class="flex items-center">
                                    <h3 class="font-semibold text-gray-900 truncate cursor-pointer hover:underline" onclick="viewProfile('${displayAuthor.username}')">${displayAuthor.displayName}</h3>
                                    ${displayVerificationBadge}
                                </div>
                                <span class="text-gray-500 text-sm cursor-pointer hover:underline" onclick="viewProfile('${displayAuthor.username}')">@${displayAuthor.username}</span>
                                <span class="text-gray-400 text-sm">·</span>
                                <span class="text-gray-500 text-sm">${timeAgo}</span>
                            </div>
                            <div class="relative">
                                <button onclick="toggleBuzzMenu('${buzz.id}')" class="text-gray-400 hover:text-gray-600 p-1">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                    </svg>
                                </button>
                                <div id="buzzMenu-${buzz.id}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                                    <button onclick="showReportModal('${buzz.id}', 'buzz'); toggleBuzzMenu('${buzz.id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                        Report Buzz
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-800 mb-3 whitespace-pre-wrap">${processedText}</p>
                        ${buzz.imageUrl ? `<img src="${buzz.imageUrl}" alt="Buzz image" class="rounded-lg max-w-full h-auto mb-3">` : ''}
                        <div class="flex items-center space-x-6 text-gray-500">
                            <button class="flex items-center space-x-1 hover:text-blue-500 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span class="text-sm">${buzz.commentCount || 0}</span>
                            </button>
                            <button onclick="rebuzzBuzz('${buzz.id}', '${buzz.authorId}')" class="flex items-center space-x-1 hover:text-green-500 transition-colors ${isRebuzzed ? 'text-green-500' : ''}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span class="text-sm">${buzz.rebuzzes ? buzz.rebuzzes.length : 0}</span>
                            </button>
                            <button onclick="likeBuzz('${buzz.id}', '${buzz.authorId}')" class="flex items-center space-x-1 hover:text-red-500 transition-colors ${isLiked ? 'text-red-500' : ''}">
                                <svg class="w-5 h-5" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <span class="text-sm">${buzz.likes ? buzz.likes.length : 0}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            return buzzDiv;
        }

        // Toggle buzz menu
        window.toggleBuzzMenu = (buzzId) => {
            const menu = document.getElementById(`buzzMenu-${buzzId}`);
            
            // Close all other menus
            document.querySelectorAll('[id^="buzzMenu-"]').forEach(m => {
                if (m.id !== `buzzMenu-${buzzId}`) {
                    m.classList.add('hidden');
                }
            });
            
            menu.classList.toggle('hidden');
        };

        // Format timestamp
        function formatTimeAgo(date) {
            if (!date) return 'now';
            
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return `${diffInSeconds}s`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d`;
            
            return date.toLocaleDateString();
        }

        // Format time for messages
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Format date for join date
        function formatDate(timestamp) {
            if (!timestamp) return 'Recently';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }

        // Navigation functions
        window.goHome = () => {
            showMainApp();
            updateActiveNav('home');
        };

        window.goToMyProfile = () => {
            viewProfile(currentUserProfile.username);
            updateActiveNav('profile');
        };

        window.goToMessages = () => {
            showMessagesSection();
            updateActiveNav('messages');
        };

        window.goToVerification = () => {
            showVerificationSection();
        };

        window.goToSettings = () => {
            showSettingsSection();
        };

        window.goToSearch = () => {
            showSearchSection();
            updateActiveNav('search');
        };

        window.goToNotifications = () => {
            toggleNotifications();
            updateActiveNav('notifications');
        };

        // Update active navigation state
        function updateActiveNav(activeItem) {
            // Desktop navigation
            document.querySelectorAll('.desktop-nav .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mobile navigation
            document.querySelectorAll('.mobile-nav .mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to current item
            const desktopItem = document.querySelector(`.desktop-nav .nav-item[data-nav="${activeItem}"]`);
            const mobileItem = document.querySelector(`.mobile-nav .mobile-nav-item[data-nav="${activeItem}"]`);
            
            if (desktopItem) desktopItem.classList.add('active');
            if (mobileItem) mobileItem.classList.add('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#notificationButton') && !e.target.closest('#notificationDropdown')) {
                notificationDropdown.classList.add('hidden');
            }
            
            // Close user menu
            if (!e.target.closest('[onclick="toggleUserMenu()"]') && !e.target.closest('#userMenuDropdown')) {
                const userMenu = document.getElementById('userMenuDropdown');
                const userMenuIcon = document.getElementById('userMenuIcon');
                if (userMenu && !userMenu.classList.contains('hidden')) {
                    userMenu.classList.add('hidden');
                    if (userMenuIcon) {
                        userMenuIcon.classList.remove('fa-chevron-down');
                        userMenuIcon.classList.add('fa-chevron-up');
                    }
                }
            }
            
            // Close buzz menus
            if (!e.target.closest('[onclick^="toggleBuzzMenu"]') && !e.target.closest('[id^="buzzMenu-"]')) {
                document.querySelectorAll('[id^="buzzMenu-"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (feedListener) feedListener();
            if (notificationListener) notificationListener();
            if (activeChatListener) activeChatListener();
            if (chatListListener) chatListListener();
            
            // Clean up user status listeners
            Object.values(userStatusListeners).forEach(listener => {
                if (listener) listener();
            });
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Welcome Landing Section -->
    <div id="welcomeSection" class="flex items-center justify-center min-h-screen px-4">
        <div class="instagram-card p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold instagram-gradient-text mb-3">OrioBuzz</h1>
                <p class="text-gray-600">Connect and share your thoughts</p>
            </div>
            <button onclick="showSignup()" class="w-full instagram-button text-white py-3 px-4 rounded-lg font-medium mb-3">
                <i class="fas fa-user-plus mr-2"></i>
                Create Account
            </button>
            <button onclick="showExistingUserLogin()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors font-medium">
                <i class="fas fa-sign-in-alt mr-2"></i>
                Already have an account? Sign In
            </button>
        </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="hidden flex items-center justify-center min-h-screen px-4">
        <div class="instagram-card p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold instagram-gradient-text mb-3">Welcome Back!</h1>
                <p class="text-gray-600">Sign in to your OrioBuzz account</p>
            </div>
            <div class="space-y-4 mb-6">
                <div class="relative">
                    <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="email" id="loginEmail" placeholder="Email" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <button onclick="signIn()" class="w-full instagram-button text-white py-3 px-4 rounded-lg font-medium mb-3">
                <i class="fas fa-sign-in-alt mr-2"></i>
                Sign In
            </button>
            <button onclick="showSignup()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors font-medium">
                <i class="fas fa-user-plus mr-2"></i>
                Don't have an account? Sign Up
            </button>
        </div>
    </div>

    <!-- Signup Section -->
    <div id="signupSection" class="hidden flex items-center justify-center min-h-screen px-4">
        <div class="instagram-card p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold instagram-gradient-text mb-3">Join OrioBuzz</h1>
                <p class="text-gray-600">Create your account</p>
            </div>
            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="email" id="signupEmail" placeholder="Email" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-at absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="signupUsername" placeholder="Username (lowercase, a-z, 0-9, _, .)" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="signupDisplayName" placeholder="Display Name" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="relative">
                    <i class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="date" id="signupDOB" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <p class="text-xs text-gray-500">You must be at least 13 years old to create an account</p>
            </div>
            <button onclick="signUp()" class="w-full instagram-button text-white py-3 px-4 rounded-lg font-medium mt-6">
                <i class="fas fa-user-plus mr-2"></i>
                Sign Up
            </button>
            <button onclick="showLogin()" class="w-full text-gray-600 py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors font-medium mt-2">
                Already have an account? Sign In
            </button>
        </div>
    </div>

    <!-- Onboarding Section -->
    <div id="onboardingSection" class="hidden min-h-screen">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold instagram-gradient-text mb-4">Welcome to OrioBuzz!</h1>
                <p class="text-xl text-gray-600 mb-2">Let's personalize your experience</p>
                <p class="text-gray-500">Select at least 3 interests to get started</p>
            </div>
            
            <div class="instagram-card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900">Choose Your Interests</h2>
                    <div class="text-sm text-gray-500">
                        Selected: <span id="selectedCount" class="font-semibold text-blue-600">0/3</span>
                    </div>
                </div>
                
                <div id="interestsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                    <!-- Interest cards will be populated here -->
                </div>
                
                <div class="text-center">
                    <button 
                        id="completeOnboardingButton" 
                        onclick="completeOnboarding()" 
                        disabled
                        class="px-8 py-3 rounded-lg font-medium text-white opacity-50 cursor-not-allowed transition-all"
                    >
                        <i<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968b49a05229a74d',t:'MTc1NDExMzcyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
