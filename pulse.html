<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - Connect & Chat</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            margin: 10px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
        }

        /* iOS Style Auth Screen */
        .auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 40px;
            position: relative;
        }

        .auth-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.08)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.06)"/></svg>');
            opacity: 0.3;
        }

        .auth-screen.hidden {
            display: none;
        }

        .logo-container {
            position: relative;
            z-index: 2;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 64px;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .logo-subtitle {
            font-size: 18px;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .auth-form {
            background: rgba(255, 255, 255, 0.15);
            padding: 40px;
            border-radius: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            max-width: 450px;
            position: relative;
            z-index: 2;
        }

        .account-type-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 25px;
        }

        .account-type-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .account-type-btn.active {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            opacity: 0.9;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        .business-fields {
            display: none;
            animation: slideDown 0.3s ease;
        }

        .business-fields.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-google {
            background: white;
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        /* iOS Style Sidebar */
        .sidebar {
            width: 380px;
            background: rgba(255, 255, 255, 0.98);
            border-right: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            padding-bottom: 90px;
            backdrop-filter: blur(20px);
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            position: relative;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            transform: translateX(2px);
        }

        .profile-pic {
            width: 55px;
            height: 55px;
            border-radius: 18px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
        }

        .premium-badge {
            position: absolute;
            bottom: -3px;
            right: -3px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .user-info h3 {
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .verified-badge {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .user-status {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .country-flag {
            font-size: 16px;
        }

        .business-badge {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stories Section */
        .stories-section {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .stories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stories-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .add-story-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .stories-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .stories-list::-webkit-scrollbar {
            height: 3px;
        }

        .stories-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .stories-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            min-width: 60px;
            transition: all 0.3s ease;
        }

        .story-item:hover {
            transform: translateY(-2px);
        }

        .story-avatar {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: relative;
            border: 2px solid #667eea;
            margin-bottom: 5px;
            overflow: hidden;
        }

        .story-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 13px;
        }

        .story-avatar.add-story {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px dashed #667eea;
        }

        .story-name {
            font-size: 11px;
            text-align: center;
            font-weight: 500;
            color: #666;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-list::-webkit-scrollbar {
            width: 4px;
        }

        .chat-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        .chat-item {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .chat-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .chat-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .chat-item:hover::before {
            width: 4px;
        }

        .chat-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
        }

        .chat-item.active::before {
            width: 4px;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 13px;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #4CAF50;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(76, 175, 80, 0.3);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .chat-preview {
            font-size: 13px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .chat-meta {
            text-align: right;
            font-size: 12px;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .unread-count {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            padding: 0 6px;
        }

        /* Main Chat Area - Instagram Style */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding-bottom: 90px;
            position: relative;
        }

        .chat-header {
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(20px);
            position: relative;
        }

        .chat-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 25px;
            right: 25px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-header-info:hover {
            transform: translateX(2px);
        }

        .chat-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 12px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        .message {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 8px;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            color: #333;
            border-bottom-left-radius: 8px;
        }

        .message-content {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }

        .message-status {
            font-size: 12px;
        }

        .message-reactions {
            position: absolute;
            bottom: -12px;
            right: 15px;
            background: white;
            border-radius: 15px;
            padding: 4px 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            display: flex;
            gap: 3px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .reaction-picker {
            position: absolute;
            top: -55px;
            right: 0;
            background: white;
            border-radius: 25px;
            padding: 10px 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 10px;
            z-index: 100;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .reaction-picker.hidden {
            display: none;
        }

        .reaction-emoji {
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 5px;
            border-radius: 50%;
        }

        .reaction-emoji:hover {
            transform: scale(1.3);
            background: rgba(102, 126, 234, 0.1);
        }

        /* Voice Message Styles */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 18px;
            max-width: 280px;
            min-width: 200px;
        }

        .voice-play-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
        }

        .voice-waveform {
            flex: 1;
            height: 35px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 35"><rect x="2" y="12" width="3" height="11" rx="1.5" fill="%23667eea"/><rect x="8" y="8" width="3" height="19" rx="1.5" fill="%23667eea"/><rect x="14" y="10" width="3" height="15" rx="1.5" fill="%23667eea"/><rect x="20" y="14" width="3" height="7" rx="1.5" fill="%23667eea"/><rect x="26" y="6" width="3" height="23" rx="1.5" fill="%23667eea"/><rect x="32" y="11" width="3" height="13" rx="1.5" fill="%23667eea"/><rect x="38" y="4" width="3" height="27" rx="1.5" fill="%23667eea"/><rect x="44" y="13" width="3" height="9" rx="1.5" fill="%23667eea"/><rect x="50" y="9" width="3" height="17" rx="1.5" fill="%23667eea"/><rect x="56" y="15" width="3" height="5" rx="1.5" fill="%23667eea"/></svg>') no-repeat center;
            background-size: contain;
        }

        .voice-duration {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 500;
        }

        /* Message Input - iOS Style */
        .message-input-container {
            position: fixed;
            bottom: 90px;
            left: 400px;
            right: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.98);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(20px);
        }

        .message-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: white;
            border-radius: 25px;
            padding: 12px 18px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            padding: 8px 0;
            resize: none;
            max-height: 120px;
            min-height: 20px;
            font-family: inherit;
            line-height: 1.4;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .input-btn:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Bottom Navigation - iOS Style */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 25px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 15px;
            min-width: 70px;
            position: relative;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 0 0 3px 3px;
            transition: width 0.3s ease;
        }

        .nav-item.active::before {
            width: 30px;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
            opacity: 0.8;
        }

        .nav-item.active .nav-label {
            opacity: 1;
            font-weight: 600;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #666;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .welcome-icon {
            font-size: 100px;
            margin-bottom: 25px;
            opacity: 0.3;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .welcome-subtitle {
            font-size: 16px;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .welcome-features {
            font-size: 14px;
            opacity: 0.6;
            line-height: 1.5;
        }

        /* Modals - iOS Style */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 35px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: rgba(0, 0, 0, 0.05);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.1);
        }

        /* Premium Modal */
        .premium-modal {
            max-width: 650px;
        }

        .premium-header {
            text-align: center;
            padding: 35px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            border-radius: 20px;
            margin: -35px -35px 25px -35px;
            position: relative;
            overflow: hidden;
        }

        .premium-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.2)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.15)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
        }

        .premium-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .premium-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .premium-price {
            font-size: 48px;
            font-weight: 800;
            margin: 15px 0;
        }

        .premium-features {
            list-style: none;
            padding: 0;
        }

        .premium-features li {
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 15px;
        }

        .premium-features li:last-child {
            border-bottom: none;
        }

        .premium-features li:before {
            content: "âœ“";
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                margin: 0;
                border-radius: 0;
                height: 100vh;
            }
            
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-chat {
                width: 100%;
            }

            .message-input-container {
                left: 25px;
            }

            .stories-list {
                gap: 8px;
            }

            .story-avatar {
                width: 45px;
                height: 45px;
            }

            .story-name {
                font-size: 10px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            background: white;
            border-radius: 20px;
            max-width: 80px;
            align-self: flex-start;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Online Status */
        .online-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #4CAF50;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        /* Group Chat Styles */
        .group-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .group-members {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Message Status Icons */
        .status-sent { color: #999; }
        .status-delivered { color: #999; }
        .status-read { color: #4CAF50; }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .main-chat {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            }
            
            .message.received {
                background: #333;
                color: #fff;
            }
            
            .sidebar {
                background: rgba(30, 30, 30, 0.98);
                color: #fff;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="logo-container">
            <div class="logo">ðŸ’¬ Pulse</div>
            <div class="logo-subtitle">Connect â€¢ Chat â€¢ Share</div>
        </div>
        
        <div class="auth-form">
            <div class="account-type-selector">
                <button class="account-type-btn active" onclick="selectAccountType('personal')">Personal</button>
                <button class="account-type-btn" onclick="selectAccountType('business')">Business</button>
            </div>
            
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullName" placeholder="Enter your full name" required>
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>
            
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="phone" placeholder="Enter your phone number" required>
            </div>
            
            <!-- Business Fields -->
            <div id="businessFields" class="business-fields">
                <div class="form-group">
                    <label>Business Name</label>
                    <input type="text" id="businessName" placeholder="Enter business name">
                </div>
                
                <div class="form-group">
                    <label>Legal Name</label>
                    <input type="text" id="legalName" placeholder="Enter legal business name">
                </div>
                
                <div class="form-group">
                    <label>Headquarters Address</label>
                    <textarea id="headquarters" placeholder="Enter headquarters address" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>GST Number</label>
                    <input type="text" id="gstNumber" placeholder="Enter GST number">
                </div>
                
                <div class="form-group">
                    <label>Country</label>
                    <select id="businessCountry">
                        <option value="IN">India</option>
                        <option value="US">United States</option>
                        <option value="GB">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="signUp()">Create Account</button>
            <button class="btn btn-google" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
            
            <p style="margin-top: 20px; font-size: 14px; text-align: center; opacity: 0.8;">
                Already have an account? 
                <a href="#" onclick="toggleAuthMode()" style="color: white; text-decoration: underline; font-weight: 500;">Sign In</a>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-profile" onclick="openProfile()">
                    <div class="profile-pic" id="userAvatar">
                        A
                        <div class="premium-badge hidden" id="userPremiumBadge">âœ“</div>
                    </div>
                    <div class="user-info">
                        <h3 id="userName">
                            Arya
                            <div class="verified-badge hidden" id="userVerifiedBadge">âœ“</div>
                        </h3>
                        <div class="user-status" id="userStatus">
                            <span class="country-flag" id="userCountry">ðŸ‡®ðŸ‡³</span>
                            <span class="online-status">
                                <span class="online-dot"></span>
                                Online
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stories Section -->
            <div class="stories-section">
                <div class="stories-header">
                    <div class="stories-title">Stories</div>
                    <button class="add-story-btn" onclick="addStory()">Add</button>
                </div>
                <div class="stories-list" id="storiesList">
                    <div class="story-item" onclick="addStory()">
                        <div class="story-avatar add-story">+</div>
                        <div class="story-name">Add Story</div>
                    </div>
                    
                    <div class="story-item" onclick="viewStory('pulse-official')">
                        <div class="story-avatar">
                            <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23667eea'/><text x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-weight='bold'>P</text></svg>" alt="Pulse">
                            <div class="premium-badge">âœ“</div>
                        </div>
                        <div class="story-name">Pulse</div>
                    </div>
                    
                    <div class="story-item" onclick="viewStory('gursharn')">
                        <div class="story-avatar">
                            <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23ff6b6b'/><text x='50' y='60' text-anchor='middle' fill='white' font-size='30' font-weight='bold'>GA</text></svg>" alt="Gursharn">
                            <div class="premium-badge">âœ“</div>
                        </div>
                        <div class="story-name">Gursharn</div>
                    </div>
                    
                    <div class="story-item" onclick="viewStory('john')">
                        <div class="story-avatar">J</div>
                        <div class="story-name">John</div>
                    </div>
                </div>
            </div>
            
            <!-- Chat List -->
            <div class="chat-list" id="chatList">
                <!-- Chats will be loaded here -->
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-icon">ðŸ’¬</div>
                <h2 class="welcome-title">Welcome to Pulse</h2>
                <p class="welcome-subtitle">Select a chat to start messaging</p>
                <div class="welcome-features">
                    Send messages â€¢ Share media â€¢ Voice calls â€¢ Stories<br>
                    End-to-end encrypted â€¢ Real-time sync
                </div>
            </div>
            
            <div id="chatArea" class="hidden">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-header-info" onclick="viewProfile()">
                        <div class="chat-avatar" id="currentChatAvatar">J</div>
                        <div>
                            <div class="chat-name" id="currentChatName">John Doe</div>
                            <div class="user-status" id="currentChatStatus">
                                <span class="online-status">
                                    <span class="online-dot"></span>
                                    Online
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="action-btn" onclick="startVoiceCall()" title="Voice Call"><i class="fas fa-phone"></i></button>
                        <button class="action-btn" onclick="startVideoCall()" title="Video Call"><i class="fas fa-video"></i></button>
                        <button class="action-btn" onclick="showChatInfo()" title="Chat Info"><i class="fas fa-info-circle"></i></button>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Message Input (Fixed Position) -->
        <div class="message-input-container" id="messageInputContainer" style="display: none;">
            <div class="message-input-wrapper">
                <div class="input-actions">
                    <button class="input-btn" onclick="attachFile()" title="Attach File"><i class="fas fa-paperclip"></i></button>
                    <button class="input-btn" onclick="openCamera()" title="Camera"><i class="fas fa-camera"></i></button>
                </div>
                <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1" onkeypress="handleKeyPress(event)" oninput="handleTyping()"></textarea>
                <div class="input-actions">
                    <button class="input-btn" onclick="openStickerModal()" title="Stickers & Emoji"><i class="fas fa-smile"></i></button>
                    <button class="input-btn" onclick="recordVoice()" title="Voice Message"><i class="fas fa-microphone"></i></button>
                    <button class="input-btn send-btn" onclick="sendMessage()" title="Send"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav" style="display: none;">
        <div class="nav-item active" onclick="switchView('home')">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" onclick="switchView('chats')">
            <div class="nav-icon"><i class="fas fa-comments"></i></div>
            <div class="nav-label">Chats</div>
        </div>
        <div class="nav-item" onclick="switchView('contacts')">
            <div class="nav-icon"><i class="fas fa-user-plus"></i></div>
            <div class="nav-label">Add Contact</div>
        </div>
        <div class="nav-item" onclick="switchView('stories')">
            <div class="nav-icon"><i class="fas fa-book-open"></i></div>
            <div class="nav-label">Stories</div>
        </div>
        <div class="nav-item" onclick="openSettings()">
            <div class="nav-icon"><i class="fas fa-cog"></i></div>
            <div class="nav-label">Settings</div>
        </div>
    </div>

    <!-- Premium Modal -->
    <div id="premiumModal" class="modal hidden">
        <div class="modal-content premium-modal">
            <div class="premium-header">
                <div class="premium-icon">âœ¨</div>
                <div class="premium-title">Pulse Premium</div>
                <div class="premium-price">$130</div>
                <p>Unlock exclusive features and premium experience</p>
            </div>
            
            <ul class="premium-features">
                <li>Edit sent messages anytime</li>
                <li>View deleted messages from others</li>
                <li>Premium verified badge everywhere</li>
                <li>Priority customer support 24/7</li>
                <li>Advanced message reactions & stickers</li>
                <li>Custom chat themes & wallpapers</li>
                <li>Unlimited cloud storage</li>
                <li>Advanced privacy controls</li>
                <li>Message scheduling & reminders</li>
                <li>Read receipts for groups</li>
                <li>Voice message transcription</li>
                <li>Advanced search & filters</li>
            </ul>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="purchasePremium()" id="premiumBtn">Get Premium Now</button>
                <p style="font-size: 12px; margin-top: 15px; opacity: 0.7;">
                    * Premium features available for eligible accounts only
                </p>
            </div>
            
            <button class="close-btn" onclick="closeModal('premiumModal')">&times;</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Profile Settings</h3>
                <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
            </div>
            
            <div style="text-align: center; margin-bottom: 25px;">
                <div class="profile-pic" style="width: 120px; height: 120px; margin: 0 auto; position: relative;" id="profilePicLarge">
                    A
                    <div class="premium-badge hidden" id="profilePremiumBadge">âœ“</div>
                </div>
                <button onclick="uploadProfilePic()" style="margin-top: 15px; padding: 10px 20px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; cursor: pointer; font-weight: 500;">Change Photo</button>
            </div>
            
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="profileName" placeholder="Enter your name">
            </div>
            
            <div class="form-group">
                <label>About</label>
                <textarea id="profileBio" placeholder="Tell us about yourself..." rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="profilePhone" placeholder="Enter phone number">
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="profileEmail" placeholder="Enter email">
            </div>

            <div class="form-group">
                <label>Country</label>
                <input type="text" id="profileCountry" placeholder="Detected from IP" readonly style="background: #f5f5f5;">
            </div>
            
            <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="openPremiumModal()" style="background: linear-gradient(45deg, #FFD700, #FFA500); color: white; border: none; padding: 15px 25px; border-radius: 15px; cursor: pointer; font-weight: bold; font-size: 14px;">
                    âœ¨ Upgrade to Premium
                </button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Contact</h3>
                <button class="close-btn" onclick="closeModal('addContactModal')">&times;</button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button onclick="switchContactMethod('email')" id="emailMethodBtn" class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px;">
                        <i class="fas fa-envelope"></i> Email ID
                    </button>
                    <button onclick="switchContactMethod('qr')" id="qrMethodBtn" class="btn" style="flex: 1; background: white; color: #333; border: 1px solid #ddd; padding: 12px;">
                        <i class="fas fa-qrcode"></i> QR Code
                    </button>
                </div>
                
                <!-- Email Search -->
                <div id="emailSearchSection">
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Search by Email</label>
                        <input type="email" id="contactEmail" placeholder="Enter email address..." style="width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px;">
                    </div>
                    <button onclick="searchByEmail()" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-search"></i> Search Contact
                    </button>
                </div>
                
                <!-- QR Code Section -->
                <div id="qrCodeSection" class="hidden">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: #667eea;"><i class="fas fa-qrcode"></i> My QR Code</h4>
                        <div id="myQRCode" style="background: white; padding: 20px; border-radius: 15px; display: inline-block; border: 2px solid #667eea;">
                            <div style="width: 200px; height: 200px; background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; border-radius: 10px;">
                                <i class="fas fa-qrcode"></i>
                            </div>
                        </div>
                        <p style="margin-top: 15px; font-size: 14px; color: #666;">Share this QR code with others to connect instantly</p>
                        <button onclick="downloadQR()" class="btn" style="background: #4CAF50; color: white; margin-top: 10px; padding: 10px 20px; border: none; border-radius: 8px;">
                            <i class="fas fa-download"></i> Download QR
                        </button>
                    </div>
                    
                    <div style="border-top: 1px solid #eee; padding-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: #667eea;"><i class="fas fa-camera"></i> Scan QR Code</h4>
                        <button onclick="scanQRCode()" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-camera"></i> Open Camera to Scan
                        </button>
                        <p style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                            Or upload QR code image from gallery
                        </p>
                        <input type="file" id="qrUpload" accept="image/*" style="display: none;" onchange="processQRImage(event)">
                        <button onclick="document.getElementById('qrUpload').click()" class="btn" style="width: 100%; margin-top: 10px; background: white; color: #333; border: 1px solid #ddd;">
                            <i class="fas fa-upload"></i> Upload QR Image
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults" class="hidden" style="margin-top: 25px;">
                <h4 style="margin-bottom: 15px; color: #667eea;"><i class="fas fa-user-check"></i> Search Results</h4>
                <div id="searchResultsList"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <div style="max-height: 60vh; overflow-y: auto;">
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">ðŸ‘¤ Account</h4>
                    <button onclick="openProfile()" class="btn" style="background: white; color: #333; border: 1px solid #ddd; text-align: left; padding: 15px 20px;">
                        Edit Profile & Privacy
                    </button>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">âœ¨ Premium</h4>
                    <button onclick="openPremiumModal()" class="btn" style="background: linear-gradient(45deg, #FFD700, #FFA500); color: white; font-weight: bold; padding: 15px 20px;">
                        Upgrade to Premium - $130
                    </button>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">ðŸ”’ Privacy & Security</h4>
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span>Read Receipts</span>
                            <input type="checkbox" checked style="transform: scale(1.2);">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span>Last Seen</span>
                            <input type="checkbox" checked style="transform: scale(1.2);">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Profile Photo</span>
                            <select style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option>Everyone</option>
                                <option>Contacts</option>
                                <option>Nobody</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">ðŸŽ¨ Appearance</h4>
                    <button onclick="toggleTheme()" class="btn" style="background: white; color: #333; border: 1px solid #ddd; text-align: left; padding: 15px 20px;">
                        ðŸŒ™ Toggle Dark Mode
                    </button>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">ðŸ“± Notifications</h4>
                    <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span>Message Notifications</span>
                            <input type="checkbox" checked style="transform: scale(1.2);">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Group Notifications</span>
                            <input type="checkbox" checked style="transform: scale(1.2);">
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">â„¹ï¸ About</h4>
                    <div style="padding: 20px; background: #f9f9f9; border-radius: 12px; font-size: 14px;">
                        <p><strong>Pulse Chat</strong></p>
                        <p>Version 2.1.0</p>
                        <p>Â© 2024 Pulse Technologies</p>
                        <p style="margin-top: 15px; line-height: 1.5;">Made with â¤ï¸ for seamless communication worldwide. Connect, chat, and share with friends, family, and business contacts.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB2XeuTfHZ7FYKLoYb4epKp3upmVqG0fzE",
            authDomain: "pulse-17f40.firebaseapp.com",
            databaseURL: "https://pulse-17f40-default-rtdb.firebaseio.com",
            projectId: "pulse-17f40",
            storageBucket: "pulse-17f40.firebasestorage.app",
            messagingSenderId: "259780854138",
            appId: "1:259780854138:web:89c265fd22a34a7f1fd6c3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let currentChat = null;
        let currentView = 'chats';
        let userCountry = 'IN';
        let mediaRecorder = null;
        let audioChunks = [];
        let accountType = 'personal';
        let typingTimeout = null;

        // Initialize App
        function initializeApp() {
            detectUserCountry();
            setupAuthStateListener();
            setupNotifications();
        }

        // Detect user country from IP
        function detectUserCountry() {
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    userCountry = data.country_code || 'IN';
                    updateCountryDisplay();
                })
                .catch(() => {
                    userCountry = 'IN'; // Default to India
                    updateCountryDisplay();
                });
        }

        function updateCountryDisplay() {
            const countryFlags = {
                'IN': 'ðŸ‡®ðŸ‡³', 'US': 'ðŸ‡ºðŸ‡¸', 'GB': 'ðŸ‡¬ðŸ‡§', 'CA': 'ðŸ‡¨ðŸ‡¦',
                'AU': 'ðŸ‡¦ðŸ‡º', 'DE': 'ðŸ‡©ðŸ‡ª', 'FR': 'ðŸ‡«ðŸ‡·', 'JP': 'ðŸ‡¯ðŸ‡µ'
            };
            document.getElementById('userCountry').textContent = countryFlags[userCountry] || 'ðŸŒ';
        }

        // Auth State Listener
        function setupAuthStateListener() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserProfile();
                    showMainApp();
                    setupRealtimeListeners();
                } else {
                    showAuthScreen();
                }
            });
        }

        // Account Type Selection
        function selectAccountType(type) {
            accountType = type;
            
            // Update UI
            document.querySelectorAll('.account-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide business fields
            const businessFields = document.getElementById('businessFields');
            if (type === 'business') {
                businessFields.classList.add('show');
            } else {
                businessFields.classList.remove('show');
            }
        }

        // Sign Up Function
        async function signUp() {
            const email = document.getElementById('email').value;
            const password = Math.random().toString(36).slice(-8); // Generate random password
            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;

            if (!email || !fullName || !phone) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                // Create user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Prepare user data
                const userData = {
                    name: fullName,
                    email: email,
                    phone: phone,
                    accountType: accountType,
                    country: userCountry,
                    profilePic: '',
                    status: 'Online',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    customStatus: 'Hey there! I am using Pulse.',
                    isPremium: email === 'sgursharn076@gmail.com',
                    isVerified: email === 'sgursharn076@gmail.com',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                // Add business fields if business account
                if (accountType === 'business') {
                    userData.businessName = document.getElementById('businessName').value;
                    userData.legalName = document.getElementById('legalName').value;
                    userData.headquarters = document.getElementById('headquarters').value;
                    userData.gstNumber = document.getElementById('gstNumber').value;
                    userData.businessCountry = document.getElementById('businessCountry').value;
                }

                // Save user data to Firebase
                await database.ref('users/' + user.uid).set(userData);

                // Update display name
                await user.updateProfile({
                    displayName: fullName
                });

                alert('Account created successfully!');
                
            } catch (error) {
                console.error('Sign up error:', error);
                alert('Error creating account: ' + error.message);
            }
        }

        // Google Sign In
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                // Check if user exists in database
                const userSnapshot = await database.ref('users/' + user.uid).once('value');
                
                if (!userSnapshot.exists()) {
                    // New user - show profile setup
                    showProfileSetup(user);
                } else {
                    // Existing user - proceed to main app
                    const userData = userSnapshot.val();
                    if (!userData.profileSetupComplete) {
                        showProfileSetup(user);
                    }
                }

            } catch (error) {
                console.error('Google sign in error:', error);
                alert('Error signing in with Google: ' + error.message);
            }
        }

        // Show Profile Setup
        function showProfileSetup(user) {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('profileSetupModal').classList.remove('hidden');
            
            // Pre-fill with Google data
            document.getElementById('setupName').value = user.displayName || '';
            
            if (user.photoURL) {
                const setupProfilePic = document.getElementById('setupProfilePic');
                setupProfilePic.innerHTML = `<img src="${user.photoURL}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 18px;">`;
            }
        }

        // Upload Profile Picture during setup
        function uploadSetupProfilePic() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        alert('Image size too large. Please select an image under 2MB.');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64Image = event.target.result;
                        const setupProfilePic = document.getElementById('setupProfilePic');
                        setupProfilePic.innerHTML = `<img src="${base64Image}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 18px;">`;
                        setupProfilePic.setAttribute('data-image', base64Image);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Complete Profile Setup
        async function completeProfileSetup() {
            const name = document.getElementById('setupName').value.trim();
            const bio = document.getElementById('setupBio').value.trim();
            const status = document.getElementById('setupStatus').value.trim();
            const phone = document.getElementById('setupPhone').value.trim();
            const businessType = document.getElementById('setupBusinessType').value;
            
            if (!name) {
                alert('Please enter your display name');
                return;
            }

            try {
                const setupProfilePic = document.getElementById('setupProfilePic');
                const profilePic = setupProfilePic.getAttribute('data-image') || currentUser.photoURL || '';
                
                const userData = {
                    name: name,
                    email: currentUser.email,
                    phone: phone,
                    accountType: 'business',
                    businessType: businessType,
                    country: userCountry,
                    profilePic: profilePic,
                    status: 'Online',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    customStatus: bio || 'Available for business',
                    statusMessage: status,
                    isPremium: currentUser.email === 'sgursharn076@gmail.com',
                    isVerified: currentUser.email === 'sgursharn076@gmail.com',
                    profileSetupComplete: true,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref('users/' + currentUser.uid).set(userData);
                await currentUser.updateProfile({ displayName: name });

                document.getElementById('profileSetupModal').classList.add('hidden');
                alert('Profile setup completed successfully!');
                
            } catch (error) {
                console.error('Error completing profile setup:', error);
                alert('Error setting up profile. Please try again.');
            }
        }

        // Load User Profile
        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const snapshot = await database.ref('users/' + currentUser.uid).once('value');
                const userData = snapshot.val();
                
                if (userData) {
                    updateUserUI(userData);
                    
                    // Update online status
                    await database.ref('users/' + currentUser.uid + '/status').set('Online');
                    await database.ref('users/' + currentUser.uid + '/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        function updateUserUI(userData) {
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userAvatar').textContent = userData.name.charAt(0).toUpperCase();
            
            if (userData.profilePic) {
                document.getElementById('userAvatar').innerHTML = `<img src="${userData.profilePic}" alt="Profile">`;
            }
            
            // Show premium badge if eligible
            if (userData.isPremium) {
                document.getElementById('userPremiumBadge').classList.remove('hidden');
                document.getElementById('userVerifiedBadge').classList.remove('hidden');
            }
            
            // Update country flag
            const countryFlags = {
                'IN': 'ðŸ‡®ðŸ‡³', 'US': 'ðŸ‡ºðŸ‡¸', 'GB': 'ðŸ‡¬ðŸ‡§', 'CA': 'ðŸ‡¨ðŸ‡¦',
                'AU': 'ðŸ‡¦ðŸ‡º', 'DE': 'ðŸ‡©ðŸ‡ª', 'FR': 'ðŸ‡«ðŸ‡·', 'JP': 'ðŸ‡¯ðŸ‡µ'
            };
            document.getElementById('userCountry').textContent = countryFlags[userData.country] || 'ðŸŒ';
        }

        // Show/Hide Screens
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('bottomNav').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('bottomNav').style.display = 'flex';
            
            loadChats();
            setupPulseOfficialAccount();
        }

        // Setup Realtime Listeners
        function setupRealtimeListeners() {
            // Listen for new chats being created
            database.ref('chats').on('child_added', (snapshot) => {
                const chatId = snapshot.key;
                const chatData = snapshot.val();
                
                // Check if this chat involves current user
                if (chatData.participants && chatData.participants.includes(currentUser.uid)) {
                    loadChats(); // Refresh chat list when new chat is added
                }
            });
            
            // Listen for chat updates (new messages, etc.)
            database.ref('chats').on('child_changed', (snapshot) => {
                const chatId = snapshot.key;
                const chatData = snapshot.val();
                
                // Check if this chat involves current user
                if (chatData.participants && chatData.participants.includes(currentUser.uid)) {
                    // If we're currently in this chat, reload messages
                    if (currentChat === chatId) {
                        loadMessages(chatId);
                    }
                    // Always refresh chat list to show updated last message
                    loadChats();
                }
            });

            // Listen for user status changes
            database.ref('users').on('child_changed', (snapshot) => {
                loadChats(); // Refresh to update online status
            });
            
            // Listen for new messages in current chat
            if (currentChat) {
                database.ref(`chats/${currentChat}/messages`).on('child_added', (snapshot) => {
                    const messageId = snapshot.key;
                    const message = snapshot.val();
                    
                    // Only add if message doesn't already exist in UI
                    if (!document.querySelector(`[data-message-id="${messageId}"]`)) {
                        const messagesContainer = document.getElementById('messagesContainer');
                        const messageElement = createMessageElement(messageId, message);
                        messagesContainer.appendChild(messageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                });
            }
        }

        // Setup Pulse Official Account
        async function setupPulseOfficialAccount() {
            const pulseData = {
                name: 'Pulse Official',
                email: 'official@pulse.com',
                accountType: 'business',
                businessType: 'technology',
                country: 'US',
                profilePic: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSJ1cmwoI2dyYWRpZW50MCkiLz4KPHN0eWxlPgouY2xhc3MxIHsgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgc2Fucy1zZXJpZjsgZm9udC13ZWlnaHQ6IGJvbGQ7IGZvbnQtc2l6ZTogMzZweDsgZmlsbDogd2hpdGU7IH0KPC9zdHlsZT4KPGR0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgY2xhc3M9ImNsYXNzMSI+UDwvdGV4dD4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzY2N2VlYTtzdG9wLW9wYWNpdHk6MSIgLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNzY0YmEyO3N0b3Atb3BhY2l0eToxIiAvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPg==',
                status: 'Always Online',
                lastSeen: firebase.database.ServerValue.TIMESTAMP,
                customStatus: 'ðŸš€ Official Pulse Support - Here to help 24/7',
                statusMessage: 'Always Available',
                isPremium: true,
                isVerified: true,
                isOfficial: true,
                profileSetupComplete: true
            };

            const gursharnData = {
                name: 'Gursharn Arya',
                email: 'sgursharn076@gmail.com',
                accountType: 'business',
                businessType: 'technology',
                country: 'IN',
                profilePic: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSJ1cmwoI2dyYWRpZW50MCkiLz4KPHN0eWxlPgouY2xhc3MxIHsgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgc2Fucy1zZXJpZjsgZm9udC13ZWlnaHQ6IGJvbGQ7IGZvbnQtc2l6ZTogMjhweDsgZmlsbDogd2hpdGU7IH0KPC9zdHlsZT4KPHR0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgY2xhc3M9ImNsYXNzMSI+R0E8L3R0ZXh0Pgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDAiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgo8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIiAvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNGRkE1MDA7c3RvcC1vcGFjaXR5OjEiIC8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+',
                status: 'Online',
                lastSeen: firebase.database.ServerValue.TIMESTAMP,
                customStatus: 'ðŸ‘‘ Pulse Premium Creator & Developer',
                statusMessage: 'Building the future of communication',
                isPremium: true,
                isVerified: true,
                isFounder: true,
                profileSetupComplete: true
            };

            try {
                await database.ref('users/pulse-official').set(pulseData);
                await database.ref('users/gursharn-arya').set(gursharnData);
                
                // Send welcome message after delay
                setTimeout(() => {
                    sendPulseWelcomeMessage();
                }, 2000);
                
                // Setup daily messages
                setupDailyMessages();
            } catch (error) {
                console.error('Error setting up official accounts:', error);
            }
        }

        // Send Pulse Welcome Message
        async function sendPulseWelcomeMessage() {
            if (!currentUser) return;

            const chatId = generateChatId('pulse-official', currentUser.uid);
            const welcomeMessage = {
                sender: 'pulse-official',
                text: `ðŸŽ‰ Welcome to Pulse, ${currentUser.displayName || 'User'}! 

We're excited to have you join our community. Here's what you can do:

âœ¨ Send messages, voice notes, and media
ðŸ“– Share and view stories  
ðŸŽ­ React to messages with emojis
${currentUser.email === 'sgursharn076@gmail.com' ? 'ðŸ‘‘ Enjoy your Premium features!' : 'ðŸ’Ž Upgrade to Premium for exclusive features'}

Need help? Just ask! We're here 24/7. ðŸš€`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                type: 'text',
                seen: false
            };

            try {
                const messageRef = database.ref(`chats/${chatId}/messages`).push();
                await messageRef.set(welcomeMessage);
                
                // Update chat info
                await database.ref(`chats/${chatId}`).update({
                    participants: ['pulse-official', currentUser.uid],
                    lastMessage: welcomeMessage.text.substring(0, 50) + '...',
                    lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                    [`unreadCount_${currentUser.uid}`]: firebase.database.ServerValue.increment(1)
                });
            } catch (error) {
                console.error('Error sending welcome message:', error);
            }
        }

        // Setup Daily Messages
        function setupDailyMessages() {
            const messages = [
                'ðŸŒŸ Good morning! Start your day with Pulse - stay connected with friends and family!',
                'ðŸš€ New feature alert! You can now react to messages with emojis. Long press any message to try it!',
                'ðŸ’¡ Pro tip: Use voice messages for quick communication when typing is not convenient!',
                'ðŸŽ‰ Thank you for using Pulse! We\'re constantly working to improve your experience.',
                'ðŸ”’ Your privacy matters! All messages are end-to-end encrypted by default.',
                'âœ¨ Upgrade to Pulse Premium for exclusive features like message editing and deleted message recovery!',
                'ðŸ“± Did you know? You can view stories by tapping on user profile pictures!',
                'ðŸŒ Connect with people from around the world! Pulse supports users from every country.',
                'ðŸ’¬ Share your feedback! We love hearing from our users about new features and improvements.',
                'ðŸŽŠ Celebrate with Pulse! Use our reaction system to express yourself in chats.'
            ];
            
            // Send a random daily message every 24 hours
            setInterval(async () => {
                if (!currentUser) return;
                
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                const chatId = generateChatId('pulse-official', currentUser.uid);
                
                const dailyMessage = {
                    sender: 'pulse-official',
                    text: randomMessage,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'text',
                    seen: false
                };

                try {
                    const messageRef = database.ref(`chats/${chatId}/messages`).push();
                    await messageRef.set(dailyMessage);
                    
                    await database.ref(`chats/${chatId}`).update({
                        lastMessage: randomMessage.substring(0, 50) + '...',
                        lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                        [`unreadCount_${currentUser.uid}`]: firebase.database.ServerValue.increment(1)
                    });
                } catch (error) {
                    console.error('Error sending daily message:', error);
                }
            }, 24 * 60 * 60 * 1000); // 24 hours
        }

        // Generate Chat ID
        function generateChatId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        // Load Chats
        async function loadChats() {
            if (!currentUser) return;

            try {
                const snapshot = await database.ref('chats').once('value');
                const chats = snapshot.val() || {};
                
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';
                
                // Get user chats
                const userChats = Object.entries(chats).filter(([chatId, chatData]) => 
                    chatData.participants && chatData.participants.includes(currentUser.uid)
                );
                
                // Sort by last message time (handle undefined timestamps)
                userChats.sort(([,a], [,b]) => {
                    const timeA = a.lastMessageTime || a.createdAt || 0;
                    const timeB = b.lastMessageTime || b.createdAt || 0;
                    return timeB - timeA;
                });
                
                for (const [chatId, chatData] of userChats) {
                    const otherUserId = chatData.participants.find(id => id !== currentUser.uid);
                    
                    // Handle system users and regular users
                    let userData;
                    if (otherUserId === 'pulse-official') {
                        userData = {
                            name: 'Pulse Official',
                            email: 'official@pulse.com',
                            profilePic: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9InVybCgjZ3JhZGllbnQwKSIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMzZweCIgZm9udC13ZWlnaHQ9ImJvbGQiPjwvdGV4dD48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzY2N2VlYTtzdG9wLW9wYWNpdHk6MSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6Izc2NGJhMjtzdG9wLW9wYWNpdHk6MSIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjwvc3ZnPg==',
                            status: 'Always Online',
                            country: 'US',
                            isPremium: true,
                            isVerified: true,
                            isOfficial: true,
                            accountType: 'business'
                        };
                    } else if (otherUserId === 'gursharn-arya') {
                        userData = {
                            name: 'Gursharn Arya',
                            email: 'sgursharn076@gmail.com',
                            profilePic: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9InVybCgjZ3JhZGllbnQwKSIvPjx0ZXh0IHg9IjUwIiB5PSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMjhweCIgZm9udC13ZWlnaHQ9ImJvbGQiPkdBPC90ZXh0PjxkZWZzPjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZENzAwO3N0b3Atb3BhY2l0eToxIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkZBNTAwO3N0b3Atb3BhY2l0eToxIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PC9zdmc+',
                            status: 'Online',
                            country: 'IN',
                            isPremium: true,
                            isVerified: true,
                            isFounder: true,
                            accountType: 'business'
                        };
                    } else {
                        const userSnapshot = await database.ref('users/' + otherUserId).once('value');
                        userData = userSnapshot.val();
                    }
                    
                    if (userData) {
                        const chatElement = createChatElement(chatId, userData, chatData);
                        chatList.appendChild(chatElement);
                    }
                }
                
                // Setup realtime listener for chat updates
                database.ref('chats').off('child_changed'); // Remove previous listeners
                database.ref('chats').on('child_changed', (snapshot) => {
                    const chatId = snapshot.key;
                    const chatData = snapshot.val();
                    
                    // Check if this chat involves current user
                    if (chatData.participants && chatData.participants.includes(currentUser.uid)) {
                        loadChats(); // Reload chats to update the list
                    }
                });
                
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        function createChatElement(chatId, userData, chatData) {
            const chatElement = document.createElement('div');
            chatElement.className = 'chat-item';
            chatElement.onclick = () => openChat(chatId, userData);
            
            const unreadCount = chatData[`unreadCount_${currentUser.uid}`] || 0;
            const isOnline = userData.status === 'Online' || userData.status === 'Always Online';
            
            chatElement.innerHTML = `
                <div class="chat-avatar">
                    ${userData.profilePic ? 
                        `<img src="${userData.profilePic}" alt="${userData.name}">` : 
                        userData.name.charAt(0).toUpperCase()
                    }
                    ${userData.isPremium ? '<div class="premium-badge">âœ“</div>' : ''}
                    ${isOnline ? '<div class="online-indicator"></div>' : ''}
                </div>
                <div class="chat-info">
                    <div class="chat-name">
                        ${userData.name}
                        ${userData.isVerified ? '<div class="verified-badge">âœ“</div>' : ''}
                        ${userData.accountType === 'business' ? '<div class="business-badge">Business</div>' : ''}
                        <span class="country-flag">${getCountryFlag(userData.country)}</span>
                    </div>
                    <div class="chat-preview">${chatData.lastMessage || 'No messages yet'}</div>
                </div>
                <div class="chat-meta">
                    <div>${formatTime(chatData.lastMessageTime)}</div>
                    ${unreadCount > 0 ? `<div class="unread-count">${unreadCount}</div>` : ''}
                </div>
            `;
            
            return chatElement;
        }

        // Open Chat
        async function openChat(chatId, userData) {
            currentChat = chatId;
            
            // Update active chat item
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Show chat area
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('messageInputContainer').style.display = 'block';
            
            // Update chat header
            updateChatHeader(userData);
            
            // Load messages
            await loadMessages(chatId);
            
            // Mark messages as read
            await markMessagesAsRead(chatId);
        }

        function updateChatHeader(userData) {
            document.getElementById('currentChatName').innerHTML = `
                ${userData.name}
                ${userData.isVerified ? '<div class="verified-badge">âœ“</div>' : ''}
                ${userData.accountType === 'business' ? '<div class="business-badge">Business</div>' : ''}
            `;
            
            const avatarElement = document.getElementById('currentChatAvatar');
            if (userData.profilePic) {
                avatarElement.innerHTML = `<img src="${userData.profilePic}" alt="${userData.name}">`;
            } else {
                avatarElement.textContent = userData.name.charAt(0).toUpperCase();
            }
            
            const isOnline = userData.status === 'Online' || userData.status === 'Always Online';
            document.getElementById('currentChatStatus').innerHTML = `
                <span class="country-flag">${getCountryFlag(userData.country)}</span>
                ${isOnline ? 
                    '<span class="online-status"><span class="online-dot"></span>Online</span>' : 
                    `Last seen ${formatTime(userData.lastSeen)}`
                }
            `;
        }

        // Load Messages
        async function loadMessages(chatId) {
            try {
                const snapshot = await database.ref(`chats/${chatId}/messages`).orderByChild('timestamp').once('value');
                const messages = snapshot.val() || {};
                
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                Object.entries(messages).forEach(([messageId, message]) => {
                    const messageElement = createMessageElement(messageId, message);
                    messagesContainer.appendChild(messageElement);
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Setup realtime listener for new messages
                database.ref(`chats/${chatId}/messages`).off(); // Remove previous listeners
                database.ref(`chats/${chatId}/messages`).on('child_added', (snapshot) => {
                    const messageId = snapshot.key;
                    const message = snapshot.val();
                    
                    // Check if message already exists
                    if (!document.querySelector(`[data-message-id="${messageId}"]`)) {
                        const messageElement = createMessageElement(messageId, message);
                        messagesContainer.appendChild(messageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                });
                
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function createMessageElement(messageId, message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender === currentUser.uid ? 'sent' : 'received'}`;
            messageElement.setAttribute('data-message-id', messageId);
            
            let content = '';
            
            if (message.type === 'voice') {
                content = `
                    <div class="voice-message">
                        <button class="voice-play-btn" onclick="playVoiceMessage('${messageId}')"><i class="fas fa-play"></i></button>
                        <div class="voice-waveform"></div>
                        <div class="voice-duration">${message.duration || '0:30'}</div>
                    </div>
                `;
            } else if (message.type === 'image') {
                content = `<img src="${message.text}" style="max-width: 250px; border-radius: 12px;">`;
            } else {
                content = `<div class="message-content">${message.text}</div>`;
            }
            
            messageElement.innerHTML = `
                ${content}
                <div class="message-time">
                    ${formatTime(message.timestamp)}
                    ${message.sender === currentUser.uid ? 
                        `<span class="message-status ${message.seen ? 'status-read' : 'status-delivered'}">âœ“âœ“</span>` : 
                        ''
                    }
                </div>
                ${message.reactions && Object.keys(message.reactions).length > 0 ? 
                    `<div class="message-reactions">${Object.values(message.reactions).join('')}</div>` : 
                    ''
                }
            `;
            
            // Add long press for reactions
            let pressTimer;
            messageElement.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    showReactionPicker(messageElement, messageId);
                }, 500);
            });
            
            messageElement.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });
            
            messageElement.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
            });
            
            return messageElement;
        }

        // Send Message
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChat) return;
            
            const message = {
                sender: currentUser.uid,
                text: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                type: 'text',
                seen: false
            };
            
            try {
                // Add message to chat
                const messageRef = database.ref(`chats/${currentChat}/messages`).push();
                await messageRef.set(message);
                
                // Update chat info with proper timestamp
                const updateData = {
                    lastMessage: messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText,
                    lastMessageTime: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Increment unread count for other participants
                const chatSnapshot = await database.ref(`chats/${currentChat}`).once('value');
                const chatData = chatSnapshot.val();
                
                if (chatData && chatData.participants) {
                    chatData.participants.forEach(participantId => {
                        if (participantId !== currentUser.uid) {
                            updateData[`unreadCount_${participantId}`] = firebase.database.ServerValue.increment(1);
                        }
                    });
                }
                
                await database.ref(`chats/${currentChat}`).update(updateData);
                
                messageInput.value = '';
                
                // Auto-resize textarea
                messageInput.style.height = 'auto';
                
                // Update message status after delay (simulate delivery)
                setTimeout(async () => {
                    await messageRef.update({ seen: true });
                }, 1000);
                
                // Force refresh chat list to show updated last message
                setTimeout(() => {
                    loadChats();
                }, 500);
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        // Mark Messages as Read
        async function markMessagesAsRead(chatId) {
            try {
                await database.ref(`chats/${chatId}/unreadCount_${currentUser.uid}`).set(0);
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        // Reaction Functions
        function showReactionPicker(messageElement, messageId) {
            // Remove existing reaction pickers
            document.querySelectorAll('.reaction-picker').forEach(picker => picker.remove());
            
            const reactionPicker = document.createElement('div');
            reactionPicker.className = 'reaction-picker';
            reactionPicker.innerHTML = `
                <span class="reaction-emoji" onclick="addReaction('${messageId}', 'ðŸ˜‚')">ðŸ˜‚</span>
                <span class="reaction-emoji" onclick="addReaction('${messageId}', 'â¤ï¸')">â¤ï¸</span>
                <span class="reaction-emoji" onclick="addReaction('${messageId}', 'ðŸ˜¡')">ðŸ˜¡</span>
                <span class="reaction-emoji" onclick="addReaction('${messageId}', 'ðŸ¥º')">ðŸ¥º</span>
                <span class="reaction-emoji" onclick="addReaction('${messageId}', 'ðŸ˜­')">ðŸ˜­</span>
                <span class="reaction-emoji" onclick="addReaction('${messageId}', 'ðŸ˜Ž')">ðŸ˜Ž</span>
                <span class="reaction-emoji" onclick="addReaction('${messageId}', 'ðŸ”¥')">ðŸ”¥</span>
            `;
            
            messageElement.style.position = 'relative';
            messageElement.appendChild(reactionPicker);
            
            // Remove picker after 3 seconds
            setTimeout(() => {
                reactionPicker.remove();
            }, 3000);
        }

        async function addReaction(messageId, emoji) {
            try {
                await database.ref(`chats/${currentChat}/messages/${messageId}/reactions/${currentUser.uid}`).set(emoji);
                
                // Remove reaction picker
                document.querySelectorAll('.reaction-picker').forEach(picker => picker.remove());
            } catch (error) {
                console.error('Error adding reaction:', error);
            }
        }

        // Voice Message Functions
        function recordVoice() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        
                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            sendVoiceMessage(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };
                        
                        mediaRecorder.start();
                        
                        // Show recording UI
                        const recordBtn = event.target;
                        recordBtn.style.background = '#ff4757';
                        recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                        recordBtn.onclick = stopRecording;
                        
                        // Auto stop after 60 seconds
                        setTimeout(() => {
                            if (mediaRecorder && mediaRecorder.state === 'recording') {
                                stopRecording();
                            }
                        }, 60000);
                    })
                    .catch(err => {
                        alert('Microphone access denied. Please allow microphone access to record voice messages.');
                    });
            } else {
                alert('Voice recording not supported in this browser');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                
                // Reset record button
                const recordBtn = document.querySelector('[title="Voice Message"]');
                recordBtn.style.background = '';
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                recordBtn.onclick = recordVoice;
            }
        }

        async function sendVoiceMessage(audioBlob) {
            try {
                // Convert to base64 for storage
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Audio = e.target.result;
                    
                    const message = {
                        sender: currentUser.uid,
                        text: base64Audio,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: 'voice',
                        duration: '0:' + Math.floor(Math.random() * 60).toString().padStart(2, '0'),
                        seen: false
                    };
                    
                    const messageRef = database.ref(`chats/${currentChat}/messages`).push();
                    await messageRef.set(message);
                    
                    await database.ref(`chats/${currentChat}`).update({
                        lastMessage: 'ðŸŽ¤ Voice message',
                        lastMessageTime: firebase.database.ServerValue.TIMESTAMP
                    });
                };
                reader.readAsDataURL(audioBlob);
            } catch (error) {
                console.error('Error sending voice message:', error);
            }
        }

        function playVoiceMessage(messageId) {
            // Get message data and play audio
            database.ref(`chats/${currentChat}/messages/${messageId}`).once('value', (snapshot) => {
                const message = snapshot.val();
                if (message && message.type === 'voice') {
                    const audio = new Audio(message.text);
                    
                    // Update play button immediately
                    const playBtn = document.querySelector(`[onclick="playVoiceMessage('${messageId}')"]`);
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    playBtn.style.background = '#ff4757';
                    
                    // Play audio
                    audio.play().then(() => {
                        console.log('Voice message playing...');
                    }).catch(error => {
                        console.error('Error playing voice message:', error);
                        playBtn.textContent = 'â–¶ï¸';
                        playBtn.style.background = '';
                        alert('Error playing voice message');
                    });
                    
                    // Handle pause
                    playBtn.onclick = () => {
                        audio.pause();
                        playBtn.innerHTML = '<i class="fas fa-play"></i>';
                        playBtn.style.background = '';
                        playBtn.onclick = () => playVoiceMessage(messageId);
                    };
                    
                    // Handle audio end
                    audio.onended = () => {
                        playBtn.innerHTML = '<i class="fas fa-play"></i>';
                        playBtn.style.background = '';
                        playBtn.onclick = () => playVoiceMessage(messageId);
                    };
                    
                    // Handle audio error
                    audio.onerror = () => {
                        playBtn.innerHTML = '<i class="fas fa-play"></i>';
                        playBtn.style.background = '';
                        playBtn.onclick = () => playVoiceMessage(messageId);
                        console.error('Audio playback error');
                    };
                }
            });
        }

        // Media Functions
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,.pdf,.doc,.docx';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            };
            input.click();
        }

        function openCamera() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'camera';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            };
            input.click();
        }

        async function handleFileUpload(file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size too large. Please select a file under 5MB.');
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Data = e.target.result;
                    
                    const message = {
                        sender: currentUser.uid,
                        text: base64Data,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: file.type.startsWith('image/') ? 'image' : 'file',
                        fileName: file.name,
                        fileSize: file.size,
                        seen: false
                    };
                    
                    const messageRef = database.ref(`chats/${currentChat}/messages`).push();
                    await messageRef.set(message);
                    
                    const previewText = message.type === 'image' ? 'ðŸ“· Photo' : `ðŸ“Ž ${file.name}`;
                    await database.ref(`chats/${currentChat}`).update({
                        lastMessage: previewText,
                        lastMessageTime: firebase.database.ServerValue.TIMESTAMP
                    });
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('Error uploading file. Please try again.');
            }
        }

        // Navigation Functions
        function switchView(view) {
            currentView = view;
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            switch(view) {
                case 'home':
                    showHomeView();
                    break;
                case 'chats':
                    showChatsView();
                    break;
                case 'contacts':
                    showContactsView();
                    break;
                case 'stories':
                    showStoriesView();
                    break;
            }
        }

        function showContactsView() {
            document.getElementById('addContactModal').classList.remove('hidden');
        }

        function showHomeView() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('chatArea').classList.add('hidden');
            document.getElementById('messageInputContainer').style.display = 'none';
        }

        function showChatsView() {
            // Default chat view - already implemented
            loadChats();
        }

        function showStoriesView() {
            document.getElementById('welcomeScreen').innerHTML = `
                <div class="welcome-icon">ðŸ“–</div>
                <h2 class="welcome-title">Stories</h2>
                <p class="welcome-subtitle">View and manage your stories</p>
                <div style="margin-top: 30px;">
                    <button onclick="addStory()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 15px; cursor: pointer; font-weight: 600; margin: 10px;">
                        ðŸ“¸ Add Story
                    </button>
                    <button onclick="viewMyStory()" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 15px 30px; border-radius: 15px; cursor: pointer; font-weight: 600; margin: 10px;">
                        ðŸ‘ï¸ View My Story
                    </button>
                </div>
                <div id="storiesGrid" style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; max-width: 800px;">
                    <!-- Stories will be loaded here -->
                </div>
            `;
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('chatArea').classList.add('hidden');
            document.getElementById('messageInputContainer').style.display = 'none';
            
            loadAllStories();
        }

        async function loadAllStories() {
            try {
                const storiesSnapshot = await database.ref('stories').once('value');
                const stories = storiesSnapshot.val() || {};
                
                const storiesGrid = document.getElementById('storiesGrid');
                if (!storiesGrid) return;
                
                storiesGrid.innerHTML = '';
                
                for (const [userId, userStories] of Object.entries(stories)) {
                    const userSnapshot = await database.ref('users/' + userId).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userStories) {
                        const latestStory = Object.values(userStories)[Object.values(userStories).length - 1];
                        const storyElement = createStoryGridItem(userId, userData, latestStory);
                        storiesGrid.appendChild(storyElement);
                    }
                }
            } catch (error) {
                console.error('Error loading stories:', error);
            }
        }

        function createStoryGridItem(userId, userData, story) {
            const storyElement = document.createElement('div');
            storyElement.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: transform 0.3s ease;
                text-align: center;
            `;
            
            storyElement.onmouseover = () => storyElement.style.transform = 'translateY(-5px)';
            storyElement.onmouseout = () => storyElement.style.transform = 'translateY(0)';
            storyElement.onclick = () => viewStory(userId);
            
            storyElement.innerHTML = `
                <div style="width: 80px; height: 80px; border-radius: 20px; background: linear-gradient(135deg, #667eea, #764ba2); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px; position: relative; overflow: hidden;">
                    ${userData.profilePic ? 
                        `<img src="${userData.profilePic}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 18px;">` : 
                        userData.name.charAt(0).toUpperCase()
                    }
                    ${userData.isPremium ? '<div style="position: absolute; bottom: -3px; right: -3px; background: linear-gradient(45deg, #FFD700, #FFA500); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 2px solid white;">âœ“</div>' : ''}
                </div>
                <h4 style="margin-bottom: 8px; font-size: 16px; font-weight: 600;">${userData.name}</h4>
                <p style="font-size: 12px; opacity: 0.7; margin-bottom: 10px;">${formatTime(story.timestamp)}</p>
                <div style="background: rgba(102, 126, 234, 0.1); padding: 8px 12px; border-radius: 10px; font-size: 12px; color: #667eea;">
                    ${story.type === 'text' ? 'ðŸ“ Text Story' : story.type === 'image' ? 'ðŸ“· Photo Story' : 'ðŸŽ¥ Video Story'}
                </div>
            `;
            
            return storyElement;
        }

        function viewMyStory() {
            if (!currentUser) return;
            
            database.ref(`stories/${currentUser.uid}`).once('value', (snapshot) => {
                const myStories = snapshot.val();
                if (!myStories) {
                    alert('You haven\'t posted any stories yet. Tap "Add Story" to create your first story!');
                    return;
                }
                
                // Show story viewer with views and likes
                const storyKeys = Object.keys(myStories);
                const latestStoryKey = storyKeys[storyKeys.length - 1];
                const latestStory = myStories[latestStoryKey];
                
                const viewsCount = latestStory.views ? Object.keys(latestStory.views).length : 0;
                const likesCount = latestStory.likes ? Object.keys(latestStory.likes).length : 0;
                
                alert(`Your Latest Story:\n\nðŸ‘ï¸ Views: ${viewsCount}\nâ¤ï¸ Likes: ${likesCount}\n\nPosted: ${formatTime(latestStory.timestamp)}`);
            });
        }

        // Premium Functions
        function openPremiumModal() {
            document.getElementById('premiumModal').classList.remove('hidden');
            
            // Check if user is eligible
            if (currentUser && currentUser.email === 'sgursharn076@gmail.com') {
                document.getElementById('premiumBtn').textContent = 'Activate Premium';
            } else {
                document.getElementById('premiumBtn').textContent = 'Not Eligible';
                document.getElementById('premiumBtn').disabled = true;
                document.getElementById('premiumBtn').style.opacity = '0.5';
            }
        }

        async function purchasePremium() {
            if (currentUser && currentUser.email === 'sgursharn076@gmail.com') {
                try {
                    await database.ref(`users/${currentUser.uid}`).update({
                        isPremium: true,
                        isVerified: true,
                        premiumActivatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    alert('ðŸŽ‰ Premium activated successfully! Enjoy your exclusive features!');
                    closeModal('premiumModal');
                    loadUserProfile(); // Refresh UI
                } catch (error) {
                    console.error('Error activating premium:', error);
                    alert('Error activating premium. Please try again.');
                }
            } else {
                alert('Premium is only available for eligible accounts.');
            }
        }

        // Profile Functions
        function openProfile() {
            document.getElementById('profileModal').classList.remove('hidden');
            
            if (currentUser) {
                database.ref(`users/${currentUser.uid}`).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('profileName').value = userData.name || '';
                        document.getElementById('profileBio').value = userData.customStatus || '';
                        document.getElementById('profilePhone').value = userData.phone || '';
                        document.getElementById('profileEmail').value = userData.email || '';
                        document.getElementById('profileCountry').value = getCountryName(userData.country);
                        
                        const profilePic = document.getElementById('profilePicLarge');
                        if (userData.profilePic) {
                            profilePic.innerHTML = `<img src="${userData.profilePic}" alt="Profile">`;
                        } else {
                            profilePic.textContent = userData.name.charAt(0).toUpperCase();
                        }
                        
                        if (userData.isPremium) {
                            document.getElementById('profilePremiumBadge').classList.remove('hidden');
                        }
                    }
                });
            }
        }

        async function saveProfile() {
            if (!currentUser) return;
            
            try {
                const updates = {
                    name: document.getElementById('profileName').value,
                    customStatus: document.getElementById('profileBio').value,
                    phone: document.getElementById('profilePhone').value
                };
                
                await database.ref(`users/${currentUser.uid}`).update(updates);
                await currentUser.updateProfile({ displayName: updates.name });
                
                alert('Profile updated successfully!');
                closeModal('profileModal');
                loadUserProfile(); // Refresh UI
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile. Please try again.');
            }
        }

        function uploadProfilePic() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) { // 2MB limit for profile pics
                        alert('Image size too large. Please select an image under 2MB.');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        const base64Image = event.target.result;
                        
                        try {
                            await database.ref(`users/${currentUser.uid}/profilePic`).set(base64Image);
                            
                            // Update UI
                            const profilePic = document.getElementById('profilePicLarge');
                            profilePic.innerHTML = `<img src="${base64Image}" alt="Profile">`;
                            
                            const userAvatar = document.getElementById('userAvatar');
                            userAvatar.innerHTML = `<img src="${base64Image}" alt="Profile">`;
                            
                            alert('Profile picture updated successfully!');
                        } catch (error) {
                            console.error('Error uploading profile picture:', error);
                            alert('Error uploading profile picture. Please try again.');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Settings Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Utility Functions
        function getCountryFlag(countryCode) {
            const flags = {
                'IN': 'ðŸ‡®ðŸ‡³', 'US': 'ðŸ‡ºðŸ‡¸', 'GB': 'ðŸ‡¬ðŸ‡§', 'CA': 'ðŸ‡¨ðŸ‡¦',
                'AU': 'ðŸ‡¦ðŸ‡º', 'DE': 'ðŸ‡©ðŸ‡ª', 'FR': 'ðŸ‡«ðŸ‡·', 'JP': 'ðŸ‡¯ðŸ‡µ'
            };
            return flags[countryCode] || 'ðŸŒ';
        }

        function getCountryName(countryCode) {
            const names = {
                'IN': 'India', 'US': 'United States', 'GB': 'United Kingdom', 'CA': 'Canada',
                'AU': 'Australia', 'DE': 'Germany', 'FR': 'France', 'JP': 'Japan'
            };
            return names[countryCode] || 'Unknown';
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Typing Indicator
        function handleTyping() {
            if (!currentChat) return;
            
            // Clear previous timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Set typing status
            database.ref(`chats/${currentChat}/typing/${currentUser.uid}`).set(true);
            
            // Clear typing status after 3 seconds
            typingTimeout = setTimeout(() => {
                database.ref(`chats/${currentChat}/typing/${currentUser.uid}`).remove();
            }, 3000);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Notification Setup
        function setupNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Call Functions
        function startVoiceCall() {
            alert(`ðŸ“ž Starting voice call... (WebRTC integration would be implemented here)`);
        }

        function startVideoCall() {
            alert(`ðŸ“¹ Starting video call... (WebRTC integration would be implemented here)`);
        }

        function showChatInfo() {
            alert('Chat info modal would open here with user details, media, and settings.');
        }

        function viewProfile() {
            alert('User profile modal would open here with full profile details.');
        }

        function openStickerModal() {
            alert('Sticker and emoji picker would open here! ðŸ˜Š');
        }

        async function addStory() {
            if (!currentUser) return;
            
            const storyType = prompt('Choose story type:\n1. Text Story\n2. Photo Story\n\nEnter 1 or 2:');
            
            if (storyType === '1') {
                const storyText = prompt('Enter your text story:');
                if (storyText) {
                    await createTextStory(storyText);
                }
            } else if (storyType === '2') {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 3 * 1024 * 1024) {
                            alert('Image size too large. Please select an image under 3MB.');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = async function(event) {
                            const base64Image = event.target.result;
                            await createImageStory(base64Image);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            }
        }

        async function createTextStory(text) {
            try {
                const storyData = {
                    type: 'text',
                    content: text,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    views: {},
                    likes: {}
                };
                
                await database.ref(`stories/${currentUser.uid}`).push(storyData);
                alert('Text story posted successfully! ðŸ“');
                
                if (currentView === 'stories') {
                    loadAllStories();
                }
            } catch (error) {
                console.error('Error creating text story:', error);
                alert('Error posting story. Please try again.');
            }
        }

        async function createImageStory(imageBase64) {
            try {
                const storyData = {
                    type: 'image',
                    content: imageBase64,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    views: {},
                    likes: {}
                };
                
                await database.ref(`stories/${currentUser.uid}`).push(storyData);
                alert('Photo story posted successfully! ðŸ“·');
                
                if (currentView === 'stories') {
                    loadAllStories();
                }
            } catch (error) {
                console.error('Error creating image story:', error);
                alert('Error posting story. Please try again.');
            }
        }

        async function viewStory(userId) {
            try {
                const storiesSnapshot = await database.ref(`stories/${userId}`).once('value');
                const stories = storiesSnapshot.val();
                
                if (!stories) {
                    alert('No stories available for this user.');
                    return;
                }
                
                const userSnapshot = await database.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                // Get latest story
                const storyKeys = Object.keys(stories);
                const latestStoryKey = storyKeys[storyKeys.length - 1];
                const latestStory = stories[latestStoryKey];
                
                // Mark as viewed
                if (currentUser && userId !== currentUser.uid) {
                    await database.ref(`stories/${userId}/${latestStoryKey}/views/${currentUser.uid}`).set(true);
                }
                
                // Show story viewer
                showStoryViewer(userData, latestStory, userId, latestStoryKey);
                
            } catch (error) {
                console.error('Error viewing story:', error);
                alert('Error loading story. Please try again.');
            }
        }

        function showStoryViewer(userData, story, userId, storyKey) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.background = 'rgba(0, 0, 0, 0.9)';
            
            let storyContent = '';
            if (story.type === 'text') {
                storyContent = `
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 60px 40px; border-radius: 20px; text-align: center; font-size: 24px; font-weight: 600; line-height: 1.4; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                        ${story.content}
                    </div>
                `;
            } else if (story.type === 'image') {
                storyContent = `
                    <img src="${story.content}" style="max-width: 100%; max-height: 70vh; border-radius: 20px; object-fit: contain;">
                `;
            }
            
            modal.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; position: relative;">
                    <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); padding: 20px; border-radius: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                        <div style="width: 50px; height: 50px; border-radius: 15px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden;">
                            ${userData.profilePic ? 
                                `<img src="${userData.profilePic}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 13px;">` : 
                                userData.name.charAt(0).toUpperCase()
                            }
                        </div>
                        <div>
                            <div style="color: white; font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                ${userData.name}
                                ${userData.isVerified ? '<div style="background: #4CAF50; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px;">âœ“</div>' : ''}
                                ${userData.isPremium ? '<div style="background: linear-gradient(45deg, #FFD700, #FFA500); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px;">âœ“</div>' : ''}
                            </div>
                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 12px;">${formatTime(story.timestamp)}</div>
                        </div>
                    </div>
                    
                    ${storyContent}
                    
                    <div style="margin-top: 20px; display: flex; gap: 15px;">
                        <button onclick="likeStory('${userId}', '${storyKey}')" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 12px 20px; border-radius: 15px; cursor: pointer; font-size: 16px; backdrop-filter: blur(10px);">
                            â¤ï¸ Like
                        </button>
                        <button onclick="closeStoryViewer()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 12px 20px; border-radius: 15px; cursor: pointer; font-size: 16px; backdrop-filter: blur(10px);">
                            âœ• Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto close after 10 seconds
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    modal.remove();
                }
            }, 10000);
        }

        async function likeStory(userId, storyKey) {
            if (!currentUser) return;
            
            try {
                await database.ref(`stories/${userId}/${storyKey}/likes/${currentUser.uid}`).set(true);
                alert('Story liked! â¤ï¸');
            } catch (error) {
                console.error('Error liking story:', error);
            }
        }

        function closeStoryViewer() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.style.background === 'rgba(0, 0, 0, 0.9)') {
                    modal.remove();
                }
            });
        }

        // Contact Functions
        function switchContactMethod(method) {
            const emailBtn = document.getElementById('emailMethodBtn');
            const qrBtn = document.getElementById('qrMethodBtn');
            const emailSection = document.getElementById('emailSearchSection');
            const qrSection = document.getElementById('qrCodeSection');
            
            if (method === 'email') {
                emailBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                emailBtn.style.color = 'white';
                qrBtn.style.background = 'white';
                qrBtn.style.color = '#333';
                emailSection.classList.remove('hidden');
                qrSection.classList.add('hidden');
            } else {
                qrBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                qrBtn.style.color = 'white';
                emailBtn.style.background = 'white';
                emailBtn.style.color = '#333';
                qrSection.classList.remove('hidden');
                emailSection.classList.add('hidden');
                generateMyQRCode();
            }
        }

        async function searchByEmail() {
            const email = document.getElementById('contactEmail').value.trim();
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            try {
                // Search for user by email
                const usersSnapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
                const users = usersSnapshot.val();
                
                const searchResults = document.getElementById('searchResults');
                const searchResultsList = document.getElementById('searchResultsList');
                
                if (!users) {
                    searchResultsList.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>No user found with email: ${email}</p>
                            <p style="font-size: 12px; margin-top: 10px;">Make sure the email is correct and the user has a Pulse account.</p>
                        </div>
                    `;
                } else {
                    const userId = Object.keys(users)[0];
                    const userData = users[userId];
                    
                    if (userId === currentUser.uid) {
                        searchResultsList.innerHTML = `
                            <div style="text-align: center; padding: 30px; color: #667eea;">
                                <i class="fas fa-user-check" style="font-size: 48px; margin-bottom: 15px;"></i>
                                <p>This is your own account!</p>
                            </div>
                        `;
                    } else {
                        searchResultsList.innerHTML = createContactSearchResult(userId, userData);
                    }
                }
                
                searchResults.classList.remove('hidden');
            } catch (error) {
                console.error('Error searching for contact:', error);
                alert('Error searching for contact. Please try again.');
            }
        }

        function createContactSearchResult(userId, userData) {
            return `
                <div style="background: white; border: 1px solid #ddd; border-radius: 15px; padding: 20px; display: flex; align-items: center; gap: 15px;">
                    <div style="width: 60px; height: 60px; border-radius: 18px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; position: relative; overflow: hidden;">
                        ${userData.profilePic ? 
                            `<img src="${userData.profilePic}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">` : 
                            userData.name.charAt(0).toUpperCase()
                        }
                        ${userData.isPremium ? '<div style="position: absolute; bottom: -3px; right: -3px; background: linear-gradient(45deg, #FFD700, #FFA500); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 2px solid white;">âœ“</div>' : ''}
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                            ${userData.name}
                            ${userData.isVerified ? '<i class="fas fa-check-circle" style="color: #4CAF50; font-size: 14px;"></i>' : ''}
                            ${userData.accountType === 'business' ? '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: bold;">BUSINESS</span>' : ''}
                        </h4>
                        <p style="font-size: 14px; color: #666; margin-bottom: 5px;">${userData.email}</p>
                        <p style="font-size: 12px; color: #999;">${userData.customStatus || 'Available on Pulse'}</p>
                    </div>
                    <button onclick="addContact('${userId}')" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-user-plus"></i> Add
                    </button>
                </div>
            `;
        }

        async function addContact(userId) {
            try {
                // Create a new chat between current user and the contact
                const chatId = generateChatId(currentUser.uid, userId);
                
                // Check if chat already exists
                const chatSnapshot = await database.ref(`chats/${chatId}`).once('value');
                
                if (chatSnapshot.exists()) {
                    alert('You are already connected with this user!');
                    closeModal('addContactModal');
                    // Open existing chat
                    const userData = await database.ref(`users/${userId}`).once('value');
                    openChat(chatId, userData.val());
                    return;
                }
                
                // Get user data first
                const userSnapshot = await database.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    alert('User not found. Please try again.');
                    return;
                }
                
                // Create new chat with proper structure
                const chatData = {
                    participants: [currentUser.uid, userId],
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastMessage: 'ðŸŽ‰ You are now connected! Start chatting.',
                    lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                    [`unreadCount_${currentUser.uid}`]: 0,
                    [`unreadCount_${userId}`]: 1
                };
                
                await database.ref(`chats/${chatId}`).set(chatData);
                
                // Send connection message
                const connectionMessage = {
                    sender: 'system',
                    text: `ðŸŽ‰ You are now connected with ${userData.name}! Start chatting with each other.`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system',
                    seen: false
                };
                
                await database.ref(`chats/${chatId}/messages`).push(connectionMessage);
                
                alert(`Contact added successfully! You can now chat with ${userData.name}.`);
                closeModal('addContactModal');
                
                // Force immediate refresh of chat list
                await loadChats();
                
                // Open the new chat after a short delay
                setTimeout(() => {
                    openChat(chatId, userData);
                }, 800);
                
            } catch (error) {
                console.error('Error adding contact:', error);
                alert('Error adding contact. Please try again.');
            }
        }

        function generateMyQRCode() {
            if (!currentUser) return;
            
            // Generate QR code data (in real app, this would be actual QR generation)
            const qrData = {
                userId: currentUser.uid,
                email: currentUser.email,
                name: currentUser.displayName || 'Pulse User',
                type: 'pulse_contact'
            };
            
            // Update QR display with user info
            const qrCodeDiv = document.getElementById('myQRCode');
            qrCodeDiv.innerHTML = `
                <div style="width: 200px; height: 200px; background: white; border: 2px solid #667eea; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
                    <i class="fas fa-qrcode" style="font-size: 60px; color: #667eea; margin-bottom: 10px;"></i>
                    <div style="font-size: 12px; color: #333; font-weight: bold;">${currentUser.displayName || 'User'}</div>
                    <div style="font-size: 10px; color: #666; margin-top: 5px;">${currentUser.email}</div>
                    <div style="font-size: 8px; color: #999; margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px;">Pulse QR Code</div>
                </div>
            `;
        }

        function downloadQR() {
            // In a real app, this would generate and download actual QR code
            alert('QR Code download feature would be implemented here. The QR would contain your contact information for easy sharing.');
        }

        function scanQRCode() {
            // In a real app, this would open camera for QR scanning
            alert('Camera QR scanner would open here. For now, you can upload a QR image using the upload button below.');
        }

        function processQRImage(event) {
            const file = event.target.files[0];
            if (file) {
                // In a real app, this would process the QR code from image
                alert('QR code processing would happen here. The app would extract contact information and add the user automatically.');
            }
        }

        // Initialize app when page loads
        window.addEventListener('load', () => {
            initializeApp();
            
            // Load dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            if (currentUser) {
                database.ref(`users/${currentUser.uid}/status`).set('Online');
            }
        });

        window.addEventListener('offline', () => {
            if (currentUser) {
                database.ref(`users/${currentUser.uid}/status`).set('Offline');
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                database.ref(`users/${currentUser.uid}`).update({
                    status: 'Offline',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97115cacb6ab85f7',t:'MTc1NTUxOTU5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
