<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - Advanced Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .ios-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .instagram-gradient {
            background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
        }
        
        .chat-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        .status-ring {
            background: conic-gradient(from 0deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888, #f09433);
            padding: 2px;
            border-radius: 50%;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
        }
        
        .online-dot {
            width: 12px;
            height: 12px;
            background: #00d4aa;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            right: 0;
        }
        
        .verified-tick {
            background: #1DA1F2;
            border-radius: 50%;
            padding: 2px;
        }
        
        .business-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .premium-badge {
            background: linear-gradient(45deg, #FFD700, #FF6B35, #F7931E);
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(255,215,0,0.3);
            animation: premiumGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes premiumGlow {
            0% { box-shadow: 0 2px 4px rgba(255,215,0,0.3); }
            100% { box-shadow: 0 4px 8px rgba(255,215,0,0.5), 0 0 12px rgba(255,215,0,0.3); }
        }
        
        .premium-crown {
            color: #FFD700;
            filter: drop-shadow(0 2px 4px rgba(255,215,0,0.3));
        }
        
        .country-flag {
            width: 20px;
            height: 15px;
            border-radius: 2px;
        }
        
        .dark-theme {
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .dark-theme .bg-white {
            background: #2d2d2d !important;
        }
        
        .dark-theme .text-gray-900 {
            color: #ffffff !important;
        }
        
        .dark-theme .border-gray-200 {
            border-color: #404040 !important;
        }
        
        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid #e5e7eb;
            z-index: 50;
        }
        
        .nav-item {
            transition: all 0.3s ease;
        }
        
        .nav-item.active {
            color: #3b82f6;
            transform: scale(1.1);
        }
        
        .mobile-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        @media (max-width: 768px) {
            .desktop-sidebar {
                display: none;
            }
            
            .mobile-chat-header {
                display: flex;
            }
            
            .desktop-chat-header {
                display: none;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-sidebar {
                transform: translateX(0) !important;
            }
            
            .mobile-chat-header {
                display: none;
            }
            
            .desktop-chat-header {
                display: flex;
            }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 w-96 max-w-90vw shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 gradient-bg rounded-full flex items-center justify-center">
                    <span class="text-3xl font-bold text-white">P</span>
                </div>
                <h1 class="text-3xl font-bold gradient-bg bg-clip-text text-transparent mb-2">Welcome to Pulse</h1>
                <p class="text-gray-600">Connect with friends and family instantly</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="loginWithGoogle()" class="w-full bg-white border-2 border-gray-200 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center space-x-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Continue with Google</span>
                </button>
                
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">or</span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <input type="email" id="loginEmail" placeholder="Email address" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button onclick="loginWithEmail()" class="w-full gradient-bg text-white py-3 rounded-xl hover:opacity-90 transition-opacity">
                    Sign In
                </button>
                
                <div class="text-center">
                    <button onclick="showRegister()" class="text-blue-500 hover:underline">Don't have an account? Sign up</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Register Screen -->
    <div id="registerScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 w-96 max-w-90vw shadow-2xl max-h-90vh overflow-y-auto">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold gradient-bg bg-clip-text text-transparent mb-2">Create Account</h1>
                <p class="text-gray-600">Join Pulse today</p>
            </div>
            
            <div class="space-y-4">
                <div class="text-center mb-4">
                    <div class="w-20 h-20 mx-auto mb-3 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer" onclick="uploadProfilePicture()">
                        <span class="text-2xl">📷</span>
                    </div>
                    <p class="text-sm text-gray-500">Add profile picture</p>
                </div>
                
                <input type="text" id="registerName" placeholder="Full Name" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="email" id="registerEmail" placeholder="Email address" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="tel" id="registerPhone" placeholder="Phone Number" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="registerPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="registerBio" placeholder="Bio (optional)" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Account Type</label>
                    <select id="registerAccountType" onchange="toggleRegisterBusinessFields()" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="personal">Personal</option>
                        <option value="business">Business</option>
                    </select>
                </div>
                
                <!-- Business Fields -->
                <div id="registerBusinessFields" class="hidden space-y-3">
                    <input type="text" id="registerBusinessName" placeholder="Business Name" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="registerLegalName" placeholder="Legal Name" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <textarea id="registerHeadquarters" placeholder="Headquarters Address" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                    <input type="text" id="registerGST" placeholder="GST Number" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button onclick="registerUser()" class="w-full gradient-bg text-white py-3 rounded-xl hover:opacity-90 transition-opacity">
                    Create Account
                </button>
                
                <div class="text-center">
                    <button onclick="showLogin()" class="text-blue-500 hover:underline">Already have an account? Sign in</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 sidebar-overlay z-40 hidden md:hidden" onclick="closeMobileSidebar()"></div>
    
    <!-- Main App Container -->
    <div id="mainApp" class="flex h-full hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-80 bg-white border-r border-gray-200 flex flex-col desktop-sidebar md:relative fixed inset-y-0 left-0 z-50 mobile-sidebar">
            <!-- Header -->
            <div class="p-4 border-b border-gray-100 ios-blur bg-white/80">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl font-bold gradient-bg bg-clip-text text-transparent">Pulse</h1>
                    <div class="flex space-x-2">
                        <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                        <button onclick="showStatusModal()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                        <button onclick="showSettingsModal()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="relative">
                    <input type="text" placeholder="Search chats..." class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
            
            <!-- Status Stories -->
            <div class="p-4 border-b border-gray-100">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Status</h3>
                <div class="flex space-x-3 overflow-x-auto">
                    <div class="flex-shrink-0 text-center">
                        <div class="status-ring rounded-full">
                            <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-lg">📷</span>
                            </div>
                        </div>
                        <p class="text-xs mt-1">My Status</p>
                    </div>
                    <div class="flex-shrink-0 text-center">
                        <div class="status-ring rounded-full">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='24' fill='%23FF6B6B'/%3E%3Ctext x='24' y='30' text-anchor='middle' fill='white' font-size='20'%3EA%3C/text%3E%3C/svg%3E" class="w-12 h-12 rounded-full">
                        </div>
                        <p class="text-xs mt-1">Arya</p>
                    </div>
                    <div class="flex-shrink-0 text-center">
                        <div class="status-ring rounded-full">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='24' fill='%234ECDC4'/%3E%3Ctext x='24' y='30' text-anchor='middle' fill='white' font-size='20'%3ES%3C/text%3E%3C/svg%3E" class="w-12 h-12 rounded-full">
                        </div>
                        <p class="text-xs mt-1">Sarah</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat List -->
            <div class="flex-1 overflow-y-auto">
                <div id="chatList" class="divide-y divide-gray-100">
                    <!-- Chat items will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="flex-1 flex flex-col md:ml-0 ml-0">
            <!-- Mobile Chat Header -->
            <div id="mobileChatHeader" class="mobile-chat-header p-4 bg-white border-b border-gray-200 ios-blur bg-white/80 hidden items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="openMobileSidebar()" class="p-2 rounded-full hover:bg-gray-100 transition-colors md:hidden">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <button onclick="goBackToChats()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img id="mobileChatAvatar" class="w-8 h-8 rounded-full" src="">
                            <div id="mobileOnlineIndicator" class="online-dot hidden"></div>
                        </div>
                        <div>
                            <h3 id="mobileChatName" class="font-semibold text-gray-900 text-sm"></h3>
                            <p id="mobileChatStatus" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-1">
                    <button onclick="startVideoCall()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                    <button onclick="startVoiceCall()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Desktop Chat Header -->
            <div id="chatHeader" class="desktop-chat-header p-4 bg-white border-b border-gray-200 ios-blur bg-white/80 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img id="chatAvatar" class="w-10 h-10 rounded-full" src="">
                            <div id="onlineIndicator" class="online-dot hidden"></div>
                        </div>
                        <div>
                            <h3 id="chatName" class="font-semibold text-gray-900"></h3>
                            <p id="chatStatus" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="startVideoCall()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                        <button onclick="startVoiceCall()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                        </button>
                        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex-1 flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50">
                <div class="text-center">
                    <div class="w-32 h-32 mx-auto mb-6 gradient-bg rounded-full flex items-center justify-center">
                        <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome to Pulse</h2>
                    <p class="text-gray-600">Select a chat to start messaging</p>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div id="messagesArea" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
                <!-- Messages will be populated here -->
            </div>
            
            <!-- Message Reactions Popup -->
            <div id="reactionsPopup" class="fixed bg-white rounded-full shadow-lg border p-2 hidden z-50">
                <div class="flex space-x-2">
                    <button onclick="addReaction('😂')" class="text-2xl hover:scale-125 transition-transform">😂</button>
                    <button onclick="addReaction('❤️')" class="text-2xl hover:scale-125 transition-transform">❤️</button>
                    <button onclick="addReaction('😡')" class="text-2xl hover:scale-125 transition-transform">😡</button>
                    <button onclick="addReaction('🥺')" class="text-2xl hover:scale-125 transition-transform">🥺</button>
                    <button onclick="addReaction('😭')" class="text-2xl hover:scale-125 transition-transform">😭</button>
                    <button onclick="addReaction('😎')" class="text-2xl hover:scale-125 transition-transform">😎</button>
                    <button onclick="addReaction('🔥')" class="text-2xl hover:scale-125 transition-transform">🔥</button>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="px-4 py-2 hidden">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                        <div class="flex space-x-1">
                            <div class="w-1 h-1 bg-gray-500 rounded-full typing-indicator"></div>
                            <div class="w-1 h-1 bg-gray-500 rounded-full typing-indicator" style="animation-delay: 0.2s"></div>
                            <div class="w-1 h-1 bg-gray-500 rounded-full typing-indicator" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    <span class="text-sm text-gray-500">typing...</span>
                </div>
            </div>
            
            <!-- Message Input -->
            <div id="messageInput" class="p-4 bg-white border-t border-gray-200 hidden">
                <div class="flex items-center space-x-3">
                    <button onclick="toggleEmojiPicker()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <span class="text-xl">😊</span>
                    </button>
                    <button onclick="attachFile()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                        </svg>
                    </button>
                    <div class="flex-1 relative">
                        <input type="text" id="messageText" placeholder="Type a message..." class="w-full px-4 py-2 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" onkeypress="handleMessageKeyPress(event)">
                    </div>
                    <button onclick="sendMessage()" class="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div id="bottomNavigation" class="nav-bottom hidden">
        <div class="flex justify-around items-center py-3">
            <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center space-y-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs">Home</span>
            </button>
            <button onclick="switchTab('status')" class="nav-item flex flex-col items-center space-y-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                <span class="text-xs">Status</span>
            </button>
            <button onclick="switchTab('calls')" class="nav-item flex flex-col items-center space-y-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                <span class="text-xs">Calls</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-item flex flex-col items-center space-y-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-xs">Settings</span>
            </button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-96 max-w-90vw max-h-90vh overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="closeSettingsModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Profile Section -->
                <div class="border-b pb-4">
                    <h3 class="font-semibold mb-3">Profile Settings</h3>
                    <div class="space-y-2">
                        <button onclick="showProfileModal()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg flex items-center justify-between">
                            <span>Edit Profile</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg flex items-center justify-between">
                            <span>Privacy Settings</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Chat Settings -->
                <div class="border-b pb-4">
                    <h3 class="font-semibold mb-3">Chat Settings</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between p-3">
                            <span>Dark Mode</span>
                            <button onclick="toggleTheme()" class="w-12 h-6 bg-gray-300 rounded-full relative transition-colors" id="themeToggle">
                                <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3">
                            <span>Read Receipts</span>
                            <button class="w-12 h-6 bg-blue-500 rounded-full relative">
                                <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5"></div>
                            </button>
                        </div>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg">Chat Wallpaper</button>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg">Font Size</button>
                    </div>
                </div>
                
                <!-- Notifications -->
                <div class="border-b pb-4">
                    <h3 class="font-semibold mb-3">Notifications</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between p-3">
                            <span>Message Notifications</span>
                            <button class="w-12 h-6 bg-blue-500 rounded-full relative">
                                <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5"></div>
                            </button>
                        </div>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg">Notification Tone</button>
                    </div>
                </div>
                
                <!-- Storage -->
                <div class="border-b pb-4">
                    <h3 class="font-semibold mb-3">Storage & Data</h3>
                    <div class="space-y-2">
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg">Network Usage</button>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg">Storage Usage</button>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-red-600">Clear Chat History</button>
                    </div>
                </div>
                
                <!-- Premium Section -->
                <div class="border-b pb-4" id="premiumSection">
                    <h3 class="font-semibold mb-3 flex items-center">
                        <span class="premium-crown mr-2">👑</span>
                        Pulse Premium
                    </h3>
                    <div class="space-y-2" id="premiumContent">
                        <!-- Premium content will be populated based on user -->
                    </div>
                </div>
                
                <!-- Help -->
                <div>
                    <h3 class="font-semibold mb-3">Help & Support</h3>
                    <div class="space-y-2">
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg">Help Center</button>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg">Contact Support</button>
                        <button onclick="logout()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg text-red-600">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-96 max-w-90vw">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Profile Settings</h2>
                <button onclick="closeProfileModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="text-center mb-6">
                <div class="w-24 h-24 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center">
                    <span class="text-2xl">👤</span>
                </div>
                <button class="text-blue-500 text-sm">Change Photo</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Account Type</label>
                    <select id="accountType" onchange="toggleBusinessFields()" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="personal">Personal</option>
                        <option value="business">Business</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="userName" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Your name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <input type="text" id="userStatus" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Hey there! I'm using Pulse">
                </div>
                
                <!-- Business Fields -->
                <div id="businessFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
                        <input type="text" id="businessName" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Business name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Legal Name</label>
                        <input type="text" id="legalName" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Legal business name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Headquarters Address</label>
                        <textarea id="headquarters" class="w-full p-2 border border-gray-300 rounded-lg" rows="2" placeholder="Business address"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GST Number</label>
                        <input type="text" id="gstNumber" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="GST number">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                        <select id="country" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="IN">India</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="saveProfile()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Status Modal -->
    <div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-96 max-w-90vw">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Add Status</h2>
                <button onclick="closeStatusModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Type</label>
                    <select id="statusType" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="text">Text</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                    <textarea id="statusContent" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" placeholder="What's on your mind?"></textarea>
                </div>
                
                <button onclick="postStatus()" class="w-full instagram-gradient text-white py-2 rounded-lg hover:opacity-90 transition-opacity">
                    Post Status
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB2XeuTfHZ7FYKLoYb4epKp3upmVqG0fzE",
            authDomain: "pulse-17f40.firebaseapp.com",
            databaseURL: "https://pulse-17f40-default-rtdb.firebaseio.com",
            projectId: "pulse-17f40",
            storageBucket: "pulse-17f40.firebasestorage.app",
            messagingSenderId: "259780854138",
            appId: "1:259780854138:web:89c265fd22a34a7f1fd6c3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let currentChat = null;
        let typingTimeout = null;

        // Real user accounts data
        const realAccounts = [
            {
                id: 'pulse_official',
                name: 'Pulse',
                avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Cdefs%3E%3ClinearGradient id='pulseGrad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='50%25' style='stop-color:%23764ba2'/%3E%3Cstop offset='100%25' style='stop-color:%23f093fb'/%3E%3C/linearGradient%3E%3ClinearGradient id='innerGlow' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffffff' stop-opacity='0.3'/%3E%3Cstop offset='100%25' style='stop-color:%23ffffff' stop-opacity='0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='24' cy='24' r='24' fill='url(%23pulseGrad)'/%3E%3Ccircle cx='24' cy='24' r='22' fill='url(%23innerGlow)'/%3E%3Ctext x='24' y='30' text-anchor='middle' fill='white' font-size='18' font-weight='bold' font-family='Inter'%3EP%3C/text%3E%3Ccircle cx='24' cy='24' r='23' fill='none' stroke='%23ffffff' stroke-width='1' opacity='0.5'/%3E%3C/svg%3E",
                lastMessage: '🎉 Welcome to Pulse! Discover new features and updates.',
                time: 'now',
                unread: 1,
                online: true,
                status: 'Official Pulse Account • Advanced AI Assistant',
                verified: true,
                business: true,
                country: 'US',
                accountType: 'business',
                canMessage: false,
                bio: '🚀 Official Pulse Account\n💫 Next-generation messaging platform\n🔒 End-to-end encrypted\n🌍 Connecting the world securely\n\n📧 Contact: support@pulse.com\n🌐 Website: pulse.com',
                businessName: 'Pulse Technologies Inc.',
                legalName: 'Pulse Technologies Incorporated',
                headquarters: '1 Hacker Way, Menlo Park, CA 94301, United States',
                gstNumber: 'US-TECH-2024-001',
                companyType: 'Technology Platform',
                employees: '10,000+',
                founded: '2024'
            },
            {
                id: 'gursharn_arya',
                name: 'Gursharn Arya',
                email: 'sgursharn076@gmail.com',
                avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Cdefs%3E%3ClinearGradient id='gursharGrad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23FF6B6B'/%3E%3Cstop offset='50%25' style='stop-color:%23FF8E53'/%3E%3Cstop offset='100%25' style='stop-color:%23FF3D71'/%3E%3C/linearGradient%3E%3ClinearGradient id='premiumGlow' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23FFD700'/%3E%3Cstop offset='100%25' style='stop-color:%23FFA500'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='24' cy='24' r='24' fill='url(%23gursharGrad)'/%3E%3Ccircle cx='24' cy='24' r='22' fill='none' stroke='url(%23premiumGlow)' stroke-width='2'/%3E%3Ctext x='24' y='30' text-anchor='middle' fill='white' font-size='16' font-weight='bold' font-family='Inter'%3EGA%3C/text%3E%3Cpath d='M35 15 L40 20 L35 25' fill='none' stroke='%23FFD700' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E",
                lastMessage: 'Hey! Check out the new Pulse Premium features 🚀✨',
                time: '3:45 PM',
                unread: 0,
                online: true,
                status: 'Pulse Premium • Founder & CEO',
                verified: true,
                premium: true,
                business: false,
                country: 'IN',
                accountType: 'personal',
                canMessage: true,
                bio: '👑 Pulse Premium Member\n🚀 Founder & CEO at Pulse Technologies\n💻 Full Stack Developer & Tech Innovator\n🌟 Building the future of communication\n\n🏢 Affiliated Company: Pulse Technologies Inc.\n📍 New Delhi, India\n🎓 Computer Science Engineer\n💡 "Innovation distinguishes between a leader and a follower"',
                affiliatedCompany: 'Pulse Technologies Inc.',
                position: 'Founder & CEO',
                premiumSince: '2024',
                premiumFeatures: ['Edit Messages', 'See Deleted Messages', 'Advanced Analytics', 'Priority Support', 'Custom Themes', 'Unlimited Storage']
            }
        ];

        // Get user's country from IP (simulated)
        function getUserCountry() {
            // In real app, use IP geolocation API
            return 'IN'; // Default to India for demo
        }

        // Current active tab
        let activeTab = 'chats';
        let isDarkMode = false;

        const sampleMessages = {
            'chat1': [
                {
                    id: 'msg1',
                    sender: 'other',
                    text: 'Hey! How are you doing?',
                    timestamp: Date.now() - 300000,
                    seen: true,
                    type: 'text'
                },
                {
                    id: 'msg2',
                    sender: 'me',
                    text: 'I\'m doing great! Just working on some new projects. How about you?',
                    timestamp: Date.now() - 240000,
                    seen: true,
                    type: 'text'
                },
                {
                    id: 'msg3',
                    sender: 'other',
                    text: 'That sounds awesome! I\'d love to hear more about it.',
                    timestamp: Date.now() - 180000,
                    seen: false,
                    type: 'text'
                }
            ]
        };

        // Initialize app
        function initializeApp() {
            // Hide bottom navigation initially
            document.getElementById('bottomNavigation').classList.add('hidden');
            
            // Listen for authentication state changes
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    database.ref('users/' + user.uid).once('value')
                        .then((snapshot) => {
                            if (snapshot.exists()) {
                                currentUser = snapshot.val();
                                localStorage.setItem('pulseUser', JSON.stringify(currentUser));
                                showMainApp();
                                setupUserPresence();
                            } else {
                                // User exists in auth but not in database, create profile
                                currentUser = {
                                    uid: user.uid,
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    country: getUserCountry(),
                                    accountType: 'personal',
                                    profilePic: user.photoURL,
                                    bio: 'Hey there! I\'m using Pulse',
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                                };
                                
                                database.ref('users/' + user.uid).set(currentUser)
                                    .then(() => {
                                        localStorage.setItem('pulseUser', JSON.stringify(currentUser));
                                        showMainApp();
                                        setupUserPresence();
                                    });
                            }
                        });
                } else {
                    // User is signed out
                    currentUser = null;
                    localStorage.removeItem('pulseUser');
                    showLoginScreen();
                }
            });
        }
        
        // Setup user presence (online/offline status)
        function setupUserPresence() {
            if (!currentUser) return;
            
            const userStatusRef = database.ref('users/' + currentUser.uid + '/status');
            const isOfflineForDatabase = {
                state: 'offline',
                lastSeen: firebase.database.ServerValue.TIMESTAMP,
            };
            
            const isOnlineForDatabase = {
                state: 'online',
                lastSeen: firebase.database.ServerValue.TIMESTAMP,
            };
            
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    return;
                }
                
                userStatusRef.onDisconnect().set(isOfflineForDatabase).then(() => {
                    userStatusRef.set(isOnlineForDatabase);
                });
            });
        }

        // Authentication functions
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('bottomNavigation').classList.remove('hidden');
            renderChatList();
            sendWelcomeMessage();
            setupPremiumContent();
        }

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    currentUser = {
                        uid: user.uid,
                        name: user.displayName,
                        email: user.email,
                        profilePic: user.photoURL,
                        country: getUserCountry(),
                        accountType: 'personal',
                        bio: 'Hey there! I\'m using Pulse'
                    };
                    
                    // Save user data to Firebase Database
                    database.ref('users/' + user.uid).set(currentUser);
                    localStorage.setItem('pulseUser', JSON.stringify(currentUser));
                    showMainApp();
                })
                .catch((error) => {
                    console.error('Google login error:', error);
                    alert('Login failed: ' + error.message);
                });
        }

        function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Get user data from Firebase Database
                    database.ref('users/' + user.uid).once('value')
                        .then((snapshot) => {
                            if (snapshot.exists()) {
                                currentUser = snapshot.val();
                            } else {
                                // Create basic user profile if doesn't exist
                                currentUser = {
                                    uid: user.uid,
                                    name: user.displayName || email.split('@')[0],
                                    email: user.email,
                                    country: getUserCountry(),
                                    accountType: 'personal',
                                    profilePic: user.photoURL,
                                    bio: 'Hey there! I\'m using Pulse'
                                };
                                database.ref('users/' + user.uid).set(currentUser);
                            }
                            
                            localStorage.setItem('pulseUser', JSON.stringify(currentUser));
                            showMainApp();
                        });
                })
                .catch((error) => {
                    console.error('Email login error:', error);
                    alert('Login failed: ' + error.message);
                });
        }

        function registerUser() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const bio = document.getElementById('registerBio').value;
            const accountType = document.getElementById('registerAccountType').value;
            
            if (!name || !email || !password) {
                alert('Please fill in required fields');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Update user profile
                    user.updateProfile({
                        displayName: name
                    });
                    
                    // Create user data object
                    currentUser = {
                        uid: user.uid,
                        name: name,
                        email: email,
                        phone: phone,
                        bio: bio || 'Hey there! I\'m using Pulse',
                        country: getUserCountry(),
                        accountType: accountType,
                        profilePic: null,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    };

                    if (accountType === 'business') {
                        currentUser.businessName = document.getElementById('registerBusinessName').value;
                        currentUser.legalName = document.getElementById('registerLegalName').value;
                        currentUser.headquarters = document.getElementById('registerHeadquarters').value;
                        currentUser.gstNumber = document.getElementById('registerGST').value;
                    }
                    
                    // Save to Firebase Database
                    database.ref('users/' + user.uid).set(currentUser)
                        .then(() => {
                            localStorage.setItem('pulseUser', JSON.stringify(currentUser));
                            showMainApp();
                        })
                        .catch((error) => {
                            console.error('Error saving user data:', error);
                            alert('Registration completed but failed to save profile data');
                            showMainApp();
                        });
                })
                .catch((error) => {
                    console.error('Registration error:', error);
                    alert('Registration failed: ' + error.message);
                });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    // Update last seen
                    if (currentUser) {
                        database.ref('users/' + currentUser.uid + '/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
                    }
                    
                    localStorage.removeItem('pulseUser');
                    currentUser = null;
                    document.getElementById('bottomNavigation').classList.add('hidden');
                    showLoginScreen();
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                });
        }

        function sendWelcomeMessage() {
            // Send welcome message from Pulse official account
            setTimeout(() => {
                const welcomeMessages = [
                    '🎉 Welcome to Pulse! Your secure messaging experience starts here.',
                    '✨ Discover amazing features: Status updates, Voice calls, File sharing & more!',
                    '🔒 Your privacy matters. All messages are end-to-end encrypted.',
                    '💡 Tip: Tap on profiles to start chatting instantly!'
                ];
                
                welcomeMessages.forEach((msg, index) => {
                    setTimeout(() => {
                        if (!sampleMessages['pulse_official']) {
                            sampleMessages['pulse_official'] = [];
                        }
                        sampleMessages['pulse_official'].push({
                            id: 'welcome-' + index,
                            sender: 'other',
                            text: msg,
                            timestamp: Date.now(),
                            seen: false,
                            type: 'text'
                        });
                        
                        if (currentChat && currentChat.id === 'pulse_official') {
                            loadMessages('pulse_official');
                        }
                    }, index * 2000);
                });
            }, 1000);
            
            // Setup daily messages
            setupDailyMessages();
        }
        
        function setupDailyMessages() {
            const dailyMessages = [
                '🚀 New Feature Alert: Voice message reactions are now live!',
                '💎 Premium users can now edit messages up to 48 hours after sending!',
                '🔥 Trending: Dark mode usage increased by 300% this week!',
                '📊 Your chat activity: 50% more active than last month!',
                '🎯 Pro Tip: Long press on messages to add reactions!',
                '🌟 Update Available: Enhanced file sharing with preview support!',
                '🔐 Security Update: Advanced encryption protocols now active!',
                '💬 Community: Join 10M+ users worldwide on Pulse!',
                '🎨 Customize: Try our new chat wallpapers in Settings!',
                '⚡ Performance: Messages now load 2x faster!'
            ];
            
            // Send a daily message every 24 hours (simulated as every 30 seconds for demo)
            setInterval(() => {
                const randomMessage = dailyMessages[Math.floor(Math.random() * dailyMessages.length)];
                
                if (!sampleMessages['pulse_official']) {
                    sampleMessages['pulse_official'] = [];
                }
                
                sampleMessages['pulse_official'].push({
                    id: 'daily-' + Date.now(),
                    sender: 'other',
                    text: randomMessage,
                    timestamp: Date.now(),
                    seen: false,
                    type: 'text'
                });
                
                // Update chat list
                const pulseChat = realAccounts.find(acc => acc.id === 'pulse_official');
                if (pulseChat) {
                    pulseChat.lastMessage = randomMessage;
                    pulseChat.time = 'now';
                    pulseChat.unread = (pulseChat.unread || 0) + 1;
                    renderChatList();
                }
                
                // If currently viewing Pulse chat, update messages
                if (currentChat && currentChat.id === 'pulse_official') {
                    loadMessages('pulse_official');
                }
            }, 30000); // 30 seconds for demo (change to 86400000 for 24 hours)
        }

        // Render chat list with real-time updates
        function renderChatList() {
            if (!currentUser) return;
            
            const chatList = document.getElementById('chatList');
            
            // Listen for real-time chat updates
            database.ref('chats/' + currentUser.uid).on('value', (snapshot) => {
                chatList.innerHTML = '';
                
                // Add real accounts first
                realAccounts.forEach(chat => {
                    renderChatItem(chat, chatList);
                });
                
                // Add user chats from Firebase
                if (snapshot.exists()) {
                    const chats = [];
                    snapshot.forEach((childSnapshot) => {
                        const chatData = childSnapshot.val();
                        const chatUserId = childSnapshot.key;
                        
                        // Skip if it's already in realAccounts
                        if (!realAccounts.find(acc => acc.id === chatUserId)) {
                            chats.push({
                                id: chatUserId,
                                ...chatData.chatWith,
                                lastMessage: chatData.lastMessage || 'No messages yet',
                                time: chatData.lastMessageTime ? formatTime(chatData.lastMessageTime) : '',
                                unread: chatData.unreadCount || 0,
                                online: false // Will be updated by presence system
                            });
                        }
                    });
                    
                    // Sort by last message time
                    chats.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                    
                    chats.forEach(chat => {
                        renderChatItem(chat, chatList);
                    });
                }
            });
        }
        
        // Render individual chat item
        function renderChatItem(chat, container) {
            const chatItem = document.createElement('div');
            chatItem.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors';
            chatItem.onclick = () => openChat(chat);

            const countryFlag = getCountryFlag(chat.country || 'IN');
            const verifiedBadge = chat.verified ? `
                <div class="verified-tick ml-1">
                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            ` : '';

            const businessBadge = chat.business ? `
                <span class="business-badge text-white ml-2">BUSINESS</span>
            ` : '';

            const premiumBadge = chat.premium ? `
                <span class="premium-badge ml-2">PREMIUM</span>
            ` : '';

            chatItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <img src="${chat.avatar || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\' viewBox=\'0 0 48 48\'%3E%3Ccircle cx=\'24\' cy=\'24\' r=\'24\' fill=\'%23E5E7EB\'/%3E%3Ctext x=\'24\' y=\'30\' text-anchor=\'middle\' fill=\'%236B7280\' font-size=\'16\'%3E${(chat.name || 'U').charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E'}" alt="${chat.name}" class="w-12 h-12 rounded-full">
                        ${chat.online ? '<div class="online-dot"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center flex-wrap">
                                <h4 class="font-semibold text-gray-900 truncate">${chat.name}</h4>
                                ${verifiedBadge}
                                ${premiumBadge}
                                ${businessBadge}
                                <img src="${countryFlag}" alt="${chat.country || 'IN'}" class="country-flag ml-2">
                            </div>
                            <span class="text-xs text-gray-500">${chat.time}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-sm text-gray-600 truncate">${chat.lastMessage}</p>
                            ${chat.unread > 0 ? `<span class="bg-blue-500 text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center">${chat.unread}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(chatItem);
        }

        // Get country flag
        function getCountryFlag(countryCode) {
            const flags = {
                'US': 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 15"%3E%3Crect width="20" height="15" fill="%23B22234"/%3E%3Cpath d="M0,1.15h20M0,2.31h20M0,3.46h20M0,4.62h20M0,5.77h20M0,6.92h20M0,8.08h20M0,9.23h20M0,10.38h20M0,11.54h20M0,12.69h20M0,13.85h20M0,15h20" stroke="%23fff" stroke-width="0.77"/%3E%3Crect width="8" height="8" fill="%233C3B6E"/%3E%3C/svg%3E',
                'IN': 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 15"%3E%3Crect width="20" height="5" fill="%23FF9933"/%3E%3Crect y="5" width="20" height="5" fill="%23fff"/%3E%3Crect y="10" width="20" height="5" fill="%23138808"/%3E%3Ccircle cx="10" cy="7.5" r="2" fill="none" stroke="%23000080" stroke-width="0.5"/%3E%3C/svg%3E',
                'UK': 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 15"%3E%3Crect width="20" height="15" fill="%23012169"/%3E%3Cpath d="M0,0L20,15M20,0L0,15" stroke="%23fff" stroke-width="2"/%3E%3Cpath d="M0,0L20,15M20,0L0,15" stroke="%23C8102E" stroke-width="1"/%3E%3Cpath d="M10,0v15M0,7.5h20" stroke="%23fff" stroke-width="3"/%3E%3Cpath d="M10,0v15M0,7.5h20" stroke="%23C8102E" stroke-width="2"/%3E%3C/svg%3E'
            };
            return flags[countryCode] || flags['IN'];
        }

        // Mobile sidebar functions
        function openMobileSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        }
        
        function closeMobileSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }
        
        function goBackToChats() {
            // Hide chat, show welcome screen on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('welcomeScreen').classList.remove('hidden');
                document.getElementById('mobileChatHeader').classList.add('hidden');
                document.getElementById('messagesArea').classList.add('hidden');
                document.getElementById('messageInput').classList.add('hidden');
                currentChat = null;
            }
        }

        // Open chat
        function openChat(chat) {
            currentChat = chat;
            
            // Close mobile sidebar if open
            closeMobileSidebar();
            
            // Hide welcome screen, show chat
            document.getElementById('welcomeScreen').classList.add('hidden');
            
            // Show appropriate header based on screen size
            if (window.innerWidth <= 768) {
                document.getElementById('mobileChatHeader').classList.remove('hidden');
                document.getElementById('chatHeader').classList.add('hidden');
                
                // Update mobile chat header
                document.getElementById('mobileChatAvatar').src = chat.avatar;
                document.getElementById('mobileChatName').textContent = chat.name;
                document.getElementById('mobileChatStatus').textContent = chat.status;
                document.getElementById('mobileOnlineIndicator').classList.toggle('hidden', !chat.online);
            } else {
                document.getElementById('chatHeader').classList.remove('hidden');
                document.getElementById('mobileChatHeader').classList.add('hidden');
                
                // Update desktop chat header
                document.getElementById('chatAvatar').src = chat.avatar;
                document.getElementById('chatName').textContent = chat.name;
                document.getElementById('chatStatus').textContent = chat.status;
                document.getElementById('onlineIndicator').classList.toggle('hidden', !chat.online);
            }
            
            document.getElementById('messagesArea').classList.remove('hidden');
            document.getElementById('messageInput').classList.remove('hidden');
            
            // Load messages
            loadMessages(chat.id);
        }

        // Load messages with real-time listener
        function loadMessages(chatUserId) {
            if (!currentUser) return;
            
            const messagesArea = document.getElementById('messagesArea');
            const chatId = getChatId(currentUser.uid, chatUserId);
            
            // Remove existing listener if any
            if (window.currentMessageListener) {
                window.currentMessageListener.off();
            }
            
            // Set up real-time listener for messages
            window.currentMessageListener = database.ref('messages/' + chatId)
                .orderByChild('timestamp')
                .on('value', (snapshot) => {
                    messagesArea.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const messages = [];
                        snapshot.forEach((childSnapshot) => {
                            messages.push(childSnapshot.val());
                        });
                        
                        messages.forEach(message => {
                            displayMessage(message);
                        });
                    }
                    
                    // Scroll to bottom
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                    
                    // Mark messages as seen
                    markMessagesAsSeen(chatId, chatUserId);
                });
        }
        
        // Display individual message
        function displayMessage(message) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            const isMyMessage = message.senderId === currentUser.uid;
            
            messageDiv.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;
            
            const bubbleClass = isMyMessage 
                ? 'bg-blue-500 text-white' 
                : 'bg-white border border-gray-200';
            
            let messageContent = '';
            
            if (message.type === 'voice') {
                messageContent = `
                    <div class="flex items-center space-x-2">
                        <button onclick="playVoiceMessage('${message.id}')" class="p-2 rounded-full bg-blue-600 hover:bg-blue-700">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 0%" id="progress-${message.id}"></div>
                        </div>
                        <span class="text-xs">0:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}</span>
                    </div>
                `;
            } else if (message.type === 'image') {
                messageContent = `
                    <div class="max-w-xs">
                        <img src="${message.imageUrl}" alt="Image" class="rounded-lg max-w-full h-auto">
                        ${message.text ? `<p class="text-sm mt-2">${message.text}</p>` : ''}
                    </div>
                `;
            } else {
                messageContent = `<p class="text-sm">${message.text}</p>`;
            }
            
            const reactions = message.reactions ? Object.entries(message.reactions).map(([emoji, count]) => 
                `<span class="text-xs bg-gray-100 rounded-full px-2 py-1 mr-1">${emoji} ${count}</span>`
            ).join('') : '';
            
            const timestamp = message.timestamp ? (typeof message.timestamp === 'number' ? message.timestamp : Date.now()) : Date.now();
            
            messageDiv.innerHTML = `
                <div class="chat-bubble ${bubbleClass} rounded-2xl px-4 py-2 shadow-sm relative group" 
                     oncontextmenu="showReactionMenu(event, '${message.id}')" 
                     data-message-id="${message.id}">
                    ${messageContent}
                    ${reactions ? `<div class="mt-1">${reactions}</div>` : ''}
                    <div class="flex items-center justify-end mt-1 space-x-1">
                        <span class="message-time">${formatTime(timestamp)}</span>
                        ${isMyMessage ? `
                            <svg class="w-3 h-3 ${message.seen ? 'text-blue-300' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        ` : ''}
                    </div>
                    ${currentUser && currentUser.premium && isMyMessage ? `
                        <button onclick="editMessage('${message.id}')" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-gray-600 text-white rounded-full p-1">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                            </svg>
                        </button>
                    ` : ''}
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
        }
        
        // Mark messages as seen
        function markMessagesAsSeen(chatId, otherUserId) {
            if (!currentUser) return;
            
            database.ref('messages/' + chatId)
                .orderByChild('receiverId')
                .equalTo(currentUser.uid)
                .once('value', (snapshot) => {
                    const updates = {};
                    snapshot.forEach((childSnapshot) => {
                        const messageId = childSnapshot.key;
                        updates['/messages/' + chatId + '/' + messageId + '/seen'] = true;
                    });
                    
                    if (Object.keys(updates).length > 0) {
                        database.ref().update(updates);
                    }
                    
                    // Reset unread count
                    database.ref('chats/' + currentUser.uid + '/' + otherUserId + '/unreadCount').set(0);
                });
        }
        
        // Setup premium content
        function setupPremiumContent() {
            const premiumContent = document.getElementById('premiumContent');
            
            if (currentUser && currentUser.email === 'sgursharn076@gmail.com') {
                // User has premium access
                premiumContent.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-lg mb-3">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">👑</span>
                            <div>
                                <h4 class="font-bold">Pulse Premium Active</h4>
                                <p class="text-sm opacity-90">Premium since ${currentUser.premiumSince || '2024'}</p>
                            </div>
                        </div>
                        <div class="text-sm">
                            <p>✨ Edit Messages</p>
                            <p>🔍 See Deleted Messages</p>
                            <p>📊 Advanced Analytics</p>
                            <p>🎨 Custom Themes</p>
                            <p>☁️ Unlimited Storage</p>
                        </div>
                    </div>
                `;
            } else {
                // Show premium upgrade option
                premiumContent.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg mb-3">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">👑</span>
                            <div>
                                <h4 class="font-bold">Upgrade to Premium</h4>
                                <p class="text-sm opacity-90">$130/year - Exclusive Features</p>
                            </div>
                        </div>
                        <button onclick="showPremiumUpgrade()" class="w-full bg-white text-blue-600 py-2 rounded-lg font-semibold mt-2">
                            Learn More
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 text-center">Premium access is currently limited to select users</p>
                `;
            }
        }
        
        // Voice message functions
        function playVoiceMessage(messageId) {
            const progressBar = document.getElementById(`progress-${messageId}`);
            if (progressBar) {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 2;
                    progressBar.style.width = progress + '%';
                    if (progress >= 100) {
                        clearInterval(interval);
                        setTimeout(() => {
                            progressBar.style.width = '0%';
                        }, 500);
                    }
                }, 100);
            }
        }
        
        // Message reactions
        function showReactionMenu(event, messageId) {
            event.preventDefault();
            const popup = document.getElementById('reactionsPopup');
            popup.style.left = event.pageX + 'px';
            popup.style.top = (event.pageY - 50) + 'px';
            popup.classList.remove('hidden');
            popup.dataset.messageId = messageId;
            
            // Hide after 3 seconds
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 3000);
        }
        
        function addReaction(emoji) {
            const popup = document.getElementById('reactionsPopup');
            const messageId = popup.dataset.messageId;
            
            if (currentChat && messageId) {
                const messages = sampleMessages[currentChat.id] || [];
                const message = messages.find(m => m.id === messageId);
                
                if (message) {
                    if (!message.reactions) message.reactions = {};
                    message.reactions[emoji] = (message.reactions[emoji] || 0) + 1;
                    loadMessages(currentChat.id);
                }
            }
            
            popup.classList.add('hidden');
        }
        
        // Premium features
        function editMessage(messageId) {
            if (!currentUser || !currentUser.premium) {
                alert('This feature is only available for Premium users');
                return;
            }
            
            const newText = prompt('Edit your message:');
            if (newText && currentChat) {
                const messages = sampleMessages[currentChat.id] || [];
                const message = messages.find(m => m.id === messageId);
                
                if (message && message.sender === 'me') {
                    message.text = newText + ' (edited)';
                    loadMessages(currentChat.id);
                }
            }
        }
        
        function showPremiumUpgrade() {
            alert('Premium access is currently limited to select users. Contact support for more information.');
        }

        // Send message
        function sendMessage() {
            const messageText = document.getElementById('messageText');
            const text = messageText.value.trim();
            
            if (!text || !currentChat || !currentUser) return;
            
            const messageId = database.ref().child('messages').push().key;
            const chatId = getChatId(currentUser.uid, currentChat.id);
            
            const message = {
                id: messageId,
                senderId: currentUser.uid,
                receiverId: currentChat.id,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                seen: false,
                type: 'text',
                senderName: currentUser.name,
                senderAvatar: currentUser.profilePic
            };
            
            // Save message to Firebase
            const updates = {};
            updates['/messages/' + chatId + '/' + messageId] = message;
            updates['/chats/' + currentUser.uid + '/' + currentChat.id] = {
                lastMessage: text,
                lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                unreadCount: 0,
                chatWith: {
                    uid: currentChat.id,
                    name: currentChat.name,
                    avatar: currentChat.avatar
                }
            };
            updates['/chats/' + currentChat.id + '/' + currentUser.uid] = {
                lastMessage: text,
                lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                unreadCount: firebase.database.ServerValue.increment(1),
                chatWith: {
                    uid: currentUser.uid,
                    name: currentUser.name,
                    avatar: currentUser.profilePic
                }
            };
            
            database.ref().update(updates)
                .then(() => {
                    messageText.value = '';
                    // Message will be displayed via real-time listener
                })
                .catch((error) => {
                    console.error('Error sending message:', error);
                    alert('Failed to send message');
                });
        }

        // Get chat ID for two users
        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
        }

        // Handle message key press
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('hidden');
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }

        // Simulate response
        function simulateResponse() {
            const responses = [
                "That's interesting!",
                "I see what you mean.",
                "Thanks for sharing!",
                "Let me think about that.",
                "Sounds good to me!"
            ];
            
            const response = {
                id: 'msg' + Date.now(),
                sender: 'other',
                text: responses[Math.floor(Math.random() * responses.length)],
                timestamp: Date.now(),
                seen: false,
                type: 'text'
            };
            
            sampleMessages[currentChat.id].push(response);
            loadMessages(currentChat.id);
            
            // Update chat list
            const chat = sampleChats.find(c => c.id === currentChat.id);
            if (chat) {
                chat.lastMessage = response.text;
                chat.time = formatTime(Date.now());
                renderChatList();
            }
        }

        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // Profile modal functions
        function showProfileModal() {
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function toggleBusinessFields() {
            const accountType = document.getElementById('accountType').value;
            const businessFields = document.getElementById('businessFields');
            
            if (accountType === 'business') {
                businessFields.classList.remove('hidden');
            } else {
                businessFields.classList.add('hidden');
            }
        }

        function saveProfile() {
            // In a real app, save to Firebase
            alert('Profile saved successfully!');
            closeProfileModal();
        }

        // Status modal functions
        function showStatusModal() {
            document.getElementById('statusModal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden');
        }

        function postStatus() {
            const content = document.getElementById('statusContent').value.trim();
            if (!content) return;
            
            // In a real app, save to Firebase
            alert('Status posted successfully!');
            closeStatusModal();
            document.getElementById('statusContent').value = '';
        }

        // Call functions
        function startVideoCall() {
            if (!currentChat) return;
            alert(`Starting video call with ${currentChat.name}...`);
        }

        function startVoiceCall() {
            if (!currentChat) return;
            alert(`Starting voice call with ${currentChat.name}...`);
        }

        // File attachment with Firebase Storage
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file);
                }
            };
            input.click();
        }
        
        // Upload file to Firebase Storage
        function uploadFile(file) {
            if (!currentUser || !currentChat) return;
            
            const fileId = Date.now() + '_' + file.name;
            const storageRef = storage.ref('uploads/' + currentUser.uid + '/' + fileId);
            
            // Show upload progress
            const progressDiv = document.createElement('div');
            progressDiv.className = 'fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg z-50';
            progressDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium">Uploading ${file.name}</p>
                        <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                            <div id="uploadProgress" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressDiv);
            
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progress
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('uploadProgress').style.width = progress + '%';
                },
                (error) => {
                    // Error
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                    document.body.removeChild(progressDiv);
                },
                () => {
                    // Success
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        document.body.removeChild(progressDiv);
                        
                        // Send message with file
                        const messageId = database.ref().child('messages').push().key;
                        const chatId = getChatId(currentUser.uid, currentChat.id);
                        
                        let messageType = 'file';
                        if (file.type.startsWith('image/')) messageType = 'image';
                        else if (file.type.startsWith('video/')) messageType = 'video';
                        else if (file.type.startsWith('audio/')) messageType = 'voice';
                        
                        const message = {
                            id: messageId,
                            senderId: currentUser.uid,
                            receiverId: currentChat.id,
                            text: file.name,
                            fileUrl: downloadURL,
                            fileName: file.name,
                            fileSize: file.size,
                            fileType: file.type,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            seen: false,
                            type: messageType,
                            senderName: currentUser.name,
                            senderAvatar: currentUser.profilePic
                        };
                        
                        // Save message to Firebase
                        const updates = {};
                        updates['/messages/' + chatId + '/' + messageId] = message;
                        updates['/chats/' + currentUser.uid + '/' + currentChat.id] = {
                            lastMessage: messageType === 'image' ? '📷 Photo' : messageType === 'video' ? '🎥 Video' : messageType === 'voice' ? '🎤 Voice message' : '📎 ' + file.name,
                            lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                            unreadCount: 0,
                            chatWith: {
                                uid: currentChat.id,
                                name: currentChat.name,
                                avatar: currentChat.avatar
                            }
                        };
                        updates['/chats/' + currentChat.id + '/' + currentUser.uid] = {
                            lastMessage: messageType === 'image' ? '📷 Photo' : messageType === 'video' ? '🎥 Video' : messageType === 'voice' ? '🎤 Voice message' : '📎 ' + file.name,
                            lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                            unreadCount: firebase.database.ServerValue.increment(1),
                            chatWith: {
                                uid: currentUser.uid,
                                name: currentUser.name,
                                avatar: currentUser.profilePic
                            }
                        };
                        
                        database.ref().update(updates)
                            .then(() => {
                                console.log('File message sent successfully');
                            })
                            .catch((error) => {
                                console.error('Error sending file message:', error);
                                alert('Failed to send file');
                            });
                    });
                }
            );
        }

        // Emoji picker
        function toggleEmojiPicker() {
            const emojis = ['😀', '😂', '😍', '🤔', '👍', '❤️', '🔥', '💯'];
            const messageText = document.getElementById('messageText');
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            messageText.value += randomEmoji;
            messageText.focus();
        }

        // Additional utility functions
        function switchTab(tab) {
            activeTab = tab;
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Handle tab content
            switch(tab) {
                case 'home':
                    // Show main chat interface
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                    document.getElementById('chatHeader').classList.add('hidden');
                    document.getElementById('messagesArea').classList.add('hidden');
                    document.getElementById('messageInput').classList.add('hidden');
                    currentChat = null;
                    break;
                case 'status':
                    showStatusModal();
                    break;
                case 'calls':
                    alert('📞 Calls feature coming soon!\n\n🎥 Video & Voice calls\n👥 Group calling\n🔒 End-to-end encrypted');
                    break;
                case 'settings':
                    showSettingsModal();
                    break;
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-theme', isDarkMode);
            
            const toggle = document.getElementById('themeToggle');
            if (isDarkMode) {
                toggle.classList.add('bg-blue-500');
                toggle.classList.remove('bg-gray-300');
                toggle.querySelector('div').classList.add('translate-x-6');
            } else {
                toggle.classList.remove('bg-blue-500');
                toggle.classList.add('bg-gray-300');
                toggle.querySelector('div').classList.remove('translate-x-6');
            }
            
            localStorage.setItem('pulseTheme', isDarkMode ? 'dark' : 'light');
        }

        function showSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function toggleRegisterBusinessFields() {
            const accountType = document.getElementById('registerAccountType').value;
            const businessFields = document.getElementById('registerBusinessFields');
            
            if (accountType === 'business') {
                businessFields.classList.remove('hidden');
            } else {
                businessFields.classList.add('hidden');
            }
        }

        function uploadProfilePicture() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64 = e.target.result;
                        // Update profile picture preview
                        document.querySelector('#registerScreen .w-20').innerHTML = `<img src="${base64}" class="w-20 h-20 rounded-full object-cover">`;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Enhanced message sending with media support
        function sendMediaMessage(type, data) {
            if (!currentChat) return;
            
            const message = {
                id: 'msg' + Date.now(),
                sender: 'me',
                type: type,
                data: data,
                timestamp: Date.now(),
                seen: false
            };
            
            if (!sampleMessages[currentChat.id]) {
                sampleMessages[currentChat.id] = [];
            }
            sampleMessages[currentChat.id].push(message);
            
            loadMessages(currentChat.id);
            
            // Update chat list
            const chat = realAccounts.find(c => c.id === currentChat.id);
            if (chat) {
                chat.lastMessage = type === 'image' ? '📷 Photo' : type === 'voice' ? '🎤 Voice message' : '📎 File';
                chat.time = formatTime(Date.now());
                renderChatList();
            }
        }

        // Voice recording functionality
        let mediaRecorder;
        let audioChunks = [];

        function startVoiceRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const reader = new FileReader();
                        reader.onload = () => {
                            sendMediaMessage('voice', reader.result);
                        };
                        reader.readAsDataURL(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    alert('Recording started... Click again to stop');
                })
                .catch(err => {
                    alert('Microphone access denied');
                });
        }

        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // Load saved theme on startup
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('pulseTheme');
            if (savedTheme === 'dark') {
                toggleTheme();
            }
        }

        // Handle window resize for responsive behavior
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                // Desktop view - close mobile sidebar
                closeMobileSidebar();
                
                // Switch to desktop header if chat is open
                if (currentChat) {
                    document.getElementById('chatHeader').classList.remove('hidden');
                    document.getElementById('mobileChatHeader').classList.add('hidden');
                }
            } else {
                // Mobile view - switch to mobile header if chat is open
                if (currentChat) {
                    document.getElementById('mobileChatHeader').classList.remove('hidden');
                    document.getElementById('chatHeader').classList.add('hidden');
                }
            }
        });

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            loadSavedTheme();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9718110110b1c6aa',t:'MTc1NTU4OTg5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
