<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - Real-time Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ios-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        .status-ring {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            padding: 2px;
            border-radius: 50%;
        }
        
        .chat-item:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        .message-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .instagram-gradient {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <!-- Main Container -->
    <div class="flex h-full relative">
        <!-- Mobile Menu Button -->
        <button id="mobileMenuBtn" onclick="toggleMobileMenu()" class="md:hidden fixed top-4 left-4 z-50 bg-purple-500 text-white p-2 rounded-full shadow-lg">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
            </svg>
        </button>

        <!-- Sidebar -->
        <div id="sidebar" class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col fixed md:relative inset-y-0 left-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <!-- Header -->
            <div class="p-4 border-b border-gray-100 bg-gradient-to-r from-purple-500 to-pink-500">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="status-ring">
                            <img id="userAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23667eea'/%3E%3Ctext x='20' y='26' text-anchor='middle' fill='white' font-size='16' font-weight='bold'%3EP%3C/text%3E%3C/svg%3E" 
                                 class="w-10 h-10 rounded-full bg-white" alt="Profile">
                        </div>
                        <div>
                            <h2 id="userName" class="text-white font-semibold">Pulse User</h2>
                            <p class="text-white/80 text-sm" id="userStatus">Online</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="showSettings()" class="text-white/80 hover:text-white p-2 rounded-full hover:bg-white/20">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <button onclick="logout()" class="text-white/80 hover:text-white p-2 rounded-full hover:bg-white/20">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="p-4">
                <div class="relative">
                    <input type="text" placeholder="Search chats..." 
                           class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>

            <!-- Status Stories -->
            <div class="px-4 pb-4">
                <div class="flex space-x-3 overflow-x-auto">
                    <div class="flex-shrink-0 text-center">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-300">
                            <svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Your Story</p>
                    </div>
                    <div class="flex-shrink-0 text-center">
                        <div class="status-ring">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='24' fill='%23ff6b6b'/%3E%3Ctext x='24' y='30' text-anchor='middle' fill='white' font-size='18' font-weight='bold'%3EA%3C/text%3E%3C/svg%3E" 
                                 class="w-12 h-12 rounded-full bg-white">
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Arya</p>
                    </div>
                    <div class="flex-shrink-0 text-center">
                        <div class="status-ring">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='24' fill='%234ecdc4'/%3E%3Ctext x='24' y='30' text-anchor='middle' fill='white' font-size='18' font-weight='bold'%3ER%3C/text%3E%3C/svg%3E" 
                                 class="w-12 h-12 rounded-full bg-white">
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Rahul</p>
                    </div>
                </div>
            </div>

            <!-- Chat List -->
            <div class="flex-1 overflow-y-auto">
                <div id="chatList" class="space-y-1">
                    <!-- Chat items will be populated here -->
                </div>
            </div>

            <!-- New Chat Button -->
            <div class="p-4">
                <button onclick="showNewChatModal()" class="w-full instagram-gradient text-white py-3 rounded-full font-medium hover:opacity-90 transition-opacity">
                    + New Chat
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col md:ml-0 ml-0">
            <!-- Chat Header -->
            <div id="chatHeader" class="hidden p-4 bg-white border-b border-gray-200 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img id="chatAvatar" class="w-10 h-10 rounded-full" alt="Chat Avatar">
                    <div>
                        <h3 id="chatName" class="font-semibold text-gray-900"></h3>
                        <p id="chatStatus" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="startVideoCall()" class="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-full">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                        </svg>
                    </button>
                    <button onclick="startVoiceCall()" class="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-full">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                        </svg>
                    </button>
                    <button onclick="showChatInfo()" class="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-full">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex-1 flex items-center justify-center bg-gradient-to-br from-purple-50 to-pink-50">
                <div class="text-center">
                    <div class="w-32 h-32 mx-auto mb-6 instagram-gradient rounded-full flex items-center justify-center">
                        <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome to Pulse</h2>
                    <p class="text-gray-600 mb-6">Select a chat to start messaging</p>
                    <button onclick="showNewChatModal()" class="instagram-gradient text-white px-6 py-3 rounded-full font-medium hover:opacity-90 transition-opacity">
                        Start New Chat
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="hidden flex-1 overflow-y-auto p-4 bg-gray-50">
                <div id="messagesList" class="space-y-4">
                    <!-- Messages will be populated here -->
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-4 py-2 text-sm text-gray-500">
                <span class="typing-indicator">Someone is typing...</span>
            </div>

            <!-- Message Input -->
            <div id="messageInput" class="hidden p-4 bg-white border-t border-gray-200">
                <div class="flex items-center space-x-3">
                    <button onclick="showEmojiPicker()" class="p-2 text-gray-600 hover:text-purple-600 rounded-full hover:bg-purple-50">
                        ğŸ˜Š
                    </button>
                    <button onclick="attachFile()" class="p-2 text-gray-600 hover:text-purple-600 rounded-full hover:bg-purple-50">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div class="flex-1 relative">
                        <input type="text" id="messageText" placeholder="Type a message..." 
                               class="w-full px-4 py-2 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500"
                               onkeypress="handleMessageKeyPress(event)">
                    </div>
                    <button onclick="sendMessage()" class="p-2 instagram-gradient text-white rounded-full hover:opacity-90">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 w-96 ios-shadow">
            <div class="text-center mb-6">
                <div class="w-20 h-20 mx-auto mb-4 instagram-gradient rounded-full flex items-center justify-center">
                    <span class="text-white text-2xl font-bold">P</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Welcome to Pulse</h2>
                <p class="text-gray-600">Connect with friends and family</p>
            </div>

            <div id="loginForm">




                <!-- Email Login Form -->
                <div id="emailLoginForm" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Account Type</label>
                        <select id="accountType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="toggleBusinessFields()">
                            <option value="personal">Personal</option>
                            <option value="business">Business</option>
                        </select>
                    </div>
                    <div>
                        <input type="email" id="loginEmail" placeholder="Email address" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <input type="password" id="loginPassword" placeholder="Password" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <!-- Business Fields -->
                    <div id="businessFields" class="hidden space-y-4">
                        <div>
                            <input type="text" id="businessName" placeholder="Business Name" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <input type="text" id="legalName" placeholder="Legal Name" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <input type="text" id="headquarters" placeholder="Headquarters Address" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <input type="text" id="gstNumber" placeholder="GST Number" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <input type="text" id="country" placeholder="Country" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>





                <div class="text-center">
                    <button onclick="signInWithGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 py-4 rounded-lg font-medium hover:bg-gray-50 flex items-center justify-center space-x-3 shadow-sm">
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span class="text-lg">Continue with Google</span>
                    </button>
                </div>

                <p class="mt-4 text-center text-sm text-gray-600">
                    Don't have an account? 
                    <button onclick="showRegister()" class="text-purple-600 hover:text-purple-700 font-medium">Sign up</button>
                </p>
            </div>

            <div id="registerForm" class="hidden">
                <div class="space-y-4">
                    <div>
                        <input type="text" id="registerName" placeholder="Full Name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <input type="email" id="registerEmail" placeholder="Email address" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <input type="tel" id="registerPhone" placeholder="Phone Number" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <input type="password" id="registerPassword" placeholder="Password" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <button onclick="register()" class="w-full mt-6 instagram-gradient text-white py-3 rounded-lg font-medium hover:opacity-90">
                    Create Account
                </button>

                <p class="mt-4 text-center text-sm text-gray-600">
                    Already have an account? 
                    <button onclick="showLogin()" class="text-purple-600 hover:text-purple-700 font-medium">Sign in</button>
                </p>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-96 ios-shadow">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Start New Chat</h3>
            <div class="space-y-4">
                <input type="email" id="newChatEmail" placeholder="Enter email address" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <div class="flex space-x-3">
                    <button onclick="startNewChat()" class="flex-1 instagram-gradient text-white py-2 rounded-lg font-medium hover:opacity-90">
                        Start Chat
                    </button>
                    <button onclick="closeNewChatModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB2XeuTfHZ7FYKLoYb4epKp3upmVqG0fzE",
            authDomain: "pulse-17f40.firebaseapp.com",
            databaseURL: "https://pulse-17f40-default-rtdb.firebaseio.com",
            projectId: "pulse-17f40",
            storageBucket: "pulse-17f40.firebasestorage.app",
            messagingSenderId: "259780854138",
            appId: "1:259780854138:web:89c265fd22a34a7f1fd6c3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let currentChatId = null;
        let currentChatUser = null;
        let isMobileMenuOpen = false;

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginModal').classList.add('hidden');
                loadUserData();
                loadChats();
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        });

        // Toggle business fields
        function toggleBusinessFields() {
            const accountType = document.getElementById('accountType').value;
            const businessFields = document.getElementById('businessFields');
            
            if (accountType === 'business') {
                businessFields.classList.remove('hidden');
            } else {
                businessFields.classList.add('hidden');
            }
        }

        // Authentication functions
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }





        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Save user data to database
                await database.ref('users/' + user.uid).set({
                    name: name,
                    email: email,
                    phone: phone,
                    profilePic: generateAvatar(name),
                    status: 'Online',
                    lastSeen: Date.now(),
                    customStatus: 'Hey there! I am using Pulse.',
                    accountType: 'personal',
                    createdAt: Date.now()
                });
                
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Check if user exists in database
                const userRef = database.ref('users/' + user.uid);
                const snapshot = await userRef.once('value');
                
                if (!snapshot.exists()) {
                    // Create new user record
                    await userRef.set({
                        name: user.displayName,
                        email: user.email,
                        profilePic: user.photoURL || generateAvatar(user.displayName),
                        status: 'Online',
                        lastSeen: Date.now(),
                        customStatus: 'Hey there! I am using Pulse.',
                        accountType: 'personal',
                        createdAt: Date.now()
                    });
                }
            } catch (error) {
                alert('Google sign-in failed: ' + error.message);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        }

        // Generate avatar SVG
        function generateAvatar(name) {
            const initial = name ? name.charAt(0).toUpperCase() : 'U';
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='${encodeURIComponent(color)}'/%3E%3Ctext x='20' y='26' text-anchor='middle' fill='white' font-size='16' font-weight='bold'%3E${initial}%3C/text%3E%3C/svg%3E`;
        }

        // Load user data
        async function loadUserData() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();
            
            if (userData) {
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userStatus').textContent = userData.customStatus || 'Online';
                document.getElementById('userAvatar').src = userData.profilePic;
            }
        }

        // Load chats
        function loadChats() {
            if (!currentUser) return;
            
            const chatsRef = database.ref('chats');
            chatsRef.on('value', (snapshot) => {
                const chats = snapshot.val() || {};
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';
                
                Object.keys(chats).forEach(chatId => {
                    const chat = chats[chatId];
                    if (chat.participants && chat.participants.includes(currentUser.uid)) {
                        createChatItem(chatId, chat);
                    }
                });
            });
        }

        // Create chat item
        async function createChatItem(chatId, chat) {
            const otherUserId = chat.participants.find(id => id !== currentUser.uid);
            const userRef = database.ref('users/' + otherUserId);
            const userSnapshot = await userRef.once('value');
            const otherUser = userSnapshot.val();
            
            if (!otherUser) return;
            
            const lastMessage = chat.lastMessage || {};
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item p-4 cursor-pointer border-b border-gray-100 hover:bg-gray-50';
            chatItem.onclick = () => openChat(chatId, otherUser);
            
            chatItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${otherUser.profilePic}" class="w-12 h-12 rounded-full" alt="${otherUser.name}">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-gray-900 truncate">${otherUser.name}</h4>
                            <span class="text-xs text-gray-500">${formatTime(lastMessage.timestamp)}</span>
                        </div>
                        <p class="text-sm text-gray-600 truncate">${lastMessage.text || 'No messages yet'}</p>
                    </div>
                    ${chat.unreadCount ? `<div class="w-5 h-5 bg-purple-500 text-white text-xs rounded-full flex items-center justify-center">${chat.unreadCount}</div>` : ''}
                </div>
            `;
            
            document.getElementById('chatList').appendChild(chatItem);
        }

        // Open chat
        function openChat(chatId, otherUser) {
            currentChatId = chatId;
            currentChatUser = otherUser;
            
            // Update UI
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('messagesArea').classList.remove('hidden');
            document.getElementById('messageInput').classList.remove('hidden');
            
            // Update chat header
            document.getElementById('chatAvatar').src = otherUser.profilePic;
            document.getElementById('chatName').textContent = otherUser.name;
            document.getElementById('chatStatus').textContent = otherUser.status === 'Online' ? 'Online' : `Last seen ${formatTime(otherUser.lastSeen)}`;
            
            // Close mobile menu when opening chat on mobile
            if (window.innerWidth < 768) {
                closeMobileMenu();
            }
            
            // Load messages
            loadMessages(chatId);
        }

        // Load messages
        function loadMessages(chatId) {
            const messagesRef = database.ref('chats/' + chatId + '/messages');
            messagesRef.on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                const messagesList = document.getElementById('messagesList');
                messagesList.innerHTML = '';
                
                Object.keys(messages).sort((a, b) => messages[a].timestamp - messages[b].timestamp).forEach(messageId => {
                    const message = messages[messageId];
                    createMessageBubble(message);
                });
                
                // Scroll to bottom
                messagesList.scrollTop = messagesList.scrollHeight;
            });
        }

        // Create message bubble
        function createMessageBubble(message) {
            const messageDiv = document.createElement('div');
            const isOwn = message.sender === currentUser.uid;
            
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'}`;
            
            let content = '';
            
            if (message.type === 'image') {
                content = `
                    <div class="mb-2">
                        <img src="${message.fileUrl}" alt="${message.fileName}" class="max-w-xs rounded-lg cursor-pointer" onclick="window.open('${message.fileUrl}', '_blank')">
                    </div>
                    <p class="text-sm">${message.fileName}</p>
                `;
            } else if (message.type === 'video') {
                content = `
                    <div class="mb-2">
                        <video controls class="max-w-xs rounded-lg">
                            <source src="${message.fileUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <p class="text-sm">${message.fileName}</p>
                `;
            } else if (message.type === 'audio') {
                content = `
                    <div class="mb-2">
                        <audio controls class="w-full">
                            <source src="${message.fileUrl}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                    <p class="text-sm">${message.fileName}</p>
                `;
            } else if (message.type === 'file') {
                const fileSize = message.fileSize ? (message.fileSize / 1024 / 1024).toFixed(2) + ' MB' : '';
                content = `
                    <div class="flex items-center space-x-3 p-2 bg-gray-100 rounded-lg mb-2">
                        <svg class="w-8 h-8 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${message.fileName}</p>
                            <p class="text-xs text-gray-500">${fileSize}</p>
                        </div>
                        <button onclick="window.open('${message.fileUrl}', '_blank')" class="text-blue-500 hover:text-blue-700">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;
            } else if (message.type === 'uploading') {
                content = `
                    <div class="flex items-center space-x-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-current"></div>
                        <p class="text-sm">${message.text}</p>
                    </div>
                `;
            } else if (message.type === 'error') {
                content = `<p class="text-sm text-red-500">${message.text}</p>`;
            } else {
                content = `<p class="text-sm">${message.text}</p>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${isOwn ? 'bg-purple-500 text-white' : 'bg-white text-gray-800'} px-4 py-2 rounded-2xl ios-shadow">
                    ${content}
                    <div class="flex items-center justify-end space-x-1 mt-1">
                        <span class="text-xs ${isOwn ? 'text-purple-200' : 'text-gray-500'}">${formatTime(message.timestamp)}</span>
                        ${isOwn ? `<span class="text-xs ${message.seen ? 'text-blue-300' : 'text-purple-200'}">âœ“âœ“</span>` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('messagesList').appendChild(messageDiv);
        }

        // Send message
        async function sendMessage() {
            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText || !currentChatId) return;
            
            const messageId = database.ref().child('chats').child(currentChatId).child('messages').push().key;
            const message = {
                sender: currentUser.uid,
                text: messageText,
                timestamp: Date.now(),
                type: 'text',
                seen: false
            };
            
            // Send message
            await database.ref('chats/' + currentChatId + '/messages/' + messageId).set(message);
            
            // Update last message
            await database.ref('chats/' + currentChatId + '/lastMessage').set(message);
            
            // Clear input
            document.getElementById('messageText').value = '';
        }

        // Handle message key press
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // New chat functions
        function showNewChatModal() {
            document.getElementById('newChatModal').classList.remove('hidden');
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.add('hidden');
            document.getElementById('newChatEmail').value = '';
        }

        async function startNewChat() {
            const email = document.getElementById('newChatEmail').value.trim();
            if (!email) return;
            
            // Find user by email
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('email').equalTo(email).once('value');
            const users = snapshot.val();
            
            if (!users) {
                alert('User not found');
                return;
            }
            
            const otherUserId = Object.keys(users)[0];
            const otherUser = users[otherUserId];
            
            // Create chat
            const chatId = [currentUser.uid, otherUserId].sort().join('_');
            await database.ref('chats/' + chatId).set({
                participants: [currentUser.uid, otherUserId],
                createdAt: Date.now(),
                lastMessage: {
                    text: '',
                    timestamp: Date.now()
                }
            });
            
            closeNewChatModal();
            openChat(chatId, otherUser);
        }

        // Utility functions
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString();
            }
        }

        // Settings functionality
        function showSettings() {
            const settingsModal = document.createElement('div');
            settingsModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            settingsModal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 w-96 max-w-full mx-4 ios-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Settings</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" id="settingsName" value="${currentUser ? document.getElementById('userName').textContent : ''}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status Message</label>
                            <input type="text" id="settingsStatus" value="${currentUser ? document.getElementById('userStatus').textContent : ''}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
                            <select id="themeSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notificationsToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button onclick="saveSettings()" class="flex-1 instagram-gradient text-white py-2 rounded-lg font-medium hover:opacity-90">
                            Save Changes
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(settingsModal);
        }

        async function saveSettings() {
            if (!currentUser) return;
            
            const name = document.getElementById('settingsName').value;
            const status = document.getElementById('settingsStatus').value;
            
            try {
                await database.ref('users/' + currentUser.uid).update({
                    name: name,
                    customStatus: status
                });
                
                // Update UI
                document.getElementById('userName').textContent = name;
                document.getElementById('userStatus').textContent = status;
                
                // Close modal
                document.querySelector('.fixed').remove();
                
                alert('Settings saved successfully!');
            } catch (error) {
                alert('Failed to save settings: ' + error.message);
            }
        }

        function showEmojiPicker() {
            const emojiModal = document.createElement('div');
            emojiModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            emojiModal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 w-80 max-w-full mx-4 ios-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Choose Emoji</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-8 gap-2 max-h-60 overflow-y-auto">
                        ${['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'â˜ºï¸', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ¥¸', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´', 'ğŸ“³', 'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸', 'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'ğŸš·', 'ğŸš¯', 'ğŸš³', 'ğŸš±', 'ğŸ”', 'ğŸ“µ', 'ğŸš­', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ğŸ”…', 'ğŸ”†', 'ã€½ï¸', 'âš ï¸', 'ğŸš¸', 'ğŸ”±', 'âšœï¸', 'ğŸ”°', 'â™»ï¸', 'âœ…', 'ğŸˆ¯', 'ğŸ’¹', 'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸŒ', 'ğŸ’ ', 'â“‚ï¸', 'ğŸŒ€', 'ğŸ’¤', 'ğŸ§', 'ğŸš¾', 'â™¿', 'ğŸ…¿ï¸', 'ğŸˆ³', 'ğŸˆ‚ï¸', 'ğŸ›‚', 'ğŸ›ƒ', 'ğŸ›„', 'ğŸ›…', 'ğŸš¹', 'ğŸšº', 'ğŸš¼', 'ğŸš»', 'ğŸš®', 'ğŸ¦', 'ğŸ“¶', 'ğŸˆ', 'ğŸ”£', 'â„¹ï¸', 'ğŸ”¤', 'ğŸ”¡', 'ğŸ” ', 'ğŸ†–', 'ğŸ†—', 'ğŸ†™', 'ğŸ†’', 'ğŸ†•', 'ğŸ†“', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ', 'ğŸ”¢', '#ï¸âƒ£', '*ï¸âƒ£', 'âï¸', 'â–¶ï¸', 'â¸ï¸', 'â¯ï¸', 'â¹ï¸', 'âºï¸', 'â­ï¸', 'â®ï¸', 'â©', 'âª', 'â«', 'â¬', 'â—€ï¸', 'ğŸ”¼', 'ğŸ”½', 'â¡ï¸', 'â¬…ï¸', 'â¬†ï¸', 'â¬‡ï¸', 'â†—ï¸', 'â†˜ï¸', 'â†™ï¸', 'â†–ï¸', 'â†•ï¸', 'â†”ï¸', 'â†ªï¸', 'â†©ï¸', 'â¤´ï¸', 'â¤µï¸', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚', 'ğŸ”„', 'ğŸ”ƒ', 'ğŸµ', 'ğŸ¶', 'â•', 'â–', 'â—', 'âœ–ï¸', 'â™¾ï¸', 'ğŸ’²', 'ğŸ’±', 'â„¢ï¸', 'Â©ï¸', 'Â®ï¸', 'ã€°ï¸', 'â°', 'â¿', 'ğŸ”š', 'ğŸ”™', 'ğŸ”›', 'ğŸ”', 'ğŸ”œ', 'âœ”ï¸', 'â˜‘ï¸', 'ğŸ”˜', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'âš«', 'âšª', 'ğŸŸ¤', 'ğŸ”º', 'ğŸ”»', 'ğŸ”¸', 'ğŸ”¹', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”³', 'ğŸ”²', 'â–ªï¸', 'â–«ï¸', 'â—¾', 'â—½', 'â—¼ï¸', 'â—»ï¸', 'ğŸŸ¥', 'ğŸŸ§', 'ğŸŸ¨', 'ğŸŸ©', 'ğŸŸ¦', 'ğŸŸª', 'â¬›', 'â¬œ', 'ğŸŸ«', 'ğŸ”ˆ', 'ğŸ”‡', 'ğŸ”‰', 'ğŸ”Š', 'ğŸ””', 'ğŸ”•', 'ğŸ“£', 'ğŸ“¢', 'ğŸ‘ï¸â€ğŸ—¨ï¸', 'ğŸ’¬', 'ğŸ’­', 'ğŸ—¯ï¸', 'â™ ï¸', 'â™£ï¸', 'â™¥ï¸', 'â™¦ï¸', 'ğŸƒ', 'ğŸ´', 'ğŸ€„', 'ğŸ•', 'ğŸ•‘', 'ğŸ•’', 'ğŸ•“', 'ğŸ•”', 'ğŸ••', 'ğŸ•–', 'ğŸ•—', 'ğŸ•˜', 'ğŸ•™', 'ğŸ•š', 'ğŸ•›', 'ğŸ•œ', 'ğŸ•', 'ğŸ•', 'ğŸ•Ÿ', 'ğŸ• ', 'ğŸ•¡', 'ğŸ•¢', 'ğŸ•£', 'ğŸ•¤', 'ğŸ•¥', 'ğŸ•¦', 'ğŸ•§'].map(emoji => 
                            `<button onclick="addEmoji('${emoji}')" class="text-2xl hover:bg-gray-100 rounded p-1 transition-colors">${emoji}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(emojiModal);
        }

        function addEmoji(emoji) {
            const messageInput = document.getElementById('messageText');
            messageInput.value += emoji;
            messageInput.focus();
            document.querySelector('.fixed').remove();
        }

        function attachFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            fileInput.multiple = true;
            
            fileInput.onchange = async function(event) {
                const files = event.target.files;
                if (!files.length || !currentChatId) return;
                
                for (let file of files) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                        continue;
                    }
                    
                    try {
                        // Show uploading message
                        const messageId = database.ref().child('chats').child(currentChatId).child('messages').push().key;
                        const uploadingMessage = {
                            sender: currentUser.uid,
                            text: `Uploading ${file.name}...`,
                            timestamp: Date.now(),
                            type: 'uploading',
                            seen: false
                        };
                        
                        await database.ref('chats/' + currentChatId + '/messages/' + messageId).set(uploadingMessage);
                        
                        // Upload file to Firebase Storage
                        const storageRef = storage.ref('attachments/' + currentUser.uid + '/' + Date.now() + '_' + file.name);
                        const uploadTask = storageRef.put(file);
                        
                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                // Progress tracking could be added here
                            },
                            (error) => {
                                console.error('Upload failed:', error);
                                // Update message to show error
                                database.ref('chats/' + currentChatId + '/messages/' + messageId).update({
                                    text: `Failed to upload ${file.name}`,
                                    type: 'error'
                                });
                            },
                            async () => {
                                // Upload completed successfully
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Update message with file info
                                const fileMessage = {
                                    sender: currentUser.uid,
                                    text: file.name,
                                    timestamp: Date.now(),
                                    type: file.type.startsWith('image/') ? 'image' : 
                                          file.type.startsWith('video/') ? 'video' :
                                          file.type.startsWith('audio/') ? 'audio' : 'file',
                                    fileUrl: downloadURL,
                                    fileName: file.name,
                                    fileSize: file.size,
                                    seen: false
                                };
                                
                                await database.ref('chats/' + currentChatId + '/messages/' + messageId).set(fileMessage);
                                await database.ref('chats/' + currentChatId + '/lastMessage').set(fileMessage);
                            }
                        );
                        
                    } catch (error) {
                        console.error('Error uploading file:', error);
                        alert('Failed to upload file: ' + error.message);
                    }
                }
            };
            
            fileInput.click();
        }

        function startVideoCall() {
            if (!currentChatUser) return;
            
            const callModal = document.createElement('div');
            callModal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
            callModal.innerHTML = `
                <div class="text-center text-white">
                    <div class="w-32 h-32 mx-auto mb-6 rounded-full overflow-hidden">
                        <img src="${currentChatUser.profilePic}" class="w-full h-full object-cover" alt="${currentChatUser.name}">
                    </div>
                    <h3 class="text-2xl font-bold mb-2">${currentChatUser.name}</h3>
                    <p class="text-lg mb-8">Video calling...</p>
                    <div class="flex justify-center space-x-6">
                        <button onclick="endCall()" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-full">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                            </svg>
                        </button>
                        <button onclick="toggleMute()" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.793L4.617 14H2a1 1 0 01-1-1V7a1 1 0 011-1h2.617l3.766-2.793a1 1 0 011.617.793z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <button onclick="toggleCamera()" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(callModal);
            
            // Simulate call duration
            setTimeout(() => {
                if (document.body.contains(callModal)) {
                    endCall();
                }
            }, 30000); // Auto end after 30 seconds for demo
        }

        function startVoiceCall() {
            if (!currentChatUser) return;
            
            const callModal = document.createElement('div');
            callModal.className = 'fixed inset-0 bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center z-50';
            callModal.innerHTML = `
                <div class="text-center text-white">
                    <div class="w-40 h-40 mx-auto mb-6 rounded-full overflow-hidden border-4 border-white">
                        <img src="${currentChatUser.profilePic}" class="w-full h-full object-cover" alt="${currentChatUser.name}">
                    </div>
                    <h3 class="text-3xl font-bold mb-2">${currentChatUser.name}</h3>
                    <p class="text-xl mb-2">Voice calling...</p>
                    <p id="callTimer" class="text-lg mb-8 opacity-75">00:00</p>
                    <div class="flex justify-center space-x-8">
                        <button onclick="endCall()" class="bg-red-500 hover:bg-red-600 text-white p-6 rounded-full shadow-lg">
                            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                            </svg>
                        </button>
                        <button onclick="toggleMute()" id="muteBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-6 rounded-full shadow-lg">
                            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <button onclick="toggleSpeaker()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-6 rounded-full shadow-lg">
                            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.793L4.617 14H2a1 1 0 01-1-1V7a1 1 0 011-1h2.617l3.766-2.793a1 1 0 011.617.793zM12 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm4-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(callModal);
            
            // Start call timer
            let seconds = 0;
            const timer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                const timerElement = document.getElementById('callTimer');
                if (timerElement) {
                    timerElement.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            // Store timer reference
            callModal.timer = timer;
            
            // Simulate call duration
            setTimeout(() => {
                if (document.body.contains(callModal)) {
                    endCall();
                }
            }, 60000); // Auto end after 1 minute for demo
        }

        function endCall() {
            const callModal = document.querySelector('.fixed.inset-0.bg-black, .fixed.inset-0.bg-gradient-to-br');
            if (callModal) {
                if (callModal.timer) {
                    clearInterval(callModal.timer);
                }
                callModal.remove();
            }
        }

        function toggleMute() {
            const muteBtn = document.getElementById('muteBtn');
            if (muteBtn) {
                muteBtn.classList.toggle('bg-red-500');
                muteBtn.classList.toggle('bg-white');
            }
        }

        function toggleCamera() {
            // Camera toggle functionality for video calls
            alert('Camera toggled');
        }

        function toggleSpeaker() {
            // Speaker toggle functionality for voice calls
            alert('Speaker toggled');
        }

        function showChatInfo() {
            if (!currentChatUser) return;
            
            const infoModal = document.createElement('div');
            infoModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            infoModal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 w-96 max-w-full mx-4 ios-shadow max-h-96 overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Chat Info</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-center mb-6">
                        <img src="${currentChatUser.profilePic}" class="w-24 h-24 rounded-full mx-auto mb-4" alt="${currentChatUser.name}">
                        <h4 class="text-xl font-semibold text-gray-800">${currentChatUser.name}</h4>
                        <p class="text-gray-600">${currentChatUser.email || 'No email available'}</p>
                        <p class="text-sm text-gray-500 mt-2">${currentChatUser.customStatus || 'No status'}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">Status</span>
                            <span class="text-sm ${currentChatUser.status === 'Online' ? 'text-green-600' : 'text-gray-500'}">${currentChatUser.status || 'Offline'}</span>
                        </div>
                        
                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">Last Seen</span>
                            <span class="text-sm text-gray-500">${currentChatUser.lastSeen ? formatTime(currentChatUser.lastSeen) : 'Unknown'}</span>
                        </div>
                        
                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">Account Type</span>
                            <span class="text-sm text-gray-500 capitalize">${currentChatUser.accountType || 'Personal'}</span>
                        </div>
                        
                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">Joined</span>
                            <span class="text-sm text-gray-500">${currentChatUser.createdAt ? new Date(currentChatUser.createdAt).toLocaleDateString() : 'Unknown'}</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 space-y-3">
                        <button onclick="blockUser()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-medium">
                            Block User
                        </button>
                        <button onclick="clearChat()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                            Clear Chat History
                        </button>
                        <button onclick="exportChat()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium">
                            Export Chat
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(infoModal);
        }

        function blockUser() {
            if (confirm(`Are you sure you want to block ${currentChatUser.name}?`)) {
                // In a real app, you would implement blocking logic here
                alert(`${currentChatUser.name} has been blocked.`);
                document.querySelector('.fixed').remove();
            }
        }

        async function clearChat() {
            if (confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                try {
                    await database.ref('chats/' + currentChatId + '/messages').remove();
                    await database.ref('chats/' + currentChatId + '/lastMessage').set({
                        text: '',
                        timestamp: Date.now()
                    });
                    alert('Chat history cleared successfully.');
                    document.querySelector('.fixed').remove();
                } catch (error) {
                    alert('Failed to clear chat: ' + error.message);
                }
            }
        }

        async function exportChat() {
            try {
                const messagesRef = database.ref('chats/' + currentChatId + '/messages');
                const snapshot = await messagesRef.once('value');
                const messages = snapshot.val() || {};
                
                let chatText = `Chat Export - ${currentChatUser.name}\n`;
                chatText += `Exported on: ${new Date().toLocaleString()}\n\n`;
                
                Object.keys(messages).sort((a, b) => messages[a].timestamp - messages[b].timestamp).forEach(messageId => {
                    const message = messages[messageId];
                    const sender = message.sender === currentUser.uid ? 'You' : currentChatUser.name;
                    const time = new Date(message.timestamp).toLocaleString();
                    chatText += `[${time}] ${sender}: ${message.text}\n`;
                });
                
                // Create and download file
                const blob = new Blob([chatText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat_${currentChatUser.name}_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Chat exported successfully!');
                document.querySelector('.fixed').remove();
            } catch (error) {
                alert('Failed to export chat: ' + error.message);
            }
        }

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            isMobileMenuOpen = !isMobileMenuOpen;
            
            if (isMobileMenuOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
            }
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            isMobileMenuOpen = false;
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            if (window.innerWidth < 768 && isMobileMenuOpen && 
                !sidebar.contains(event.target) && 
                !menuBtn.contains(event.target)) {
                closeMobileMenu();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // App is ready
            console.log('Pulse Chat App initialized');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'970f921c64a94454',t:'MTc1NTUwMDgxMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
