<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forbiary - Professional Knowledge Platform</title>
    <meta name="description" content="Forbiary is a collaborative knowledge-sharing platform where users can create, edit, and moderate articles on various topics with professional moderation system.">
    <meta name="keywords" content="knowledge sharing, articles, collaboration, education, research, moderation">
    <link rel="canonical" href="https://forbiary.com/">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Forbiary - Professional Knowledge Platform">
    <meta property="og:description" content="Collaborative knowledge-sharing platform with professional moderation system">
    <meta property="og:url" content="https://forbiary.com/">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://forbiary.com/og-image.jpg">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Forbiary - Professional Knowledge Platform">
    <meta name="twitter:description" content="Collaborative knowledge-sharing platform with professional moderation system">
    <meta name="twitter:image" content="https://forbiary.com/og-image.jpg">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Forbiary",
        "description": "Collaborative knowledge-sharing platform",
        "url": "https://forbiary.com/",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://forbiary.com/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Lato, Helvetica, Arial, sans-serif;
            background: #f6f6f6;
            margin: 0;
            padding: 0;
        }
        
        .wiki-header {
            background: #fff;
            border-bottom: 1px solid #a2a9b1;
            padding: 0;
        }
        
        .wiki-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #a2a9b1;
            padding: 8px 0;
        }
        
        .wiki-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .wiki-logo {
            font-size: 20px;
            font-weight: bold;
            color: #0645ad;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .wiki-search {
            flex: 1;
            max-width: 400px;
            margin: 0 15px;
            min-width: 200px;
        }
        
        .wiki-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .wiki-nav-links {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .wiki-nav-links a {
            color: #0645ad;
            text-decoration: none;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 2px;
            white-space: nowrap;
        }
        
        .wiki-nav-links a:hover {
            background: #eaecf0;
        }
        
        .wiki-content {
            background: #fff;
            margin: 15px auto;
            padding: 15px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            max-width: 1200px;
        }
        
        .wiki-article {
            line-height: 1.6;
            color: #222;
        }
        
        .wiki-article h1 {
            font-size: 28px;
            font-weight: normal;
            border-bottom: 3px solid #a2a9b1;
            padding-bottom: 8px;
            margin-bottom: 20px;
            color: #000;
        }
        
        .wiki-article h2 {
            font-size: 22px;
            font-weight: normal;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 4px;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        .wiki-article h3 {
            font-size: 18px;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        
        .wiki-infobox {
            width: 100%;
            max-width: 300px;
            margin: 0 0 20px 0;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .wiki-toc {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin: 20px 0;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        
        .wiki-edit-btn {
            background: #0645ad;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .wiki-edit-btn:hover {
            background: #0b0080;
        }
        
        .wiki-tabs {
            border-bottom: 1px solid #a2a9b1;
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .wiki-tab {
            display: inline-block;
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-bottom: none;
            cursor: pointer;
            margin-right: 2px;
            min-width: 120px;
            text-align: center;
        }
        
        .wiki-tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
        }
        
        .wiki-sidebar {
            width: 100%;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .wiki-main-content {
            width: 100%;
        }
        
        .edit-summary {
            width: 100%;
            padding: 8px;
            border: 1px solid #a2a9b1;
            margin: 10px 0;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .CodeMirror {
            border: 1px solid #a2a9b1;
            height: 300px;
        }
        
        .ql-editor {
            min-height: 300px;
            border: 1px solid #a2a9b1;
        }
        
        .pending-edit {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .moderator-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .edit-history {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            border-top: 1px solid #a2a9b1;
            padding-top: 15px;
        }
        
        .diff-added {
            background: #d4edda;
            color: #155724;
        }
        
        .diff-removed {
            background: #f8d7da;
            color: #721c24;
        }

        .category-card:hover > div {
            background: #eaecf0 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-left {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .mobile-menu {
            display: block;
            background: #0645ad;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 16px;
        }

        .nav-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border-top: 1px solid #a2a9b1;
            z-index: 1000;
        }

        .nav-dropdown.show {
            display: block;
        }

        .nav-dropdown .wiki-nav-links {
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 10px;
        }

        .nav-dropdown .wiki-nav-links a {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin: 20px 0;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 8px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
        }

        .search-select {
            padding: 8px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            min-width: 120px;
        }

        .internal-link {
            color: #0645ad;
            text-decoration: none;
            border-bottom: 1px dotted #0645ad;
        }

        .internal-link:hover {
            background: #f0f8ff;
        }

        .related-articles {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0645ad;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Desktop navigation styles */
        @media (min-width: 769px) {
            .mobile-menu {
                display: none;
            }
            
            .nav-dropdown {
                display: none !important;
            }
            
            #desktopNavLinks {
                display: flex;
            }
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #desktopNavLinks {
                display: none;
            }
            .wiki-container {
                padding: 0 10px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
            }

            .wiki-search {
                margin: 0;
                max-width: none;
                width: 100%;
            }

            .header-right {
                width: 100%;
                justify-content: center;
            }

            .mobile-menu {
                display: block;
            }

            .wiki-nav-links {
                display: none;
            }

            .wiki-nav {
                position: relative;
            }

            .wiki-content {
                margin: 10px;
                padding: 10px;
            }

            .wiki-article h1 {
                font-size: 24px;
            }

            .wiki-article h2 {
                font-size: 20px;
            }

            .wiki-article h3 {
                font-size: 16px;
            }

            .wiki-sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
                float: none;
            }

            .wiki-main-content {
                margin-left: 0;
            }

            .wiki-infobox {
                float: none;
                width: 100%;
                margin: 0 0 20px 0;
            }

            .wiki-toc {
                width: 100%;
                box-sizing: border-box;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-actions {
                justify-content: stretch;
            }

            .form-actions button {
                flex: 1;
                min-width: 0;
            }

            .edit-actions {
                justify-content: stretch;
            }

            .edit-actions button {
                flex: 1;
                min-width: 0;
            }

            .search-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: 0;
                width: 100%;
            }

            .search-select {
                min-width: 0;
                width: 100%;
            }

            .user-info {
                justify-content: center;
                text-align: center;
            }

            .user-info img {
                width: 28px !important;
                height: 28px !important;
            }

            .user-info span {
                font-size: 13px;
            }

            .CodeMirror {
                height: 250px;
            }

            .ql-editor {
                min-height: 250px;
            }

            .pending-edit {
                padding: 10px;
            }

            .article-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .wiki-edit-btn {
                margin: 2px;
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        /* Tablet Styles */
        @media (min-width: 769px) and (max-width: 1024px) {
            .wiki-container {
                padding: 0 15px;
            }

            .wiki-content {
                margin: 15px;
                padding: 15px;
            }

            .wiki-sidebar {
                width: 180px;
                padding: 12px;
            }

            .wiki-main-content {
                margin-left: 210px;
            }

            .wiki-infobox {
                width: 250px;
                margin: 0 0 15px 15px;
            }

            .form-grid {
                gap: 15px;
            }

            .search-input {
                min-width: 200px;
            }
        }

        /* Desktop Styles */
        @media (min-width: 1025px) {
            .wiki-container {
                padding: 0 20px;
            }

            .wiki-content {
                margin: 20px auto;
                padding: 20px;
            }

            .wiki-sidebar {
                width: 200px;
                padding: 15px;
                margin-right: 20px;
                float: left;
            }

            .wiki-main-content {
                margin-left: 240px;
            }

            .wiki-infobox {
                float: right;
                width: 300px;
                margin: 0 0 20px 20px;
            }

            .CodeMirror {
                height: 400px;
            }

            .ql-editor {
                min-height: 400px;
            }
        }

        /* Large Desktop Styles */
        @media (min-width: 1200px) {
            .wiki-article h1 {
                font-size: 32px;
            }

            .wiki-article h2 {
                font-size: 24px;
            }

            .wiki-article h3 {
                font-size: 20px;
            }
        }

        /* Profile Page Styles */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .profile-stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        /* Print Styles */
        @media print {
            .wiki-header,
            .wiki-nav,
            .wiki-sidebar,
            .wiki-edit-btn,
            .form-actions,
            .edit-actions {
                display: none !important;
            }

            .wiki-content {
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }

            .wiki-main-content {
                margin-left: 0;
            }

            body {
                background: white;
            }
        }
        /* Internal Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            width: 100%;
        }

        .notification {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #007bff;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            position: relative;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #28a745;
        }

        .notification.error {
            border-left-color: #dc3545;
        }

        .notification.warning {
            border-left-color: #ffc107;
        }

        .notification.info {
            border-left-color: #17a2b8;
        }

        .notification-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            color: #333;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
            font-size: 14px;
        }

        .notification-message {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            margin-right: 20px;
        }

        @media (max-width: 768px) {
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Internal Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
    <!-- Wikipedia-style Header -->
    <header class="wiki-header">
        <div class="wiki-container">
            <div class="header-content">
                <div class="header-left">
                    <a href="#" onclick="showHome()" class="wiki-logo">
                        <i class="fas fa-book-open" style="margin-right: 8px;"></i>Forbiary
                    </a>
                </div>
                <div class="wiki-search">
                    <input type="text" id="mainSearchInput" placeholder="Search Forbiary..." onkeypress="if(event.key==='Enter') searchFromHeader()">
                </div>
                <div class="header-right">
                    <div id="userInfoDesktop" style="display:none;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img id="userPhotoDesktop" style="width: 32px; height: 32px; border-radius: 50%; cursor: pointer;" src="" alt="" onclick="showProfile()" title="View Profile">
                            <span id="userNameDesktop" style="font-size: 14px; color: #0645ad; cursor: pointer; text-decoration: underline;" onclick="showProfile()" title="View Profile"></span>
                            <span id="moderatorBadgeDesktop" class="moderator-badge" style="display:none;">Moderator</span>
                            <button onclick="signOut()" style="color: #d33; font-size: 14px; background: none; border: none; cursor: pointer; padding: 4px 8px; margin-left: 8px;">Sign Out</button>
                        </div>
                    </div>
                    <button onclick="signInWithGoogle()" id="loginBtnDesktop" class="wiki-edit-btn">
                        <i class="fab fa-google" style="margin-right: 5px;"></i>Sign In
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Wikipedia-style Navigation -->
    <nav class="wiki-nav">
        <div class="wiki-container">
            <button class="mobile-menu" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i> Menu
            </button>
            <div class="wiki-nav-links" id="desktopNavLinks">
                <a href="#" onclick="showHome()">Main page</a>
                <a href="#" onclick="showSearch()">Browse articles</a>
                <a href="#" onclick="showWrite()">Create article</a>
                <a href="#" onclick="showBecomeModerator()">Become moderator</a>
                <a href="#" onclick="showCategories()">Categories</a>
                <a href="#" onclick="showMyDrafts()" id="userSectionDesktop" style="display:none;">My Drafts</a>
                <a href="#" onclick="showProfile()" id="profileSectionDesktop" style="display:none;">My Profile</a>
                <a href="#" onclick="showModerate()" id="moderatorSectionDesktop1" style="display:none; color: #28a745;">Moderate Articles</a>
                <a href="#" onclick="showPendingEdits()" id="moderatorSectionDesktop2" style="display:none; color: #28a745;">Pending Edits</a>
            </div>
            <div class="nav-dropdown" id="mobileNavDropdown">
                <div class="wiki-nav-links">
                    <a href="#" onclick="showHome(); closeMobileMenu()">Main page</a>
                    <a href="#" onclick="showSearch(); closeMobileMenu()">Browse articles</a>
                    <a href="#" onclick="showWrite(); closeMobileMenu()">Create article</a>
                    <a href="#" onclick="showBecomeModerator(); closeMobileMenu()">Become moderator</a>
                    <a href="#" onclick="showCategories(); closeMobileMenu()">Categories</a>
                    <div style="border-top: 1px solid #ddd; margin: 10px 0; padding-top: 10px;" id="userSection" style="display:none;">
                        <a href="#" onclick="showMyDrafts(); closeMobileMenu()">My Drafts</a>
                        <a href="#" onclick="showProfile(); closeMobileMenu()">My Profile</a>
                    </div>
                    <div style="border-top: 1px solid #ddd; margin: 10px 0; padding-top: 10px;" id="moderatorSection" style="display:none;">
                        <a href="#" onclick="showModerate(); closeMobileMenu()" style="color: #28a745;">Moderate Articles</a>
                        <a href="#" onclick="showPendingEdits(); closeMobileMenu()" style="color: #28a745;">Pending Edits</a>
                    </div>
                    <div style="border-top: 1px solid #ddd; margin: 10px 0; padding-top: 10px;">
                        <div id="userInfoMobile" style="display:none; padding: 8px 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <img id="userPhotoMobile" style="width: 24px; height: 24px; border-radius: 50%; cursor: pointer;" src="" alt="" onclick="showProfile(); closeMobileMenu()" title="View Profile">
                                <span id="userNameMobile" style="font-size: 14px; color: #0645ad; cursor: pointer; text-decoration: underline;" onclick="showProfile(); closeMobileMenu()" title="View Profile"></span>
                                <span id="moderatorBadgeMobile" class="moderator-badge" style="display:none;">Moderator</span>
                            </div>
                            <button onclick="signOut(); closeMobileMenu()" style="color: #d33; font-size: 14px; background: none; border: none; cursor: pointer; padding: 4px 0;">Sign Out</button>
                        </div>
                        <a href="#" onclick="signInWithGoogle(); closeMobileMenu()" id="loginBtnMobile">
                            <i class="fab fa-google" style="margin-right: 5px;"></i>Sign In
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Home Page -->
        <div id="homePage">
            <div class="wiki-content">
                <div class="wiki-sidebar">
                    <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #a2a9b1; padding-bottom: 5px;">Navigation</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showHome()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Main page</a></li>
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showSearch()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Browse articles</a></li>
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showWrite()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Create article</a></li>
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showBecomeModerator()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Become moderator</a></li>
                    </ul>
                    
                    <h3 style="font-size: 16px; font-weight: bold; margin: 20px 0 15px 0; border-bottom: 1px solid #a2a9b1; padding-bottom: 5px;">Categories</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Technology')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Technology</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Business')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Business</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Science')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Science</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('History')" style="color: #0645ad; text-decoration: none; font-size: 13px;">History</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Health')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Health</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Education')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Education</a></li>
                    </ul>
                </div>
                
                <div class="wiki-main-content">
                    <div class="wiki-article">
                        <h1>Welcome to Forbiary</h1>
                        <p><strong>Forbiary</strong> is a collaborative knowledge-sharing platform where users can create, edit, and moderate articles on various topics. Anyone can contribute and become a moderator to help maintain quality content.</p>
                        
                        <div class="wiki-toc">
                            <strong>Contents</strong>
                            <ol style="margin: 10px 0 0 20px;">
                                <li><a href="#getting-started" style="color: #0645ad; text-decoration: none;">Getting Started</a></li>
                                <li><a href="#recent-articles" style="color: #0645ad; text-decoration: none;">Recent Articles</a></li>
                                <li><a href="#how-to-contribute" style="color: #0645ad; text-decoration: none;">How to Contribute</a></li>
                                <li><a href="#moderation" style="color: #0645ad; text-decoration: none;">Moderation System</a></li>
                            </ol>
                        </div>
                        
                        <h2 id="getting-started">Getting Started</h2>
                        <p>To start contributing to Forbiary, you need to sign in with your Google account. Once signed in, you can:</p>
                        <ul>
                            <li>Create new articles on any topic</li>
                            <li>Edit existing articles to improve them</li>
                            <li>Apply to become a moderator</li>
                            <li>Review and approve edits from other users</li>
                        </ul>
                        
                        <h2 id="recent-articles">Recent Articles</h2>
                        <div id="recentArticles" style="margin: 20px 0;">
                            <div class="loading-spinner" style="margin: 20px auto; display: block;"></div>
                            <p style="text-align: center; color: #666; margin-top: 10px;">Loading recent articles...</p>
                        </div>
                        
                        <h2 id="how-to-contribute">How to Contribute</h2>
                        <p>Contributing to Forbiary is easy and open to everyone:</p>
                        <ol>
                            <li><strong>Sign in</strong> with your Google account</li>
                            <li><strong>Create</strong> new articles or <strong>edit</strong> existing ones</li>
                            <li><strong>Submit</strong> your changes for review</li>
                            <li><strong>Moderators</strong> will review and approve quality content</li>
                        </ol>
                        
                        <h2 id="moderation">Moderation System</h2>
                        <p>Forbiary uses a community-driven moderation system where any user can apply to become a moderator. Moderators help maintain quality by reviewing article edits and ensuring content meets our standards.</p>
                        
                        <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; margin: 20px 0;">
                            <strong>Quick Actions:</strong><br>
                            <a href="#" onclick="showSearch()" style="color: #0645ad; margin-right: 15px;">Browse Articles</a>
                            <a href="#" onclick="showWrite()" style="color: #0645ad; margin-right: 15px;">Create Article</a>
                            <a href="#" onclick="showBecomeModerator()" style="color: #0645ad;">Become Moderator</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="searchPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Browse Articles</h1>
                    <div class="search-controls">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by title, tags, or content...">
                        <select id="categoryFilter" class="search-select">
                            <option value="">All Categories</option>
                            <option value="Technology">Technology</option>
                            <option value="Business">Business</option>
                            <option value="Science">Science</option>
                            <option value="History">History</option>
                            <option value="Health">Health</option>
                            <option value="Education">Education</option>
                        </select>
                        <button onclick="searchArticles()" class="wiki-edit-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="searchResults">
                        <!-- Search results will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Become Moderator Page -->
        <div id="becomeModeratorPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Become a Moderator</h1>
                    <p>Moderators help maintain the quality of Forbiary by reviewing article edits and ensuring content meets our community standards.</p>
                    
                    <h2>Requirements</h2>
                    <ul>
                        <li>Active Google account</li>
                        <li>Understanding of community guidelines</li>
                        <li>Commitment to fair and unbiased moderation</li>
                    </ul>
                    
                    <h2>Responsibilities</h2>
                    <ul>
                        <li>Review pending article edits</li>
                        <li>Approve or reject changes based on quality</li>
                        <li>Help maintain community standards</li>
                        <li>Assist other users when needed</li>
                    </ul>
                    
                    <div id="moderatorApplication" style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; margin: 20px 0;">
                        <h3>Apply to Become a Moderator</h3>
                        <p>Fill out the form below to become a moderator instantly:</p>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Why do you want to become a moderator?</label>
                            <textarea id="moderatorReason" rows="4" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="Explain why you want to help moderate content on Forbiary..."></textarea>
                        </div>
                        <button onclick="applyForModerator()" class="wiki-edit-btn" style="background: #28a745;">
                            <i class="fas fa-user-shield"></i> Become Moderator
                        </button>
                        <div id="applicationStatus" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Page -->
        <div id="categoriesPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Categories</h1>
                    <p>Browse articles by category to find content that interests you.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div class="category-card" onclick="filterByCategory('Technology')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-microchip" style="margin-right: 8px;"></i>Technology
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Articles about software, hardware, AI, and digital innovations</p>
                                <div id="techCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Business')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-briefcase" style="margin-right: 8px;"></i>Business
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Entrepreneurship, finance, management, and business strategies</p>
                                <div id="businessCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Science')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-flask" style="margin-right: 8px;"></i>Science
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Research, discoveries, and scientific breakthroughs</p>
                                <div id="scienceCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('History')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-landmark" style="margin-right: 8px;"></i>History
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Historical events, figures, and cultural heritage</p>
                                <div id="historyCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Health')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-heartbeat" style="margin-right: 8px;"></i>Health
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Medical research, wellness, and healthcare topics</p>
                                <div id="healthCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Education')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-graduation-cap" style="margin-right: 8px;"></i>Education
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Learning resources, academic research, and educational methods</p>
                                <div id="educationCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Edits Page -->
        <div id="pendingEditsPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Pending Edits</h1>
                    <p>Review and approve edits submitted by community members.</p>
                    <div id="pendingEditsList">
                        <!-- Pending edits will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- User Profile Page -->
        <div id="profilePage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>User Profile</h1>
                    <div id="profileContent">
                        <!-- Profile content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Write/Edit Article Page -->
        <div id="writePage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1 id="writePageTitle">Create New Article</h1>
                    
                    <div class="wiki-tabs">
                        <div class="wiki-tab active" onclick="switchEditMode('visual')" id="visualTab">Visual Editor</div>
                        <div class="wiki-tab" onclick="switchEditMode('code')" id="codeTab">Source Code</div>
                    </div>
                    
                    <form id="articleForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Article Title</label>
                            <input type="text" id="articleTitle" required style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="Enter article title">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Summary</label>
                            <textarea id="articleSummary" required rows="3" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="Brief summary of the article"></textarea>
                        </div>

                        <div class="form-grid">
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Category</label>
                                <select id="articleCategory" required style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px; box-sizing: border-box;">
                                    <option value="">Select Category</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Business">Business</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Health">Health</option>
                                    <option value="Education">Education</option>
                                    <option value="Education">Artist</option>
                                    <option value="Education">Actor</option>
                                    <option value="Education">Entertainment</option>
                                    <option value="Education">Nation</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tags</label>
                                <input type="text" id="articleTags" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px; box-sizing: border-box;" placeholder="Comma-separated tags">
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Featured Image</label>
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 8px;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; font-weight: normal; margin-bottom: 5px; font-size: 14px;">Image URL:</label>
                                    <input type="url" id="imageUrl" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 4px; font-size: 14px;" placeholder="Enter image URL (e.g., https://example.com/image.jpg)">
                                </div>
                                <div id="imagePreview" style="display: none; text-align: center; margin-top: 15px;">
                                    <img id="previewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" alt="Image preview">
                                    <div style="margin-top: 10px;">
                                        <button type="button" onclick="removeImage()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            <i class="fas fa-times"></i> Remove Image
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                    <i class="fas fa-info-circle"></i> <p>
  <a href="https://community.oriontec.xyz/Uploadimage.html" target="_blank" style="color: #007bff; text-decoration: none;">
    Go here and upload your image, copy the URL and paste it here
  </a>
</p>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">References</label>
                            <textarea id="articleReferences" rows="3" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="URLs, books, or other sources (one per line)"></textarea>
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                <i class="fas fa-info-circle"></i> References will be automatically numbered [1], [2], [3]...
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Article Content</label>
                            <div id="visualEditor" style="display: block;">
                                <div id="editor"></div>
                            </div>
                            <div id="codeEditor" style="display: none;">
                                <textarea id="codeTextarea" style="width: 100%; height: 400px; font-family: monospace; padding: 10px; border: 1px solid #a2a9b1;"></textarea>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Edit Summary</label>
                            <input type="text" id="editSummary" class="edit-summary" placeholder="Briefly describe your changes..." style="width: 100%;">
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="showHome()" style="padding: 8px 16px; border: 1px solid #a2a9b1; background: #f8f9fa; border-radius: 2px; cursor: pointer;">Cancel</button>
                            <button type="button" onclick="previewArticle()" style="padding: 8px 16px; border: 1px solid #a2a9b1; background: #f8f9fa; border-radius: 2px; cursor: pointer;">Preview</button>
                            <button type="submit" class="wiki-edit-btn">
                                <i class="fas fa-save"></i> <span id="submitButtonText">Submit for Review</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Moderate Page -->
        <div id="moderatePage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Article Moderation</h1>
                    <p>Review recent articles and suggest improvements or deletions if content is inappropriate or false.</p>
                    
                    <div class="wiki-tabs">
                        <div class="wiki-tab active" onclick="switchModeratorTab('recent')" id="recentTab">Recent Articles</div>
                        <div class="wiki-tab" onclick="switchModeratorTab('notifications')" id="notificationsTab">Notifications <span id="notificationBadge" style="background: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; margin-left: 5px; display: none;"></span></div>
                        <div class="wiki-tab" onclick="switchModeratorTab('suggestions')" id="suggestionsTab">My Suggestions</div>
                    </div>
                    
                    <div id="recentArticlesTab" style="display: block;">
                        <div id="recentArticlesList">
                            <!-- Recent articles will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="notificationsTab" style="display: none;">
                        <div id="moderatorNotifications">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="suggestionsTab" style="display: none;">
                        <div id="moderatorSuggestions">
                            <!-- Moderator suggestions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Article Reader -->
        <div id="articleReader" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <div id="articleContent">
                        <!-- Article content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebase Configuration - Real Firebase Database
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "auth.oriontec.xyz",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:7248a0983dcf0d45a87418",
            measurementId: "G-5RFLRYTLCN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const realtimeDb = firebase.database();

        // Internal Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Information'
            };

            notification.innerHTML = `
                <button class="notification-close" onclick="closeNotification(this)">&times;</button>
                <div class="notification-title">${titles[type] || 'Notification'}</div>
                <div class="notification-message">${message}</div>
            `;

            container.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(notification.querySelector('.notification-close'));
                }, duration);
            }
        }

        function closeNotification(closeBtn) {
            const notification = closeBtn.parentElement;
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 300);
        }

        // Initialize Quill Editor
        let quill;
        
        // Current user and admin status
        let currentUser = null;
        let isAdmin = false;
        let isModerator = false;
        let currentEditingArticleId = null;
        let currentEditMode = 'visual';
        
        // SEO and metadata management
        let siteArticles = new Map(); // Cache for internal linking
        let relatedArticles = new Map(); // Related articles cache

        // Admin emails (you can modify this list)
        const adminEmails = ['customerserviceffrj4@gmail.com', 'admin@forbiary.com', 'moderator@forbiary.com'];

        // Mobile menu functions
        function toggleMobileMenu() {
            const dropdown = document.getElementById('mobileNavDropdown');
            dropdown.classList.toggle('show');
        }

        function closeMobileMenu() {
            const dropdown = document.getElementById('mobileNavDropdown');
            dropdown.classList.remove('show');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('mobileNavDropdown');
            const menuButton = document.querySelector('.mobile-menu');
            
            if (!dropdown.contains(event.target) && !menuButton.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                // Mobile UI
                document.getElementById('loginBtnMobile').style.display = 'none';
                document.getElementById('userInfoMobile').style.display = 'block';
                document.getElementById('userNameMobile').textContent = user.displayName;
                document.getElementById('userPhotoMobile').src = user.photoURL;
                
                // Desktop UI
                document.getElementById('loginBtnDesktop').style.display = 'none';
                document.getElementById('userInfoDesktop').style.display = 'block';
                document.getElementById('userNameDesktop').textContent = user.displayName;
                document.getElementById('userPhotoDesktop').src = user.photoURL;

                // Show user sections
                document.getElementById('userSection').style.display = 'block';
                document.getElementById('userSectionDesktop').style.display = 'inline-block';
                document.getElementById('profileSectionDesktop').style.display = 'inline-block';

                // Check if user is admin or moderator
                isAdmin = adminEmails.includes(user.email);
                await checkModeratorStatus();
                
                if (isAdmin || isModerator) {
                    // Mobile moderator UI
                    document.getElementById('moderatorSection').style.display = 'block';
                    document.getElementById('moderatorBadgeMobile').style.display = 'inline-block';
                    
                    // Desktop moderator UI
                    document.getElementById('moderatorSectionDesktop1').style.display = 'inline-block';
                    document.getElementById('moderatorSectionDesktop2').style.display = 'inline-block';
                    document.getElementById('moderatorBadgeDesktop').style.display = 'inline-block';
                }

                // Initialize editor if on write page
                if (document.getElementById('writePage').style.display !== 'none') {
                    setTimeout(() => initializeEditor(), 100);
                }
            } else {
                currentUser = null;
                isAdmin = false;
                isModerator = false;
                
                // Mobile UI
                document.getElementById('loginBtnMobile').style.display = 'block';
                document.getElementById('userInfoMobile').style.display = 'none';
                document.getElementById('userSection').style.display = 'none';
                document.getElementById('moderatorSection').style.display = 'none';
                document.getElementById('moderatorBadgeMobile').style.display = 'none';
                
                // Desktop UI
                document.getElementById('loginBtnDesktop').style.display = 'block';
                document.getElementById('userInfoDesktop').style.display = 'none';
                document.getElementById('userSectionDesktop').style.display = 'none';
                document.getElementById('profileSectionDesktop').style.display = 'none';
                document.getElementById('moderatorSectionDesktop1').style.display = 'none';
                document.getElementById('moderatorSectionDesktop2').style.display = 'none';
                document.getElementById('moderatorBadgeDesktop').style.display = 'none';
            }
        });

        // Sign in with Google
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                showNotification('🎉 Welcome to Forbiary! You are now signed in.', 'success');
            } catch (error) {
                showNotification('Sign in failed: ' + error.message, 'error');
            }
        }

        // Sign out
        async function signOut() {
            try {
                await auth.signOut();
                showNotification('You have been signed out successfully', 'info');
            } catch (error) {
                showNotification('Sign out failed: ' + error.message, 'error');
            }
        }

        // Navigation functions
        function showHome() {
            hideAllPages();
            document.getElementById('homePage').style.display = 'block';
            loadRecentArticles();
            updatePageMetadata('Forbiary - Professional Knowledge Platform', 'Collaborative knowledge-sharing platform where users can create, edit, and moderate articles on various topics with professional moderation system.');
            window.location.hash = '';
        }

        function showSearch() {
            hideAllPages();
            document.getElementById('searchPage').style.display = 'block';
            loadAllArticles();
            updatePageMetadata('Browse Articles - Forbiary', 'Search and browse all articles on Forbiary knowledge platform.');
        }

        // Show drafts for current user
        function showMyDrafts() {
            if (!currentUser) {
                showNotification('Please sign in to view your drafts', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('searchPage').style.display = 'block';
            document.getElementById('searchPage').querySelector('h1').textContent = 'My Drafts';
            loadUserDrafts();
            updatePageMetadata('My Drafts - Forbiary', 'View your draft articles on Forbiary.');
        }

        // Load user drafts
        async function loadUserDrafts() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('articles')
                    .where('uid', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();

                const container = document.getElementById('searchResults');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No drafts found. <a href="#" onclick="showWrite()" style="color: #0645ad;">Create your first article</a></p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const article = doc.data();
                    const draftCard = createDraftCard(doc.id, article);
                    container.appendChild(draftCard);
                });
            } catch (error) {
                console.error('Error loading drafts:', error);
            }
        }

        // Create draft card
        function createDraftCard(id, article) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-bottom: 15px;';

            const date = article.timestamp ? new Date(article.timestamp.toDate ? article.timestamp.toDate() : article.timestamp).toLocaleDateString() : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">${article.title}</h3>
                        <p style="margin: 0 0 8px 0; color: #666; line-height: 1.4;">${article.summary}</p>
                        <div style="font-size: 14px; color: #666;">
                            <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 8px;">${article.category}</span>
                            <span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 8px;">DRAFT</span>
                            Created ${date}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="showWrite('${id}')" class="wiki-edit-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="viewDraft('${id}')" class="wiki-edit-btn" style="background: #6c757d;">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button onclick="deleteDraft('${id}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // View draft
        async function viewDraft(articleId) {
            try {
                const doc = await db.collection('articles').doc(articleId).get();
                
                if (!doc.exists) {
                    showNotification('Draft not found', 'error');
                    return;
                }

                const article = doc.data();
                
                if (article.status !== 'pending') {
                    showNotification('This is not a draft', 'warning');
                    return;
                }

                // Check if user owns this draft
                if (currentUser && article.uid !== currentUser.uid && !isAdmin && !isModerator) {
                    showNotification('You can only view your own drafts', 'warning');
                    return;
                }

                hideAllPages();
                document.getElementById('articleReader').style.display = 'block';
                
                const date = article.timestamp ? new Date(article.timestamp.toDate ? article.timestamp.toDate() : article.timestamp).toLocaleDateString() : 'Recently';
                const tagsHtml = article.tags.map(tag => 
                    `<span class="inline-block bg-gray-100 text-gray-800 text-sm px-3 py-1 rounded-full mr-2">${tag}</span>`
                ).join('');

                document.getElementById('articleContent').innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #856404;"><i class="fas fa-exclamation-triangle"></i> Draft Preview</h3>
                        <p style="margin: 0; color: #856404;">This article is currently in draft status and pending moderator approval.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div class="article-meta">
                            <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-size: 14px;">${article.category}</span>
                            <span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 3px; font-size: 14px; margin-left: 8px;">DRAFT</span>
                        </div>
                        <h1>${article.title}</h1>
                        <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                            ${date}
                        </div>
                        <p style="font-size: 16px; color: #333; margin-bottom: 20px; font-style: italic;">${article.summary}</p>
                        <div style="margin-bottom: 20px;">${tagsHtml}</div>
                        ${featuredImageHtml}
                    </div>
                    
                    <div style="line-height: 1.6; margin-bottom: 30px;">
                        ${article.content}
                    </div>
                    
                    <div class="edit-actions" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #a2a9b1;">
                        <button onclick="showMyDrafts()" class="wiki-edit-btn">
                            <i class="fas fa-arrow-left"></i> Back to Drafts
                        </button>
                        <button onclick="showWrite('${articleId}')" class="wiki-edit-btn">
                            <i class="fas fa-edit"></i> Edit Draft
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading draft:', error);
                showNotification('Error loading draft', 'error');
            }
        }

        // Delete draft with internal confirmation
        async function deleteDraft(articleId) {
            if (!currentUser) return;
            
            // Create custom confirmation dialog
            const confirmDelete = await showConfirmDialog(
                'Delete Draft', 
                'Are you sure you want to delete this draft? This action cannot be undone.',
                'Delete',
                'Cancel'
            );
            
            if (confirmDelete) {
                try {
                    // Check ownership
                    const doc = await db.collection('articles').doc(articleId).get();
                    if (doc.exists) {
                        const article = doc.data();
                        if (article.uid !== currentUser.uid && !isAdmin && !isModerator) {
                            showNotification('You can only delete your own drafts', 'warning');
                            return;
                        }
                    }

                    // Remove from localStorage
                    localStorage.removeItem(`articles_${articleId}`);
                    
                    // Update collection
                    const collectionData = JSON.parse(localStorage.getItem('collection_articles') || '[]');
                    const updatedCollection = collectionData.filter(item => item.id !== articleId);
                    localStorage.setItem('collection_articles', JSON.stringify(updatedCollection));
                    
                    showNotification('Draft deleted successfully', 'success');
                    loadUserDrafts();
                } catch (error) {
                    showNotification('Error deleting draft: ' + error.message, 'error');
                }
            }
        }

        // Custom confirmation dialog
        function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    border-radius: 8px;
                    padding: 24px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    animation: dialogIn 0.2s ease-out;
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333;">${title}</h3>
                    <p style="margin: 0 0 24px 0; color: #666; line-height: 1.5;">${message}</p>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="cancelBtn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; cursor: pointer;">${cancelText}</button>
                        <button id="confirmBtn" style="padding: 8px 16px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">${confirmText}</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Add animation styles
                const dialogStyle = document.createElement('style');
                dialogStyle.textContent = `
                    @keyframes dialogIn {
                        from { transform: scale(0.9); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(dialogStyle);
                
                // Handle buttons
                dialog.querySelector('#confirmBtn').onclick = () => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(dialogStyle);
                    resolve(true);
                };
                
                dialog.querySelector('#cancelBtn').onclick = () => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(dialogStyle);
                    resolve(false);
                };
                
                // Handle overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        document.head.removeChild(dialogStyle);
                        resolve(false);
                    }
                };
            });
        }

        async function showWrite(articleId = null) {
            if (articleId) {
                // For editing existing articles - check if article is locked
                try {
                    const doc = await db.collection('articles').doc(articleId).get();
                    if (doc.exists && doc.data().locked) {
                        showNotification('This article is locked and cannot be edited', 'warning');
                        showHome();
                        return;
                    }
                } catch (error) {
                    console.error('Error checking article lock status:', error);
                }

                hideAllPages();
                document.getElementById('writePage').style.display = 'block';
                currentEditingArticleId = articleId;
                document.getElementById('writePageTitle').textContent = 'Edit Article';
                document.getElementById('submitButtonText').textContent = 'Submit Edit';
                updatePageMetadata('Edit Article - Forbiary', 'Edit an existing article on Forbiary knowledge platform.');
                
                // Initialize editor first, then load content
                setTimeout(() => {
                    initializeEditor();
                    setupImagePreview();
                    setTimeout(() => loadArticleForEditing(articleId), 300);
                }, 100);
            } else {
                // For creating new articles - check if user is signed in
                if (!currentUser) {
                    showNotification('Please sign in to create articles', 'warning');
                    return;
                }
                
                hideAllPages();
                document.getElementById('writePage').style.display = 'block';
                currentEditingArticleId = null;
                document.getElementById('writePageTitle').textContent = 'Create New Article';
                document.getElementById('submitButtonText').textContent = 'Submit for Review';
                updatePageMetadata('Create Article - Forbiary', 'Create a new article on Forbiary knowledge platform.');
                clearForm();
                setTimeout(() => {
                    initializeEditor();
                    setupImagePreview();
                }, 100);
            }
        }

        function showModerate() {
            if (!currentUser || (!isAdmin && !isModerator)) {
                showNotification('Access denied. Moderator privileges required', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('moderatePage').style.display = 'block';
            loadRecentArticlesForModerators();
            updatePageMetadata('Moderate Articles - Forbiary', 'Review and moderate recent articles on Forbiary.');
        }

        function showBecomeModerator() {
            hideAllPages();
            document.getElementById('becomeModeratorPage').style.display = 'block';
            updatePageMetadata('Become Moderator - Forbiary', 'Apply to become a moderator on Forbiary knowledge platform.');
        }

        function showCategories() {
            hideAllPages();
            document.getElementById('categoriesPage').style.display = 'block';
            loadCategoryCounts();
            updatePageMetadata('Categories - Forbiary', 'Browse articles by category on Forbiary knowledge platform.');
        }

        function showPendingEdits() {
            if (!currentUser || (!isAdmin && !isModerator)) {
                showNotification('Access denied. Moderator privileges required', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('pendingEditsPage').style.display = 'block';
            loadPendingEdits();
            updatePageMetadata('Pending Edits - Forbiary', 'Review pending edits on Forbiary knowledge platform.');
        }

        function showProfile() {
            if (!currentUser) {
                showNotification('Please sign in to view your profile', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('profilePage').style.display = 'block';
            loadUserProfile();
            updatePageMetadata('My Profile - Forbiary', 'View your profile and contribution statistics on Forbiary.');
        }

        function hideAllPages() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('searchPage').style.display = 'none';
            document.getElementById('writePage').style.display = 'none';
            document.getElementById('moderatePage').style.display = 'none';
            document.getElementById('articleReader').style.display = 'none';
            document.getElementById('becomeModeratorPage').style.display = 'none';
            document.getElementById('categoriesPage').style.display = 'none';
            document.getElementById('pendingEditsPage').style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';
        }

        // Image URL preview functionality
        function setupImagePreview() {
            const imageUrlInput = document.getElementById('imageUrl');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (imageUrlInput) {
                imageUrlInput.addEventListener('input', function() {
                    const url = this.value.trim();
                    if (url && isValidImageUrl(url)) {
                        previewImg.src = url;
                        previewImg.onload = function() {
                            imagePreview.style.display = 'block';
                        };
                        previewImg.onerror = function() {
                            imagePreview.style.display = 'none';
                            showNotification('Invalid image URL or image cannot be loaded', 'warning');
                        };
                    } else {
                        imagePreview.style.display = 'none';
                    }
                });
            }
        }

        // Validate image URL
        function isValidImageUrl(url) {
            const imageExtensions = /\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i;
            return url.match(/^https?:\/\/.+/) && (imageExtensions.test(url) || url.includes('imgur.com') || url.includes('cloudinary.com') || url.includes('unsplash.com'));
        }

        // Remove image
        function removeImage() {
            document.getElementById('imageUrl').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Initialize Quill editor with enhanced toolbar
        function initializeEditor() {
            if (quill) {
                quill.setContents([]);
                return;
            }
            
            // Wait for DOM to be ready
            setTimeout(() => {
                const editorElement = document.getElementById('editor');
                if (editorElement) {
                    quill = new Quill('#editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                [{ 'font': ['serif', 'monospace', 'arial', 'times-new-roman', 'helvetica'] }],
                                [{ 'size': ['small', false, 'large', 'huge'] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'script': 'sub'}, { 'script': 'super' }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'direction': 'rtl' }],
                                [{ 'align': [] }],
                                ['link'],
                                ['blockquote', 'code-block'],
                                ['formula'],
                                ['clean']
                            ]
                        },
                        placeholder: 'Write your article content here... Use [[Article Name]] for internal links',
                        formats: ['header', 'font', 'size', 'bold', 'italic', 'underline', 'strike', 'color', 'background', 'script', 'list', 'bullet', 'indent', 'direction', 'align', 'link', 'image', 'video', 'blockquote', 'code-block', 'formula']
                    });

                    // Add internal linking functionality
                    quill.on('text-change', function(delta, oldDelta, source) {
                        if (source === 'user') {
                            detectInternalLinks();
                        }
                    });

                    // Add custom toolbar buttons
                    const toolbar = quill.getModule('toolbar');
                    
                    // Add internal link button
                    const internalLinkBtn = document.createElement('button');
                    internalLinkBtn.innerHTML = '<i class="fas fa-link"></i> Internal Link';
                    internalLinkBtn.onclick = () => insertInternalLink();
                    internalLinkBtn.style.cssText = 'margin-left: 10px; padding: 5px 10px; background: #0645ad; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;';
                    
                    const toolbarContainer = document.querySelector('.ql-toolbar');
                    if (toolbarContainer) {
                        toolbarContainer.appendChild(internalLinkBtn);
                    }
                }
            }, 100);
        }

        // Insert internal link
        function insertInternalLink() {
            const range = quill.getSelection();
            if (range) {
                const text = prompt('Enter article title to link to:');
                if (text) {
                    quill.insertText(range.index, `[[${text}]]`, 'user');
                }
            }
        }

        // Switch moderator tabs
        function switchModeratorTab(tab) {
            // Hide all tabs
            document.getElementById('recentArticlesTab').style.display = 'none';
            document.getElementById('notificationsTab').style.display = 'none';
            document.getElementById('suggestionsTab').style.display = 'none';
            
            // Remove active class from all tabs
            document.getElementById('recentTab').classList.remove('active');
            document.getElementById('notificationsTab').classList.remove('active');
            document.getElementById('suggestionsTab').classList.remove('active');
            
            // Show selected tab and mark as active
            if (tab === 'recent') {
                document.getElementById('recentArticlesTab').style.display = 'block';
                document.getElementById('recentTab').classList.add('active');
                loadRecentArticlesForModerators();
            } else if (tab === 'notifications') {
                document.getElementById('notificationsTab').style.display = 'block';
                document.getElementById('notificationsTab').classList.add('active');
                loadModeratorNotifications();
            } else if (tab === 'suggestions') {
                document.getElementById('suggestionsTab').style.display = 'block';
                document.getElementById('suggestionsTab').classList.add('active');
                loadModeratorSuggestions();
            }
        }

        // Switch between visual and code editing modes
        function switchEditMode(mode) {
            currentEditMode = mode;
            
            if (mode === 'visual') {
                document.getElementById('visualTab').classList.add('active');
                document.getElementById('codeTab').classList.remove('active');
                document.getElementById('visualEditor').style.display = 'block';
                document.getElementById('codeEditor').style.display = 'none';
                
                // Sync content from code to visual
                const codeContent = document.getElementById('codeTextarea').value;
                if (codeContent && quill) {
                    quill.root.innerHTML = codeContent;
                }
            } else {
                document.getElementById('visualTab').classList.remove('active');
                document.getElementById('codeTab').classList.add('active');
                document.getElementById('visualEditor').style.display = 'none';
                document.getElementById('codeEditor').style.display = 'block';
                
                // Sync content from visual to code
                if (quill) {
                    document.getElementById('codeTextarea').value = quill.root.innerHTML;
                }
            }
        }

        // Check if user is a moderator
        async function checkModeratorStatus() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('moderators').doc(currentUser.uid).get();
                isModerator = doc.exists && doc.data().status === 'approved';
            } catch (error) {
                console.error('Error checking moderator status:', error);
            }
        }

        // Apply to become a moderator
        async function applyForModerator() {
            if (!currentUser) {
                showNotification('Please sign in first', 'warning');
                return;
            }

            const reason = document.getElementById('moderatorReason').value;
            if (!reason.trim()) {
                showNotification('Please provide a reason for becoming a moderator', 'warning');
                return;
            }

            try {
                showNotification('Processing your moderator application...', 'info', 2000);
                
                const currentTime = new Date();
                await db.collection('moderators').doc(currentUser.uid).set({
                    email: currentUser.email,
                    name: currentUser.displayName,
                    reason: reason.trim(),
                    appliedAt: firebase.firestore.Timestamp.fromDate(currentTime),
                    status: 'approved' // Auto-approve as requested
                });

                isModerator = true;
                document.getElementById('moderatorSection').style.display = 'block';
                document.getElementById('moderatorBadgeMobile').style.display = 'inline-block';
                document.getElementById('moderatorSectionDesktop1').style.display = 'inline-block';
                document.getElementById('moderatorSectionDesktop2').style.display = 'inline-block';
                document.getElementById('moderatorBadgeDesktop').style.display = 'inline-block';
                
                document.getElementById('applicationStatus').innerHTML = '<div style="color: #28a745; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin-top: 15px;"><i class="fas fa-check-circle"></i> You are now a moderator! You can now moderate articles and lock/unlock them.</div>';
                
                showNotification('Congratulations! You are now a moderator', 'success');
            } catch (error) {
                showNotification('Error applying for moderator: ' + error.message, 'error');
            }
        }

        // Clear form
        function clearForm() {
            try {
                const titleElement = document.getElementById('articleTitle');
                const summaryElement = document.getElementById('articleSummary');
                const categoryElement = document.getElementById('articleCategory');
                const tagsElement = document.getElementById('articleTags');
                const referencesElement = document.getElementById('articleReferences');
                const editSummaryElement = document.getElementById('editSummary');
                const codeTextareaElement = document.getElementById('codeTextarea');
                const imageUrlElement = document.getElementById('imageUrl');

                if (titleElement) titleElement.value = '';
                if (summaryElement) summaryElement.value = '';
                if (categoryElement) categoryElement.value = '';
                if (tagsElement) tagsElement.value = '';
                if (referencesElement) referencesElement.value = '';
                if (editSummaryElement) editSummaryElement.value = '';
                if (codeTextareaElement) codeTextareaElement.value = '';
                if (imageUrlElement) {
                    imageUrlElement.value = '';
                    document.getElementById('imagePreview').style.display = 'none';
                }
                
                if (quill && quill.setContents) {
                    try {
                        quill.setContents([]);
                    } catch (quillError) {
                        console.warn('Error clearing Quill editor:', quillError);
                    }
                }
            } catch (error) {
                console.error('Error clearing form:', error);
            }
        }

        // Load article for editing
        async function loadArticleForEditing(articleId) {
            try {
                const doc = await db.collection('articles').doc(articleId).get();
                if (!doc.exists) {
                    alert('Article not found');
                    return;
                }
                
                const article = doc.data();
                
                // Safely populate form fields
                const titleElement = document.getElementById('articleTitle');
                const summaryElement = document.getElementById('articleSummary');
                const categoryElement = document.getElementById('articleCategory');
                const tagsElement = document.getElementById('articleTags');
                const referencesElement = document.getElementById('articleReferences');
                const codeTextareaElement = document.getElementById('codeTextarea');
                const imageUrlElement = document.getElementById('imageUrl');

                if (titleElement) titleElement.value = article.title || '';
                if (summaryElement) summaryElement.value = article.summary || '';
                if (categoryElement) categoryElement.value = article.category || '';
                if (tagsElement) tagsElement.value = (article.tags || []).join(', ');
                if (referencesElement) referencesElement.value = (article.references || []).join('\n');
                if (codeTextareaElement) codeTextareaElement.value = article.content || '';
                if (imageUrlElement && article.featuredImage) {
                    imageUrlElement.value = article.featuredImage;
                    const previewImg = document.getElementById('previewImg');
                    const imagePreview = document.getElementById('imagePreview');
                    if (previewImg && imagePreview) {
                        previewImg.src = article.featuredImage;
                        imagePreview.style.display = 'block';
                    }
                }
                
                // Safely populate Quill editor
                if (quill && quill.root) {
                    try {
                        quill.root.innerHTML = article.content || '';
                    } catch (quillError) {
                        console.warn('Error loading content into Quill editor:', quillError);
                        if (codeTextareaElement) codeTextareaElement.value = article.content || '';
                    }
                }
                
            } catch (error) {
                console.error('Error loading article for editing:', error);
                alert('Error loading article for editing: ' + (error.message || 'Unknown error'));
            }
        }

        // Preview article
        function previewArticle() {
            const title = document.getElementById('articleTitle').value;
            const summary = document.getElementById('articleSummary').value;
            const content = currentEditMode === 'visual' ? quill.root.innerHTML : document.getElementById('codeTextarea').value;
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>Preview: ${title}</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        h1 { border-bottom: 3px solid #a2a9b1; padding-bottom: 8px; }
                        h2 { border-bottom: 1px solid #a2a9b1; padding-bottom: 4px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p><strong>Summary:</strong> ${summary}</p>
                    <hr>
                    ${content}
                </body>
                </html>
            `);
        }

        // Search from header
        function searchFromHeader() {
            const searchTerm = document.getElementById('mainSearchInput').value;
            document.getElementById('searchInput').value = searchTerm;
            showSearch();
            searchArticles();
        }

        // Filter by category
        function filterByCategory(category) {
            document.getElementById('categoryFilter').value = category;
            showSearch();
            searchArticles();
        }

        // Get user IP address (simplified for demo)
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        // Check if IP is banned
        async function checkIPBan(ip) {
            try {
                const doc = await db.collection('bannedIPs').doc(ip).get();
                if (doc.exists) {
                    const banData = doc.data();
                    const banExpiry = banData.expiresAt.toDate();
                    return new Date() < banExpiry;
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        // Ban IP address
        async function banIP(ip, reason = 'False information') {
            if (!isAdmin && !isModerator) return;
            
            const currentTime = new Date();
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 5); // 5 months ban
            
            try {
                await db.collection('bannedIPs').doc(ip).set({
                    reason: reason,
                    bannedBy: currentUser.displayName,
                    bannedAt: firebase.firestore.Timestamp.fromDate(currentTime),
                    expiresAt: firebase.firestore.Timestamp.fromDate(expiryDate)
                });
                
                showNotification(`IP ${ip} has been banned for 5 months.`, 'success');
            } catch (error) {
                console.error('Error banning IP:', error);
                showNotification('Error banning IP: ' + error.message, 'error');
            }
        }

        // Enhanced page metadata update for comprehensive SEO
        function updatePageMetadata(title, description, keywords = '', canonicalUrl = '', article = null) {
            // Update title
            document.title = title;
            
            // Update meta description
            let metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.setAttribute('content', description);
            }
            
            // Update keywords
            if (keywords) {
                let metaKeywords = document.querySelector('meta[name="keywords"]');
                if (!metaKeywords) {
                    metaKeywords = document.createElement('meta');
                    metaKeywords.setAttribute('name', 'keywords');
                    document.head.appendChild(metaKeywords);
                }
                metaKeywords.setAttribute('content', keywords);
            }
            
            // Update robots meta
            let metaRobots = document.querySelector('meta[name="robots"]');
            if (!metaRobots) {
                metaRobots = document.createElement('meta');
                metaRobots.setAttribute('name', 'robots');
                document.head.appendChild(metaRobots);
            }
            metaRobots.setAttribute('content', article?.metaRobots || 'index, follow');
            
            // Update canonical URL
            let canonical = document.querySelector('link[rel="canonical"]');
            if (canonical) {
                canonical.setAttribute('href', canonicalUrl || window.location.href);
            }
            
            // Add article-specific meta tags if article data is provided
            if (article) {
                // Add author meta tag
                let metaAuthor = document.querySelector('meta[name="author"]');
                if (!metaAuthor) {
                    metaAuthor = document.createElement('meta');
                    metaAuthor.setAttribute('name', 'author');
                    document.head.appendChild(metaAuthor);
                }
                metaAuthor.setAttribute('content', article.author);
                
                // Add article published time
                if (article.timestamp) {
                    let metaPublished = document.querySelector('meta[property="article:published_time"]');
                    if (!metaPublished) {
                        metaPublished = document.createElement('meta');
                        metaPublished.setAttribute('property', 'article:published_time');
                        document.head.appendChild(metaPublished);
                    }
                    const publishedTime = article.timestamp.toDate ? article.timestamp.toDate().toISOString() : new Date(article.timestamp).toISOString();
                    metaPublished.setAttribute('content', publishedTime);
                }
                
                // Add article modified time
                if (article.lastEditedAt) {
                    let metaModified = document.querySelector('meta[property="article:modified_time"]');
                    if (!metaModified) {
                        metaModified = document.createElement('meta');
                        metaModified.setAttribute('property', 'article:modified_time');
                        document.head.appendChild(metaModified);
                    }
                    const modifiedTime = article.lastEditedAt.toDate ? article.lastEditedAt.toDate().toISOString() : new Date(article.lastEditedAt).toISOString();
                    metaModified.setAttribute('content', modifiedTime);
                }
                
                // Add article section
                let metaSection = document.querySelector('meta[property="article:section"]');
                if (!metaSection) {
                    metaSection = document.createElement('meta');
                    metaSection.setAttribute('property', 'article:section');
                    document.head.appendChild(metaSection);
                }
                metaSection.setAttribute('content', article.category);
                
                // Add article tags
                if (article.tags && article.tags.length > 0) {
                    // Remove existing article:tag meta tags
                    const existingTags = document.querySelectorAll('meta[property="article:tag"]');
                    existingTags.forEach(tag => tag.remove());
                    
                    // Add new article:tag meta tags
                    article.tags.forEach(tag => {
                        const metaTag = document.createElement('meta');
                        metaTag.setAttribute('property', 'article:tag');
                        metaTag.setAttribute('content', tag);
                        document.head.appendChild(metaTag);
                    });
                }
            }
            
            // Update comprehensive Open Graph and Twitter Card tags
            updateOpenGraphTags(title, description, canonicalUrl || window.location.href, article);
            updateTwitterCardTags(title, description, article);
        }

        // Enhanced Open Graph tags update
        function updateOpenGraphTags(title, description, url, article = null) {
            const ogTags = [
                { property: 'og:title', content: article?.ogTitle || title },
                { property: 'og:description', content: article?.ogDescription || description },
                { property: 'og:url', content: url },
                { property: 'og:type', content: article?.ogType || 'article' },
                { property: 'og:site_name', content: 'Forbiary' },
                { property: 'og:locale', content: 'en_US' }
            ];
            
            // Add image if available
            if (article?.featuredImage) {
                ogTags.push({ property: 'og:image', content: article.featuredImage });
                ogTags.push({ property: 'og:image:alt', content: `Featured image for ${title}` });
            } else {
                ogTags.push({ property: 'og:image', content: 'https://forbiary.com/default-og-image.jpg' });
                ogTags.push({ property: 'og:image:alt', content: 'Forbiary Knowledge Platform' });
            }
            
            // Add article-specific Open Graph tags
            if (article) {
                if (article.author) {
                    ogTags.push({ property: 'article:author', content: article.author });
                }
                if (article.timestamp) {
                    const publishedTime = article.timestamp.toDate ? article.timestamp.toDate().toISOString() : new Date(article.timestamp).toISOString();
                    ogTags.push({ property: 'article:published_time', content: publishedTime });
                }
                if (article.lastEditedAt) {
                    const modifiedTime = article.lastEditedAt.toDate ? article.lastEditedAt.toDate().toISOString() : new Date(article.lastEditedAt).toISOString();
                    ogTags.push({ property: 'article:modified_time', content: modifiedTime });
                }
                if (article.category) {
                    ogTags.push({ property: 'article:section', content: article.category });
                }
            }
            
            ogTags.forEach(tag => {
                let ogTag = document.querySelector(`meta[property="${tag.property}"]`);
                if (ogTag) {
                    ogTag.setAttribute('content', tag.content);
                } else {
                    ogTag = document.createElement('meta');
                    ogTag.setAttribute('property', tag.property);
                    ogTag.setAttribute('content', tag.content);
                    document.head.appendChild(ogTag);
                }
            });
        }

        // Enhanced Twitter Card tags update
        function updateTwitterCardTags(title, description, article = null) {
            const twitterTags = [
                { name: 'twitter:card', content: article?.twitterCard || 'summary_large_image' },
                { name: 'twitter:site', content: '@Forbiary' },
                { name: 'twitter:title', content: article?.twitterTitle || title },
                { name: 'twitter:description', content: article?.twitterDescription || description }
            ];
            
            // Add image if available
            if (article?.featuredImage) {
                twitterTags.push({ name: 'twitter:image', content: article.featuredImage });
                twitterTags.push({ name: 'twitter:image:alt', content: `Featured image for ${title}` });
            } else {
                twitterTags.push({ name: 'twitter:image', content: 'https://forbiary.com/default-twitter-image.jpg' });
                twitterTags.push({ name: 'twitter:image:alt', content: 'Forbiary Knowledge Platform' });
            }
            
            twitterTags.forEach(tag => {
                let twitterTag = document.querySelector(`meta[name="${tag.name}"]`);
                if (twitterTag) {
                    twitterTag.setAttribute('content', tag.content);
                } else {
                    twitterTag = document.createElement('meta');
                    twitterTag.setAttribute('name', tag.name);
                    twitterTag.setAttribute('content', tag.content);
                    document.head.appendChild(twitterTag);
                }
            });
        }

        // Enhanced SEO keywords generation with better analysis
        function generateSEOKeywords(title, summary, content, tags, category) {
            const commonWords = ['the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'this', 'that', 'these', 'those', 'a', 'an', 'how', 'what', 'when', 'where', 'why', 'who', 'which', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'up', 'down', 'out', 'off', 'over', 'under', 'again', 'further', 'then', 'once'];
            
            // Extract text from HTML content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            // Combine all text sources with weighted importance
            const titleWords = title.toLowerCase().split(/\s+/);
            const summaryWords = summary.toLowerCase().split(/\s+/);
            const contentWords = textContent.toLowerCase().match(/\b[a-zA-Z]{3,}\b/g) || [];
            
            const wordFreq = {};
            
            // Weight title words more heavily (3x)
            titleWords.forEach(word => {
                if (!commonWords.includes(word) && word.length > 2) {
                    wordFreq[word] = (wordFreq[word] || 0) + 3;
                }
            });
            
            // Weight summary words moderately (2x)
            summaryWords.forEach(word => {
                if (!commonWords.includes(word) && word.length > 2) {
                    wordFreq[word] = (wordFreq[word] || 0) + 2;
                }
            });
            
            // Weight content words normally (1x)
            contentWords.forEach(word => {
                if (!commonWords.includes(word) && word.length > 2) {
                    wordFreq[word] = (wordFreq[word] || 0) + 1;
                }
            });
            
            // Sort by frequency and get top keywords
            const sortedWords = Object.entries(wordFreq)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .map(([word]) => word);
            
            // Add category-specific keywords
            const categoryKeywords = {
                'Technology': ['tech', 'software', 'digital', 'innovation', 'development', 'programming', 'computer', 'internet', 'AI', 'machine learning'],
                'Business': ['business', 'management', 'strategy', 'marketing', 'finance', 'entrepreneurship', 'startup', 'company', 'corporate', 'leadership'],
                'Science': ['research', 'study', 'scientific', 'discovery', 'experiment', 'analysis', 'theory', 'methodology', 'data', 'evidence'],
                'History': ['historical', 'past', 'ancient', 'timeline', 'civilization', 'culture', 'heritage', 'tradition', 'legacy', 'chronicle'],
                'Health': ['health', 'medical', 'wellness', 'treatment', 'healthcare', 'medicine', 'fitness', 'nutrition', 'disease', 'therapy'],
                'Education': ['education', 'learning', 'teaching', 'academic', 'knowledge', 'study', 'curriculum', 'training', 'skill', 'development']
            };
            
            const relevantCategoryKeywords = categoryKeywords[category] || [];
            
            // Combine all keywords: user tags (highest priority) + extracted words + category keywords
            const allKeywords = [
                ...tags, // User-defined tags get highest priority
                ...sortedWords,
                ...relevantCategoryKeywords.filter(keyword => 
                    textContent.toLowerCase().includes(keyword) || 
                    title.toLowerCase().includes(keyword) || 
                    summary.toLowerCase().includes(keyword)
                ),
                category.toLowerCase(), // Always include category
                'forbiary', // Brand keyword
                'knowledge', 'article', 'information' // Generic relevant keywords
            ];
            
            // Remove duplicates and limit to 25 keywords
            const uniqueKeywords = [...new Set(allKeywords)];
            return uniqueKeywords.slice(0, 25).join(', ');
        }

        // Enhanced SEO description generation
        function generateSEODescription(summary, content, title, category) {
            // Optimal length for SEO descriptions is 150-160 characters
            const maxLength = 155;
            
            // If summary is good length and quality, use it
            if (summary && summary.length >= 50 && summary.length <= maxLength) {
                return summary;
            }
            
            // If summary is too long, truncate smartly
            if (summary && summary.length > maxLength) {
                const truncated = summary.substring(0, maxLength - 3);
                const lastSpace = truncated.lastIndexOf(' ');
                return lastSpace > 100 ? truncated.substring(0, lastSpace) + '...' : truncated + '...';
            }
            
            // If summary is too short, enhance it
            if (summary && summary.length < 50) {
                const enhanced = `${summary} - Comprehensive ${category.toLowerCase()} article on Forbiary knowledge platform.`;
                return enhanced.length <= maxLength ? enhanced : enhanced.substring(0, maxLength - 3) + '...';
            }
            
            // Extract from content if no good summary
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            // Try to find a good opening sentence
            const sentences = textContent.split(/[.!?]+/).filter(s => s.trim().length > 30);
            if (sentences.length > 0) {
                let description = sentences[0].trim();
                
                // If first sentence is too short, combine with second
                if (description.length < 80 && sentences.length > 1) {
                    const combined = `${description}. ${sentences[1].trim()}`;
                    if (combined.length <= maxLength) {
                        description = combined;
                    }
                }
                
                // Ensure it ends properly and fits length
                if (description.length > maxLength) {
                    const truncated = description.substring(0, maxLength - 3);
                    const lastSpace = truncated.lastIndexOf(' ');
                    description = lastSpace > 100 ? truncated.substring(0, lastSpace) + '...' : truncated + '...';
                }
                
                return description;
            }
            
            // Fallback: create description from title and category
            const fallback = `Learn about ${title.toLowerCase()} in this comprehensive ${category.toLowerCase()} article on Forbiary knowledge platform.`;
            return fallback.length <= maxLength ? fallback : fallback.substring(0, maxLength - 3) + '...';
        }

        // Notify moderators about new article
        async function notifyModeratorsNewArticle(articleId, articleData) {
            try {
                const currentTime = new Date();
                await db.collection('moderatorNotifications').add({
                    type: 'new_article',
                    articleId: articleId,
                    articleTitle: articleData.title,
                    author: articleData.author,
                    category: articleData.category,
                    timestamp: firebase.firestore.Timestamp.fromDate(currentTime),
                    read: false,
                    message: `New article "${articleData.title}" published by ${articleData.author}`
                });
            } catch (error) {
                console.error('Error notifying moderators:', error);
            }
        }

        // Generate comprehensive structured data for article
        function generateArticleStructuredData(article, articleId) {
            const publishDate = article.timestamp ? article.timestamp.toDate().toISOString() : new Date().toISOString();
            const modifiedDate = article.lastEditedAt ? article.lastEditedAt.toDate().toISOString() : publishDate;
            
            const structuredData = {
                "@context": "https://schema.org",
                "@type": "Article",
                "headline": article.title,
                "description": article.seoDescription || article.summary,
                "image": article.featuredImage || "https://forbiary.com/default-article-image.jpg",
                "author": {
                    "@type": "Person",
                    "name": article.author,
                    "url": `https://forbiary.com/author/${article.uid}`
                },
                "publisher": {
                    "@type": "Organization",
                    "name": "Forbiary",
                    "url": "https://forbiary.com",
                    "logo": {
                        "@type": "ImageObject",
                        "url": "https://forbiary.com/logo.png",
                        "width": 200,
                        "height": 60
                    }
                },
                "datePublished": publishDate,
                "dateModified": modifiedDate,
                "mainEntityOfPage": {
                    "@type": "WebPage",
                    "@id": `https://forbiary.com/#${articleId}`
                },
                "articleSection": article.category,
                "keywords": article.seoKeywords || article.tags.join(', '),
                "wordCount": article.wordCount || 0,
                "url": `https://forbiary.com/#${articleId}`,
                "inLanguage": "en-US",
                "isAccessibleForFree": true,
                "genre": article.category,
                "about": {
                    "@type": "Thing",
                    "name": article.category
                }
            };

            // Add breadcrumb structured data
            const breadcrumbData = {
                "@context": "https://schema.org",
                "@type": "BreadcrumbList",
                "itemListElement": [
                    {
                        "@type": "ListItem",
                        "position": 1,
                        "name": "Home",
                        "item": "https://forbiary.com"
                    },
                    {
                        "@type": "ListItem",
                        "position": 2,
                        "name": article.category,
                        "item": `https://forbiary.com/category/${article.category.toLowerCase()}`
                    },
                    {
                        "@type": "ListItem",
                        "position": 3,
                        "name": article.title,
                        "item": `https://forbiary.com/#${articleId}`
                    }
                ]
            };
            
            // Remove existing structured data
            const existingScripts = document.querySelectorAll('script[type="application/ld+json"][data-article]');
            existingScripts.forEach(script => script.remove());
            
            // Add article structured data
            const articleScript = document.createElement('script');
            articleScript.type = 'application/ld+json';
            articleScript.setAttribute('data-article', 'true');
            articleScript.textContent = JSON.stringify(structuredData);
            document.head.appendChild(articleScript);
            
            // Add breadcrumb structured data
            const breadcrumbScript = document.createElement('script');
            breadcrumbScript.type = 'application/ld+json';
            breadcrumbScript.setAttribute('data-article', 'true');
            breadcrumbScript.textContent = JSON.stringify(breadcrumbData);
            document.head.appendChild(breadcrumbScript);
        }

        // Calculate article quality score for SEO ranking
        function calculateQualityScore(title, summary, content, tags, references, wordCount) {
            let score = 0;
            
            // Title quality (max 20 points)
            if (title.length >= 10 && title.length <= 60) score += 15;
            else if (title.length >= 5) score += 10;
            if (title.split(' ').length >= 3) score += 5; // Multi-word titles are better
            
            // Summary quality (max 15 points)
            if (summary.length >= 50 && summary.length <= 160) score += 15;
            else if (summary.length >= 30) score += 10;
            
            // Content quality (max 30 points)
            if (wordCount >= 300) score += 20;
            else if (wordCount >= 150) score += 15;
            else if (wordCount >= 50) score += 10;
            
            // Check for headings in content
            if (content.includes('<h2>') || content.includes('<h3>')) score += 5;
            if (content.includes('<ul>') || content.includes('<ol>')) score += 5; // Lists improve readability
            
            // Tags quality (max 10 points)
            if (tags.length >= 3 && tags.length <= 8) score += 10;
            else if (tags.length >= 1) score += 5;
            
            // References quality (max 10 points)
            if (references.length >= 2) score += 10;
            else if (references.length >= 1) score += 5;
            
            // Content structure bonus (max 15 points)
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 10);
            if (sentences.length >= 5) score += 5; // Good sentence count
            
            const paragraphs = content.split('<p>').length - 1;
            if (paragraphs >= 3) score += 5; // Well-structured paragraphs
            
            if (content.includes('</strong>') || content.includes('</em>')) score += 5; // Text formatting
            
            return Math.min(score, 100); // Cap at 100
        }

        // Detect and create internal links
        function detectInternalLinks() {
            if (!quill) return;
            
            const text = quill.getText();
            const words = text.split(/\s+/);
            
            // Simple internal linking - look for article titles in text
            siteArticles.forEach((articleData, articleId) => {
                const title = articleData.title.toLowerCase();
                words.forEach((word, index) => {
                    if (word.toLowerCase().includes(title) && word.length > 3) {
                        // This is a simplified version - in a real implementation,
                        // you'd want more sophisticated text processing
                    }
                });
            });
        }

        // Load articles for internal linking cache
        async function loadArticlesForLinking() {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .get();
                
                siteArticles.clear();
                snapshot.forEach(doc => {
                    siteArticles.set(doc.id, doc.data());
                });
            } catch (error) {
                console.error('Error loading articles for linking:', error);
            }
        }

        // Submit article or edit
        document.getElementById('articleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = document.querySelector('#articleForm button[type="submit"]');
            if (!submitBtn) {
                console.error('Submit button not found');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;

            try {
                // Check if user is signed in for new articles
                if (!currentEditingArticleId && !currentUser) {
                    showNotification('Please sign in to create articles', 'warning');
                    return;
                }

                // Get and validate form elements
                const titleElement = document.getElementById('articleTitle');
                const summaryElement = document.getElementById('articleSummary');
                const categoryElement = document.getElementById('articleCategory');
                const tagsElement = document.getElementById('articleTags');
                const referencesElement = document.getElementById('articleReferences');
                const editSummaryElement = document.getElementById('editSummary');
                const codeTextareaElement = document.getElementById('codeTextarea');
                const imageUrlElement = document.getElementById('imageUrl');

                if (!titleElement || !summaryElement || !categoryElement || !tagsElement || 
                    !referencesElement || !editSummaryElement || !codeTextareaElement) {
                    throw new Error('Form elements not properly initialized');
                }

                // Get form values safely with validation
                const title = titleElement.value ? titleElement.value.trim() : '';
                const summary = summaryElement.value ? summaryElement.value.trim() : '';
                const category = categoryElement.value ? categoryElement.value.trim() : '';
                const tagsValue = tagsElement.value ? tagsElement.value.trim() : '';
                const referencesValue = referencesElement.value ? referencesElement.value.trim() : '';
                const editSummary = editSummaryElement.value ? editSummaryElement.value.trim() : '';
                const featuredImage = imageUrlElement ? imageUrlElement.value.trim() : '';

                // Process tags and references with validation
                const tags = tagsValue ? tagsValue.split(',').map(tag => tag.trim()).filter(tag => tag && tag.length > 0) : [];
                const references = referencesValue ? referencesValue.split('\n').map(ref => ref.trim()).filter(ref => ref && ref.length > 0) : [];
                
                // Get content based on current edit mode
                let htmlContent = '';
                try {
                    if (currentEditMode === 'visual' && quill && quill.root) {
                        htmlContent = quill.root.innerHTML || '';
                    } else {
                        htmlContent = codeTextareaElement.value || '';
                    }
                } catch (contentError) {
                    console.error('Error getting content:', contentError);
                    htmlContent = codeTextareaElement.value || '';
                }

                // Comprehensive field validation
                const validationErrors = [];
                
                if (!title) {
                    validationErrors.push('Article title is required');
                }
                if (title.length > 200) {
                    validationErrors.push('Article title must be less than 200 characters');
                }
                if (!summary) {
                    validationErrors.push('Article summary is required');
                }
                if (summary.length > 500) {
                    validationErrors.push('Article summary must be less than 500 characters');
                }
                if (!category) {
                    validationErrors.push('Please select a category');
                }
                if (!htmlContent || htmlContent.trim() === '<p><br></p>' || htmlContent.trim() === '' || htmlContent.trim() === '<p></p>') {
                    validationErrors.push('Article content is required');
                }
                if (htmlContent.length > 50000) {
                    validationErrors.push('Article content is too long (maximum 50,000 characters)');
                }
                if (tags.length > 10) {
                    validationErrors.push('Maximum 10 tags allowed');
                }
                if (references.length > 20) {
                    validationErrors.push('Maximum 20 references allowed');
                }

                if (validationErrors.length > 0) {
                    showNotification('Please fix the following errors:<br><br>• ' + validationErrors.join('<br>• '), 'error', 8000);
                    return;
                }

                // Get user IP for tracking
                let userIP = 'unknown';
                try {
                    userIP = await getUserIP();
                    const isBanned = await checkIPBan(userIP);
                    
                    if (isBanned) {
                        showNotification('Your IP address has been banned for submitting false information. Ban will expire in 5 months.', 'error');
                        return;
                    }
                } catch (ipError) {
                    console.warn('Could not get user IP:', ipError);
                }

                // Create timestamp objects for different databases
                const currentTime = new Date();
                const firestoreTimestamp = firebase.firestore.Timestamp.fromDate(currentTime);
                const realtimeTimestamp = currentTime.getTime();

                if (currentEditingArticleId) {
                    // Update existing article with enhanced edit tracking
                    const seoKeywords = generateSEOKeywords(title, summary, htmlContent, tags, category);
                    const seoDescription = generateSEODescription(summary, htmlContent, title, category);
                    
                    // Calculate word count
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;
                    const wordCount = (tempDiv.textContent || tempDiv.innerText || '').split(/\s+/).filter(word => word.length > 0).length;
                    
                    // Get original article for edit history and change detection
                    let originalArticle = {};
                    try {
                        const originalDoc = await db.collection('articles').doc(currentEditingArticleId).get();
                        originalArticle = originalDoc.exists ? originalDoc.data() : {};
                    } catch (error) {
                        console.warn('Could not load original article for edit history:', error);
                    }
                    
                    // Check if title has changed - if so, send for review
                    const titleChanged = originalArticle.title && originalArticle.title !== title;
                    
                    // Prepare edit history entry with detailed change tracking
                    const editHistoryEntry = {
                        editor: currentUser.displayName,
                        editorUid: currentUser.uid,
                        editSummary: editSummary || 'No summary provided',
                        timestamp: firestoreTimestamp,
                        previousTitle: originalArticle.title || '',
                        previousSummary: originalArticle.summary || '',
                        titleChanged: titleChanged,
                        changesDetected: {
                            title: titleChanged,
                            summary: originalArticle.summary !== summary,
                            content: originalArticle.content !== htmlContent,
                            category: originalArticle.category !== category,
                            tags: JSON.stringify(originalArticle.tags || []) !== JSON.stringify(tags),
                            references: JSON.stringify(originalArticle.references || []) !== JSON.stringify(references),
                            featuredImage: (originalArticle.featuredImage || '') !== featuredImage
                        }
                    };

                    const updatedArticleData = {
                        summary,
                        category,
                        tags,
                        references,
                        content: htmlContent,
                        featuredImage: featuredImage || null,
                        editSummary: editSummary || 'No summary provided',
                        lastEditedBy: currentUser.displayName,
                        lastEditedByUid: currentUser.uid,
                        authorIP: userIP,
                        wordCount,
                        // Enhanced SEO Metadata
                        seoKeywords,
                        seoDescription,
                        seoTitle: `${titleChanged ? originalArticle.title : title} - Forbiary Knowledge Platform`,
                        canonicalUrl: `https://forbiary.com/#${currentEditingArticleId}`,
                        // Additional metadata for better SEO
                        readingTime: Math.ceil(wordCount / 200), // Average reading speed
                        lastOptimized: new Date().toISOString()
                    };

                    // If title changed, create pending edit for moderator review
                    if (titleChanged) {
                        try {
                            await db.collection('pendingTitleChanges').add({
                                articleId: currentEditingArticleId,
                                originalTitle: originalArticle.title,
                                newTitle: title,
                                editorUid: currentUser.uid,
                                editorName: currentUser.displayName,
                                editSummary: editSummary || 'Title change',
                                timestamp: firestoreTimestamp,
                                status: 'pending'
                            });
                            
                            showNotification('📝 Article updated! Title change sent for moderator review.', 'info');
                        } catch (error) {
                            console.warn('Could not create pending title change:', error);
                        }
                    } else {
                        // Include title in update if it hasn't changed
                        updatedArticleData.title = title;
                        updatedArticleData.seoTitle = `${title} - Forbiary Knowledge Platform`;
                    }

                    // Update article in Firestore with serverTimestamp for update operations
                    try {
                        await db.collection('articles').doc(currentEditingArticleId).update({
                            ...updatedArticleData,
                            lastEditedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            editHistory: firebase.firestore.FieldValue.arrayUnion(editHistoryEntry)
                        });
                    } catch (firestoreError) {
                        console.error('Firestore update error:', firestoreError);
                        throw new Error('Failed to update article in Firestore: ' + firestoreError.message);
                    }
                    
                    // Update in Realtime Database as backup
                    try {
                        const realtimeData = {
                            ...updatedArticleData,
                            lastEditedAt: realtimeTimestamp,
                            editHistory: originalArticle.editHistory ? 
                                [...(originalArticle.editHistory || []), {
                                    ...editHistoryEntry,
                                    timestamp: realtimeTimestamp
                                }] : [{ ...editHistoryEntry, timestamp: realtimeTimestamp }]
                        };
                        
                        await realtimeDb.ref('articles').child(currentEditingArticleId).update(realtimeData);
                    } catch (realtimeError) {
                        console.warn('Could not save to Realtime Database:', realtimeError);
                    }

                    if (!titleChanged) {
                        showNotification('🎉 Article updated successfully! Your changes are now live.', 'success');
                    }
                } else {
                    // Create new article with comprehensive SEO
                    const seoKeywords = generateSEOKeywords(title, summary, htmlContent, tags, category);
                    const seoDescription = generateSEODescription(summary, htmlContent, title, category);
                    
                    // Calculate word count and reading time
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;
                    const wordCount = (tempDiv.textContent || tempDiv.innerText || '').split(/\s+/).filter(word => word.length > 0).length;
                    const readingTime = Math.ceil(wordCount / 200); // Average reading speed
                    
                    const baseArticleData = {
                        title,
                        summary,
                        category,
                        tags,
                        references,
                        content: htmlContent,
                        featuredImage: featuredImage || null,
                        editSummary: editSummary || 'No summary provided',
                        author: currentUser.displayName,
                        authorEmail: currentUser.email,
                        uid: currentUser.uid,
                        status: 'approved', // Published immediately
                        editHistory: [],
                        locked: false,
                        viewCount: 0,
                        authorIP: userIP,
                        createdAt: currentTime.toISOString(),
                        wordCount,
                        readingTime,
                        // Comprehensive SEO Metadata
                        seoKeywords,
                        seoDescription,
                        seoTitle: `${title} - Forbiary Knowledge Platform`,
                        // Open Graph metadata
                        ogTitle: title,
                        ogDescription: seoDescription,
                        ogType: 'article',
                        ogImage: featuredImage || 'https://community.oriontec.xyz/IMG_9197.png',
                        // Twitter Card metadata
                        twitterCard: 'summary_large_image',
                        twitterTitle: title,
                        twitterDescription: seoDescription,
                        twitterImage: featuredImage || 'https://community.oriontec.xyz/IMG_9197.png',
                        // Additional SEO fields
                        metaRobots: 'index, follow',
                        lastOptimized: currentTime.toISOString(),
                        // Article quality metrics
                        qualityScore: calculateQualityScore(title, summary, htmlContent, tags, references, wordCount)
                    };

                    // Submit to Firestore with proper timestamp handling
                    let articleRef;
                    try {
                        // Use regular Date object for addDoc, then update with serverTimestamp
                        articleRef = await db.collection('articles').add({
                            ...baseArticleData,
                            timestamp: firestoreTimestamp,
                            lastViewed: firestoreTimestamp
                        });
                        
                        // Update with canonical URL and server timestamps
                        await db.collection('articles').doc(articleRef.id).update({
                            canonicalUrl: `https://forbiary.com/#${articleRef.id}`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            lastViewed: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (firestoreError) {
                        console.error('Firestore creation error:', firestoreError);
                        throw new Error('Failed to create article in Firestore: ' + firestoreError.message);
                    }

                    // Submit to Realtime Database as backup
                    try {
                        const realtimeData = {
                            ...baseArticleData,
                            timestamp: realtimeTimestamp,
                            lastViewed: realtimeTimestamp,
                            canonicalUrl: `https://forbiary.com/#${articleRef.id}`
                        };
                        
                        await realtimeDb.ref('articles').child(articleRef.id).set(realtimeData);
                    } catch (realtimeError) {
                        console.warn('Could not save to Realtime Database:', realtimeError);
                        // Don't fail the entire operation if Realtime DB fails
                    }

                    // Notify moderators about new article
                    try {
                        await db.collection('moderatorNotifications').add({
                            type: 'new_article',
                            articleId: articleRef.id,
                            articleTitle: title,
                            author: currentUser.displayName,
                            category: category,
                            timestamp: firestoreTimestamp,
                            read: false,
                            message: `New article "${title}" published by ${currentUser.displayName}`
                        });
                    } catch (notifyError) {
                        console.warn('Could not notify moderators:', notifyError);
                    }

                    showNotification('🎉 Article published successfully! Your article is now live on Forbiary.', 'success', 6000);
                    
                    // Auto-refresh recent articles and redirect to home
                    setTimeout(() => {
                        loadRecentArticles();
                        showHome();
                    }, 1500);
                }

                // Clear form and redirect
                clearForm();
                showHome();
                
            } catch (error) {
                console.error('Submission error:', error);
                
                // Show user-friendly error message
                let errorMessage = 'An error occurred while submitting your article. ';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'You do not have permission to perform this action.';
                } else if (error.code === 'network-request-failed') {
                    errorMessage += 'Network error. Please check your internet connection and try again.';
                } else if (error.code === 'quota-exceeded') {
                    errorMessage += 'Storage quota exceeded. Please try again later.';
                } else if (error.code === 'invalid-argument') {
                    errorMessage += 'Invalid data format. Please check your input and try again.';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Please try again or contact support if the problem persists.';
                }
                
                showNotification(errorMessage, 'error', 8000);
                
            } finally {
                // Always reset button state
                try {
                    if (submitBtn) {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (resetError) {
                    console.error('Error resetting button:', resetError);
                }
            }
        });

        // Load recent articles
        async function loadRecentArticles() {
            const container = document.getElementById('recentArticles');
            if (!container) return;

            try {
                // Show loading state
                container.innerHTML = `
                    <div class="loading-spinner" style="margin: 20px auto; display: block;"></div>
                    <p style="text-align: center; color: #666; margin-top: 10px;">Loading recent articles...</p>
                `;

                let articlesData = [];

                // Try Firestore first - only get real articles (exclude demo articles)
                try {
                    const snapshot = await db.collection('articles')
                        .where('status', '==', 'approved')
                        .orderBy('timestamp', 'desc')
                        .limit(8)
                        .get();

                    snapshot.forEach(doc => {
                        const article = doc.data();
                        // Exclude demo articles
                        if (!doc.id.startsWith('demo_article_')) {
                            articlesData.push({ id: doc.id, ...article });
                        }
                    });
                } catch (firestoreError) {
                    console.warn('Firestore unavailable:', firestoreError);
                }

                // Clear loading state
                container.innerHTML = '';

                if (articlesData.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                            <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: #adb5bd;"></i>
                            <h4 style="margin: 0 0 10px 0; color: #6c757d;">No Articles Published Yet</h4>
                            <p style="margin: 0 0 20px 0;">Be the first to contribute to Forbiary!</p>
                            <button onclick="showWrite()" class="wiki-edit-btn">
                                <i class="fas fa-plus"></i> Create First Article
                            </button>
                        </div>
                    `;
                    return;
                }

                // Create article cards
                articlesData.forEach((article, index) => {
                    const articleCard = createArticleCard(article.id || `article_${index}`, article);
                    container.appendChild(articleCard);
                });

                showNotification(`Loaded ${articlesData.length} recent articles`, 'success', 2000);

            } catch (error) {
                console.error('Error loading recent articles:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h4 style="margin: 0 0 10px 0;">Error Loading Articles</h4>
                        <p style="margin: 0 0 20px 0;">Unable to load recent articles. Please try refreshing the page.</p>
                        <button onclick="loadRecentArticles()" class="wiki-edit-btn">
                            <i class="fas fa-refresh"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Create article card for home page
        function createArticleCard(id, article) {
            const card = document.createElement('div');
            card.style.cssText = `
                background: #fff;
                border: 1px solid #a2a9b1;
                padding: 15px;
                margin-bottom: 15px;
                cursor: pointer;
                transition: background-color 0.2s ease;
            `;
            
            // Add hover effects
            card.addEventListener('mouseenter', () => {
                card.style.backgroundColor = '#f8f9fa';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.backgroundColor = '#fff';
            });

            // Format date
            let date = 'Recently';
            
            if (article.timestamp) {
                if (article.timestamp.toDate) {
                    date = article.timestamp.toDate().toLocaleDateString();
                } else {
                    date = new Date(article.timestamp).toLocaleDateString();
                }
            } else if (article.createdAt) {
                date = new Date(article.createdAt).toLocaleDateString();
            }

            const viewCount = article.viewCount || 0;
            const tags = article.tags || [];

            card.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #0645ad; font-weight: normal; line-height: 1.3;">
                        <a href="#" onclick="event.preventDefault(); openArticle('${id}')" style="color: #0645ad; text-decoration: none;">${article.title}</a>
                    </h3>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 8px;">${article.category}</span>
                        ${date}
                        ${viewCount > 0 ? ` • ${viewCount} views` : ''}
                    </div>
                    
                    <p style="font-size: 14px; color: #333; margin: 0 0 10px 0; line-height: 1.5;">
                        ${article.summary}
                    </p>
                    
                    ${tags.length > 0 ? `
                        <div style="margin-bottom: 10px;">
                            ${tags.slice(0, 5).map(tag => 
                                `<span style="display: inline-block; background: #eaecf0; color: #333; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 4px; margin-bottom: 2px;">
                                    ${tag}
                                </span>`
                            ).join('')}
                            ${tags.length > 5 ? `<span style="color: #666; font-size: 11px;">+${tags.length - 5} more</span>` : ''}
                        </div>
                    ` : ''}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #eaecf0;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="event.stopPropagation(); openArticle('${id}')" class="wiki-edit-btn" style="font-size: 12px; padding: 6px 12px; background: #0645ad;">
                            Read
                        </button>
                        
                        ${currentUser ? `
                            <button onclick="event.stopPropagation(); showWrite('${id}')" class="wiki-edit-btn" style="font-size: 12px; padding: 6px 12px; background: #f8f9fa; color: #333; border: 1px solid #a2a9b1;">
                                Edit
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Make entire card clickable
            card.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    openArticle(id);
                }
            });
            
            return card;
        }

        // Create article link for lists (backward compatibility)
        function createArticleLink(id, article) {
            const link = document.createElement('div');
            link.style.marginBottom = '10px';
            
            const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';
            
            link.innerHTML = `
                <div style="border-bottom: 1px solid #eee; padding-bottom: 8px;">
                    <a href="#" onclick="openArticle('${id}')" style="color: #0645ad; text-decoration: none; font-weight: bold; font-size: 16px;">${article.title}</a>
                    <div style="font-size: 14px; color: #666; margin-top: 4px;">
                        <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 8px;">${article.category}</span>
                        ${date}
                    </div>
                    <p style="font-size: 14px; color: #333; margin: 8px 0 0 0; line-height: 1.4;">${article.summary}</p>
                </div>
            `;
            
            return link;
        }

        // Load all articles for search
        async function loadAllArticles() {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .orderBy('timestamp', 'desc')
                    .get();

                displaySearchResults(snapshot);
            } catch (error) {
                console.error('Error loading articles:', error);
            }
        }

        // Search articles
        async function searchArticles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            try {
                let query = db.collection('articles').where('status', '==', 'approved');
                
                if (categoryFilter) {
                    query = query.where('category', '==', categoryFilter);
                }

                const snapshot = await query.get();
                
                let filteredDocs = [];
                snapshot.forEach(doc => {
                    const article = doc.data();
                    const matchesSearch = !searchTerm || 
                        article.title.toLowerCase().includes(searchTerm) ||
                        article.summary.toLowerCase().includes(searchTerm) ||
                        article.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                    
                    if (matchesSearch) {
                        filteredDocs.push({ id: doc.id, data: article });
                    }
                });

                displaySearchResults({ docs: filteredDocs });
            } catch (error) {
                console.error('Error searching articles:', error);
            }
        }

        // Display search results
        function displaySearchResults(snapshot) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            const docs = snapshot.docs || snapshot;

            if (docs.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No articles found.</p>';
                return;
            }

            docs.forEach(item => {
                const doc = item.id ? item : { id: item.id, data: () => item.data };
                const article = item.data || doc.data();
                const articleLink = createArticleLink(item.id || doc.id, article);
                container.appendChild(articleLink);
            });
        }

        // Open article
        async function openArticle(articleId) {
            try {
                const doc = await db.collection('articles').doc(articleId).get();
                
                if (!doc.exists) {
                    showNotification('Article not found', 'error');
                    return;
                }

                const article = doc.data();
                
                if (article.status !== 'approved') {
                    showNotification('Article is not available', 'warning');
                    return;
                }

                // Update view count
                try {
                    await db.collection('articles').doc(articleId).update({
                        viewCount: firebase.firestore.FieldValue.increment(1),
                        lastViewed: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating view count:', error);
                }

                hideAllPages();
                document.getElementById('articleReader').style.display = 'block';
                
                // Update comprehensive SEO metadata for article
                const canonicalUrl = `https://forbiary.com/#${articleId}`;
                updatePageMetadata(
                    article.seoTitle || `${article.title} - Forbiary Knowledge Platform`,
                    article.seoDescription || article.summary,
                    article.seoKeywords || article.tags.join(', '),
                    canonicalUrl,
                    article // Pass full article data for enhanced metadata
                );
                
                // Generate structured data
                generateArticleStructuredData(article, articleId);
                
                const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';
                const tagsHtml = article.tags.map(tag => 
                    `<span class="inline-block bg-gray-100 text-gray-800 text-sm px-3 py-1 rounded-full mr-2">${tag}</span>`
                ).join('');

                const featuredImageHtml = article.featuredImage ? 
                    `<div style="margin: 20px 0; text-align: center;">
                        <img src="${article.featuredImage}" alt="Featured image for ${article.title}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;" onerror="this.style.display='none'">
                        <div style="font-size: 12px; color: #666; margin-top: 8px; font-style: italic;">Featured Image</div>
                    </div>` : '';

                const referencesHtml = article.references.length > 0 ? 
                    `<div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; margin: 30px 0; border-radius: 4px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333; border-bottom: 1px solid #a2a9b1; padding-bottom: 8px;">
                            <i class="fas fa-book" style="margin-right: 8px; color: #0645ad;"></i>References
                        </h3>
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${article.references.map((ref, index) => {
                                const isUrl = ref.match(/^https?:\/\/.+/);
                                const refContent = isUrl ? 
                                    `<a href="${ref}" target="_blank" rel="noopener noreferrer" style="color: #0645ad; text-decoration: none;">${ref}</a>` : 
                                    ref;
                                return `<li style="margin-bottom: 8px; font-size: 14px; color: #333;">${refContent}</li>`;
                            }).join('')}
                        </ol>
                    </div>` : '';

                const isLocked = article.locked || false;
                const editButton = !isLocked ? `<button onclick="showWrite('${articleId}')" class="wiki-edit-btn" style="float: right;"><i class="fas fa-edit"></i> Edit</button>` : 
                    `<span style="float: right; background: #dc3545; color: white; padding: 8px 16px; border-radius: 2px; font-size: 14px;"><i class="fas fa-lock"></i> Locked</span>`;
                
                const lockButton = (isAdmin || isModerator) ? 
                    `<button onclick="${isLocked ? 'unlockArticle' : 'lockArticle'}('${articleId}')" class="wiki-edit-btn" style="background: ${isLocked ? '#28a745' : '#dc3545'};">
                        <i class="fas fa-${isLocked ? 'unlock' : 'lock'}"></i> ${isLocked ? 'Unlock' : 'Lock'} Article
                    </button>` : '';

                const editHistoryHtml = article.editHistory && article.editHistory.length > 0 ? 
                    `<div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; margin: 20px 0; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Edit History</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${article.editHistory.slice(-10).reverse().map(edit => 
                                `<div style="padding: 5px 0; border-bottom: 1px solid #eee; font-size: 14px;">
                                    <strong>${edit.editor}</strong> - ${edit.editSummary || 'No summary'} 
                                    <span style="color: #666;">(${edit.timestamp ? new Date(edit.timestamp.toDate()).toLocaleDateString() : 'Recently'})</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>` : '';

                // Generate related articles
                const relatedArticlesHtml = await generateRelatedArticles(article, articleId);
                
                document.getElementById('articleContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        ${editButton}
                        <div class="article-meta">
                            <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-size: 14px;">${article.category}</span>
                            ${isLocked ? '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 3px; font-size: 14px; margin-left: 8px;"><i class="fas fa-lock"></i> Locked</span>' : ''}
                        </div>
                        <h1>${article.title}</h1>
                        <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                            ${date}
                        </div>
                        <p style="font-size: 16px; color: #333; margin-bottom: 20px; font-style: italic;">${article.summary}</p>
                        <div style="margin-bottom: 20px;">${tagsHtml}</div>
                        ${featuredImageHtml}
                    </div>
                    
                    <div style="line-height: 1.6; margin-bottom: 30px;">
                        ${article.content}
                    </div>
                    
                    ${relatedArticlesHtml}
                    ${editHistoryHtml}
                    ${referencesHtml}
                    
                    <div class="edit-actions" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #a2a9b1;">
                        <button onclick="showHome()" class="wiki-edit-btn">
                            <i class="fas fa-arrow-left"></i> Back to Home
                        </button>
                        <button onclick="copyArticleLink('${articleId}')" class="wiki-edit-btn" style="background: #f8f9fa; color: #333;">
                            <i class="fas fa-share"></i> Share Article
                        </button>
                        ${!isLocked ? `<button onclick="showWrite('${articleId}')" class="wiki-edit-btn"><i class="fas fa-edit"></i> Edit Article</button>` : ''}
                        ${lockButton}
                    </div>
                `;

                window.location.hash = articleId;
            } catch (error) {
                console.error('Error loading article:', error);
                alert('Error loading article');
            }
        }

        // Generate related articles
        async function generateRelatedArticles(currentArticle, currentArticleId) {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .where('category', '==', currentArticle.category)
                    .limit(10)
                    .get();

                let relatedArticles = [];
                snapshot.forEach(doc => {
                    if (doc.id !== currentArticleId) {
                        const article = doc.data();
                        // Calculate relevance based on shared tags
                        const sharedTags = currentArticle.tags.filter(tag => 
                            article.tags.some(articleTag => articleTag.toLowerCase() === tag.toLowerCase())
                        );
                        
                        if (sharedTags.length > 0 || article.category === currentArticle.category) {
                            relatedArticles.push({
                                id: doc.id,
                                ...article,
                                relevance: sharedTags.length
                            });
                        }
                    }
                });

                // Sort by relevance and take top 5
                relatedArticles.sort((a, b) => b.relevance - a.relevance);
                relatedArticles = relatedArticles.slice(0, 5);

                if (relatedArticles.length === 0) {
                    return '';
                }

                const relatedHtml = relatedArticles.map(article => 
                    `<div style="margin-bottom: 8px;">
                        <a href="#" onclick="openArticle('${article.id}')" class="internal-link" style="font-size: 14px;">${article.title}</a>
                        <div style="font-size: 12px; color: #666;">${article.summary.substring(0, 100)}...</div>
                    </div>`
                ).join('');

                return `
                    <div class="related-articles">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px;">Related Articles</h3>
                        ${relatedHtml}
                    </div>
                `;
            } catch (error) {
                console.error('Error generating related articles:', error);
                return '';
            }
        }

        // Copy article link
        function copyArticleLink(articleId) {
            const link = `${window.location.origin}${window.location.pathname}#${articleId}`;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('Article link copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy link to clipboard', 'error');
            });
        }

        // Lock article
        async function lockArticle(articleId) {
            if (!isAdmin && !isModerator) {
                showNotification('Only moderators can lock articles', 'warning');
                return;
            }

            const confirmLock = await showConfirmDialog(
                'Lock Article', 
                'Are you sure you want to lock this article? This will prevent all users from editing it.',
                'Lock Article',
                'Cancel'
            );
            
            if (confirmLock) {
                try {
                    const currentTime = new Date();
                    await db.collection('articles').doc(articleId).update({
                        locked: true,
                        lockedBy: currentUser.displayName,
                        lockedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('Article locked successfully!', 'success');
                    openArticle(articleId); // Refresh the article view
                } catch (error) {
                    showNotification('Error locking article: ' + error.message, 'error');
                }
            }
        }

        // Unlock article
        async function unlockArticle(articleId) {
            if (!isAdmin && !isModerator) {
                showNotification('Only moderators can unlock articles', 'warning');
                return;
            }

            const confirmUnlock = await showConfirmDialog(
                'Unlock Article', 
                'Are you sure you want to unlock this article? This will allow users to edit it again.',
                'Unlock Article',
                'Cancel'
            );
            
            if (confirmUnlock) {
                try {
                    const currentTime = new Date();
                    await db.collection('articles').doc(articleId).update({
                        locked: false,
                        unlockedBy: currentUser.displayName,
                        unlockedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('Article unlocked successfully!', 'success');
                    openArticle(articleId); // Refresh the article view
                } catch (error) {
                    showNotification('Error unlocking article: ' + error.message, 'error');
                }
            }
        }

        // Load recent articles for moderators
        async function loadRecentArticlesForModerators() {
            if (!isAdmin && !isModerator) return;

            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                const container = document.getElementById('recentArticlesList');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No recent articles.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const article = doc.data();
                    const articleCard = createModeratorReviewCard(doc.id, article);
                    container.appendChild(articleCard);
                });
            } catch (error) {
                console.error('Error loading recent articles:', error);
            }
        }

        // Load moderator notifications
        async function loadModeratorNotifications() {
            if (!isAdmin && !isModerator) return;

            try {
                const snapshot = await db.collection('moderatorNotifications')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();

                const container = document.getElementById('moderatorNotifications');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No notifications.</p>';
                    return;
                }

                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const notification = doc.data();
                    if (!notification.read) unreadCount++;
                    
                    const notificationCard = createNotificationCard(doc.id, notification);
                    container.appendChild(notificationCard);
                });

                // Update notification badge
                const badge = document.getElementById('notificationBadge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Load moderator suggestions
        async function loadModeratorSuggestions() {
            if (!currentUser || (!isAdmin && !isModerator)) return;

            try {
                const snapshot = await db.collection('moderatorSuggestions')
                    .where('moderatorId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .get();

                const container = document.getElementById('moderatorSuggestions');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">You haven\'t made any suggestions yet.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const suggestion = doc.data();
                    const suggestionCard = createSuggestionCard(doc.id, suggestion);
                    container.appendChild(suggestionCard);
                });
            } catch (error) {
                console.error('Error loading suggestions:', error);
            }
        }

        // Create moderator review card for recent articles
        function createModeratorReviewCard(id, article) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; margin-bottom: 20px;';

            const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';
            const timeAgo = article.timestamp ? getTimeAgo(article.timestamp.toDate()) : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">
                            <a href="#" onclick="openArticle('${id}')" style="color: #0645ad; text-decoration: none;">${article.title}</a>
                        </h3>
                        <p style="margin: 0 0 8px 0; color: #666; line-height: 1.4;">${article.summary}</p>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <span>By <strong>${article.author}</strong> • ${timeAgo} • ${article.category}</span>
                            ${article.viewCount ? ` • ${article.viewCount} views` : ''}
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            <strong>SEO Keywords:</strong> ${article.seoKeywords || 'Auto-generated'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="suggestImprovement('${id}')" class="wiki-edit-btn" style="background: #17a2b8;">
                            <i class="fas fa-lightbulb"></i> Suggest
                        </button>
                        <button onclick="deleteArticle('${id}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button onclick="openArticle('${id}')" class="wiki-edit-btn" style="background: #6c757d;">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Create notification card
        function createNotificationCard(id, notification) {
            const card = document.createElement('div');
            const isUnread = !notification.read;
            card.style.cssText = `background: ${isUnread ? '#fff3cd' : '#f8f9fa'}; border: 1px solid ${isUnread ? '#ffeaa7' : '#a2a9b1'}; padding: 15px; border-radius: 4px; margin-bottom: 15px;`;

            const date = notification.timestamp ? new Date(notification.timestamp.toDate()).toLocaleDateString() : 'Recently';
            const timeAgo = notification.timestamp ? getTimeAgo(notification.timestamp.toDate()) : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="font-size: 16px; color: #333; margin-bottom: 5px;">
                            ${isUnread ? '<strong>' : ''}${notification.message}${isUnread ? '</strong>' : ''}
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            ${timeAgo} • ${notification.type === 'new_article' ? 'New Article' : 'Notification'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${notification.articleId ? `<button onclick="openArticle('${notification.articleId}')" class="wiki-edit-btn" style="background: #6c757d; font-size: 12px; padding: 4px 8px;">View</button>` : ''}
                        ${isUnread ? `<button onclick="markNotificationRead('${id}')" class="wiki-edit-btn" style="background: #28a745; font-size: 12px; padding: 4px 8px;">Mark Read</button>` : ''}
                    </div>
                </div>
            `;

            return card;
        }

        // Create suggestion card
        function createSuggestionCard(id, suggestion) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; border-radius: 4px; margin-bottom: 15px;';

            const date = suggestion.timestamp ? new Date(suggestion.timestamp.toDate()).toLocaleDateString() : 'Recently';
            const timeAgo = suggestion.timestamp ? getTimeAgo(suggestion.timestamp.toDate()) : 'Recently';

            const statusColor = suggestion.status === 'implemented' ? '#28a745' : 
                               suggestion.status === 'rejected' ? '#dc3545' : '#ffc107';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="font-size: 16px; color: #333; margin-bottom: 5px;">
                            <strong>${suggestion.type === 'improvement' ? 'Improvement' : 'Deletion'} Suggestion</strong>
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            Article: <a href="#" onclick="openArticle('${suggestion.articleId}')" style="color: #0645ad;">${suggestion.articleTitle}</a>
                        </div>
                        <div style="font-size: 14px; color: #333; margin-bottom: 8px;">
                            ${suggestion.suggestion}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ${timeAgo} • Status: <span style="color: ${statusColor}; font-weight: bold;">${suggestion.status.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // Get time ago helper
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        // Create moderation card
        function createModerationCard(id, article) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; margin-bottom: 20px;';

            const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">${article.title}</h3>
                        <p style="margin: 0 0 8px 0; color: #666; line-height: 1.4;">${article.summary}</p>
                        <div style="font-size: 14px; color: #666;">
                            <span>By <strong>${article.author}</strong> • ${date} • ${article.category}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="approveArticle('${id}')" class="wiki-edit-btn" style="background: #28a745;">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button onclick="rejectArticle('${id}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
                <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">Article Content Preview:</h4>
                    <div style="max-height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.6; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                        ${article.content.length > 1500 ? article.content.substring(0, 1500) + '...<br><br><em style="color: #666;">[Content truncated - Full article available after approval]</em>' : article.content}
                    </div>
                </div>
            `;

            return card;
        }

        // Approve article
        async function approveArticle(articleId) {
            if (!isAdmin && !isModerator) return;

            try {
                await db.collection('articles').doc(articleId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: currentUser.displayName
                });
                
                showNotification('Article approved successfully!', 'success');
                loadPendingArticles();
            } catch (error) {
                showNotification('Error approving article: ' + error.message, 'error');
            }
        }

        // Reject article
        async function rejectArticle(articleId) {
            if (!isAdmin && !isModerator) return;

            const confirmReject = await showConfirmDialog(
                'Reject Article', 
                'Are you sure you want to reject this article?',
                'Reject',
                'Cancel'
            );
            
            if (confirmReject) {
                try {
                    await db.collection('articles').doc(articleId).update({
                        status: 'rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rejectedBy: currentUser.displayName
                    });
                    
                    showNotification('Article rejected', 'info');
                    loadPendingArticles();
                } catch (error) {
                    showNotification('Error rejecting article: ' + error.message, 'error');
                }
            }
        }

        // Load category counts
        async function loadCategoryCounts() {
            const categories = ['Technology', 'Business', 'Science', 'History', 'Health', 'Education'];
            
            for (const category of categories) {
                try {
                    const snapshot = await db.collection('articles')
                        .where('status', '==', 'approved')
                        .where('category', '==', category)
                        .get();
                    
                    const count = snapshot.size;
                    const elementId = category.toLowerCase() + 'Count';
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `${count} article${count !== 1 ? 's' : ''}`;
                    }
                } catch (error) {
                    console.error(`Error loading ${category} count:`, error);
                    const elementId = category.toLowerCase() + 'Count';
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = 'Error loading count';
                    }
                }
            }
        }

        // Load pending edits
        async function loadPendingEdits() {
            if (!isAdmin && !isModerator) return;

            try {
                const snapshot = await db.collection('edits')
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();

                const container = document.getElementById('pendingEditsList');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No pending edits.</p>';
                    return;
                }

                for (const doc of snapshot.docs) {
                    const edit = doc.data();
                    const editCard = await createEditCard(doc.id, edit);
                    container.appendChild(editCard);
                }
            } catch (error) {
                console.error('Error loading pending edits:', error);
            }
        }

        // Create edit card
        async function createEditCard(editId, edit) {
            const card = document.createElement('div');
            card.className = 'pending-edit';

            // Get original article
            let originalArticle = null;
            try {
                const articleDoc = await db.collection('articles').doc(edit.articleId).get();
                originalArticle = articleDoc.exists ? articleDoc.data() : null;
            } catch (error) {
                console.error('Error loading original article:', error);
            }

            const date = edit.timestamp ? new Date(edit.timestamp.toDate()).toLocaleDateString() : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px;">${edit.title}</h3>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            Edited by <strong>${edit.editor}</strong> • ${date}
                            ${edit.editorIP ? ` • IP: ${edit.editorIP}` : ''}
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <strong>Edit Summary:</strong> ${edit.editSummary || 'No summary provided'}
                        </div>
                        ${originalArticle ? `<div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <strong>Original Article:</strong> <a href="#" onclick="openArticle('${edit.articleId}')" style="color: #0645ad;">${originalArticle.title}</a>
                        </div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="approveEdit('${editId}')" class="wiki-edit-btn" style="background: #28a745;">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button onclick="rejectEdit('${editId}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        ${edit.editorIP && edit.editorIP !== 'unknown' ? `<button onclick="banIP('${edit.editorIP}', 'False information in edit')" class="wiki-edit-btn" style="background: #6c757d;">
                            <i class="fas fa-ban"></i> Ban IP
                        </button>` : ''}
                    </div>
                </div>
                <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">Edited Content Preview:</h4>
                    <div style="max-height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.6; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                        ${edit.content.length > 1500 ? edit.content.substring(0, 1500) + '...<br><br><em style="color: #666;">[Content truncated - Full content available after approval]</em>' : edit.content}
                    </div>
                </div>
            `;

            return card;
        }

        // Approve edit
        async function approveEdit(editId) {
            if (!isAdmin && !isModerator) return;

            try {
                const editDoc = await db.collection('edits').doc(editId).get();
                if (!editDoc.exists) return;

                const edit = editDoc.data();

                // Update the original article
                await db.collection('articles').doc(edit.articleId).update({
                    title: edit.title,
                    summary: edit.summary,
                    category: edit.category,
                    tags: edit.tags,
                    references: edit.references,
                    content: edit.content,
                    lastEditedBy: edit.editor,
                    lastEditedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    editHistory: firebase.firestore.FieldValue.arrayUnion({
                        editor: edit.editor,
                        editSummary: edit.editSummary,
                        timestamp: edit.timestamp
                    })
                });

                // Mark edit as approved
                await db.collection('edits').doc(editId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: currentUser.displayName
                });

                showNotification('Edit approved successfully!', 'success');
                loadPendingEdits();
            } catch (error) {
                showNotification('Error approving edit: ' + error.message, 'error');
            }
        }

        // Reject edit
        async function rejectEdit(editId) {
            if (!isAdmin && !isModerator) return;

            const confirmReject = await showConfirmDialog(
                'Reject Edit', 
                'Are you sure you want to reject this edit?',
                'Reject',
                'Cancel'
            );
            
            if (confirmReject) {
                try {
                    await db.collection('edits').doc(editId).update({
                        status: 'rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rejectedBy: currentUser.displayName
                    });

                    showNotification('Edit rejected', 'info');
                    loadPendingEdits();
                } catch (error) {
                    showNotification('Error rejecting edit: ' + error.message, 'error');
                }
            }
        }

        // Suggest improvement for article
        async function suggestImprovement(articleId) {
            if (!currentUser || (!isAdmin && !isModerator)) return;

            const suggestion = prompt('Enter your suggestion for improving this article:');
            if (!suggestion || !suggestion.trim()) return;

            try {
                const articleDoc = await db.collection('articles').doc(articleId).get();
                const article = articleDoc.data();
                const currentTime = new Date();

                await db.collection('moderatorSuggestions').add({
                    articleId: articleId,
                    articleTitle: article.title,
                    moderatorId: currentUser.uid,
                    moderatorName: currentUser.displayName,
                    type: 'improvement',
                    suggestion: suggestion.trim(),
                    status: 'pending',
                    timestamp: firebase.firestore.Timestamp.fromDate(currentTime)
                });

                showNotification('Suggestion submitted successfully!', 'success');
            } catch (error) {
                showNotification('Error submitting suggestion: ' + error.message, 'error');
            }
        }

        // Delete article
        async function deleteArticle(articleId) {
            if (!currentUser || (!isAdmin && !isModerator)) return;

            const reason = prompt('Enter reason for deleting this article (required):');
            if (!reason || !reason.trim()) return;

            const confirmDelete = await showConfirmDialog(
                'Delete Article', 
                'Are you sure you want to delete this article? This action cannot be undone.',
                'Delete',
                'Cancel'
            );
            
            if (confirmDelete) {
                try {
                    const articleDoc = await db.collection('articles').doc(articleId).get();
                    const article = articleDoc.data();
                    const currentTime = new Date();

                    // Log the deletion
                    await db.collection('moderatorSuggestions').add({
                        articleId: articleId,
                        articleTitle: article.title,
                        moderatorId: currentUser.uid,
                        moderatorName: currentUser.displayName,
                        type: 'deletion',
                        suggestion: reason.trim(),
                        status: 'implemented',
                        timestamp: firebase.firestore.Timestamp.fromDate(currentTime)
                    });

                    // Delete the article
                    await db.collection('articles').doc(articleId).delete();

                    showNotification('Article deleted successfully!', 'success');
                    loadRecentArticlesForModerators();
                } catch (error) {
                    showNotification('Error deleting article: ' + error.message, 'error');
                }
            }
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                await db.collection('moderatorNotifications').doc(notificationId).update({
                    read: true,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                loadModeratorNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Handle URL hash for direct article links
        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                openArticle(hash);
            } else {
                showHome();
            }
        }

        // No demo articles - only show real user-created articles

        // Load user profile with comprehensive points system
        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                showNotification('Loading your profile...', 'info', 2000);

                // Get user's articles from both Firestore and localStorage
                let articlesData = [];
                
                // Try Firestore first
                try {
                    const articlesSnapshot = await db.collection('articles')
                        .where('uid', '==', currentUser.uid)
                        .get();
                    
                    articlesSnapshot.forEach(doc => {
                        articlesData.push({ id: doc.id, ...doc.data() });
                    });
                } catch (firestoreError) {
                    console.warn('Firestore unavailable, using localStorage:', firestoreError);
                }

                // Fallback to localStorage if Firestore fails or is empty
                if (articlesData.length === 0) {
                    const localArticles = JSON.parse(localStorage.getItem('collection_articles') || '[]');
                    articlesData = localArticles.filter(article => article.uid === currentUser.uid);
                }

                // Get user's edits
                let editsData = [];
                try {
                    const editsSnapshot = await db.collection('edits')
                        .where('editorUid', '==', currentUser.uid)
                        .get();
                    
                    editsSnapshot.forEach(doc => {
                        editsData.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    console.warn('Could not load edits from Firestore:', error);
                }

                // Calculate detailed statistics
                const stats = calculateDetailedStats(articlesData, editsData);
                
                // Get user's profile data or create default
                let profileData = {
                    joinedAt: currentUser.metadata.creationTime,
                    totalContributions: stats.totalArticles + stats.totalEdits,
                    points: stats.totalPoints,
                    lastActive: new Date().toISOString()
                };

                try {
                    const profileDoc = await db.collection('userProfiles').doc(currentUser.uid).get();
                    if (profileDoc.exists) {
                        profileData = { ...profileData, ...profileDoc.data() };
                    } else {
                        // Create profile document
                        await db.collection('userProfiles').doc(currentUser.uid).set({
                            ...profileData,
                            email: currentUser.email,
                            name: currentUser.displayName,
                            photoURL: currentUser.photoURL,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                } catch (error) {
                    console.warn('Could not access user profiles collection:', error);
                }

                // Update profile with latest stats
                try {
                    await db.collection('userProfiles').doc(currentUser.uid).update({
                        points: stats.totalPoints,
                        totalContributions: stats.totalArticles + stats.totalEdits,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        stats: {
                            articles: {
                                total: stats.totalArticles,
                                approved: stats.approvedArticles,
                                rejected: stats.rejectedArticles,
                                pending: stats.pendingArticles
                            },
                            edits: {
                                total: stats.totalEdits,
                                approved: stats.approvedEdits,
                                rejected: stats.rejectedEdits,
                                pending: stats.pendingEdits
                            }
                        }
                    });
                } catch (error) {
                    console.warn('Could not update profile stats:', error);
                }

                displayUserProfile(profileData, stats, articlesData, editsData);

            } catch (error) {
                console.error('Error loading user profile:', error);
                document.getElementById('profileContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>Error Loading Profile</h3>
                        <p>Unable to load your profile data. Please try refreshing the page.</p>
                        <button onclick="loadUserProfile()" class="wiki-edit-btn" style="margin-top: 15px;">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Calculate detailed user statistics and points with content change tracking
        function calculateDetailedStats(articlesData, editsData) {
            // Initialize counters
            let totalArticles = 0;
            let approvedArticles = 0;
            let rejectedArticles = 0;
            let pendingArticles = 0;
            let totalViews = 0;
            let contentAdditions = 0;
            let contentRemovals = 0;

            // Process articles
            articlesData.forEach(article => {
                totalArticles++;
                if (article.status === 'approved') {
                    approvedArticles++;
                    totalViews += article.viewCount || 0;
                } else if (article.status === 'rejected') {
                    rejectedArticles++;
                } else if (article.status === 'pending') {
                    pendingArticles++;
                }

                // Track content changes from edit history
                if (article.editHistory && article.editHistory.length > 0) {
                    article.editHistory.forEach(edit => {
                        if (edit.changesDetected) {
                            if (edit.changesDetected.content) {
                                // Simple heuristic: if content length increased, it's an addition
                                const currentLength = article.content ? article.content.length : 0;
                                const previousLength = edit.previousContent ? edit.previousContent.length : 0;
                                
                                if (currentLength > previousLength) {
                                    contentAdditions++;
                                } else if (currentLength < previousLength) {
                                    contentRemovals++;
                                }
                            }
                        }
                    });
                }
            });

            // Initialize edit counters
            let totalEdits = 0;
            let approvedEdits = 0;
            let rejectedEdits = 0;
            let pendingEdits = 0;

            // Process edits
            editsData.forEach(edit => {
                totalEdits++;
                if (edit.status === 'approved') {
                    approvedEdits++;
                } else if (edit.status === 'rejected') {
                    rejectedEdits++;
                } else if (edit.status === 'pending') {
                    pendingEdits++;
                }
            });

            // Calculate points with detailed breakdown including content change penalties
            const articlePoints = {
                approved: approvedArticles * 15,    // +15 for each approved article
                rejected: rejectedArticles * -8,    // -8 for each rejected article
                pending: pendingArticles * 2        // +2 for each pending article
            };

            const editPoints = {
                approved: approvedEdits * 8,        // +8 for each approved edit
                rejected: rejectedEdits * -3,       // -3 for each rejected edit
                pending: pendingEdits * 1           // +1 for each pending edit
            };

            // Content change penalties
            const contentChangePoints = {
                removals: contentRemovals * -2,     // -2 points for each content removal
                additions: contentAdditions * 1     // +1 point for each content addition
            };

            // Bonus points for high engagement
            const viewBonus = Math.floor(totalViews / 10); // +1 point for every 10 views
            const contributionBonus = totalArticles >= 5 ? 25 : 0; // +25 bonus for 5+ articles

            const totalPoints = 
                articlePoints.approved + 
                articlePoints.rejected + 
                articlePoints.pending +
                editPoints.approved + 
                editPoints.rejected + 
                editPoints.pending +
                contentChangePoints.removals +
                contentChangePoints.additions +
                viewBonus + 
                contributionBonus;

            return {
                totalArticles,
                approvedArticles,
                rejectedArticles,
                pendingArticles,
                totalEdits,
                approvedEdits,
                rejectedEdits,
                pendingEdits,
                totalViews,
                contentAdditions,
                contentRemovals,
                totalPoints,
                articlePoints,
                editPoints,
                contentChangePoints,
                viewBonus,
                contributionBonus,
                // Additional metrics
                successRate: totalArticles > 0 ? Math.round((approvedArticles / totalArticles) * 100) : 0,
                editSuccessRate: totalEdits > 0 ? Math.round((approvedEdits / totalEdits) * 100) : 0,
                averageViewsPerArticle: approvedArticles > 0 ? Math.round(totalViews / approvedArticles) : 0
            };
        }

        // Display enhanced user profile with detailed statistics
        function displayUserProfile(profileData, stats, articlesData, editsData) {
            const joinedDate = new Date(profileData.joinedAt).toLocaleDateString();
            const pointsColor = stats.totalPoints >= 0 ? '#007bff' : '#dc3545'; // Blue for positive, red for negative
            const pointsSign = stats.totalPoints >= 0 ? '+' : '';
            
            // Determine user level based on points
            const getUserLevel = (points) => {
                if (points >= 500) return { level: 'Expert', color: '#6f42c1', icon: 'fas fa-crown' };
                if (points >= 200) return { level: 'Advanced', color: '#fd7e14', icon: 'fas fa-star' };
                if (points >= 100) return { level: 'Intermediate', color: '#20c997', icon: 'fas fa-medal' };
                if (points >= 50) return { level: 'Contributor', color: '#0dcaf0', icon: 'fas fa-user-edit' };
                if (points >= 0) return { level: 'Beginner', color: '#6c757d', icon: 'fas fa-seedling' };
                return { level: 'Needs Improvement', color: '#dc3545', icon: 'fas fa-exclamation-triangle' };
            };

            const userLevel = getUserLevel(stats.totalPoints);

            const profileHTML = `
                <div class="profile-grid">
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #a2a9b1; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="position: relative; display: inline-block; margin-bottom: 15px;">
                                <img src="${currentUser.photoURL}" alt="Profile Photo" style="width: 90px; height: 90px; border-radius: 50%; border: 4px solid ${userLevel.color}; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <div style="position: absolute; bottom: -5px; right: -5px; background: ${userLevel.color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px;">
                                    <i class="${userLevel.icon}"></i>
                                </div>
                            </div>
                            <h2 style="margin: 0 0 5px 0; font-size: 26px; color: #333; font-weight: 600;">${currentUser.displayName}</h2>
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">${currentUser.email}</p>
                            <div style="margin-bottom: 15px;">
                                <span style="background: ${userLevel.color}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500;">
                                    <i class="${userLevel.icon}" style="margin-right: 5px;"></i>${userLevel.level}
                                </span>
                                ${isModerator ? '<span class="moderator-badge" style="margin-left: 8px;">Moderator</span>' : ''}
                            </div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border: 2px solid ${pointsColor}; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div style="font-size: 36px; font-weight: bold; color: ${pointsColor}; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ${pointsSign}${stats.totalPoints}
                            </div>
                            <div style="font-size: 14px; color: #666; font-weight: 500;">Contribution Points</div>
                            <div style="margin-top: 10px; font-size: 12px; color: #999;">
                                Success Rate: ${stats.successRate}% • Views: ${stats.totalViews}
                            </div>
                        </div>
                        
                        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                <i class="fas fa-info-circle" style="margin-right: 8px; color: #17a2b8;"></i>Profile Info
                            </h4>
                            <div style="font-size: 14px; color: #666; line-height: 1.6;">
                                <div style="margin-bottom: 8px;"><strong>Joined:</strong> ${joinedDate}</div>
                                <div style="margin-bottom: 8px;"><strong>Total Contributions:</strong> ${profileData.totalContributions}</div>
                                <div style="margin-bottom: 8px;"><strong>Article Success Rate:</strong> ${stats.successRate}%</div>
                                <div style="margin-bottom: 8px;"><strong>Edit Success Rate:</strong> ${stats.editSuccessRate}%</div>
                                <div><strong>Avg Views per Article:</strong> ${stats.averageViewsPerArticle}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin: 0 0 25px 0; font-size: 22px; color: #333; font-weight: 600;">
                            <i class="fas fa-chart-bar" style="margin-right: 10px; color: #007bff;"></i>Detailed Statistics
                        </h3>
                        
                        <div class="profile-stats-grid">
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%); border: 1px solid #a2a9b1; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 18px 0; font-size: 18px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                                    <i class="fas fa-file-alt" style="margin-right: 10px; color: #007bff;"></i>Articles
                                </h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                                    <span style="font-weight: 500;">Total:</span>
                                    <strong style="color: #333;">${stats.totalArticles}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; background: rgba(40, 167, 69, 0.1); border-radius: 6px;">
                                    <span style="color: #28a745; font-weight: 500;">✓ Approved:</span>
                                    <strong style="color: #28a745;">${stats.approvedArticles} (+${stats.articlePoints.approved})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; background: rgba(220, 53, 69, 0.1); border-radius: 6px;">
                                    <span style="color: #dc3545; font-weight: 500;">✗ Rejected:</span>
                                    <strong style="color: #dc3545;">${stats.rejectedArticles} (${stats.articlePoints.rejected})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 193, 7, 0.1); border-radius: 6px;">
                                    <span style="color: #ffc107; font-weight: 500;">⏳ Pending:</span>
                                    <strong style="color: #ffc107;">${stats.pendingArticles} (+${stats.articlePoints.pending})</strong>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%); border: 1px solid #a2a9b1; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 18px 0; font-size: 18px; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                                    <i class="fas fa-edit" style="margin-right: 10px; color: #28a745;"></i>Edits
                                </h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                                    <span style="font-weight: 500;">Total:</span>
                                    <strong style="color: #333;">${stats.totalEdits}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; background: rgba(40, 167, 69, 0.1); border-radius: 6px;">
                                    <span style="color: #28a745; font-weight: 500;">✓ Approved:</span>
                                    <strong style="color: #28a745;">${stats.approvedEdits} (+${stats.editPoints.approved})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; background: rgba(220, 53, 69, 0.1); border-radius: 6px;">
                                    <span style="color: #dc3545; font-weight: 500;">✗ Rejected:</span>
                                    <strong style="color: #dc3545;">${stats.rejectedEdits} (${stats.editPoints.rejected})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 193, 7, 0.1); border-radius: 6px;">
                                    <span style="color: #ffc107; font-weight: 500;">⏳ Pending:</span>
                                    <strong style="color: #ffc107;">${stats.pendingEdits} (+${stats.editPoints.pending})</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%); border: 1px solid #ced4da; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                            <h4 style="margin: 0 0 15px 0; font-size: 18px; color: #333; border-bottom: 2px solid #6c757d; padding-bottom: 10px;">
                                <i class="fas fa-calculator" style="margin-right: 10px; color: #6c757d;"></i>Points Breakdown
                            </h4>
                            <div style="font-size: 14px; color: #666; line-height: 1.8;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• Approved Articles (${stats.approvedArticles} × 15):</span>
                                    <span style="color: #28a745; font-weight: bold;">+${stats.articlePoints.approved}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• Rejected Articles (${stats.rejectedArticles} × -8):</span>
                                    <span style="color: #dc3545; font-weight: bold;">${stats.articlePoints.rejected}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• Pending Articles (${stats.pendingArticles} × 2):</span>
                                    <span style="color: #ffc107; font-weight: bold;">+${stats.articlePoints.pending}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• Approved Edits (${stats.approvedEdits} × 8):</span>
                                    <span style="color: #28a745; font-weight: bold;">+${stats.editPoints.approved}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• Rejected Edits (${stats.rejectedEdits} × -3):</span>
                                    <span style="color: #dc3545; font-weight: bold;">${stats.editPoints.rejected}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• Pending Edits (${stats.pendingEdits} × 1):</span>
                                    <span style="color: #ffc107; font-weight: bold;">+${stats.editPoints.pending}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• View Bonus (${stats.totalViews} views ÷ 10):</span>
                                    <span style="color: #17a2b8; font-weight: bold;">+${stats.viewBonus}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding: 6px 0; border-bottom: 1px solid #ddd;">
                                    <span>• Contribution Bonus (5+ articles):</span>
                                    <span style="color: #6f42c1; font-weight: bold;">+${stats.contributionBonus}</span>
                                </div>
                                <hr style="margin: 15px 0; border-color: #adb5bd;">
                                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; padding: 10px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                                    <span>Total Points:</span>
                                    <span style="color: ${pointsColor};">${pointsSign}${stats.totalPoints}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 35px;">
                    <h3 style="margin: 0 0 25px 0; font-size: 22px; color: #333; font-weight: 600;">
                        <i class="fas fa-history" style="margin-right: 10px; color: #17a2b8;"></i>Recent Activity
                    </h3>
                    <div id="recentActivity">
                        <div class="loading-spinner" style="margin: 20px auto; display: block;"></div>
                    </div>
                </div>
            `;

            document.getElementById('profileContent').innerHTML = profileHTML;
            
            // Load recent activity with the actual data
            loadUserRecentActivityWithData(articlesData, editsData);
        }

        // Load user's recent activity with enhanced display
        async function loadUserRecentActivityWithData(articlesData, editsData) {
            if (!currentUser) return;

            try {
                const activities = [];

                // Process articles data
                articlesData.forEach((article, index) => {
                    activities.push({
                        type: 'article',
                        title: article.title,
                        status: article.status,
                        timestamp: article.timestamp || article.createdAt,
                        id: article.id,
                        category: article.category,
                        viewCount: article.viewCount || 0,
                        summary: article.summary
                    });
                });

                // Process edits data
                editsData.forEach((edit, index) => {
                    activities.push({
                        type: 'edit',
                        title: edit.title,
                        status: edit.status,
                        timestamp: edit.timestamp,
                        articleId: edit.articleId,
                        editSummary: edit.editSummary
                    });
                });

                // Sort by timestamp (most recent first)
                activities.sort((a, b) => {
                    const aTime = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp)) : new Date(0);
                    const bTime = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp)) : new Date(0);
                    return bTime - aTime;
                });

                // Display activities
                const activityContainer = document.getElementById('recentActivity');
                if (activities.length === 0) {
                    activityContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                            <i class="fas fa-history" style="font-size: 48px; margin-bottom: 20px; color: #adb5bd;"></i>
                            <h4 style="margin: 0 0 10px 0; color: #6c757d;">No Recent Activity</h4>
                            <p style="margin: 0;">Start contributing by creating your first article!</p>
                            <button onclick="showWrite()" class="wiki-edit-btn" style="margin-top: 15px;">
                                <i class="fas fa-plus"></i> Create Article
                            </button>
                        </div>
                    `;
                    return;
                }

                const activityHTML = activities.slice(0, 15).map((activity, index) => {
                    const timeAgo = getTimeAgo(activity.timestamp ? (activity.timestamp.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp)) : new Date());
                    const statusColor = activity.status === 'approved' ? '#28a745' : 
                                       activity.status === 'rejected' ? '#dc3545' : '#ffc107';
                    const statusIcon = activity.status === 'approved' ? '✓' : 
                                      activity.status === 'rejected' ? '✗' : '⏳';
                    const statusBg = activity.status === 'approved' ? 'rgba(40, 167, 69, 0.1)' : 
                                    activity.status === 'rejected' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(255, 193, 7, 0.1)';

                    const pointsEarned = activity.type === 'article' ? 
                        (activity.status === 'approved' ? '+15' : activity.status === 'rejected' ? '-8' : '+2') :
                        (activity.status === 'approved' ? '+8' : activity.status === 'rejected' ? '-3' : '+1');

                    return `
                        <div style="background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border: 1px solid #dee2e6; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <div style="background: ${activity.type === 'article' ? '#007bff' : '#17a2b8'}; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <i class="fas fa-${activity.type === 'article' ? 'file-alt' : 'edit'}" style="font-size: 14px;"></i>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 2px;">
                                                ${activity.type === 'article' ? 'Created Article' : 'Edited Article'}
                                            </div>
                                            <div style="font-size: 12px; color: #6c757d;">
                                                ${timeAgo} ${activity.category ? `• ${activity.category}` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <h4 style="margin: 0 0 6px 0; font-size: 18px; color: #333; line-height: 1.3;">
                                            ${activity.title}
                                        </h4>
                                        ${activity.summary ? `<p style="margin: 0; color: #666; font-size: 14px; line-height: 1.4;">${activity.summary.substring(0, 120)}${activity.summary.length > 120 ? '...' : ''}</p>` : ''}
                                        ${activity.editSummary ? `<p style="margin: 6px 0 0 0; color: #666; font-size: 14px;"><strong>Edit Summary:</strong> ${activity.editSummary}</p>` : ''}
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                        <div style="background: ${statusBg}; color: ${statusColor}; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; border: 1px solid ${statusColor};">
                                            ${statusIcon} ${activity.status.toUpperCase()}
                                        </div>
                                        <div style="color: ${statusColor}; font-size: 14px; font-weight: 600;">
                                            ${pointsEarned} points
                                        </div>
                                        ${activity.viewCount ? `<div style="color: #6c757d; font-size: 13px;"><i class="fas fa-eye" style="margin-right: 4px;"></i>${activity.viewCount} views</div>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    ${activity.type === 'article' && activity.id ? 
                                        `<button onclick="openArticle('${activity.id}')" class="wiki-edit-btn" style="font-size: 12px; padding: 6px 12px; background: #007bff;">
                                            <i class="fas fa-eye"></i> View
                                        </button>` : 
                                        activity.articleId ? 
                                        `<button onclick="openArticle('${activity.articleId}')" class="wiki-edit-btn" style="font-size: 12px; padding: 6px 12px; background: #007bff;">
                                            <i class="fas fa-eye"></i> View
                                        </button>` : ''
                                    }
                                    ${activity.type === 'article' && activity.status === 'approved' ? 
                                        `<button onclick="showWrite('${activity.id}')" class="wiki-edit-btn" style="font-size: 12px; padding: 6px 12px; background: #28a745;">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                activityContainer.innerHTML = activityHTML;

            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h4 style="margin: 0 0 10px 0;">Error Loading Activity</h4>
                        <p style="margin: 0;">Unable to load your recent activity. Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        // Fallback function for backward compatibility
        async function loadUserRecentActivity() {
            return loadUserRecentActivityWithData([], []);
        }

        // Initialize app
        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('load', () => {
            // Load articles for internal linking
            loadArticlesForLinking();
            
            if (window.location.hash) {
                handleHashChange();
            } else {
                showHome();
            }
        });

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchArticles();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'965b3a9650484049',t:'MTc1MzYwOTc4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

<style>
.trusted-badge {
    background-color: #0d6efd;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    margin-left: 5px;
}
</style>

<script>
// Placeholder AI Enhancer function
async function generateEnhancements(summary, title) {
    // Replace this logic with actual API call or AI logic
    return {
        enhancedTitle: title + " (Enhanced)",
        enhancedSummary: summary + " This is enhanced by AI.",
        suggestedReferences: ["https://example.com/ref1", "https://example.com/ref2"]
    };
}
</script>

<script>
// Title change review logic
function checkTitleChange(originalTitle, newTitle) {
    if (!isAdmin && !isModerator && originalTitle !== newTitle) {
        showNotification('Your title change will be reviewed.', 'info');
        return 'pending_review';
    }
    return 'approved';
}
</script>

<script>
function autoLinkKeywords(content) {
    return content.replace(/Gursharn Arya/g, '<a class="internal-link" href="/article/gursharn-arya">Gursharn Arya</a>');
}
</script>
