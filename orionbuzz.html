<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Pulse - Social Media Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(45deg, #fce7f3 0%, #ddd6fe 25%, #bfdbfe 50%, #a7f3d0 75%, #fed7d7 100%);
        }
        .pulse-shadow {
            box-shadow: 0 4px 15px rgba(147, 197, 253, 0.3);
        }
        .buzz-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .avatar-letter {
            background: linear-gradient(135deg, #f472b6 0%, #60a5fa 100%);
        }
        .mobile-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #f472b6 0%, #60a5fa 100%);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #ec4899 0%, #3b82f6 100%);
        }
        .verified-tick {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: linear-gradient(45deg, #1DA1F2, #0084b4);
            border-radius: 50%;
            position: relative;
            margin-left: 4px;
        }
        .verified-tick::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        .hashtag {
            color: #1DA1F2;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        .hashtag:hover {
            text-decoration: underline;
        }
        .mention {
            color: #1DA1F2;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        .mention:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-50 to-blue-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold bg-gradient-to-r from-pink-500 to-blue-500 bg-clip-text text-transparent mb-2">Pulse</h1>
                <p class="text-gray-600">Connect with the world through Buzz</p>
            </div>
            <button id="googleSignIn" class="w-full bg-white border-2 border-gray-200 rounded-xl py-3 px-4 flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Setup Screens -->
    <div id="nameSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">What's your name?</h2>
            <input type="text" id="fullName" placeholder="Enter your full name" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 focus:border-pink-400 outline-none">
            <button id="nameNext" class="w-full btn-primary text-white py-3 rounded-xl font-semibold">Next</button>
        </div>
    </div>

    <div id="usernameSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">Choose a username</h2>
            <input type="text" id="username" placeholder="username123" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-2 focus:border-pink-400 outline-none">
            <p class="text-sm text-gray-500 mb-4">Only lowercase letters and numbers</p>
            <div id="usernameError" class="text-red-500 text-sm mb-4 hidden"></div>
            <button id="usernameNext" class="w-full btn-primary text-white py-3 rounded-xl font-semibold">Next</button>
        </div>
    </div>

    <div id="dobSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">Date of Birth</h2>
            <input type="date" id="dateOfBirth" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 focus:border-pink-400 outline-none">
            <button id="dobNext" class="w-full btn-primary text-white py-3 rounded-xl font-semibold mb-3">Next</button>
            <button id="dobSkip" class="w-full border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold">Skip</button>
        </div>
    </div>

    <div id="bioSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">Add Bio</h2>
            <textarea id="userBio" placeholder="Tell us about yourself..." class="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 focus:border-pink-400 outline-none resize-none" rows="4"></textarea>
            <button id="bioNext" class="w-full btn-primary text-white py-3 rounded-xl font-semibold mb-3">Next</button>
            <button id="bioSkip" class="w-full border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold">Skip</button>
        </div>
    </div>

    <div id="profilePicSetup" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md pulse-shadow">
            <h2 class="text-2xl font-bold text-center mb-6">Profile Picture</h2>
            <div class="flex justify-center mb-6">
                <div id="previewAvatar" class="w-24 h-24 rounded-full avatar-letter flex items-center justify-center text-white text-2xl font-bold"></div>
            </div>
            <input type="file" id="profilePicInput" accept="image/*" class="hidden">
            <button id="uploadPic" class="w-full btn-primary text-white py-3 rounded-xl font-semibold mb-3">Upload Photo</button>
            <button id="picSkip" class="w-full border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold">Skip</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-white/80 backdrop-blur-md border-b border-pink-100 sticky top-0 z-50">
            <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-2xl font-bold bg-gradient-to-r from-pink-500 to-blue-500 bg-clip-text text-transparent">Pulse</h1>
                <div class="flex gap-4">
                    <button id="notificationBtn" class="relative p-2">
                        <span class="text-xl">üîî</span>
                        <div id="notificationDot" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></div>
                    </button>
                    <button id="messageBtn" class="p-2">
                        <span class="text-xl">üí¨</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Edit Profile Modal -->
        <div id="editProfileModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold mb-4">Edit Profile</h3>
                <div class="space-y-4">
                    <div class="flex justify-center mb-4">
                        <div id="editAvatar" class="w-20 h-20 rounded-full avatar-letter flex items-center justify-center text-white text-xl font-bold cursor-pointer"></div>
                    </div>
                    <input type="file" id="editProfilePicInput" accept="image/*" class="hidden">
                    <input type="text" id="editFullName" placeholder="Full Name" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 outline-none">
                    <textarea id="editBio" placeholder="Bio" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 outline-none resize-none" rows="3"></textarea>
                    <div class="flex gap-3">
                        <button id="saveProfile" class="flex-1 btn-primary text-white py-3 rounded-xl font-semibold">Save</button>
                        <button id="cancelEdit" class="flex-1 border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verification Request Modal -->
        <div id="verificationModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">Request Verification</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Full Name (as on National ID)</label>
                        <input type="text" id="verifyFullName" placeholder="Enter your full name" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Why do you think you deserve verification?</label>
                        <textarea id="verifyReason" placeholder="Explain why you should be verified..." class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none resize-none" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Other name you're known by (Optional)</label>
                        <input type="text" id="verifyOtherName" placeholder="Stage name, business name, etc." class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Country</label>
                        <select id="verifyCountry" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none">
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="IN">India</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                        </select>
                    </div>
                    
                    <div id="documentTypeDiv" class="hidden">
                        <label class="block text-sm font-medium mb-2">Document Type</label>
                        <select id="verifyDocType" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none">
                            <option value="">Select Document Type</option>
                        </select>
                    </div>
                    
                    <div id="documentUploadDiv" class="hidden">
                        <label class="block text-sm font-medium mb-2">Upload Document</label>
                        <input type="file" id="verifyDocument" accept="image/*" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Social Media Links (Optional - Max 5)</label>
                        <div id="socialLinksContainer">
                            <input type="url" class="social-link w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none mb-2" placeholder="Instagram, Facebook, YouTube, News links, etc.">
                        </div>
                        <button type="button" id="addSocialLink" class="text-blue-500 text-sm">+ Add another link</button>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="submitVerification" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold">Submit Request</button>
                        <button id="cancelVerification" class="flex-1 border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Screen -->
        <div id="searchScreen" class="hidden bg-white min-h-screen">
            <div class="max-w-md mx-auto p-4">
                <div class="flex items-center gap-3 mb-4">
                    <button id="backToHome" class="p-2">
                        <span class="text-xl">‚¨ÖÔ∏è</span>
                    </button>
                    <input type="text" id="searchInput" placeholder="Search users, buzzes, hashtags..." class="flex-1 p-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 outline-none">
                </div>
                
                <!-- Search Tabs -->
                <div class="flex gap-2 mb-4">
                    <button id="usersTab" class="flex-1 py-2 px-4 bg-pink-500 text-white rounded-lg font-semibold">Users</button>
                    <button id="buzzesTab" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg font-semibold">Buzzes</button>
                    <button id="hashtagsTab" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg font-semibold">Hashtags</button>
                </div>
                
                <div id="searchResults" class="space-y-3"></div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profileScreen" class="hidden bg-white min-h-screen">
            <div class="max-w-md mx-auto">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center gap-3 mb-4">
                        <button id="backFromProfile" class="p-2">
                            <span class="text-xl">‚¨ÖÔ∏è</span>
                        </button>
                        <h2 class="text-xl font-bold">Profile</h2>
                    </div>
                    <div id="profileInfo" class="text-center">
                        <!-- Profile info will be loaded here -->
                    </div>
                </div>
                <div id="userBuzzes" class="pb-20">
                    <!-- User's buzzes will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden bg-white min-h-screen">
            <div class="max-w-md mx-auto p-4">
                <div class="flex items-center gap-3 mb-6">
                    <button id="backFromSettings" class="p-2">
                        <span class="text-xl">‚¨ÖÔ∏è</span>
                    </button>
                    <h2 class="text-xl font-bold">Settings</h2>
                </div>
                <div class="space-y-4">
                    <button id="verificationBtn" class="w-full p-4 bg-blue-50 rounded-xl text-left">
                        <span>‚úÖ Request Verification</span>
                    </button>
                    <button id="privateAccountBtn" class="w-full p-4 bg-gray-50 rounded-xl text-left flex items-center justify-between">
                        <span>üîí Private Account</span>
                        <span id="privateStatus" class="text-sm text-gray-500">Off</span>
                    </button>
                    <button id="privacyBtn" class="w-full p-4 bg-gray-50 rounded-xl text-left">
                        <span>üõ°Ô∏è Privacy Settings</span>
                    </button>
                    <button id="blockListBtn" class="w-full p-4 bg-gray-50 rounded-xl text-left">
                        <span>üö´ Blocked Users</span>
                    </button>
                    <button id="helpCenterBtn" class="w-full p-4 bg-green-50 rounded-xl text-left">
                        <span>‚ùì Help Center</span>
                    </button>
                    <button id="addAccountBtn" class="w-full p-4 bg-gray-50 rounded-xl text-left">
                        <span>‚ûï Add Account</span>
                    </button>
                    <button id="logoutBtn" class="w-full p-4 bg-red-50 text-red-600 rounded-xl text-left">
                        <span>üö™ Logout</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Notifications Screen -->
        <div id="notificationsScreen" class="hidden bg-white min-h-screen">
            <div class="max-w-md mx-auto p-4">
                <div class="flex items-center gap-3 mb-6">
                    <button id="backFromNotifications" class="p-2">
                        <span class="text-xl">‚¨ÖÔ∏è</span>
                    </button>
                    <h2 class="text-xl font-bold">Notifications</h2>
                </div>
                <div id="notificationsList" class="space-y-3">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Messages Screen -->
        <div id="messagesScreen" class="hidden bg-white min-h-screen">
            <div class="max-w-md mx-auto p-4">
                <div class="flex items-center gap-3 mb-6">
                    <button id="backFromMessages" class="p-2">
                        <span class="text-xl">‚¨ÖÔ∏è</span>
                    </button>
                    <h2 class="text-xl font-bold">Messages</h2>
                </div>
                <div id="messagesList" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">Messages feature coming soon!</p>
                </div>
            </div>
        </div>

        <!-- Hashtag Screen -->
        <div id="hashtagScreen" class="hidden bg-white min-h-screen">
            <div class="max-w-md mx-auto p-4">
                <div class="flex items-center gap-3 mb-6">
                    <button id="backFromHashtag" class="p-2">
                        <span class="text-xl">‚¨ÖÔ∏è</span>
                    </button>
                    <h2 id="hashtagTitle" class="text-xl font-bold">#hashtag</h2>
                </div>
                <div id="hashtagStats" class="bg-gray-50 rounded-xl p-4 mb-4">
                    <div class="flex justify-between">
                        <div class="text-center">
                            <p id="hashtagPostCount" class="font-bold text-lg">0</p>
                            <p class="text-gray-500 text-sm">Posts</p>
                        </div>
                        <div class="text-center">
                            <p id="hashtagUserCount" class="font-bold text-lg">0</p>
                            <p class="text-gray-500 text-sm">Users</p>
                        </div>
                    </div>
                </div>
                <div id="hashtagPosts" class="space-y-3">
                    <!-- Hashtag posts will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Help Center Screen -->
        <div id="helpCenterScreen" class="hidden bg-white min-h-screen">
            <div class="max-w-md mx-auto p-4">
                <div class="flex items-center gap-3 mb-6">
                    <button id="backFromHelp" class="p-2">
                        <span class="text-xl">‚¨ÖÔ∏è</span>
                    </button>
                    <h2 class="text-xl font-bold">Help Center</h2>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h3 class="font-bold mb-2">üì± Getting Started</h3>
                        <p class="text-gray-600 text-sm">Learn how to use Pulse and create your first buzz</p>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h3 class="font-bold mb-2">üîí Privacy & Safety</h3>
                        <p class="text-gray-600 text-sm">Manage your privacy settings and stay safe</p>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h3 class="font-bold mb-2">‚úÖ Verification</h3>
                        <p class="text-gray-600 text-sm">How to get verified on Pulse</p>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h3 class="font-bold mb-2">üö´ Report Issues</h3>
                        <p class="text-gray-600 text-sm">Report bugs, spam, or inappropriate content</p>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h3 class="font-bold mb-2">üìû Contact Support</h3>
                        <p class="text-gray-600 text-sm">Get in touch with our support team</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="homeContent" class="max-w-md mx-auto">
            <!-- Create Buzz -->
            <div class="bg-white/80 backdrop-blur-md border-b border-pink-100 p-4">
                <div class="flex gap-3">
                    <div id="userAvatar" class="w-10 h-10 rounded-full avatar-letter flex items-center justify-center text-white font-bold text-sm"></div>
                    <div class="flex-1">
                        <div class="relative">
                            <textarea id="buzzText" placeholder="What's buzzing?" class="w-full resize-none border-none outline-none text-lg bg-transparent" rows="3"></textarea>
                            <div id="suggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto z-10"></div>
                        </div>
                        <div class="flex items-center justify-between mt-3">
                            <div class="flex gap-3">
                                <button id="addImage" class="p-2 text-pink-500 hover:bg-pink-50 rounded-full">
                                    <span class="text-xl">üì∑</span>
                                </button>
                                <input type="file" id="buzzImageInput" accept="image/*" multiple class="hidden">
                            </div>
                            <button id="postBuzz" class="btn-primary text-white px-6 py-2 rounded-full font-semibold disabled:opacity-50" disabled>Buzz</button>
                        </div>
                        <div id="imagePreview" class="hidden mt-3">
                            <div id="imageGrid" class="grid grid-cols-2 gap-2"></div>
                            <button id="removeAllImages" class="mt-2 text-red-500 text-sm">Remove all images</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div id="feed" class="pb-20">
                <!-- Buzz posts will be dynamically added here -->
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-pink-100 mobile-safe">
            <div class="max-w-md mx-auto px-4 py-2">
                <div class="flex justify-around">
                    <button id="homeBtn" class="p-3 text-pink-500">
                        <span class="text-2xl">üè†</span>
                    </button>
                    <button id="searchBtn" class="p-3 text-gray-400">
                        <span class="text-2xl">üîç</span>
                    </button>
                    <button id="profileBtn" class="p-3 text-gray-400">
                        <span class="text-2xl">üë§</span>
                    </button>
                    <button id="settingsBtn" class="p-3 text-gray-400">
                        <span class="text-2xl">‚öôÔ∏è</span>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let currentUserData = null;
        let currentBuzzImage = null;
        let usernames = new Set();

        // Load existing usernames
        database.ref('usernames').once('value', (snapshot) => {
            if (snapshot.exists()) {
                usernames = new Set(Object.keys(snapshot.val()));
            }
        });

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                checkUserProfile();
            } else {
                showScreen('loginScreen');
            }
        });

        // Google Sign In
        document.getElementById('googleSignIn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                console.error('Sign in error:', error);
                alert('Sign in failed. Please try again.');
            });
        });

        // Check if user profile is complete
        function checkUserProfile() {
            database.ref(`users/${currentUser.uid}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    currentUserData = userData;
                    
                    // Auto-verify special email
                    if (currentUser.email === 'customerserviceffrj4@gmail.com' && !userData.isVerified) {
                        database.ref(`users/${currentUser.uid}/isVerified`).set(true);
                        sendNotification(currentUser.uid, 'verification_approved', null);
                        userData.isVerified = true;
                    }
                    
                    if (userData.profileComplete) {
                        loadMainApp();
                    } else {
                        showScreen('nameSetup');
                    }
                } else {
                    showScreen('nameSetup');
                }
            });
        }

        // Screen navigation
        function showScreen(screenId) {
            const screens = ['loginScreen', 'nameSetup', 'usernameSetup', 'dobSetup', 'bioSetup', 'profilePicSetup', 'mainApp'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMainScreen(screenId) {
            const screens = ['homeContent', 'searchScreen', 'profileScreen', 'settingsScreen', 'notificationsScreen', 'messagesScreen', 'hashtagScreen', 'helpCenterScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            
            // Update bottom nav
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('text-pink-500');
                btn.classList.add('text-gray-400');
            });
        }

        // Name setup
        document.getElementById('nameNext').addEventListener('click', () => {
            const name = document.getElementById('fullName').value.trim();
            if (name) {
                database.ref(`users/${currentUser.uid}`).update({ fullName: name });
                showScreen('usernameSetup');
            }
        });

        // Username setup
        document.getElementById('usernameNext').addEventListener('click', () => {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const errorDiv = document.getElementById('usernameError');
            
            if (!username) {
                errorDiv.textContent = 'Username is required';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!/^[a-z0-9]+$/.test(username)) {
                errorDiv.textContent = 'Only lowercase letters and numbers allowed';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (usernames.has(username)) {
                errorDiv.textContent = 'Username already taken';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Save username
            database.ref(`users/${currentUser.uid}`).update({ username: username });
            database.ref(`usernames/${username}`).set(currentUser.uid);
            usernames.add(username);
            errorDiv.classList.add('hidden');
            showScreen('dobSetup');
        });

        // DOB setup
        document.getElementById('dobNext').addEventListener('click', () => {
            const dob = document.getElementById('dateOfBirth').value;
            if (dob) {
                database.ref(`users/${currentUser.uid}`).update({ dateOfBirth: dob });
            }
            showScreen('bioSetup');
        });

        document.getElementById('dobSkip').addEventListener('click', () => {
            showScreen('bioSetup');
        });

        // Bio setup
        document.getElementById('bioNext').addEventListener('click', () => {
            const bio = document.getElementById('userBio').value.trim();
            if (bio) {
                database.ref(`users/${currentUser.uid}`).update({ bio: bio });
            }
            showScreen('profilePicSetup');
        });

        document.getElementById('bioSkip').addEventListener('click', () => {
            showScreen('profilePicSetup');
        });

        // Profile picture setup
        document.getElementById('uploadPic').addEventListener('click', () => {
            document.getElementById('profilePicInput').click();
        });

        document.getElementById('profilePicInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    document.getElementById('previewAvatar').innerHTML = `<img src="${base64}" class="w-full h-full rounded-full object-cover">`;
                    currentUser.profilePicture = base64;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('picSkip').addEventListener('click', () => {
            finishSetup();
        });

        // Update preview avatar with first letter
        function updatePreviewAvatar() {
            const name = document.getElementById('fullName').value.trim();
            if (name) {
                document.getElementById('previewAvatar').textContent = name.charAt(0).toUpperCase();
            }
        }

        document.getElementById('fullName').addEventListener('input', updatePreviewAvatar);

        // Finish setup
        function finishSetup() {
            const userData = {
                profileComplete: true,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                isPrivate: false,
                followers: {},
                following: {},
                isVerified: false
            };
            
            if (currentUser.profilePicture) {
                userData.profilePicture = currentUser.profilePicture;
            }
            
            // Auto-verify special names
            const fullName = document.getElementById('fullName').value.trim();
            if (fullName === 'Anmol Sunda' || fullName === 'Dozeta Group' || fullName === 'Gursharn Arya') {
                userData.isVerified = true;
            }
            
            database.ref(`users/${currentUser.uid}`).update(userData).then(() => {
                if (userData.isVerified) {
                    sendNotification(currentUser.uid, 'verification_approved', null);
                }
                loadMainApp();
            });
        }

        // Load main app
        function loadMainApp() {
            database.ref(`users/${currentUser.uid}`).once('value', (snapshot) => {
                currentUserData = snapshot.val();
                setupUserAvatar(currentUserData);
                loadFeed();
                loadNotifications();
                showScreen('mainApp');
                showMainScreen('homeContent');
            });
        }

        // Setup user avatar
        function setupUserAvatar(userData) {
            const avatar = document.getElementById('userAvatar');
            if (userData.profilePicture) {
                avatar.innerHTML = `<img src="${userData.profilePicture}" class="w-full h-full rounded-full object-cover">`;
            } else {
                avatar.textContent = userData.fullName.charAt(0).toUpperCase();
            }
        }

        // Create avatar element
        function createAvatar(userData, size = 'w-10 h-10') {
            if (userData.profilePicture) {
                return `<img src="${userData.profilePicture}" class="${size} rounded-full object-cover">`;
            } else {
                return `<div class="${size} rounded-full avatar-letter flex items-center justify-center text-white font-bold">${userData.fullName.charAt(0).toUpperCase()}</div>`;
            }
        }

        // Global variables for images and suggestions
        let currentBuzzImages = [];
        let currentSuggestionType = null;
        let currentSuggestionQuery = '';

        // Buzz creation
        document.getElementById('buzzText').addEventListener('input', (e) => {
            const text = e.target.value;
            const postBtn = document.getElementById('postBuzz');
            postBtn.disabled = !text.trim() && currentBuzzImages.length === 0;
            
            // Handle hashtag and mention suggestions
            handleSuggestions(text, e.target);
        });

        function handleSuggestions(text, textarea) {
            const cursorPos = textarea.selectionStart;
            const textBeforeCursor = text.substring(0, cursorPos);
            const words = textBeforeCursor.split(/\s/);
            const currentWord = words[words.length - 1];
            
            if (currentWord.startsWith('#') && currentWord.length > 1) {
                // Show hashtag suggestions
                const query = currentWord.substring(1).toLowerCase();
                showHashtagSuggestions(query);
            } else if (currentWord.startsWith('@') && currentWord.length > 1) {
                // Show mention suggestions
                const query = currentWord.substring(1).toLowerCase();
                showMentionSuggestions(query);
            } else {
                hideSuggestions();
            }
        }

        function showHashtagSuggestions(query) {
            database.ref('hashtags').once('value', (snapshot) => {
                const suggestions = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const hashtag = child.key;
                        if (hashtag.includes(query)) {
                            const data = child.val();
                            const postCount = data.posts ? Object.keys(data.posts).length : 0;
                            suggestions.push({ hashtag, postCount });
                        }
                    });
                }
                
                suggestions.sort((a, b) => b.postCount - a.postCount);
                renderSuggestions(suggestions.slice(0, 5), 'hashtag');
            });
        }

        function showMentionSuggestions(query) {
            database.ref('users').once('value', (snapshot) => {
                const suggestions = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const userData = child.val();
                        if (userData.profileComplete && 
                            (userData.username.toLowerCase().includes(query) || 
                             userData.fullName.toLowerCase().includes(query))) {
                            suggestions.push({
                                username: userData.username,
                                fullName: userData.fullName,
                                profilePicture: userData.profilePicture,
                                isVerified: userData.isVerified
                            });
                        }
                    });
                }
                
                renderSuggestions(suggestions.slice(0, 5), 'mention');
            });
        }

        function renderSuggestions(suggestions, type) {
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (suggestions.length === 0) {
                hideSuggestions();
                return;
            }
            
            suggestionsDiv.innerHTML = '';
            suggestionsDiv.classList.remove('hidden');
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                
                if (type === 'hashtag') {
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-blue-500">#${suggestion.hashtag}</span>
                            <span class="text-gray-500 text-sm">${suggestion.postCount} posts</span>
                        </div>
                    `;
                    div.onclick = () => insertSuggestion(`#${suggestion.hashtag}`);
                } else if (type === 'mention') {
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            ${suggestion.profilePicture ? 
                                `<img src="${suggestion.profilePicture}" class="w-8 h-8 rounded-full object-cover">` :
                                `<div class="w-8 h-8 rounded-full avatar-letter flex items-center justify-center text-white font-bold text-sm">${suggestion.fullName.charAt(0).toUpperCase()}</div>`
                            }
                            <div>
                                <p class="font-semibold flex items-center">${suggestion.fullName}${suggestion.isVerified ? '<span class="verified-tick ml-1"></span>' : ''}</p>
                                <p class="text-gray-500 text-sm">@${suggestion.username}</p>
                            </div>
                        </div>
                    `;
                    div.onclick = () => insertSuggestion(`@${suggestion.username}`);
                }
                
                suggestionsDiv.appendChild(div);
            });
        }

        function insertSuggestion(suggestion) {
            const textarea = document.getElementById('buzzText');
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            const textBeforeCursor = text.substring(0, cursorPos);
            const textAfterCursor = text.substring(cursorPos);
            
            // Find the start of the current word
            const words = textBeforeCursor.split(/\s/);
            const currentWord = words[words.length - 1];
            const wordStart = textBeforeCursor.lastIndexOf(currentWord);
            
            // Replace the current word with the suggestion
            const newText = text.substring(0, wordStart) + suggestion + ' ' + textAfterCursor;
            textarea.value = newText;
            
            // Set cursor position after the inserted suggestion
            const newCursorPos = wordStart + suggestion.length + 1;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            hideSuggestions();
            textarea.focus();
        }

        function hideSuggestions() {
            document.getElementById('suggestions').classList.add('hidden');
        }

        document.getElementById('addImage').addEventListener('click', () => {
            document.getElementById('buzzImageInput').click();
        });

        document.getElementById('buzzImageInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 4) {
                alert('Maximum 4 images allowed per buzz');
                return;
            }
            
            currentBuzzImages = [];
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentBuzzImages.push(e.target.result);
                    
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'relative';
                    imgDiv.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg">
                        <button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">√ó</button>
                    `;
                    imageGrid.appendChild(imgDiv);
                    
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('postBuzz').disabled = false;
                };
                reader.readAsDataURL(file);
            });
        });

        function removeImage(index) {
            currentBuzzImages.splice(index, 1);
            updateImagePreview();
        }

        function updateImagePreview() {
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            
            if (currentBuzzImages.length === 0) {
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('buzzImageInput').value = '';
                const postBtn = document.getElementById('postBuzz');
                postBtn.disabled = !document.getElementById('buzzText').value.trim();
                return;
            }
            
            currentBuzzImages.forEach((image, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative';
                imgDiv.innerHTML = `
                    <img src="${image}" class="w-full h-24 object-cover rounded-lg">
                    <button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">√ó</button>
                `;
                imageGrid.appendChild(imgDiv);
            });
        }

        document.getElementById('removeAllImages').addEventListener('click', () => {
            currentBuzzImages = [];
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('buzzImageInput').value = '';
            const postBtn = document.getElementById('postBuzz');
            postBtn.disabled = !document.getElementById('buzzText').value.trim();
        });

        // Post buzz
        document.getElementById('postBuzz').addEventListener('click', () => {
            const text = document.getElementById('buzzText').value.trim();
            if (!text && currentBuzzImages.length === 0) return;

            // Extract hashtags and mentions
            const hashtags = extractHashtags(text);
            const mentions = extractMentions(text);

            const buzzData = {
                userId: currentUser.uid,
                authorName: currentUserData.fullName,
                authorUsername: currentUserData.username,
                authorImage: currentUserData.profilePicture || null,
                isVerified: currentUserData.isVerified || false,
                text: text,
                hashtags: hashtags,
                mentions: mentions,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: {},
                comments: {},
                rebuzzes: {},
                saves: {}
            };

            if (currentBuzzImages.length > 0) {
                buzzData.images = currentBuzzImages;
            }

            database.ref('buzzes').push(buzzData).then((buzzRef) => {
                const buzzId = buzzRef.key;
                
                // Store hashtags
                hashtags.forEach(hashtag => {
                    database.ref(`hashtags/${hashtag.toLowerCase()}/posts/${buzzId}`).set(true);
                    database.ref(`hashtags/${hashtag.toLowerCase()}/users/${currentUser.uid}`).set(true);
                });

                // Send mention notifications
                mentions.forEach(username => {
                    database.ref('usernames').child(username.toLowerCase()).once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const mentionedUserId = snapshot.val();
                            if (mentionedUserId !== currentUser.uid) {
                                sendNotification(mentionedUserId, 'mention', buzzId);
                            }
                        }
                    });
                });

                document.getElementById('buzzText').value = '';
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('buzzImageInput').value = '';
                currentBuzzImages = [];
                document.getElementById('postBuzz').disabled = true;
                hideSuggestions();
                loadFeed();
            }).catch((error) => {
                console.error('Failed to post buzz:', error);
                alert('Failed to post buzz. Please try again.');
            });
        });

        // Load feed
        function loadFeed() {
            database.ref('buzzes').orderByChild('timestamp').limitToLast(20).once('value', (snapshot) => {
                const buzzes = [];
                snapshot.forEach((child) => {
                    buzzes.unshift({ id: child.key, ...child.val() });
                });
                
                renderFeed(buzzes);
            });
        }

        // Render feed
        function renderFeed(buzzes) {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                feed.appendChild(buzzElement);
            });
        }

        // Hashtag and mention utility functions
        function extractHashtags(text) {
            const hashtagRegex = /#[a-zA-Z0-9_]+/g;
            const matches = text.match(hashtagRegex);
            return matches ? matches.map(tag => tag.substring(1)) : [];
        }

        function extractMentions(text) {
            const mentionRegex = /@[a-zA-Z0-9_]+/g;
            const matches = text.match(mentionRegex);
            return matches ? matches.map(mention => mention.substring(1)) : [];
        }

        function formatTextWithHashtagsAndMentions(text) {
            if (!text) return '';
            
            // Replace hashtags
            text = text.replace(/#([a-zA-Z0-9_]+)/g, '<span class="hashtag" onclick="showHashtag(\'$1\')">#$1</span>');
            
            // Replace mentions
            text = text.replace(/@([a-zA-Z0-9_]+)/g, '<span class="mention" onclick="showMentionedUser(\'$1\')">@$1</span>');
            
            return text;
        }

        // Create image grid for multiple images
        function createImageGrid(images) {
            if (!images || images.length === 0) return '';
            
            if (images.length === 1) {
                return `<img src="${images[0]}" class="w-full rounded-lg mb-3 max-h-96 object-cover">`;
            } else if (images.length === 2) {
                return `
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <img src="${images[0]}" class="w-full h-48 object-cover rounded-lg">
                        <img src="${images[1]}" class="w-full h-48 object-cover rounded-lg">
                    </div>
                `;
            } else if (images.length === 3) {
                return `
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <img src="${images[0]}" class="w-full h-48 object-cover rounded-lg">
                        <div class="grid grid-rows-2 gap-2">
                            <img src="${images[1]}" class="w-full h-23 object-cover rounded-lg">
                            <img src="${images[2]}" class="w-full h-23 object-cover rounded-lg">
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <img src="${images[0]}" class="w-full h-24 object-cover rounded-lg">
                        <img src="${images[1]}" class="w-full h-24 object-cover rounded-lg">
                        <img src="${images[2]}" class="w-full h-24 object-cover rounded-lg">
                        <img src="${images[3]}" class="w-full h-24 object-cover rounded-lg">
                    </div>
                `;
            }
        }

        // Create buzz element
        function createBuzzElement(buzz) {
            const div = document.createElement('div');
            div.className = 'bg-white/80 backdrop-blur-md border-b border-pink-100 p-4';
            
            const timeAgo = getTimeAgo(buzz.timestamp);
            const isLiked = buzz.likes && buzz.likes[currentUser.uid];
            const isRebuzzed = buzz.rebuzzes && buzz.rebuzzes[currentUser.uid];
            const isSaved = buzz.saves && buzz.saves[currentUser.uid];
            
            const likeCount = buzz.likes ? Object.keys(buzz.likes).length : 0;
            const commentCount = buzz.comments ? Object.keys(buzz.comments).length : 0;
            const rebuzzCount = buzz.rebuzzes ? Object.keys(buzz.rebuzzes).length : 0;
            
            div.innerHTML = `
                <div class="flex gap-3">
                    <div class="cursor-pointer" onclick="showUserProfile('${buzz.userId}')">
                        ${buzz.authorImage ? 
                            `<img src="${buzz.authorImage}" class="w-10 h-10 rounded-full object-cover">` :
                            `<div class="w-10 h-10 rounded-full avatar-letter flex items-center justify-center text-white font-bold">${buzz.authorName.charAt(0).toUpperCase()}</div>`
                        }
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold cursor-pointer flex items-center" onclick="showUserProfile('${buzz.userId}')">${buzz.authorName}${buzz.isVerified ? '<span class="verified-tick"></span>' : ''}</span>
                            <span class="text-gray-500 text-sm cursor-pointer" onclick="showUserProfile('${buzz.userId}')">@${buzz.authorUsername}</span>
                            <span class="text-gray-500 text-sm">¬∑</span>
                            <span class="text-gray-500 text-sm">${timeAgo}</span>
                            ${buzz.userId === currentUser.uid ? `
                                <button onclick="deleteBuzz('${buzz.id}')" class="ml-auto text-red-500 hover:bg-red-50 p-1 rounded">
                                    <span class="text-sm">üóëÔ∏è</span>
                                </button>
                            ` : ''}
                        </div>
                        <p class="mb-3">${formatTextWithHashtagsAndMentions(buzz.text)}</p>
                        ${buzz.images ? createImageGrid(buzz.images) : (buzz.image ? `<img src="${buzz.image}" class="w-full rounded-lg mb-3 max-h-96 object-cover">` : '')}
                        <div class="flex items-center justify-between text-gray-500 max-w-md">
                            <button class="flex items-center gap-2 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors ${isLiked ? 'text-red-500' : ''}" onclick="toggleLike('${buzz.id}', '${buzz.userId}')">
                                <span class="text-lg">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span>${likeCount}</span>
                            </button>
                            <button class="flex items-center gap-2 hover:text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-colors" onclick="showComments('${buzz.id}')">
                                <span class="text-lg">üí¨</span>
                                <span>${commentCount}</span>
                            </button>
                            <button class="flex items-center gap-2 hover:text-green-500 p-2 rounded-full hover:bg-green-50 transition-colors ${isRebuzzed ? 'text-green-500' : ''}" onclick="rebuzz('${buzz.id}', '${buzz.userId}')">
                                <span class="text-lg">üîÑ</span>
                                <span>${rebuzzCount}</span>
                            </button>
                            <button class="flex items-center gap-2 hover:text-yellow-500 p-2 rounded-full hover:bg-yellow-50 transition-colors ${isSaved ? 'text-yellow-500' : ''}" onclick="saveBuzz('${buzz.id}', '${buzz.userId}')">
                                <span class="text-lg">${isSaved ? 'üîñ' : 'üìë'}</span>
                            </button>
                            <button class="flex items-center gap-2 hover:text-gray-700 p-2 rounded-full hover:bg-gray-50 transition-colors" onclick="shareBuzz('${buzz.id}')">
                                <span class="text-lg">üì§</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Utility functions
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            return `${days}d`;
        }

        // Delete buzz
        function deleteBuzz(buzzId) {
            if (confirm('Are you sure you want to delete this buzz?')) {
                database.ref(`buzzes/${buzzId}`).remove().then(() => {
                    loadFeed();
                });
            }
        }

        // Interaction functions
        function toggleLike(buzzId, authorId) {
            const likeRef = database.ref(`buzzes/${buzzId}/likes/${currentUser.uid}`);
            likeRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Unlike
                    likeRef.remove().then(() => {
                        loadFeed();
                    });
                } else {
                    // Like
                    likeRef.set(true).then(() => {
                        // Send notification
                        if (authorId !== currentUser.uid) {
                            sendNotification(authorId, 'like', buzzId);
                        }
                        loadFeed();
                    });
                }
            });
        }

        function rebuzz(buzzId, authorId) {
            const rebuzzRef = database.ref(`buzzes/${buzzId}/rebuzzes/${currentUser.uid}`);
            rebuzzRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Un-rebuzz
                    rebuzzRef.remove().then(() => {
                        loadFeed();
                    });
                } else {
                    // Rebuzz
                    rebuzzRef.set(true).then(() => {
                        // Send notification
                        if (authorId !== currentUser.uid) {
                            sendNotification(authorId, 'rebuzz', buzzId);
                        }
                        loadFeed();
                    });
                }
            });
        }

        function saveBuzz(buzzId, authorId) {
            const saveRef = database.ref(`buzzes/${buzzId}/saves/${currentUser.uid}`);
            saveRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Unsave
                    saveRef.remove().then(() => {
                        loadFeed();
                    });
                } else {
                    // Save
                    saveRef.set(true).then(() => {
                        // Send notification
                        if (authorId !== currentUser.uid) {
                            sendNotification(authorId, 'save', buzzId);
                        }
                        loadFeed();
                    });
                }
            });
        }

        function showComments(buzzId) {
            alert('Comments feature coming soon!');
        }

        function shareBuzz(buzzId) {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this Buzz on Pulse',
                    url: window.location.href
                });
            } else {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied to clipboard!');
                }).catch(() => {
                    alert('Share feature not supported on this device');
                });
            }
        }

        // Hashtag and mention navigation
        function showHashtag(hashtag) {
            document.getElementById('hashtagTitle').textContent = `#${hashtag}`;
            loadHashtagData(hashtag);
            showMainScreen('hashtagScreen');
        }

        function showMentionedUser(username) {
            database.ref('usernames').child(username.toLowerCase()).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const userId = snapshot.val();
                    showUserProfile(userId);
                } else {
                    alert('User not found');
                }
            });
        }

        function loadHashtagData(hashtag) {
            const hashtagRef = database.ref(`hashtags/${hashtag.toLowerCase()}`);
            
            hashtagRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const postCount = data.posts ? Object.keys(data.posts).length : 0;
                    const userCount = data.users ? Object.keys(data.users).length : 0;
                    
                    document.getElementById('hashtagPostCount').textContent = postCount;
                    document.getElementById('hashtagUserCount').textContent = userCount;
                    
                    // Load posts with this hashtag
                    if (data.posts) {
                        const postIds = Object.keys(data.posts);
                        loadHashtagPosts(postIds);
                    } else {
                        document.getElementById('hashtagPosts').innerHTML = '<p class="text-gray-500 text-center py-8">No posts found</p>';
                    }
                } else {
                    document.getElementById('hashtagPostCount').textContent = '0';
                    document.getElementById('hashtagUserCount').textContent = '0';
                    document.getElementById('hashtagPosts').innerHTML = '<p class="text-gray-500 text-center py-8">No posts found</p>';
                }
            });
        }

        function loadHashtagPosts(postIds) {
            const hashtagPosts = document.getElementById('hashtagPosts');
            hashtagPosts.innerHTML = '';
            
            postIds.forEach(postId => {
                database.ref(`buzzes/${postId}`).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const buzz = { id: snapshot.key, ...snapshot.val() };
                        const buzzElement = createBuzzElement(buzz);
                        hashtagPosts.appendChild(buzzElement);
                    }
                });
            });
        }

        // Notification system
        function sendNotification(userId, type, buzzId) {
            const notificationData = {
                fromUserId: currentUser.uid,
                fromUserName: currentUserData ? currentUserData.fullName : 'Pulse',
                fromUserImage: currentUserData ? (currentUserData.profilePicture || null) : null,
                fromUserVerified: currentUserData ? (currentUserData.isVerified || false) : false,
                type: type,
                buzzId: buzzId,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            };
            
            // Special handling for verification notifications
            if (type === 'verification_approved') {
                notificationData.fromUserName = 'Pulse Team';
                notificationData.fromUserImage = null;
                notificationData.fromUserVerified = true;
            }
            
            database.ref(`notifications/${userId}`).push(notificationData);
        }

        function loadNotifications() {
            database.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
                const notifications = [];
                let unreadCount = 0;
                
                snapshot.forEach((child) => {
                    const notification = { id: child.key, ...child.val() };
                    notifications.unshift(notification);
                    if (!notification.read) unreadCount++;
                });
                
                // Update notification dot
                const notificationDot = document.getElementById('notificationDot');
                if (unreadCount > 0) {
                    notificationDot.classList.remove('hidden');
                } else {
                    notificationDot.classList.add('hidden');
                }
                
                renderNotifications(notifications);
            });
        }

        function renderNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-gray-500 text-center py-8">No notifications yet</p>';
                return;
            }
            
            notifications.forEach(notification => {
                const div = document.createElement('div');
                div.className = `p-4 border-b border-gray-100 ${!notification.read ? 'bg-pink-50' : ''}`;
                
                const typeEmoji = {
                    'like': '‚ù§Ô∏è',
                    'rebuzz': 'üîÑ',
                    'save': 'üîñ',
                    'comment': 'üí¨',
                    'follow': 'üë§',
                    'mention': 'üì¢',
                    'verification_approved': '‚úÖ'
                };
                
                const typeText = {
                    'like': 'liked your buzz',
                    'rebuzz': 'rebuzzed your post',
                    'save': 'saved your buzz',
                    'comment': 'commented on your buzz',
                    'follow': 'started following you',
                    'mention': 'mentioned you in a buzz',
                    'verification_approved': 'Congratulations! Your account has been verified'
                };
                
                const userName = notification.fromUserName || 'Unknown User';
                const userImage = notification.fromUserImage;
                const isVerified = notification.fromUserVerified || false;
                
                div.innerHTML = `
                    <div class="flex gap-3">
                        ${userImage ? 
                            `<img src="${userImage}" class="w-10 h-10 rounded-full object-cover">` :
                            `<div class="w-10 h-10 rounded-full avatar-letter flex items-center justify-center text-white font-bold text-sm">${userName.charAt(0).toUpperCase()}</div>`
                        }
                        <div class="flex-1">
                            <p>
                                <span class="font-bold">${userName}</span>
                                ${isVerified ? '<span class="verified-tick ml-1"></span>' : ''}
                                ${typeText[notification.type] || 'sent you a notification'} ${typeEmoji[notification.type] || 'üì¢'}
                            </p>
                            <p class="text-gray-500 text-sm">${getTimeAgo(notification.timestamp)}</p>
                        </div>
                    </div>
                `;
                
                notificationsList.appendChild(div);
            });
        }

        // User profile functions
        function showUserProfile(userId) {
            database.ref(`users/${userId}`).once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    renderUserProfile(userData, userId);
                    loadUserBuzzes(userId);
                    showMainScreen('profileScreen');
                }
            });
        }

        function renderUserProfile(userData, userId) {
            const profileInfo = document.getElementById('profileInfo');
            
            // Count followers and following
            const followersCount = userData.followers ? Object.keys(userData.followers).length : 0;
            const followingCount = userData.following ? Object.keys(userData.following).length : 0;
            const isFollowing = userData.followers && userData.followers[currentUser.uid];
            
            profileInfo.innerHTML = `
                <div class="mb-4">
                    ${userData.profilePicture ? 
                        `<img src="${userData.profilePicture}" class="w-24 h-24 rounded-full object-cover mx-auto mb-4">` :
                        `<div class="w-24 h-24 rounded-full avatar-letter flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4">${userData.fullName.charAt(0).toUpperCase()}</div>`
                    }
                    <h3 class="text-xl font-bold flex items-center justify-center">${userData.fullName}${userData.isVerified ? '<span class="verified-tick"></span>' : ''}</h3>
                    <p class="text-gray-500">@${userData.username}</p>
                    ${userData.bio ? `<p class="text-gray-700 mt-2">${userData.bio}</p>` : ''}
                    ${userData.dateOfBirth ? `<p class="text-gray-500 text-sm mt-2">Born ${new Date(userData.dateOfBirth).toLocaleDateString()}</p>` : ''}
                    <div class="flex gap-6 justify-center mt-4">
                        <div class="text-center">
                            <p class="font-bold">${followersCount}</p>
                            <p class="text-gray-500 text-sm">Followers</p>
                        </div>
                        <div class="text-center">
                            <p class="font-bold">${followingCount}</p>
                            <p class="text-gray-500 text-sm">Following</p>
                        </div>
                    </div>
                </div>
                ${userId !== currentUser.uid ? `
                    <div class="flex gap-3 justify-center">
                        <button onclick="followUser('${userId}')" class="btn-primary text-white px-6 py-2 rounded-full font-semibold">
                            ${isFollowing ? 'Unfollow' : 'Follow'}
                        </button>
                        <button onclick="blockUser('${userId}')" class="border-2 border-red-500 text-red-500 px-6 py-2 rounded-full font-semibold">Block</button>
                    </div>
                ` : `
                    <div class="flex justify-center">
                        <button onclick="showEditProfile()" class="btn-primary text-white px-6 py-2 rounded-full font-semibold">Edit Profile</button>
                    </div>
                `}
            `;
        }

        function loadUserBuzzes(userId) {
            database.ref('buzzes').orderByChild('userId').equalTo(userId).once('value', (snapshot) => {
                const buzzes = [];
                snapshot.forEach((child) => {
                    buzzes.unshift({ id: child.key, ...child.val() });
                });
                
                const userBuzzes = document.getElementById('userBuzzes');
                userBuzzes.innerHTML = '';
                
                if (buzzes.length === 0) {
                    userBuzzes.innerHTML = '<p class="text-gray-500 text-center py-8">No buzzes yet</p>';
                    return;
                }
                
                buzzes.forEach(buzz => {
                    const buzzElement = createBuzzElement(buzz);
                    userBuzzes.appendChild(buzzElement);
                });
            });
        }

        function followUser(userId) {
            database.ref(`users/${userId}/followers/${currentUser.uid}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Unfollow
                    database.ref(`users/${userId}/followers/${currentUser.uid}`).remove();
                    database.ref(`users/${currentUser.uid}/following/${userId}`).remove();
                } else {
                    // Follow
                    database.ref(`users/${userId}/followers/${currentUser.uid}`).set(true);
                    database.ref(`users/${currentUser.uid}/following/${userId}`).set(true);
                    // Send notification
                    sendNotification(userId, 'follow', null);
                }
                // Refresh profile
                showUserProfile(userId);
            });
        }

        function blockUser(userId) {
            if (confirm('Are you sure you want to block this user?')) {
                database.ref(`users/${currentUser.uid}/blockedUsers/${userId}`).set(true);
                alert('User blocked successfully');
            }
        }

        // Edit profile functions
        function showEditProfile() {
            document.getElementById('editProfileModal').classList.remove('hidden');
            document.getElementById('editFullName').value = currentUserData.fullName;
            document.getElementById('editBio').value = currentUserData.bio || '';
            
            const editAvatar = document.getElementById('editAvatar');
            if (currentUserData.profilePicture) {
                editAvatar.innerHTML = `<img src="${currentUserData.profilePicture}" class="w-full h-full rounded-full object-cover">`;
            } else {
                editAvatar.textContent = currentUserData.fullName.charAt(0).toUpperCase();
            }
        }

        document.getElementById('editAvatar').addEventListener('click', () => {
            document.getElementById('editProfilePicInput').click();
        });

        document.getElementById('editProfilePicInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    document.getElementById('editAvatar').innerHTML = `<img src="${base64}" class="w-full h-full rounded-full object-cover">`;
                    currentUserData.profilePicture = base64;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('saveProfile').addEventListener('click', () => {
            const newName = document.getElementById('editFullName').value.trim();
            const newBio = document.getElementById('editBio').value.trim();
            
            if (!newName) {
                alert('Name is required');
                return;
            }
            
            const updates = {
                fullName: newName,
                bio: newBio
            };
            
            if (currentUserData.profilePicture) {
                updates.profilePicture = currentUserData.profilePicture;
            }
            
            database.ref(`users/${currentUser.uid}`).update(updates).then(() => {
                currentUserData.fullName = newName;
                currentUserData.bio = newBio;
                document.getElementById('editProfileModal').classList.add('hidden');
                setupUserAvatar(currentUserData);
                showUserProfile(currentUser.uid);
            });
        });

        document.getElementById('cancelEdit').addEventListener('click', () => {
            document.getElementById('editProfileModal').classList.add('hidden');
        });

        // Search functionality
        let currentSearchTab = 'users';

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            if (query.length > 0) {
                performSearch(query, currentSearchTab);
            } else {
                loadDefaultContent(currentSearchTab);
            }
        });

        // Search tab handlers
        document.getElementById('usersTab').addEventListener('click', () => {
            currentSearchTab = 'users';
            updateSearchTabs();
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (query) {
                performSearch(query, 'users');
            } else {
                loadDefaultContent('users');
            }
        });

        document.getElementById('buzzesTab').addEventListener('click', () => {
            currentSearchTab = 'buzzes';
            updateSearchTabs();
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (query) {
                performSearch(query, 'buzzes');
            } else {
                loadDefaultContent('buzzes');
            }
        });

        document.getElementById('hashtagsTab').addEventListener('click', () => {
            currentSearchTab = 'hashtags';
            updateSearchTabs();
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (query) {
                performSearch(query, 'hashtags');
            } else {
                loadDefaultContent('hashtags');
            }
        });

        function updateSearchTabs() {
            document.querySelectorAll('#searchScreen button[id$="Tab"]').forEach(tab => {
                tab.classList.remove('bg-pink-500', 'text-white');
                tab.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById(currentSearchTab + 'Tab').classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(currentSearchTab + 'Tab').classList.add('bg-pink-500', 'text-white');
        }

        function performSearch(query, type) {
            switch(type) {
                case 'users':
                    searchUsers(query);
                    break;
                case 'buzzes':
                    searchBuzzes(query);
                    break;
                case 'hashtags':
                    searchHashtags(query);
                    break;
            }
        }

        function loadDefaultContent(type) {
            switch(type) {
                case 'users':
                    loadAllUsers();
                    break;
                case 'buzzes':
                    loadRecentBuzzes();
                    break;
                case 'hashtags':
                    loadTrendingHashtags();
                    break;
            }
        }

        function searchUsers(query) {
            database.ref('users').once('value', (snapshot) => {
                const results = [];
                snapshot.forEach((child) => {
                    const userData = child.val();
                    if (userData.profileComplete && 
                        (userData.fullName.toLowerCase().includes(query) || 
                         userData.username.toLowerCase().includes(query))) {
                        results.push({ id: child.key, ...userData });
                    }
                });
                
                renderUserResults(results);
            });
        }

        function searchBuzzes(query) {
            database.ref('buzzes').once('value', (snapshot) => {
                const results = [];
                snapshot.forEach((child) => {
                    const buzzData = child.val();
                    if (buzzData.text && buzzData.text.toLowerCase().includes(query)) {
                        results.push({ id: child.key, ...buzzData });
                    }
                });
                
                results.sort((a, b) => b.timestamp - a.timestamp);
                renderBuzzResults(results.slice(0, 20));
            });
        }

        function searchHashtags(query) {
            database.ref('hashtags').once('value', (snapshot) => {
                const results = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const hashtag = child.key;
                        if (hashtag.includes(query)) {
                            const data = child.val();
                            const postCount = data.posts ? Object.keys(data.posts).length : 0;
                            const userCount = data.users ? Object.keys(data.users).length : 0;
                            results.push({ hashtag, postCount, userCount });
                        }
                    });
                }
                
                results.sort((a, b) => b.postCount - a.postCount);
                renderHashtagResults(results);
            });
        }

        function loadAllUsers() {
            database.ref('users').once('value', (snapshot) => {
                const results = [];
                snapshot.forEach((child) => {
                    const userData = child.val();
                    if (userData.profileComplete && child.key !== currentUser.uid) {
                        results.push({ id: child.key, ...userData });
                    }
                });
                
                renderUserResults(results);
            });
        }

        function loadRecentBuzzes() {
            database.ref('buzzes').orderByChild('timestamp').limitToLast(20).once('value', (snapshot) => {
                const results = [];
                snapshot.forEach((child) => {
                    results.unshift({ id: child.key, ...child.val() });
                });
                
                renderBuzzResults(results);
            });
        }

        function loadTrendingHashtags() {
            database.ref('hashtags').once('value', (snapshot) => {
                const results = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const hashtag = child.key;
                        const data = child.val();
                        const postCount = data.posts ? Object.keys(data.posts).length : 0;
                        const userCount = data.users ? Object.keys(data.users).length : 0;
                        results.push({ hashtag, postCount, userCount });
                    });
                }
                
                results.sort((a, b) => b.postCount - a.postCount);
                renderHashtagResults(results.slice(0, 20));
            });
        }

        function renderUserResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center py-4">No users found</p>';
                return;
            }
            
            results.forEach(user => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50';
                div.onclick = () => showUserProfile(user.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        ${user.profilePicture ? 
                            `<img src="${user.profilePicture}" class="w-12 h-12 rounded-full object-cover">` :
                            `<div class="w-12 h-12 rounded-full avatar-letter flex items-center justify-center text-white font-bold">${user.fullName.charAt(0).toUpperCase()}</div>`
                        }
                        <div>
                            <p class="font-bold flex items-center">${user.fullName}${user.isVerified ? '<span class="verified-tick"></span>' : ''}</p>
                            <p class="text-gray-500 text-sm">@${user.username}</p>
                            ${user.bio ? `<p class="text-gray-600 text-sm mt-1">${user.bio}</p>` : ''}
                        </div>
                    </div>
                `;
                
                searchResults.appendChild(div);
            });
        }

        function renderBuzzResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center py-4">No buzzes found</p>';
                return;
            }
            
            results.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                searchResults.appendChild(buzzElement);
            });
        }

        function renderHashtagResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center py-4">No hashtags found</p>';
                return;
            }
            
            results.forEach(hashtag => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50';
                div.onclick = () => showHashtag(hashtag.hashtag);
                
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-blue-500 text-lg">#${hashtag.hashtag}</p>
                            <p class="text-gray-500 text-sm">${hashtag.userCount} users</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">${hashtag.postCount}</p>
                            <p class="text-gray-500 text-sm">posts</p>
                        </div>
                    </div>
                `;
                
                searchResults.appendChild(div);
            });
        }

        // Verification functions
        document.getElementById('verificationBtn').addEventListener('click', () => {
            document.getElementById('verificationModal').classList.remove('hidden');
        });

        document.getElementById('cancelVerification').addEventListener('click', () => {
            document.getElementById('verificationModal').classList.add('hidden');
        });

        // Country change handler for document types
        document.getElementById('verifyCountry').addEventListener('change', (e) => {
            const country = e.target.value;
            const docTypeDiv = document.getElementById('documentTypeDiv');
            const docUploadDiv = document.getElementById('documentUploadDiv');
            const docTypeSelect = document.getElementById('verifyDocType');
            
            if (country) {
                docTypeDiv.classList.remove('hidden');
                docUploadDiv.classList.remove('hidden');
                
                // Clear previous options
                docTypeSelect.innerHTML = '<option value="">Select Document Type</option>';
                
                // Add country-specific document types
                const documentTypes = {
                    'US': ['Passport', 'Driver License', 'State ID'],
                    'IN': ['PAN Card', 'Voter Card', 'Aadhaar Card', 'Passport'],
                    'UK': ['Passport', 'Driver License', 'National ID'],
                    'CA': ['Passport', 'Driver License', 'Health Card'],
                    'AU': ['Passport', 'Driver License', 'Medicare Card'],
                    'DE': ['Passport', 'National ID', 'Driver License'],
                    'FR': ['Passport', 'National ID', 'Driver License'],
                    'JP': ['Passport', 'Driver License', 'Residence Card'],
                    'BR': ['Passport', 'National ID', 'Driver License'],
                    'MX': ['Passport', 'National ID', 'Driver License']
                };
                
                const docs = documentTypes[country] || ['Passport', 'National ID'];
                docs.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc;
                    option.textContent = doc;
                    docTypeSelect.appendChild(option);
                });
            } else {
                docTypeDiv.classList.add('hidden');
                docUploadDiv.classList.add('hidden');
            }
        });

        // Add social link functionality
        document.getElementById('addSocialLink').addEventListener('click', () => {
            const container = document.getElementById('socialLinksContainer');
            const links = container.querySelectorAll('.social-link');
            
            if (links.length < 5) {
                const input = document.createElement('input');
                input.type = 'url';
                input.className = 'social-link w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none mb-2';
                input.placeholder = 'Instagram, Facebook, YouTube, News links, etc.';
                container.appendChild(input);
            }
        });

        // Submit verification request
        document.getElementById('submitVerification').addEventListener('click', () => {
            const fullName = document.getElementById('verifyFullName').value.trim();
            const reason = document.getElementById('verifyReason').value.trim();
            const otherName = document.getElementById('verifyOtherName').value.trim();
            const country = document.getElementById('verifyCountry').value;
            const docType = document.getElementById('verifyDocType').value;
            const docFile = document.getElementById('verifyDocument').files[0];
            
            if (!fullName || !reason || !country || !docType || !docFile) {
                alert('Please fill all required fields');
                return;
            }
            
            // Get social links
            const socialLinks = [];
            document.querySelectorAll('.social-link').forEach(input => {
                if (input.value.trim()) {
                    socialLinks.push(input.value.trim());
                }
            });
            
            // Convert document to base64
            const reader = new FileReader();
            reader.onload = (e) => {
                const verificationData = {
                    userId: currentUser.uid,
                    fullName: fullName,
                    reason: reason,
                    otherName: otherName,
                    country: country,
                    documentType: docType,
                    documentImage: e.target.result,
                    socialLinks: socialLinks,
                    status: 'pending',
                    submittedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Auto-approve special names
                if (fullName === 'Anmol Sunda' || fullName === 'Dozeta Group' || fullName === 'Gursharn Arya') {
                    verificationData.status = 'approved';
                    database.ref(`users/${currentUser.uid}/isVerified`).set(true);
                    sendNotification(currentUser.uid, 'verification_approved', null);
                    currentUserData.isVerified = true;
                }
                
                database.ref('verificationRequests').push(verificationData).then(() => {
                    document.getElementById('verificationModal').classList.add('hidden');
                    alert(verificationData.status === 'approved' ? 'Congratulations! You have been verified!' : 'Verification request submitted successfully!');
                });
            };
            reader.readAsDataURL(docFile);
        });

        // Settings functions
        document.getElementById('privateAccountBtn').addEventListener('click', () => {
            const currentStatus = currentUserData.isPrivate || false;
            database.ref(`users/${currentUser.uid}/isPrivate`).set(!currentStatus).then(() => {
                currentUserData.isPrivate = !currentStatus;
                document.getElementById('privateStatus').textContent = currentUserData.isPrivate ? 'On' : 'Off';
            });
        });

        document.getElementById('privacyBtn').addEventListener('click', () => {
            alert('Privacy settings coming soon!');
        });

        document.getElementById('blockListBtn').addEventListener('click', () => {
            alert('Blocked users list coming soon!');
        });

        document.getElementById('helpCenterBtn').addEventListener('click', () => {
            showMainScreen('helpCenterScreen');
        });

        document.getElementById('addAccountBtn').addEventListener('click', () => {
            alert('Add account feature coming soon!');
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        });

        // Navigation event listeners
        document.getElementById('homeBtn').addEventListener('click', () => {
            showMainScreen('homeContent');
            document.getElementById('homeBtn').classList.remove('text-gray-400');
            document.getElementById('homeBtn').classList.add('text-pink-500');
            loadFeed();
        });

        document.getElementById('searchBtn').addEventListener('click', () => {
            showMainScreen('searchScreen');
            document.getElementById('searchBtn').classList.remove('text-gray-400');
            document.getElementById('searchBtn').classList.add('text-pink-500');
            currentSearchTab = 'users';
            updateSearchTabs();
            loadAllUsers();
        });

        document.getElementById('profileBtn').addEventListener('click', () => {
            showUserProfile(currentUser.uid);
            document.getElementById('profileBtn').classList.remove('text-gray-400');
            document.getElementById('profileBtn').classList.add('text-pink-500');
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            showMainScreen('settingsScreen');
            document.getElementById('settingsBtn').classList.remove('text-gray-400');
            document.getElementById('settingsBtn').classList.add('text-pink-500');
            document.getElementById('privateStatus').textContent = currentUserData.isPrivate ? 'On' : 'Off';
        });

        document.getElementById('notificationBtn').addEventListener('click', () => {
            showMainScreen('notificationsScreen');
            database.ref(`notifications/${currentUser.uid}`).once('value', (snapshot) => {
                const updates = {};
                snapshot.forEach((child) => {
                    updates[`${child.key}/read`] = true;
                });
                if (Object.keys(updates).length > 0) {
                    database.ref(`notifications/${currentUser.uid}`).update(updates);
                }
            });
        });

        document.getElementById('messageBtn').addEventListener('click', () => {
            showMainScreen('messagesScreen');
        });

        // Back button event listeners
        document.getElementById('backToHome').addEventListener('click', () => {
            showMainScreen('homeContent');
            document.getElementById('homeBtn').classList.remove('text-gray-400');
            document.getElementById('homeBtn').classList.add('text-pink-500');
        });

        document.getElementById('backFromProfile').addEventListener('click', () => {
            showMainScreen('homeContent');
            document.getElementById('homeBtn').classList.remove('text-gray-400');
            document.getElementById('homeBtn').classList.add('text-pink-500');
        });

        document.getElementById('backFromSettings').addEventListener('click', () => {
            showMainScreen('homeContent');
            document.getElementById('homeBtn').classList.remove('text-gray-400');
            document.getElementById('homeBtn').classList.add('text-pink-500');
        });

        document.getElementById('backFromNotifications').addEventListener('click', () => {
            showMainScreen('homeContent');
            document.getElementById('homeBtn').classList.remove('text-gray-400');
            document.getElementById('homeBtn').classList.add('text-pink-500');
        });

        document.getElementById('backFromMessages').addEventListener('click', () => {
            showMainScreen('homeContent');
            document.getElementById('homeBtn').classList.remove('text-gray-400');
            document.getElementById('homeBtn').classList.add('text-pink-500');
        });

        document.getElementById('backFromHashtag').addEventListener('click', () => {
            showMainScreen('homeContent');
            document.getElementById('homeBtn').classList.remove('text-gray-400');
            document.getElementById('homeBtn').classList.add('text-pink-500');
        });

        document.getElementById('backFromHelp').addEventListener('click', () => {
            showMainScreen('settingsScreen');
            document.getElementById('settingsBtn').classList.remove('text-gray-400');
            document.getElementById('settingsBtn').classList.add('text-pink-500');
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // App will initialize through auth state observer
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978390b114bf9190',t:'MTc1NjcxNzEwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
