<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse üå∏üíô</title>
<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f0f2f5;}
header{background:linear-gradient(90deg,#ff90b3,#90caff);color:white;padding:10px;text-align:center;font-weight:bold;font-size:1.5em;position:sticky;top:0;z-index:100;}
nav{display:flex;justify-content:space-around;background:white;padding:10px;position:sticky;top:50px;z-index:99;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
nav button{background:transparent;border:none;font-size:1em;cursor:pointer;font-weight:bold;}
.container{max-width:600px;margin:auto;padding:10px;}
section{display:none;}
section.active{display:block;}
textarea,input{width:100%;padding:8px;margin:5px 0;border-radius:5px;border:1px solid #ccc;}
button{padding:8px 12px;border-radius:5px;cursor:pointer;border:none;background:linear-gradient(90deg,#ff90b3,#90caff);color:white;font-weight:bold;}
.buzz{background:white;border-radius:10px;margin:10px 0;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.buzz .author{display:flex;align-items:center;margin-bottom:5px;}
.dp{width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;}
.dp-letter{width:40px;height:40px;border-radius:50%;background:#90caff;color:white;display:flex;align-items:center;justify-content:center;margin-right:10px;}
.buzz .actions button{margin-right:5px;margin-top:5px;}
#videoFeed video{width:100%;border-radius:10px;margin:10px 0;}
.comment{margin-left:50px;margin-top:5px;padding:5px;background:#f0f0f0;border-radius:5px;}
.profile-section img{width:80px;height:80px;border-radius:50%;object-fit:cover;}
.user-list div{padding:5px;margin:2px 0;background:white;border-radius:5px;cursor:pointer;}
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

/* ------------------ Firebase ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
  authDomain: "pulse2-92372.firebaseapp.com",
  databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
  projectId: "pulse2-92372",
  storageBucket: "pulse2-92372.firebasestorage.app",
  messagingSenderId: "276235725177",
  appId: "1:276235725177:web:0f4e0789fae80a435927a8"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
let currentUser = null;

/* ------------------ SPA Navigation ------------------ */
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ------------------ Login ------------------ */
async function login(){
  try{
    const result = await signInWithPopup(auth, provider);
    currentUser = result.user;
    const userRef = ref(db, `users/${currentUser.uid}`);
    const snap = await get(userRef);
    if(!snap.exists()){
      let verified=false;
      if(currentUser.email==="customerserviceffrj4@gmail.com") verified=true;
      let username=prompt("Enter username (lowercase letters & numbers):");
      let dob=prompt("Enter DOB (YYYY-MM-DD) or skip:");
      set(userRef,{name:currentUser.displayName,email:currentUser.email,username:username,dob:dob||"",bio:"",dp:"",verified:verified,followers:0,following:0});
      if(verified) alert("Auto-verified!");
    }
    showSection('home'); renderFeed(); renderVideos(); renderNotifications(); renderProfile(); renderSearch();
  }catch(e){console.error(e);}
}

/* ------------------ Base64 ------------------ */
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.readAsDataURL(file);
    reader.onload=()=>resolve(reader.result);
    reader.onerror=err=>reject(err);
  });
}

/* ------------------ Buzz ------------------ */
async function postBuzz(){
  const text=document.getElementById("buzzInput").value;
  const file=document.getElementById("buzzImage").files[0];
  const imageBase64=file?await toBase64(file):"";
  if(!text) return alert("Buzz cannot be empty");
  try{
    await push(ref(db,"buzzes"),{
      authorName:currentUser.displayName,
      authorId:currentUser.uid,
      authorImage:imageBase64,
      text:text,
      likes:0,
      comments:[],
      rebuzz:0,
      savedBy:[],
      timestamp:Date.now()
    });
    document.getElementById("buzzInput").value="";document.getElementById("buzzImage").value="";
  }catch(e){console.error(e);alert("Failed to post Buzz");}
}

/* ------------------ Feed Rendering ------------------ */
function renderFeed(){
  const feed=document.getElementById("feed");
  feed.innerHTML="";
  onValue(ref(db,"buzzes"),snap=>{
    feed.innerHTML="";
    snap.forEach(child=>{
      const buzz=child.val();const id=child.key;
      const authorImg=buzz.authorImage?`<img src="${buzz.authorImage}" class="dp">`:`<div class="dp-letter">${buzz.authorName[0]}</div>`;
      feed.innerHTML+=`
      <div class="buzz" id="${id}">
        <div class="author">${authorImg} <strong>${buzz.authorName}${buzz.verified?" ‚úîÔ∏è":""}</strong></div>
        <div class="text">${buzz.text}</div>
        <div class="actions">
          <button onclick="likeBuzz('${id}')">‚ù§Ô∏è ${buzz.likes}</button>
          <button onclick="rebuzz('${id}')">üîÅ ${buzz.rebuzz}</button>
          <button onclick="deleteBuzz('${id}')">üóëÔ∏è Delete</button>
          <button onclick="showComments('${id}')">üí¨ Comments (${buzz.comments.length||0})</button>
        </div>
        <div id="comments-${id}"></div>
        <div style="margin-top:5px;">
          <input type="text" id="commentInput-${id}" placeholder="Write a comment...">
          <button onclick="postComment('${id}')">Post</button>
        </div>
      </div>
      `;
    });
  });
}

/* ------------------ Like / Rebuzz / Delete ------------------ */
async function likeBuzz(id){
  const buzzRef=ref(db,"buzzes/"+id);
  const snap=await get(buzzRef);
  if(snap.exists()){
    const data=snap.val();
    update(buzzRef,{likes:(data.likes||0)+1});
    if(data.authorId!==currentUser.uid){
      push(ref(db,`notifications/${data.authorId}`),{message:`${currentUser.displayName} liked your Buzz`,timestamp:Date.now()});
    }
  }
}
async function rebuzz(id){
  const buzzRef=ref(db,"buzzes/"+id);
  const snap=await get(buzzRef);
  if(snap.exists()){
    const data=snap.val();
    update(buzzRef,{rebuzz:(data.rebuzz||0)+1});
    if(data.authorId!==currentUser.uid){
      push(ref(db,`notifications/${data.authorId}`),{message:`${currentUser.displayName} rebuzzed your Buzz`,timestamp:Date.now()});
    }
  }
}
async function deleteBuzz(id){if(confirm("Delete this Buzz?")) set(ref(db,"buzzes/"+id),null);}

/* ------------------ Comments ------------------ */
async function postComment(id){
  const input=document.getElementById(`commentInput-${id}`);
  const text=input.value;
  if(!text) return;
  const buzzRef=ref(db,"buzzes/"+id);
  const snap=await get(buzzRef);
  if(snap.exists()){
    const data=snap.val();
    const comments=data.comments||[];
    comments.push({author:currentUser.displayName,text:text});
    update(buzzRef,{comments:comments});
    input.value="";
  }
}
function showComments(id){
  const container=document.getElementById(`comments-${id}`);
  const buzzRef=ref(db,"buzzes/"+id);
  onValue(buzzRef,snap=>{
    const data=snap.val();
    container.innerHTML="";
    (data.comments||[]).forEach(c=>{
      container.innerHTML+=`<div class="comment"><strong>${c.author}</strong>: ${c.text}</div>`;
    });
  });
}

/* ------------------ Video Upload ------------------ */
async function uploadVideo(){
  const file=document.getElementById("videoFile").files[0];
  if(!file) return alert("Select a video!");
  const status=document.getElementById("videoStatus");status.innerText="Uploading...";
  const formData=new FormData();
  formData.append("file",file);formData.append("upload_preset","Pulsevideos");
  try{
    const res=await fetch("https://api.cloudinary.com/v1_1/dzjylmmcj/video/upload",{method:"POST",body:formData});
    const data=await res.json();
    await push(ref(db,"videos"),{videoURL:data.secure_url,format:data.format,width:data.width,height:data.height,duration:data.duration,uploadedAt:Date.now()});
    status.innerText="Upload complete!";renderVideos();
  }catch(e){status.innerText="Upload failed!";console.error(e);}
}
function renderVideos(){
  const videoFeed=document.getElementById("videoFeed");videoFeed.innerHTML="";
  onValue(ref(db,"videos"),snap=>{
    snap.forEach(child=>{const vid=child.val();videoFeed.innerHTML+=`<video controls src="${vid.videoURL}"></video>`;});
  });
}

/* ------------------ Notifications ------------------ */
function renderNotifications(){
  const notif=document.getElementById("notificationsFeed");notif.innerHTML="";
  if(!currentUser) return;
  onValue(ref(db,`notifications/${currentUser.uid}`),snap=>{
    notif.innerHTML="";
    snap.forEach(child=>{const n=child.val();notif.innerHTML+=`<div>${n.message}</div>`;});
  });
}

/* ------------------ Profile ------------------ */
function renderProfile(){
  const profile=document.getElementById("profileFeed");profile.innerHTML="";
  if(!currentUser) return;
  const userRef=ref(db,`users/${currentUser.uid}`);
  onValue(userRef,snap=>{
    const u=snap.val();
    const dp=u.dp?`<img src="${u.dp}">`:`<div class="dp-letter">${u.name[0]}</div>`;
    profile.innerHTML=`
      <div class="profile-section">${dp}<h3>${u.name}${u.verified?" ‚úîÔ∏è":""}</h3>
      <p>Username: ${u.username}</p>
      <p>Bio: ${u.bio||"No bio set"}</p>
      <p>Followers: ${u.followers} | Following: ${u.following}</p>
      <input type="text" id="bioInput" placeholder="Edit bio">
      <button onclick="updateBio()">Update Bio</button>
      <input type="file" id="dpFile" accept="image/*">
      <button onclick="updateDP()">Update DP</button>
      </div>
    `;
  });
}

async function updateBio(){
  const bio=document.getElementById("bioInput").value;
  await update(ref(db,`users/${currentUser.uid}`),{bio:bio});
}
async function updateDP(){
  const file=document.getElementById("dpFile").files[0];
  if(!file) return;
  const base64=await toBase64(file);
  await update(ref(db,`users/${currentUser.uid}`),{dp:base64});
}

/* ------------------ Search Users ------------------ */
function renderSearch(){
  const container=document.getElementById("searchUsers");
  container.innerHTML="";
  onValue(ref(db,"users"),snap=>{
    container.innerHTML="";
    snap.forEach(child=>{
      const u=child.val();
      const uid=child.key;
      const dp=u.dp?`<img src="${u.dp}" class="dp">`:`<div class="dp-letter">${u.name[0]}</div>`;
      container.innerHTML+=`<div onclick="openProfile('${uid}')">${dp} ${u.name} (@${u.username})${u.verified?" ‚úîÔ∏è":""}</div>`;
    });
  });
}
function openProfile(uid){
  showSection('profile');
  const profile=document.getElementById("profileFeed");profile.innerHTML="";
  const userRef=ref(db,`users/${uid}`);
  onValue(userRef,snap=>{
    const u=snap.val();
    const dp=u.dp?`<img src="${u.dp}">`:`<div class="dp-letter">${u.name[0]}</div>`;
    profile.innerHTML=`
      <div class="profile-section">${dp}<h3>${u.name}${u.verified?" ‚úîÔ∏è":""}</h3>
      <p>Username: ${u.username}</p>
      <p>Bio: ${u.bio||"No bio set"}</p>
      <p>Followers: ${u.followers} | Following: ${u.following}</p>
      `;
  });
}

/* ------------------ Expose Functions ------------------ */
window.login=login;window.postBuzz=postBuzz;window.likeBuzz=likeBuzz;window.rebuzz=rebuzz;window.deleteBuzz=deleteBuzz;
window.showComments=showComments;window.postComment=postComment;window.uploadVideo=uploadVideo;
window.showSection=showSection;window.renderFeed=renderFeed;window.renderVideos=renderVideos;
window.renderNotifications=renderNotifications;window.renderProfile=renderProfile;
window.renderSearch=renderSearch;
</script>
</head>
<body>
<header>Pulse üå∏üíô</header>
<nav>
<button onclick="showSection('login')">Login</button>
<button onclick="showSection('home')">Home</button>
<button onclick="showSection('profile')">Profile</button>
<button onclick="showSection('notifications')">Notifications</button>
<button onclick="showSection('search')">Search</button>
<button onclick="showSection('settings')">Settings</button>
</nav>

<section id="login" class="active">
<div class="container">
<button onclick="login()">Login with Google</button>
</div>
</section>

<section id="home">
<div class="container">
<h3>Post a Buzz</h3>
<textarea id="buzzInput" placeholder="What's happening?"></textarea>
<input type="file" id="buzzImage" accept="image/*">
<button onclick="postBuzz()">Post Buzz</button>

<h3>Feed</h3>
<div id="feed"></div>

<h3>Video Upload</h3>
<input type="file" id="videoFile" accept="video/*">
<button onclick="uploadVideo()">Upload Video</button>
<p id="videoStatus"></p>
<div id="videoFeed"></div>
</div>
</section>

<section id="profile">
<div class="container" id="profileFeed"></div>
</section>

<section id="notifications">
<div class="container">
<h3>Notifications</h3>
<div id="notificationsFeed"></div>
</div>
</section>

<section id="search">
<div class="container">
<h3>Search Users</h3>
<div class="user-list" id="searchUsers"></div>
</div>
</section>

<section id="settings">
<div class="container">
<h3>Settings</h3>
<p>Private account, block/unblock, logout, verification requests etc. can be added here.</p>
</div>
</section>
</body>
</html>
