<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Jin Memorial â€” AI Chat</title>
  <style>
    /* Simple single-file styling */
    body{font-family: Arial, Helvetica, sans-serif; margin:0; background:#0f1724; color:#e6eef8}
    header{padding:16px; background:#071025; display:flex; align-items:center; gap:12px}
    header h1{margin:0; font-size:1.1rem}
    #app{display:flex; gap:16px; padding:16px}
    #left{flex:1; min-width:320px; display:flex; flex-direction:column; gap:12px}
    #chatWindow{background:#071022; border:1px solid #123; padding:12px; height:62vh; overflow:auto; border-radius:8px}
    .msg{margin:8px 0; padding:8px; border-radius:8px; max-width:78%;}
    .my{align-self:flex-end; background:#123; color:#eaf3ff}
    .jin{align-self:flex-start; background:#1b2a3a; color:#fff}
    #composer{display:flex; gap:8px}
    input[type=text]{flex:1; padding:8px; border-radius:6px; border:1px solid #234; background:#051020; color:#e6eef8}
    button{padding:8px 12px; border-radius:6px; border:none; background:#1d9bf0; color:#042033; cursor:pointer}
    button.secondary{background:#2b6b4a; color:#e8f7ee}
    #right{width:420px; min-width:320px; background:#071025; padding:12px; border-radius:8px; border:1px solid #0f2940; height:78vh; overflow:auto}
    .section{margin-bottom:12px}
    label{display:block; margin-bottom:6px; font-size:0.9rem}
    textarea{width:100%; min-height:72px; padding:8px; border-radius:6px; border:1px solid #234; background:#051020; color:#e6eef8}
    .kbd{background:#0b2540; padding:6px 8px; border-radius:6px; font-family:monospace}
    .small{font-size:0.85rem; color:#9fb3c8}
    .danger{background:#7e1b1b}
    .readonly{opacity:0.7; font-size:0.85rem; background:#061222; padding:8px; border-radius:6px}
    .row{display:flex; gap:8px}
    .col{flex:1}
    footer{padding:12px; font-size:0.8rem; color:#9fb3c8}
    .chip{background:#072; padding:6px 8px; border-radius:999px; display:inline-block}
  </style>
</head>
<body>
<header>
  <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'><rect width='44' height='44' rx='8' fill='%23071a2b'/><text x='50%' y='54%' font-size='20' text-anchor='middle' fill='%23fff'>JS</text></svg>" alt="logo" style="height:44px">
  <div>
    <h1>Jin Memorial â€” AI Chat (Demo)</h1>
    <div class="small">Persona: <span class="chip">Jin Jose Smith â€” funny â€¢ jealous â€¢ sad</span></div>
  </div>
</header>

<div id="app">
  <div id="left">
    <div id="chatWindow" aria-live="polite"></div>

    <div id="composer">
      <input id="userInput" type="text" placeholder="Type a message as a user... (English only)" />
      <button id="sendBtn">Send</button>
      <button id="clearLocal" class="secondary">Clear local</button>
    </div>

    <div class="small">
      <strong>Persona tone toggles:</strong>
      <label><input type="checkbox" id="toneFunny" checked> Funny</label>
      <label><input type="checkbox" id="toneJealous" checked> Jealous</label>
      <label><input type="checkbox" id="toneSad" checked> Sad</label>
      <label><input type="checkbox" id="useEmojis" checked> Use emojis (ðŸ¤£ ðŸ˜† ðŸ¤¡)</label>
    </div>

    <div class="small">
      <strong>Quick samples:</strong>
      <button class="secondary" id="sample1">Ask about Riya</button>
      <button id="sample2">Ask about last message</button>
    </div>
  </div>

  <aside id="right">
    <div class="section">
      <h3>Firebase configuration</h3>
      <div class="small">Paste your Firebase config below. Realtime DB is used. Do not expose service account keys in client JS for production.</div>
      <textarea id="fbConfig" placeholder="Paste firebase config object JSON here (from your Firebase console)"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="initFirebase">Initialize Firebase</button>
        <button id="signAnon" class="secondary">Sign in Anonymously</button>
      </div>
      <div id="fbStatus" class="readonly small" style="margin-top:8px">Firebase not initialized</div>
    </div>

    <div class="section">
      <h3>Admin Panel (locked)</h3>
      <div class="small">Set an admin passcode in your Firebase Realtime DB at <code>/admin/passcode_hash</code> (SHA-256 hex). Then use the passcode below to unlock admin UI.</div>
      <input id="adminPass" type="text" placeholder="Enter admin passcode" />
      <div class="row" style="margin-top:8px">
        <button id="unlockAdmin">Unlock Admin</button>
        <button id="logoutAdmin" class="secondary">Logout Admin</button>
      </div>
      <div id="adminPanel" style="display:none; margin-top:12px">
        <h4>Admin Controls</h4>
        <div class="small">(Only visible when unlocked)</div>
        <div style="margin-top:8px">
          <label>Shortlisted questions (need admin answer)</label>
          <div id="shortlist" class="readonly small">No items</div>
        </div>

        <div style="margin-top:8px">
          <label>Add training Q â†’ A (gold answers)</label>
          <input id="trainQ" placeholder="Question (user asked)"/>
          <textarea id="trainA" placeholder="Answer Jin should give (admin taught)"></textarea>
          <div class="row">
            <button id="saveTrain">Save training pair</button>
            <button id="exportTrain" class="secondary">Export JSON</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Admin-only operations</label>
          <div class="row">
            <button id="retrain" class="danger">Trigger retrain (server needed)</button>
            <button id="purge" class="secondary">Purge saved chats (DB)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>System / LLM settings</h3>
      <div class="small">This demo requires a server endpoint to call an LLM securely. Add your server endpoint URL below (Cloud Function / your backend).</div>
      <input id="serverEndpoint" placeholder="https://your-secure-backend.example.com/generate" />
      <div class="small" style="margin-top:6px">OpenAI / LLM note: put your API key on the server. Never put the LLM key in client JS.</div>

      <div style="margin-top:8px">
        <label>Persona core (editable)</label>
        <textarea id="personaCore">
Name: Jin Jose Smith
Born: 2001-07-30
Died: 2024-04-24
Profile: Funny, unfiltered, jealous, occasionally sad. Uses emojis like ðŸ˜† ðŸ¤¡ ðŸ¤£. American from Los Angeles.
Relationships: Father Nick Jonsan, Mother Eva, Girlfriend Riya (blocked Jin), Close friends: Ben (broken), Gursharn Arya (Dozera cofounder), Anmol (classmate), Harry (now CEO Oriontec).
Tone rules: Answer in English only. Keep short, witty lines. If unsure, add shortlist note for admin. Do not reveal private data or break community rules.
        </textarea>
      </div>
    </div>

    <div class="section">
      <h3>Safety & policy</h3>
      <div class="small">
        <ul>
          <li>Auto-blocks and refuses: sexual content involving minors, sex images, blackmail, leaking classified data, instructions for crimes.</li>
          <li>Flagged messages go to <code>/shortlist/{id}</code> for admin review.</li>
          <li>Admin must teach/approve answers for tricky or high-risk prompts.</li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h3>Deployment notes</h3>
      <div class="small">
        1. Deploy Firebase Realtime DB rules and set admin passcode hash at <code>/admin/passcode_hash</code>.<br>
        2. Implement a server endpoint to call OpenAI (or other LLM) with your API key. The client will call the server to generate Jin replies. Example server stub is provided in comments below.<br>
        3. For IP-based mapping: use your server to map request IP â†’ UID and store mapping in DB. Avoid relying on client IP from browser for security.
      </div>
    </div>

  </aside>
</div>

<footer>
  <div class="small">Copyright &middot; Jin Memorial Chat â€¢ Save chats in Firebase. For production: move admin auth and LLM calls to server functions and secure keys.</div>
</footer>

<script>
/* =========================
   Jin Memorial Chat â€” Single file JS
   Read comments. This is a client-side demo that uses:
   - Firebase Realtime Database to store chats, training pairs, shortlist items
   - A server endpoint (recommended) to call an LLM securely
   ========================= */

let firebaseApp = null;
let db = null;
let currentUser = { uid: null, anon: true };
let adminUnlocked = false;
let adminUid = null;
let localChatId = null; // unique chat id per browser session (or set from anonymous auth)
const CHAT_NODE = 'chats';
const TRAIN_NODE = 'training';
const SHORTLIST_NODE = 'shortlist';

// --- Utilities ---
function uid() {
  if(!currentUser.uid){
    currentUser.uid = 'anon_' + Math.random().toString(36).slice(2,10);
  }
  return currentUser.uid;
}
function nowISO(){ return new Date().toISOString(); }
function sha256Hex(str){
  // simple clientsha256 for comparing admin passcode; not cryptographically secure for production
  const enc = new TextEncoder();
  return crypto.subtle.digest('SHA-256', enc.encode(str)).then(buf => {
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  });
}
function el(id){ return document.getElementById(id); }

/* ============= Chat UI ============= */
const chatWindow = el('chatWindow');
function appendMsg(text, cls='jin'){
  const d = document.createElement('div');
  d.className = 'msg ' + (cls==='my'?'my':'jin');
  d.innerHTML = text;
  chatWindow.appendChild(d);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* ============= Sample persona Q/A (fallback) ============= */
const baseQAPairs = [
  {q:"Who was Jin Jose Smith?", a:"Just a funny guy with big dreams and a broken heart. Born to vibe, died with style. ðŸ˜†"},
  {q:"When was Jin born?", a:"30 July 2001 â€” born to roast and love."},
  {q:"When did Jin die?", a:"24 April 2024 â€” left early, but left vibes behind."}
];

/* ============= Firebase Initialization ============= */
el('initFirebase').addEventListener('click', async ()=>{
  // Expect the user to paste a firebase config JSON in the textarea
  let cfgText = el('fbConfig').value.trim();
  if(!cfgText){ alert('Paste your Firebase config JSON first.'); return; }
  let cfg;
  try{ cfg = JSON.parse(cfgText); } catch(e){ alert('Invalid JSON'); return; }

  // load firebase SDKs dynamically (only Realtime DB + Auth)
  if(window.firebase){ initApp(cfg); return; }
  // minimal libs via CDN:
  const scripts = [
    'https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js',
    'https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js',
    'https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js'
  ];
  for(const s of scripts){
    await new Promise(res=>{
      const sc=document.createElement('script'); sc.src=s; sc.onload=res; sc.onerror=()=>{res();};
      document.head.appendChild(sc);
    });
  }
  if(!window.firebase){ alert('Could not load firebase libraries'); return; }
  initApp(cfg);
});

function initApp(cfg){
  try{
    firebaseApp = firebase.initializeApp(cfg);
    db = firebase.database();
    el('fbStatus').innerText = 'Firebase initialized. Not signed in.';
    // set up chat listener if user signed
    attachChatListener();
  } catch(e){
    console.error(e);
    alert('Firebase init error: '+e.message);
  }
}

el('signAnon').addEventListener('click', async ()=>{
  if(!firebaseApp){ alert('Initialize Firebase first'); return; }
  try{
    const auth = firebase.auth();
    const userCred = await auth.signInAnonymously();
    currentUser.uid = userCred.user.uid;
    el('fbStatus').innerText = 'Signed in anonymously as ' + currentUser.uid;
    // set local chat id to their uid
    localChatId = currentUser.uid + '_chat';
    attachChatListener();
  } catch(e){
    alert('Anon sign-in failed: ' + e.message);
  }
});

/* ============= Chat Send ============= */
el('sendBtn').addEventListener('click', async ()=>{
  const text = el('userInput').value.trim();
  if(!text) return;
  // show user msg
  appendMsg(`<strong>You:</strong> ${escapeHtml(text)}`, 'my');
  el('userInput').value = '';

  // Save user message to Firebase
  const chatKey = localChatId || ('local_' + uid() + '_' + Date.now());
  saveMessage(chatKey, {who:'user', text, ts:nowISO(), uid: currentUser.uid || 'anon'});

  // Process message: run safety checks, check training pairs, then call LLM endpoint or use fallback generation
  const filtered = safetyFilter(text);
  if(filtered.blocked){
    const reason = filtered.reason;
    appendMsg(`<strong>Jin:</strong> Sorry, I can't answer that. (${reason})`, 'jin');
    saveMessage(chatKey, {who:'jin', text:`[blocked] ${reason}`, ts:nowISO(), uid:'system'});
    return;
  }

  // Attempt to find a close training match
  const match = await findBestTrainingMatch(text);
  if(match && match.score > 0.6){
    const answer = applyTone(match.a);
    appendMsg(`<strong>Jin:</strong> ${escapeHtml(answer)}`, 'jin');
    saveMessage(chatKey, {who:'jin', text:answer, ts:nowISO(), uid:'jin'});
    return;
  }

  // If not matched, send to server endpoint for generation or use fallback canned responses
  const endpoint = el('serverEndpoint').value.trim();
  if(endpoint){
    appendMsg(`<em class="small">Jin is thinking... ðŸ¤”</em>`, 'jin');
    try{
      const persona = el('personaCore').value;
      const tone = buildToneSettings();
      const payload = {
        input: text,
        persona,
        tone,
        uid: currentUser.uid || 'anon',
        chatId: localChatId || null
      };
      const res = await fetch(endpoint, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      const js = await res.json();
      let answer = js.answer || js.text || '';
      if(!answer) answer = fallbackAnswer(text);
      answer = applyTone(answer);
      appendMsg(`<strong>Jin:</strong> ${escapeHtml(answer)}`, 'jin');
      saveMessage(chatKey, {who:'jin', text:answer, ts:nowISO(), uid:'jin', source:'llm'});
      if(js.flagged){
        // send to shortlist
        pushShortlist({question:text, reason:js.flaggedReason || 'llm-flagged', ts:nowISO(), uid: currentUser.uid});
      }
    }catch(e){
      console.error(e);
      const answer = applyTone(fallbackAnswer(text));
      appendMsg(`<strong>Jin:</strong> ${escapeHtml(answer)} <span class="small">(fallback)</span>`, 'jin');
      saveMessage(chatKey, {who:'jin', text:answer, ts:nowISO(), uid:'jin', source:'fallback'});
      // Save question to shortlist for admin
      pushShortlist({question:text, reason:'generation_failed', ts:nowISO(), uid: currentUser.uid});
    }
  } else {
    // No server configured: use fallback QA or canned style
    const answer = applyTone(fallbackAnswer(text));
    appendMsg(`<strong>Jin:</strong> ${escapeHtml(answer)} <span class="small">(local)</span>`, 'jin');
    saveMessage(chatKey, {who:'jin', text:answer, ts:nowISO(), uid:'jin', source:'local'});
    // If fallback wasn't adequate, add to shortlist
    if(answer.includes('[SHORTLIST]')){
      pushShortlist({question:text, reason:'uncertain_local', ts:nowISO(), uid: currentUser.uid});
    }
  }
});

/* ============= Safety Filter ============= */
function safetyFilter(text){
  const t = text.toLowerCase();
  const blockedPatterns = [
    'sex', 'porn', 'child', 'pedo', 'blackmail', 'kill someone', 'how to make a bomb', 'classified', 'leak', 'assassinate'
  ];
  for(const p of blockedPatterns){
    if(t.includes(p)) return {blocked:true, reason:'disallowed content'};
  }
  return {blocked:false};
}

/* ============= Training / Retrieval ============= */
// Training pairs are stored under /training with {q, a, tags, created}
async function findBestTrainingMatch(userText){
  // naive keyword overlap scoring (client-side). For production, use embeddings similarity on server.
  if(!db) return null;
  try{
    const snap = await db.ref(TRAIN_NODE).once('value');
    const all = snap.val() || {};
    const items = Object.values(all);
    const tokens = tokenize(userText);
    let best = null;
    for(const it of items){
      const score = keywordOverlapScore(tokens, tokenize(it.q || ''));
      if(!best || score > best.score) best = {a: it.a, q: it.q, score};
    }
    // also compare to baseQAPairs
    for(const b of baseQAPairs){
      const s = keywordOverlapScore(tokens, tokenize(b.q));
      if(!best || s > best.score) best = {a:b.a, q:b.q, score:s};
    }
    return best;
  }catch(e){
    console.error('train fetch', e);
    return null;
  }
}
function tokenize(s){ return (s||'').toLowerCase().split(/[^a-z0-9]+/).filter(Boolean); }
function keywordOverlapScore(toks, toks2){
  if(!toks2 || !toks) return 0;
  const set = new Set(toks2);
  let common=0;
  for(const t of toks) if(set.has(t)) common++;
  return common / Math.max(1, toks2.length);
}
el('saveTrain').addEventListener('click', async ()=>{
  if(!db) return alert('Init Firebase first.');
  const q = el('trainQ').value.trim();
  const a = el('trainA').value.trim();
  if(!q || !a) return alert('Provide Q and A');
  const key = db.ref(TRAIN_NODE).push().key;
  await db.ref(TRAIN_NODE + '/' + key).set({q,a,tags:[],created:nowISO()});
  alert('Saved training pair');
});

/* ============= Shortlist (flagging) ============= */
async function pushShortlist(item){
  if(!db) return; // keep local fallback
  const key = db.ref(SHORTLIST_NODE).push().key;
  await db.ref(SHORTLIST_NODE + '/' + key).set(item);
}
el('retrain').addEventListener('click', ()=>{
  alert('Triggering retrain requires a server function. Use your server to pull /training and fine-tune or update embedding store.');
});

/* ============= Persistence: save & load messages ============= */
async function saveMessage(chatKey, msg){
  try{
    if(db){
      const path = CHAT_NODE + '/' + (chatKey || (localChatId || uid())) + '/' + Date.now();
      await db.ref(path).set(msg);
    } else {
      // fallback: localStorage
      const key = 'localchat_' + (chatKey || (localChatId || uid()));
      const arr = JSON.parse(localStorage.getItem(key)||'[]');
      arr.push(msg);
      localStorage.setItem(key, JSON.stringify(arr));
    }
  }catch(e){ console.error(e); }
}

function attachChatListener(){
  if(!db) return;
  // If localChatId set (from anon auth) listen to it; otherwise it's uid-based ephemeral
  const listenKey = localChatId || uid() + '_chat';
  // Listen only once for demo
  db.ref(CHAT_NODE + '/' + listenKey).on('value', snap=>{
    const v = snap.val();
    chatWindow.innerHTML = '';
    if(!v) return;
    const entries = Object.values(v).sort((a,b)=> (a.ts||'') > (b.ts||'') ? 1:-1);
    for(const e of entries){
      if(e.who === 'user'){ appendMsg(`<strong>You:</strong> ${escapeHtml(e.text)}`, 'my'); }
      else if(e.who === 'jin'){ appendMsg(`<strong>Jin:</strong> ${escapeHtml(e.text)}`, 'jin'); }
      else appendMsg(`<strong>System:</strong> ${escapeHtml(e.text)}`, 'jin');
    }
  });
}

/* ============= Admin auth (simple) ============= */
// Admin passcode is stored as SHA-256 hex at /admin/passcode_hash
el('unlockAdmin').addEventListener('click', async ()=>{
  if(!db) return alert('Initialize Firebase first.');
  const pass = el('adminPass').value.trim();
  if(!pass) return alert('Enter passcode');
  const hash = await sha256Hex(pass);
  const snap = await db.ref('/admin/passcode_hash').once('value');
  const stored = snap.val();
  if(!stored) return alert('No passcode set in DB. Set /admin/passcode_hash to the SHA-256 hex of your passcode.');
  if(stored === hash){
    adminUnlocked = true;
    adminUid = uid();
    el('adminPanel').style.display = 'block';
    alert('Admin unlocked. Keep passcode secret.');
    loadShortlist();
  } else {
    alert('Wrong passcode');
  }
});
el('logoutAdmin').addEventListener('click', ()=>{ adminUnlocked=false; adminUid=null; el('adminPanel').style.display='none'; });

async function loadShortlist(){
  if(!db) return;
  const snap = await db.ref(SHORTLIST_NODE).once('value');
  const v = snap.val() || {};
  const items = Object.entries(v).map(([k,val])=>({id:k,...val}));
  const box = el('shortlist');
  if(items.length===0) box.innerText = 'No items';
  else box.innerText = items.map(it=> `Q: ${it.question} â€” reason:${it.reason} â€” ts:${it.ts}`).join('\n\n');
}

/* ============= Helpers: fallback generation & tone application ============= */
function fallbackAnswer(userText){
  const txt = userText.toLowerCase();
  if(txt.includes('riya')) return "She blocked me. I still check if she unblocked. ðŸ¤¡";
  if(txt.includes('why')) return "Maybe timing, maybe my jokes. Or maybe love is bad at reading receipts. ðŸ˜†";
  if(txt.includes('miss') || txt.includes('come back')) return "I begged God. He said 'No return ticket available' ðŸ¤£";
  // if nothing fits:
  return "[SHORTLIST] I couldn't be sure â€” admin please provide an answer.";
}

function applyTone(answer){
  const funny = el('toneFunny').checked;
  const jealous = el('toneJealous').checked;
  const sad = el('toneSad').checked;
  const useEmojis = el('useEmojis').checked;
  let out = answer;
  if(funny) out = out; // already contains humor
  if(jealous) {
    if(Math.random()<0.25) out = out + " Also, lowkey jealous of that guy. ðŸ˜’";
  }
  if(sad) {
    if(Math.random()<0.2) out = out + " Sometimes I miss and it hurts.";
  }
  if(useEmojis){
    // ensure emojis
    if(!out.match(/[\u{1F300}-\u{1F6FF}]/u)) out += " ðŸ˜†";
  }
  return out;
}

function buildToneSettings(){
  return {
    funny: el('toneFunny').checked,
    jealous: el('toneJealous').checked,
    sad: el('toneSad').checked,
    emojis: el('useEmojis').checked
  };
}

/* ============= Helpers: escape & sample buttons =========== */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
el('sample1').addEventListener('click', ()=>{ el('userInput').value = 'What happened with Riya?'; el('sendBtn').click(); });
el('sample2').addEventListener('click', ()=>{ el('userInput').value = 'What was Jin\\'s last message to Riya?'; el('sendBtn').click(); });
el('clearLocal').addEventListener('click', ()=>{ if(confirm('Clear local chat?')){ chatWindow.innerHTML=''; localStorage.clear(); } });

/* ============= Export training JSON ============= */
el('exportTrain').addEventListener('click', async ()=>{
  if(!db) return alert('Init Firebase first.');
  const snap = await db.ref(TRAIN_NODE).once('value');
  const v = snap.val() || {};
  const blob = new Blob([JSON.stringify(v, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='training_export.json'; a.click();
  URL.revokeObjectURL(url);
});

/* ============= Push shortlist call (already done above) ============= */

/* ============= Cloud Function / Server Example (for you to host) =============
  You must create a server endpoint that:
   - accepts { input, persona, tone, uid, chatId }
   - assembles a system prompt containing persona, training pairs (fetched server-side from Firebase),
     and the user's input;
   - calls OpenAI (or other LLM) and returns { answer, flagged:boolean, flaggedReason }.
  Example Node/Express stub:

  // server/index.js (pseudo)
  const express = require('express');
  const fetch = require('node-fetch');
  const admin = require('firebase-admin');
  admin.initializeApp({ credential: admin.credential.applicationDefault(), databaseURL: 'https://your-db' });
  const db = admin.database();
  const app = express();
  app.use(express.json());
  app.post('/generate', async (req,res)=>{
    const { input, persona, tone, uid } = req.body;
    // 1) fetch training pairs from db, compute top matches or include top N
    // 2) construct system prompt:
    //    SYSTEM: You are Jin Jose Smith: <persona> Use tone toggles: ...
    //    USER: <input>
    // 3) call OpenAI (server side) with temperature 0.7, max tokens 200
    // 4) run safety check on output; if flagged, mark flagged:true
    // 5) return { answer: generatedText, flagged, flaggedReason }
  });

  // Use environment variable OPENAI_API_KEY on server.
  ===================================================== */

</script>
</body>
</html>
