<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - Social Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2XeuTfHZ7FYKLoYb4epKp3upmVqG0fzE",
            authDomain: "pulse-17f40.firebaseapp.com",
            databaseURL: "https://pulse-17f40-default-rtdb.firebaseio.com",
            projectId: "pulse-17f40",
            storageBucket: "pulse-17f40.firebasestorage.app",
            messagingSenderId: "259780854138",
            appId: "1:259780854138:web:89c265fd22a34a7f1fd6c3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        window.firebaseAuth = auth;
        window.firebaseDb = database;
        window.googleProvider = provider;
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #ec4899 0%, #3b82f6 50%, #8b5cf6 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        .pulse-shadow {
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.3);
        }
        .verified-badge {
            background: linear-gradient(45deg, #ec4899, #3b82f6);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
        }
        .verified-badge svg {
            width: 12px;
            height: 12px;
            color: white;
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full pulse-shadow">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">Pulse</h1>
                <p class="text-white/80">Connect with the world through Buzz</p>
            </div>
            <button onclick="signInWithGoogle()" class="w-full bg-white text-gray-800 py-3 px-6 rounded-full font-semibold hover:bg-gray-100 transition-colors flex items-center justify-center gap-3">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="hidden min-h-screen bg-gray-50 p-4">
        <div class="max-w-md mx-auto pt-20">
            <div class="bg-white rounded-3xl p-8 pulse-shadow">
                <div id="nameStep" class="setup-step">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">What's your name?</h2>
                    <input type="text" id="fullName" placeholder="Enter your full name" class="w-full p-4 border border-gray-200 rounded-2xl mb-6 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <button onclick="nextStep('username')" class="w-full gradient-bg text-white py-3 px-6 rounded-full font-semibold">Next</button>
                </div>

                <div id="usernameStep" class="setup-step hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Choose a username</h2>
                    <input type="text" id="username" placeholder="username123" class="w-full p-4 border border-gray-200 rounded-2xl mb-2 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <p class="text-sm text-gray-500 mb-6">Only letters and numbers allowed</p>
                    <button onclick="checkUsername()" class="w-full gradient-bg text-white py-3 px-6 rounded-full font-semibold">Next</button>
                </div>

                <div id="dobStep" class="setup-step hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Date of Birth</h2>
                    <input type="date" id="dateOfBirth" class="w-full p-4 border border-gray-200 rounded-2xl mb-6 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <button onclick="nextStep('profile')" class="w-full gradient-bg text-white py-3 px-6 rounded-full font-semibold">Next</button>
                </div>

                <div id="profileStep" class="setup-step hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Profile Picture</h2>
                    <div class="text-center mb-6">
                        <div id="profilePreview" class="w-24 h-24 rounded-full mx-auto mb-4 gradient-bg flex items-center justify-center text-white text-2xl font-bold"></div>
                        <input type="file" id="profileImage" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        <button onclick="document.getElementById('profileImage').click()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full mr-2">Upload Photo</button>
                        <button onclick="completeSetup()" class="gradient-bg text-white px-6 py-2 rounded-full">Skip</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <!-- Desktop Navigation -->
            <div class="hidden md:block max-w-6xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-2xl font-bold gradient-bg bg-clip-text text-transparent">Pulse</h1>
                    <div class="flex items-center gap-6">
                        <button onclick="showScreen('search')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        </button>
                        <button onclick="showScreen('home')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                        </button>
                        <button onclick="showScreen('notifications')" class="nav-btn text-gray-600 hover:text-pink-500 relative">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                            <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"></span>
                        </button>
                        <button onclick="showScreen('messages')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                        </button>
                        <button onclick="showScreen('settings')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <div class="md:hidden px-4 py-3">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-bold gradient-bg bg-clip-text text-transparent">Pulse</h1>
                    <button onclick="showScreen('search')" class="text-gray-600 hover:text-pink-500">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Mobile Bottom Navigation -->
        <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
            <div class="flex justify-around py-2">
                <button onclick="showScreen('home')" class="mobile-nav-btn flex flex-col items-center py-2 px-3 text-gray-600 hover:text-pink-500">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    <span class="text-xs mt-1">Home</span>
                </button>
                <button onclick="showScreen('notifications')" class="mobile-nav-btn flex flex-col items-center py-2 px-3 text-gray-600 hover:text-pink-500 relative">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                    <span class="text-xs mt-1">Alerts</span>
                    <span id="mobileNotificationBadge" class="hidden absolute top-1 right-2 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center"></span>
                </button>
                <button onclick="showScreen('messages')" class="mobile-nav-btn flex flex-col items-center py-2 px-3 text-gray-600 hover:text-pink-500">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                    <span class="text-xs mt-1">Messages</span>
                </button>
                <button onclick="showScreen('settings')" class="mobile-nav-btn flex flex-col items-center py-2 px-3 text-gray-600 hover:text-pink-500">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                    <span class="text-xs mt-1">Settings</span>
                </button>
            </div>
        </div>

        <!-- Search Screen -->
        <div id="searchScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <div class="mb-6">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search users, buzzes..." class="w-full p-4 pl-12 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" oninput="performSearch()">
                    <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="space-y-4">
                <!-- Default trending/suggested content -->
                <div id="trendingSection">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Trending</h3>
                    <div class="bg-white rounded-3xl p-6 pulse-shadow">
                        <p class="text-gray-500 text-center">Start typing to search for users and buzzes!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="homeScreen" class="max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <!-- Create Buzz -->
            <div class="bg-white rounded-3xl p-6 mb-6 pulse-shadow">
                <div class="flex gap-4">
                    <div id="userAvatar" class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center text-white font-bold"></div>
                    <div class="flex-1">
                        <textarea id="buzzText" placeholder="What's buzzing?" class="w-full p-4 border border-gray-200 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-500" rows="3"></textarea>
                        <div class="flex justify-between items-center mt-4">
                            <div class="flex gap-4">
                                <input type="file" id="buzzImage" accept="image/*" class="hidden" onchange="handleBuzzMedia(event, 'image')">
                                <input type="file" id="buzzVideo" accept="video/*" class="hidden" onchange="handleBuzzMedia(event, 'video')">
                                <button onclick="document.getElementById('buzzImage').click()" class="text-pink-500 hover:bg-pink-50 p-2 rounded-full" title="Add Photo">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                </button>
                                <button onclick="document.getElementById('buzzVideo').click()" class="text-blue-500 hover:bg-blue-50 p-2 rounded-full" title="Add Video">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                                </button>
                            </div>
                            <button id="buzzButton" onclick="postBuzz()" class="gradient-bg text-white px-6 py-2 rounded-full font-semibold hover:opacity-90 transition-opacity">Buzz</button>
                        </div>
                        <div id="buzzMediaPreview" class="hidden mt-4">
                            <div class="relative">
                                <img id="buzzImageDisplay" class="hidden w-full rounded-2xl max-h-64 object-cover">
                                <video id="buzzVideoDisplay" class="hidden w-full rounded-2xl max-h-64" controls>
                                    Your browser does not support the video tag.
                                </video>
                                <button onclick="clearBuzzMedia()" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1 hover:bg-opacity-70">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div id="buzzFeed"></div>
        </div>

        <!-- Notifications Screen -->
        <div id="notificationsScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Notifications</h2>
            <div id="notificationsList" class="space-y-4">
                <div class="bg-white rounded-3xl p-6 text-center">
                    <p class="text-gray-500">No notifications yet</p>
                </div>
            </div>
        </div>

        <!-- Messages Screen -->
        <div id="messagesScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Messages</h2>
            <div class="bg-white rounded-3xl p-6 text-center">
                <p class="text-gray-500">Messages feature coming soon!</p>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
            <div class="bg-white rounded-3xl p-6 space-y-4">
                <button onclick="showProfile()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span class="font-medium">Profile</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </button>
                
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                        <span class="font-medium">Privacy</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="privateAccount" class="sr-only peer" onchange="togglePrivateAccount()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                    </label>
                </div>

                <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                        <span class="font-medium">Notifications</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>

                <button onclick="showVerificationRequest()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        <span class="font-medium">Request Verification</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </button>

                <button onclick="showBlockedUsers()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/></svg>
                        <span class="font-medium">Blocked Users</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </button>

                <button onclick="addAccount()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span class="font-medium">Add Account</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </button>

                <button onclick="signOutUser()" class="w-full flex items-center gap-3 p-4 hover:bg-red-50 rounded-2xl text-red-600 font-medium">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profileScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <div class="bg-white rounded-3xl p-6 mb-6 pulse-shadow">
                <!-- Profile Header -->
                <div class="flex items-start gap-4 mb-6">
                    <div id="profileAvatar" class="w-20 h-20 rounded-full gradient-bg flex items-center justify-center text-white text-2xl font-bold"></div>
                    <div class="flex-1">
                        <h2 id="profileName" class="text-xl font-bold text-gray-800"></h2>
                        <p id="profileUsername" class="text-gray-500 mb-2"></p>
                        <div class="flex gap-4 text-sm text-gray-600">
                            <span><strong id="followingCount">0</strong> Following</span>
                            <span><strong id="followersCount">0</strong> Followers</span>
                        </div>
                    </div>
                    <button onclick="editProfile()" class="px-4 py-2 border border-gray-300 rounded-full text-sm font-medium hover:bg-gray-50">
                        Edit Profile
                    </button>
                </div>

                <!-- Profile Tabs -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button onclick="showProfileTab('buzzes')" class="profile-tab active px-4 py-2 font-medium text-pink-500 border-b-2 border-pink-500">
                        Buzzes
                    </button>
                    <button onclick="showProfileTab('rebuzzes')" class="profile-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Rebuzzes
                    </button>
                    <button onclick="showProfileTab('media')" class="profile-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Media
                    </button>
                    <button onclick="showProfileTab('likes')" class="profile-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Likes
                    </button>
                </div>

                <!-- Profile Content -->
                <div id="profileBuzzes" class="profile-content"></div>
                <div id="profileRebuzzes" class="profile-content hidden"></div>
                <div id="profileMedia" class="profile-content hidden"></div>
                <div id="profileLikes" class="profile-content hidden"></div>
            </div>
        </div>

        <!-- Blocked Users Screen -->
        <div id="blockedUsersScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="showScreen('settings')" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2 class="text-2xl font-bold text-gray-800">Blocked Users</h2>
            </div>
            <div id="blockedUsersList" class="bg-white rounded-3xl p-6">
                <p class="text-gray-500 text-center">No blocked users</p>
            </div>
        </div>

        <!-- Verification Request Screen -->
        <div id="verificationRequestScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="showScreen('settings')" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2 class="text-2xl font-bold text-gray-800">Request Verification</h2>
            </div>

            <div class="bg-white rounded-3xl p-6 pulse-shadow">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-pink-500 to-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Get Verified</h3>
                    <p class="text-gray-600">Submit your verification request to get the verified badge</p>
                </div>

                <form id="verificationForm" class="space-y-6">
                    <!-- Full Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name (as on National ID) *</label>
                        <input type="text" id="verifyFullName" required class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Enter your full legal name">
                    </div>

                    <!-- Question 1 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Why do you think you deserve the verified badge? *</label>
                        <textarea id="verifyReason" required rows="4" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Explain why you should be verified (e.g., public figure, influencer, business, etc.)"></textarea>
                    </div>

                    <!-- Question 2 (Optional) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Other name you're known by (Optional)</label>
                        <input type="text" id="verifyKnownAs" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Stage name, business name, etc.">
                    </div>

                    <!-- Country Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                        <select id="verifyCountry" required class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" onchange="updateDocumentOptions()">
                            <option value="">Select your country</option>
                            <option value="US">United States</option>
                            <option value="IN">India</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="RU">Russia</option>
                            <option value="CN">China</option>
                            <option value="KR">South Korea</option>
                            <option value="SG">Singapore</option>
                            <option value="AE">UAE</option>
                            <option value="SA">Saudi Arabia</option>
                            <option value="ZA">South Africa</option>
                            <option value="NG">Nigeria</option>
                            <option value="EG">Egypt</option>
                            <option value="AR">Argentina</option>
                            <option value="CL">Chile</option>
                            <option value="CO">Colombia</option>
                            <option value="PE">Peru</option>
                            <option value="TH">Thailand</option>
                            <option value="VN">Vietnam</option>
                            <option value="PH">Philippines</option>
                            <option value="ID">Indonesia</option>
                            <option value="MY">Malaysia</option>
                            <option value="BD">Bangladesh</option>
                            <option value="PK">Pakistan</option>
                            <option value="LK">Sri Lanka</option>
                            <option value="NP">Nepal</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <!-- Document Type -->
                    <div id="documentTypeSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document Type *</label>
                        <select id="verifyDocumentType" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500">
                            <option value="">Select document type</option>
                        </select>
                    </div>

                    <!-- Document Upload -->
                    <div id="documentUploadSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Document *</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center">
                            <input type="file" id="verifyDocument" accept="image/*" class="hidden" onchange="handleDocumentUpload(event)">
                            <div id="documentUploadArea" onclick="document.getElementById('verifyDocument').click()" class="cursor-pointer">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                                <p class="text-gray-600 mb-2">Click to upload your document</p>
                                <p class="text-sm text-gray-500">PNG, JPG up to 5MB</p>
                            </div>
                            <div id="documentPreview" class="hidden">
                                <img id="documentImage" class="max-w-full h-48 object-cover rounded-lg mx-auto">
                                <button type="button" onclick="removeDocument()" class="mt-2 text-red-500 hover:text-red-700">Remove</button>
                            </div>
                        </div>
                    </div>

                    <!-- Social Media Links (Optional) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Verified Social Media or News Links (Optional)</label>
                        <p class="text-sm text-gray-500 mb-3">Add up to 5 links where you're verified or mentioned</p>
                        <div id="socialLinksContainer">
                            <div class="flex gap-2 mb-2">
                                <input type="url" class="flex-1 p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="https://instagram.com/yourprofile">
                                <button type="button" onclick="addSocialLink()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-2xl hover:bg-gray-200">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button type="submit" class="w-full gradient-bg text-white py-3 px-6 rounded-full font-semibold hover:opacity-90 transition-opacity">
                            Submit Verification Request
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- User Profile View Screen -->
        <div id="userProfileScreen" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="goBackFromUserProfile()" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2 class="text-xl font-bold text-gray-800">Profile</h2>
            </div>
            
            <div class="bg-white rounded-3xl p-6 mb-6 pulse-shadow">
                <!-- User Profile Header -->
                <div class="flex items-start gap-4 mb-6">
                    <div id="viewUserAvatar" class="w-20 h-20 rounded-full gradient-bg flex items-center justify-center text-white text-2xl font-bold"></div>
                    <div class="flex-1">
                        <h2 id="viewUserName" class="text-xl font-bold text-gray-800"></h2>
                        <p id="viewUserUsername" class="text-gray-500 mb-2"></p>
                        <p id="viewUserBio" class="text-gray-700 mb-3"></p>
                        <div class="flex gap-4 text-sm text-gray-600">
                            <span><strong id="viewFollowingCount">0</strong> Following</span>
                            <span><strong id="viewFollowersCount">0</strong> Followers</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button id="followButton" onclick="toggleFollow()" class="px-4 py-2 gradient-bg text-white rounded-full text-sm font-medium hover:opacity-90">
                            Follow
                        </button>
                        <button onclick="showUserOptions()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- User Profile Tabs -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button onclick="showUserProfileTab('buzzes')" class="user-profile-tab active px-4 py-2 font-medium text-pink-500 border-b-2 border-pink-500">
                        Buzzes
                    </button>
                    <button onclick="showUserProfileTab('media')" class="user-profile-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Media
                    </button>
                </div>

                <!-- User Profile Content -->
                <div id="userProfileBuzzes" class="user-profile-content"></div>
                <div id="userProfileMedia" class="user-profile-content hidden"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Authentication
        async function signInWithGoogle() {
            try {
                const { signInWithPopup } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                const result = await signInWithPopup(window.firebaseAuth, window.googleProvider);
                currentUser = result.user;
                checkUserSetup();
            } catch (error) {
                console.error('Sign in error:', error);
            }
        }

        async function checkUserSetup() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                showMainApp();
            } else {
                showSetupScreen();
            }
        }

        function showSetupScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('profilePreview').textContent = currentUser.displayName.charAt(0).toUpperCase();
        }

        function nextStep(step) {
            document.querySelectorAll('.setup-step').forEach(s => s.classList.add('hidden'));
            document.getElementById(step + 'Step').classList.remove('hidden');
        }

        async function checkUsername() {
            const username = document.getElementById('username').value.toLowerCase();
            if (!/^[a-z0-9]+$/.test(username)) {
                alert('Username can only contain letters and numbers');
                return;
            }

            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const usernameRef = ref(window.firebaseDb, `usernames/${username}`);
            const snapshot = await get(usernameRef);
            
            if (snapshot.exists()) {
                alert('Username already taken');
                return;
            }
            
            nextStep('dob');
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Compress setup profile image
                compressImage(file, (compressedDataUrl) => {
                    currentBuzzImage = compressedDataUrl;
                    document.getElementById('profilePreview').style.backgroundImage = `url(${compressedDataUrl})`;
                    document.getElementById('profilePreview').style.backgroundSize = 'cover';
                    document.getElementById('profilePreview').textContent = '';
                });
            }
        }

        async function completeSetup() {
            const { ref, set } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const fullName = document.getElementById('fullName').value;
            const username = document.getElementById('username').value.toLowerCase();
            const dob = document.getElementById('dateOfBirth').value;

            // Create user data with proper null handling
            const userData = {
                uid: currentUser.uid,
                fullName: fullName || 'Unknown User',
                username: username || 'unknown',
                email: currentUser.email || '',
                dateOfBirth: dob || '',
                createdAt: Date.now(),
                followers: 0,
                following: 0
            };

            // Only add profileImage if it exists (not null/undefined)
            if (currentBuzzImage) {
                userData.profileImage = currentBuzzImage;
            }

            await set(ref(window.firebaseDb, `users/${currentUser.uid}`), userData);
            await set(ref(window.firebaseDb, `usernames/${username}`), currentUser.uid);

            showMainApp();
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadUserData();
            loadBuzzFeed();
            updateNotificationBadge(); // Load notification count on startup
            
            // Check verification status on app load
            checkUserVerificationStatus();
        }

        async function loadUserData() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            const avatar = document.getElementById('userAvatar');
            if (userData.profileImage) {
                avatar.style.backgroundImage = `url(${userData.profileImage})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = userData.fullName.charAt(0).toUpperCase();
            }
        }

        // Check user verification status on app load
        async function checkUserVerificationStatus() {
            const { ref, get, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            
            // Listen for changes in user verification status
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                if (userData && userData.isVerified) {
                    // User is verified, update UI everywhere
                    updateVerificationUI(true);
                }
            });
        }

        // Fix verification for specific user
        async function fixUserVerification() {
            const { ref, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const targetUserId = 'TxX2zJmiA1MTc3cSkpk6D86nH3u2';
            
            try {
                // Set user as verified
                await update(ref(window.firebaseDb, `users/${targetUserId}`), {
                    isVerified: true,
                    verificationApproved: true,
                    verificationDate: Date.now()
                });

                // Send congratulations notification
                await createVerificationNotification(targetUserId);
                
                console.log('User verification fixed and notification sent!');
            } catch (error) {
                console.error('Error fixing verification:', error);
            }
        }

        // Create verification approval notification
        async function createVerificationNotification(userId) {
            const { ref, push } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            
            const notificationData = {
                type: 'verification_approved',
                fromUserId: 'system',
                fromUserName: 'Pulse Team',
                fromUserUsername: 'pulse',
                title: 'Congratulations! 🎉',
                message: 'Your verification request has been approved! You now have the verified badge.',
                timestamp: Date.now(),
                read: false
            };

            await push(ref(window.firebaseDb, `notifications/${userId}`), notificationData);
        }

        // Auto-fix verification on app load
        setTimeout(() => {
            if (window.firebaseDb) {
                fixUserVerification();
            }
        }, 2000);

        function updateVerificationUI(isVerified) {
            // This function will be called when verification status changes
            // It will trigger a refresh of all user content to show verified badges
            if (isVerified) {
                loadBuzzFeed(); // Refresh feed to show verified badges
                loadUserData(); // Refresh user data
            }
        }

        let previousScreen = 'home';

        function showScreen(screen) {
            // Store previous screen for back navigation
            const currentScreen = document.querySelector('[id$="Screen"]:not(.hidden)')?.id?.replace('Screen', '') || 'home';
            if (screen !== 'userProfile') {
                previousScreen = currentScreen;
            }

            document.querySelectorAll('#homeScreen, #searchScreen, #notificationsScreen, #messagesScreen, #settingsScreen, #profileScreen, #blockedUsersScreen, #userProfileScreen, #verificationRequestScreen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screen + 'Screen').classList.remove('hidden');

            // Update mobile navigation active state
            updateMobileNavigation(screen);

            // Load screen-specific data
            if (screen === 'notifications') {
                loadNotifications();
            } else if (screen === 'search') {
                document.getElementById('searchInput').focus();
                showTrendingContent();
            }
        }

        function updateMobileNavigation(activeScreen) {
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.classList.remove('text-pink-500');
                btn.classList.add('text-gray-600');
            });

            // Find and highlight active button
            const activeButton = document.querySelector(`[onclick="showScreen('${activeScreen}')"]`);
            if (activeButton && activeButton.classList.contains('mobile-nav-btn')) {
                activeButton.classList.remove('text-gray-600');
                activeButton.classList.add('text-pink-500');
            }
        }

        function showProfile() {
            showScreen('profile');
            loadProfileData();
        }

        // Search functionality
        let searchTimeout;
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // Debounce search
            searchTimeout = setTimeout(async () => {
                if (query.length === 0) {
                    showTrendingContent();
                    return;
                }

                if (query.length < 2) {
                    return;
                }

                await searchUsersAndBuzzes(query);
            }, 300);
        }

        async function showTrendingContent() {
            // Show all users when search is empty
            await searchUsersAndBuzzes('');
        }

        async function searchUsersAndBuzzes(query) {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            
            // Get all users
            const usersRef = ref(window.firebaseDb, 'users');
            const usersSnapshot = await get(usersRef);
            const users = [];
            
            if (usersSnapshot.exists()) {
                usersSnapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    // Show all users if query is empty or matches
                    if (!query || 
                        user.fullName.toLowerCase().includes(query) || 
                        user.username.toLowerCase().includes(query)) {
                        users.push({ id: childSnapshot.key, ...user });
                    }
                });
            }

            // Search buzzes only if there's a query
            const buzzes = [];
            if (query) {
                const buzzesRef = ref(window.firebaseDb, 'buzzes');
                const buzzesSnapshot = await get(buzzesRef);
                
                if (buzzesSnapshot.exists()) {
                    buzzesSnapshot.forEach((childSnapshot) => {
                        const buzz = childSnapshot.val();
                        if (buzz.text.toLowerCase().includes(query)) {
                            buzzes.push({ id: childSnapshot.key, ...buzz });
                        }
                    });
                }
            }

            renderSearchResults(users, buzzes, query);
        }

        function renderSearchResults(users, buzzes, query) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            // Users section
            if (users.length > 0) {
                const usersSection = document.createElement('div');
                usersSection.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800 mb-4">People</h3>
                    <div class="space-y-3">
                        ${users.map(user => `
                            <div class="bg-white rounded-2xl p-4 pulse-shadow cursor-pointer hover:bg-gray-50" onclick="viewUserProfile('${user.id}')">
                                <div class="flex items-center gap-3">
                                    ${user.profileImage ? 
                                        `<div class="w-12 h-12 rounded-full" style="background-image: url(${user.profileImage}); background-size: cover;"></div>` :
                                        `<div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center text-white font-bold">${user.fullName.charAt(0).toUpperCase()}</div>`
                                    }
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-800 flex items-center">${user.fullName}${user.isVerified ? getVerifiedBadge() : ''}</p>
                                        <p class="text-gray-500">@${user.username}</p>
                                        ${user.bio ? `<p class="text-sm text-gray-600 mt-1">${user.bio}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                resultsContainer.appendChild(usersSection);
            }

            // Buzzes section
            if (buzzes.length > 0) {
                const buzzesSection = document.createElement('div');
                buzzesSection.className = users.length > 0 ? 'mt-6' : '';
                buzzesSection.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Buzzes</h3>
                    <div class="space-y-4">
                        ${buzzes.map(buzz => createBuzzElement(buzz).outerHTML).join('')}
                    </div>
                `;
                resultsContainer.appendChild(buzzesSection);
            }

            // No results
            if (users.length === 0 && buzzes.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="bg-white rounded-3xl p-6 pulse-shadow text-center">
                        <p class="text-gray-500">${query ? `No results found for "${query}"` : 'No users found'}</p>
                    </div>
                `;
            }
        }

        function showVerificationRequest() {
            showScreen('verificationRequest');
            checkVerificationStatus();
        }

        function showBlockedUsers() {
            showScreen('blockedUsers');
            loadBlockedUsers();
        }

        // User profile viewing
        let currentViewingUserId = null;

        async function viewUserProfile(userId) {
            if (userId === currentUser.uid) {
                showProfile();
                return;
            }

            currentViewingUserId = userId;
            showScreen('userProfile');
            await loadUserProfileData(userId);
        }

        function goBackFromUserProfile() {
            showScreen(previousScreen);
        }

        async function loadUserProfileData(userId) {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${userId}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            if (!userData) {
                alert('User not found');
                goBackFromUserProfile();
                return;
            }

            // Update profile info
            document.getElementById('viewUserName').innerHTML = userData.fullName + (userData.isVerified ? getVerifiedBadge() : '');
            document.getElementById('viewUserUsername').textContent = `@${userData.username}`;
            document.getElementById('viewUserBio').textContent = userData.bio || '';
            document.getElementById('viewFollowingCount').textContent = (typeof userData.following === 'number') ? userData.following : 0;
            document.getElementById('viewFollowersCount').textContent = (typeof userData.followers === 'number') ? userData.followers : 0;

            const avatar = document.getElementById('viewUserAvatar');
            if (userData.profileImage) {
                avatar.style.backgroundImage = `url(${userData.profileImage})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = userData.fullName.charAt(0).toUpperCase();
                avatar.style.backgroundImage = '';
            }

            // Update follow button
            await updateFollowButton(userId);

            // Load user's buzzes
            loadViewUserBuzzes(userId);
        }

        async function updateFollowButton(userId) {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const followRef = ref(window.firebaseDb, `users/${currentUser.uid}/following/${userId}`);
            const snapshot = await get(followRef);
            
            const followButton = document.getElementById('followButton');
            if (snapshot.exists()) {
                followButton.textContent = 'Following';
                followButton.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-300';
            } else {
                followButton.textContent = 'Follow';
                followButton.className = 'px-4 py-2 gradient-bg text-white rounded-full text-sm font-medium hover:opacity-90';
            }
        }

        async function toggleFollow() {
            const followButton = document.getElementById('followButton');
            
            // Prevent multiple clicks
            if (followButton.disabled) return;
            followButton.disabled = true;
            followButton.style.opacity = '0.7';
            
            try {
                const { ref, get, set, update, remove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
                const followRef = ref(window.firebaseDb, `users/${currentUser.uid}/following/${currentViewingUserId}`);
                const snapshot = await get(followRef);
                
                if (snapshot.exists()) {
                    // Unfollow
                    await remove(followRef);
                    await remove(ref(window.firebaseDb, `users/${currentViewingUserId}/followers/${currentUser.uid}`));
                    
                    // Update counts
                    const currentUserRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
                    const targetUserRef = ref(window.firebaseDb, `users/${currentViewingUserId}`);
                    
                    const currentUserData = (await get(currentUserRef)).val();
                    const targetUserData = (await get(targetUserRef)).val();
                    
                    const newFollowing = Math.max(0, (typeof currentUserData.following === 'number' ? currentUserData.following : 0) - 1);
                    const newFollowers = Math.max(0, (typeof targetUserData.followers === 'number' ? targetUserData.followers : 0) - 1);
                    
                    await update(currentUserRef, { following: newFollowing });
                    await update(targetUserRef, { followers: newFollowers });
                    
                    // Update UI immediately
                    followButton.textContent = 'Follow';
                    followButton.className = 'px-4 py-2 gradient-bg text-white rounded-full text-sm font-medium hover:opacity-90';
                    document.getElementById('viewFollowersCount').textContent = newFollowers;
                } else {
                    // Follow
                    await set(followRef, { timestamp: Date.now() });
                    await set(ref(window.firebaseDb, `users/${currentViewingUserId}/followers/${currentUser.uid}`), { timestamp: Date.now() });
                    
                    // Update counts
                    const currentUserRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
                    const targetUserRef = ref(window.firebaseDb, `users/${currentViewingUserId}`);
                    
                    const currentUserData = (await get(currentUserRef)).val();
                    const targetUserData = (await get(targetUserRef)).val();
                    
                    const newFollowing = (typeof currentUserData.following === 'number' ? currentUserData.following : 0) + 1;
                    const newFollowers = (typeof targetUserData.followers === 'number' ? targetUserData.followers : 0) + 1;
                    
                    await update(currentUserRef, { following: newFollowing });
                    await update(targetUserRef, { followers: newFollowers });

                    // Update UI immediately
                    followButton.textContent = 'Following';
                    followButton.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-300';
                    document.getElementById('viewFollowersCount').textContent = newFollowers;

                    // Create notification
                    await createNotification(currentViewingUserId, 'follow', null, currentUser.uid);
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
            } finally {
                // Re-enable button
                followButton.disabled = false;
                followButton.style.opacity = '1';
            }
        }

        async function loadViewUserBuzzes(userId) {
            const { ref, query, orderByChild, equalTo, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('authorId'), equalTo(userId));
            
            onValue(buzzesRef, (snapshot) => {
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.unshift({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderViewUserBuzzes(buzzes);
            });
        }

        function renderViewUserBuzzes(buzzes) {
            const container = document.getElementById('userProfileBuzzes');
            container.innerHTML = '';

            if (buzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No buzzes yet</p>';
                return;
            }

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                container.appendChild(buzzElement);
            });
        }

        function showUserProfileTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.user-profile-tab').forEach(t => {
                t.classList.remove('active', 'text-pink-500', 'border-b-2', 'border-pink-500');
                t.classList.add('text-gray-500');
            });
            
            event.target.classList.add('active', 'text-pink-500', 'border-b-2', 'border-pink-500');
            event.target.classList.remove('text-gray-500');

            // Show content
            document.querySelectorAll('.user-profile-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`userProfile${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');

            // Load content based on tab
            if (tab === 'media') {
                loadViewUserMedia();
            }
        }

        async function loadViewUserMedia() {
            const { ref, query, orderByChild, equalTo, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('authorId'), equalTo(currentViewingUserId));
            
            onValue(buzzesRef, (snapshot) => {
                const mediaBuzzes = [];
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.image) {
                        mediaBuzzes.unshift({ id: childSnapshot.key, ...buzz });
                    }
                });
                renderViewUserMedia(mediaBuzzes);
            });
        }

        function renderViewUserMedia(buzzes) {
            const container = document.getElementById('userProfileMedia');
            container.innerHTML = '';

            if (buzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No media posts yet</p>';
                return;
            }

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                container.appendChild(buzzElement);
            });
        }

        function showUserOptions() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-4">User Options</h3>
                    <div class="space-y-3">
                        <button onclick="blockUser(); closeUserOptionsModal();" class="w-full p-3 text-left hover:bg-red-50 rounded-2xl text-red-600 font-medium">
                            Block User
                        </button>
                        <button onclick="reportUser(); closeUserOptionsModal();" class="w-full p-3 text-left hover:bg-gray-50 rounded-2xl text-gray-700">
                            Report User
                        </button>
                        <button onclick="closeUserOptionsModal()" class="w-full p-3 text-center bg-gray-100 hover:bg-gray-200 rounded-2xl font-medium">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeUserOptionsModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        async function blockUser() {
            const { ref, set, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentViewingUserId}`);
            const userData = (await get(userRef)).val();
            
            await set(ref(window.firebaseDb, `users/${currentUser.uid}/blocked/${currentViewingUserId}`), {
                name: userData.fullName,
                username: userData.username,
                timestamp: Date.now()
            });
            
            alert('User blocked successfully');
            goBackFromUserProfile();
        }

        function reportUser() {
            alert('Report submitted. We will review this user.');
        }

        async function loadProfileData() {
            const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            // Update profile info
            document.getElementById('profileName').innerHTML = userData.fullName + (userData.isVerified ? getVerifiedBadge() : '');
            document.getElementById('profileUsername').textContent = `@${userData.username}`;
            document.getElementById('followingCount').textContent = (typeof userData.following === 'number') ? userData.following : 0;
            document.getElementById('followersCount').textContent = (typeof userData.followers === 'number') ? userData.followers : 0;

            const avatar = document.getElementById('profileAvatar');
            if (userData.profileImage) {
                avatar.style.backgroundImage = `url(${userData.profileImage})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = userData.fullName.charAt(0).toUpperCase();
            }

            // Load user's buzzes
            loadUserBuzzes();
        }

        async function loadUserBuzzes() {
            const { ref, query, orderByChild, equalTo, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('authorId'), equalTo(currentUser.uid));
            
            onValue(buzzesRef, (snapshot) => {
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.unshift({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderProfileBuzzes(buzzes);
            });
        }

        async function renderProfileBuzzes(buzzes) {
            const container = document.getElementById('profileBuzzes');
            container.innerHTML = '';

            if (buzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No buzzes yet</p>';
                return;
            }

            for (const buzz of buzzes) {
                const buzzElement = await createBuzzElement(buzz);
                container.appendChild(buzzElement);
            }
        }

        function showProfileTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab').forEach(t => {
                t.classList.remove('active', 'text-pink-500', 'border-b-2', 'border-pink-500');
                t.classList.add('text-gray-500');
            });
            
            event.target.classList.add('active', 'text-pink-500', 'border-b-2', 'border-pink-500');
            event.target.classList.remove('text-gray-500');

            // Show content
            document.querySelectorAll('.profile-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`profile${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');

            // Load content based on tab
            if (tab === 'rebuzzes') {
                loadUserRebuzzes();
            } else if (tab === 'media') {
                loadUserMedia();
            } else if (tab === 'likes') {
                loadUserLikes();
            }
        }

        async function loadUserRebuzzes() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const rebuzzesRef = ref(window.firebaseDb, `users/${currentUser.uid}/rebuzzedBuzzes`);
            const snapshot = await get(rebuzzesRef);
            
            const container = document.getElementById('profileRebuzzes');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No rebuzzes yet</p>';
                return;
            }

            const rebuzzedBuzzes = [];
            const rebuzzData = snapshot.val();
            
            // Get original buzzes for each rebuzz
            for (const buzzId of Object.keys(rebuzzData)) {
                const buzzRef = ref(window.firebaseDb, `buzzes/${buzzId}`);
                const buzzSnapshot = await get(buzzRef);
                if (buzzSnapshot.exists()) {
                    rebuzzedBuzzes.push({ id: buzzId, ...buzzSnapshot.val() });
                }
            }

            // Sort by rebuzz timestamp
            rebuzzedBuzzes.sort((a, b) => (rebuzzData[b.id]?.timestamp || 0) - (rebuzzData[a.id]?.timestamp || 0));

            container.innerHTML = '';
            if (rebuzzedBuzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No rebuzzes yet</p>';
                return;
            }

            rebuzzedBuzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz, true);
                container.appendChild(buzzElement);
            });
        }

        async function loadUserMedia() {
            const { ref, query, orderByChild, equalTo, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('authorId'), equalTo(currentUser.uid));
            
            onValue(buzzesRef, (snapshot) => {
                const mediaBuzzes = [];
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.image) {
                        mediaBuzzes.unshift({ id: childSnapshot.key, ...buzz });
                    }
                });
                renderMediaBuzzes(mediaBuzzes);
            });
        }

        function renderMediaBuzzes(buzzes) {
            const container = document.getElementById('profileMedia');
            container.innerHTML = '';

            if (buzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No media posts yet</p>';
                return;
            }

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                container.appendChild(buzzElement);
            });
        }

        async function loadUserLikes() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const likesRef = ref(window.firebaseDb, `users/${currentUser.uid}/likedBuzzes`);
            const snapshot = await get(likesRef);
            
            const container = document.getElementById('profileLikes');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No liked posts yet</p>';
                return;
            }

            const likedBuzzes = [];
            const likeData = snapshot.val();
            
            // Get original buzzes for each liked buzz
            for (const buzzId of Object.keys(likeData)) {
                const buzzRef = ref(window.firebaseDb, `buzzes/${buzzId}`);
                const buzzSnapshot = await get(buzzRef);
                if (buzzSnapshot.exists()) {
                    likedBuzzes.push({ id: buzzId, ...buzzSnapshot.val() });
                }
            }

            // Sort by like timestamp
            likedBuzzes.sort((a, b) => (likeData[b.id]?.timestamp || 0) - (likeData[a.id]?.timestamp || 0));

            container.innerHTML = '';
            if (likedBuzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No liked posts yet</p>';
                return;
            }

            likedBuzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                container.appendChild(buzzElement);
            });
        }

        async function togglePrivateAccount() {
            const { ref, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const isPrivate = document.getElementById('privateAccount').checked;
            
            await update(ref(window.firebaseDb, `users/${currentUser.uid}`), {
                isPrivate: isPrivate
            });
        }

        function addAccount() {
            alert('Add Account feature coming soon!');
        }

        function editProfile() {
            showEditProfileModal();
        }

        function showEditProfileModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-md w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Edit Profile</h3>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="text-center">
                            <div id="editProfilePreview" class="w-20 h-20 rounded-full mx-auto mb-3 gradient-bg flex items-center justify-center text-white text-xl font-bold cursor-pointer" onclick="document.getElementById('editProfileImage').click()">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M3 4V1h2v3h3v2H5v3H3V6H0V4h3zm3 6V7h3V4h7l1.83 2H21c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V10h3zm7 9c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-3.2-5c0 1.77 1.43 3.2 3.2 3.2s3.2-1.43 3.2-3.2-1.43-3.2-3.2-3.2-3.2 1.43-3.2 3.2z"/></svg>
                            </div>
                            <input type="file" id="editProfileImage" accept="image/*" class="hidden" onchange="handleEditProfileImage(event)">
                            <p class="text-sm text-gray-500">Click to change profile picture</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="editFullName" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="editUsername" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="username123">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                            <textarea id="editBio" rows="3" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-full font-medium hover:bg-gray-50">Cancel</button>
                            <button onclick="saveProfileChanges()" class="flex-1 gradient-bg text-white px-4 py-2 rounded-full font-medium">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load current data
            loadCurrentProfileData();
        }

        let newProfileImage = null;

        async function loadCurrentProfileData() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            
            document.getElementById('editFullName').value = userData.fullName || '';
            document.getElementById('editUsername').value = userData.username || '';
            document.getElementById('editBio').value = userData.bio || '';
            
            // Set profile image preview
            const preview = document.getElementById('editProfilePreview');
            if (userData.profileImage) {
                preview.style.backgroundImage = `url(${userData.profileImage})`;
                preview.style.backgroundSize = 'cover';
                preview.innerHTML = '';
            } else {
                preview.textContent = userData.fullName.charAt(0).toUpperCase();
                preview.style.backgroundImage = '';
            }
        }

        function handleEditProfileImage(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image too large. Max size: 5MB', 'error');
                    return;
                }

                // Compress profile image
                compressImage(file, (compressedDataUrl) => {
                    newProfileImage = compressedDataUrl;
                    const preview = document.getElementById('editProfilePreview');
                    preview.style.backgroundImage = `url(${compressedDataUrl})`;
                    preview.style.backgroundSize = 'cover';
                    preview.innerHTML = '';
                });
            }
        }

        async function saveProfileChanges() {
            const { ref, update, get, set, remove, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const fullName = document.getElementById('editFullName').value.trim();
            const username = document.getElementById('editUsername').value.trim().toLowerCase();
            const bio = document.getElementById('editBio').value.trim();
            
            if (!fullName) {
                showToast('Full name is required', 'error');
                return;
            }

            if (!username || !/^[a-z0-9]+$/.test(username)) {
                showToast('Username can only contain letters and numbers', 'error');
                return;
            }

            try {
                // Check if username is available (if changed)
                const currentUserData = (await get(ref(window.firebaseDb, `users/${currentUser.uid}`))).val();
                
                if (username !== currentUserData.username) {
                    const usernameRef = ref(window.firebaseDb, `usernames/${username}`);
                    const usernameSnapshot = await get(usernameRef);
                    
                    if (usernameSnapshot.exists()) {
                        showToast('Username already taken', 'error');
                        return;
                    }

                    // Remove old username mapping
                    await remove(ref(window.firebaseDb, `usernames/${currentUserData.username}`));
                    // Add new username mapping
                    await set(usernameRef, currentUser.uid);
                }

                // Prepare update data
                const updateData = {
                    fullName: fullName,
                    username: username,
                    bio: bio
                };

                // Add profile image if changed
                if (newProfileImage) {
                    updateData.profileImage = newProfileImage;
                }

                await update(ref(window.firebaseDb, `users/${currentUser.uid}`), updateData);

                // Update all existing buzzes with new profile info
                if (newProfileImage || fullName !== currentUserData.fullName || username !== currentUserData.username) {
                    const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('authorId'), equalTo(currentUser.uid));
                    const buzzesSnapshot = await get(buzzesRef);
                    
                    if (buzzesSnapshot.exists()) {
                        const buzzUpdates = {};
                        buzzesSnapshot.forEach((childSnapshot) => {
                            const buzzId = childSnapshot.key;
                            buzzUpdates[`buzzes/${buzzId}/authorName`] = fullName;
                            buzzUpdates[`buzzes/${buzzId}/authorUsername`] = username;
                            if (newProfileImage) {
                                buzzUpdates[`buzzes/${buzzId}/authorImage`] = newProfileImage;
                            }
                        });
                        
                        if (Object.keys(buzzUpdates).length > 0) {
                            await update(ref(window.firebaseDb), buzzUpdates);
                        }
                    }
                }

                closeEditModal();
                loadProfileData(); // Refresh profile display
                loadUserData(); // Refresh nav avatar
                showToast('Profile updated successfully!', 'success');
                
                // Reset new profile image
                newProfileImage = null;

                // Refresh feed to show updated profile info
                loadBuzzFeed();

            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Failed to update profile', 'error');
            }
        }

        function closeEditModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        async function loadBlockedUsers() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const blockedRef = ref(window.firebaseDb, `users/${currentUser.uid}/blocked`);
            const snapshot = await get(blockedRef);
            
            const container = document.getElementById('blockedUsersList');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p class="text-gray-500 text-center">No blocked users</p>';
                return;
            }

            const blocked = snapshot.val();
            container.innerHTML = '';
            
            Object.keys(blocked).forEach(userId => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center justify-between p-4 border-b border-gray-100';
                userDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center text-white font-bold">
                            ${blocked[userId].name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-medium">${blocked[userId].name}</p>
                            <p class="text-sm text-gray-500">@${blocked[userId].username}</p>
                        </div>
                    </div>
                    <button onclick="unblockUser('${userId}')" class="px-4 py-2 bg-red-100 text-red-600 rounded-full text-sm font-medium hover:bg-red-200">
                        Unblock
                    </button>
                `;
                container.appendChild(userDiv);
            });
        }

        async function unblockUser(userId) {
            const { ref, remove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            await remove(ref(window.firebaseDb, `users/${currentUser.uid}/blocked/${userId}`));
            loadBlockedUsers();
        }

        let currentBuzzMedia = null;
        let currentMediaType = null;

        // Image compression function
        function compressImage(file, callback, quality = 0.7) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Calculate new dimensions (max 1200px width/height)
                let { width, height } = img;
                const maxSize = 1200;
                
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw and compress
                ctx.drawImage(img, 0, 0, width, height);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                
                // Check if still too large, compress more
                if (compressedDataUrl.length > 8 * 1024 * 1024 && quality > 0.3) {
                    compressImage(file, callback, quality - 0.2);
                } else {
                    callback(compressedDataUrl);
                }
            };
            
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleBuzzMedia(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            if (type === 'image') {
                // Check image file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image too large. Max size: 5MB', 'error');
                    return;
                }

                // Compress image
                compressImage(file, (compressedDataUrl) => {
                    // Double check compressed size
                    if (compressedDataUrl.length > 8 * 1024 * 1024) {
                        showToast('Image still too large after compression. Please use a smaller image.', 'error');
                        return;
                    }

                    currentBuzzMedia = compressedDataUrl;
                    currentMediaType = type;
                    
                    // Show preview
                    document.getElementById('buzzMediaPreview').classList.remove('hidden');
                    const imageDisplay = document.getElementById('buzzImageDisplay');
                    imageDisplay.src = compressedDataUrl;
                    imageDisplay.classList.remove('hidden');
                    imageDisplay.onerror = function() {
                        showToast('Error loading image preview', 'error');
                        clearBuzzMedia();
                    };
                    document.getElementById('buzzVideoDisplay').classList.add('hidden');
                    
                    showToast('Image added successfully!', 'success');
                });
            } else if (type === 'video') {
                // Check video file size (max 3MB to ensure Base64 stays under 8MB)
                if (file.size > 3 * 1024 * 1024) {
                    showToast('Video too large. Please use a video under 3MB', 'error');
                    return;
                }

                // Check video format
                const allowedTypes = ['video/mp4', 'video/webm', 'video/ogg', 'video/quicktime'];
                if (!allowedTypes.includes(file.type)) {
                    showToast('Unsupported video format. Please use MP4, WebM, or OGG', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    
                    // Final size check for Base64
                    if (dataUrl.length > 8 * 1024 * 1024) {
                        showToast('Video file creates data too large for upload. Please use a smaller video.', 'error');
                        return;
                    }

                    currentBuzzMedia = dataUrl;
                    currentMediaType = type;
                    
                    // Show preview
                    document.getElementById('buzzMediaPreview').classList.remove('hidden');
                    const videoDisplay = document.getElementById('buzzVideoDisplay');
                    videoDisplay.src = dataUrl;
                    videoDisplay.classList.remove('hidden');
                    videoDisplay.onerror = function() {
                        showToast('Error loading video preview', 'error');
                        clearBuzzMedia();
                    };
                    document.getElementById('buzzImageDisplay').classList.add('hidden');
                    
                    showToast('Video added successfully!', 'success');
                };
                reader.onerror = function() {
                    showToast('Error reading video file', 'error');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearBuzzMedia() {
            currentBuzzMedia = null;
            currentMediaType = null;
            document.getElementById('buzzMediaPreview').classList.add('hidden');
            document.getElementById('buzzImageDisplay').classList.add('hidden');
            document.getElementById('buzzVideoDisplay').classList.add('hidden');
            document.getElementById('buzzImage').value = '';
            document.getElementById('buzzVideo').value = '';
        }

        async function postBuzz() {
            const text = document.getElementById('buzzText').value.trim();
            if (!text && !currentBuzzMedia) {
                showToast('Please write something or add media!', 'error');
                return;
            }

            const buzzButton = document.getElementById('buzzButton');
            const originalText = buzzButton.textContent;
            
            try {
                // Show loading state
                buzzButton.textContent = 'Posting...';
                buzzButton.disabled = true;
                buzzButton.style.opacity = '0.7';

                const { ref, push, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
                
                if (!currentUser) {
                    throw new Error('User not authenticated');
                }

                const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                if (!userData) {
                    throw new Error('User data not found');
                }

                // Create buzz data with proper null handling
                const buzzData = {
                    text: text || '',
                    authorId: currentUser.uid,
                    authorName: userData.fullName || 'Unknown User',
                    authorUsername: userData.username || 'unknown',
                    timestamp: Date.now(),
                    likes: 0,
                    rebuzzes: 0,
                    comments: 0
                };

                // Add verification status
                if (userData.isVerified) {
                    buzzData.isVerified = true;
                }

                // Add media if it exists
                if (currentBuzzMedia) {
                    if (currentMediaType === 'image') {
                        buzzData.image = currentBuzzMedia;
                    } else if (currentMediaType === 'video') {
                        buzzData.video = currentBuzzMedia;
                    }
                }

                // Only add authorImage if it exists
                if (userData.profileImage) {
                    buzzData.authorImage = userData.profileImage;
                }

                console.log('Posting buzz:', buzzData);
                const buzzesRef = ref(window.firebaseDb, 'buzzes');
                await push(buzzesRef, buzzData);

                // Clear the form
                document.getElementById('buzzText').value = '';
                clearBuzzMedia();
                
                console.log('Buzz posted successfully!');
                
                // Show success state briefly
                buzzButton.textContent = 'Posted!';
                buzzButton.style.backgroundColor = '#10b981';
                
                showToast('Buzz posted successfully!', 'success');
                
                // Reload feed immediately
                loadBuzzFeed();

                // Reset button after 2 seconds
                setTimeout(() => {
                    buzzButton.textContent = originalText;
                    buzzButton.disabled = false;
                    buzzButton.style.opacity = '1';
                    buzzButton.style.backgroundColor = '';
                }, 2000);

            } catch (error) {
                console.error('Error posting buzz:', error);
                showToast('Failed to post buzz: ' + error.message, 'error');
                
                // Reset button on error
                buzzButton.textContent = originalText;
                buzzButton.disabled = false;
                buzzButton.style.opacity = '1';
            }
        }

        let currentBuzzes = [];
        let feedUpdateTimeout = null;

        async function loadBuzzFeed() {
            const { ref, onValue, query, orderByChild, limitToLast } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('timestamp'), limitToLast(50));
            
            onValue(buzzesRef, (snapshot) => {
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.unshift({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                
                // Only update if buzzes actually changed
                if (JSON.stringify(buzzes) !== JSON.stringify(currentBuzzes)) {
                    currentBuzzes = buzzes;
                    
                    // Debounce feed updates to prevent flickering
                    if (feedUpdateTimeout) {
                        clearTimeout(feedUpdateTimeout);
                    }
                    feedUpdateTimeout = setTimeout(() => {
                        renderBuzzFeed(buzzes);
                    }, 100);
                }
            });
        }

        async function renderBuzzFeed(buzzes) {
            const feed = document.getElementById('buzzFeed');
            
            // Store scroll position
            const scrollPosition = window.scrollY;
            
            // Get existing buzz elements to preserve state
            const existingBuzzes = {};
            feed.querySelectorAll('[data-buzz-id]').forEach(element => {
                const buzzId = element.getAttribute('data-buzz-id');
                existingBuzzes[buzzId] = element;
            });

            // Clear feed
            feed.innerHTML = '';

            // Render buzzes, reusing existing elements where possible
            for (const buzz of buzzes) {
                let buzzElement;
                if (existingBuzzes[buzz.id]) {
                    // Reuse existing element and update only if needed
                    buzzElement = existingBuzzes[buzz.id];
                    await updateBuzzElement(buzzElement, buzz);
                } else {
                    // Create new element
                    buzzElement = await createBuzzElement(buzz);
                }
                feed.appendChild(buzzElement);
            }
            
            // Restore scroll position
            window.scrollTo(0, scrollPosition);
        }

        async function updateBuzzElement(element, buzz) {
            // Update like count and state
            const likeButton = element.querySelector(`.like-btn-${buzz.id}`);
            const likeCount = likeButton?.querySelector('span');
            if (likeCount) {
                likeCount.textContent = buzz.likes || 0;
            }

            // Update rebuzz count
            const rebuzzButton = element.querySelector(`.rebuzz-btn-${buzz.id}`);
            const rebuzzCount = rebuzzButton?.querySelector('span');
            if (rebuzzCount) {
                rebuzzCount.textContent = buzz.rebuzzes || 0;
            }

            // Update comment count
            const commentButton = element.querySelector(`[onclick="commentBuzz('${buzz.id}')"]`);
            const commentCount = commentButton?.querySelector('span');
            if (commentCount) {
                commentCount.textContent = buzz.comments || 0;
            }
        }

        // Notification system
        async function createNotification(userId, type, buzzId = null, fromUserId = null) {
            const { ref, push, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            
            // Don't create notification for self
            if (userId === currentUser.uid) return;

            const fromUserRef = ref(window.firebaseDb, `users/${fromUserId || currentUser.uid}`);
            const fromUserData = (await get(fromUserRef)).val();

            const notificationData = {
                type: type, // 'like', 'comment', 'rebuzz', 'follow', 'save', 'verification_approved'
                fromUserId: fromUserId || currentUser.uid,
                fromUserName: fromUserData.fullName,
                fromUserUsername: fromUserData.username,
                fromUserImage: fromUserData.profileImage || null,
                buzzId: buzzId,
                timestamp: Date.now(),
                read: false
            };

            await push(ref(window.firebaseDb, `notifications/${userId}`), notificationData);
            
            // Update notification count
            updateNotificationBadge(userId);
        }

        async function loadNotifications() {
            const { ref, query, orderByChild, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const notificationsRef = query(ref(window.firebaseDb, `notifications/${currentUser.uid}`), orderByChild('timestamp'));
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977bd00963168997',t:'MTc1NjYzNTgwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
