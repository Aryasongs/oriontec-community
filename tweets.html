<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Pulse - Social Media Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pulse-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .instagram-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .verified-badge {
            background: linear-gradient(45deg, #e91e63, #2196f3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
        }
        .story-ring {
            background: linear-gradient(45deg, #f8bbd9, #93c5fd, #7dd3fc);
            padding: 2px;
            border-radius: 50%;
        }
        .notification-dot {
            background: #ff3040;
        }
        .buzz-card {
            transition: all 0.3s ease;
        }
        .buzz-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .hashtag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .hashtag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .mention {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mention:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(240, 147, 251, 0.3);
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
        }
        
        .suggestion-item:hover {
            background-color: #f9fafb;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .hashtag-suggestion {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .hashtag-text {
            font-weight: 600;
            color: #667eea;
        }
        
        .hashtag-count {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .mention-suggestion {
            display: flex;
            align-items: center;
            space-x: 3;
        }
        
        .mention-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .mention-info {
            flex: 1;
        }
        
        .mention-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .mention-username {
            font-size: 12px;
            color: #6b7280;
        }
        
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC30TcmMVhP_8HdFYS1WufRiZwSDYNMTF0",
            authDomain: "pulse2-92372.firebaseapp.com",
            databaseURL: "https://pulse2-92372-default-rtdb.firebaseio.com",
            projectId: "pulse2-92372",
            storageBucket: "pulse2-92372.firebasestorage.app",
            messagingSenderId: "276235725177",
            appId: "1:276235725177:web:0f4e0789fae80a435927a8"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
    </script>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold instagram-gradient bg-clip-text text-transparent mb-2">Pulse</h1>
                <p class="text-gray-600">Connect with the world through Buzz</p>
            </div>
            
            <button onclick="signInWithGoogle()" class="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-50 transition duration-300 flex items-center justify-center space-x-2 mb-4">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>
        </div>
    </div>

    <!-- Setup Profile Screen -->
    <div id="setupScreen" class="hidden min-h-screen bg-gray-50 p-4">
        <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 mt-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Complete Your Profile</h2>
                <p class="text-gray-600 mt-2">Let's set up your Pulse account</p>
            </div>

            <div id="nameStep" class="setup-step">
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                <input type="text" id="fullName" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="Enter your full name">
                <button onclick="nextStep('username')" class="w-full mt-4 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">Next</button>
            </div>

            <div id="usernameStep" class="setup-step hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                <input type="text" id="username" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="Choose a unique username" oninput="checkUsername()">
                <div id="usernameStatus" class="mt-2 text-sm"></div>
                <button onclick="nextStep('dob')" id="usernameNext" class="w-full mt-4 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition" disabled>Next</button>
            </div>

            <div id="dobStep" class="setup-step hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                <input type="date" id="dateOfBirth" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                <button onclick="nextStep('bio')" class="w-full mt-4 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">Next</button>
            </div>

            <div id="bioStep" class="setup-step hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Bio (Optional)</label>
                <textarea id="userBio" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none" rows="3" placeholder="Tell us about yourself..."></textarea>
                <button onclick="nextStep('dp')" class="w-full mt-4 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">Next</button>
            </div>

            <div id="dpStep" class="setup-step hidden">
                <div class="text-center">
                    <div class="w-24 h-24 mx-auto mb-4 story-ring rounded-full">
                        <div id="previewDP" class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-2xl font-bold text-gray-600">
                            ?
                        </div>
                    </div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture (Optional)</label>
                    <input type="file" id="profilePic" accept="image/*" class="hidden" onchange="previewImage()">
                    <button onclick="document.getElementById('profilePic').click()" class="bg-gray-100 text-gray-700 py-2 px-4 rounded-xl hover:bg-gray-200 transition mb-4">Choose Photo</button>
                    <div class="space-y-2">
                        <button onclick="completeSetup()" class="w-full instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">Complete Setup</button>
                        <button onclick="completeSetup()" class="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">Skip for Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold instagram-gradient bg-clip-text text-transparent">Pulse</h1>
                    </div>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden md:flex items-center space-x-6">
                        <button onclick="showTab('search')" class="p-2 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </button>
                        <button onclick="showTab('home')" id="homeBtn" class="p-2 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                            </svg>
                        </button>
                        <button onclick="showTab('notifications')" class="p-2 rounded-lg hover:bg-gray-100 transition relative">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5V11"/>
                            </svg>
                            <div id="notificationBadge" class="notification-dot absolute -top-1 -right-1 w-3 h-3 rounded-full hidden"></div>
                        </button>
                        <button onclick="showTab('messages')" class="p-2 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </button>
                        <button onclick="showTab('settings')" class="p-2 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                        <div class="w-8 h-8 story-ring rounded-full cursor-pointer" onclick="showProfile()">
                            <div id="navProfilePic" class="w-full h-full bg-gray-300 rounded-full flex items-center justify-center text-sm font-bold text-white">
                                U
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Search Button -->
                    <div class="md:hidden">
                        <button onclick="showTab('search')" class="p-2 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Mobile Bottom Navigation -->
        <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
            <div class="flex justify-around items-center py-2">
                <button onclick="showTab('home')" id="mobileHomeBtn" class="p-3 rounded-lg hover:bg-gray-100 transition">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                </button>
                <button onclick="showTab('notifications')" class="p-3 rounded-lg hover:bg-gray-100 transition relative">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5V11"/>
                    </svg>
                    <div id="mobileNotificationBadge" class="notification-dot absolute -top-1 -right-1 w-3 h-3 rounded-full hidden"></div>
                </button>
                <button onclick="showTab('messages')" class="p-3 rounded-lg hover:bg-gray-100 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </button>
                <button onclick="showTab('settings')" class="p-3 rounded-lg hover:bg-gray-100 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
                <div class="w-8 h-8 story-ring rounded-full cursor-pointer" onclick="showProfile()">
                    <div id="mobileNavProfilePic" class="w-full h-full bg-gray-300 rounded-full flex items-center justify-center text-sm font-bold text-white">
                        U
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="searchTab" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <div class="mb-6">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search users..." class="w-full p-4 pl-12 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-pink-500 focus:border-transparent" oninput="searchUsers()">
                    <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>
            
            <div id="searchResults">
                <div class="text-center py-8 text-gray-500">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <p>Search for users to connect with</p>
                </div>
            </div>
        </div>

        <!-- Home Feed -->
        <div id="homeTab" class="max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <!-- Create Buzz -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex space-x-4">
                    <div class="w-12 h-12 story-ring rounded-full flex-shrink-0">
                        <div id="createBuzzDP" class="w-full h-full bg-gray-300 rounded-full flex items-center justify-center text-lg font-bold text-white">
                            U
                        </div>
                    </div>
                    <div class="flex-1 relative">
                        <textarea id="buzzText" placeholder="What's buzzing?" class="w-full p-3 border border-gray-200 rounded-xl resize-none focus:ring-2 focus:ring-pink-500 focus:border-transparent" rows="3" oninput="handleTextInput()" onkeydown="handleKeyDown(event)"></textarea>
                        <div id="suggestionDropdown" class="suggestions-dropdown">
                            <!-- Suggestions will be populated here -->
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <div class="flex space-x-4">
                                <button onclick="document.getElementById('buzzImage').click()" class="text-pink-500 hover:bg-pink-50 p-2 rounded-lg transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                                <input type="file" id="buzzImage" accept="image/*" class="hidden" onchange="previewBuzzImage()">
                            </div>
                            <button onclick="createBuzz()" class="instagram-gradient text-white px-6 py-2 rounded-xl font-medium hover:opacity-90 transition">
                                Buzz
                            </button>
                        </div>
                        <div id="buzzImagePreview" class="hidden mt-4">
                            <img id="buzzPreviewImg" class="w-full max-h-64 object-cover rounded-xl">
                            <button onclick="removeBuzzImage()" class="mt-2 text-red-500 text-sm hover:underline">Remove Image</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div id="feedContainer">
                <!-- Sample Buzz Posts will be loaded here -->
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notificationsTab" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Notifications</h2>
            <div id="notificationsContainer">
                <!-- Notifications will be loaded here -->
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messagesTab" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Messages</h2>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 text-center">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Messages Yet</h3>
                <p class="text-gray-500">Start a conversation with someone!</p>
            </div>
        </div>

        <!-- Hashtag Tab -->
        <div id="hashtagTab" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2" id="hashtagTitle">#trending</h2>
                <div class="flex items-center space-x-4 text-sm text-gray-600">
                    <span id="hashtagPostCount">0 posts</span>
                    <span id="hashtagUserCount">0 users</span>
                </div>
            </div>
            <div id="hashtagFeedContainer">
                <!-- Hashtag posts will be loaded here -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="hidden max-w-2xl mx-auto p-4 pb-20 md:pb-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
            <div class="space-y-4">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Account</h3>
                    <div class="space-y-3">
                        <button onclick="addAccount()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">Add Account</button>
                        <button onclick="togglePrivateAccount()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">
                            <span id="privateAccountText">Private Account</span>
                        </button>
                        <button onclick="showPrivacySettings()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">Privacy</button>
                        <button onclick="showBlockSettings()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">Block</button>
                        <button onclick="showUnblockSettings()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">Unblock</button>
                        <button onclick="showVerificationRequest()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">Request Verification</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Support</h3>
                    <div class="space-y-3">
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">Help Center</button>
                        <button class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition">Report a Problem</button>
                        <button onclick="signOut()" class="w-full text-left p-3 hover:bg-gray-50 rounded-lg transition text-red-600">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="hidden w-full pb-20 md:pb-4">
            <!-- Instagram-Style Profile Header -->
            <div class="bg-white">
                <!-- Profile Info Section -->
                <div class="p-4">
                    <div class="flex items-start space-x-4 mb-4">
                        <!-- Profile Picture -->
                        <div class="w-20 h-20 md:w-24 md:h-24 flex-shrink-0">
                            <div class="w-full h-full story-ring rounded-full p-0.5">
                                <div id="profilePageDP" class="w-full h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-2xl font-bold text-white overflow-hidden">
                                    U
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stats Section -->
                        <div class="flex-1">
                            <div class="flex justify-around text-center mb-3">
                                <div class="cursor-pointer" onclick="showUserBuzzesModal()">
                                    <div id="buzzCount" class="text-lg font-bold text-gray-800">0</div>
                                    <div class="text-xs text-gray-600">Posts</div>
                                </div>
                                <div class="cursor-pointer" onclick="showFollowersModal()">
                                    <div id="followersCount" class="text-lg font-bold text-gray-800">0</div>
                                    <div class="text-xs text-gray-600">Followers</div>
                                </div>
                                <div class="cursor-pointer" onclick="showFollowingModal()">
                                    <div id="followingCount" class="text-lg font-bold text-gray-800">0</div>
                                    <div class="text-xs text-gray-600">Following</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Name and Bio -->
                    <div class="mb-4">
                        <h2 id="profileName" class="text-sm font-bold text-gray-800 flex items-center mb-1">User Name</h2>
                        <p id="profileUsername" class="text-sm text-gray-600 mb-2">@username</p>
                        <p id="profileBio" class="text-sm text-gray-800 leading-relaxed"></p>
                    </div>
                    
                    <!-- Action Button -->
                    <div class="profile-action-buttons">
                        <button onclick="showEditProfile()" class="w-full instagram-gradient text-white py-2 px-4 rounded-lg font-medium hover:opacity-90 transition text-sm">
                            Edit Profile
                        </button>
                    </div>
                </div>
                
                <!-- Instagram-Style Tabs -->
                <div class="border-t border-gray-200">
                    <div class="flex">
                        <button onclick="showProfileSection('buzzes')" id="buzzesTabBtn" class="flex-1 py-3 flex items-center justify-center text-pink-600 border-b-2 border-pink-600">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </button>
                        <button onclick="showProfileSection('media')" id="mediaTabBtn" class="flex-1 py-3 flex items-center justify-center text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <button onclick="showProfileSection('likes')" id="likesTabBtn" class="flex-1 py-3 flex items-center justify-center text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </button>
                        <button onclick="showProfileSection('rebuzzes')" id="rebuzzesTabBtn" class="flex-1 py-3 flex items-center justify-center text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile Content Grid -->
            <div id="profileBuzzesSection">
                <div id="userBuzzesContainer" class="grid grid-cols-3 gap-1">
                    <!-- User's buzzes will be loaded here -->
                </div>
            </div>

            <div id="profileRebuzzesSection" class="hidden">
                <div id="userRebuzzesContainer" class="grid grid-cols-3 gap-1">
                    <!-- User's rebuzzes will be loaded here -->
                </div>
            </div>

            <div id="profileMediaSection" class="hidden">
                <div id="userMediaContainer" class="grid grid-cols-3 gap-1">
                    <!-- User's media posts will be loaded here -->
                </div>
            </div>

            <div id="profileLikesSection" class="hidden">
                <div id="userLikesContainer" class="grid grid-cols-3 gap-1">
                    <!-- User's liked posts will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Edit Profile</h3>
                    <button onclick="closeEditProfile()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-4 story-ring rounded-full">
                            <div id="editProfilePic" class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-2xl font-bold text-gray-600">
                                ?
                            </div>
                        </div>
                        <input type="file" id="newProfilePic" accept="image/*" class="hidden" onchange="previewNewProfilePic()">
                        <button onclick="document.getElementById('newProfilePic').click()" class="bg-gray-100 text-gray-700 py-2 px-4 rounded-xl hover:bg-gray-200 transition">Change Photo</button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="editFullName" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                        <textarea id="editBio" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none" rows="3" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeEditProfile()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">Cancel</button>
                        <button onclick="saveProfileChanges()" class="flex-1 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buzz Detail Modal -->
    <div id="buzzModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Buzz</h3>
                    <button onclick="closeBuzzModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div id="buzzModalContent">
                    <!-- Buzz content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Followers/Following Modal -->
    <div id="followModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[70vh] overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 id="followModalTitle" class="text-xl font-bold text-gray-800">Followers</h3>
                    <button onclick="closeFollowModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="followModalContent" class="p-4 overflow-y-auto max-h-96">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlert" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
            <div class="mb-4">
                <div class="w-16 h-16 mx-auto bg-gradient-to-r from-pink-500 to-purple-500 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <p id="alertMessage" class="text-gray-800 font-medium"></p>
            </div>
            <button onclick="closeCustomAlert()" class="w-full instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">
                OK
            </button>
        </div>
    </div>

    <!-- Permission Dialog Modal -->
    <div id="permissionDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <div class="text-center mb-6">
                <div id="permissionIcon" class="w-16 h-16 mx-auto bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </div>
                <h3 id="permissionTitle" class="text-xl font-bold text-gray-800 mb-2">Permission Required</h3>
                <p id="permissionMessage" class="text-gray-600 text-sm leading-relaxed"></p>
            </div>
            <div class="flex space-x-3">
                <button onclick="denyPermission()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">
                    Deny
                </button>
                <button onclick="allowPermission()" class="flex-1 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">
                    Allow
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog Modal -->
    <div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <div class="text-center mb-6">
                <div id="confirmIcon" class="w-16 h-16 mx-auto bg-gradient-to-r from-red-500 to-pink-500 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                </div>
                <h3 id="confirmTitle" class="text-xl font-bold text-gray-800 mb-2">Confirm Action</h3>
                <p id="confirmMessage" class="text-gray-600 text-sm leading-relaxed"></p>
            </div>
            <div class="flex space-x-3">
                <button onclick="cancelConfirm()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">
                    Cancel
                </button>
                <button onclick="proceedConfirm()" id="confirmProceedBtn" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Input Dialog Modal -->
    <div id="inputDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <div class="mb-6">
                <div id="inputIcon" class="w-16 h-16 mx-auto bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </div>
                <h3 id="inputTitle" class="text-xl font-bold text-gray-800 mb-2 text-center">Input Required</h3>
                <p id="inputMessage" class="text-gray-600 text-sm mb-4 text-center"></p>
                <input type="text" id="inputField" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter value...">
            </div>
            <div class="flex space-x-3">
                <button onclick="cancelInput()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">
                    Cancel
                </button>
                <button onclick="submitInput()" class="flex-1 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Share Dialog Modal -->
    <div id="shareDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto bg-gradient-to-r from-pink-500 to-purple-500 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Share Buzz</h3>
                <p class="text-gray-600 text-sm mb-4">Choose how you want to share this buzz</p>
            </div>
            
            <div class="space-y-3">
                <button onclick="copyBuzzLink()" class="w-full flex items-center justify-center space-x-3 p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    <span class="font-medium text-gray-700">Copy Link</span>
                </button>
                
                <button onclick="shareToSocial('twitter')" class="w-full flex items-center justify-center space-x-3 p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition">
                    <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                    </svg>
                    <span class="font-medium text-gray-700">Share on Twitter</span>
                </button>
                
                <button onclick="shareToSocial('whatsapp')" class="w-full flex items-center justify-center space-x-3 p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition">
                    <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.106"/>
                    </svg>
                    <span class="font-medium text-gray-700">Share on WhatsApp</span>
                </button>
            </div>
            
            <button onclick="closeShareDialog()" class="w-full mt-4 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">
                Cancel
            </button>
        </div>
    </div>

    <!-- Verification Request Modal -->
    <div id="verificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Request Verification</h3>
                    <button onclick="closeVerificationModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <form id="verificationForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name (as on National ID) *</label>
                        <input type="text" id="verifyFullName" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Why do you think you deserve a verified badge? *</label>
                        <textarea id="verifyReason" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none" rows="3" placeholder="Explain why you should be verified..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Other name you're known by (Optional)</label>
                        <input type="text" id="verifyOtherName" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Stage name, pen name, etc.">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                        <select id="verifyCountry" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="updateDocumentOptions()">
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="IN">India</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="RU">Russia</option>
                            <option value="CN">China</option>
                            <option value="KR">South Korea</option>
                            <option value="SG">Singapore</option>
                            <option value="AE">UAE</option>
                            <option value="SA">Saudi Arabia</option>
                            <option value="ZA">South Africa</option>
                            <option value="NG">Nigeria</option>
                            <option value="EG">Egypt</option>
                            <option value="AR">Argentina</option>
                            <option value="CL">Chile</option>
                            <option value="CO">Colombia</option>
                            <option value="PE">Peru</option>
                            <option value="TH">Thailand</option>
                            <option value="VN">Vietnam</option>
                            <option value="ID">Indonesia</option>
                            <option value="MY">Malaysia</option>
                            <option value="PH">Philippines</option>
                            <option value="BD">Bangladesh</option>
                            <option value="PK">Pakistan</option>
                            <option value="LK">Sri Lanka</option>
                            <option value="NP">Nepal</option>
                            <option value="TR">Turkey</option>
                            <option value="IR">Iran</option>
                            <option value="IQ">Iraq</option>
                            <option value="IL">Israel</option>
                            <option value="JO">Jordan</option>
                            <option value="LB">Lebanon</option>
                            <option value="SY">Syria</option>
                            <option value="YE">Yemen</option>
                            <option value="OM">Oman</option>
                            <option value="QA">Qatar</option>
                            <option value="KW">Kuwait</option>
                            <option value="BH">Bahrain</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document Type *</label>
                        <select id="verifyDocType" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Select Document Type</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Document *</label>
                        <input type="file" id="verifyDocument" required accept="image/*,.pdf" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">Upload clear image of your ID document</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Verified Social Media Links (Optional)</label>
                        <div class="space-y-2">
                            <input type="url" id="socialLink1" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Instagram/Facebook/YouTube verified profile link">
                            <input type="url" id="socialLink2" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="News article or media mention link">
                            <input type="url" id="socialLink3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Additional link">
                            <input type="url" id="socialLink4" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Additional link">
                            <input type="url" id="socialLink5" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Additional link">
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeVerificationModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">Cancel</button>
                        <button type="submit" class="flex-1 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentTab = 'home';
        let buzzImageData = null;
        let currentSuggestionType = null;
        let currentSuggestionQuery = '';
        let selectedSuggestionIndex = -1;
        let availableHashtags = [];
        let availableUsers = [];
        
        // Dialog management variables
        let currentPermissionCallback = null;
        let currentConfirmCallback = null;
        let currentInputCallback = null;
        let currentShareBuzzId = null;

        // Authentication
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    currentUser = result.user;
                    checkUserProfile();
                })
                .catch((error) => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed. Please try again.');
                });
        }

        function checkUserProfile() {
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        showMainApp();
                    } else {
                        showSetupScreen();
                    }
                });
        }

        function showSetupScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
            
            // Pre-fill name from Google account
            document.getElementById('fullName').value = currentUser.displayName || '';
            updatePreviewDP();
        }

        function nextStep(step) {
            document.querySelectorAll('.setup-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(step + 'Step').classList.remove('hidden');
        }

        function checkUsername() {
            const username = document.getElementById('username').value.toLowerCase();
            const button = document.getElementById('usernameNext');
            const status = document.getElementById('usernameStatus');
            
            if (username.length < 3) {
                status.innerHTML = '<span class="text-red-500">Username must be at least 3 characters</span>';
                button.disabled = true;
                return;
            }
            
            if (!/^[a-z0-9_]+$/.test(username)) {
                status.innerHTML = '<span class="text-red-500">Only lowercase letters, numbers, and underscores allowed</span>';
                button.disabled = true;
                return;
            }
            
            // Check if username exists
            database.ref('usernames/' + username).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        status.innerHTML = '<span class="text-red-500">Username already taken</span>';
                        button.disabled = true;
                    } else {
                        status.innerHTML = '<span class="text-green-500">Username available!</span>';
                        button.disabled = false;
                    }
                });
        }

        function previewImage() {
            showPermissionDialog(
                'Camera & Photos Access',
                'Pulse wants to access your photos to set your profile picture. This will help others recognize you on the platform.',
                'camera',
                (allowed) => {
                    if (allowed) {
                        const file = document.getElementById('profilePic').files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const preview = document.getElementById('previewDP');
                                preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full">`;
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        // Reset file input if permission denied
                        document.getElementById('profilePic').value = '';
                        showCustomAlert('Photo access denied. You can skip this step and add a photo later.');
                    }
                }
            );
        }

        function updatePreviewDP() {
            const name = document.getElementById('fullName').value;
            if (name) {
                const initial = name.charAt(0).toUpperCase();
                document.getElementById('previewDP').textContent = initial;
            }
        }

        function completeSetup() {
            const fullName = document.getElementById('fullName').value;
            const username = document.getElementById('username').value.toLowerCase();
            const dob = document.getElementById('dateOfBirth').value;
            const bio = document.getElementById('userBio').value;
            const profilePicFile = document.getElementById('profilePic').files[0];
            
            let profilePicData = null;
            if (profilePicFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePicData = e.target.result;
                    saveUserProfile();
                };
                reader.readAsDataURL(profilePicFile);
            } else {
                saveUserProfile();
            }
            
            function saveUserProfile() {
                // Check for auto-verification
                let isVerified = false;
                if (currentUser.email === 'customerserviceffrj4@gmail.com' || 
                    fullName === 'Anmol Sunda' || 
                    fullName === 'Dozeta Group' || 
                    fullName === 'Gursharn Arya') {
                    isVerified = true;
                }
                
                const userData = {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    fullName: fullName,
                    username: username,
                    dateOfBirth: dob,
                    bio: bio || '',
                    profilePic: profilePicData,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    followers: 0,
                    following: 0,
                    buzzes: 0,
                    verified: isVerified
                };
                
                // Save user data and reserve username
                Promise.all([
                    database.ref('users/' + currentUser.uid).set(userData),
                    database.ref('usernames/' + username).set(currentUser.uid)
                ]).then(() => {
                    if (isVerified) {
                        // Send verification notification
                        createNotification(currentUser.uid, 'verification', null, 'system');
                    }
                    showMainApp();
                }).catch((error) => {
                    console.error('Profile setup error:', error);
                    alert('Failed to create profile. Please try again.');
                });
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            loadUserProfile();
            loadFeed();
            loadNotifications(); // Load notifications on app start
            showTab('home');
        }

        function loadUserProfile() {
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        updateProfilePics(userData);
                        checkVerificationStatus(userData);
                    }
                });
        }

        function checkVerificationStatus(userData) {
            // Check if user should be auto-verified but isn't
            if (!userData.verified && (
                currentUser.email === 'customerserviceffrj4@gmail.com' || 
                userData.fullName === 'Anmol Sunda' || 
                userData.fullName === 'Dozeta Group' || 
                userData.fullName === 'Gursharn Arya'
            )) {
                // Auto-verify the user
                database.ref('users/' + currentUser.uid + '/verified').set(true)
                    .then(() => {
                        createNotification(currentUser.uid, 'verification', null, 'system');
                    });
            }
        }

        function updateProfilePics(userData) {
            const profilePics = document.querySelectorAll('#navProfilePic, #mobileNavProfilePic, #createBuzzDP, #profilePageDP');
            profilePics.forEach(pic => {
                if (userData.profilePic) {
                    pic.innerHTML = `<img src="${userData.profilePic}" class="w-full h-full object-cover rounded-full">`;
                } else {
                    pic.textContent = userData.fullName.charAt(0).toUpperCase();
                }
            });
        }

        function showTab(tab) {
            // Hide all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            currentTab = tab;
            
            // Update navigation
            document.querySelectorAll('nav button, .md\\:hidden button').forEach(btn => btn.classList.remove('text-pink-600'));
            if (tab === 'home') {
                document.getElementById('homeBtn')?.classList.add('text-pink-600');
                document.getElementById('mobileHomeBtn')?.classList.add('text-pink-600');
            }
            
            // Load content based on tab
            if (tab === 'notifications') {
                loadNotifications();
            } else if (tab === 'search') {
                document.getElementById('searchInput').focus();
                searchUsers(); // Load all users initially
            } else if (tab === 'hashtag') {
                // Hashtag tab content is loaded by loadHashtagFeed function
            }
        }

        function previewBuzzImage() {
            showPermissionDialog(
                'Camera & Photos Access',
                'Pulse wants to access your photos to add images to your buzz. This will make your posts more engaging and visual.',
                'camera',
                (allowed) => {
                    if (allowed) {
                        const file = document.getElementById('buzzImage').files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                buzzImageData = e.target.result;
                                document.getElementById('buzzPreviewImg').src = e.target.result;
                                document.getElementById('buzzImagePreview').classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        // Reset file input if permission denied
                        document.getElementById('buzzImage').value = '';
                        showCustomAlert('Photo access denied. You can still post text-only buzzes.');
                    }
                }
            );
        }

        function removeBuzzImage() {
            buzzImageData = null;
            document.getElementById('buzzImagePreview').classList.add('hidden');
            document.getElementById('buzzImage').value = '';
        }

        function createBuzz() {
            const text = document.getElementById('buzzText').value.trim();
            if (!text && !buzzImageData) {
                showCustomAlert('Please write something or add an image!');
                return;
            }
            
            // Extract hashtags and mentions
            const hashtags = extractHashtags(text);
            const mentions = extractMentions(text);
            
            // Get current user data first
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    
                    const buzzData = {
                        uid: currentUser.uid,
                        authorName: userData.fullName || 'User',
                        authorUsername: userData.username || 'user',
                        authorImage: userData.profilePic || null,
                        authorVerified: userData.verified || false,
                        text: text || '',
                        image: buzzImageData || null,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        likes: 0,
                        rebuzzes: 0,
                        comments: 0,
                        likedBy: {},
                        rebuzzedBy: {},
                        hashtags: hashtags,
                        mentions: mentions
                    };
                    
                    return database.ref('buzzes').push(buzzData);
                })
                .then((buzzRef) => {
                    const buzzId = buzzRef.key;
                    
                    // Update user's buzz count
                    database.ref('users/' + currentUser.uid + '/buzzes').transaction((count) => (count || 0) + 1);
                    
                    // Process hashtags
                    processHashtags(hashtags, buzzId);
                    
                    // Process mentions and send notifications
                    processMentions(mentions, buzzId);
                    
                    document.getElementById('buzzText').value = '';
                    removeBuzzImage();
                    loadFeed();
                    
                    // Refresh profile if currently viewing it
                    if (currentTab === 'profile') {
                        loadUserProfileData();
                        loadUserBuzzes();
                    }
                    
                    showCustomAlert('Buzz posted successfully!');
                })
                .catch((error) => {
                    console.error('Error creating buzz:', error);
                    showCustomAlert('Failed to post buzz: ' + error.message);
                });
        }

        function extractHashtags(text) {
            const hashtagRegex = /#[a-zA-Z0-9_]+/g;
            const hashtags = text.match(hashtagRegex) || [];
            return hashtags.map(tag => tag.toLowerCase());
        }

        function extractMentions(text) {
            const mentionRegex = /@[a-zA-Z0-9_]+/g;
            const mentions = text.match(mentionRegex) || [];
            return mentions.map(mention => mention.substring(1).toLowerCase());
        }

        function processHashtags(hashtags, buzzId) {
            hashtags.forEach(hashtag => {
                const hashtagKey = hashtag.substring(1); // Remove #
                
                // Add to hashtag posts
                database.ref(`hashtags/${hashtagKey}/posts/${buzzId}`).set(true);
                
                // Update hashtag stats
                database.ref(`hashtags/${hashtagKey}/postCount`).transaction((count) => (count || 0) + 1);
                database.ref(`hashtags/${hashtagKey}/users/${currentUser.uid}`).set(true);
                database.ref(`hashtags/${hashtagKey}/lastUsed`).set(firebase.database.ServerValue.TIMESTAMP);
            });
        }

        function processMentions(mentions, buzzId) {
            mentions.forEach(username => {
                // Find user by username
                database.ref('usernames/' + username).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const mentionedUserId = snapshot.val();
                            if (mentionedUserId !== currentUser.uid) {
                                // Create mention notification
                                createNotification(mentionedUserId, 'mention', buzzId, currentUser.uid);
                            }
                        }
                    });
            });
        }

        function loadFeed() {
            database.ref('buzzes').orderByChild('timestamp').limitToLast(20).once('value')
                .then((snapshot) => {
                    const buzzes = [];
                    snapshot.forEach((child) => {
                        buzzes.unshift({id: child.key, ...child.val()});
                    });
                    
                    displayBuzzes(buzzes);
                });
        }

        function displayBuzzes(buzzes) {
            const container = document.getElementById('feedContainer');
            container.innerHTML = '';
            
            buzzes.forEach(buzz => {
                // Use stored author data if available, otherwise fetch from users
                if (buzz.authorName && buzz.authorUsername) {
                    const userData = {
                        fullName: buzz.authorName,
                        username: buzz.authorUsername,
                        profilePic: buzz.authorImage
                    };
                    const buzzElement = createBuzzElement(buzz, userData);
                    container.appendChild(buzzElement);
                } else {
                    // Fallback: get user data for older buzzes
                    database.ref('users/' + buzz.uid).once('value')
                        .then((userSnapshot) => {
                            const userData = userSnapshot.val();
                            if (userData) {
                                const buzzElement = createBuzzElement(buzz, userData);
                                container.appendChild(buzzElement);
                            }
                        });
                }
            });
        }

        function createBuzzElement(buzz, userData) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6 buzz-card';
            
            const profilePic = userData.profilePic 
                ? `<img src="${userData.profilePic}" class="w-full h-full object-cover rounded-full">`
                : userData.fullName.charAt(0).toUpperCase();
            
            const buzzImage = buzz.image 
                ? `<img src="${buzz.image}" class="w-full max-h-96 object-cover rounded-xl mt-4">`
                : '';
            
            const timeAgo = buzz.timestamp ? new Date(buzz.timestamp).toLocaleString() : 'Just now';
            
            // Check for verification status from buzz data or user data
            const isVerified = buzz.authorVerified || userData.verified || false;
            
            div.innerHTML = `
                <div class="flex space-x-4">
                    <div class="w-12 h-12 story-ring rounded-full flex-shrink-0">
                        <div class="w-full h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-lg font-bold text-white">
                            ${profilePic}
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <h3 class="font-bold text-gray-800 cursor-pointer hover:underline flex items-center" onclick="viewUserProfile('${buzz.uid}')">${userData.fullName}${isVerified ? '<span class="verified-badge ml-1"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></span>' : ''}</h3>
                                <span class="text-gray-500 cursor-pointer hover:underline" onclick="viewUserProfile('${buzz.uid}')">@${userData.username}</span>
                                <span class="text-gray-400"></span>
                                <span class="text-gray-500 text-sm">${timeAgo}</span>
                            </div>
                            ${buzz.uid === currentUser.uid ? `
                                <button onclick="deleteBuzz('${buzz.id}')" class="text-red-500 hover:text-red-700 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                        <p class="text-gray-800 mb-3">${formatTextWithHashtagsAndMentions(buzz.text)}</p>
                        ${buzzImage}
                        
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                            <button onclick="toggleLike('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-red-500 transition" id="likeBtn-${buzz.id}">
                                <svg class="w-5 h-5 ${buzz.likedBy && buzz.likedBy[currentUser.uid] ? 'fill-red-500 text-red-500' : 'fill-none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                <span id="likeCount-${buzz.id}">${buzz.likes || 0}</span>
                            </button>
                            
                            <button onclick="showComments('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-blue-500 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <span>${buzz.comments || 0}</span>
                            </button>
                            
                            <button onclick="rebuzz('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-green-500 transition" id="rebuzzBtn-${buzz.id}">
                                <svg class="w-5 h-5 ${buzz.rebuzzedBy && buzz.rebuzzedBy[currentUser.uid] ? 'text-green-500' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                <span id="rebuzzCount-${buzz.id}">${buzz.rebuzzes || 0}</span>
                            </button>
                            
                            <button onclick="shareBuzz('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-pink-500 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        function toggleLike(buzzId) {
            const likeBtn = document.getElementById(`likeBtn-${buzzId}`);
            const likeCount = document.getElementById(`likeCount-${buzzId}`);
            const likeIcon = likeBtn.querySelector('svg');
            
            const likeRef = database.ref(`buzzes/${buzzId}/likedBy/${currentUser.uid}`);
            const likesRef = database.ref(`buzzes/${buzzId}/likes`);
            
            likeRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Unlike - Update UI immediately
                    likeIcon.classList.remove('fill-red-500', 'text-red-500');
                    likeIcon.classList.add('fill-none');
                    const currentCount = parseInt(likeCount.textContent);
                    likeCount.textContent = Math.max(0, currentCount - 1);
                    
                    // Update database
                    likeRef.remove();
                    likesRef.transaction((currentLikes) => Math.max(0, (currentLikes || 1) - 1));
                } else {
                    // Like - Update UI immediately
                    likeIcon.classList.remove('fill-none');
                    likeIcon.classList.add('fill-red-500', 'text-red-500');
                    const currentCount = parseInt(likeCount.textContent);
                    likeCount.textContent = currentCount + 1;
                    
                    // Update database
                    likeRef.set(true);
                    likesRef.transaction((currentLikes) => (currentLikes || 0) + 1);
                    
                    // Create notification for the buzz author
                    database.ref(`buzzes/${buzzId}/uid`).once('value').then((buzzSnapshot) => {
                        const buzzAuthorId = buzzSnapshot.val();
                        if (buzzAuthorId !== currentUser.uid) {
                            createNotification(buzzAuthorId, 'like', buzzId, currentUser.uid);
                        }
                    });
                }
            });
        }

        function rebuzz(buzzId) {
            const rebuzzBtn = document.getElementById(`rebuzzBtn-${buzzId}`);
            const rebuzzCount = document.getElementById(`rebuzzCount-${buzzId}`);
            const rebuzzIcon = rebuzzBtn.querySelector('svg');
            
            const rebuzzRef = database.ref(`buzzes/${buzzId}/rebuzzedBy/${currentUser.uid}`);
            const rebuzzesRef = database.ref(`buzzes/${buzzId}/rebuzzes`);
            
            rebuzzRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Un-rebuzz - Update UI immediately
                    rebuzzIcon.classList.remove('text-green-500');
                    const currentCount = parseInt(rebuzzCount.textContent);
                    rebuzzCount.textContent = Math.max(0, currentCount - 1);
                    
                    // Update database
                    rebuzzRef.remove();
                    rebuzzesRef.transaction((currentRebuzzes) => Math.max(0, (currentRebuzzes || 1) - 1));
                } else {
                    // Rebuzz - Update UI immediately
                    rebuzzIcon.classList.add('text-green-500');
                    const currentCount = parseInt(rebuzzCount.textContent);
                    rebuzzCount.textContent = currentCount + 1;
                    
                    // Update database
                    rebuzzRef.set(true);
                    rebuzzesRef.transaction((currentRebuzzes) => (currentRebuzzes || 0) + 1);
                    
                    // Create notification for the buzz author
                    database.ref(`buzzes/${buzzId}/uid`).once('value').then((buzzSnapshot) => {
                        const buzzAuthorId = buzzSnapshot.val();
                        if (buzzAuthorId !== currentUser.uid) {
                            createNotification(buzzAuthorId, 'rebuzz', buzzId, currentUser.uid);
                        }
                    });
                }
            });
        }

        function formatTextWithHashtagsAndMentions(text) {
            if (!text) return '';
            
            // Replace hashtags with styled clickable elements
            text = text.replace(/#([a-zA-Z0-9_]+)/g, '<span class="hashtag" onclick="showHashtagFeed(\'$1\')">#$1</span>');
            
            // Replace mentions with styled clickable elements
            text = text.replace(/@([a-zA-Z0-9_]+)/g, '<span class="mention" onclick="viewUserByUsername(\'$1\')">@$1</span>');
            
            return text;
        }

        function showHashtagFeed(hashtag) {
            showTab('hashtag');
            loadHashtagFeed(hashtag);
        }

        function loadHashtagFeed(hashtag) {
            document.getElementById('hashtagTitle').textContent = '#' + hashtag;
            
            // Load hashtag stats
            database.ref(`hashtags/${hashtag}`).once('value')
                .then((snapshot) => {
                    const hashtagData = snapshot.val();
                    if (hashtagData) {
                        document.getElementById('hashtagPostCount').textContent = (hashtagData.postCount || 0) + ' posts';
                        
                        // Count unique users
                        const userCount = hashtagData.users ? Object.keys(hashtagData.users).length : 0;
                        document.getElementById('hashtagUserCount').textContent = userCount + ' users';
                        
                        // Load posts with this hashtag
                        if (hashtagData.posts) {
                            const postIds = Object.keys(hashtagData.posts);
                            loadHashtagPosts(postIds);
                        } else {
                            document.getElementById('hashtagFeedContainer').innerHTML = '<div class="text-center py-8 text-gray-500">No posts found for this hashtag</div>';
                        }
                    } else {
                        document.getElementById('hashtagPostCount').textContent = '0 posts';
                        document.getElementById('hashtagUserCount').textContent = '0 users';
                        document.getElementById('hashtagFeedContainer').innerHTML = '<div class="text-center py-8 text-gray-500">No posts found for this hashtag</div>';
                    }
                });
        }

        function loadHashtagPosts(postIds) {
            const container = document.getElementById('hashtagFeedContainer');
            container.innerHTML = '';
            
            postIds.forEach(postId => {
                database.ref(`buzzes/${postId}`).once('value')
                    .then((snapshot) => {
                        const buzz = snapshot.val();
                        if (buzz) {
                            const userData = {
                                fullName: buzz.authorName,
                                username: buzz.authorUsername,
                                profilePic: buzz.authorImage,
                                verified: false // Will be updated if needed
                            };
                            
                            // Check if user is verified
                            database.ref(`users/${buzz.uid}/verified`).once('value')
                                .then((verifiedSnapshot) => {
                                    userData.verified = verifiedSnapshot.val() || false;
                                    const buzzElement = createBuzzElement({id: postId, ...buzz}, userData);
                                    container.appendChild(buzzElement);
                                });
                        }
                    });
            });
        }

        function viewUserByUsername(username) {
            database.ref('usernames/' + username.toLowerCase()).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const userId = snapshot.val();
                        viewUserProfile(userId);
                    } else {
                        alert('User not found');
                    }
                });
        }

        function createNotification(recipientId, type, buzzId, actorId) {
            const notificationData = {
                type: type, // 'like', 'rebuzz', 'comment', 'follow', 'mention'
                buzzId: buzzId,
                actorId: actorId,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            };
            
            database.ref(`notifications/${recipientId}`).push(notificationData);
        }

        function searchUsers() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResults');
            
            database.ref('users').once('value').then((snapshot) => {
                const users = [];
                snapshot.forEach((child) => {
                    const userData = child.val();
                    if (query.length === 0 || 
                        userData.username.toLowerCase().includes(query) || 
                        userData.fullName.toLowerCase().includes(query)) {
                        users.push({id: child.key, ...userData});
                    }
                });
                
                if (query.length === 0) {
                    // Show all users when no search query
                    displaySearchResults(users);
                } else if (users.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No users found</p>
                        </div>
                    `;
                } else {
                    displaySearchResults(users);
                }
            });
        }

        function displaySearchResults(users) {
            const container = document.getElementById('searchResults');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No users found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            users.forEach(user => {
                if (user.id === currentUser.uid) return; // Don't show current user
                
                const userElement = document.createElement('div');
                userElement.className = 'bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mb-4 hover:shadow-md transition cursor-pointer';
                userElement.onclick = () => viewUserProfile(user.id);
                
                const profilePic = user.profilePic 
                    ? `<img src="${user.profilePic}" class="w-full h-full object-cover rounded-full">`
                    : user.fullName.charAt(0).toUpperCase();
                
                userElement.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 story-ring rounded-full flex-shrink-0">
                            <div class="w-full h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-lg font-bold text-white">
                                ${profilePic}
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${user.fullName}</h3>
                            <p class="text-gray-500">@${user.username}</p>
                        </div>
                        <button onclick="event.stopPropagation(); followUser('${user.id}')" class="instagram-gradient text-white px-4 py-2 rounded-xl font-medium hover:opacity-90 transition">
                            Follow
                        </button>
                    </div>
                `;
                
                container.appendChild(userElement);
            });
        }

        let currentViewingUserId = null;

        function viewUserProfile(userId) {
            if (userId === currentUser.uid) {
                showProfile();
                return;
            }
            
            currentViewingUserId = userId;
            
            // Load other user's profile
            database.ref('users/' + userId).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    showOtherUserProfile(userData, userId);
                }
            });
        }

        function showOtherUserProfile(userData, userId) {
            showTab('profile');
            loadUserProfileData(); // This will now load the correct user's data
            showProfileSection('buzzes'); // Reset to buzzes tab
        }

        function updateProfileActionButtons(userId) {
            // Find the existing button container or create it
            const profileHeader = document.querySelector('#profileTab .bg-white .flex.items-center.space-x-4');
            let buttonsContainer = profileHeader.querySelector('.profile-action-buttons');
            
            // Remove existing buttons
            const existingButtons = profileHeader.querySelectorAll('button');
            existingButtons.forEach(btn => btn.remove());
            
            if (!buttonsContainer) {
                buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'profile-action-buttons flex space-x-2';
                profileHeader.appendChild(buttonsContainer);
            }
            
            if (userId === currentUser.uid) {
                // Show edit profile button for own profile
                buttonsContainer.innerHTML = `
                    <button onclick="showEditProfile()" class="instagram-gradient text-white px-4 py-2 rounded-xl font-medium hover:opacity-90 transition">
                        Edit Profile
                    </button>
                `;
            } else {
                // Show follow/unfollow and message buttons for other users
                database.ref(`users/${currentUser.uid}/followingList/${userId}`).once('value')
                    .then((snapshot) => {
                        const isFollowing = snapshot.exists();
                        
                        buttonsContainer.innerHTML = `
                            <button onclick="toggleFollow('${userId}')" id="followButton-${userId}" class="${isFollowing ? 'bg-gray-200 text-gray-700' : 'instagram-gradient text-white'} px-4 py-2 rounded-xl font-medium hover:opacity-90 transition">
                                ${isFollowing ? 'Following' : 'Follow'}
                            </button>
                            <button onclick="messageUser('${userId}')" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-xl font-medium hover:bg-gray-50 transition">
                                Message
                            </button>
                        `;
                    });
            }
        }

        function loadOtherUserBuzzes(userId) {
            database.ref('buzzes').orderByChild('uid').equalTo(userId).once('value')
                .then((snapshot) => {
                    const buzzes = [];
                    snapshot.forEach((child) => {
                        buzzes.unshift({id: child.key, ...child.val()});
                    });
                    
                    const container = document.getElementById('userBuzzesContainer');
                    if (buzzes.length === 0) {
                        container.innerHTML = '<div class="text-center py-8 text-gray-500">No buzzes yet</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    database.ref('users/' + userId).once('value')
                        .then((userSnapshot) => {
                            const userData = userSnapshot.val();
                            buzzes.forEach(buzz => {
                                const buzzElement = createBuzzElement(buzz, userData);
                                container.appendChild(buzzElement);
                            });
                        });
                });
        }

        function followUser(userId) {
            // Update UI immediately
            event.target.textContent = 'Following';
            event.target.classList.remove('instagram-gradient');
            event.target.classList.add('bg-gray-200', 'text-gray-700');
            event.target.disabled = true;
            
            // Add to current user's following
            database.ref(`users/${currentUser.uid}/followingList/${userId}`).set(true);
            database.ref(`users/${currentUser.uid}/following`).transaction((count) => (count || 0) + 1);
            
            // Add to target user's followers
            database.ref(`users/${userId}/followersList/${currentUser.uid}`).set(true);
            database.ref(`users/${userId}/followers`).transaction((count) => (count || 0) + 1);
            
            // Create notification
            createNotification(userId, 'follow', null, currentUser.uid);
        }

        function toggleFollow(userId) {
            const followButton = document.getElementById(`followButton-${userId}`);
            
            database.ref(`users/${currentUser.uid}/followingList/${userId}`).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // Unfollow
                        followButton.textContent = 'Follow';
                        followButton.className = 'instagram-gradient text-white px-4 py-2 rounded-xl font-medium hover:opacity-90 transition';
                        
                        // Remove from current user's following
                        database.ref(`users/${currentUser.uid}/followingList/${userId}`).remove();
                        database.ref(`users/${currentUser.uid}/following`).transaction((count) => Math.max(0, (count || 1) - 1));
                        
                        // Remove from target user's followers
                        database.ref(`users/${userId}/followersList/${currentUser.uid}`).remove();
                        database.ref(`users/${userId}/followers`).transaction((count) => Math.max(0, (count || 1) - 1));
                        
                        showCustomAlert('Unfollowed successfully!');
                    } else {
                        // Follow
                        followButton.textContent = 'Following';
                        followButton.className = 'bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-medium hover:opacity-90 transition';
                        
                        // Add to current user's following
                        database.ref(`users/${currentUser.uid}/followingList/${userId}`).set(true);
                        database.ref(`users/${currentUser.uid}/following`).transaction((count) => (count || 0) + 1);
                        
                        // Add to target user's followers
                        database.ref(`users/${userId}/followersList/${currentUser.uid}`).set(true);
                        database.ref(`users/${userId}/followers`).transaction((count) => (count || 0) + 1);
                        
                        // Create notification
                        createNotification(userId, 'follow', null, currentUser.uid);
                        
                        showCustomAlert('Following successfully!');
                    }
                });
        }

        function messageUser(userId) {
            showCustomAlert('Messaging feature coming soon!');
        }

        function loadNotifications() {
            database.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).once('value')
                .then((snapshot) => {
                    const notifications = [];
                    snapshot.forEach((child) => {
                        notifications.unshift({id: child.key, ...child.val()});
                    });
                    
                    displayNotifications(notifications);
                    updateNotificationBadge(notifications);
                });
        }

        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsContainer');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5V11"/>
                        </svg>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            notifications.forEach(notification => {
                database.ref('users/' + notification.actorId).once('value').then((userSnapshot) => {
                    const actorData = userSnapshot.val();
                    if (actorData) {
                        const notificationElement = createNotificationElement(notification, actorData);
                        container.appendChild(notificationElement);
                    }
                });
            });
        }

        function createNotificationElement(notification, actorData) {
            const div = document.createElement('div');
            div.className = `bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mb-4 ${!notification.read ? 'border-l-4 border-l-pink-500' : ''}`;
            
            const profilePic = actorData.profilePic 
                ? `<img src="${actorData.profilePic}" class="w-full h-full object-cover rounded-full">`
                : actorData.fullName.charAt(0).toUpperCase();
            
            let actionText = '';
            let actorName = actorData ? actorData.fullName : 'System';
            
            switch(notification.type) {
                case 'like':
                    actionText = 'liked your buzz';
                    break;
                case 'rebuzz':
                    actionText = 'rebuzzed your post';
                    break;
                case 'comment':
                    actionText = 'commented on your buzz';
                    break;
                case 'follow':
                    actionText = 'started following you';
                    break;
                case 'mention':
                    actionText = 'mentioned you in a buzz';
                    break;
                case 'verification':
                    actionText = ' Congratulations! Your account has been verified!';
                    actorName = 'Pulse Team';
                    break;
            }
            
            const timeAgo = notification.timestamp ? new Date(notification.timestamp).toLocaleString() : 'Just now';
            
            if (notification.type === 'verification') {
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-blue-500 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-semibold">${actionText}</p>
                            <p class="text-gray-500 text-sm">${timeAgo}</p>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 story-ring rounded-full flex-shrink-0 cursor-pointer" onclick="viewUserProfile('${notification.actorId}')">
                            <div class="w-full h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-sm font-bold text-white">
                                ${profilePic}
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800">
                                <span class="font-semibold cursor-pointer hover:underline" onclick="viewUserProfile('${notification.actorId}')">${actorName}</span> 
                                ${actionText}
                            </p>
                            <p class="text-gray-500 text-sm">${timeAgo}</p>
                        </div>
                    </div>
                `;
            }
            
            // Mark as read when clicked
            div.onclick = () => {
                if (!notification.read) {
                    database.ref(`notifications/${currentUser.uid}/${notification.id}/read`).set(true);
                    div.classList.remove('border-l-4', 'border-l-pink-500');
                }
            };
            
            return div;
        }

        function updateNotificationBadge(notifications) {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badges = document.querySelectorAll('#notificationBadge, #mobileNotificationBadge');
            
            badges.forEach(badge => {
                if (unreadCount > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        }



        // Permission Dialog Functions
        function showPermissionDialog(title, message, icon, callback) {
            document.getElementById('permissionTitle').textContent = title;
            document.getElementById('permissionMessage').textContent = message;
            
            // Update icon based on permission type
            const iconElement = document.getElementById('permissionIcon');
            if (icon === 'camera') {
                iconElement.innerHTML = `
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                `;
            } else if (icon === 'location') {
                iconElement.innerHTML = `
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                `;
            } else if (icon === 'notification') {
                iconElement.innerHTML = `
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5V11"/>
                    </svg>
                `;
            } else if (icon === 'clipboard') {
                iconElement.innerHTML = `
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                `;
            }
            
            currentPermissionCallback = callback;
            document.getElementById('permissionDialog').classList.remove('hidden');
        }

        function allowPermission() {
            document.getElementById('permissionDialog').classList.add('hidden');
            if (currentPermissionCallback) {
                currentPermissionCallback(true);
                currentPermissionCallback = null;
            }
        }

        function denyPermission() {
            document.getElementById('permissionDialog').classList.add('hidden');
            if (currentPermissionCallback) {
                currentPermissionCallback(false);
                currentPermissionCallback = null;
            }
        }

        // Confirmation Dialog Functions
        function showConfirmDialog(title, message, confirmText, callback, isDestructive = false) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const proceedBtn = document.getElementById('confirmProceedBtn');
            proceedBtn.textContent = confirmText;
            
            if (isDestructive) {
                proceedBtn.className = 'flex-1 bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition';
            } else {
                proceedBtn.className = 'flex-1 instagram-gradient text-white py-3 rounded-xl font-medium hover:opacity-90 transition';
            }
            
            currentConfirmCallback = callback;
            document.getElementById('confirmDialog').classList.remove('hidden');
        }

        function proceedConfirm() {
            document.getElementById('confirmDialog').classList.add('hidden');
            if (currentConfirmCallback) {
                currentConfirmCallback(true);
                currentConfirmCallback = null;
            }
        }

        function cancelConfirm() {
            document.getElementById('confirmDialog').classList.add('hidden');
            if (currentConfirmCallback) {
                currentConfirmCallback(false);
                currentConfirmCallback = null;
            }
        }

        // Input Dialog Functions
        function showInputDialog(title, message, placeholder, callback) {
            document.getElementById('inputTitle').textContent = title;
            document.getElementById('inputMessage').textContent = message;
            document.getElementById('inputField').placeholder = placeholder;
            document.getElementById('inputField').value = '';
            
            currentInputCallback = callback;
            document.getElementById('inputDialog').classList.remove('hidden');
            
            // Focus on input field
            setTimeout(() => {
                document.getElementById('inputField').focus();
            }, 100);
        }

        function submitInput() {
            const value = document.getElementById('inputField').value.trim();
            document.getElementById('inputDialog').classList.add('hidden');
            
            if (currentInputCallback) {
                currentInputCallback(value);
                currentInputCallback = null;
            }
        }

        function cancelInput() {
            document.getElementById('inputDialog').classList.add('hidden');
            if (currentInputCallback) {
                currentInputCallback(null);
                currentInputCallback = null;
            }
        }

        // Share Dialog Functions
        function shareBuzz(buzzId) {
            currentShareBuzzId = buzzId;
            document.getElementById('shareDialog').classList.remove('hidden');
        }

        function closeShareDialog() {
            document.getElementById('shareDialog').classList.add('hidden');
            currentShareBuzzId = null;
        }

        function copyBuzzLink() {
            showPermissionDialog(
                'Clipboard Access',
                'Pulse wants to copy the buzz link to your clipboard. This will allow you to easily share it with others.',
                'clipboard',
                (allowed) => {
                    if (allowed) {
                        const buzzLink = `${window.location.origin}#buzz-${currentShareBuzzId}`;
                        
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(buzzLink).then(() => {
                                closeShareDialog();
                                showCustomAlert('Link copied to clipboard!');
                            }).catch(() => {
                                // Fallback for clipboard API failure
                                fallbackCopyText(buzzLink);
                            });
                        } else {
                            // Fallback for browsers without clipboard API
                            fallbackCopyText(buzzLink);
                        }
                    } else {
                        closeShareDialog();
                        showCustomAlert('Clipboard access denied. You can manually copy the link from the address bar.');
                    }
                }
            );
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                closeShareDialog();
                showCustomAlert('Link copied to clipboard!');
            } catch (err) {
                closeShareDialog();
                showCustomAlert('Unable to copy link. Please copy manually from address bar.');
            }
            
            document.body.removeChild(textArea);
        }

        function shareToSocial(platform) {
            const buzzLink = `${window.location.origin}#buzz-${currentShareBuzzId}`;
            const shareText = 'Check out this buzz on Pulse!';
            
            let shareUrl = '';
            
            if (platform === 'twitter') {
                shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(buzzLink)}`;
            } else if (platform === 'whatsapp') {
                shareUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + buzzLink)}`;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
                closeShareDialog();
            }
        }

        function closeBuzzModal() {
            document.getElementById('buzzModal').classList.add('hidden');
        }

        function showProfile() {
            currentViewingUserId = null; // Reset to own profile
            showTab('profile');
            loadUserProfileData();
            // Reset profile section to buzzes
            showProfileSection('buzzes');
        }

        // Settings Functions
        function addAccount() {
            alert('Add Account feature: This would allow you to add multiple accounts to switch between them easily.');
        }

        function togglePrivateAccount() {
            database.ref('users/' + currentUser.uid + '/isPrivate').once('value')
                .then((snapshot) => {
                    const isPrivate = snapshot.val() || false;
                    const newPrivateStatus = !isPrivate;
                    
                    database.ref('users/' + currentUser.uid + '/isPrivate').set(newPrivateStatus)
                        .then(() => {
                            const text = document.getElementById('privateAccountText');
                            text.textContent = newPrivateStatus ? 'Public Account' : 'Private Account';
                            alert(newPrivateStatus ? 'Account is now private' : 'Account is now public');
                        });
                });
        }

        function showPrivacySettings() {
            alert('Privacy Settings:\n\n Who can see your posts\n Who can message you\n Who can tag you\n Data download options\n Account deactivation');
        }

        function showBlockSettings() {
            showInputDialog(
                'Block User',
                'Enter the username of the user you want to block:',
                'Enter username...',
                (username) => {
                    if (username) {
                        database.ref('usernames/' + username.toLowerCase()).once('value')
                            .then((snapshot) => {
                                if (snapshot.exists()) {
                                    const userIdToBlock = snapshot.val();
                                    
                                    showConfirmDialog(
                                        'Block User',
                                        `Are you sure you want to block @${username}? They won't be able to see your posts or interact with you.`,
                                        'Block',
                                        (confirmed) => {
                                            if (confirmed) {
                                                database.ref('users/' + currentUser.uid + '/blocked/' + userIdToBlock).set(true)
                                                    .then(() => {
                                                        showCustomAlert(`Successfully blocked @${username}`);
                                                    })
                                                    .catch(() => {
                                                        showCustomAlert('Failed to block user');
                                                    });
                                            }
                                        },
                                        true
                                    );
                                } else {
                                    showCustomAlert('User not found');
                                }
                            });
                    }
                }
            );
        }

        function showUnblockSettings() {
            database.ref('users/' + currentUser.uid + '/blocked').once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        showCustomAlert('No blocked users');
                        return;
                    }
                    
                    const blockedUsers = [];
                    snapshot.forEach((child) => {
                        blockedUsers.push(child.key);
                    });
                    
                    if (blockedUsers.length === 0) {
                        showCustomAlert('No blocked users');
                        return;
                    }
                    
                    // Get usernames for blocked users
                    Promise.all(blockedUsers.map(uid => 
                        database.ref('users/' + uid + '/username').once('value')
                    )).then((usernames) => {
                        const usernameList = usernames.map(snap => snap.val()).join(', ');
                        
                        showInputDialog(
                            'Unblock User',
                            `Blocked users: ${usernameList}\n\nEnter username to unblock:`,
                            'Enter username...',
                            (userToUnblock) => {
                                if (userToUnblock) {
                                    database.ref('usernames/' + userToUnblock.toLowerCase()).once('value')
                                        .then((snapshot) => {
                                            if (snapshot.exists()) {
                                                const userIdToUnblock = snapshot.val();
                                                
                                                showConfirmDialog(
                                                    'Unblock User',
                                                    `Are you sure you want to unblock @${userToUnblock}? They will be able to see your posts and interact with you again.`,
                                                    'Unblock',
                                                    (confirmed) => {
                                                        if (confirmed) {
                                                            database.ref('users/' + currentUser.uid + '/blocked/' + userIdToUnblock).remove()
                                                                .then(() => {
                                                                    showCustomAlert(`Successfully unblocked @${userToUnblock}`);
                                                                })
                                                                .catch(() => {
                                                                    showCustomAlert('Failed to unblock user');
                                                                });
                                                        }
                                                    }
                                                );
                                            } else {
                                                showCustomAlert('User not found');
                                            }
                                        });
                                }
                            }
                        );
                    });
                });
        }

        function showProfileSection(section) {
            // Hide all profile sections
            document.querySelectorAll('[id^="profile"][id$="Section"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected section
            document.getElementById('profile' + section.charAt(0).toUpperCase() + section.slice(1) + 'Section').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('[id$="TabBtn"]').forEach(btn => {
                btn.classList.remove('text-pink-600', 'border-b-2', 'border-pink-600');
                btn.classList.add('text-gray-400');
            });
            
            document.getElementById(section + 'TabBtn').classList.remove('text-gray-400');
            document.getElementById(section + 'TabBtn').classList.add('text-pink-600', 'border-b-2', 'border-pink-600');
            
            // Load content based on section and current viewing user
            const targetUserId = currentViewingUserId || currentUser.uid;
            
            switch(section) {
                case 'buzzes':
                    loadUserBuzzes();
                    break;
                case 'rebuzzes':
                    loadUserRebuzzes(targetUserId);
                    break;
                case 'media':
                    loadUserMedia(targetUserId);
                    break;
                case 'likes':
                    loadUserLikes(targetUserId);
                    break;
            }
        }

        function showUserBuzzesModal() {
            // This function can be used to show a modal with all user buzzes if needed
            // For now, it just switches to the buzzes tab
            showProfileSection('buzzes');
        }

        function loadUserProfileData() {
            // Determine which user's profile to load
            const targetUserId = currentViewingUserId || currentUser.uid;
            
            database.ref('users/' + targetUserId).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        const profileNameEl = document.getElementById('profileName');
                        profileNameEl.innerHTML = userData.fullName + (userData.verified ? '<span class="verified-badge ml-2"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></span>' : '');
                        
                        document.getElementById('profileBio').textContent = userData.bio || '';
                        
                        // Fix follower/following count display
                        const followingCount = (userData.following && typeof userData.following === 'number') ? userData.following : 0;
                        const followersCount = (userData.followers && typeof userData.followers === 'number') ? userData.followers : 0;
                        document.getElementById('followingCount').textContent = followingCount;
                        document.getElementById('followersCount').textContent = followersCount;
                        
                        // Load buzz count
                        loadUserBuzzCount(targetUserId);
                        
                        const profileDP = document.getElementById('profilePageDP');
                        if (userData.profilePic) {
                            profileDP.innerHTML = `<img src="${userData.profilePic}" class="w-full h-full object-cover rounded-full">`;
                        } else {
                            profileDP.textContent = userData.fullName.charAt(0).toUpperCase();
                        }
                        
                        // Update action buttons based on whose profile is being viewed
                        updateProfileActionButtons(targetUserId);
                    }
                });
        }

        function loadUserBuzzCount(userId) {
            database.ref('buzzes').orderByChild('uid').equalTo(userId).once('value')
                .then((snapshot) => {
                    const buzzCount = snapshot.numChildren();
                    document.getElementById('buzzCount').textContent = buzzCount;
                });
        }

        function loadUserBuzzes() {
            const targetUserId = currentViewingUserId || currentUser.uid;
            
            database.ref('buzzes').orderByChild('uid').equalTo(targetUserId).once('value')
                .then((snapshot) => {
                    const buzzes = [];
                    snapshot.forEach((child) => {
                        buzzes.unshift({id: child.key, ...child.val()});
                    });
                    
                    const container = document.getElementById('userBuzzesContainer');
                    if (buzzes.length === 0) {
                        container.innerHTML = '<div class="col-span-3 text-center py-16 text-gray-500"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg><p>No posts yet</p></div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    buzzes.forEach(buzz => {
                        const gridItem = createGridItem(buzz);
                        container.appendChild(gridItem);
                    });
                })
                .catch((error) => {
                    console.error('Error loading user buzzes:', error);
                    const container = document.getElementById('userBuzzesContainer');
                    container.innerHTML = '<div class="col-span-3 text-center py-16 text-red-500"><p>Error loading posts</p></div>';
                });
        }

        function createGridItem(buzz) {
            const div = document.createElement('div');
            div.className = 'aspect-square bg-gray-100 cursor-pointer hover:opacity-75 transition relative';
            div.onclick = () => showBuzzModal(buzz);
            
            if (buzz.image) {
                div.innerHTML = `
                    <img src="${buzz.image}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition flex items-center justify-center">
                        <div class="text-white opacity-0 hover:opacity-100 transition flex items-center space-x-4">
                            <div class="flex items-center space-x-1">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                <span class="text-sm font-medium">${buzz.likes || 0}</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <span class="text-sm font-medium">${buzz.comments || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Text-only post
                div.className += ' flex items-center justify-center p-4';
                div.innerHTML = `
                    <div class="text-center">
                        <p class="text-gray-800 text-sm font-medium line-clamp-3">${buzz.text.substring(0, 100)}${buzz.text.length > 100 ? '...' : ''}</p>
                        <div class="mt-2 flex items-center justify-center space-x-4 text-gray-600">
                            <div class="flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                <span class="text-xs">${buzz.likes || 0}</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <span class="text-xs">${buzz.comments || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return div;
        }

        function showBuzzModal(buzz) {
            // Get user data for the buzz
            database.ref('users/' + buzz.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        const buzzElement = createBuzzElement(buzz, userData);
                        document.getElementById('buzzModalContent').innerHTML = '';
                        document.getElementById('buzzModalContent').appendChild(buzzElement);
                        document.getElementById('buzzModal').classList.remove('hidden');
                    }
                });
        }

        function loadUserRebuzzes(userId = currentUser.uid) {
            const targetUserId = currentViewingUserId || userId;
            
            database.ref('buzzes').once('value')
                .then((snapshot) => {
                    const rebuzzes = [];
                    snapshot.forEach((child) => {
                        const buzz = child.val();
                        if (buzz.rebuzzedBy && buzz.rebuzzedBy[targetUserId]) {
                            rebuzzes.unshift({id: child.key, ...buzz});
                        }
                    });
                    
                    const container = document.getElementById('userRebuzzesContainer');
                    if (rebuzzes.length === 0) {
                        container.innerHTML = '<div class="col-span-3 text-center py-16 text-gray-500"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg><p>No rebuzzes yet</p></div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    rebuzzes.forEach(buzz => {
                        const gridItem = createGridItem(buzz);
                        container.appendChild(gridItem);
                    });
                });
        }

        function loadUserMedia(userId = currentUser.uid) {
            const targetUserId = currentViewingUserId || userId;
            
            database.ref('buzzes').orderByChild('uid').equalTo(targetUserId).once('value')
                .then((snapshot) => {
                    const mediaBuzzes = [];
                    snapshot.forEach((child) => {
                        const buzz = child.val();
                        if (buzz.image) {
                            mediaBuzzes.unshift({id: child.key, ...buzz});
                        }
                    });
                    
                    const container = document.getElementById('userMediaContainer');
                    if (mediaBuzzes.length === 0) {
                        container.innerHTML = '<div class="col-span-3 text-center py-16 text-gray-500"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><p>No photos or videos</p></div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    mediaBuzzes.forEach(buzz => {
                        const gridItem = createGridItem(buzz);
                        container.appendChild(gridItem);
                    });
                });
        }

        function loadUserLikes(userId = currentUser.uid) {
            const targetUserId = currentViewingUserId || userId;
            
            database.ref('buzzes').once('value')
                .then((snapshot) => {
                    const likedBuzzes = [];
                    snapshot.forEach((child) => {
                        const buzz = child.val();
                        if (buzz.likedBy && buzz.likedBy[targetUserId]) {
                            likedBuzzes.unshift({id: child.key, ...buzz});
                        }
                    });
                    
                    const container = document.getElementById('userLikesContainer');
                    if (likedBuzzes.length === 0) {
                        container.innerHTML = '<div class="col-span-3 text-center py-16 text-gray-500"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg><p>No liked posts yet</p></div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    likedBuzzes.forEach(buzz => {
                        const gridItem = createGridItem(buzz);
                        container.appendChild(gridItem);
                    });
                });
        }

        function showEditProfile() {
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('editFullName').value = userData.fullName;
                        document.getElementById('editBio').value = userData.bio || '';
                        
                        const editProfilePic = document.getElementById('editProfilePic');
                        if (userData.profilePic) {
                            editProfilePic.innerHTML = `<img src="${userData.profilePic}" class="w-full h-full object-cover rounded-full">`;
                        } else {
                            editProfilePic.textContent = userData.fullName.charAt(0).toUpperCase();
                        }
                        
                        document.getElementById('editProfileModal').classList.remove('hidden');
                    }
                });
        }

        function closeEditProfile() {
            document.getElementById('editProfileModal').classList.add('hidden');
        }

        function previewNewProfilePic() {
            showPermissionDialog(
                'Camera & Photos Access',
                'Pulse wants to access your photos to update your profile picture. This will help others recognize you on the platform.',
                'camera',
                (allowed) => {
                    if (allowed) {
                        const file = document.getElementById('newProfilePic').files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('editProfilePic').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full">`;
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        // Reset file input if permission denied
                        document.getElementById('newProfilePic').value = '';
                        showCustomAlert('Photo access denied. You can keep your current profile picture.');
                    }
                }
            );
        }

        function saveProfileChanges() {
            const newName = document.getElementById('editFullName').value;
            const newBio = document.getElementById('editBio').value;
            const newProfilePicFile = document.getElementById('newProfilePic').files[0];
            
            let updates = {
                fullName: newName,
                bio: newBio
            };
            
            if (newProfilePicFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updates.profilePic = e.target.result;
                    updateProfile();
                };
                reader.readAsDataURL(newProfilePicFile);
            } else {
                updateProfile();
            }
            
            function updateProfile() {
                database.ref('users/' + currentUser.uid).update(updates)
                    .then(() => {
                        closeEditProfile();
                        loadUserProfile();
                        loadUserProfileData();
                        showCustomAlert('Profile updated successfully!');
                    })
                    .catch((error) => {
                        console.error('Error updating profile:', error);
                        alert('Failed to update profile');
                    });
            }
        }

        function deleteBuzz(buzzId) {
            showConfirmDialog(
                'Delete Buzz',
                'Are you sure you want to delete this buzz? This action cannot be undone.',
                'Delete',
                (confirmed) => {
                    if (confirmed) {
                        database.ref('buzzes/' + buzzId).remove()
                            .then(() => {
                                loadFeed();
                                showCustomAlert('Buzz deleted successfully!');
                            })
                            .catch((error) => {
                                console.error('Error deleting buzz:', error);
                                showCustomAlert('Failed to delete buzz');
                            });
                    }
                },
                true // isDestructive
            );
        }

        function showCustomAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('customAlert').classList.remove('hidden');
        }

        function closeCustomAlert() {
            document.getElementById('customAlert').classList.add('hidden');
        }

        function showFollowersModal() {
            const targetUserId = currentViewingUserId || currentUser.uid;
            document.getElementById('followModalTitle').textContent = 'Followers';
            
            database.ref(`users/${targetUserId}/followersList`).once('value')
                .then((snapshot) => {
                    const followerIds = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((child) => {
                            followerIds.push(child.key);
                        });
                    }
                    
                    if (followerIds.length === 0) {
                        document.getElementById('followModalContent').innerHTML = '<div class="text-center py-8 text-gray-500">No followers yet</div>';
                    } else {
                        loadFollowList(followerIds);
                    }
                    
                    document.getElementById('followModal').classList.remove('hidden');
                });
        }

        function showFollowingModal() {
            const targetUserId = currentViewingUserId || currentUser.uid;
            document.getElementById('followModalTitle').textContent = 'Following';
            
            database.ref(`users/${targetUserId}/followingList`).once('value')
                .then((snapshot) => {
                    const followingIds = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((child) => {
                            followingIds.push(child.key);
                        });
                    }
                    
                    if (followingIds.length === 0) {
                        document.getElementById('followModalContent').innerHTML = '<div class="text-center py-8 text-gray-500">Not following anyone yet</div>';
                    } else {
                        loadFollowList(followingIds);
                    }
                    
                    document.getElementById('followModal').classList.remove('hidden');
                });
        }

        function loadFollowList(userIds) {
            const container = document.getElementById('followModalContent');
            container.innerHTML = '';
            
            userIds.forEach(userId => {
                database.ref(`users/${userId}`).once('value')
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            const userElement = document.createElement('div');
                            userElement.className = 'flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition cursor-pointer';
                            userElement.onclick = () => {
                                closeFollowModal();
                                viewUserProfile(userId);
                            };
                            
                            const profilePic = userData.profilePic 
                                ? `<img src="${userData.profilePic}" class="w-full h-full object-cover rounded-full">`
                                : userData.fullName.charAt(0).toUpperCase();
                            
                            userElement.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 story-ring rounded-full flex-shrink-0">
                                        <div class="w-full h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-sm font-bold text-white">
                                            ${profilePic}
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${userData.fullName}${userData.verified ? '<span class="verified-badge ml-1"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></span>' : ''}</h4>
                                        <p class="text-gray-500 text-sm">@${userData.username}</p>
                                    </div>
                                </div>
                            `;
                            
                            container.appendChild(userElement);
                        }
                    });
            });
        }

        function closeFollowModal() {
            document.getElementById('followModal').classList.add('hidden');
        }

        function showVerificationRequest() {
            document.getElementById('verificationModal').classList.remove('hidden');
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.add('hidden');
        }

        function updateDocumentOptions() {
            const country = document.getElementById('verifyCountry').value;
            const docSelect = document.getElementById('verifyDocType');
            
            docSelect.innerHTML = '<option value="">Select Document Type</option>';
            
            const documentOptions = {
                'US': ['Passport', 'Driver License', 'State ID'],
                'IN': ['PAN Card', 'Voter ID', 'Aadhaar Card', 'Passport', 'Driver License'],
                'UK': ['Passport', 'Driver License', 'National ID'],
                'CA': ['Passport', 'Driver License', 'Provincial ID'],
                'AU': ['Passport', 'Driver License', 'Proof of Age Card'],
                'DE': ['Passport', 'National ID', 'Driver License'],
                'FR': ['Passport', 'National ID', 'Driver License'],
                'JP': ['Passport', 'Driver License', 'Residence Card'],
                'BR': ['Passport', 'National ID (RG)', 'Driver License'],
                'MX': ['Passport', 'National ID (INE)', 'Driver License'],
                'default': ['Passport', 'National ID', 'Driver License']
            };
            
            const options = documentOptions[country] || documentOptions['default'];
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                docSelect.appendChild(optionElement);
            });
        }

        document.getElementById('verificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                uid: currentUser.uid,
                fullName: document.getElementById('verifyFullName').value,
                reason: document.getElementById('verifyReason').value,
                otherName: document.getElementById('verifyOtherName').value,
                country: document.getElementById('verifyCountry').value,
                documentType: document.getElementById('verifyDocType').value,
                socialLinks: [
                    document.getElementById('socialLink1').value,
                    document.getElementById('socialLink2').value,
                    document.getElementById('socialLink3').value,
                    document.getElementById('socialLink4').value,
                    document.getElementById('socialLink5').value
                ].filter(link => link.trim() !== ''),
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            };
            
            const documentFile = document.getElementById('verifyDocument').files[0];
            if (documentFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    formData.document = e.target.result;
                    submitVerificationRequest(formData);
                };
                reader.readAsDataURL(documentFile);
            } else {
                submitVerificationRequest(formData);
            }
        });

        function submitVerificationRequest(formData) {
            database.ref('verificationRequests').push(formData)
                .then(() => {
                    closeVerificationModal();
                    showCustomAlert('Verification request submitted successfully! We will review your request and notify you of the decision.');
                    document.getElementById('verificationForm').reset();
                })
                .catch((error) => {
                    console.error('Error submitting verification request:', error);
                    showCustomAlert('Failed to submit verification request. Please try again.');
                });
        }

        function handleTextInput() {
            const textarea = document.getElementById('buzzText');
            const text = textarea.value;
            const cursorPosition = textarea.selectionStart;
            
            // Find the current word being typed
            const textBeforeCursor = text.substring(0, cursorPosition);
            const words = textBeforeCursor.split(/\s/);
            const currentWord = words[words.length - 1];
            
            if (currentWord.startsWith('#') && currentWord.length > 1) {
                // Hashtag suggestion
                currentSuggestionType = 'hashtag';
                currentSuggestionQuery = currentWord.substring(1).toLowerCase();
                showHashtagSuggestions();
            } else if (currentWord.startsWith('@') && currentWord.length > 1) {
                // Mention suggestion
                currentSuggestionType = 'mention';
                currentSuggestionQuery = currentWord.substring(1).toLowerCase();
                showMentionSuggestions();
            } else {
                hideSuggestions();
            }
        }

        function handleKeyDown(event) {
            const dropdown = document.getElementById('suggestionDropdown');
            const suggestions = dropdown.querySelectorAll('.suggestion-item');
            
            if (dropdown.style.display === 'block' && suggestions.length > 0) {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                    updateSuggestionSelection(suggestions);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSuggestionSelection(suggestions);
                } else if (event.key === 'Enter' && selectedSuggestionIndex >= 0) {
                    event.preventDefault();
                    selectSuggestion(selectedSuggestionIndex);
                } else if (event.key === 'Escape') {
                    hideSuggestions();
                }
            }
        }

        function updateSuggestionSelection(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.style.backgroundColor = '#f3f4f6';
                } else {
                    item.style.backgroundColor = '';
                }
            });
        }

        function showHashtagSuggestions() {
            // Load existing hashtags from database
            database.ref('hashtags').once('value').then((snapshot) => {
                const hashtags = [];
                snapshot.forEach((child) => {
                    const hashtagData = child.val();
                    const hashtagName = child.key;
                    if (hashtagName.toLowerCase().includes(currentSuggestionQuery)) {
                        hashtags.push({
                            name: hashtagName,
                            count: hashtagData.postCount || 0
                        });
                    }
                });
                
                // Sort by post count (most popular first)
                hashtags.sort((a, b) => b.count - a.count);
                
                displayHashtagSuggestions(hashtags.slice(0, 5)); // Show top 5
            });
        }

        function displayHashtagSuggestions(hashtags) {
            const dropdown = document.getElementById('suggestionDropdown');
            dropdown.innerHTML = '';
            
            if (hashtags.length === 0) {
                // Show option to create new hashtag
                const newHashtagItem = document.createElement('div');
                newHashtagItem.className = 'suggestion-item';
                newHashtagItem.innerHTML = `
                    <div class="hashtag-suggestion">
                        <span class="hashtag-text">#${currentSuggestionQuery}</span>
                        <span class="hashtag-count">New</span>
                    </div>
                `;
                newHashtagItem.onclick = () => selectSuggestion(0);
                dropdown.appendChild(newHashtagItem);
            } else {
                hashtags.forEach((hashtag, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `
                        <div class="hashtag-suggestion">
                            <span class="hashtag-text">#${hashtag.name}</span>
                            <span class="hashtag-count">${hashtag.count} posts</span>
                        </div>
                    `;
                    item.onclick = () => selectSuggestion(index);
                    dropdown.appendChild(item);
                });
            }
            
            dropdown.style.display = 'block';
            selectedSuggestionIndex = -1;
        }

        function showMentionSuggestions() {
            // Load users from database
            database.ref('users').once('value').then((snapshot) => {
                const users = [];
                snapshot.forEach((child) => {
                    const userData = child.val();
                    if (userData.username && userData.username.toLowerCase().includes(currentSuggestionQuery)) {
                        users.push({
                            id: child.key,
                            username: userData.username,
                            fullName: userData.fullName,
                            profilePic: userData.profilePic
                        });
                    }
                });
                
                // Sort alphabetically
                users.sort((a, b) => a.username.localeCompare(b.username));
                
                displayMentionSuggestions(users.slice(0, 5)); // Show top 5
            });
        }

        function displayMentionSuggestions(users) {
            const dropdown = document.getElementById('suggestionDropdown');
            dropdown.innerHTML = '';
            
            if (users.length === 0) {
                const noUsersItem = document.createElement('div');
                noUsersItem.className = 'suggestion-item';
                noUsersItem.innerHTML = `
                    <div class="text-gray-500 text-center">No users found</div>
                `;
                dropdown.appendChild(noUsersItem);
            } else {
                users.forEach((user, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    const avatar = user.profilePic 
                        ? `<img src="${user.profilePic}" class="mention-avatar">`
                        : `<div class="mention-avatar">${user.fullName.charAt(0).toUpperCase()}</div>`;
                    
                    item.innerHTML = `
                        <div class="mention-suggestion">
                            ${avatar}
                            <div class="mention-info">
                                <div class="mention-name">${user.fullName}</div>
                                <div class="mention-username">@${user.username}</div>
                            </div>
                        </div>
                    `;
                    item.onclick = () => selectSuggestion(index);
                    dropdown.appendChild(item);
                });
            }
            
            dropdown.style.display = 'block';
            selectedSuggestionIndex = -1;
        }

        function selectSuggestion(index) {
            const textarea = document.getElementById('buzzText');
            const text = textarea.value;
            const cursorPosition = textarea.selectionStart;
            
            // Find the current word being typed
            const textBeforeCursor = text.substring(0, cursorPosition);
            const textAfterCursor = text.substring(cursorPosition);
            const words = textBeforeCursor.split(/\s/);
            const currentWord = words[words.length - 1];
            
            let replacement = '';
            const dropdown = document.getElementById('suggestionDropdown');
            const suggestions = dropdown.querySelectorAll('.suggestion-item');
            
            if (currentSuggestionType === 'hashtag') {
                const hashtagText = suggestions[index].querySelector('.hashtag-text').textContent;
                replacement = hashtagText + ' ';
            } else if (currentSuggestionType === 'mention') {
                const usernameText = suggestions[index].querySelector('.mention-username').textContent;
                replacement = usernameText + ' ';
            }
            
            // Replace the current word with the selected suggestion
            const beforeCurrentWord = textBeforeCursor.substring(0, textBeforeCursor.length - currentWord.length);
            const newText = beforeCurrentWord + replacement + textAfterCursor;
            const newCursorPosition = beforeCurrentWord.length + replacement.length;
            
            textarea.value = newText;
            textarea.setSelectionRange(newCursorPosition, newCursorPosition);
            textarea.focus();
            
            hideSuggestions();
        }

        function hideSuggestions() {
            const dropdown = document.getElementById('suggestionDropdown');
            dropdown.style.display = 'none';
            dropdown.innerHTML = '';
            currentSuggestionType = null;
            currentSuggestionQuery = '';
            selectedSuggestionIndex = -1;
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            const textarea = document.getElementById('buzzText');
            const dropdown = document.getElementById('suggestionDropdown');
            
            if (textarea && dropdown && !textarea.contains(event.target) && !dropdown.contains(event.target)) {
                hideSuggestions();
            }
        });

        // Keyboard support for dialogs
        document.addEventListener('keydown', function(event) {
            // ESC key to close dialogs
            if (event.key === 'Escape') {
                // Close permission dialog
                if (!document.getElementById('permissionDialog').classList.contains('hidden')) {
                    denyPermission();
                }
                // Close confirm dialog
                else if (!document.getElementById('confirmDialog').classList.contains('hidden')) {
                    cancelConfirm();
                }
                // Close input dialog
                else if (!document.getElementById('inputDialog').classList.contains('hidden')) {
                    cancelInput();
                }
                // Close share dialog
                else if (!document.getElementById('shareDialog').classList.contains('hidden')) {
                    closeShareDialog();
                }
                // Close custom alert
                else if (!document.getElementById('customAlert').classList.contains('hidden')) {
                    closeCustomAlert();
                }
            }
            
            // Enter key for input dialog
            if (event.key === 'Enter' && !document.getElementById('inputDialog').classList.contains('hidden')) {
                event.preventDefault();
                submitInput();
            }
        });

        function signOut() {
            showConfirmDialog(
                'Sign Out',
                'Are you sure you want to sign out of your Pulse account? You will need to sign in again to access your account.',
                'Sign Out',
                (confirmed) => {
                    if (confirmed) {
                        auth.signOut().then(() => {
                            currentUser = null;
                            document.getElementById('mainApp').classList.add('hidden');
                            document.getElementById('loginScreen').classList.remove('hidden');
                            showCustomAlert('Successfully signed out!');
                        }).catch((error) => {
                            console.error('Sign out error:', error);
                            showCustomAlert('Failed to sign out. Please try again.');
                        });
                    }
                }
            );
        }

        // Listen for auth state changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                checkUserProfile();
            } else {
                currentUser = null;
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already signed in
            if (auth.currentUser) {
                currentUser = auth.currentUser;
                checkUserProfile();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97853957704f3c52',t:'MTc1NjczNDQ5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
