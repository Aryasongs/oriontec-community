<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - Social Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2XeuTfHZ7FYKLoYb4epKp3upmVqG0fzE",
            authDomain: "pulse-17f40.firebaseapp.com",
            databaseURL: "https://pulse-17f40-default-rtdb.firebaseio.com",
            projectId: "pulse-17f40",
            storageBucket: "pulse-17f40.firebasestorage.app",
            messagingSenderId: "259780854138",
            appId: "1:259780854138:web:89c265fd22a34a7f1fd6c3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        window.firebaseAuth = auth;
        window.firebaseDb = database;
        window.googleProvider = provider;
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #ec4899 0%, #3b82f6 50%, #8b5cf6 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        .pulse-shadow {
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full pulse-shadow">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">Pulse</h1>
                <p class="text-white/80">Connect with the world through Buzz</p>
            </div>
            <button onclick="signInWithGoogle()" class="w-full bg-white text-gray-800 py-3 px-6 rounded-full font-semibold hover:bg-gray-100 transition-colors flex items-center justify-center gap-3">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="hidden min-h-screen bg-gray-50 p-4">
        <div class="max-w-md mx-auto pt-20">
            <div class="bg-white rounded-3xl p-8 pulse-shadow">
                <div id="nameStep" class="setup-step">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">What's your name?</h2>
                    <input type="text" id="fullName" placeholder="Enter your full name" class="w-full p-4 border border-gray-200 rounded-2xl mb-6 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <button onclick="nextStep('username')" class="w-full gradient-bg text-white py-3 px-6 rounded-full font-semibold">Next</button>
                </div>

                <div id="usernameStep" class="setup-step hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Choose a username</h2>
                    <input type="text" id="username" placeholder="username123" class="w-full p-4 border border-gray-200 rounded-2xl mb-2 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <p class="text-sm text-gray-500 mb-6">Only letters and numbers allowed</p>
                    <button onclick="checkUsername()" class="w-full gradient-bg text-white py-3 px-6 rounded-full font-semibold">Next</button>
                </div>

                <div id="dobStep" class="setup-step hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Date of Birth</h2>
                    <input type="date" id="dateOfBirth" class="w-full p-4 border border-gray-200 rounded-2xl mb-6 focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <button onclick="nextStep('profile')" class="w-full gradient-bg text-white py-3 px-6 rounded-full font-semibold">Next</button>
                </div>

                <div id="profileStep" class="setup-step hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Profile Picture</h2>
                    <div class="text-center mb-6">
                        <div id="profilePreview" class="w-24 h-24 rounded-full mx-auto mb-4 gradient-bg flex items-center justify-center text-white text-2xl font-bold"></div>
                        <input type="file" id="profileImage" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        <button onclick="document.getElementById('profileImage').click()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full mr-2">Upload Photo</button>
                        <button onclick="completeSetup()" class="gradient-bg text-white px-6 py-2 rounded-full">Skip</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-2xl font-bold gradient-bg bg-clip-text text-transparent">Pulse</h1>
                    <div class="flex items-center gap-6">
                        <button onclick="showScreen('home')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                        </button>
                        <button onclick="showScreen('notifications')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                        </button>
                        <button onclick="showScreen('messages')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                        </button>
                        <button onclick="showScreen('settings')" class="nav-btn text-gray-600 hover:text-pink-500">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Home Screen -->
        <div id="homeScreen" class="max-w-2xl mx-auto p-4">
            <!-- Create Buzz -->
            <div class="bg-white rounded-3xl p-6 mb-6 pulse-shadow">
                <div class="flex gap-4">
                    <div id="userAvatar" class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center text-white font-bold"></div>
                    <div class="flex-1">
                        <textarea id="buzzText" placeholder="What's buzzing?" class="w-full p-4 border border-gray-200 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-500" rows="3"></textarea>
                        <div class="flex justify-between items-center mt-4">
                            <div class="flex gap-4">
                                <input type="file" id="buzzImage" accept="image/*" class="hidden" onchange="handleBuzzImage(event)">
                                <button onclick="document.getElementById('buzzImage').click()" class="text-pink-500 hover:bg-pink-50 p-2 rounded-full">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                </button>
                            </div>
                            <button id="buzzButton" onclick="postBuzz()" class="gradient-bg text-white px-6 py-2 rounded-full font-semibold hover:opacity-90 transition-opacity">Buzz</button>
                        </div>
                        <div id="buzzImagePreview" class="hidden mt-4">
                            <img id="buzzImageDisplay" class="w-full rounded-2xl max-h-64 object-cover">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div id="buzzFeed"></div>
        </div>

        <!-- Notifications Screen -->
        <div id="notificationsScreen" class="hidden max-w-2xl mx-auto p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Notifications</h2>
            <div id="notificationsList" class="space-y-4">
                <div class="bg-white rounded-3xl p-6 text-center">
                    <p class="text-gray-500">No notifications yet</p>
                </div>
            </div>
        </div>

        <!-- Messages Screen -->
        <div id="messagesScreen" class="hidden max-w-2xl mx-auto p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Messages</h2>
            <div class="bg-white rounded-3xl p-6 text-center">
                <p class="text-gray-500">Messages feature coming soon!</p>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden max-w-2xl mx-auto p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
            <div class="bg-white rounded-3xl p-6 space-y-4">
                <button onclick="showProfile()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span class="font-medium">Profile</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </button>
                
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                        <span class="font-medium">Privacy</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="privateAccount" class="sr-only peer" onchange="togglePrivateAccount()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                    </label>
                </div>

                <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                        <span class="font-medium">Notifications</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>

                <button onclick="showBlockedUsers()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/></svg>
                        <span class="font-medium">Blocked Users</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </button>

                <button onclick="addAccount()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span class="font-medium">Add Account</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </button>

                <button onclick="signOutUser()" class="w-full flex items-center gap-3 p-4 hover:bg-red-50 rounded-2xl text-red-600 font-medium">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profileScreen" class="hidden max-w-2xl mx-auto p-4">
            <div class="bg-white rounded-3xl p-6 mb-6 pulse-shadow">
                <!-- Profile Header -->
                <div class="flex items-start gap-4 mb-6">
                    <div id="profileAvatar" class="w-20 h-20 rounded-full gradient-bg flex items-center justify-center text-white text-2xl font-bold"></div>
                    <div class="flex-1">
                        <h2 id="profileName" class="text-xl font-bold text-gray-800"></h2>
                        <p id="profileUsername" class="text-gray-500 mb-2"></p>
                        <div class="flex gap-4 text-sm text-gray-600">
                            <span><strong id="followingCount">0</strong> Following</span>
                            <span><strong id="followersCount">0</strong> Followers</span>
                        </div>
                    </div>
                    <button onclick="editProfile()" class="px-4 py-2 border border-gray-300 rounded-full text-sm font-medium hover:bg-gray-50">
                        Edit Profile
                    </button>
                </div>

                <!-- Profile Tabs -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button onclick="showProfileTab('buzzes')" class="profile-tab active px-4 py-2 font-medium text-pink-500 border-b-2 border-pink-500">
                        Buzzes
                    </button>
                    <button onclick="showProfileTab('rebuzzes')" class="profile-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Rebuzzes
                    </button>
                    <button onclick="showProfileTab('media')" class="profile-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Media
                    </button>
                    <button onclick="showProfileTab('likes')" class="profile-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Likes
                    </button>
                </div>

                <!-- Profile Content -->
                <div id="profileBuzzes" class="profile-content"></div>
                <div id="profileRebuzzes" class="profile-content hidden"></div>
                <div id="profileMedia" class="profile-content hidden"></div>
                <div id="profileLikes" class="profile-content hidden"></div>
            </div>
        </div>

        <!-- Blocked Users Screen -->
        <div id="blockedUsersScreen" class="hidden max-w-2xl mx-auto p-4">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="showScreen('settings')" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2 class="text-2xl font-bold text-gray-800">Blocked Users</h2>
            </div>
            <div id="blockedUsersList" class="bg-white rounded-3xl p-6">
                <p class="text-gray-500 text-center">No blocked users</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentBuzzImage = null;

        // Authentication
        async function signInWithGoogle() {
            try {
                const { signInWithPopup } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                const result = await signInWithPopup(window.firebaseAuth, window.googleProvider);
                currentUser = result.user;
                checkUserSetup();
            } catch (error) {
                console.error('Sign in error:', error);
            }
        }

        async function checkUserSetup() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                showMainApp();
            } else {
                showSetupScreen();
            }
        }

        function showSetupScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('profilePreview').textContent = currentUser.displayName.charAt(0).toUpperCase();
        }

        function nextStep(step) {
            document.querySelectorAll('.setup-step').forEach(s => s.classList.add('hidden'));
            document.getElementById(step + 'Step').classList.remove('hidden');
        }

        async function checkUsername() {
            const username = document.getElementById('username').value.toLowerCase();
            if (!/^[a-z0-9]+$/.test(username)) {
                alert('Username can only contain letters and numbers');
                return;
            }

            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const usernameRef = ref(window.firebaseDb, `usernames/${username}`);
            const snapshot = await get(usernameRef);
            
            if (snapshot.exists()) {
                alert('Username already taken');
                return;
            }
            
            nextStep('dob');
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentBuzzImage = e.target.result;
                    document.getElementById('profilePreview').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('profilePreview').style.backgroundSize = 'cover';
                    document.getElementById('profilePreview').textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }

        async function completeSetup() {
            const { ref, set } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const fullName = document.getElementById('fullName').value;
            const username = document.getElementById('username').value.toLowerCase();
            const dob = document.getElementById('dateOfBirth').value;

            const userData = {
                uid: currentUser.uid,
                fullName: fullName,
                username: username,
                email: currentUser.email,
                dateOfBirth: dob,
                profileImage: currentBuzzImage || null,
                createdAt: Date.now(),
                followers: 0,
                following: 0
            };

            await set(ref(window.firebaseDb, `users/${currentUser.uid}`), userData);
            await set(ref(window.firebaseDb, `usernames/${username}`), currentUser.uid);

            showMainApp();
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadUserData();
            loadBuzzFeed();
        }

        async function loadUserData() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            const avatar = document.getElementById('userAvatar');
            if (userData.profileImage) {
                avatar.style.backgroundImage = `url(${userData.profileImage})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = userData.fullName.charAt(0).toUpperCase();
            }
        }

        function showScreen(screen) {
            document.querySelectorAll('#homeScreen, #notificationsScreen, #messagesScreen, #settingsScreen, #profileScreen, #blockedUsersScreen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screen + 'Screen').classList.remove('hidden');
        }

        function showProfile() {
            showScreen('profile');
            loadProfileData();
        }

        function showBlockedUsers() {
            showScreen('blockedUsers');
            loadBlockedUsers();
        }

        async function loadProfileData() {
            const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            // Update profile info
            document.getElementById('profileName').textContent = userData.fullName;
            document.getElementById('profileUsername').textContent = `@${userData.username}`;
            document.getElementById('followingCount').textContent = userData.following || 0;
            document.getElementById('followersCount').textContent = userData.followers || 0;

            const avatar = document.getElementById('profileAvatar');
            if (userData.profileImage) {
                avatar.style.backgroundImage = `url(${userData.profileImage})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = userData.fullName.charAt(0).toUpperCase();
            }

            // Load user's buzzes
            loadUserBuzzes();
        }

        async function loadUserBuzzes() {
            const { ref, query, orderByChild, equalTo, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('authorId'), equalTo(currentUser.uid));
            
            onValue(buzzesRef, (snapshot) => {
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.unshift({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderProfileBuzzes(buzzes);
            });
        }

        function renderProfileBuzzes(buzzes) {
            const container = document.getElementById('profileBuzzes');
            container.innerHTML = '';

            if (buzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No buzzes yet</p>';
                return;
            }

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                container.appendChild(buzzElement);
            });
        }

        function showProfileTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab').forEach(t => {
                t.classList.remove('active', 'text-pink-500', 'border-b-2', 'border-pink-500');
                t.classList.add('text-gray-500');
            });
            
            event.target.classList.add('active', 'text-pink-500', 'border-b-2', 'border-pink-500');
            event.target.classList.remove('text-gray-500');

            // Show content
            document.querySelectorAll('.profile-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`profile${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');

            // Load content based on tab
            if (tab === 'rebuzzes') {
                loadUserRebuzzes();
            } else if (tab === 'media') {
                loadUserMedia();
            } else if (tab === 'likes') {
                loadUserLikes();
            }
        }

        async function loadUserRebuzzes() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const rebuzzesRef = ref(window.firebaseDb, `users/${currentUser.uid}/rebuzzedBuzzes`);
            const snapshot = await get(rebuzzesRef);
            
            const container = document.getElementById('profileRebuzzes');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No rebuzzes yet</p>';
                return;
            }

            const rebuzzedBuzzes = [];
            const rebuzzData = snapshot.val();
            
            // Get original buzzes for each rebuzz
            for (const buzzId of Object.keys(rebuzzData)) {
                const buzzRef = ref(window.firebaseDb, `buzzes/${buzzId}`);
                const buzzSnapshot = await get(buzzRef);
                if (buzzSnapshot.exists()) {
                    rebuzzedBuzzes.push({ id: buzzId, ...buzzSnapshot.val() });
                }
            }

            // Sort by rebuzz timestamp
            rebuzzedBuzzes.sort((a, b) => (rebuzzData[b.id]?.timestamp || 0) - (rebuzzData[a.id]?.timestamp || 0));

            container.innerHTML = '';
            if (rebuzzedBuzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No rebuzzes yet</p>';
                return;
            }

            rebuzzedBuzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz, true);
                container.appendChild(buzzElement);
            });
        }

        async function loadUserMedia() {
            const { ref, query, orderByChild, equalTo, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('authorId'), equalTo(currentUser.uid));
            
            onValue(buzzesRef, (snapshot) => {
                const mediaBuzzes = [];
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.image) {
                        mediaBuzzes.unshift({ id: childSnapshot.key, ...buzz });
                    }
                });
                renderMediaBuzzes(mediaBuzzes);
            });
        }

        function renderMediaBuzzes(buzzes) {
            const container = document.getElementById('profileMedia');
            container.innerHTML = '';

            if (buzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No media posts yet</p>';
                return;
            }

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                container.appendChild(buzzElement);
            });
        }

        async function loadUserLikes() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const likesRef = ref(window.firebaseDb, `users/${currentUser.uid}/likedBuzzes`);
            const snapshot = await get(likesRef);
            
            const container = document.getElementById('profileLikes');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No liked posts yet</p>';
                return;
            }

            const likedBuzzes = [];
            const likeData = snapshot.val();
            
            // Get original buzzes for each liked buzz
            for (const buzzId of Object.keys(likeData)) {
                const buzzRef = ref(window.firebaseDb, `buzzes/${buzzId}`);
                const buzzSnapshot = await get(buzzRef);
                if (buzzSnapshot.exists()) {
                    likedBuzzes.push({ id: buzzId, ...buzzSnapshot.val() });
                }
            }

            // Sort by like timestamp
            likedBuzzes.sort((a, b) => (likeData[b.id]?.timestamp || 0) - (likeData[a.id]?.timestamp || 0));

            container.innerHTML = '';
            if (likedBuzzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No liked posts yet</p>';
                return;
            }

            likedBuzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                container.appendChild(buzzElement);
            });
        }

        async function togglePrivateAccount() {
            const { ref, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const isPrivate = document.getElementById('privateAccount').checked;
            
            await update(ref(window.firebaseDb, `users/${currentUser.uid}`), {
                isPrivate: isPrivate
            });
        }

        function addAccount() {
            alert('Add Account feature coming soon!');
        }

        function editProfile() {
            showEditProfileModal();
        }

        function showEditProfileModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-md w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Edit Profile</h3>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="editFullName" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                            <textarea id="editBio" rows="3" class="w-full p-3 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-full font-medium hover:bg-gray-50">Cancel</button>
                            <button onclick="saveProfileChanges()" class="flex-1 gradient-bg text-white px-4 py-2 rounded-full font-medium">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load current data
            loadCurrentProfileData();
        }

        async function loadCurrentProfileData() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            
            document.getElementById('editFullName').value = userData.fullName || '';
            document.getElementById('editBio').value = userData.bio || '';
        }

        async function saveProfileChanges() {
            const { ref, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const fullName = document.getElementById('editFullName').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            
            if (!fullName) {
                alert('Full name is required');
                return;
            }

            await update(ref(window.firebaseDb, `users/${currentUser.uid}`), {
                fullName: fullName,
                bio: bio
            });

            closeEditModal();
            loadProfileData(); // Refresh profile display
            alert('Profile updated successfully!');
        }

        function closeEditModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        async function loadBlockedUsers() {
            const { ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const blockedRef = ref(window.firebaseDb, `users/${currentUser.uid}/blocked`);
            const snapshot = await get(blockedRef);
            
            const container = document.getElementById('blockedUsersList');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p class="text-gray-500 text-center">No blocked users</p>';
                return;
            }

            const blocked = snapshot.val();
            container.innerHTML = '';
            
            Object.keys(blocked).forEach(userId => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center justify-between p-4 border-b border-gray-100';
                userDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center text-white font-bold">
                            ${blocked[userId].name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-medium">${blocked[userId].name}</p>
                            <p class="text-sm text-gray-500">@${blocked[userId].username}</p>
                        </div>
                    </div>
                    <button onclick="unblockUser('${userId}')" class="px-4 py-2 bg-red-100 text-red-600 rounded-full text-sm font-medium hover:bg-red-200">
                        Unblock
                    </button>
                `;
                container.appendChild(userDiv);
            });
        }

        async function unblockUser(userId) {
            const { ref, remove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            await remove(ref(window.firebaseDb, `users/${currentUser.uid}/blocked/${userId}`));
            loadBlockedUsers();
        }

        function handleBuzzImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentBuzzImage = e.target.result;
                    document.getElementById('buzzImagePreview').classList.remove('hidden');
                    document.getElementById('buzzImageDisplay').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function postBuzz() {
            const text = document.getElementById('buzzText').value.trim();
            if (!text && !currentBuzzImage) {
                alert('Please write something or add an image!');
                return;
            }

            const buzzButton = document.getElementById('buzzButton');
            const originalText = buzzButton.textContent;
            
            try {
                // Show loading state
                buzzButton.textContent = 'Posting...';
                buzzButton.disabled = true;
                buzzButton.style.opacity = '0.7';

                const { ref, push, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
                
                if (!currentUser) {
                    throw new Error('User not authenticated');
                }

                const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                if (!userData) {
                    throw new Error('User data not found');
                }

                const buzzData = {
                    text: text,
                    image: currentBuzzImage,
                    authorId: currentUser.uid,
                    authorName: userData.fullName,
                    authorUsername: userData.username,
                    authorImage: userData.profileImage,
                    timestamp: Date.now(),
                    likes: 0,
                    rebuzzes: 0,
                    comments: 0
                };

                console.log('Posting buzz:', buzzData);
                const buzzesRef = ref(window.firebaseDb, 'buzzes');
                await push(buzzesRef, buzzData);

                // Clear the form
                document.getElementById('buzzText').value = '';
                document.getElementById('buzzImagePreview').classList.add('hidden');
                document.getElementById('buzzImage').value = '';
                currentBuzzImage = null;
                
                console.log('Buzz posted successfully!');
                
                // Show success state briefly
                buzzButton.textContent = 'Posted!';
                buzzButton.style.backgroundColor = '#10b981';
                
                // Reload feed immediately
                loadBuzzFeed();

                // Reset button after 2 seconds
                setTimeout(() => {
                    buzzButton.textContent = originalText;
                    buzzButton.disabled = false;
                    buzzButton.style.opacity = '1';
                    buzzButton.style.backgroundColor = '';
                }, 2000);

            } catch (error) {
                console.error('Error posting buzz:', error);
                alert('Failed to post buzz: ' + error.message);
                
                // Reset button on error
                buzzButton.textContent = originalText;
                buzzButton.disabled = false;
                buzzButton.style.opacity = '1';
            }
        }

        async function loadBuzzFeed() {
            const { ref, onValue, query, orderByChild, limitToLast } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzesRef = query(ref(window.firebaseDb, 'buzzes'), orderByChild('timestamp'), limitToLast(20));
            
            onValue(buzzesRef, (snapshot) => {
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.unshift({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderBuzzFeed(buzzes);
            });
        }

        function renderBuzzFeed(buzzes) {
            const feed = document.getElementById('buzzFeed');
            feed.innerHTML = '';

            buzzes.forEach(buzz => {
                const buzzElement = createBuzzElement(buzz);
                feed.appendChild(buzzElement);
            });
        }

        function createBuzzElement(buzz, isRebuzz = false) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-3xl p-6 mb-6 pulse-shadow';
            
            const authorAvatar = buzz.authorImage 
                ? `<div class="w-12 h-12 rounded-full" style="background-image: url(${buzz.authorImage}); background-size: cover;"></div>`
                : `<div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center text-white font-bold">${buzz.authorName.charAt(0).toUpperCase()}</div>`;

            const rebuzzHeader = isRebuzz ? `
                <div class="flex items-center gap-2 mb-3 text-gray-500 text-sm">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7z"/></svg>
                    <span>You rebuzzed</span>
                </div>
            ` : '';

            div.innerHTML = `
                ${rebuzzHeader}
                <div class="flex gap-4">
                    ${authorAvatar}
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-bold text-gray-800">${buzz.authorName}</span>
                            <span class="text-gray-500">@${buzz.authorUsername}</span>
                            <span class="text-gray-400">Â·</span>
                            <span class="text-gray-400">${formatTime(buzz.timestamp)}</span>
                        </div>
                        <p class="text-gray-800 mb-4">${buzz.text}</p>
                        ${buzz.image ? `<img src="${buzz.image}" class="w-full rounded-2xl mb-4 max-h-96 object-cover">` : ''}
                        <div class="flex justify-between items-center text-gray-500">
                            <button onclick="likeBuzz('${buzz.id}')" class="like-btn-${buzz.id} flex items-center gap-2 hover:text-red-500 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                <span>${buzz.likes || 0}</span>
                            </button>
                            <button onclick="commentBuzz('${buzz.id}')" class="flex items-center gap-2 hover:text-blue-500 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h11c.55 0 1-.45 1-1z"/></svg>
                                <span>${buzz.comments || 0}</span>
                            </button>
                            <button onclick="rebuzz('${buzz.id}')" class="rebuzz-btn-${buzz.id} flex items-center gap-2 hover:text-green-500 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7z"/></svg>
                                <span>${buzz.rebuzzes || 0}</span>
                            </button>
                            <button onclick="saveBuzz('${buzz.id}')" class="save-btn-${buzz.id} hover:text-pink-500 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>
                            </button>
                            <button onclick="shareBuzz('${buzz.id}')" class="hover:text-blue-500 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        async function likeBuzz(buzzId) {
            const { ref, get, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzRef = ref(window.firebaseDb, `buzzes/${buzzId}`);
            const userLikeRef = ref(window.firebaseDb, `users/${currentUser.uid}/likedBuzzes/${buzzId}`);
            
            const buzzSnapshot = await get(buzzRef);
            const userLikeSnapshot = await get(userLikeRef);
            const buzz = buzzSnapshot.val();
            
            if (userLikeSnapshot.exists()) {
                // Unlike
                await update(buzzRef, { likes: Math.max(0, (buzz.likes || 0) - 1) });
                await update(ref(window.firebaseDb, `users/${currentUser.uid}/likedBuzzes/${buzzId}`), null);
            } else {
                // Like
                await update(buzzRef, { likes: (buzz.likes || 0) + 1 });
                await update(userLikeRef, { timestamp: Date.now(), buzzId: buzzId });
            }
        }

        function commentBuzz(buzzId) {
            const comment = prompt('Add a comment:');
            if (comment && comment.trim()) {
                addComment(buzzId, comment.trim());
            }
        }

        async function addComment(buzzId, commentText) {
            const { ref, push, get, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();

            const commentData = {
                text: commentText,
                authorId: currentUser.uid,
                authorName: userData.fullName,
                authorUsername: userData.username,
                timestamp: Date.now()
            };

            await push(ref(window.firebaseDb, `comments/${buzzId}`), commentData);
            
            // Update comment count
            const buzzRef = ref(window.firebaseDb, `buzzes/${buzzId}`);
            const buzzSnapshot = await get(buzzRef);
            const buzz = buzzSnapshot.val();
            await update(buzzRef, { comments: (buzz.comments || 0) + 1 });
        }

        async function rebuzz(buzzId) {
            const { ref, get, update, push } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const buzzRef = ref(window.firebaseDb, `buzzes/${buzzId}`);
            const userRebuzzRef = ref(window.firebaseDb, `users/${currentUser.uid}/rebuzzedBuzzes/${buzzId}`);
            
            const buzzSnapshot = await get(buzzRef);
            const userRebuzzSnapshot = await get(userRebuzzRef);
            const buzz = buzzSnapshot.val();
            
            if (userRebuzzSnapshot.exists()) {
                // Un-rebuzz
                await update(buzzRef, { rebuzzes: Math.max(0, (buzz.rebuzzes || 0) - 1) });
                await update(ref(window.firebaseDb, `users/${currentUser.uid}/rebuzzedBuzzes/${buzzId}`), null);
            } else {
                // Rebuzz
                await update(buzzRef, { rebuzzes: (buzz.rebuzzes || 0) + 1 });
                await update(userRebuzzRef, { timestamp: Date.now(), originalBuzzId: buzzId });
                
                // Create rebuzz entry
                const userRef = ref(window.firebaseDb, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                const rebuzzData = {
                    originalBuzzId: buzzId,
                    originalBuzz: buzz,
                    rebuzzedBy: currentUser.uid,
                    rebuzzedByName: userData.fullName,
                    rebuzzedByUsername: userData.username,
                    timestamp: Date.now(),
                    type: 'rebuzz'
                };

                await push(ref(window.firebaseDb, 'rebuzzes'), rebuzzData);
            }
        }

        async function saveBuzz(buzzId) {
            const { ref, get, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const userSaveRef = ref(window.firebaseDb, `users/${currentUser.uid}/savedBuzzes/${buzzId}`);
            const saveSnapshot = await get(userSaveRef);
            
            if (saveSnapshot.exists()) {
                // Unsave
                await update(userSaveRef, null);
                alert('Buzz removed from saved!');
            } else {
                // Save
                await update(userSaveRef, { timestamp: Date.now(), buzzId: buzzId });
                alert('Buzz saved!');
            }
        }

        function shareBuzz(buzzId) {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this Buzz on Pulse',
                    url: window.location.href
                });
            } else {
                alert('Share feature coming soon!');
            }
        }

        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            return `${days}d`;
        }

        async function signOutUser() {
            const { signOut } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
            await signOut(window.firebaseAuth);
            location.reload();
        }

        // Initialize app
        window.addEventListener('load', () => {
            const { onAuthStateChanged } = window.firebaseAuth ? 
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js") : 
                Promise.resolve({});
            
            if (window.firebaseAuth) {
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js").then(({ onAuthStateChanged }) => {
                    onAuthStateChanged(window.firebaseAuth, (user) => {
                        if (user) {
                            currentUser = user;
                            checkUserSetup();
                        }
                    });
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977b4e474661edf5',t:'MTc1NjYzMDQ5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
