<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - Social Media Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, get, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2XeuTfHZ7FYKLoYb4epKp3upmVqG0fzE",
            authDomain: "pulse-17f40.firebaseapp.com",
            databaseURL: "https://pulse-17f40-default-rtdb.firebaseio.com",
            projectId: "pulse-17f40",
            storageBucket: "pulse-17f40.firebasestorage.app",
            messagingSenderId: "259780854138",
            appId: "1:259780854138:web:89c265fd22a34a7f1fd6c3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        window.firebaseAuth = auth;
        window.firebaseDb = database;
        window.googleProvider = provider;
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(45deg, #f8b4d9 0%, #fce7f3 25%, #87ceeb 50%, #bae6fd 75%, #e0f2fe 100%);
        }
        .story-ring {
            background: linear-gradient(45deg, #f8b4d9, #fce7f3, #87ceeb, #bae6fd, #e0f2fe);
            padding: 2px;
            border-radius: 50%;
        }
        .story-inner {
            background: white;
            border-radius: 50%;
            padding: 2px;
        }
        .buzz-card {
            transition: all 0.3s ease;
        }
        .buzz-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .notification-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .verified-badge {
            background: linear-gradient(45deg, #3b82f6, #ec4899);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
        }
        .verified-badge svg {
            width: 10px;
            height: 10px;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 gradient-bg rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-white text-3xl font-bold">P</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome to Pulse</h1>
                <p class="text-gray-600">Connect, Share, and Buzz with the world</p>
            </div>
            <button onclick="signInWithGoogle()" class="w-full bg-white border-2 border-gray-200 rounded-full py-3 px-6 flex items-center justify-center space-x-3 hover:bg-gray-50 transition-colors">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span class="text-gray-700 font-medium">Continue with Google</span>
            </button>
        </div>
    </div>

    <!-- Setup Profile Screen -->
    <div id="setupScreen" class="hidden min-h-screen bg-gray-50 p-4">
        <div class="max-w-md mx-auto pt-8">
            <div class="bg-white rounded-3xl p-8 shadow-lg">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Complete Your Profile</h2>
                    <p class="text-gray-600">Let's set up your Pulse account</p>
                </div>
                
                <div id="setupStep1" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                        <input type="text" id="displayName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="Enter your name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="Choose a unique username">
                        <p class="text-xs text-gray-500 mt-1">Only letters and numbers, lowercase</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                        <input type="date" id="dateOfBirth" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bio (Optional)</label>
                        <textarea id="setupBio" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <button onclick="nextStep()" class="w-full gradient-bg text-white py-3 rounded-xl font-medium hover:opacity-90 transition-opacity">Next</button>
                </div>

                <div id="setupStep2" class="hidden space-y-6">
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 relative">
                            <div id="profilePreview" class="w-24 h-24 gradient-bg rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                ?
                            </div>
                            <button onclick="document.getElementById('imageInput').click()" class="absolute bottom-0 right-0 bg-pink-500 text-white rounded-full w-8 h-8 flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        <p class="text-sm text-gray-600">Add a profile picture (optional)</p>
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="skipProfilePicture()" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-50 transition-colors">Skip</button>
                        <button onclick="completeSetup()" class="flex-1 gradient-bg text-white py-3 rounded-xl font-medium hover:opacity-90 transition-opacity">Complete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-4">
                        <div class="gradient-bg rounded-full w-10 h-10 flex items-center justify-center">
                            <span class="text-white font-bold text-lg">P</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-800 hidden sm:block">Pulse</h1>
                    </div>
                    
                    <!-- Search Bar (Desktop) -->
                    <div class="hidden md:flex flex-1 max-w-md mx-8">
                        <div class="relative w-full">
                            <input type="text" id="searchInput" placeholder="Search users..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-sky-400 focus:border-transparent">
                            <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <div id="searchResults" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-xl shadow-lg mt-2 max-h-80 overflow-y-auto z-50">
                                <!-- Search results will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Desktop Navigation -->
                    <div class="hidden md:flex items-center space-x-6">
                        <button onclick="showPage('home')" id="homeBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                        </button>
                        <button onclick="showPage('search')" id="searchBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors md:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <button onclick="showPage('notifications')" id="notificationBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors relative">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5v3.5"></path>
                            </svg>
                            <div id="notificationDot" class="hidden notification-dot absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></div>
                        </button>
                        <button onclick="showPage('messages')" id="messageBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </button>
                        <button onclick="showPage('profile')" id="profileBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <div id="navProfilePic" class="w-8 h-8 gradient-bg rounded-full flex items-center justify-center text-white text-sm font-bold">
                                U
                            </div>
                        </button>
                        <button onclick="showPage('settings')" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Mobile Menu Button -->
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Mobile Bottom Navigation -->
        <div id="mobileNav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
            <div class="flex items-center justify-around py-2">
                <button onclick="showPage('home')" id="mobileHomeBtn" class="flex flex-col items-center p-2 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="text-xs mt-1">Home</span>
                </button>
                <button onclick="showPage('search')" id="mobileSearchBtn" class="flex flex-col items-center p-2 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span class="text-xs mt-1">Search</span>
                </button>
                <button onclick="showPage('notifications')" id="mobileNotificationBtn" class="flex flex-col items-center p-2 text-gray-600 relative">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5v3.5"></path>
                    </svg>
                    <div id="mobileNotificationDot" class="hidden notification-dot absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
                    <span class="text-xs mt-1">Alerts</span>
                </button>
                <button onclick="showPage('messages')" id="mobileMessageBtn" class="flex flex-col items-center p-2 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <span class="text-xs mt-1">Messages</span>
                </button>
                <button onclick="showPage('profile')" id="mobileProfileBtn" class="flex flex-col items-center p-2 text-gray-600">
                    <div id="mobileNavProfilePic" class="w-6 h-6 gradient-bg rounded-full flex items-center justify-center text-white text-xs font-bold">
                        U
                    </div>
                    <span class="text-xs mt-1">Profile</span>
                </button>
            </div>
        </div>

        <!-- Search Page -->
        <div id="searchPage" class="hidden max-w-4xl mx-auto px-4 py-6 pb-20 md:pb-6">
            <div class="bg-white rounded-2xl shadow-sm">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Search</h2>
                    <div class="relative">
                        <input type="text" id="mobileSearchInput" placeholder="Search users..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent">
                        <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <div id="mobileSearchResults" class="divide-y divide-gray-100">
                    <div class="p-6 text-center text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <p class="text-lg">Search for users</p>
                        <p class="text-sm">Find and connect with people on Pulse</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="max-w-6xl mx-auto px-4 py-6 pb-20 md:pb-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                        <div class="flex items-center space-x-4 mb-4">
                            <div id="sidebarProfilePic" class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center text-white font-bold">
                                U
                            </div>
                            <div>
                                <h3 id="sidebarName" class="font-semibold text-gray-800">User Name</h3>
                                <p id="sidebarUsername" class="text-gray-500 text-sm">@username</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="font-bold text-lg" id="buzzCount">0</p>
                                <p class="text-gray-500 text-sm">Buzzes</p>
                            </div>
                            <div>
                                <p class="font-bold text-lg" id="followingCount">0</p>
                                <p class="text-gray-500 text-sm">Following</p>
                            </div>
                            <div>
                                <p class="font-bold text-lg" id="followersCount">0</p>
                                <p class="text-gray-500 text-sm">Followers</p>
                            </div>
                        </div>
                    </div>

                    <!-- Trending -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Trending</h3>
                        <div class="space-y-3">
                            <div class="hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <p class="text-sm text-gray-500">#1 Trending</p>
                                <p class="font-semibold">#PulseLife</p>
                                <p class="text-sm text-gray-500">12.5K Buzzes</p>
                            </div>
                            <div class="hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <p class="text-sm text-gray-500">#2 Trending</p>
                                <p class="font-semibold">#TechNews</p>
                                <p class="text-sm text-gray-500">8.2K Buzzes</p>
                            </div>
                            <div class="hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <p class="text-sm text-gray-500">#3 Trending</p>
                                <p class="font-semibold">#MondayMotivation</p>
                                <p class="text-sm text-gray-500">5.7K Buzzes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Feed -->
                <div class="lg:col-span-2">
                    <!-- Create Buzz -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                        <div class="flex space-x-4">
                            <div id="createBuzzProfilePic" class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                                U
                            </div>
                            <div class="flex-1">
                                <textarea id="buzzText" placeholder="What's buzzing?" class="w-full resize-none border-none outline-none text-lg placeholder-gray-500 focus:ring-2 focus:ring-sky-400" rows="3"></textarea>
                                <div id="imagePreview" class="hidden mt-4">
                                    <img id="previewImg" class="max-w-full h-auto rounded-xl" alt="Preview">
                                    <button onclick="removeImage()" class="mt-2 text-red-500 text-sm hover:underline">Remove image</button>
                                </div>
                                <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                                    <div class="flex space-x-4">
                                        <button onclick="document.getElementById('buzzImageInput').click()" class="text-sky-500 hover:bg-sky-50 p-2 rounded-full transition-colors">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                        <input type="file" id="buzzImageInput" accept="image/*" class="hidden" onchange="handleBuzzImageUpload(event)">
                                    </div>
                                    <button onclick="createBuzz()" class="gradient-bg text-white px-6 py-2 rounded-full font-medium hover:opacity-90 transition-opacity">
                                        Buzz
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feed -->
                    <div id="feedContainer" class="space-y-6">
                        <!-- Buzzes will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Page -->
        <div id="notificationsPage" class="hidden max-w-4xl mx-auto px-4 py-6 pb-20 md:pb-6">
            <div class="bg-white rounded-2xl shadow-sm">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Notifications</h2>
                </div>
                <div id="notificationsList" class="divide-y divide-gray-100">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Messages Page -->
        <div id="messagesPage" class="hidden max-w-4xl mx-auto px-4 py-6 pb-20 md:pb-6">
            <div class="bg-white rounded-2xl shadow-sm">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Messages</h2>
                </div>
                <div class="p-6 text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <p class="text-lg">No messages yet</p>
                    <p class="text-sm">Start a conversation with someone!</p>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="hidden max-w-4xl mx-auto px-4 py-6 pb-20 md:pb-6">
            <div class="bg-white rounded-2xl shadow-sm">
                <div class="relative">
                    <div class="h-48 gradient-bg rounded-t-2xl"></div>
                    <div class="absolute -bottom-16 left-6">
                        <div id="profilePagePic" class="w-32 h-32 gradient-bg rounded-full border-4 border-white flex items-center justify-center text-white text-4xl font-bold">
                            U
                        </div>
                    </div>
                </div>
                <div class="pt-20 p-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 id="profilePageName" class="text-2xl font-bold text-gray-800">User Name</h2>
                            <p id="profilePageUsername" class="text-gray-500">@username</p>
                            <p id="profilePageBio" class="text-gray-700 mt-2">Bio will appear here</p>
                        </div>
                        <button onclick="editProfile()" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-full font-medium hover:bg-gray-50 transition-colors">
                            Edit Profile
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-8 mb-8">
                        <div class="text-center">
                            <p class="font-bold text-2xl" id="profileBuzzCount">0</p>
                            <p class="text-gray-500">Buzzes</p>
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-2xl" id="profileFollowingCount">0</p>
                            <p class="text-gray-500">Following</p>
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-2xl" id="profileFollowersCount">0</p>
                            <p class="text-gray-500">Followers</p>
                        </div>
                    </div>

                    <!-- Profile Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-8">
                            <button onclick="showProfileTab('buzzes')" id="buzzesTab" class="py-4 px-1 border-b-2 border-sky-500 font-medium text-sm text-sky-600">
                                Buzzes
                            </button>
                            <button onclick="showProfileTab('rebuzzes')" id="rebuzzesTab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Rebuzzes
                            </button>
                            <button onclick="showProfileTab('media')" id="mediaTab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Media
                            </button>
                            <button onclick="showProfileTab('likes')" id="likesTab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Likes
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div id="profileTabContent">
                        <div id="userBuzzes" class="space-y-6">
                            <!-- User's buzzes will be loaded here -->
                        </div>
                        <div id="userRebuzzes" class="hidden space-y-6">
                            <!-- User's rebuzzes will be loaded here -->
                        </div>
                        <div id="userMedia" class="hidden">
                            <div class="grid grid-cols-3 gap-4">
                                <!-- User's media will be loaded here -->
                            </div>
                        </div>
                        <div id="userLikes" class="hidden space-y-6">
                            <!-- User's liked buzzes will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="hidden max-w-4xl mx-auto px-4 py-6 pb-20 md:pb-6">
            <div class="bg-white rounded-2xl shadow-sm">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Settings</h2>
                </div>
                <div class="p-6 space-y-6">
                    <div class="flex items-center justify-between py-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Account Settings</h3>
                                <p class="text-gray-500 text-sm">Manage your account preferences</p>
                            </div>
                        </div>
                        <button class="text-pink-500 hover:text-pink-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center justify-between py-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Privacy & Safety</h3>
                                <p class="text-gray-500 text-sm">Control who can see your content</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="privateAccount" class="sr-only peer" onchange="togglePrivateAccount()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between py-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5v3.5"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Notifications</h3>
                                <p class="text-gray-500 text-sm">Choose what notifications you receive</p>
                            </div>
                        </div>
                        <button class="text-pink-500 hover:text-pink-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center justify-between py-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Request Verification</h3>
                                <p class="text-gray-500 text-sm">Apply for verified badge</p>
                            </div>
                        </div>
                        <button onclick="showVerificationRequest()" class="text-pink-500 hover:text-pink-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center justify-between py-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18 21l-5.586-5.586m0 0L21 18l-5.586-5.586m0 0L5.636 5.636M18.364 18.364L5.636 5.636"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Blocked Accounts</h3>
                                <p class="text-gray-500 text-sm">Manage blocked users</p>
                            </div>
                        </div>
                        <button onclick="showBlockedAccounts()" class="text-pink-500 hover:text-pink-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="pt-6 space-y-3">
                        <button onclick="addAccount()" class="w-full bg-sky-500 text-white py-3 rounded-xl font-medium hover:bg-sky-600 transition-colors flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <span>Add Account</span>
                        </button>
                        <button onclick="signOutUser()" class="w-full bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Comments</h3>
                    <button onclick="closeCommentModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="originalBuzz" class="p-6 border-b border-gray-200">
                <!-- Original buzz will be shown here -->
            </div>
            <div class="p-6 border-b border-gray-200">
                <div class="flex space-x-4">
                    <div id="commentProfilePic" class="w-10 h-10 gradient-bg rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                        U
                    </div>
                    <div class="flex-1">
                        <textarea id="commentText" placeholder="Write a comment..." class="w-full resize-none border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-sky-400 focus:border-transparent" rows="3"></textarea>
                        <div class="flex justify-end mt-3">
                            <button onclick="postComment()" class="gradient-bg text-white px-4 py-2 rounded-full font-medium hover:opacity-90 transition-opacity">
                                Comment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="commentsList" class="p-6 space-y-4">
                <!-- Comments will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentBuzzId = null;
        let buzzImageBase64 = null;

        // Authentication
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(firebaseAuth, googleProvider);
                currentUser = result.user;
                
                // Check if user profile exists
                const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
                const snapshot = await get(userRef);
                
                if (!snapshot.exists()) {
                    showSetupScreen();
                } else {
                    showMainApp();
                    loadUserData();
                }
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed. Please try again.');
            }
        }

        function showSetupScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('displayName').value = currentUser.displayName || '';
        }

        function nextStep() {
            const displayName = document.getElementById('displayName').value.trim();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            const bio = document.getElementById('setupBio').value.trim();

            if (!displayName || !username || !dateOfBirth) {
                alert('Please fill in all required fields');
                return;
            }

            if (!/^[a-z0-9]+$/.test(username)) {
                alert('Username can only contain lowercase letters and numbers');
                return;
            }

            // Check if username is available
            checkUsernameAvailability(username).then(available => {
                if (!available) {
                    alert('Username is already taken. Please choose another one.');
                    return;
                }

                document.getElementById('setupStep1').classList.add('hidden');
                document.getElementById('setupStep2').classList.remove('hidden');
                
                // Update profile preview
                const firstLetter = displayName.charAt(0).toUpperCase();
                document.getElementById('profilePreview').textContent = firstLetter;
            });
        }

        async function checkUsernameAvailability(username) {
            const usernamesRef = ref(firebaseDb, 'usernames');
            const snapshot = await get(usernamesRef);
            const usernames = snapshot.val() || {};
            return !usernames[username];
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('profilePreview');
                    img.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
                    window.profileImageBase64 = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function skipProfilePicture() {
            window.profileImageBase64 = null;
            completeSetup();
        }

        async function completeSetup() {
            const displayName = document.getElementById('displayName').value.trim();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            const bio = document.getElementById('setupBio').value.trim();

            const userData = {
                uid: currentUser.uid,
                displayName: displayName,
                username: username,
                email: currentUser.email,
                dateOfBirth: dateOfBirth,
                profileImage: window.profileImageBase64 || null,
                createdAt: Date.now(),
                buzzCount: 0,
                followingCount: 0,
                followersCount: 0,
                bio: bio || ''
            };

            try {
                // Save user data
                await set(ref(firebaseDb, `users/${currentUser.uid}`), userData);
                
                // Reserve username
                await set(ref(firebaseDb, `usernames/${username}`), currentUser.uid);

                showMainApp();
                loadUserData();
            } catch (error) {
                console.error('Setup error:', error);
                alert('Setup failed. Please try again.');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            showPage('home');
            loadFeed();
        }

        async function loadUserData() {
            if (!currentUser) return;

            const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            if (userData) {
                // Update all profile pictures and names
                updateProfileElements(userData);
            }
        }

        function updateProfileElements(userData) {
            const firstLetter = userData.displayName.charAt(0).toUpperCase();
            const verifiedBadge = userData.isVerified ? getVerifiedBadge() : '';
            
            // Update navigation profile pic
            const navPic = document.getElementById('navProfilePic');
            if (userData.profileImage) {
                navPic.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
            } else {
                navPic.textContent = firstLetter;
            }

            // Update mobile navigation profile pic
            const mobileNavPic = document.getElementById('mobileNavProfilePic');
            if (userData.profileImage) {
                mobileNavPic.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
            } else {
                mobileNavPic.textContent = firstLetter;
            }

            // Update sidebar elements
            const sidebarPic = document.getElementById('sidebarProfilePic');
            if (userData.profileImage) {
                sidebarPic.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
            } else {
                sidebarPic.textContent = firstLetter;
            }

            document.getElementById('sidebarName').innerHTML = `${userData.displayName}${verifiedBadge}`;
            document.getElementById('sidebarUsername').textContent = `@${userData.username}`;
            document.getElementById('buzzCount').textContent = Number(userData.buzzCount || 0);
            document.getElementById('followingCount').textContent = Number(userData.followingCount || 0);
            document.getElementById('followersCount').textContent = Number(userData.followersCount || 0);

            // Update create buzz profile pic
            const createBuzzPic = document.getElementById('createBuzzProfilePic');
            if (userData.profileImage) {
                createBuzzPic.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
            } else {
                createBuzzPic.textContent = firstLetter;
            }

            // Update profile page
            const profilePagePic = document.getElementById('profilePagePic');
            if (userData.profileImage) {
                profilePagePic.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
            } else {
                profilePagePic.textContent = firstLetter;
            }

            document.getElementById('profilePageName').innerHTML = `${userData.displayName}${verifiedBadge}`;
            document.getElementById('profilePageUsername').textContent = `@${userData.username}`;
            document.getElementById('profilePageBio').textContent = userData.bio || 'No bio yet';
            document.getElementById('profileBuzzCount').textContent = Number(userData.buzzCount || 0);
            document.getElementById('profileFollowingCount').textContent = Number(userData.followingCount || 0);
            document.getElementById('profileFollowersCount').textContent = Number(userData.followersCount || 0);

            // Update comment modal profile pic
            const commentPic = document.getElementById('commentProfilePic');
            if (userData.profileImage) {
                commentPic.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
            } else {
                commentPic.textContent = firstLetter;
            }
        }

        // Navigation
        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('[id$="Page"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(page + 'Page').classList.remove('hidden');

            // Update desktop navigation buttons
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('text-sky-500'));
            document.getElementById(page + 'Btn')?.classList.add('text-sky-500');

            // Update mobile navigation buttons
            document.querySelectorAll('#mobileNav button').forEach(btn => {
                btn.classList.remove('text-sky-500');
                btn.classList.add('text-gray-600');
            });
            document.getElementById('mobile' + page.charAt(0).toUpperCase() + page.slice(1) + 'Btn')?.classList.remove('text-gray-600');
            document.getElementById('mobile' + page.charAt(0).toUpperCase() + page.slice(1) + 'Btn')?.classList.add('text-sky-500');

            // Load page-specific content
            if (page === 'profile') {
                // Check if viewing own profile or someone else's
                if (window.viewedUser && window.viewedUser.uid !== currentUser?.uid) {
                    // Keep the viewed user's profile
                } else {
                    // Load current user's profile
                    loadUserBuzzes();
                    if (currentUser) {
                        loadUserData().then(() => {
                            updateProfilePageWithUser({
                                uid: currentUser.uid,
                                displayName: document.getElementById('sidebarName').textContent,
                                username: document.getElementById('sidebarUsername').textContent.replace('@', ''),
                                bio: document.getElementById('profilePageBio').textContent,
                                buzzCount: document.getElementById('buzzCount').textContent,
                                followingCount: document.getElementById('followingCount').textContent,
                                followersCount: document.getElementById('followersCount').textContent,
                                profileImage: null // Will be handled by loadUserData
                            });
                        });
                    }
                }
            } else if (page === 'notifications') {
                loadNotifications();
            } else if (page === 'search') {
                loadAllUsersOnSearch();
            }
        }

        function toggleMobileMenu() {
            // This can be used for additional mobile menu functionality if needed
            console.log('Mobile menu toggled');
        }

        // Buzz functionality
        function handleBuzzImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    buzzImageBase64 = e.target.result;
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            buzzImageBase64 = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('buzzImageInput').value = '';
        }

        async function createBuzz() {
            const text = document.getElementById('buzzText').value.trim();
            
            if (!text && !buzzImageBase64) {
                alert('Please write something or add an image');
                return;
            }

            if (!currentUser) {
                alert('Please login first');
                return;
            }

            // Show loading state
            const buzzButton = document.querySelector('button[onclick="createBuzz()"]');
            const originalText = buzzButton.textContent;
            buzzButton.textContent = 'Posting...';
            buzzButton.disabled = true;

            // Clean buzz data - only include defined values
            const buzzData = {
                uid: currentUser.uid,
                text: text || '',
                timestamp: Date.now(),
                likes: 0,
                comments: 0,
                rebuzzes: 0,
                saves: 0
            };

            // Only add image if it exists
            if (buzzImageBase64) {
                buzzData.image = buzzImageBase64;
            }

            try {
                console.log('Creating buzz with data:', buzzData);
                
                // Validate data before sending
                if (!buzzData.uid || buzzData.text === undefined || !buzzData.timestamp) {
                    throw new Error('Invalid buzz data');
                }

                // Add buzz to database
                const buzzRef = push(ref(firebaseDb, 'buzzes'));
                await set(buzzRef, buzzData);
                
                console.log('Buzz created successfully with ID:', buzzRef.key);

                // Update user's buzz count
                const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                if (userData) {
                    await update(userRef, { buzzCount: (userData.buzzCount || 0) + 1 });
                }

                // Clear form
                document.getElementById('buzzText').value = '';
                removeImage();

                // Reload feed and user data
                await loadFeed();
                await loadUserData();

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse';
                successMsg.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Buzz posted successfully! </span>
                    </div>
                `;
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 3000);

            } catch (error) {
                console.error('Error creating buzz:', error);
                console.error('Error details:', error.message);
                
                let errorMessage = 'Failed to post buzz. ';
                if (error.message.includes('undefined')) {
                    errorMessage += 'Data validation error. Please try again.';
                } else if (error.message.includes('permission')) {
                    errorMessage += 'Permission denied. Please check your login.';
                } else {
                    errorMessage += 'Please check your connection and try again.';
                }
                
                alert(errorMessage);
            } finally {
                // Reset button
                buzzButton.textContent = originalText;
                buzzButton.disabled = false;
            }
        }

        async function loadFeed() {
            const buzzesRef = ref(firebaseDb, 'buzzes');
            const snapshot = await get(buzzesRef);
            const buzzes = snapshot.val() || {};

            const feedContainer = document.getElementById('feedContainer');
            feedContainer.innerHTML = '';

            // Convert to array and sort by timestamp
            const buzzArray = Object.entries(buzzes).map(([id, buzz]) => ({ id, ...buzz }));
            buzzArray.sort((a, b) => b.timestamp - a.timestamp);

            for (const buzz of buzzArray) {
                const userRef = ref(firebaseDb, `users/${buzz.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                if (userData) {
                    const buzzElement = createBuzzElement(buzz, userData);
                    feedContainer.appendChild(buzzElement);
                }
            }
        }

        function createBuzzElement(buzz, userData) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl p-6 shadow-sm buzz-card';
            
            const firstLetter = userData.displayName.charAt(0).toUpperCase();
            const profilePicHtml = userData.profileImage 
                ? `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`
                : firstLetter;

            const imageHtml = buzz.image 
                ? `<img src="${buzz.image}" class="w-full rounded-xl mt-4" alt="Buzz image">`
                : '';

            const timeAgo = getTimeAgo(buzz.timestamp);
            const verifiedBadge = userData.isVerified ? getVerifiedBadge() : '';

            div.innerHTML = `
                <div class="flex space-x-4">
                    <div onclick="viewUserProfile('${buzz.uid}')" class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity">
                        ${profilePicHtml}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="flex items-center">
                                <h3 onclick="viewUserProfile('${buzz.uid}')" class="font-semibold text-gray-800 cursor-pointer hover:text-pink-600 transition-colors">${userData.displayName}</h3>
                                ${verifiedBadge}
                            </div>
                            <p onclick="viewUserProfile('${buzz.uid}')" class="text-gray-500 text-sm cursor-pointer hover:text-pink-600 transition-colors">@${userData.username}</p>
                            <span class="text-gray-400"></span>
                            <p class="text-gray-500 text-sm">${timeAgo}</p>
                            <div class="ml-auto relative">
                                <button onclick="showBuzzMenu('${buzz.id}')" class="text-gray-400 hover:text-gray-600 p-1">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-800 mb-4">${buzz.text}</p>
                        ${imageHtml}
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                            <button onclick="toggleLike('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <span>${buzz.likes || 0}</span>
                            </button>
                            <button onclick="openCommentModal('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-blue-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span>${buzz.comments || 0}</span>
                            </button>
                            <button onclick="rebuzz('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-green-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>${buzz.rebuzzes || 0}</span>
                            </button>
                            <button onclick="toggleSave('${buzz.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-pink-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                </svg>
                                <span>${buzz.saves || 0}</span>
                            </button>
                            <button onclick="shareBuzz('${buzz.id}')" class="text-gray-500 hover:text-blue-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            return `${days}d`;
        }

        // Buzz interactions
        async function toggleLike(buzzId) {
            if (!currentUser) return;

            const likeRef = ref(firebaseDb, `likes/${buzzId}/${currentUser.uid}`);
            const likeSnapshot = await get(likeRef);
            const buzzRef = ref(firebaseDb, `buzzes/${buzzId}`);
            const buzzSnapshot = await get(buzzRef);
            const buzzData = buzzSnapshot.val();

            if (likeSnapshot.exists()) {
                // Unlike
                await remove(likeRef);
                await update(buzzRef, { likes: Math.max(0, (buzzData.likes || 0) - 1) });
            } else {
                // Like
                await set(likeRef, true);
                await update(buzzRef, { likes: (buzzData.likes || 0) + 1 });
                
                // Send notification to buzz owner (if not self-like)
                if (buzzData.uid !== currentUser.uid) {
                    await sendNotification(buzzData.uid, 'like', {
                        fromUserId: currentUser.uid,
                        buzzId: buzzId,
                        message: 'liked your buzz'
                    });
                }
            }

            loadFeed();
        }

        async function rebuzz(buzzId) {
            if (!currentUser) return;

            const rebuzzRef = ref(firebaseDb, `rebuzzes/${buzzId}/${currentUser.uid}`);
            const rebuzzSnapshot = await get(rebuzzRef);
            const buzzRef = ref(firebaseDb, `buzzes/${buzzId}`);
            const buzzSnapshot = await get(buzzRef);
            const buzzData = buzzSnapshot.val();

            if (rebuzzSnapshot.exists()) {
                // Un-rebuzz
                await remove(rebuzzRef);
                await update(buzzRef, { rebuzzes: Math.max(0, (buzzData.rebuzzes || 0) - 1) });
            } else {
                // Rebuzz
                await set(rebuzzRef, true);
                await update(buzzRef, { rebuzzes: (buzzData.rebuzzes || 0) + 1 });
                
                // Send notification to buzz owner (if not self-rebuzz)
                if (buzzData.uid !== currentUser.uid) {
                    await sendNotification(buzzData.uid, 'rebuzz', {
                        fromUserId: currentUser.uid,
                        buzzId: buzzId,
                        message: 'rebuzzed your post'
                    });
                }
            }

            loadFeed();
        }

        async function toggleSave(buzzId) {
            if (!currentUser) return;

            const saveRef = ref(firebaseDb, `saves/${buzzId}/${currentUser.uid}`);
            const saveSnapshot = await get(saveRef);
            const buzzRef = ref(firebaseDb, `buzzes/${buzzId}`);
            const buzzSnapshot = await get(buzzRef);
            const buzzData = buzzSnapshot.val();

            if (saveSnapshot.exists()) {
                // Unsave
                await remove(saveRef);
                await update(buzzRef, { saves: Math.max(0, (buzzData.saves || 0) - 1) });
            } else {
                // Save
                await set(saveRef, true);
                await update(buzzRef, { saves: (buzzData.saves || 0) + 1 });
                
                // Send notification to buzz owner (if not self-save)
                if (buzzData.uid !== currentUser.uid) {
                    await sendNotification(buzzData.uid, 'save', {
                        fromUserId: currentUser.uid,
                        buzzId: buzzId,
                        message: 'saved your buzz'
                    });
                }
            }

            loadFeed();
        }

        function shareBuzz(buzzId) {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this Buzz on Pulse',
                    url: window.location.href
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(window.location.href);
                alert('Link copied to clipboard!');
            }
        }

        // Comments
        async function openCommentModal(buzzId) {
            currentBuzzId = buzzId;
            
            // Load original buzz
            const buzzRef = ref(firebaseDb, `buzzes/${buzzId}`);
            const buzzSnapshot = await get(buzzRef);
            const buzzData = buzzSnapshot.val();
            
            const userRef = ref(firebaseDb, `users/${buzzData.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();

            const originalBuzz = document.getElementById('originalBuzz');
            const firstLetter = userData.displayName.charAt(0).toUpperCase();
            const profilePicHtml = userData.profileImage 
                ? `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`
                : firstLetter;

            const imageHtml = buzzData.image 
                ? `<img src="${buzzData.image}" class="w-full rounded-xl mt-4" alt="Buzz image">`
                : '';

            originalBuzz.innerHTML = `
                <div class="flex space-x-4">
                    <div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                        ${profilePicHtml}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <h3 class="font-semibold text-gray-800">${userData.displayName}</h3>
                            <p class="text-gray-500 text-sm">@${userData.username}</p>
                        </div>
                        <p class="text-gray-800">${buzzData.text}</p>
                        ${imageHtml}
                    </div>
                </div>
            `;

            // Load comments
            loadComments(buzzId);

            document.getElementById('commentModal').classList.remove('hidden');
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.add('hidden');
            currentBuzzId = null;
        }

        async function postComment() {
            const text = document.getElementById('commentText').value.trim();
            
            if (!text || !currentBuzzId || !currentUser) return;

            const commentData = {
                buzzId: currentBuzzId,
                uid: currentUser.uid,
                text: text,
                timestamp: Date.now(),
                likes: 0
            };

            try {
                // Add comment
                const commentRef = push(ref(firebaseDb, `comments/${currentBuzzId}`));
                await set(commentRef, commentData);

                // Update buzz comment count
                const buzzRef = ref(firebaseDb, `buzzes/${currentBuzzId}`);
                const buzzSnapshot = await get(buzzRef);
                const buzzData = buzzSnapshot.val();
                await update(buzzRef, { comments: (buzzData.comments || 0) + 1 });

                // Send notification to buzz owner (if not self-comment)
                if (buzzData.uid !== currentUser.uid) {
                    await sendNotification(buzzData.uid, 'comment', {
                        fromUserId: currentUser.uid,
                        buzzId: currentBuzzId,
                        message: 'commented on your buzz'
                    });
                }

                // Clear form and reload
                document.getElementById('commentText').value = '';
                loadComments(currentBuzzId);
                loadFeed();
            } catch (error) {
                console.error('Error posting comment:', error);
                alert('Failed to post comment. Please try again.');
            }
        }

        async function loadComments(buzzId) {
            const commentsRef = ref(firebaseDb, `comments/${buzzId}`);
            const snapshot = await get(commentsRef);
            const comments = snapshot.val() || {};

            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';

            // Convert to array and sort by timestamp
            const commentArray = Object.entries(comments).map(([id, comment]) => ({ id, ...comment }));
            commentArray.sort((a, b) => a.timestamp - b.timestamp);

            for (const comment of commentArray) {
                const userRef = ref(firebaseDb, `users/${comment.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                if (userData) {
                    const commentElement = createCommentElement(comment, userData);
                    commentsList.appendChild(commentElement);
                }
            }
        }

        function createCommentElement(comment, userData) {
            const div = document.createElement('div');
            div.className = 'flex space-x-3';
            
            const firstLetter = userData.displayName.charAt(0).toUpperCase();
            const profilePicHtml = userData.profileImage 
                ? `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`
                : firstLetter;

            const timeAgo = getTimeAgo(comment.timestamp);
            const verifiedBadge = userData.isVerified ? getVerifiedBadge() : '';

            div.innerHTML = `
                <div class="w-8 h-8 gradient-bg rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                    ${profilePicHtml}
                </div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <div class="flex items-center">
                            <h4 class="font-medium text-gray-800 text-sm">${userData.displayName}</h4>
                            ${verifiedBadge}
                        </div>
                        <p class="text-gray-500 text-xs">@${userData.username}</p>
                        <span class="text-gray-400 text-xs"></span>
                        <p class="text-gray-500 text-xs">${timeAgo}</p>
                    </div>
                    <p class="text-gray-700 text-sm">${comment.text}</p>
                    <div class="flex items-center space-x-4 mt-2">
                        <button onclick="likeComment('${comment.id}')" class="flex items-center space-x-1 text-gray-500 hover:text-red-500 transition-colors text-xs">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                            <span>${comment.likes || 0}</span>
                        </button>
                        <button class="text-gray-500 hover:text-blue-500 transition-colors text-xs">Reply</button>
                    </div>
                </div>
            `;

            return div;
        }

        async function likeComment(commentId) {
            if (!currentUser || !currentBuzzId) return;

            const likeRef = ref(firebaseDb, `commentLikes/${currentBuzzId}/${commentId}/${currentUser.uid}`);
            const likeSnapshot = await get(likeRef);
            const commentRef = ref(firebaseDb, `comments/${currentBuzzId}/${commentId}`);
            const commentSnapshot = await get(commentRef);
            const commentData = commentSnapshot.val();

            if (likeSnapshot.exists()) {
                // Unlike
                await remove(likeRef);
                await update(commentRef, { likes: Math.max(0, (commentData.likes || 0) - 1) });
            } else {
                // Like
                await set(likeRef, true);
                await update(commentRef, { likes: (commentData.likes || 0) + 1 });
            }

            loadComments(currentBuzzId);
        }

        // Profile Tab Functions
        function showProfileTab(tabName) {
            // Hide all tab contents
            document.getElementById('userBuzzes').classList.add('hidden');
            document.getElementById('userRebuzzes').classList.add('hidden');
            document.getElementById('userMedia').classList.add('hidden');
            document.getElementById('userLikes').classList.add('hidden');

            // Reset all tab buttons
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });

            // Show selected tab and activate button
            if (tabName === 'buzzes') {
                document.getElementById('userBuzzes').classList.remove('hidden');
                document.getElementById('buzzesTab').className = 'py-4 px-1 border-b-2 border-pink-500 font-medium text-sm text-pink-600';
                loadUserBuzzes();
            } else if (tabName === 'rebuzzes') {
                document.getElementById('userRebuzzes').classList.remove('hidden');
                document.getElementById('rebuzzesTab').className = 'py-4 px-1 border-b-2 border-pink-500 font-medium text-sm text-pink-600';
                loadUserRebuzzes();
            } else if (tabName === 'media') {
                document.getElementById('userMedia').classList.remove('hidden');
                document.getElementById('mediaTab').className = 'py-4 px-1 border-b-2 border-pink-500 font-medium text-sm text-pink-600';
                loadUserMedia();
            } else if (tabName === 'likes') {
                document.getElementById('userLikes').classList.remove('hidden');
                document.getElementById('likesTab').className = 'py-4 px-1 border-b-2 border-pink-500 font-medium text-sm text-pink-600';
                loadUserLikes();
            }
        }

        async function loadUserBuzzes() {
            if (!currentUser) return;

            const buzzesRef = ref(firebaseDb, 'buzzes');
            const snapshot = await get(buzzesRef);
            const buzzes = snapshot.val() || {};

            const userBuzzes = Object.entries(buzzes)
                .filter(([id, buzz]) => buzz.uid === currentUser.uid)
                .map(([id, buzz]) => ({ id, ...buzz }))
                .sort((a, b) => b.timestamp - a.timestamp);

            const container = document.getElementById('userBuzzes');
            container.innerHTML = '';

            if (userBuzzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No buzzes yet</h3>
                        <p class="text-gray-500">Start buzzing to see your posts here!</p>
                    </div>
                `;
                return;
            }

            const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();

            for (const buzz of userBuzzes) {
                const buzzElement = createBuzzElement(buzz, userData);
                container.appendChild(buzzElement);
            }
        }

        async function loadUserRebuzzes() {
            if (!currentUser) return;

            const rebuzzesRef = ref(firebaseDb, 'rebuzzes');
            const snapshot = await get(rebuzzesRef);
            const allRebuzzes = snapshot.val() || {};

            const userRebuzzIds = [];
            Object.entries(allRebuzzes).forEach(([buzzId, users]) => {
                if (users[currentUser.uid]) {
                    userRebuzzIds.push(buzzId);
                }
            });

            const container = document.getElementById('userRebuzzes');
            container.innerHTML = '';

            if (userRebuzzIds.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No rebuzzes yet</h3>
                        <p class="text-gray-500">Rebuzz posts you like to see them here!</p>
                    </div>
                `;
                return;
            }

            // Load actual buzzes
            const buzzesRef = ref(firebaseDb, 'buzzes');
            const buzzesSnapshot = await get(buzzesRef);
            const buzzes = buzzesSnapshot.val() || {};

            for (const buzzId of userRebuzzIds) {
                if (buzzes[buzzId]) {
                    const buzz = { id: buzzId, ...buzzes[buzzId] };
                    const userRef = ref(firebaseDb, `users/${buzz.uid}`);
                    const userSnapshot = await get(userRef);
                    const userData = userSnapshot.val();

                    if (userData) {
                        const buzzElement = createBuzzElement(buzz, userData);
                        // Add rebuzz indicator
                        const rebuzzIndicator = document.createElement('div');
                        rebuzzIndicator.className = 'flex items-center space-x-2 text-gray-500 text-sm mb-3';
                        rebuzzIndicator.innerHTML = `
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>You rebuzzed</span>
                        `;
                        buzzElement.insertBefore(rebuzzIndicator, buzzElement.firstChild);
                        container.appendChild(buzzElement);
                    }
                }
            }
        }

        async function loadUserMedia() {
            if (!currentUser) return;

            const buzzesRef = ref(firebaseDb, 'buzzes');
            const snapshot = await get(buzzesRef);
            const buzzes = snapshot.val() || {};

            const userMediaBuzzes = Object.entries(buzzes)
                .filter(([id, buzz]) => buzz.uid === currentUser.uid && buzz.image)
                .map(([id, buzz]) => ({ id, ...buzz }))
                .sort((a, b) => b.timestamp - a.timestamp);

            const container = document.getElementById('userMedia').querySelector('.grid');
            container.innerHTML = '';

            if (userMediaBuzzes.length === 0) {
                container.className = 'text-center py-12';
                container.innerHTML = `
                    <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No media yet</h3>
                    <p class="text-gray-500">Share photos to see them here!</p>
                `;
                return;
            }

            container.className = 'grid grid-cols-3 gap-4';
            for (const buzz of userMediaBuzzes) {
                const mediaElement = document.createElement('div');
                mediaElement.className = 'aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:opacity-90 transition-opacity';
                mediaElement.innerHTML = `<img src="${buzz.image}" class="w-full h-full object-cover" alt="Media">`;
                mediaElement.onclick = () => openCommentModal(buzz.id);
                container.appendChild(mediaElement);
            }
        }

        async function loadUserLikes() {
            if (!currentUser) return;

            const likesRef = ref(firebaseDb, 'likes');
            const snapshot = await get(likesRef);
            const allLikes = snapshot.val() || {};

            const userLikedBuzzIds = [];
            Object.entries(allLikes).forEach(([buzzId, users]) => {
                if (users[currentUser.uid]) {
                    userLikedBuzzIds.push(buzzId);
                }
            });

            const container = document.getElementById('userLikes');
            container.innerHTML = '';

            if (userLikedBuzzIds.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No likes yet</h3>
                        <p class="text-gray-500">Like buzzes to see them here!</p>
                    </div>
                `;
                return;
            }

            // Load actual buzzes
            const buzzesRef = ref(firebaseDb, 'buzzes');
            const buzzesSnapshot = await get(buzzesRef);
            const buzzes = buzzesSnapshot.val() || {};

            for (const buzzId of userLikedBuzzIds) {
                if (buzzes[buzzId]) {
                    const buzz = { id: buzzId, ...buzzes[buzzId] };
                    const userRef = ref(firebaseDb, `users/${buzz.uid}`);
                    const userSnapshot = await get(userRef);
                    const userData = userSnapshot.val();

                    if (userData) {
                        const buzzElement = createBuzzElement(buzz, userData);
                        container.appendChild(buzzElement);
                    }
                }
            }
        }

        // Settings Functions
        async function togglePrivateAccount() {
            if (!currentUser) return;

            const isPrivate = document.getElementById('privateAccount').checked;
            const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
            
            try {
                await update(userRef, { isPrivate: isPrivate });
                const message = isPrivate ? 'Account set to private' : 'Account set to public';
                alert(message);
            } catch (error) {
                console.error('Error updating privacy:', error);
                alert('Failed to update privacy setting');
            }
        }

        function showBlockedAccounts() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.id = 'blockedAccountsModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Blocked Accounts</h3>
                        <button onclick="closeBlockedAccounts()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="blockedAccountsList" class="space-y-3">
                        <!-- Blocked accounts will be loaded here -->
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadBlockedAccounts();
        }

        function closeBlockedAccounts() {
            const modal = document.getElementById('blockedAccountsModal');
            if (modal) {
                modal.remove();
            }
        }

        async function loadBlockedAccounts() {
            if (!currentUser) return;
            
            const blockedRef = ref(firebaseDb, `blocked/${currentUser.uid}`);
            const snapshot = await get(blockedRef);
            const blockedUsers = snapshot.val() || {};
            
            const container = document.getElementById('blockedAccountsList');
            
            if (Object.keys(blockedUsers).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18 21l-5.586-5.586m0 0L21 18l-5.586-5.586m0 0L5.636 5.636M18.364 18.364L5.636 5.636"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500">No blocked accounts</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            for (const [blockedUserId, timestamp] of Object.entries(blockedUsers)) {
                const userRef = ref(firebaseDb, `users/${blockedUserId}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                
                if (userData) {
                    const blockedItem = document.createElement('div');
                    blockedItem.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
                    
                    const firstLetter = userData.displayName.charAt(0).toUpperCase();
                    const profilePicHtml = userData.profileImage 
                        ? `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`
                        : firstLetter;
                    
                    blockedItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 gradient-bg rounded-full flex items-center justify-center text-white font-bold">
                                ${profilePicHtml}
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${userData.displayName}</p>
                                <p class="text-sm text-gray-500">@${userData.username}</p>
                            </div>
                        </div>
                        <button onclick="unblockUser('${blockedUserId}')" class="bg-pink-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-pink-600 transition-colors">
                            Unblock
                        </button>
                    `;
                    
                    container.appendChild(blockedItem);
                }
            }
        }

        async function unblockUser(userId) {
            if (!currentUser) return;
            
            try {
                const blockedRef = ref(firebaseDb, `blocked/${currentUser.uid}/${userId}`);
                await remove(blockedRef);
                
                loadBlockedAccounts();
                alert('User unblocked successfully');
            } catch (error) {
                console.error('Error unblocking user:', error);
                alert('Failed to unblock user');
            }
        }

        async function addAccount() {
            try {
                // Create a new Google Auth provider instance
                const newProvider = new GoogleAuthProvider();
                newProvider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                const result = await signInWithPopup(firebaseAuth, newProvider);
                const newUser = result.user;
                
                // Check if this account already exists
                const userRef = ref(firebaseDb, `users/${newUser.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    // Switch to existing account
                    currentUser = newUser;
                    showMainApp();
                    loadUserData();
                    alert('Switched to existing account successfully!');
                } else {
                    // New account - needs setup
                    currentUser = newUser;
                    showSetupScreen();
                    alert('New account detected. Please complete the setup.');
                }
            } catch (error) {
                console.error('Add account error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    alert('Account selection was cancelled.');
                } else {
                    alert('Failed to add account. Please try again.');
                }
            }
        }

        // Notification System
        async function sendNotification(toUserId, type, data) {
            if (!currentUser) return;

            const notificationData = {
                toUserId: toUserId,
                fromUserId: data.fromUserId,
                type: type,
                buzzId: data.buzzId || null,
                message: data.message,
                timestamp: Date.now(),
                read: false
            };

            try {
                const notificationRef = push(ref(firebaseDb, `notifications/${toUserId}`));
                await set(notificationRef, notificationData);
                
                // Update notification count for the user
                await updateNotificationCount(toUserId);
            } catch (error) {
                console.error('Error sending notification:', error);
            }
        }

        async function updateNotificationCount(userId) {
            const notificationsRef = ref(firebaseDb, `notifications/${userId}`);
            const snapshot = await get(notificationsRef);
            const notifications = snapshot.val() || {};
            
            const unreadCount = Object.values(notifications).filter(n => !n.read).length;
            
            // Update UI if it's current user
            if (currentUser && userId === currentUser.uid) {
                const notificationDot = document.getElementById('notificationDot');
                const mobileNotificationDot = document.getElementById('mobileNotificationDot');
                
                if (unreadCount > 0) {
                    notificationDot?.classList.remove('hidden');
                    mobileNotificationDot?.classList.remove('hidden');
                } else {
                    notificationDot?.classList.add('hidden');
                    mobileNotificationDot?.classList.add('hidden');
                }
            }
        }

        async function loadNotifications() {
            if (!currentUser) return;

            const notificationsRef = ref(firebaseDb, `notifications/${currentUser.uid}`);
            const snapshot = await get(notificationsRef);
            const notifications = snapshot.val() || {};

            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';

            const notificationArray = Object.entries(notifications)
                .map(([id, notification]) => ({ id, ...notification }))
                .sort((a, b) => b.timestamp - a.timestamp);

            if (notificationArray.length === 0) {
                notificationsList.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5v3.5"></path>
                        </svg>
                        <p class="text-lg">No notifications yet</p>
                        <p class="text-sm">We'll notify you when something happens!</p>
                    </div>
                `;
                return;
            }

            for (const notification of notificationArray) {
                const userRef = ref(firebaseDb, `users/${notification.fromUserId}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                if (userData) {
                    const notificationElement = await createNotificationElement(notification, userData);
                    notificationsList.appendChild(notificationElement);
                }
            }

            // Mark all as read
            for (const notification of notificationArray) {
                if (!notification.read) {
                    const notificationRef = ref(firebaseDb, `notifications/${currentUser.uid}/${notification.id}`);
                    await update(notificationRef, { read: true });
                }
            }

            // Update notification count
            await updateNotificationCount(currentUser.uid);
        }

        async function createNotificationElement(notification, userData) {
            const div = document.createElement('div');
            div.className = `p-4 hover:bg-gray-50 cursor-pointer ${!notification.read ? 'bg-blue-50' : ''}`;
            
            const firstLetter = userData.displayName.charAt(0).toUpperCase();
            const profilePicHtml = userData.profileImage 
                ? `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`
                : firstLetter;

            const timeAgo = getTimeAgo(notification.timestamp);
            
            let iconHtml = '';
            let iconColor = '';
            
            switch (notification.type) {
                case 'like':
                    iconHtml = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>`;
                    iconColor = 'text-red-500';
                    break;
                case 'comment':
                    iconHtml = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>`;
                    iconColor = 'text-blue-500';
                    break;
                case 'rebuzz':
                    iconHtml = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>`;
                    iconColor = 'text-green-500';
                    break;
                case 'save':
                    iconHtml = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>`;
                    iconColor = 'text-pink-500';
                    break;
                case 'verification':
                    iconHtml = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
                    iconColor = 'text-green-500';
                    break;
            }

            const verifiedBadge = userData.isVerified ? getVerifiedBadge() : '';
            
            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div onclick="viewUserProfile('${notification.fromUserId}')" class="w-10 h-10 gradient-bg rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity">
                        ${profilePicHtml}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <p class="text-sm">
                                <span onclick="viewUserProfile('${notification.fromUserId}')" class="font-semibold text-gray-900 cursor-pointer hover:text-pink-600 transition-colors flex items-center">
                                    ${userData.displayName}${verifiedBadge}
                                </span>
                                <span class="text-gray-600">${notification.message}</span>
                            </p>
                            <svg class="w-4 h-4 ${iconColor} flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                ${iconHtml}
                            </svg>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                    </div>
                </div>
            `;

            if (notification.buzzId) {
                div.onclick = () => openCommentModal(notification.buzzId);
            }

            return div;
        }

        // Search Functions
        async function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
                searchInput.addEventListener('focus', () => {
                    document.getElementById('searchResults').classList.remove('hidden');
                });
                
                // Hide search results when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !document.getElementById('searchResults').contains(e.target)) {
                        document.getElementById('searchResults').classList.add('hidden');
                    }
                });
            }
            
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', handleMobileSearch);
            }
        }

        async function handleSearch(event) {
            const query = event.target.value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (query.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const users = await searchUsers(query);
            displaySearchResults(users, searchResults);
        }

        async function handleMobileSearch(event) {
            const query = event.target.value.trim().toLowerCase();
            const searchResults = document.getElementById('mobileSearchResults');
            
            if (query.length === 0) {
                searchResults.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <p class="text-lg">Search for users</p>
                        <p class="text-sm">Find and connect with people on Pulse</p>
                    </div>
                `;
                return;
            }
            
            const users = await searchUsers(query);
            displayMobileSearchResults(users, searchResults);
        }

        async function searchUsers(query) {
            const usersRef = ref(firebaseDb, 'users');
            const snapshot = await get(usersRef);
            const users = snapshot.val() || {};
            
            if (query.length === 0) {
                // Show all users if no query
                return Object.entries(users)
                    .map(([uid, userData]) => ({ uid, ...userData }))
                    .slice(0, 20); // Show first 20 users
            }
            
            return Object.entries(users)
                .map(([uid, userData]) => ({ uid, ...userData }))
                .filter(user => 
                    user.displayName.toLowerCase().includes(query) ||
                    user.username.toLowerCase().includes(query)
                )
                .slice(0, 10); // Limit to 10 results for search
        }

        function displaySearchResults(users, container) {
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>No users found</p>
                    </div>
                `;
            } else {
                users.forEach(user => {
                    const userElement = createSearchUserElement(user);
                    container.appendChild(userElement);
                });
            }
            
            container.classList.remove('hidden');
        }

        function displayMobileSearchResults(users, container) {
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <p class="text-lg">No users found</p>
                        <p class="text-sm">Try a different search term</p>
                    </div>
                `;
            } else {
                users.forEach(user => {
                    const userElement = createMobileSearchUserElement(user);
                    container.appendChild(userElement);
                });
            }
        }

        function createSearchUserElement(user) {
            const div = document.createElement('div');
            div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
            
            const firstLetter = user.displayName.charAt(0).toUpperCase();
            const profilePicHtml = user.profileImage 
                ? `<img src="${user.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`
                : firstLetter;
            const verifiedBadge = user.isVerified ? getVerifiedBadge() : '';
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 gradient-bg rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                        ${profilePicHtml}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <p class="font-semibold text-gray-900 truncate">${user.displayName}</p>
                            ${verifiedBadge}
                        </div>
                        <p class="text-sm text-gray-500 truncate">@${user.username}</p>
                    </div>
                </div>
            `;
            
            div.onclick = () => {
                viewUserProfile(user.uid);
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            };
            
            return div;
        }

        function createMobileSearchUserElement(user) {
            const div = document.createElement('div');
            div.className = 'p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
            
            const firstLetter = user.displayName.charAt(0).toUpperCase();
            const profilePicHtml = user.profileImage 
                ? `<img src="${user.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`
                : firstLetter;
            const verifiedBadge = user.isVerified ? getVerifiedBadge() : '';
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                        ${profilePicHtml}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <p class="font-semibold text-gray-900 truncate">${user.displayName}</p>
                            ${verifiedBadge}
                        </div>
                        <p class="text-sm text-gray-500 truncate">@${user.username}</p>
                        ${user.bio ? `<p class="text-sm text-gray-600 truncate mt-1">${user.bio}</p>` : ''}
                    </div>
                </div>
            `;
            
            div.onclick = () => {
                viewUserProfile(user.uid);
            };
            
            return div;
        }

        // User Profile Viewing
        async function viewUserProfile(userId) {
            if (!userId) return;
            
            try {
                const userRef = ref(firebaseDb, `users/${userId}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                
                if (!userData) {
                    alert('User not found');
                    return;
                }
                
                // Store the viewed user data
                window.viewedUser = { uid: userId, ...userData };
                
                // Update profile page with viewed user data
                updateProfilePageWithUser(userData);
                
                // Load user's buzzes
                await loadViewedUserBuzzes(userId);
                
                // Show profile page
                showPage('profile');
                
            } catch (error) {
                console.error('Error viewing user profile:', error);
                alert('Failed to load user profile');
            }
        }

        function updateProfilePageWithUser(userData) {
            const firstLetter = userData.displayName.charAt(0).toUpperCase();
            const verifiedBadge = userData.isVerified ? getVerifiedBadge() : '';
            
            // Update profile page picture
            const profilePagePic = document.getElementById('profilePagePic');
            if (userData.profileImage) {
                profilePagePic.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
            } else {
                profilePagePic.textContent = firstLetter;
            }
            
            // Update profile page info
            document.getElementById('profilePageName').innerHTML = `${userData.displayName}${verifiedBadge}`;
            document.getElementById('profilePageUsername').textContent = `@${userData.username}`;
            document.getElementById('profilePageBio').textContent = userData.bio || 'No bio yet';
            document.getElementById('profileBuzzCount').textContent = Number(userData.buzzCount || 0);
            document.getElementById('profileFollowingCount').textContent = Number(userData.followingCount || 0);
            document.getElementById('profileFollowersCount').textContent = Number(userData.followersCount || 0);
            
            // Update edit button based on whether it's current user or not
            const editButton = document.querySelector('button[onclick="editProfile()"]');
            if (currentUser && userData.uid === currentUser.uid) {
                editButton.textContent = 'Edit Profile';
                editButton.onclick = editProfile;
            } else {
                editButton.textContent = 'Follow';
                editButton.onclick = () => followUser(userData.uid);
            }
        }

        async function loadViewedUserBuzzes(userId) {
            const buzzesRef = ref(firebaseDb, 'buzzes');
            const snapshot = await get(buzzesRef);
            const buzzes = snapshot.val() || {};

            const userBuzzes = Object.entries(buzzes)
                .filter(([id, buzz]) => buzz.uid === userId)
                .map(([id, buzz]) => ({ id, ...buzz }))
                .sort((a, b) => b.timestamp - a.timestamp);

            const container = document.getElementById('userBuzzes');
            container.innerHTML = '';

            if (userBuzzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No buzzes yet</h3>
                            <p class="text-gray-500">This user hasn't posted anything yet!</p>
                        </div>
                    </div>
                `;
                return;
            }

            const userRef = ref(firebaseDb, `users/${userId}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();

            for (const buzz of userBuzzes) {
                const buzzElement = createBuzzElement(buzz, userData);
                container.appendChild(buzzElement);
            }
        }

        async function followUser(userId) {
            if (!currentUser || userId === currentUser.uid) return;
            
            try {
                const followRef = ref(firebaseDb, `follows/${currentUser.uid}/${userId}`);
                const followSnapshot = await get(followRef);
                
                const followerRef = ref(firebaseDb, `followers/${userId}/${currentUser.uid}`);
                const currentUserRef = ref(firebaseDb, `users/${currentUser.uid}`);
                const targetUserRef = ref(firebaseDb, `users/${userId}`);
                
                const currentUserSnapshot = await get(currentUserRef);
                const targetUserSnapshot = await get(targetUserRef);
                
                const currentUserData = currentUserSnapshot.val();
                const targetUserData = targetUserSnapshot.val();
                
                if (followSnapshot.exists()) {
                    // Unfollow
                    await remove(followRef);
                    await remove(followerRef);
                    
                    // Update counts
                    await update(currentUserRef, { 
                        followingCount: Math.max(0, (currentUserData.followingCount || 0) - 1) 
                    });
                    await update(targetUserRef, { 
                        followersCount: Math.max(0, (targetUserData.followersCount || 0) - 1) 
                    });
                    
                    // Update button text
                    const editButton = document.querySelector('button[onclick*="followUser"]');
                    if (editButton) {
                        editButton.textContent = 'Follow';
                    }
                    
                    alert('Unfollowed successfully!');
                } else {
                    // Follow
                    await set(followRef, true);
                    await set(followerRef, true);
                    
                    // Update counts
                    await update(currentUserRef, { 
                        followingCount: (currentUserData.followingCount || 0) + 1 
                    });
                    await update(targetUserRef, { 
                        followersCount: (targetUserData.followersCount || 0) + 1 
                    });
                    
                    // Update button text
                    const editButton = document.querySelector('button[onclick*="followUser"]');
                    if (editButton) {
                        editButton.textContent = 'Following';
                    }
                    
                    // Send notification
                    await sendNotification(userId, 'follow', {
                        fromUserId: currentUser.uid,
                        message: 'started following you'
                    });
                    
                    alert('Followed successfully!');
                }
                
                // Reload user data to update counts
                await loadUserData();
                
            } catch (error) {
                console.error('Error following/unfollowing user:', error);
                alert('Failed to follow/unfollow user. Please try again.');
            }
        }

        async function showBuzzMenu(buzzId) {
            // Get buzz data to check if current user owns it
            const buzzRef = ref(firebaseDb, `buzzes/${buzzId}`);
            const buzzSnapshot = await get(buzzRef);
            const buzzData = buzzSnapshot.val();
            
            const menu = document.createElement('div');
            menu.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            menu.id = 'buzzMenu';
            
            let deleteButton = '';
            if (currentUser && buzzData && buzzData.uid === currentUser.uid) {
                deleteButton = `
                    <button onclick="deleteBuzz('${buzzId}')" class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-lg flex items-center space-x-3">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span class="text-gray-700">Delete Buzz</span>
                    </button>
                `;
            }
            
            menu.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Buzz Options</h3>
                    <div class="space-y-3">
                        ${deleteButton}
                        <button onclick="reportBuzz('${buzzId}')" class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-lg flex items-center space-x-3">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <span class="text-gray-700">Report Buzz</span>
                        </button>
                        <button onclick="copyBuzzLink('${buzzId}')" class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-lg flex items-center space-x-3">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                            </svg>
                            <span class="text-gray-700">Copy Link</span>
                        </button>
                        <button onclick="closeBuzzMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-lg flex items-center space-x-3">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span class="text-gray-700">Cancel</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
        }

        function closeBuzzMenu() {
            const menu = document.getElementById('buzzMenu');
            if (menu) {
                menu.remove();
            }
        }

        function reportBuzz(buzzId) {
            closeBuzzMenu();
            alert('Buzz reported successfully. Our team will review it.');
        }

        function copyBuzzLink(buzzId) {
            closeBuzzMenu();
            const link = `${window.location.origin}#buzz=${buzzId}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy link');
            });
        }

        async function deleteBuzz(buzzId) {
            if (!currentUser) return;
            
            if (!confirm('Are you sure you want to delete this buzz? This action cannot be undone.')) {
                return;
            }
            
            try {
                closeBuzzMenu();
                
                // Delete the buzz
                const buzzRef = ref(firebaseDb, `buzzes/${buzzId}`);
                await remove(buzzRef);
                
                // Delete associated comments
                const commentsRef = ref(firebaseDb, `comments/${buzzId}`);
                await remove(commentsRef);
                
                // Delete associated likes
                const likesRef = ref(firebaseDb, `likes/${buzzId}`);
                await remove(likesRef);
                
                // Delete associated rebuzzes
                const rebuzzesRef = ref(firebaseDb, `rebuzzes/${buzzId}`);
                await remove(rebuzzesRef);
                
                // Delete associated saves
                const savesRef = ref(firebaseDb, `saves/${buzzId}`);
                await remove(savesRef);
                
                // Update user's buzz count
                const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                if (userData) {
                    await update(userRef, { buzzCount: Math.max(0, (userData.buzzCount || 0) - 1) });
                }
                
                // Reload feed and user data
                await loadFeed();
                await loadUserData();
                
                alert('Buzz deleted successfully!');
            } catch (error) {
                console.error('Error deleting buzz:', error);
                alert('Failed to delete buzz. Please try again.');
            }
        }

        function editProfile() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.id = 'editProfileModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Edit Profile</h3>
                        <button onclick="closeEditProfile()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="w-24 h-24 mx-auto mb-4 relative">
                                <div id="editProfilePreview" class="w-24 h-24 gradient-bg rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                    ?
                                </div>
                                <button onclick="document.getElementById('editImageInput').click()" class="absolute bottom-0 right-0 bg-sky-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-sky-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </button>
                            </div>
                            <input type="file" id="editImageInput" accept="image/*" class="hidden" onchange="handleEditImageUpload(event)">
                            <p class="text-sm text-gray-600">Change profile picture</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" id="editDisplayName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                            <textarea id="editBio" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="closeEditProfile()" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                            <button onclick="saveProfile()" class="flex-1 gradient-bg text-white py-3 rounded-xl font-medium hover:opacity-90 transition-opacity">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load current profile data
            loadCurrentProfileData();
        }

        function handleEditImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('editProfilePreview');
                    img.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
                    window.editProfileImageBase64 = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function loadCurrentProfileData() {
            if (!currentUser) return;
            
            const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            
            if (userData) {
                document.getElementById('editDisplayName').value = userData.displayName || '';
                document.getElementById('editBio').value = userData.bio || '';
                
                // Load current profile image
                const editPreview = document.getElementById('editProfilePreview');
                if (userData.profileImage) {
                    editPreview.innerHTML = `<img src="${userData.profileImage}" class="w-full h-full object-cover rounded-full" alt="Profile">`;
                    window.editProfileImageBase64 = userData.profileImage;
                } else {
                    const firstLetter = userData.displayName.charAt(0).toUpperCase();
                    editPreview.textContent = firstLetter;
                    window.editProfileImageBase64 = null;
                }
            }
        }

        function closeEditProfile() {
            const modal = document.getElementById('editProfileModal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveProfile() {
            if (!currentUser) return;
            
            const displayName = document.getElementById('editDisplayName').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            
            if (!displayName) {
                alert('Display name is required');
                return;
            }
            
            try {
                const updateData = {
                    displayName: displayName,
                    bio: bio
                };
                
                // Include profile image if changed
                if (window.editProfileImageBase64) {
                    updateData.profileImage = window.editProfileImageBase64;
                }
                
                const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
                await update(userRef, updateData);
                
                closeEditProfile();
                loadUserData();
                alert('Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile. Please try again.');
            }
        }

        async function loadAllUsersOnSearch() {
            const users = await searchUsers(''); // Empty query returns all users
            const searchResults = document.getElementById('mobileSearchResults');
            displayMobileSearchResults(users, searchResults);
        }

        // Verification System
        function showVerificationRequest() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.id = 'verificationModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Request Verification</h3>
                        <button onclick="closeVerificationModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name (as on National ID) *</label>
                            <input type="text" id="verificationName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="Enter your full legal name" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Why do you think you deserve a verified badge? *</label>
                            <textarea id="verificationReason" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="Explain why you should be verified..." required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Other name you are famous by (Optional)</label>
                            <input type="text" id="verificationFamousName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="Stage name, pen name, etc.">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                            <select id="verificationCountry" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent" onchange="updateDocumentOptions()" required>
                                <option value="">Select your country</option>
                                <option value="US">United States</option>
                                <option value="IN">India</option>
                                <option value="GB">United Kingdom</option>
                                <option value="CA">Canada</option>
                                <option value="AU">Australia</option>
                                <option value="DE">Germany</option>
                                <option value="FR">France</option>
                                <option value="JP">Japan</option>
                                <option value="BR">Brazil</option>
                                <option value="MX">Mexico</option>
                                <option value="IT">Italy</option>
                                <option value="ES">Spain</option>
                                <option value="RU">Russia</option>
                                <option value="CN">China</option>
                                <option value="KR">South Korea</option>
                                <option value="NL">Netherlands</option>
                                <option value="SE">Sweden</option>
                                <option value="NO">Norway</option>
                                <option value="DK">Denmark</option>
                                <option value="FI">Finland</option>
                                <option value="CH">Switzerland</option>
                                <option value="AT">Austria</option>
                                <option value="BE">Belgium</option>
                                <option value="PL">Poland</option>
                                <option value="CZ">Czech Republic</option>
                                <option value="HU">Hungary</option>
                                <option value="GR">Greece</option>
                                <option value="PT">Portugal</option>
                                <option value="IE">Ireland</option>
                                <option value="NZ">New Zealand</option>
                                <option value="SG">Singapore</option>
                                <option value="MY">Malaysia</option>
                                <option value="TH">Thailand</option>
                                <option value="PH">Philippines</option>
                                <option value="ID">Indonesia</option>
                                <option value="VN">Vietnam</option>
                                <option value="BD">Bangladesh</option>
                                <option value="PK">Pakistan</option>
                                <option value="LK">Sri Lanka</option>
                                <option value="NP">Nepal</option>
                                <option value="AE">UAE</option>
                                <option value="SA">Saudi Arabia</option>
                                <option value="EG">Egypt</option>
                                <option value="ZA">South Africa</option>
                                <option value="NG">Nigeria</option>
                                <option value="KE">Kenya</option>
                                <option value="GH">Ghana</option>
                                <option value="AR">Argentina</option>
                                <option value="CL">Chile</option>
                                <option value="CO">Colombia</option>
                                <option value="PE">Peru</option>
                                <option value="VE">Venezuela</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        
                        <div id="documentTypeSection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Document Type *</label>
                            <select id="verificationDocType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent">
                                <!-- Options will be populated based on country -->
                            </select>
                        </div>
                        
                        <div id="documentUploadSection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Document *</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center">
                                <input type="file" id="verificationDocument" accept="image/*" class="hidden" onchange="handleDocumentUpload(event)">
                                <div id="documentUploadArea" onclick="document.getElementById('verificationDocument').click()" class="cursor-pointer">
                                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-gray-600">Click to upload your document</p>
                                    <p class="text-sm text-gray-500 mt-2">PNG, JPG up to 10MB</p>
                                </div>
                                <div id="documentPreview" class="hidden mt-4">
                                    <img id="documentPreviewImg" class="max-w-full h-auto rounded-lg mx-auto" alt="Document preview">
                                    <button onclick="removeDocument()" class="mt-2 text-red-500 text-sm hover:underline">Remove document</button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Social Media Links (Optional)</label>
                            <p class="text-sm text-gray-500 mb-3">Add up to 5 links to verified accounts or news articles mentioning you</p>
                            <div id="socialLinksContainer">
                                <div class="flex space-x-2 mb-2">
                                    <input type="url" id="socialLink1" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="https://instagram.com/yourprofile">
                                </div>
                                <div class="flex space-x-2 mb-2">
                                    <input type="url" id="socialLink2" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="https://facebook.com/yourprofile">
                                </div>
                                <div class="flex space-x-2 mb-2">
                                    <input type="url" id="socialLink3" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="https://youtube.com/yourchannel">
                                </div>
                                <div class="flex space-x-2 mb-2">
                                    <input type="url" id="socialLink4" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="https://news-article-link.com">
                                </div>
                                <div class="flex space-x-2 mb-2">
                                    <input type="url" id="socialLink5" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:border-transparent" placeholder="https://another-link.com">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="closeVerificationModal()" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                            <button onclick="submitVerificationRequest()" class="flex-1 gradient-bg text-white py-3 rounded-xl font-medium hover:opacity-90 transition-opacity">Submit Request</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeVerificationModal() {
            const modal = document.getElementById('verificationModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateDocumentOptions() {
            const country = document.getElementById('verificationCountry').value;
            const docTypeSelect = document.getElementById('verificationDocType');
            const docSection = document.getElementById('documentTypeSection');
            const uploadSection = document.getElementById('documentUploadSection');
            
            if (!country) {
                docSection.classList.add('hidden');
                uploadSection.classList.add('hidden');
                return;
            }
            
            docSection.classList.remove('hidden');
            uploadSection.classList.remove('hidden');
            
            // Clear existing options
            docTypeSelect.innerHTML = '<option value="">Select document type</option>';
            
            let options = [];
            
            switch(country) {
                case 'US':
                    options = [
                        { value: 'passport', text: 'Passport' },
                        { value: 'driving_license', text: 'Driving License' }
                    ];
                    break;
                case 'IN':
                    options = [
                        { value: 'pan_card', text: 'PAN Card' },
                        { value: 'voter_id', text: 'Voter ID Card' },
                        { value: 'aadhaar', text: 'Aadhaar Card' },
                        { value: 'passport', text: 'Passport' }
                    ];
                    break;
                default:
                    options = [
                        { value: 'passport', text: 'Passport' },
                        { value: 'national_id', text: 'National ID Card' },
                        { value: 'driving_license', text: 'Driving License' }
                    ];
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                docTypeSelect.appendChild(optionElement);
            });
        }

        function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert('File size must be less than 10MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('documentUploadArea').classList.add('hidden');
                    document.getElementById('documentPreview').classList.remove('hidden');
                    document.getElementById('documentPreviewImg').src = e.target.result;
                    window.verificationDocumentBase64 = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeDocument() {
            document.getElementById('documentUploadArea').classList.remove('hidden');
            document.getElementById('documentPreview').classList.add('hidden');
            document.getElementById('verificationDocument').value = '';
            window.verificationDocumentBase64 = null;
        }

        async function submitVerificationRequest() {
            if (!currentUser) return;
            
            const name = document.getElementById('verificationName').value.trim();
            const reason = document.getElementById('verificationReason').value.trim();
            const famousName = document.getElementById('verificationFamousName').value.trim();
            const country = document.getElementById('verificationCountry').value;
            const docType = document.getElementById('verificationDocType').value;
            
            if (!name || !reason || !country || !docType || !window.verificationDocumentBase64) {
                alert('Please fill in all required fields and upload a document');
                return;
            }
            
            // Collect social links
            const socialLinks = [];
            for (let i = 1; i <= 5; i++) {
                const link = document.getElementById(`socialLink${i}`).value.trim();
                if (link) {
                    socialLinks.push(link);
                }
            }
            
            const verificationData = {
                uid: currentUser.uid,
                name: name,
                reason: reason,
                famousName: famousName || null,
                country: country,
                documentType: docType,
                document: window.verificationDocumentBase64,
                socialLinks: socialLinks,
                status: 'pending',
                submittedAt: Date.now()
            };
            
            try {
                const verificationRef = push(ref(firebaseDb, 'verificationRequests'));
                await set(verificationRef, verificationData);
                
                closeVerificationModal();
                alert('Verification request submitted successfully! We will review your application and get back to you.');
            } catch (error) {
                console.error('Error submitting verification request:', error);
                alert('Failed to submit verification request. Please try again.');
            }
        }

        // Check verification status and auto-verify specific email
        async function checkVerificationStatus() {
            if (!currentUser) return;
            
            // Auto-verify specific email
            if (currentUser.email === 'customerserviceffrj4@gmail.com') {
                const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                
                if (userData && !userData.isVerified) {
                    await update(userRef, { 
                        isVerified: true,
                        verifiedAt: Date.now()
                    });
                    
                    // Send congratulations notification
                    await sendNotification(currentUser.uid, 'verification', {
                        fromUserId: 'system',
                        message: 'Congratulations! Your account has been verified! '
                    });
                    
                    // Reload user data to show verified badge
                    await loadUserData();
                }
                return;
            }
            
            // Check for approved verification requests
            const verificationsRef = ref(firebaseDb, 'verificationRequests');
            const snapshot = await get(verificationsRef);
            const verifications = snapshot.val() || {};
            
            const userVerification = Object.entries(verifications).find(([id, req]) => 
                req.uid === currentUser.uid && req.status === 'approved'
            );
            
            if (userVerification) {
                const userRef = ref(firebaseDb, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                
                if (userData && !userData.isVerified) {
                    await update(userRef, { 
                        isVerified: true,
                        verifiedAt: Date.now()
                    });
                    
                    // Send congratulations notification
                    await sendNotification(currentUser.uid, 'verification', {
                        fromUserId: 'system',
                        message: 'Congratulations! Your account has been verified! '
                    });
                    
                    // Reload user data to show verified badge
                    await loadUserData();
                }
            }
        }

        // Function to create verified badge HTML
        function getVerifiedBadge() {
            return `<span class="verified-badge">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
            </span>`;
        }

        async function signOutUser() {
            try {
                await signOut(firebaseAuth);
                currentUser = null;
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Initialize app
        onAuthStateChanged(firebaseAuth, (user) => {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.uid);
                // Check if user has completed setup
                const userRef = ref(firebaseDb, `users/${user.uid}`);
                get(userRef).then(snapshot => {
                    if (snapshot.exists()) {
                        console.log('User profile exists, showing main app');
                        showMainApp();
                        loadUserData();
                        
                        // Check verification status
                        checkVerificationStatus();
                        
                        // Initialize search functionality
                        setTimeout(() => {
                            initializeSearch();
                        }, 1000);
                        
                        // Load initial notification count
                        updateNotificationCount(user.uid);
                    } else {
                        console.log('User profile not found, showing setup');
                        showSetupScreen();
                    }
                }).catch(error => {
                    console.error('Error checking user profile:', error);
                    showSetupScreen();
                });
            } else {
                currentUser = null;
                console.log('User not authenticated');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        });

        // Add debug function to check Firebase connection
        window.checkFirebaseConnection = async function() {
            try {
                const testRef = ref(firebaseDb, 'test');
                await set(testRef, { timestamp: Date.now() });
                console.log('Firebase connection successful');
                return true;
            } catch (error) {
                console.error('Firebase connection failed:', error);
                return false;
            }
        };

        // Test connection on load
        setTimeout(() => {
            if (currentUser) {
                checkFirebaseConnection();
            }
        }, 2000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977bfef5968154cb',t:'MTc1NjYzNzczMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
