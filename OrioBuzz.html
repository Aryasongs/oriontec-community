<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrioBuzz - Social Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 25%, #4facfe 50%, #00f2fe 75%, #43e97b 100%);
        }
        .gradient-text {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 25%, #4facfe 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .buzz-card {
            transition: all 0.3s ease;
        }
        .buzz-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .sidebar-item {
            transition: all 0.3s ease;
        }
        .sidebar-item:hover {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1));
            transform: translateX(5px);
        }
        .modal-backdrop {
            backdrop-filter: blur(10px);
        }
        .verified-badge {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            margin-left: 4px;
            object-fit: contain;
        }
        .notification-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .notification-item {
            transition: all 0.3s ease;
        }
        .notification-item:hover {
            background-color: #f3f4f6;
            transform: translateX(5px);
        }
        .onboarding-step {
            transition: all 0.5s ease;
        }
        .interest-tag {
            transition: all 0.3s ease;
        }
        .interest-tag:hover {
            transform: scale(1.05);
        }
        .character-counter {
            transition: color 0.3s ease;
        }
        .character-counter.warning {
            color: #f59e0b;
        }
        .character-counter.danger {
            color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold gradient-text mb-2">OrioBuzz</h1>
                <p class="text-gray-600">Connect with the world</p>
            </div>
            <button id="googleSignIn" class="w-full bg-white border-2 border-gray-300 rounded-full py-3 px-6 flex items-center justify-center hover:bg-gray-50 transition-all duration-300 shadow-lg">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Onboarding Screens -->
    <!-- Profile Setup -->
    <div id="profileSetupScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full mx-4">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold gradient-text mb-2">Complete Your Profile</h2>
                <p class="text-gray-600">Let's set up your OrioBuzz profile</p>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Display Name *</label>
                    <input type="text" id="onboardingDisplayName" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="Your display name">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Username *</label>
                    <input type="text" id="onboardingUsername" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="username (no spaces)" oninput="checkOnboardingUsername()">
                    <p id="onboardingUsernameStatus" class="text-xs mt-1"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bio</label>
                    <textarea id="onboardingBio" class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Location</label>
                    <input type="text" id="onboardingLocation" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="Your location">
                </div>
            </div>
            <button onclick="completeProfileSetup()" class="w-full gradient-bg text-white py-3 rounded-full hover:opacity-90 transition-opacity mt-8">
                Continue
            </button>
        </div>
    </div>

    <!-- Interest Selection -->
    <div id="interestSelectionScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full mx-4">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold gradient-text mb-2">What interests you?</h2>
                <p class="text-gray-600">Select topics you'd like to see in your feed</p>
            </div>
            <div id="interestTags" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <!-- Interest tags will be loaded here -->
            </div>
            <div class="text-center">
                <button onclick="completeInterestSelection()" class="gradient-bg text-white px-8 py-3 rounded-full hover:opacity-90 transition-opacity">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <!-- User Suggestions -->
    <div id="userSuggestionsScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full mx-4">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold gradient-text mb-2">Follow Interesting People</h2>
                <p class="text-gray-600">Discover users based on your interests</p>
            </div>
            <div id="suggestedUsers" class="space-y-4 mb-8 max-h-96 overflow-y-auto">
                <!-- Suggested users will be loaded here -->
            </div>
            <div class="text-center">
                <button onclick="completeOnboarding()" class="gradient-bg text-white px-8 py-3 rounded-full hover:opacity-90 transition-opacity">
                    Start Buzzing!
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Bar -->
        <div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-2xl font-bold gradient-text">OrioBuzz</h1>
                <div class="flex items-center space-x-4">
                    <img id="topBarUserImage" class="w-8 h-8 rounded-full border-2 border-pink-300" src="" alt="User">
                    <span id="topBarUsername" class="font-medium text-gray-700"></span>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto flex flex-col lg:flex-row">
            <!-- Left Sidebar - Desktop -->
            <div class="hidden lg:block w-64 bg-white h-screen sticky top-16 border-r border-gray-200 p-6">
                <nav class="space-y-4">
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showHome()">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                            </svg>
                            <span class="font-medium">Home</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showNotifications()">
                        <div class="flex items-center space-x-3 relative">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                            </svg>
                            <span class="font-medium">Notifications</span>
                            <span id="notificationBadgeDesktop" class="hidden absolute -top-1 left-5 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center notification-dot">0</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showMessages()">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                                <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                            </svg>
                            <span class="font-medium">Messages</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showProfile()">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-medium">Profile</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showSettings()">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-medium">Settings</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="openBuzzModal()">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-medium">Create Buzz</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="logout()">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-medium">Logout</span>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Mobile Search Bar -->
            <div class="lg:hidden bg-white border-b border-gray-200 p-4">
                <input type="text" id="mobileSearchInput" placeholder="Search users..." class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" oninput="mobileSearchUsers()">
                <div id="mobileSearchResults" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                    <!-- Mobile search results will appear here -->
                </div>
            </div>

            <!-- Mobile Bottom Navigation -->
            <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
                <div class="flex justify-around py-2">
                    <button onclick="showHome()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                        <span class="text-xs">Home</span>
                    </button>
                    <button onclick="showNotifications()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500 relative">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                        </svg>
                        <span class="text-xs">Notifications</span>
                        <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center notification-dot">0</span>
                    </button>
                    <button onclick="showMessages()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                            <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                        </svg>
                        <span class="text-xs">Messages</span>
                    </button>
                    <button onclick="showProfile()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-xs">Profile</span>
                    </button>
                    <button onclick="openBuzzModal()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-xs">Create</span>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 lg:max-w-2xl">
                <!-- Home Feed -->
                <div id="homeFeed" class="p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Latest Buzz</h2>
                    <div id="buzzFeed" class="space-y-4 lg:space-y-6">
                        <!-- Buzz posts will be loaded here -->
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profilePage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <!-- Simple Profile Header -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                        <div class="flex flex-col items-center text-center">
                            <!-- Profile Picture -->
                            <img id="profileImage" class="w-24 h-24 rounded-full border-4 border-pink-300 mb-4" src="" alt="Profile">
                            
                            <!-- Name and Username -->
                            <div class="flex items-center space-x-2 mb-2">
                                <h2 id="profileName" class="text-xl font-bold text-gray-900"></h2>
                                <img id="profileVerified" src="https://community.oriontec.xyz/verify.png" alt="Verified" class="hidden verified-badge">
                            </div>
                            <p id="profileUsername" class="text-gray-600 mb-4"></p>
                            
                            <!-- Stats Row -->
                            <div class="flex space-x-8 mb-4">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-gray-900" id="postsCount">0</div>
                                    <div class="text-sm text-gray-600">Posts</div>
                                </div>
                                <div onclick="showFollowersPage('followers')" class="text-center cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors">
                                    <div class="text-lg font-bold text-gray-900" id="followersCount">0</div>
                                    <div class="text-sm text-gray-600">Followers</div>
                                </div>
                                <div onclick="showFollowersPage('following')" class="text-center cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors">
                                    <div class="text-lg font-bold text-gray-900" id="followingCount">0</div>
                                    <div class="text-sm text-gray-600">Following</div>
                                </div>
                            </div>
                            
                            <!-- Bio -->
                            <p id="profileBio" class="text-gray-700 mb-2"></p>
                            <p id="profileLocation" class="text-gray-500 text-sm mb-4">📍 <span id="locationText">Location not set</span></p>
                            
                            <!-- Action Buttons -->
                            <div class="flex space-x-3">
                                <button onclick="openEditProfile()" class="gradient-bg text-white px-6 py-2 rounded-full hover:opacity-90 transition-opacity text-sm font-medium">
                                    Edit Profile
                                </button>
                                <button onclick="openProfileSettings()" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-full hover:bg-gray-50 transition-colors text-sm font-medium">
                                    Settings
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4 mb-6">
                        <button id="buzzTab" onclick="showBuzzTab()" class="px-4 py-2 rounded-full bg-pink-500 text-white">Buzz</button>
                        <button id="repliesTab" onclick="showRepliesTab()" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700">Replies</button>
                        <button id="resharesTab" onclick="showResharesTab()" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700">Reshares</button>
                    </div>
                    <div id="userBuzzFeed" class="space-y-4 lg:space-y-6">
                        <!-- User's buzz posts will be loaded here -->
                    </div>
                    <div id="userRepliesFeed" class="hidden space-y-4 lg:space-y-6">
                        <!-- User's replies will be loaded here -->
                    </div>
                    <div id="userResharesFeed" class="hidden space-y-4 lg:space-y-6">
                        <!-- User's reshares will be loaded here -->
                    </div>
                </div>

                <!-- Notifications Page -->
                <div id="notificationsPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Notifications</h2>
                    <div id="notificationsFeed" class="space-y-4">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>

                <!-- Messages Page -->
                <div id="messagesPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Messages</h2>
                    
                    <!-- Conversations List -->
                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-lg mb-3">Conversations</h3>
                        <div id="conversationsList" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Chat Area -->
                    <div id="chatArea" class="hidden bg-white rounded-2xl shadow-lg">
                        <!-- Chat Header -->
                        <div class="flex items-center space-x-3 p-4 border-b border-gray-200">
                            <div class="relative">
                                <img id="chatUserImage" class="w-10 h-10 rounded-full border-2 border-pink-300" src="" alt="User">
                                <div id="chatUserOnlineIndicator" class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                            </div>
                            <div class="flex-1">
                                <h4 id="chatUserName" class="font-bold"></h4>
                                <p id="chatUserStatus" class="text-sm text-gray-500">Offline</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="startAudioCall()" class="p-2 text-gray-500 hover:text-green-500 transition-colors rounded-full hover:bg-gray-100" title="Audio Call">
                                    📞
                                </button>
                                <button onclick="startVideoCall()" class="p-2 text-gray-500 hover:text-blue-500 transition-colors rounded-full hover:bg-gray-100" title="Video Call">
                                    📹
                                </button>
                                <button onclick="shareProfile(currentChatUser)" class="p-2 text-gray-500 hover:text-pink-500 transition-colors rounded-full hover:bg-gray-100" title="Share Profile">
                                    🔗
                                </button>
                            </div>
                        </div>
                        
                        <!-- Messages Container -->
                        <div id="messagesContainer" class="p-4 space-y-3 max-h-80 overflow-y-auto">
                            <!-- Messages will appear here -->
                        </div>
                        
                        <!-- Typing Indicator -->
                        <div id="typingIndicator" class="hidden px-4 py-2 text-sm text-gray-500 italic">
                            <span id="typingUsername"></span> is typing...
                        </div>
                        
                        <!-- Message Input -->
                        <div class="p-4 border-t border-gray-200">
                            <div class="flex space-x-2">
                                <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" oninput="handleTyping()">
                                <button id="sendMessageBtn" class="gradient-bg text-white px-6 py-3 rounded-full hover:opacity-90 transition-opacity">
                                    <span class="hidden sm:inline">Send</span>
                                    <span class="sm:hidden">📤</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- No Chat Selected -->
                    <div id="noChatSelected" class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
                        <div class="text-6xl mb-4">💬</div>
                        <h3 class="text-xl font-bold mb-2">Select a conversation</h3>
                        <p>Choose a conversation to start messaging</p>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Settings</h2>
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Privacy Settings</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span>Private Account</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="privateAccount" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Show Online Status</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="showOnlineStatus" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Notification Settings</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span>Push Notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pushNotifications" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Email Notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="emailNotifications" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Verification</h3>
                            <div class="space-y-3">
                                <button onclick="openVerificationModal()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Get Verified</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Community Guidelines</h3>
                            <div class="space-y-3 text-sm text-gray-700">
                                <div class="p-4 bg-blue-50 rounded-xl">
                                    <h4 class="font-semibold text-blue-800 mb-2">Content Policy</h4>
                                    <ul class="space-y-1 text-blue-700">
                                        <li>• No hate speech, harassment, or bullying</li>
                                        <li>• No explicit sexual content or nudity</li>
                                        <li>• No spam or misleading information</li>
                                        <li>• No violence or threats</li>
                                        <li>• Respect intellectual property rights</li>
                                        <li>• Maximum 500 characters per buzz (except verified users)</li>
                                    </ul>
                                </div>
                                <div class="p-4 bg-yellow-50 rounded-xl">
                                    <h4 class="font-semibold text-yellow-800 mb-2">Prohibited Words</h4>
                                    <p class="text-yellow-700">Posts containing offensive language will be automatically removed and users will receive warnings.</p>
                                </div>
                                <div class="p-4 bg-red-50 rounded-xl">
                                    <h4 class="font-semibold text-red-800 mb-2">Consequences</h4>
                                    <ul class="space-y-1 text-red-700">
                                        <li>• First violation: Warning notification</li>
                                        <li>• Repeated violations: Temporary suspension</li>
                                        <li>• Severe violations: Permanent ban</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Privacy Policy</h3>
                            <div class="space-y-3 text-sm text-gray-700">
                                <div class="p-4 bg-gray-50 rounded-xl">
                                    <h4 class="font-semibold mb-2">Data Collection</h4>
                                    <p>We collect information you provide directly, usage data, and device information to improve our services.</p>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-xl">
                                    <h4 class="font-semibold mb-2">Data Usage</h4>
                                    <p>Your data is used to personalize content, improve features, and ensure platform security.</p>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-xl">
                                    <h4 class="font-semibold mb-2">Data Sharing</h4>
                                    <p>We don't sell your personal data. Information is only shared as necessary for service operation.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Account Actions</h3>
                            <div class="space-y-3">
                                <button onclick="exportData()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Export My Data</span>
                                </button>
                                <button onclick="openAccountSwitcher()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                                    </svg>
                                    <span>Switch Account</span>
                                </button>
                                <button onclick="logout()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Logout</span>
                                </button>
                                <button onclick="deactivateAccount()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl text-red-600 flex items-center space-x-3">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Deactivate Account</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Followers Page -->
                <div id="followersPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <button onclick="goBack()" class="text-pink-500 hover:text-pink-700">← Back</button>
                        <h2 id="followersTitle" class="text-xl lg:text-2xl font-bold gradient-text">Followers</h2>
                    </div>
                    <div class="flex space-x-4 mb-6">
                        <button id="followersTab" onclick="showFollowersTab()" class="px-4 py-2 rounded-full bg-pink-500 text-white">Followers</button>
                        <button id="followingTab" onclick="showFollowingTab()" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700">Following</button>
                    </div>
                    <div id="followersContent" class="space-y-4">
                        <!-- Followers/Following list will be loaded here -->
                    </div>
                </div>

                <!-- Hashtag Page -->
                <div id="hashtagPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <button onclick="goBackFromHashtag()" class="text-pink-500 hover:text-pink-700">← Back</button>
                        <div>
                            <h2 id="hashtagTitle" class="text-xl lg:text-2xl font-bold gradient-text">#hashtag</h2>
                            <p id="hashtagCount" class="text-sm text-gray-600">0 posts</p>
                        </div>
                    </div>
                    <div id="hashtagFeed" class="space-y-4 lg:space-y-6">
                        <!-- Hashtag posts will be loaded here -->
                    </div>
                </div>

                <!-- Other User Profile Page -->
                <div id="otherUserProfile" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <div class="bg-white rounded-2xl shadow-lg p-4 lg:p-8 mb-6">
                        <div class="flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-6">
                            <img id="otherProfileImage" class="w-20 h-20 lg:w-24 lg:h-24 rounded-full border-4 border-pink-300 mx-auto sm:mx-0" src="" alt="Profile">
                            <div class="flex-1 text-center sm:text-left">
                                <div class="flex items-center justify-center sm:justify-start space-x-2 mb-2">
                                    <h2 id="otherProfileName" class="text-xl lg:text-2xl font-bold"></h2>
                                    <img id="otherProfileVerified" src="https://community.oriontec.xyz/verify.png" alt="Verified" class="hidden verified-badge">
                                </div>
                                <p id="otherProfileUsername" class="text-gray-600 mb-2"></p>
                                <p id="otherProfileLocation" class="text-gray-500 text-sm mb-2">📍 <span id="otherLocationText">Location not set</span></p>
                                <p id="otherProfileBio" class="text-gray-700 mb-4"></p>
                                <div class="flex justify-center sm:justify-start space-x-4 mb-4">
                                    <span onclick="showOtherUserFollowersPage('following')" class="text-sm cursor-pointer hover:text-pink-500"><strong id="otherFollowingCount">0</strong> Following</span>
                                    <span onclick="showOtherUserFollowersPage('followers')" class="text-sm cursor-pointer hover:text-pink-500"><strong id="otherFollowersCount">0</strong> Followers</span>
                                </div>
                                <div class="flex justify-center sm:justify-start space-x-3">
                                    <button id="followBtn" onclick="toggleFollow()" class="gradient-bg text-white px-4 lg:px-6 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                                        Follow
                                    </button>
                                    <button onclick="startChatWithUser()" class="border border-pink-500 text-pink-500 px-4 lg:px-6 py-2 rounded-full hover:bg-pink-50 transition-colors text-sm lg:text-base">
                                        💬 Message
                                    </button>
                                    <button onclick="contactUser()" class="border border-gray-300 text-gray-700 px-4 lg:px-6 py-2 rounded-full hover:bg-gray-50 transition-colors text-sm lg:text-base">
                                        📞 Contact
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-lg lg:text-xl font-bold mb-4">Buzz Posts</h3>
                    <div id="otherUserBuzzFeed" class="space-y-4 lg:space-y-6">
                        <!-- Other user's buzz posts will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - Desktop & Tablet -->
            <div class="hidden md:block w-full md:w-80 bg-white h-screen sticky top-16 border-l border-gray-200 p-4 lg:p-6">
                <div class="mb-6">
                    <input type="text" id="searchInput" placeholder="Search users..." class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" oninput="searchUsers()">
                    <div id="searchResults" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                        <!-- Search results will appear here -->
                    </div>
                </div>
                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Verified Users</h3>
                    <div id="verifiedUsers" class="space-y-3">
                        <!-- Verified users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Buzz Modal -->
    <div id="buzzModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Create Buzz</h3>
                <button onclick="closeBuzzModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
            <div class="flex items-start space-x-3 lg:space-x-4 mb-4">
                <img id="modalUserImage" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300" src="" alt="User">
                <div class="flex-1 relative">
                    <textarea id="buzzContent" placeholder="What's buzzing? Use #hashtags and @mentions" class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" rows="4" oninput="handleBuzzInput()" maxlength="500"></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <div id="hashtagSuggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-xl shadow-lg max-h-40 overflow-y-auto z-10">
                            <!-- Hashtag suggestions will appear here -->
                        </div>
                        <div class="flex-1"></div>
                        <div id="characterCounter" class="text-sm text-gray-500 character-counter">0/500</div>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <button class="text-gray-400 cursor-not-allowed flex items-center space-x-2 text-sm lg:text-base" disabled>
                    <span>📷</span>
                    <span>Add Image - Coming Soon</span>
                </button>
            </div>
            <div class="flex justify-end">
                <button id="postBuzzBtn" onclick="postBuzz()" class="gradient-bg text-white px-6 lg:px-8 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    Post Buzz
                </button>
            </div>
        </div>
    </div>

    <!-- Simple Verification Modal -->
    <div id="verificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold flex items-center space-x-2">
                    <span>✅</span>
                    <span>Get Verified</span>
                </h3>
                <button onclick="closeVerificationModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Full Name *</label>
                    <input type="text" id="verifyName" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="Your full name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Age *</label>
                    <input type="number" id="verifyAge" min="13" max="100" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="Your age">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Category *</label>
                    <select id="verifyCategory" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <option value="">Select Category</option>
                        <option value="creator">Content Creator</option>
                        <option value="business">Business</option>
                        <option value="public_figure">Public Figure</option>
                        <option value="artist">Artist</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Website/Social Link *</label>
                    <input type="url" id="verifyLink" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="https://yourwebsite.com">
                    <p class="text-xs text-gray-500 mt-1">Link where your name/brand appears</p>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-xl">
                    <h4 class="font-medium text-blue-800 mb-2">Requirements:</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Must be 13+ years old</li>
                        <li>• Provide valid website/social link</li>
                        <li>• Your name must appear on the link</li>
                        <li>• Review takes 24-48 hours</li>
                    </ul>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="submitVerification()" class="gradient-bg text-white px-6 py-2 rounded-full hover:opacity-90 transition-opacity">
                    Submit Request
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Profile Settings</h3>
                <button onclick="closeProfileSettings()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Account Settings</h3>
                    <div class="space-y-3">
                        <button onclick="openEditProfile(); closeProfileSettings();" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl flex items-center space-x-3">
                            <span>✏️</span>
                            <span>Edit Profile</span>
                        </button>
                        <button onclick="openVerificationModal(); closeProfileSettings();" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl flex items-center space-x-3">
                            <span>✅</span>
                            <span>Get Verified</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Privacy Settings</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Private Account</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profilePrivateAccount" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Show Online Status</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profileShowOnlineStatus" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Notification Settings</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Push Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profilePushNotifications" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Email Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profileEmailNotifications" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Account Actions</h3>
                    <div class="space-y-3">
                        <button onclick="exportData()" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl flex items-center space-x-3">
                            <span>📥</span>
                            <span>Export My Data</span>
                        </button>
                        <button onclick="deactivateAccount()" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl text-red-600 flex items-center space-x-3">
                            <span>⚠️</span>
                            <span>Deactivate Account</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="saveProfileSettings()" class="gradient-bg text-white px-6 lg:px-8 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Comments</h3>
                <button onclick="closeCommentModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
            <div id="commentsContainer" class="space-y-4 mb-6 max-h-60 overflow-y-auto">
                <!-- Comments will be loaded here -->
            </div>
            <div class="flex items-start space-x-3">
                <img id="commentUserImage" class="w-8 h-8 rounded-full border-2 border-pink-300" src="" alt="User">
                <div class="flex-1">
                    <textarea id="commentContent" placeholder="Write a comment..." class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" rows="2"></textarea>
                    <div class="flex justify-end mt-2">
                        <button onclick="postComment()" class="gradient-bg text-white px-4 py-2 rounded-full hover:opacity-90 transition-opacity text-sm">
                            Post Comment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Report Buzz</h3>
                <button onclick="closeReportModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 text-sm">Why are you reporting this buzz?</p>
                <div class="space-y-3">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="spam" class="text-pink-500">
                        <span>Spam or misleading content</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="harassment" class="text-pink-500">
                        <span>Harassment or bullying</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="hate" class="text-pink-500">
                        <span>Hate speech or discrimination</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="violence" class="text-pink-500">
                        <span>Violence or threats</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="inappropriate" class="text-pink-500">
                        <span>Inappropriate content</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="copyright" class="text-pink-500">
                        <span>Copyright violation</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="other" class="text-pink-500">
                        <span>Other</span>
                    </label>
                </div>
                <textarea id="reportDetails" placeholder="Additional details (optional)" class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" rows="3"></textarea>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="submitReport()" class="bg-red-500 text-white px-6 py-2 rounded-full hover:bg-red-600 transition-colors text-sm">
                    Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Account Switcher Modal -->
    <div id="accountSwitcherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Switch Account</h3>
                <button onclick="closeAccountSwitcher()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
            <div id="savedAccountsList" class="space-y-3 mb-6">
                <!-- Saved accounts will be loaded here -->
            </div>
            <div class="border-t pt-4">
                <button onclick="addNewAccount()" class="w-full gradient-bg text-white px-6 py-3 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    ➕ Add New Account
                </button>
            </div>
        </div>
    </div>

    <!-- Call Modal -->
    <div id="callModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full text-center">
            <!-- Incoming Call -->
            <div id="incomingCall" class="hidden">
                <div class="mb-6">
                    <img id="incomingCallerImage" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-pink-300" src="" alt="Caller">
                    <h3 id="incomingCallerName" class="text-xl font-bold mb-2"></h3>
                    <p class="text-gray-600 mb-4">Incoming <span id="incomingCallType">audio</span> call...</p>
                    <div class="animate-pulse">
                        <div class="w-16 h-16 bg-green-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <span class="text-white text-2xl">📞</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center space-x-4">
                    <button onclick="acceptCall()" class="bg-green-500 text-white px-6 py-3 rounded-full hover:bg-green-600 transition-colors">
                        ✅ Accept
                    </button>
                    <button onclick="rejectCall()" class="bg-red-500 text-white px-6 py-3 rounded-full hover:bg-red-600 transition-colors">
                        ❌ Decline
                    </button>
                </div>
            </div>

            <!-- Outgoing Call -->
            <div id="outgoingCall" class="hidden">
                <div class="mb-6">
                    <img id="outgoingCallerImage" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-pink-300" src="" alt="Caller">
                    <h3 id="outgoingCallerName" class="text-xl font-bold mb-2"></h3>
                    <p class="text-gray-600 mb-4">Calling...</p>
                    <div class="animate-pulse">
                        <div class="w-16 h-16 bg-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <span class="text-white text-2xl" id="outgoingCallIcon">📞</span>
                        </div>
                    </div>
                </div>
                <button onclick="cancelCall()" class="bg-red-500 text-white px-6 py-3 rounded-full hover:bg-red-600 transition-colors">
                    ❌ Cancel
                </button>
            </div>

            <!-- Active Call -->
            <div id="activeCall" class="hidden">
                <div class="mb-6">
                    <img id="activeCallerImage" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-pink-300" src="" alt="Caller">
                    <h3 id="activeCallerName" class="text-xl font-bold mb-2"></h3>
                    <p class="text-green-600 mb-4">Connected - <span id="callDuration">00:00</span></p>
                    
                    <!-- Video Elements -->
                    <div id="videoContainer" class="hidden mb-4 relative">
                        <video id="remoteVideo" class="w-full h-64 bg-gray-900 rounded-xl object-cover" autoplay playsinline controls="false"></video>
                        <video id="localVideo" class="w-20 h-16 bg-gray-700 rounded-lg absolute top-2 right-2 object-cover border-2 border-white" autoplay playsinline muted controls="false"></video>
                    </div>
                    
                    <!-- Audio Element for Audio Calls -->
                    <audio id="remoteAudio" autoplay style="display: none;"></audio>
                </div>
                
                <div class="flex justify-center space-x-4">
                    <button id="muteBtn" onclick="toggleMute()" class="bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600 transition-colors">
                        🎤
                    </button>
                    <button id="videoBtn" onclick="toggleVideo()" class="hidden bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600 transition-colors">
                        📹
                    </button>
                    <button onclick="endCall()" class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600 transition-colors">
                        📞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Edit Profile</h3>
                <button onclick="closeEditProfile()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Display Name</label>
                    <input type="text" id="editDisplayName" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" placeholder="Your display name">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="editName" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" onchange="checkUsernameAvailability()" placeholder="username (no spaces)">
                    <p id="usernameStatus" class="text-xs mt-1"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bio</label>
                    <textarea id="editBio" class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Location</label>
                    <input type="text" id="editLocation" placeholder="Enter your location" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Website</label>
                    <input type="url" id="editWebsite" placeholder="https://yourwebsite.com" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Gender</label>
                    <select id="editGender" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer_not_to_say">Prefer not to say</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Contact (Email/Phone)</label>
                    <input type="text" id="editContact" placeholder="your@email.com or +1234567890" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base">
                    <p class="text-xs text-gray-500 mt-1">Add your email or phone for contact button</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Profile Photo</label>
                    <button class="w-full p-3 border border-gray-300 rounded-xl bg-gray-100 text-gray-400 text-sm cursor-not-allowed" disabled>
                        Coming Soon - Photo Upload
                    </button>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="updateProfile()" class="gradient-bg text-white px-6 lg:px-8 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "chat-d647c.firebaseapp.com",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: ". ",
            appId: "1:. :web:7248a0983dcf0d45a87418"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        let currentUser = null;
        let currentChatUser = null;
        let currentViewingUser = null;
        let lastPage = 'home';
        let currentFollowersUserId = null;
        let isNewUser = false;
        let selectedInterests = [];
        let bannedWords = ['pussy', 'dick', 'fuck', 'india', 'america', 'bitch', 'asshole', 'shit', 'damn', 'hell', 'bastard'];
        let specialUsers = ['gursharnarya07', 'dozera', 'oriontec', 'orionbuzz'];
        let unlimitedUsers = ['gursharnarya07', 'dozera', 'oriontec', 'orionbuzz'];
        let currentOnboardingStep = 1;

        // Authentication State Observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                checkUserStatus(user);
            } else {
                showLoginScreen();
                updateOnlineStatus(false);
            }
        });

        // Check if user is new or existing
        async function checkUserStatus(user) {
            const userRef = database.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');
            
            if (!snapshot.exists()) {
                isNewUser = true;
                showProfileSetupScreen();
            } else {
                const userData = snapshot.val();
                if (!userData.onboardingCompleted) {
                    isNewUser = true;
                    showInterestSelectionScreen();
                } else {
                    isNewUser = false;
                    showMainApp();
                    loadBuzzFeed();
                    loadVerifiedUsers();
                    updateOnlineStatus(true);
                    handleURLHash();
                }
            }
        }

        // Show Profile Setup Screen
        function showProfileSetupScreen() {
            hideAllScreens();
            document.getElementById('profileSetupScreen').classList.remove('hidden');
            
            // Pre-fill with Google data
            if (currentUser) {
                document.getElementById('onboardingDisplayName').value = currentUser.displayName || '';
            }
        }

        // Show Interest Selection Screen
        function showInterestSelectionScreen() {
            hideAllScreens();
            document.getElementById('interestSelectionScreen').classList.remove('hidden');
            loadInterestTags();
        }

        // Show User Suggestions Screen
        function showUserSuggestionsScreen() {
            hideAllScreens();
            document.getElementById('userSuggestionsScreen').classList.remove('hidden');
            loadSuggestedUsers();
        }

        // Hide all screens
        function hideAllScreens() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('profileSetupScreen').classList.add('hidden');
            document.getElementById('interestSelectionScreen').classList.add('hidden');
            document.getElementById('userSuggestionsScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Load Interest Tags
        function loadInterestTags() {
            const interests = [
                'Technology', 'Sports', 'Music', 'Movies', 'Food', 'Travel',
                'Fashion', 'Art', 'Gaming', 'Business', 'Health', 'Education',
                'Photography', 'Books', 'Science', 'Politics', 'Comedy', 'News'
            ];
            
            const interestTags = document.getElementById('interestTags');
            interestTags.innerHTML = '';
            
            interests.forEach(interest => {
                const tag = document.createElement('div');
                tag.className = 'interest-tag p-3 border-2 border-gray-300 rounded-xl text-center cursor-pointer hover:border-pink-500 transition-all';
                tag.textContent = interest;
                tag.onclick = () => toggleInterest(interest, tag);
                interestTags.appendChild(tag);
            });
        }

        // Toggle Interest Selection
        function toggleInterest(interest, element) {
            if (selectedInterests.includes(interest)) {
                selectedInterests = selectedInterests.filter(i => i !== interest);
                element.classList.remove('bg-pink-500', 'text-white', 'border-pink-500');
                element.classList.add('border-gray-300');
            } else {
                selectedInterests.push(interest);
                element.classList.add('bg-pink-500', 'text-white', 'border-pink-500');
                element.classList.remove('border-gray-300');
            }
        }

        // Load Suggested Users
        function loadSuggestedUsers() {
            const suggestedUsers = document.getElementById('suggestedUsers');
            suggestedUsers.innerHTML = '';
            
            // Load users based on interests or popular users
            database.ref('users').limitToFirst(10).once('value').then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.uid !== currentUser.uid) {
                        const userElement = createSuggestedUserElement(userData);
                        suggestedUsers.appendChild(userElement);
                    }
                });
            });
        }

        // Create Suggested User Element
        function createSuggestedUserElement(userData) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4';
            
            div.innerHTML = `
                <img class="w-12 h-12 rounded-full border-2 border-pink-300" src="${userData.photoURL}" alt="User">
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span class="font-bold">${userData.username}</span>
                        ${userData.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                    </div>
                    <p class="text-gray-600 text-sm">${userData.bio || 'OrioBuzz user'}</p>
                </div>
                <button onclick="followUserFromSuggestions('${userData.uid}', this)" class="gradient-bg text-white px-4 py-2 rounded-full hover:opacity-90 transition-opacity text-sm">
                    Follow
                </button>
            `;
            
            return div;
        }

        // Follow User from Suggestions
        function followUserFromSuggestions(userId, button) {
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            const followerRef = database.ref('followers/' + userId + '/' + currentUser.uid);
            
            followRef.set(true);
            followerRef.set(true);
            
            button.textContent = 'Following';
            button.classList.remove('gradient-bg');
            button.classList.add('bg-gray-500');
            
            // Create notification
            database.ref('users/' + currentUser.uid).once('value').then((userSnapshot) => {
                const userData = userSnapshot.val();
                createNotification(userId, 'follow', userData.username + ' started following you');
            });
        }

        // Complete Profile Setup
        async function completeProfileSetup() {
            const displayName = document.getElementById('onboardingDisplayName').value.trim();
            const username = document.getElementById('onboardingUsername').value.trim().toLowerCase();
            const bio = document.getElementById('onboardingBio').value.trim();
            const location = document.getElementById('onboardingLocation').value.trim();
            
            if (!displayName || !username) {
                alert('Display name and username are required');
                return;
            }
            
            // Check username availability
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
            if (usersSnapshot.exists()) {
                alert('Username already taken. Please choose a different one.');
                return;
            }
            
            // Save user data
            const userData = {
                uid: currentUser.uid,
                displayName: displayName,
                username: username,
                email: currentUser.email,
                photoURL: currentUser.photoURL || generateAvatar(displayName),
                bio: bio,
                location: location,
                verified: false,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                onboardingCompleted: false
            };
            
            await database.ref('users/' + currentUser.uid).set(userData);
            showInterestSelectionScreen();
        }

        // Complete Interest Selection
        async function completeInterestSelection() {
            if (selectedInterests.length === 0) {
                alert('Please select at least one interest');
                return;
            }
            
            // Save interests
            await database.ref('users/' + currentUser.uid + '/interests').set(selectedInterests);
            showUserSuggestionsScreen();
        }

        // Complete Onboarding
        async function completeOnboarding() {
            // Auto-follow @oriobuzz
            const oriobuzzSnapshot = await database.ref('users').orderByChild('username').equalTo('oriobuzz').once('value');
            if (oriobuzzSnapshot.exists()) {
                const oriobuzzData = oriobuzzSnapshot.val();
                const oriobuzzId = Object.keys(oriobuzzData)[0];
                
                await database.ref('following/' + currentUser.uid + '/' + oriobuzzId).set(true);
                await database.ref('followers/' + oriobuzzId + '/' + currentUser.uid).set(true);
            }
            
            // Mark onboarding as completed
            await database.ref('users/' + currentUser.uid).update({
                onboardingCompleted: true
            });
            
            // Send welcome message from @oriobuzz
            await sendWelcomeMessage();
            
            // Show main app
            showMainApp();
            loadBuzzFeed();
            loadVerifiedUsers();
            updateOnlineStatus(true);
        }

        // Send Welcome Message from @oriobuzz
        async function sendWelcomeMessage() {
            const oriobuzzSnapshot = await database.ref('users').orderByChild('username').equalTo('oriobuzz').once('value');
            if (oriobuzzSnapshot.exists()) {
                const oriobuzzData = oriobuzzSnapshot.val();
                const oriobuzzId = Object.keys(oriobuzzData)[0];
                
                const conversationId = [currentUser.uid, oriobuzzId].sort().join('_');
                const messageData = {
                    senderId: oriobuzzId,
                    receiverId: currentUser.uid,
                    senderName: 'oriobuzz',
                    senderImage: oriobuzzData[oriobuzzId].photoURL,
                    text: 'Welcome to OrioBuzz! 🎉 Thanks for joining our community. Start exploring and connect with amazing people!',
                    timestamp: Date.now(),
                    read: false,
                    isSystemMessage: true
                };
                
                await database.ref('messages/' + conversationId).push().set(messageData);
                
                // Update conversation
                const conversationData = {
                    participants: {
                        [currentUser.uid]: true,
                        [oriobuzzId]: true
                    },
                    lastMessage: messageData.text,
                    lastMessageTime: Date.now(),
                    lastMessageSender: oriobuzzId
                };
                
                await database.ref('conversations/' + conversationId).set(conversationData);
            }
        }

        // Check Onboarding Username
        async function checkOnboardingUsername() {
            const username = document.getElementById('onboardingUsername').value.trim().toLowerCase();
            const statusElement = document.getElementById('onboardingUsernameStatus');
            
            if (!username) {
                statusElement.textContent = '';
                return;
            }
            
            if (!/^[a-z0-9_]+$/.test(username)) {
                statusElement.textContent = 'Username can only contain lowercase letters, numbers, and underscores';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            if (username.length < 3) {
                statusElement.textContent = 'Username must be at least 3 characters long';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
            
            if (usersSnapshot.exists()) {
                statusElement.textContent = '❌ Username already taken';
                statusElement.className = 'text-xs mt-1 text-red-500';
            } else {
                statusElement.textContent = '✅ Username available';
                statusElement.className = 'text-xs mt-1 text-green-500';
            }
        }

        // Content Moderation
        function containsBannedWords(content) {
            const lowerContent = content.toLowerCase();
            return bannedWords.some(word => lowerContent.includes(word));
        }

        // Check Character Limit
        function checkCharacterLimit(content, username) {
            if (unlimitedUsers.includes(username)) {
                return true; // No limit for special users
            }
            return content.length <= 500;
        }

        // Simple verification - no complex fields needed

        // URL Hash Navigation
        function handleURLHash() {
            const hash = window.location.hash.substring(1);
            if (hash.startsWith('buzz')) {
                const buzzId = hash.replace('buzz', '');
                openBuzzFromURL(buzzId);
            } else if (hash.startsWith('profile')) {
                const userId = hash.replace('profile', '');
                viewUserProfile(userId);
            } else if (hash === 'home') {
                showHome();
            }
        }

        // Listen for hash changes
        window.addEventListener('hashchange', handleURLHash);

        // Open buzz from URL
        function openBuzzFromURL(buzzId) {
            database.ref('buzz/' + buzzId).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    showHome();
                    // Scroll to buzz after a short delay
                    setTimeout(() => {
                        const buzzElement = document.querySelector(`[data-buzz-id="${buzzId}"]`);
                        if (buzzElement) {
                            buzzElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            buzzElement.style.border = '2px solid #f093fb';
                            setTimeout(() => {
                                buzzElement.style.border = '';
                            }, 3000);
                        }
                    }, 500);
                }
            });
        }

        // Share Buzz
        function shareBuzz(buzzId) {
            const url = window.location.origin + window.location.pathname + '#buzz' + buzzId;
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this buzz on OrioBuzz',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Buzz link copied to clipboard!');
                });
            }
        }

        // Share Profile
        function shareProfile(userId) {
            const url = window.location.origin + window.location.pathname + '#profile' + userId;
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this profile on OrioBuzz',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Profile link copied to clipboard!');
                });
            }
        }

        // Online Status Management
        function updateOnlineStatus(isOnline) {
            if (!currentUser) return;
            
            const userStatusRef = database.ref('userStatus/' + currentUser.uid);
            if (isOnline) {
                userStatusRef.set({
                    online: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Set offline when user disconnects
                userStatusRef.onDisconnect().set({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                userStatusRef.set({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Get user online status
        function getUserOnlineStatus(userId, callback) {
            database.ref('userStatus/' + userId).on('value', (snapshot) => {
                const status = snapshot.val();
                callback(status);
            });
        }

        // Google Sign In
        document.getElementById('googleSignIn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                console.error('Sign in error:', error);
            });
        });

        // Generate unique random username
        async function generateRandomUsername() {
            const adjectives = ['Cool', 'Smart', 'Happy', 'Bright', 'Swift', 'Bold', 'Kind', 'Wise', 'Fun', 'Nice'];
            const nouns = ['User', 'Buzz', 'Star', 'Wave', 'Fire', 'Sky', 'Moon', 'Sun', 'Wind', 'Rock'];
            
            let username;
            let isUnique = false;
            let attempts = 0;
            
            while (!isUnique && attempts < 10) {
                const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
                const randomNum = Math.floor(Math.random() * 10000);
                username = (randomAdj + randomNoun + randomNum).toLowerCase();
                
                // Check if username already exists
                const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
                if (!usersSnapshot.exists()) {
                    isUnique = true;
                } else {
                    attempts++;
                }
            }
            
            return username;
        }

        // Extract hashtags from content
        function extractHashtags(content) {
            const hashtagRegex = /#(\w+)/g;
            const hashtags = [];
            let match;
            while ((match = hashtagRegex.exec(content)) !== null) {
                hashtags.push(match[1].toLowerCase());
            }
            return [...new Set(hashtags)]; // Remove duplicates
        }

        // Extract mentions from content
        function extractMentions(content) {
            const mentionRegex = /@(\w+)/g;
            const mentions = [];
            let match;
            while ((match = mentionRegex.exec(content)) !== null) {
                mentions.push(match[1].toLowerCase());
            }
            return [...new Set(mentions)]; // Remove duplicates
        }

        // Process content for display with clickable hashtags and mentions
        function processContentForDisplay(content) {
            // Make hashtags clickable (blue color)
            content = content.replace(/#(\w+)/g, '<span class="text-blue-500 cursor-pointer hover:text-blue-700 font-medium" onclick="showHashtagPage(\'$1\')">#$1</span>');
            
            // Make mentions clickable (blue color)
            content = content.replace(/@(\w+)/g, '<span class="text-blue-500 cursor-pointer hover:text-blue-700 font-medium" onclick="viewUserByUsername(\'$1\')">@$1</span>');
            
            return content;
        }

        // Show hashtag page
        function showHashtagPage(hashtag) {
            hideAllPages();
            document.getElementById('hashtagPage').classList.remove('hidden');
            document.getElementById('hashtagTitle').textContent = '#' + hashtag;
            
            // Load hashtag posts count
            database.ref('hashtags/' + hashtag.toLowerCase()).once('value').then((snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('hashtagCount').textContent = count + ' post' + (count !== 1 ? 's' : '');
            });
            
            loadHashtagPosts(hashtag.toLowerCase());
        }

        // Load hashtag posts
        function loadHashtagPosts(hashtag) {
            const hashtagPostsRef = database.ref('hashtagPosts/' + hashtag);
            hashtagPostsRef.once('value').then((snapshot) => {
                const hashtagFeed = document.getElementById('hashtagFeed');
                hashtagFeed.innerHTML = '';
                
                if (!snapshot.exists()) {
                    hashtagFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No posts found for this hashtag</p>';
                    return;
                }
                
                const buzzIds = Object.keys(snapshot.val());
                const buzzPromises = buzzIds.map(buzzId => 
                    database.ref('buzz/' + buzzId).once('value')
                );
                
                Promise.all(buzzPromises).then((buzzSnapshots) => {
                    const buzzes = buzzSnapshots
                        .map(snapshot => snapshot.val())
                        .filter(buzz => buzz !== null)
                        .sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (buzzes.length === 0) {
                        hashtagFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No posts found for this hashtag</p>';
                        return;
                    }
                    
                    buzzes.forEach((buzz) => {
                        const buzzElement = createBuzzElement(buzz);
                        hashtagFeed.appendChild(buzzElement);
                    });
                });
            });
        }

        // View user by username
        async function viewUserByUsername(username) {
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username.toLowerCase()).once('value');
            
            if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                const userId = Object.keys(users)[0];
                viewUserProfile(userId);
            } else {
                alert('User not found');
            }
        }

        // Go back from hashtag page
        function goBackFromHashtag() {
            showHome();
        }

        // Remove mention from buzz
        async function removeMention(buzzId) {
            if (!currentUser) return;
            
            if (confirm('Remove your mention from this buzz?')) {
                const buzzRef = database.ref('buzz/' + buzzId);
                const buzzSnapshot = await buzzRef.once('value');
                const buzzData = buzzSnapshot.val();
                
                if (buzzData && buzzData.mentions) {
                    // Remove current user's username from mentions array
                    const updatedMentions = buzzData.mentions.filter(mention => mention !== currentUser.username);
                    
                    // Update content to remove the mention
                    let updatedContent = buzzData.originalContent || buzzData.content;
                    const mentionRegex = new RegExp(`@${currentUser.username}\\b`, 'gi');
                    updatedContent = updatedContent.replace(mentionRegex, '');
                    
                    // Process content for display again
                    const processedContent = processContentForDisplay(updatedContent);
                    
                    // Update the buzz
                    await buzzRef.update({
                        mentions: updatedMentions,
                        content: processedContent,
                        originalContent: updatedContent
                    });
                    
                    // Reload the feed
                    loadBuzzFeed();
                    
                    alert('Your mention has been removed from this buzz');
                }
            }
        }

        // Generate colorful avatar with initials
        function generateAvatar(name) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'];
            const initial = name ? name.charAt(0).toUpperCase() : 'U';
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            // Draw circle background
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(50, 50, 50, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw initial
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initial, 50, 50);
            
            return canvas.toDataURL();
        }

        // Save user to database
        async function saveUserToDatabase(user) {
            const userRef = database.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');
            
            if (!snapshot.exists()) {
                const displayName = user.displayName || await generateRandomUsername();
                const username = await generateRandomUsername();
                const photoURL = user.photoURL || generateAvatar(displayName);
                
                await userRef.set({
                    uid: user.uid,
                    displayName: displayName,
                    username: username,
                    email: user.email,
                    photoURL: photoURL,
                    bio: '',
                    verified: false,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                // Update existing user if they don't have a photo or display name
                const userData = snapshot.val();
                const updates = {};
                
                if (!userData.photoURL || userData.photoURL === '') {
                    updates.photoURL = generateAvatar(userData.displayName || userData.username);
                }
                
                if (!userData.displayName) {
                    updates.displayName = userData.username;
                }
                
                if (Object.keys(updates).length > 0) {
                    await userRef.update(updates);
                }
            }
        }

        // Show/Hide Screens
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateTopBar();
        }

        function updateTopBar() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('topBarUserImage').src = userData.photoURL;
                        document.getElementById('topBarUsername').textContent = userData.displayName || userData.username;
                        document.getElementById('modalUserImage').src = userData.photoURL;
                    }
                });
            }
        }

        // Search Users
        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then((snapshot) => {
                searchResults.innerHTML = '';
                let hasResults = false;
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    if (user.uid !== currentUser.uid && 
                        (user.username.toLowerCase().includes(searchTerm) || 
                         user.email.toLowerCase().includes(searchTerm))) {
                        
                        hasResults = true;
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-3 p-3 hover:bg-gray-100 cursor-pointer';
                        userDiv.onclick = () => {
                            viewUserProfile(user.uid);
                            searchResults.classList.add('hidden');
                            document.getElementById('searchInput').value = '';
                        };
                        
                        userDiv.innerHTML = `
                            <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${user.photoURL}" alt="User">
                            <div class="flex-1">
                                <div class="flex items-center space-x-1">
                                    <span class="font-medium text-sm">${user.username}</span>
                                    ${user.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                                </div>
                                <p class="text-xs text-gray-600">${user.bio || 'OrioBuzz user'}</p>
                            </div>
                        `;
                        searchResults.appendChild(userDiv);
                    }
                });
                
                if (!hasResults) {
                    searchResults.innerHTML = '<p class="p-3 text-gray-500 text-sm">No users found</p>';
                }
                
                searchResults.classList.remove('hidden');
            });
        }

        // Mobile Search Users
        function mobileSearchUsers() {
            const searchTerm = document.getElementById('mobileSearchInput').value.trim().toLowerCase();
            const searchResults = document.getElementById('mobileSearchResults');
            
            if (searchTerm.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then((snapshot) => {
                searchResults.innerHTML = '';
                let hasResults = false;
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    if (user.uid !== currentUser.uid && 
                        (user.username.toLowerCase().includes(searchTerm) || 
                         user.email.toLowerCase().includes(searchTerm))) {
                        
                        hasResults = true;
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-3 p-3 hover:bg-gray-100 cursor-pointer';
                        userDiv.onclick = () => {
                            viewUserProfile(user.uid);
                            searchResults.classList.add('hidden');
                            document.getElementById('mobileSearchInput').value = '';
                        };
                        
                        userDiv.innerHTML = `
                            <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${user.photoURL}" alt="User">
                            <div class="flex-1">
                                <div class="flex items-center space-x-1">
                                    <span class="font-medium text-sm">${user.username}</span>
                                    ${user.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                                </div>
                                <p class="text-xs text-gray-600">${user.bio || 'OrioBuzz user'}</p>
                            </div>
                        `;
                        searchResults.appendChild(userDiv);
                    }
                });
                
                if (!hasResults) {
                    searchResults.innerHTML = '<p class="p-3 text-gray-500 text-sm">No users found</p>';
                }
                
                searchResults.classList.remove('hidden');
            });
        }

        // Hide search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            const mobileSearchResults = document.getElementById('mobileSearchResults');
            
            if (searchInput && searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
            
            if (mobileSearchInput && mobileSearchResults && !mobileSearchInput.contains(e.target) && !mobileSearchResults.contains(e.target)) {
                mobileSearchResults.classList.add('hidden');
            }
        });

        // Navigation
        function showHome() {
            hideAllPages();
            document.getElementById('homeFeed').classList.remove('hidden');
            loadBuzzFeed();
        }

        function showProfile() {
            hideAllPages();
            document.getElementById('profilePage').classList.remove('hidden');
            loadUserProfile();
            loadUserBuzz();
        }

        function showNotifications() {
            hideAllPages();
            document.getElementById('notificationsPage').classList.remove('hidden');
            loadNotifications();
            clearNotificationBadge();
        }

        // Removed duplicate showMessages function - using the one with message input initialization

        function showSettings() {
            hideAllPages();
            document.getElementById('settingsPage').classList.remove('hidden');
            loadSettings();
        }

        function hideAllPages() {
            document.getElementById('homeFeed').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
            document.getElementById('notificationsPage').classList.add('hidden');
            document.getElementById('messagesPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            document.getElementById('otherUserProfile').classList.add('hidden');
            document.getElementById('followersPage').classList.add('hidden');
            document.getElementById('hashtagPage').classList.add('hidden');
        }

        // Followers Page Functions
        function showFollowersPage(type) {
            lastPage = 'profile';
            currentFollowersUserId = currentUser.uid;
            hideAllPages();
            document.getElementById('followersPage').classList.remove('hidden');
            document.getElementById('followersTitle').textContent = type === 'followers' ? 'Followers' : 'Following';
            
            if (type === 'followers') {
                showFollowersTab();
            } else {
                showFollowingTab();
            }
        }

        function showOtherUserFollowersPage(type) {
            lastPage = 'otherProfile';
            currentFollowersUserId = currentViewingUser;
            hideAllPages();
            document.getElementById('followersPage').classList.remove('hidden');
            document.getElementById('followersTitle').textContent = type === 'followers' ? 'Followers' : 'Following';
            
            if (type === 'followers') {
                showFollowersTab();
            } else {
                showFollowingTab();
            }
        }

        function showFollowersTab() {
            document.getElementById('followersTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('followingTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            loadFollowersList('followers');
        }

        function showFollowingTab() {
            document.getElementById('followingTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('followersTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            loadFollowersList('following');
        }

        function loadFollowersList(type) {
            if (!currentFollowersUserId) return;
            
            const ref = database.ref(type + '/' + currentFollowersUserId);
            ref.once('value').then((snapshot) => {
                const followersContent = document.getElementById('followersContent');
                followersContent.innerHTML = '';
                
                if (!snapshot.exists()) {
                    followersContent.innerHTML = `<p class="text-gray-500 text-center py-8">No ${type} yet</p>`;
                    return;
                }
                
                const userIds = Object.keys(snapshot.val());
                userIds.forEach(userId => {
                    database.ref('users/' + userId).once('value').then((userSnapshot) => {
                        const userData = userSnapshot.val();
                        if (userData) {
                            const userElement = createFollowerElement(userData);
                            followersContent.appendChild(userElement);
                        }
                    });
                });
            });
        }

        function createFollowerElement(userData) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4';
            
            div.innerHTML = `
                <img class="w-12 h-12 rounded-full border-2 border-pink-300" src="${userData.photoURL}" alt="User">
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span onclick="viewUserProfile('${userData.uid}')" class="font-bold cursor-pointer hover:text-pink-500">${userData.username}</span>
                        ${userData.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                    </div>
                    <p class="text-gray-600 text-sm">${userData.bio || 'OrioBuzz user'}</p>
                </div>
                ${userData.uid !== currentUser.uid ? `
                    <button onclick="toggleFollowFromList('${userData.uid}', this)" class="px-4 py-2 rounded-full text-sm transition-colors" id="followBtn-${userData.uid}">
                        Follow
                    </button>
                ` : ''}
            `;
            
            // Check follow status
            if (userData.uid !== currentUser.uid) {
                checkFollowStatusForButton(userData.uid);
            }
            
            return div;
        }

        function checkFollowStatusForButton(userId) {
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            followRef.once('value').then((snapshot) => {
                const followBtn = document.getElementById('followBtn-' + userId);
                if (followBtn) {
                    if (snapshot.exists()) {
                        followBtn.textContent = 'Following';
                        followBtn.className = 'px-4 py-2 rounded-full text-sm bg-gray-500 text-white transition-colors';
                    } else {
                        followBtn.textContent = 'Follow';
                        followBtn.className = 'px-4 py-2 rounded-full text-sm gradient-bg text-white transition-colors';
                    }
                }
            });
        }

        function toggleFollowFromList(userId, button) {
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            const followerRef = database.ref('followers/' + userId + '/' + currentUser.uid);
            
            followRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Unfollow
                    followRef.remove();
                    followerRef.remove();
                    button.textContent = 'Follow';
                    button.className = 'px-4 py-2 rounded-full text-sm gradient-bg text-white transition-colors';
                } else {
                    // Follow
                    followRef.set(true);
                    followerRef.set(true);
                    button.textContent = 'Following';
                    button.className = 'px-4 py-2 rounded-full text-sm bg-gray-500 text-white transition-colors';
                    
                    // Create notification
                    database.ref('users/' + currentUser.uid).once('value').then((userSnapshot) => {
                        const userData = userSnapshot.val();
                        createNotification(userId, 'follow', userData.username + ' started following you');
                    });
                }
            });
        }

        function goBack() {
            if (lastPage === 'profile') {
                showProfile();
            } else if (lastPage === 'otherProfile') {
                viewUserProfile(currentViewingUser);
            } else {
                showHome();
            }
        }

        // Load user profile
        function loadUserProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('profileImage').src = userData.photoURL;
                    document.getElementById('profileName').textContent = userData.displayName || userData.username;
                    document.getElementById('profileUsername').textContent = '@' + userData.username;
                    document.getElementById('profileBio').textContent = userData.bio || 'No bio yet';
                    document.getElementById('locationText').textContent = userData.location || 'Location not set';
                    
                    // Load follower counts
                    loadFollowerCounts(currentUser.uid);
                    
                    if (userData.verified) {
                        document.getElementById('profileVerified').classList.remove('hidden');
                    } else {
                        document.getElementById('profileVerified').classList.add('hidden');
                    }
                }
            });
        }

        // Load follower counts
        function loadFollowerCounts(userId) {
            const followersRef = database.ref('followers/' + userId);
            const followingRef = database.ref('following/' + userId);
            
            followersRef.once('value').then((snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                document.getElementById('followersCount').textContent = count;
                if (document.getElementById('otherFollowersCount')) {
                    document.getElementById('otherFollowersCount').textContent = count;
                }
            });
            
            followingRef.once('value').then((snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                document.getElementById('followingCount').textContent = count;
                if (document.getElementById('otherFollowingCount')) {
                    document.getElementById('otherFollowingCount').textContent = count;
                }
            });
        }

        // Buzz Modal Functions
        function openBuzzModal() {
            document.getElementById('buzzModal').classList.remove('hidden');
        }

        function closeBuzzModal() {
            document.getElementById('buzzModal').classList.add('hidden');
            document.getElementById('buzzContent').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
        }

        // Post Buzz
        async function postBuzz() {
            const content = document.getElementById('buzzContent').value.trim();
            
            if (!content) return;

            const buzzId = database.ref('buzz').push().key;

            // Get user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();

            // Extract hashtags and mentions
            const hashtags = extractHashtags(content);
            const mentions = extractMentions(content);

            // Create buzz object
            const buzzData = {
                buzzId: buzzId,
                uid: currentUser.uid,
                username: userData.username,
                displayName: userData.displayName || userData.username,
                userImage: userData.photoURL,
                verified: userData.verified || false,
                content: processContentForDisplay(content),
                originalContent: content,
                hashtags: hashtags,
                mentions: mentions,
                imageURL: null,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: {},
                rebuzzes: {}
            };

            // Save to database
            database.ref('buzz/' + buzzId).set(buzzData).then(() => {
                // Save hashtags to hashtags collection
                hashtags.forEach(hashtag => {
                    const hashtagRef = database.ref('hashtags/' + hashtag);
                    hashtagRef.transaction((currentCount) => {
                        return (currentCount || 0) + 1;
                    });
                    
                    // Add buzz to hashtag posts
                    database.ref('hashtagPosts/' + hashtag + '/' + buzzId).set(true);
                });

                // Create notifications for mentions
                mentions.forEach(async (mention) => {
                    const mentionedUserSnapshot = await database.ref('users').orderByChild('username').equalTo(mention).once('value');
                    if (mentionedUserSnapshot.exists()) {
                        const mentionedUsers = mentionedUserSnapshot.val();
                        Object.keys(mentionedUsers).forEach(userId => {
                            if (userId !== currentUser.uid) {
                                createNotification(userId, 'mention', `${userData.displayName || userData.username} mentioned you in a buzz`);
                            }
                        });
                    }
                });

                closeBuzzModal();
                loadBuzzFeed();
            });
        }

        // Load Buzz Feed with Smart Algorithm
        function loadBuzzFeed() {
            const buzzRef = database.ref('buzz').orderByChild('timestamp');
            buzzRef.off(); // Remove previous listeners to prevent duplicates
            
            buzzRef.on('value', (snapshot) => {
                const buzzFeed = document.getElementById('buzzFeed');
                const existingBuzzIds = new Set();
                
                // Get existing buzz IDs to prevent duplicates
                const existingBuzzes = buzzFeed.querySelectorAll('[data-buzz-id]');
                existingBuzzes.forEach(element => {
                    existingBuzzIds.add(element.getAttribute('data-buzz-id'));
                });
                
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz && !existingBuzzIds.has(buzz.buzzId)) {
                        buzzes.push(buzz);
                    }
                });
                
                // Only update if there are new buzzes or if feed is empty
                if (buzzes.length > 0 || buzzFeed.children.length === 0) {
                    if (buzzFeed.children.length === 0) {
                        // First load - show all buzzes
                        const allBuzzes = [];
                        snapshot.forEach((childSnapshot) => {
                            allBuzzes.push(childSnapshot.val());
                        });
                        
                        applySmartFeedAlgorithm(allBuzzes).then(sortedBuzzes => {
                            buzzFeed.innerHTML = '';
                            sortedBuzzes.forEach((buzz) => {
                                const buzzElement = createBuzzElement(buzz);
                                buzzFeed.appendChild(buzzElement);
                            });
                        });
                    } else {
                        // Add new buzzes to top
                        applySmartFeedAlgorithm(buzzes).then(sortedBuzzes => {
                            sortedBuzzes.reverse().forEach((buzz) => {
                                const buzzElement = createBuzzElement(buzz);
                                buzzFeed.insertBefore(buzzElement, buzzFeed.firstChild);
                            });
                        });
                    }
                }
            });
        }

        // Smart Feed Algorithm
        async function applySmartFeedAlgorithm(buzzes) {
            if (!currentUser) return buzzes.reverse();
            
            // Get user's following list
            const followingSnapshot = await database.ref('following/' + currentUser.uid).once('value');
            const following = followingSnapshot.exists() ? Object.keys(followingSnapshot.val()) : [];
            
            // Get user's interactions (likes, comments, rebuzzes)
            const userInteractions = await getUserInteractions();
            
            // Score each buzz
            const scoredBuzzes = buzzes.map(buzz => {
                let score = 0;
                const buzzAge = Date.now() - buzz.timestamp;
                
                // Base score from timestamp (newer = higher)
                score += Math.max(0, 1000 - (buzzAge / 3600000)); // Decrease over hours
                
                // Following boost (highest priority)
                if (following.includes(buzz.uid)) {
                    score += 5000;
                }
                
                // Interaction history boost
                if (userInteractions.likedUsers.includes(buzz.uid)) {
                    score += 2000;
                }
                if (userInteractions.commentedUsers.includes(buzz.uid)) {
                    score += 2500;
                }
                if (userInteractions.rebuzzedUsers.includes(buzz.uid)) {
                    score += 2200;
                }
                
                // Engagement boost
                const likesCount = buzz.likes ? Object.keys(buzz.likes).length : 0;
                const rebuzzesCount = buzz.rebuzzes ? Object.keys(buzz.rebuzzes).length : 0;
                const commentsCount = buzz.comments ? Object.keys(buzz.comments).length : 0;
                
                score += likesCount * 10;
                score += rebuzzesCount * 15;
                score += commentsCount * 20;
                
                // Verified user boost
                if (buzz.verified) {
                    score += 500;
                }
                
                return { ...buzz, score };
            });
            
            // Sort by score (highest first)
            return scoredBuzzes.sort((a, b) => b.score - a.score);
        }

        // Get User Interactions
        async function getUserInteractions() {
            const interactions = {
                likedUsers: [],
                commentedUsers: [],
                rebuzzedUsers: []
            };
            
            // Get all buzzes and check user's interactions
            const buzzSnapshot = await database.ref('buzz').once('value');
            buzzSnapshot.forEach(childSnapshot => {
                const buzz = childSnapshot.val();
                
                if (buzz.likes && buzz.likes[currentUser.uid]) {
                    if (!interactions.likedUsers.includes(buzz.uid)) {
                        interactions.likedUsers.push(buzz.uid);
                    }
                }
                
                if (buzz.rebuzzes && buzz.rebuzzes[currentUser.uid]) {
                    if (!interactions.rebuzzedUsers.includes(buzz.uid)) {
                        interactions.rebuzzedUsers.push(buzz.uid);
                    }
                }
                
                if (buzz.comments) {
                    Object.values(buzz.comments).forEach(comment => {
                        if (comment.uid === currentUser.uid && !interactions.commentedUsers.includes(buzz.uid)) {
                            interactions.commentedUsers.push(buzz.uid);
                        }
                    });
                }
            });
            
            return interactions;
        }

        // Profile Tab Functions
        function showBuzzTab() {
            document.getElementById('buzzTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('repliesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('resharesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            
            document.getElementById('userBuzzFeed').classList.remove('hidden');
            document.getElementById('userRepliesFeed').classList.add('hidden');
            document.getElementById('userResharesFeed').classList.add('hidden');
        }

        function showRepliesTab() {
            document.getElementById('repliesTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('buzzTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('resharesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            
            document.getElementById('userBuzzFeed').classList.add('hidden');
            document.getElementById('userRepliesFeed').classList.remove('hidden');
            document.getElementById('userResharesFeed').classList.add('hidden');
            
            loadUserReplies();
        }

        function showResharesTab() {
            document.getElementById('resharesTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('buzzTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('repliesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            
            document.getElementById('userBuzzFeed').classList.add('hidden');
            document.getElementById('userRepliesFeed').classList.add('hidden');
            document.getElementById('userResharesFeed').classList.remove('hidden');
            
            loadUserReshares();
        }

        // Load User Buzz
        function loadUserBuzz() {
            if (!currentUser) return;
            
            const buzzRef = database.ref('buzz').orderByChild('uid').equalTo(currentUser.uid);
            buzzRef.on('value', (snapshot) => {
                const userBuzzFeed = document.getElementById('userBuzzFeed');
                userBuzzFeed.innerHTML = '';
                
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.push(childSnapshot.val());
                });
                
                buzzes.reverse().forEach((buzz) => {
                    const buzzElement = createBuzzElement(buzz);
                    userBuzzFeed.appendChild(buzzElement);
                });
            });
        }

        // Load User Replies
        function loadUserReplies() {
            if (!currentUser) return;
            
            const buzzRef = database.ref('buzz');
            buzzRef.on('value', (snapshot) => {
                const userRepliesFeed = document.getElementById('userRepliesFeed');
                userRepliesFeed.innerHTML = '';
                
                const userReplies = [];
                
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.comments) {
                        Object.values(buzz.comments).forEach(comment => {
                            if (comment.uid === currentUser.uid) {
                                userReplies.push({
                                    ...buzz,
                                    userComment: comment,
                                    isReply: true
                                });
                            }
                        });
                    }
                });
                
                // Sort by comment timestamp
                userReplies.sort((a, b) => b.userComment.timestamp - a.userComment.timestamp);
                
                if (userReplies.length === 0) {
                    userRepliesFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No replies yet</p>';
                    return;
                }
                
                userReplies.forEach((reply) => {
                    const replyElement = createReplyElement(reply);
                    userRepliesFeed.appendChild(replyElement);
                });
            });
        }

        // Load User Reshares
        function loadUserReshares() {
            if (!currentUser) return;
            
            const buzzRef = database.ref('buzz');
            buzzRef.on('value', (snapshot) => {
                const userResharesFeed = document.getElementById('userResharesFeed');
                userResharesFeed.innerHTML = '';
                
                const userReshares = [];
                
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.rebuzzes && buzz.rebuzzes[currentUser.uid]) {
                        userReshares.push({
                            ...buzz,
                            isReshare: true
                        });
                    }
                });
                
                // Sort by timestamp
                userReshares.sort((a, b) => b.timestamp - a.timestamp);
                
                if (userReshares.length === 0) {
                    userResharesFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No reshares yet</p>';
                    return;
                }
                
                userReshares.forEach((reshare) => {
                    const reshareElement = createReshareElement(reshare);
                    userResharesFeed.appendChild(reshareElement);
                });
            });
        }

        // Create Reply Element
        function createReplyElement(reply) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl shadow-lg p-4 lg:p-6 border-l-4 border-blue-500';
            
            div.innerHTML = `
                <div class="mb-3">
                    <span class="text-sm text-blue-600 font-medium">💬 You replied to</span>
                </div>
                <div class="flex items-start space-x-3 lg:space-x-4 mb-4">
                    <img class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300 flex-shrink-0" src="${reply.userImage}" alt="User">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2 flex-wrap">
                            <span class="font-bold text-sm lg:text-base truncate">${reply.username}</span>
                            ${reply.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">' : ''}
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">${formatTimestamp(reply.timestamp)}</span>
                        </div>
                        <p class="text-gray-800 text-sm lg:text-base break-words">${reply.content}</p>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-xl p-3 ml-8">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="font-medium text-sm">Your reply:</span>
                        <span class="text-gray-500 text-xs">${formatTimestamp(reply.userComment.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-800">${reply.userComment.content}</p>
                </div>
            `;
            
            return div;
        }

        // Create Reshare Element
        function createReshareElement(reshare) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl shadow-lg p-4 lg:p-6 border-l-4 border-green-500';
            
            div.innerHTML = `
                <div class="mb-3">
                    <span class="text-sm text-green-600 font-medium">🔁 You reshared</span>
                </div>
                <div class="flex items-start space-x-3 lg:space-x-4">
                    <img class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300 flex-shrink-0" src="${reshare.userImage}" alt="User">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2 flex-wrap">
                            <span class="font-bold text-sm lg:text-base truncate">${reshare.username}</span>
                            ${reshare.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">' : ''}
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">${formatTimestamp(reshare.timestamp)}</span>
                        </div>
                        <p class="text-gray-800 mb-3 text-sm lg:text-base break-words">${reshare.content}</p>
                        ${reshare.imageURL ? `<img class="w-full max-w-md rounded-xl mb-3" src="${reshare.imageURL}" alt="Buzz image">` : ''}
                    </div>
                </div>
            `;
            
            return div;
        }

        // Create Buzz Element
        function createBuzzElement(buzz) {
            const div = document.createElement('div');
            div.className = 'buzz-card bg-white rounded-2xl shadow-lg p-4 lg:p-6';
            div.setAttribute('data-buzz-id', buzz.buzzId);
            
            const likesCount = buzz.likes ? Object.keys(buzz.likes).length : 0;
            const rebuzzesCount = buzz.rebuzzes ? Object.keys(buzz.rebuzzes).length : 0;
            const isLiked = buzz.likes && currentUser && buzz.likes[currentUser.uid];
            const isRebuzzed = buzz.rebuzzes && currentUser && buzz.rebuzzes[currentUser.uid];
            
            div.innerHTML = `
                <div class="flex items-start space-x-3 lg:space-x-4">
                    <div class="relative">
                        <img class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300 flex-shrink-0" src="${buzz.userImage}" alt="User">
                        <div id="onlineIndicator-${buzz.uid}" class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2 flex-wrap">
                            <span onclick="viewUserProfile('${buzz.uid}')" class="font-bold text-sm lg:text-base truncate cursor-pointer hover:text-pink-500 transition-colors">${buzz.displayName || buzz.username}</span>
                            ${buzz.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">' : ''}
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">@${buzz.username}</span>
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">${formatTimestamp(buzz.timestamp)}</span>
                        </div>
                        <p class="text-gray-800 mb-3 text-sm lg:text-base break-words">${buzz.content}</p>
                        ${buzz.mentions && buzz.mentions.includes(currentUser.username) ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 mb-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-yellow-800">You were mentioned in this buzz</span>
                                    <button onclick="removeMention('${buzz.buzzId}')" class="text-xs text-red-600 hover:text-red-800">Remove mention</button>
                                </div>
                            </div>
                        ` : ''}
                        ${buzz.imageURL ? `<img class="w-full max-w-md rounded-xl mb-3" src="${buzz.imageURL}" alt="Buzz image">` : ''}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4 lg:space-x-6">
                                <button onclick="toggleLike('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 ${isLiked ? 'text-red-500' : 'text-gray-500'} hover:text-red-500 transition-colors text-sm lg:text-base">
                                    <span>${isLiked ? '❤️' : '🤍'}</span>
                                    <span id="likes-${buzz.buzzId}">${likesCount}</span>
                                </button>
                                <button onclick="toggleRebuzz('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 ${isRebuzzed ? 'text-green-500' : 'text-gray-500'} hover:text-green-500 transition-colors text-sm lg:text-base">
                                    <span>🔁</span>
                                    <span id="rebuzzes-${buzz.buzzId}">${rebuzzesCount}</span>
                                </button>
                                <button onclick="openCommentModal('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 text-gray-500 hover:text-blue-500 transition-colors text-sm lg:text-base">
                                    <span>💬</span>
                                    <span id="comments-${buzz.buzzId}">${buzz.comments ? Object.keys(buzz.comments).length : 0}</span>
                                </button>
                                <button onclick="shareBuzz('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 text-gray-500 hover:text-purple-500 transition-colors text-sm lg:text-base">
                                    <span>🔗</span>
                                    <span class="hidden sm:inline">Share</span>
                                </button>
                                <button onclick="openReportModal('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 text-gray-500 hover:text-red-500 transition-colors text-sm lg:text-base">
                                    <span>🚨</span>
                                    <span class="hidden sm:inline">Report</span>
                                </button>
                            </div>
                            ${buzz.uid === currentUser.uid ? `<button onclick="deleteBuzz('${buzz.buzzId}')" class="text-red-500 hover:text-red-700 transition-colors text-sm lg:text-base">🗑️</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Update online status for this user
            getUserOnlineStatus(buzz.uid, (status) => {
                updateUserOnlineIndicator(buzz.uid, status);
            });
            
            return div;
        }

        // Toggle Like
        function toggleLike(buzzId) {
            if (!currentUser) return;
            
            const likeRef = database.ref(`buzz/${buzzId}/likes/${currentUser.uid}`);
            const likesElement = document.getElementById(`likes-${buzzId}`);
            const likeButton = document.querySelector(`[onclick="toggleLike('${buzzId}')"]`);
            
            likeRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Unlike
                    likeRef.remove().then(() => {
                        // Update UI immediately
                        if (likeButton) {
                            likeButton.innerHTML = '<span>🤍</span> <span id="likes-' + buzzId + '">' + (parseInt(likesElement.textContent) - 1) + '</span>';
                            likeButton.className = likeButton.className.replace('text-red-500', 'text-gray-500');
                        }
                    });
                } else {
                    // Like
                    likeRef.set(true).then(() => {
                        // Update UI immediately
                        if (likeButton) {
                            likeButton.innerHTML = '<span>❤️</span> <span id="likes-' + buzzId + '">' + (parseInt(likesElement.textContent) + 1) + '</span>';
                            likeButton.className = likeButton.className.replace('text-gray-500', 'text-red-500');
                        }
                        
                        // Get buzz author and create notification
                        database.ref(`buzz/${buzzId}`).once('value').then((buzzSnapshot) => {
                            const buzz = buzzSnapshot.val();
                            if (buzz && buzz.uid !== currentUser.uid) {
                                database.ref('users/' + currentUser.uid).once('value').then((userSnapshot) => {
                                    const userData = userSnapshot.val();
                                    createNotification(buzz.uid, 'like', (userData.displayName || userData.username) + ' liked your buzz');
                                });
                            }
                        });
                    });
                }
            });
        }

        // Toggle Rebuzz
        function toggleRebuzz(buzzId) {
            if (!currentUser) return;
            
            const rebuzzRef = database.ref(`buzz/${buzzId}/rebuzzes/${currentUser.uid}`);
            rebuzzRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    rebuzzRef.remove();
                } else {
                    rebuzzRef.set(true);
                    
                    // Get buzz author and create notification
                    database.ref(`buzz/${buzzId}`).once('value').then((buzzSnapshot) => {
                        const buzz = buzzSnapshot.val();
                        if (buzz && buzz.uid !== currentUser.uid) {
                            createNotification(buzz.uid, 'rebuzz', currentUser.displayName + ' rebuzzed your post');
                        }
                    });
                }
            });
        }

        // Load Verified Users
        function loadVerifiedUsers() {
            const usersRef = database.ref('users').orderByChild('verified').equalTo(true);
            usersRef.on('value', (snapshot) => {
                const verifiedUsersDiv = document.getElementById('verifiedUsers');
                verifiedUsersDiv.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    if (user.uid !== currentUser.uid) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-xl cursor-pointer';
                        userDiv.innerHTML = `
                            <img class="w-8 h-8 lg:w-10 lg:h-10 rounded-full border-2 border-pink-300 flex-shrink-0" src="${user.photoURL}" alt="User">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-1">
                                    <span class="font-medium text-sm lg:text-base truncate">${user.username}</span>
                                    <img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">
                                </div>
                                <p class="text-xs lg:text-sm text-gray-600 truncate">${user.bio || 'Verified user'}</p>
                            </div>
                        `;
                        verifiedUsersDiv.appendChild(userDiv);
                    }
                });
            });
        }

        // Profile Settings Functions
        function openProfileSettings() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('profilePrivateAccount').checked = userData.private || false;
                    document.getElementById('profileShowOnlineStatus').checked = userData.showOnlineStatus !== false;
                    document.getElementById('profilePushNotifications').checked = userData.pushNotifications !== false;
                    document.getElementById('profileEmailNotifications').checked = userData.emailNotifications || false;
                }
            });
            
            document.getElementById('profileSettingsModal').classList.remove('hidden');
        }

        function closeProfileSettings() {
            document.getElementById('profileSettingsModal').classList.add('hidden');
        }

        function saveProfileSettings() {
            if (!currentUser) return;
            
            const settings = {
                private: document.getElementById('profilePrivateAccount').checked,
                showOnlineStatus: document.getElementById('profileShowOnlineStatus').checked,
                pushNotifications: document.getElementById('profilePushNotifications').checked,
                emailNotifications: document.getElementById('profileEmailNotifications').checked
            };
            
            database.ref('users/' + currentUser.uid).update(settings).then(() => {
                closeProfileSettings();
                alert('Settings saved successfully!');
            });
        }

        // Edit Profile Functions
        function openEditProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('editName').value = userData.username;
                    document.getElementById('editBio').value = userData.bio || '';
                    document.getElementById('editLocation').value = userData.location || '';
                }
            });
            
            document.getElementById('editProfileModal').classList.remove('hidden');
        }

        function closeEditProfile() {
            document.getElementById('editProfileModal').classList.add('hidden');
        }

        async function updateProfile() {
            if (!currentUser) return;
            
            const name = document.getElementById('editName').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            
            // Get current user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();
            let photoURL = userData.photoURL;
            
            // If no photo exists, generate avatar with new name
            if (!photoURL || photoURL.startsWith('data:')) {
                photoURL = generateAvatar(name);
            }
            
            // Update user data
            const updates = {
                username: name,
                bio: bio,
                location: location,
                photoURL: photoURL
            };
            
            database.ref('users/' + currentUser.uid).update(updates).then(() => {
                closeEditProfile();
                loadUserProfile();
                updateTopBar();
            });
        }

        // Account Switcher Functions
        function openAccountSwitcher() {
            document.getElementById('accountSwitcherModal').classList.remove('hidden');
            loadSavedAccounts();
        }

        function closeAccountSwitcher() {
            document.getElementById('accountSwitcherModal').classList.add('hidden');
        }

        function loadSavedAccounts() {
            const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
            const accountsList = document.getElementById('savedAccountsList');
            accountsList.innerHTML = '';

            if (savedAccounts.length === 0) {
                accountsList.innerHTML = '<p class="text-gray-500 text-center py-4">No saved accounts</p>';
                return;
            }

            savedAccounts.forEach((account, index) => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors';
                
                const isCurrentAccount = currentUser && account.uid === currentUser.uid;
                
                accountDiv.innerHTML = `
                    <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${account.photoURL}" alt="User">
                    <div class="flex-1">
                        <h4 class="font-medium">${account.username}</h4>
                        <p class="text-sm text-gray-600">${account.email}</p>
                        ${isCurrentAccount ? '<span class="text-xs text-green-600">Current Account</span>' : ''}
                    </div>
                    <div class="flex space-x-2">
                        ${!isCurrentAccount ? `<button onclick="switchToAccount(${index})" class="text-sm bg-pink-500 text-white px-3 py-1 rounded-full hover:bg-pink-600">Switch</button>` : ''}
                        <button onclick="removeAccount(${index})" class="text-sm text-red-500 hover:text-red-700">Remove</button>
                    </div>
                `;
                
                accountsList.appendChild(accountDiv);
            });
        }

        function switchToAccount(index) {
            const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
            const account = savedAccounts[index];
            
            if (account) {
                // Sign out current user and sign in with saved account
                auth.signOut().then(() => {
                    // This would require implementing custom token authentication
                    // For now, we'll redirect to login
                    alert('Please sign in with the account: ' + account.email);
                    closeAccountSwitcher();
                });
            }
        }

        function removeAccount(index) {
            if (confirm('Remove this account from saved accounts?')) {
                const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
                savedAccounts.splice(index, 1);
                localStorage.setItem('oriobuzz_accounts', JSON.stringify(savedAccounts));
                loadSavedAccounts();
            }
        }

        function addNewAccount() {
            closeAccountSwitcher();
            logout();
        }

        function saveCurrentAccount() {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
                    
                    // Check if account already exists
                    const existingIndex = savedAccounts.findIndex(acc => acc.uid === currentUser.uid);
                    
                    const accountData = {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        username: userData.username,
                        photoURL: userData.photoURL
                    };
                    
                    if (existingIndex >= 0) {
                        savedAccounts[existingIndex] = accountData;
                    } else {
                        savedAccounts.push(accountData);
                    }
                    
                    localStorage.setItem('oriobuzz_accounts', JSON.stringify(savedAccounts));
                }
            });
        }

        // Utility Functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            return Math.floor(diff / 86400000) + 'd';
        }

        function logout() {
            // Save current account before logout
            saveCurrentAccount();
            auth.signOut();
        }

        // Delete Buzz
        function deleteBuzz(buzzId) {
            if (confirm('Are you sure you want to delete this buzz?')) {
                database.ref('buzz/' + buzzId).remove().then(() => {
                    loadBuzzFeed();
                    loadUserBuzz();
                });
            }
        }

        // View User Profile
        function viewUserProfile(userId) {
            if (userId === currentUser.uid) {
                showProfile();
                return;
            }
            
            currentViewingUser = userId;
            hideAllPages();
            document.getElementById('otherUserProfile').classList.remove('hidden');
            loadOtherUserProfile(userId);
            loadOtherUserBuzz(userId);
        }

        // Load Other User Profile
        function loadOtherUserProfile(userId) {
            const userRef = database.ref('users/' + userId);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('otherProfileImage').src = userData.photoURL;
                    document.getElementById('otherProfileName').textContent = userData.displayName || userData.username;
                    document.getElementById('otherProfileUsername').textContent = '@' + userData.username;
                    document.getElementById('otherProfileBio').textContent = userData.bio || 'No bio yet';
                    document.getElementById('otherLocationText').textContent = userData.location || 'Location not set';
                    
                    // Load follower counts
                    loadFollowerCounts(userId);
                    
                    // Check if following
                    checkFollowStatus(userId);
                    
                    // Check online status
                    getUserOnlineStatus(userId, (status) => {
                        updateUserOnlineIndicator(userId, status);
                    });
                    
                    if (userData.verified) {
                        document.getElementById('otherProfileVerified').classList.remove('hidden');
                    } else {
                        document.getElementById('otherProfileVerified').classList.add('hidden');
                    }

                    // Add share profile button
                    const shareBtn = document.createElement('button');
                    shareBtn.onclick = () => shareProfile(userId);
                    shareBtn.className = 'border border-gray-300 text-gray-700 px-4 lg:px-6 py-2 rounded-full hover:bg-gray-50 transition-colors text-sm lg:text-base';
                    shareBtn.innerHTML = '🔗 Share';
                    
                    const buttonContainer = document.querySelector('#otherUserProfile .flex.space-x-3');
                    if (buttonContainer && !buttonContainer.querySelector('.share-profile-btn')) {
                        shareBtn.classList.add('share-profile-btn');
                        buttonContainer.appendChild(shareBtn);
                    }
                }
            });
        }

        // Update user online indicator
        function updateUserOnlineIndicator(userId, status) {
            const indicator = document.getElementById('onlineIndicator-' + userId);
            if (indicator) {
                if (status && status.online) {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                    indicator.title = 'Online';
                } else {
                    indicator.className = 'w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                    if (status && status.lastSeen) {
                        indicator.title = 'Last seen ' + formatTimestamp(status.lastSeen);
                    } else {
                        indicator.title = 'Offline';
                    }
                }
            }
        }

        // Load Other User Buzz
        function loadOtherUserBuzz(userId) {
            // First check if user account is private
            database.ref('users/' + userId).once('value').then((userSnapshot) => {
                const userData = userSnapshot.val();
                const isPrivate = userData && userData.private;
                
                if (isPrivate) {
                    // Check if current user is following
                    database.ref('following/' + currentUser.uid + '/' + userId).once('value').then((followSnapshot) => {
                        const isFollowing = followSnapshot.exists();
                        
                        const otherUserBuzzFeed = document.getElementById('otherUserBuzzFeed');
                        
                        if (!isFollowing) {
                            // Show private account message
                            otherUserBuzzFeed.innerHTML = `
                                <div class="bg-gray-100 rounded-2xl p-8 text-center">
                                    <div class="text-6xl mb-4">🔒</div>
                                    <h3 class="text-xl font-bold mb-2">This Account is Private</h3>
                                    <p class="text-gray-600 mb-4">Follow ${userData.username} to see their buzz posts</p>
                                    <button onclick="toggleFollow()" class="gradient-bg text-white px-6 py-2 rounded-full hover:opacity-90 transition-opacity">
                                        Follow
                                    </button>
                                </div>
                            `;
                            return;
                        }
                    });
                }
                
                // Load buzz posts (either public account or following private account)
                const buzzRef = database.ref('buzz').orderByChild('uid').equalTo(userId);
                buzzRef.on('value', (snapshot) => {
                    const otherUserBuzzFeed = document.getElementById('otherUserBuzzFeed');
                    
                    // Don't overwrite private message if user is not following
                    if (isPrivate && otherUserBuzzFeed.innerHTML.includes('This Account is Private')) {
                        return;
                    }
                    
                    otherUserBuzzFeed.innerHTML = '';
                    
                    const buzzes = [];
                    snapshot.forEach((childSnapshot) => {
                        buzzes.push(childSnapshot.val());
                    });
                    
                    if (buzzes.length === 0) {
                        otherUserBuzzFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No buzz posts yet</p>';
                        return;
                    }
                    
                    buzzes.reverse().forEach((buzz) => {
                        const buzzElement = createBuzzElement(buzz);
                        otherUserBuzzFeed.appendChild(buzzElement);
                    });
                });
            });
        }

        // Check Follow Status
        function checkFollowStatus(userId) {
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            followRef.once('value').then((snapshot) => {
                const followBtn = document.getElementById('followBtn');
                if (snapshot.exists()) {
                    followBtn.textContent = 'Following';
                    followBtn.classList.remove('gradient-bg');
                    followBtn.classList.add('bg-gray-500');
                } else {
                    followBtn.textContent = 'Follow';
                    followBtn.classList.add('gradient-bg');
                    followBtn.classList.remove('bg-gray-500');
                }
            });
        }

        // Toggle Follow
        function toggleFollow() {
            if (!currentViewingUser) return;
            
            const followRef = database.ref('following/' + currentUser.uid + '/' + currentViewingUser);
            const followerRef = database.ref('followers/' + currentViewingUser + '/' + currentUser.uid);
            
            followRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Unfollow
                    followRef.remove();
                    followerRef.remove();
                    createNotification(currentViewingUser, 'unfollow', currentUser.displayName + ' unfollowed you');
                } else {
                    // Follow
                    followRef.set(true);
                    followerRef.set(true);
                    createNotification(currentViewingUser, 'follow', currentUser.displayName + ' started following you');
                }
                checkFollowStatus(currentViewingUser);
                loadFollowerCounts(currentViewingUser);
            });
        }

        // Start Chat
        function startChat() {
            if (!currentViewingUser) return;
            
            currentChatUser = currentViewingUser;
            showMessages();
            openChat(currentViewingUser);
        }

        // Start Chat with User
        function startChatWithUser() {
            if (!currentViewingUser) return;
            
            currentChatUser = currentViewingUser;
            showMessages();
            openChat(currentViewingUser);
        }

        // Contact User
        function contactUser() {
            if (!currentViewingUser) return;
            
            database.ref('users/' + currentViewingUser).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData && userData.contact) {
                    const contact = userData.contact;
                    
                    // Check if it's an email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (emailRegex.test(contact)) {
                        // Open email client
                        window.open(`mailto:${contact}?subject=Hello from OrioBuzz&body=Hi ${userData.username}, I found your profile on OrioBuzz and wanted to connect!`);
                    } else {
                        // Assume it's a phone number
                        const phoneNumber = contact.replace(/\D/g, ''); // Remove non-digits
                        if (phoneNumber.length >= 10) {
                            // Show options for phone contact
                            const options = [
                                { text: 'Call', action: () => window.open(`tel:${contact}`) },
                                { text: 'WhatsApp', action: () => window.open(`https://wa.me/${phoneNumber}?text=Hi ${userData.username}, I found your profile on OrioBuzz!`) },
                                { text: 'SMS', action: () => window.open(`sms:${contact}?body=Hi ${userData.username}, I found your profile on OrioBuzz!`) }
                            ];
                            
                            showContactOptions(options);
                        } else {
                            showCustomAlert('Invalid contact information', 'error');
                        }
                    }
                } else {
                    showCustomAlert('No contact information available for this user', 'warning');
                }
            });
        }

        // Show Contact Options
        function showContactOptions(options) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-4 text-center">Contact Options</h3>
                    <div class="space-y-3">
                        ${options.map((option, index) => `
                            <button onclick="contactOptions[${index}].action(); document.body.removeChild(this.closest('.fixed'))" 
                                    class="w-full p-3 bg-gray-100 hover:bg-gray-200 rounded-xl text-center transition-colors">
                                ${option.text}
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                            class="w-full mt-4 p-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors">
                        Cancel
                    </button>
                </div>
            `;
            
            // Store options globally for access
            window.contactOptions = options;
            
            document.body.appendChild(modal);
        }

        // Load Notifications
        function loadNotifications() {
            if (!currentUser) return;
            
            const notificationsRef = database.ref('notifications/' + currentUser.uid).orderByChild('timestamp');
            notificationsRef.on('value', (snapshot) => {
                const notificationsFeed = document.getElementById('notificationsFeed');
                notificationsFeed.innerHTML = '';
                
                const notifications = [];
                snapshot.forEach((childSnapshot) => {
                    notifications.push(childSnapshot.val());
                });
                
                if (notifications.length === 0) {
                    notificationsFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No notifications yet</p>';
                    return;
                }
                
                notifications.reverse().forEach((notification) => {
                    const notificationElement = createNotificationElement(notification);
                    notificationsFeed.appendChild(notificationElement);
                });
            });
        }

        // Create Notification Element
        function createNotificationElement(notification) {
            const div = document.createElement('div');
            div.className = 'notification-item bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 cursor-pointer';
            
            let icon = '🔔';
            let bgColor = 'bg-blue-50';
            let borderColor = 'border-l-blue-500';
            
            if (notification.type === 'like') {
                icon = '❤️';
                bgColor = 'bg-red-50';
                borderColor = 'border-l-red-500';
            } else if (notification.type === 'rebuzz') {
                icon = '🔁';
                bgColor = 'bg-green-50';
                borderColor = 'border-l-green-500';
            } else if (notification.type === 'follow') {
                icon = '👤';
                bgColor = 'bg-purple-50';
                borderColor = 'border-l-purple-500';
            } else if (notification.type === 'comment') {
                icon = '💬';
                bgColor = 'bg-yellow-50';
                borderColor = 'border-l-yellow-500';
            } else if (notification.type === 'verification') {
                icon = '✅';
                bgColor = 'bg-green-50';
                borderColor = 'border-l-green-500';
            } else if (notification.type === 'message') {
                icon = '📩';
                bgColor = 'bg-indigo-50';
                borderColor = 'border-l-indigo-500';
            }
            
            div.className += ` ${bgColor} border-l-4 ${borderColor}`;
            
            div.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm">
                            <span class="text-lg">${icon}</span>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 mb-1">${notification.message}</p>
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500">${formatTimestamp(notification.timestamp)}</p>
                            ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="removeNotification('${notification.id}')" class="text-gray-400 hover:text-red-500 transition-colors">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            // Add click handler for notification actions
            div.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    handleNotificationClick(notification);
                }
            });
            
            return div;
        }

        // Handle Notification Click
        function handleNotificationClick(notification) {
            // Mark as read
            if (!notification.read) {
                database.ref('notifications/' + currentUser.uid + '/' + notification.id).update({ read: true });
            }
            
            // Handle different notification types
            if (notification.type === 'like' || notification.type === 'comment' || notification.type === 'rebuzz') {
                // Try to navigate to the buzz (if we had buzz ID in notification)
                showHome();
            } else if (notification.type === 'follow') {
                // Navigate to followers page
                showProfile();
            } else if (notification.type === 'message') {
                // Navigate to messages
                showMessages();
            }
        }

        // Remove Notification
        function removeNotification(notificationId) {
            if (confirm('Remove this notification?')) {
                database.ref('notifications/' + currentUser.uid + '/' + notificationId).remove();
            }
        }

        // Create Notification
        function createNotification(userId, type, message) {
            if (userId === currentUser.uid) return; // Don't notify yourself
            
            const notificationId = database.ref('notifications/' + userId).push().key;
            const notificationData = {
                id: notificationId,
                type: type,
                message: message,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            };
            
            database.ref('notifications/' + userId + '/' + notificationId).set(notificationData);
            updateNotificationBadge(userId);
        }

        // Update Notification Badge
        function updateNotificationBadge(userId) {
            if (userId !== currentUser.uid) return;
            
            const notificationsRef = database.ref('notifications/' + userId).orderByChild('read').equalTo(false);
            notificationsRef.once('value').then((snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                const badge = document.getElementById('notificationBadge');
                const badgeDesktop = document.getElementById('notificationBadgeDesktop');
                
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                    badgeDesktop.textContent = count;
                    badgeDesktop.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                    badgeDesktop.classList.add('hidden');
                }
            });
        }

        // Clear Notification Badge
        function clearNotificationBadge() {
            if (!currentUser) return;
            
            const notificationsRef = database.ref('notifications/' + currentUser.uid);
            notificationsRef.once('value').then((snapshot) => {
                const updates = {};
                snapshot.forEach((childSnapshot) => {
                    updates[childSnapshot.key + '/read'] = true;
                });
                notificationsRef.update(updates);
            });
            
            document.getElementById('notificationBadge').classList.add('hidden');
            document.getElementById('notificationBadgeDesktop').classList.add('hidden');
        }

        // Load Conversations
        function loadConversations() {
            if (!currentUser) return;
            
            const conversationsRef = database.ref('conversations').orderByChild('participants/' + currentUser.uid).equalTo(true);
            conversationsRef.on('value', (snapshot) => {
                const conversationsList = document.getElementById('conversationsList');
                conversationsList.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const conversation = childSnapshot.val();
                    const otherUserId = Object.keys(conversation.participants).find(id => id !== currentUser.uid);
                    
                    if (otherUserId) {
                        database.ref('users/' + otherUserId).once('value').then((userSnapshot) => {
                            const userData = userSnapshot.val();
                            if (userData) {
                                const conversationElement = createConversationElement(conversation, userData, otherUserId);
                                conversationsList.appendChild(conversationElement);
                            }
                        });
                    }
                });
            });
        }

        // Create Conversation Element
        function createConversationElement(conversation, userData, userId) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-xl cursor-pointer';
            div.onclick = () => openChat(userId);
            
            const lastMessagePreview = conversation.lastMessage ? 
                (conversation.lastMessage.length > 30 ? 
                    conversation.lastMessage.substring(0, 30) + '...' : 
                    conversation.lastMessage) : 
                'Start a conversation';
            
            div.innerHTML = `
                <div class="relative">
                    <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${userData.photoURL}" alt="User">
                    <div id="conversationOnline-${userId}" class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <h4 class="font-medium text-sm truncate">${userData.displayName || userData.username}</h4>
                        <span class="text-xs text-gray-400">${conversation.lastMessageTime ? formatTimestamp(conversation.lastMessageTime) : ''}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate">${lastMessagePreview}</p>
                </div>
            `;
            
            // Update online status
            getUserOnlineStatus(userId, (status) => {
                const indicator = document.getElementById('conversationOnline-' + userId);
                if (indicator) {
                    if (status && status.online) {
                        indicator.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                    } else {
                        indicator.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                    }
                }
            });
            
            return div;
        }

        // Open Chat
        function openChat(userId) {
            currentChatUser = userId;
            
            database.ref('users/' + userId).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('chatUserImage').src = userData.photoURL;
                    document.getElementById('chatUserName').textContent = userData.username;
                    
                    // Update online status
                    getUserOnlineStatus(userId, (status) => {
                        const statusElement = document.getElementById('chatUserStatus');
                        const indicatorElement = document.getElementById('chatUserOnlineIndicator');
                        
                        if (status && status.online) {
                            statusElement.textContent = 'Online';
                            statusElement.className = 'text-sm text-green-500';
                            indicatorElement.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                        } else {
                            statusElement.textContent = status && status.lastSeen ? 
                                'Last seen ' + formatTimestamp(status.lastSeen) : 'Offline';
                            statusElement.className = 'text-sm text-gray-500';
                            indicatorElement.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                        }
                    });
                    
                    document.getElementById('noChatSelected').classList.add('hidden');
                    document.getElementById('chatArea').classList.remove('hidden');
                    
                    loadMessages(userId);
                    listenForTyping(userId);
                }
            });
        }

        // Handle typing indicator
        let typingTimeout;
        function handleTyping() {
            if (!currentChatUser) return;
            
            const conversationId = [currentUser.uid, currentChatUser].sort().join('_');
            
            // Show typing indicator for other user
            database.ref('typing/' + conversationId + '/' + currentUser.uid).set({
                typing: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Clear typing indicator after 3 seconds
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                database.ref('typing/' + conversationId + '/' + currentUser.uid).remove();
            }, 3000);
        }

        // Listen for typing indicator
        function listenForTyping(userId) {
            const conversationId = [currentUser.uid, userId].sort().join('_');
            
            database.ref('typing/' + conversationId + '/' + userId).on('value', (snapshot) => {
                const typingData = snapshot.val();
                const typingIndicator = document.getElementById('typingIndicator');
                const typingUsername = document.getElementById('typingUsername');
                
                if (typingData && typingData.typing) {
                    database.ref('users/' + userId).once('value').then((userSnapshot) => {
                        const userData = userSnapshot.val();
                        if (userData) {
                            typingUsername.textContent = userData.username;
                            typingIndicator.classList.remove('hidden');
                        }
                    });
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });
        }

        // Load Messages
        function loadMessages(userId) {
            const conversationId = [currentUser.uid, userId].sort().join('_');
            const messagesRef = database.ref('messages/' + conversationId).orderByChild('timestamp');
            
            messagesRef.on('value', (snapshot) => {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    const messageElement = createMessageElement(message);
                    messagesContainer.appendChild(messageElement);
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // Create Message Element
        function createMessageElement(message) {
            const div = document.createElement('div');
            const isOwn = message.senderId === currentUser.uid;
            
            div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} items-end space-x-2 mb-3`;
            
            if (isOwn) {
                div.innerHTML = `
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-4 py-2 rounded-2xl rounded-br-md shadow-lg">
                            <p class="text-sm break-words">${message.text}</p>
                        </div>
                        <div class="flex items-center justify-end space-x-1 mt-1">
                            <p class="text-xs text-gray-500">${formatTimestamp(message.timestamp)}</p>
                            <span class="text-xs ${message.read ? 'text-blue-500' : 'text-gray-400'}">${message.read ? '✓✓' : '✓'}</span>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 overflow-hidden">
                        <img class="w-full h-full object-cover" src="${message.senderImage || generateAvatar(message.senderName || 'User')}" alt="User">
                    </div>
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-white border border-gray-200 text-gray-800 px-4 py-2 rounded-2xl rounded-bl-md shadow-sm">
                            <p class="text-sm break-words">${message.text}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 ml-2">${formatTimestamp(message.timestamp)}</p>
                    </div>
                `;
            }
            
            return div;
        }

        // Send Message - Completely Fixed
        function sendMessage() {
            console.log('🚀 Send message function called');
            
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) {
                console.error('❌ Message input not found');
                return;
            }
            
            const messageText = messageInput.value.trim();
            console.log('📝 Message text:', messageText);
            
            if (!messageText) {
                console.log('⚠️ No message text');
                return;
            }
            
            if (!currentChatUser) {
                console.log('⚠️ No chat user selected');
                alert('Please select a user to chat with');
                return;
            }
            
            if (!currentUser) {
                console.log('⚠️ No current user');
                alert('Please login first');
                return;
            }
            
            console.log('✅ All checks passed, sending message...');
            
            // Create conversation ID
            const conversationId = [currentUser.uid, currentChatUser].sort().join('_');
            console.log('💬 Conversation ID:', conversationId);
            
            // Get user data first
            database.ref('users/' + currentUser.uid).once('value').then((userSnapshot) => {
                const userData = userSnapshot.val();
                console.log('👤 User data:', userData);
                
                if (!userData) {
                    console.error('❌ No user data found');
                    return;
                }
                
                // Create message data
                const messageData = {
                    senderId: currentUser.uid,
                    receiverId: currentChatUser,
                    senderName: userData.username || userData.displayName || 'User',
                    senderImage: userData.photoURL || '',
                    text: messageText,
                    timestamp: Date.now(),
                    read: false
                };
                
                console.log('📤 Sending message data:', messageData);
                
                // Save message to database
                const messageRef = database.ref('messages/' + conversationId).push();
                messageRef.set(messageData).then(() => {
                    console.log('✅ Message saved successfully');
                    
                    // Clear input
                    messageInput.value = '';
                    
                    // Update conversation
                    const conversationData = {
                        participants: {
                            [currentUser.uid]: true,
                            [currentChatUser]: true
                        },
                        lastMessage: messageText,
                        lastMessageTime: Date.now(),
                        lastMessageSender: currentUser.uid
                    };
                    
                    database.ref('conversations/' + conversationId).set(conversationData).then(() => {
                        console.log('✅ Conversation updated');
                        
                        // Create notification
                        createNotification(currentChatUser, 'message', `${userData.username || 'Someone'} sent you a message`);
                        
                        // Remove typing indicator
                        database.ref('typing/' + conversationId + '/' + currentUser.uid).remove();
                        
                    }).catch((error) => {
                        console.error('❌ Error updating conversation:', error);
                    });
                    
                }).catch((error) => {
                    console.error('❌ Error saving message:', error);
                    alert('Failed to send message: ' + error.message);
                });
                
            }).catch((error) => {
                console.error('❌ Error getting user data:', error);
                alert('Failed to get user data: ' + error.message);
            });
        }

        // Initialize message input
        function initializeMessageInput() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendMessageBtn');
            
            if (!messageInput || !sendBtn) return;
            
            // Add event listeners
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', function() {
                handleTyping();
            });
            
            sendBtn.addEventListener('click', function(e) {
                e.preventDefault();
                sendMessage();
            });
        }
        
        // Show Messages
        function showMessages() {
            hideAllPages();
            document.getElementById('messagesPage').classList.remove('hidden');
            loadConversations();
            
            // Initialize message input
            setTimeout(() => {
                initializeMessageInput();
            }, 100);
        }

        // Load Settings
        function loadSettings() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('privateAccount').checked = userData.private || false;
                    document.getElementById('showOnlineStatus').checked = userData.showOnlineStatus !== false;
                    document.getElementById('pushNotifications').checked = userData.pushNotifications !== false;
                    document.getElementById('emailNotifications').checked = userData.emailNotifications || false;
                }
            });
        }

        // Verification Functions
        function openVerificationModal() {
            document.getElementById('verificationModal').classList.remove('hidden');
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.add('hidden');
            // Clear form
            document.getElementById('verifyName').value = '';
            document.getElementById('verifyAge').value = '';
            document.getElementById('verifyCategory').value = '';
            document.getElementById('verifyLink').value = '';
        }

        function submitVerification() {
            const name = document.getElementById('verifyName').value.trim();
            const age = document.getElementById('verifyAge').value;
            const category = document.getElementById('verifyCategory').value;
            const link = document.getElementById('verifyLink').value.trim();
            
            if (!name || !age || !category || !link) {
                showCustomAlert('Please fill all required fields', 'error');
                return;
            }
            
            if (age < 13) {
                showCustomAlert('You must be at least 13 years old to get verified', 'error');
                return;
            }
            
            // Validate URL
            try {
                new URL(link);
            } catch {
                showCustomAlert('Please enter a valid URL', 'error');
                return;
            }
            
            const verificationData = {
                uid: currentUser.uid,
                name: name,
                age: age,
                category: category,
                link: link,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            };
            
            // Save verification request
            database.ref('verificationRequests/' + currentUser.uid).set(verificationData);
            
            closeVerificationModal();
            showCustomAlert('Verification request submitted! We will review it within 24-48 hours.', 'success');
            
            // Create notification for user
            createNotification(currentUser.uid, 'verification', 'Your verification request has been submitted and is under review.');
        }

        // Export Data
        function exportData() {
            if (!currentUser) return;
            
            const userData = {
                profile: {},
                buzzes: [],
                followers: [],
                following: []
            };
            
            // Get user data
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                userData.profile = snapshot.val();
                
                // Get user's buzzes
                return database.ref('buzz').orderByChild('uid').equalTo(currentUser.uid).once('value');
            }).then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    userData.buzzes.push(childSnapshot.val());
                });
                
                // Create and download file
                const dataStr = JSON.stringify(userData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'oriobuzz-data.json';
                link.click();
                URL.revokeObjectURL(url);
            });
        }

        // Deactivate Account
        function deactivateAccount() {
            if (confirm('Are you sure you want to deactivate your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    // Delete user data
                    database.ref('users/' + currentUser.uid).remove();
                    database.ref('buzz').orderByChild('uid').equalTo(currentUser.uid).once('value').then((snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            childSnapshot.ref.remove();
                        });
                    });
                    
                    // Sign out
                    auth.signOut();
                }
            }
        }

        // Comment Modal Functions
        let currentCommentBuzzId = null;

        function openCommentModal(buzzId) {
            currentCommentBuzzId = buzzId;
            document.getElementById('commentModal').classList.remove('hidden');
            
            // Set user image
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('commentUserImage').src = userData.photoURL;
                    }
                });
            }
            
            loadComments(buzzId);
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.add('hidden');
            document.getElementById('commentContent').value = '';
            currentCommentBuzzId = null;
        }

        function loadComments(buzzId) {
            const commentsRef = database.ref('buzz/' + buzzId + '/comments');
            commentsRef.on('value', (snapshot) => {
                const commentsContainer = document.getElementById('commentsContainer');
                commentsContainer.innerHTML = '';
                
                if (!snapshot.exists()) {
                    commentsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No comments yet</p>';
                    return;
                }
                
                const comments = [];
                snapshot.forEach((childSnapshot) => {
                    comments.push(childSnapshot.val());
                });
                
                comments.sort((a, b) => a.timestamp - b.timestamp);
                
                comments.forEach((comment) => {
                    const commentElement = createCommentElement(comment);
                    commentsContainer.appendChild(commentElement);
                });
            });
        }

        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'flex items-start space-x-3 p-3 bg-gray-50 rounded-xl';
            
            div.innerHTML = `
                <img class="w-8 h-8 rounded-full border-2 border-pink-300" src="${comment.userImage}" alt="User">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="font-medium text-sm">${comment.username}</span>
                        ${comment.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                        <span class="text-gray-500 text-xs">${formatTimestamp(comment.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-800">${comment.content}</p>
                </div>
            `;
            
            return div;
        }

        async function postComment() {
            const content = document.getElementById('commentContent').value.trim();
            
            if (!content || !currentCommentBuzzId) return;

            // Get user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();

            const commentId = database.ref('buzz/' + currentCommentBuzzId + '/comments').push().key;

            const commentData = {
                commentId: commentId,
                uid: currentUser.uid,
                username: userData.username,
                userImage: userData.photoURL,
                verified: userData.verified || false,
                content: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Save comment
            database.ref('buzz/' + currentCommentBuzzId + '/comments/' + commentId).set(commentData).then(() => {
                document.getElementById('commentContent').value = '';
                
                // Create notification for buzz author
                database.ref('buzz/' + currentCommentBuzzId).once('value').then((buzzSnapshot) => {
                    const buzz = buzzSnapshot.val();
                    if (buzz && buzz.uid !== currentUser.uid) {
                        createNotification(buzz.uid, 'comment', userData.username + ' commented on your buzz');
                    }
                });
            });
        }

        // Report Modal Functions
        let currentReportBuzzId = null;

        function openReportModal(buzzId) {
            currentReportBuzzId = buzzId;
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('reportDetails').value = '';
            // Clear radio buttons
            const radioButtons = document.querySelectorAll('input[name="reportReason"]');
            radioButtons.forEach(radio => radio.checked = false);
            currentReportBuzzId = null;
        }

        async function submitReport() {
            const selectedReason = document.querySelector('input[name="reportReason"]:checked');
            const details = document.getElementById('reportDetails').value.trim();
            
            if (!selectedReason || !currentReportBuzzId) {
                alert('Please select a reason for reporting');
                return;
            }

            const reportId = database.ref('reports').push().key;
            const reportData = {
                reportId: reportId,
                buzzId: currentReportBuzzId,
                reporterId: currentUser.uid,
                reason: selectedReason.value,
                details: details,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            };

            // Save report
            await database.ref('reports/' + reportId).set(reportData);

            // Check if buzz should be auto-deleted (50+ reports)
            const reportsRef = database.ref('reports').orderByChild('buzzId').equalTo(currentReportBuzzId);
            reportsRef.once('value').then((snapshot) => {
                const reportCount = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                
                if (reportCount >= 50) {
                    // Auto-delete buzz
                    database.ref('buzz/' + currentReportBuzzId).remove();
                    
                    // Notify buzz author
                    database.ref('buzz/' + currentReportBuzzId).once('value').then((buzzSnapshot) => {
                        const buzz = buzzSnapshot.val();
                        if (buzz) {
                            createNotification(buzz.uid, 'moderation', 'Your buzz has been removed due to multiple reports');
                        }
                    });
                }
            });

            closeReportModal();
            alert('Report submitted successfully. Thank you for helping keep OrioBuzz safe!');
        }

        // Real-time updates for likes, rebuzzes, and comments
        database.ref('buzz').on('child_changed', (snapshot) => {
            const buzz = snapshot.val();
            const likesElement = document.getElementById(`likes-${buzz.buzzId}`);
            const rebuzzesElement = document.getElementById(`rebuzzes-${buzz.buzzId}`);
            const commentsElement = document.getElementById(`comments-${buzz.buzzId}`);
            
            if (likesElement) {
                const likesCount = buzz.likes ? Object.keys(buzz.likes).length : 0;
                likesElement.textContent = likesCount;
            }
            
            if (rebuzzesElement) {
                const rebuzzesCount = buzz.rebuzzes ? Object.keys(buzz.rebuzzes).length : 0;
                rebuzzesElement.textContent = rebuzzesCount;
            }
            
            if (commentsElement) {
                const commentsCount = buzz.comments ? Object.keys(buzz.comments).length : 0;
                commentsElement.textContent = commentsCount;
            }
        });

        // Handle buzz input for hashtag suggestions
        function handleBuzzInput() {
            const content = document.getElementById('buzzContent').value;
            const cursorPosition = document.getElementById('buzzContent').selectionStart;
            const textBeforeCursor = content.substring(0, cursorPosition);
            const lastHashtag = textBeforeCursor.match(/#(\w*)$/);
            
            if (lastHashtag) {
                const hashtagPrefix = lastHashtag[1];
                showHashtagSuggestions(hashtagPrefix);
            } else {
                hideHashtagSuggestions();
            }
        }

        // Show hashtag suggestions
        function showHashtagSuggestions(prefix) {
            database.ref('hashtags').once('value').then((snapshot) => {
                const suggestions = document.getElementById('hashtagSuggestions');
                suggestions.innerHTML = '';
                
                if (snapshot.exists()) {
                    const hashtags = Object.keys(snapshot.val());
                    const filteredHashtags = hashtags.filter(hashtag => 
                        hashtag.toLowerCase().startsWith(prefix.toLowerCase())
                    ).slice(0, 5);
                    
                    if (filteredHashtags.length > 0) {
                        filteredHashtags.forEach(hashtag => {
                            const div = document.createElement('div');
                            div.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm';
                            div.textContent = '#' + hashtag;
                            div.onclick = () => selectHashtag(hashtag);
                            suggestions.appendChild(div);
                        });
                        suggestions.classList.remove('hidden');
                    } else {
                        hideHashtagSuggestions();
                    }
                } else {
                    hideHashtagSuggestions();
                }
            });
        }

        // Hide hashtag suggestions
        function hideHashtagSuggestions() {
            document.getElementById('hashtagSuggestions').classList.add('hidden');
        }

        // Select hashtag from suggestions
        function selectHashtag(hashtag) {
            const textarea = document.getElementById('buzzContent');
            const content = textarea.value;
            const cursorPosition = textarea.selectionStart;
            const textBeforeCursor = content.substring(0, cursorPosition);
            const textAfterCursor = content.substring(cursorPosition);
            
            // Replace the partial hashtag with the selected one
            const newTextBefore = textBeforeCursor.replace(/#\w*$/, '#' + hashtag + ' ');
            textarea.value = newTextBefore + textAfterCursor;
            
            // Set cursor position after the hashtag
            const newCursorPosition = newTextBefore.length;
            textarea.setSelectionRange(newCursorPosition, newCursorPosition);
            textarea.focus();
            
            hideHashtagSuggestions();
        }

        // Check username availability
        async function checkUsernameAvailability() {
            const username = document.getElementById('editName').value.trim().toLowerCase();
            const statusElement = document.getElementById('usernameStatus');
            
            if (!username) {
                statusElement.textContent = '';
                return;
            }
            
            // Validate username format
            if (!/^[a-z0-9_]+$/.test(username)) {
                statusElement.textContent = 'Username can only contain lowercase letters, numbers, and underscores';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            if (username.length < 3) {
                statusElement.textContent = 'Username must be at least 3 characters long';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            if (username.length > 20) {
                statusElement.textContent = 'Username must be less than 20 characters';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            // Check if username is already taken
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
            
            if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                const userIds = Object.keys(users);
                
                // Check if it's the current user's username
                if (userIds.length === 1 && userIds[0] === currentUser.uid) {
                    statusElement.textContent = 'This is your current username';
                    statusElement.className = 'text-xs mt-1 text-blue-500';
                } else {
                    statusElement.textContent = '❌ Username already taken - try another one';
                    statusElement.className = 'text-xs mt-1 text-red-500';
                }
            } else {
                statusElement.textContent = '✅ Username available';
                statusElement.className = 'text-xs mt-1 text-green-500';
            }
        }

        // Update profile with website, gender, and contact
        async function updateProfile() {
            if (!currentUser) return;
            
            const displayName = document.getElementById('editDisplayName').value.trim();
            const username = document.getElementById('editName').value.trim().toLowerCase().replace(/\s+/g, '');
            const bio = document.getElementById('editBio').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            const website = document.getElementById('editWebsite').value.trim();
            const gender = document.getElementById('editGender').value;
            const contact = document.getElementById('editContact').value.trim();
            
            // Validate required fields
            if (!username) {
                showCustomAlert('Username is required', 'error');
                return;
            }
            
            // Validate username format
            if (!/^[a-z0-9_]+$/.test(username)) {
                showCustomAlert('Username can only contain lowercase letters, numbers, and underscores', 'error');
                return;
            }
            
            if (username.length < 3) {
                showCustomAlert('Username must be at least 3 characters long', 'error');
                return;
            }
            
            if (username.length > 20) {
                showCustomAlert('Username must be less than 20 characters', 'error');
                return;
            }
            
            // Check if username is available
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
            if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                const userIds = Object.keys(users);
                if (userIds.length > 0 && userIds[0] !== currentUser.uid) {
                    showCustomAlert('Username already taken. Please choose a different one.', 'error');
                    return;
                }
            }
            
            // Validate website URL if provided
            if (website && !website.startsWith('http://') && !website.startsWith('https://')) {
                showCustomAlert('Website URL must start with http:// or https://', 'error');
                return;
            }
            
            // Validate contact if provided
            if (contact) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
                
                if (!emailRegex.test(contact) && !phoneRegex.test(contact)) {
                    showCustomAlert('Please enter a valid email or phone number', 'error');
                    return;
                }
            }
            
            // Get current user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();
            let photoURL = userData.photoURL;
            
            // If no photo exists, generate avatar with new display name
            if (!photoURL || photoURL.startsWith('data:')) {
                photoURL = generateAvatar(displayName || username);
            }
            
            // Update user data
            const updates = {
                displayName: displayName || username,
                username: username,
                bio: bio,
                location: location,
                website: website,
                gender: gender,
                contact: contact,
                photoURL: photoURL
            };
            
            try {
                await database.ref('users/' + currentUser.uid).update(updates);
                closeEditProfile();
                loadUserProfile();
                updateTopBar();
                showCustomAlert('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                showCustomAlert('Failed to update profile. Please try again.', 'error');
            }
        }

        // Load user profile with website
        function loadUserProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('profileImage').src = userData.photoURL;
                    document.getElementById('profileName').textContent = userData.displayName || userData.username;
                    document.getElementById('profileUsername').textContent = '@' + userData.username;
                    document.getElementById('profileBio').textContent = userData.bio || 'No bio yet';
                    document.getElementById('locationText').textContent = userData.location || 'Location not set';
                    
                    // Add website link if exists
                    const locationElement = document.getElementById('profileLocation');
                    if (userData.website) {
                        locationElement.innerHTML = `
                            📍 <span>${userData.location || 'Location not set'}</span><br>
                            🌐 <a href="${userData.website}" target="_blank" class="text-blue-500 hover:text-blue-700">${userData.website}</a>
                        `;
                    } else {
                        locationElement.innerHTML = `📍 <span id="locationText">${userData.location || 'Location not set'}</span>`;
                    }
                    
                    // Load follower counts and posts count
                    loadFollowerCounts(currentUser.uid);
                    loadPostsCount(currentUser.uid);
                    
                    if (userData.verified) {
                        document.getElementById('profileVerified').classList.remove('hidden');
                    } else {
                        document.getElementById('profileVerified').classList.add('hidden');
                    }
                }
            });
        }

        // Load Posts Count
        function loadPostsCount(userId) {
            const buzzRef = database.ref('buzz').orderByChild('uid').equalTo(userId);
            buzzRef.once('value').then((snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                document.getElementById('postsCount').textContent = count;
            });
        }

        // Open edit profile with website, gender, and contact
        function openEditProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('editDisplayName').value = userData.displayName || '';
                    document.getElementById('editName').value = userData.username || '';
                    document.getElementById('editBio').value = userData.bio || '';
                    document.getElementById('editLocation').value = userData.location || '';
                    document.getElementById('editWebsite').value = userData.website || '';
                    document.getElementById('editGender').value = userData.gender || '';
                    document.getElementById('editContact').value = userData.contact || '';
                }
            });
            
            document.getElementById('editProfileModal').classList.remove('hidden');
        }

        // Send Message - Completely Fixed
        function sendMessage() {
            console.log('🚀 Send message function called');
            
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) {
                console.error('❌ Message input not found');
                return;
            }
            
            const messageText = messageInput.value.trim();
            console.log('📝 Message text:', messageText);
            
            if (!messageText) {
                console.log('⚠️ No message text');
                return;
            }
            
            if (!currentChatUser) {
                console.log('⚠️ No chat user selected');
                alert('Please select a user to chat with');
                return;
            }
            
            if (!currentUser) {
                console.log('⚠️ No current user');
                alert('Please login first');
                return;
            }
            
            console.log('✅ All checks passed, sending message...');
            
            // Create conversation ID
            const conversationId = [currentUser.uid, currentChatUser].sort().join('_');
            console.log('💬 Conversation ID:', conversationId);
            
            // Get user data first
            database.ref('users/' + currentUser.uid).once('value').then((userSnapshot) => {
                const userData = userSnapshot.val();
                console.log('👤 User data:', userData);
                
                if (!userData) {
                    console.error('❌ No user data found');
                    return;
                }
                
                // Create message data
                const messageData = {
                    senderId: currentUser.uid,
                    receiverId: currentChatUser,
                    senderName: userData.username || userData.displayName || 'User',
                    senderImage: userData.photoURL || '',
                    text: messageText,
                    timestamp: Date.now(),
                    read: false
                };
                
                console.log('📤 Sending message data:', messageData);
                
                // Save message to database
                const messageRef = database.ref('messages/' + conversationId).push();
                messageRef.set(messageData).then(() => {
                    console.log('✅ Message saved successfully');
                    
                    // Clear input
                    messageInput.value = '';
                    
                    // Update conversation
                    const conversationData = {
                        participants: {
                            [currentUser.uid]: true,
                            [currentChatUser]: true
                        },
                        lastMessage: messageText,
                        lastMessageTime: Date.now(),
                        lastMessageSender: currentUser.uid
                    };
                    
                    database.ref('conversations/' + conversationId).set(conversationData).then(() => {
                        console.log('✅ Conversation updated');
                        
                        // Create notification
                        createNotification(currentChatUser, 'message', `${userData.username || 'Someone'} sent you a message`);
                        
                        // Remove typing indicator
                        database.ref('typing/' + conversationId + '/' + currentUser.uid).remove();
                        
                    }).catch((error) => {
                        console.error('❌ Error updating conversation:', error);
                    });
                    
                }).catch((error) => {
                    console.error('❌ Error saving message:', error);
                    alert('Failed to send message: ' + error.message);
                });
                
            }).catch((error) => {
                console.error('❌ Error getting user data:', error);
                alert('Failed to get user data: ' + error.message);
            });
        }

        // Create Message Element
        function createMessageElement(message) {
            const div = document.createElement('div');
            const isOwn = message.senderId === currentUser.uid;
            
            div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} items-end space-x-2 mb-3`;
            
            if (isOwn) {
                div.innerHTML = `
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-4 py-2 rounded-2xl rounded-br-md shadow-lg">
                            <p class="text-sm break-words">${message.text}</p>
                        </div>
                        <div class="flex items-center justify-end space-x-1 mt-1">
                            <p class="text-xs text-gray-500">${formatTimestamp(message.timestamp)}</p>
                            <span class="text-xs ${message.read ? 'text-blue-500' : 'text-gray-400'}">${message.read ? '✓✓' : '✓'}</span>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 overflow-hidden">
                        <img class="w-full h-full object-cover" src="${message.senderImage || generateAvatar(message.senderName || 'User')}" alt="User">
                    </div>
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-white border border-gray-200 text-gray-800 px-4 py-2 rounded-2xl rounded-bl-md shadow-sm">
                            <p class="text-sm break-words">${message.text}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 ml-2">${formatTimestamp(message.timestamp)}</p>
                    </div>
                `;
            }
            
            return div;
        }

        // Listen for notifications
        if (currentUser) {
            database.ref('notifications/' + currentUser.uid).on('child_added', () => {
                updateNotificationBadge(currentUser.uid);
            });
        }

        // ===== WEBRTC CALLING SYSTEM =====
        
        // WebRTC Configuration
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // Call State Variables
        let localPeerConnection = null;
        let localStream = null;
        let remoteStream = null;
        let currentCallId = null;
        let currentCallType = null; // 'audio' or 'video'
        let isCallActive = false;
        let isMuted = false;
        let isVideoEnabled = true;
        let callStartTime = null;
        let callTimer = null;

        // Initialize WebRTC when user signs in
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                saveUserToDatabase(user);
                showMainApp();
                loadBuzzFeed();
                loadVerifiedUsers();
                updateOnlineStatus(true);
                handleURLHash();
                initializeCallListeners(); // Initialize call listeners
            } else {
                showLoginScreen();
                updateOnlineStatus(false);
                cleanupCall(); // Cleanup any active calls
            }
        });

        // Initialize Call Listeners
        function initializeCallListeners() {
            if (!currentUser) return;

            // Listen for incoming calls
            database.ref('calls').orderByChild('receiverId').equalTo(currentUser.uid).on('child_added', (snapshot) => {
                const callData = snapshot.val();
                if (callData && callData.status === 'calling' && !isCallActive) {
                    handleIncomingCall(callData);
                }
            });

            // Listen for call status changes
            database.ref('calls').on('child_changed', (snapshot) => {
                const callData = snapshot.val();
                if (callData && callData.callId === currentCallId) {
                    handleCallStatusChange(callData);
                }
            });

            // Listen for WebRTC signaling
            database.ref('signaling').orderByChild('receiverId').equalTo(currentUser.uid).on('child_added', (snapshot) => {
                const signalingData = snapshot.val();
                if (signalingData && signalingData.callId === currentCallId) {
                    handleSignalingData(signalingData);
                }
            });
        }

        // Start Audio Call
        async function startAudioCall() {
            if (!currentChatUser) {
                alert('Please select a user to call');
                return;
            }

            if (isCallActive) {
                alert('You are already in a call');
                return;
            }

            try {
                currentCallType = 'audio';
                await initializeCall('audio');
                showOutgoingCall();
                
                // Create call record in database
                currentCallId = database.ref('calls').push().key;
                const callData = {
                    callId: currentCallId,
                    callerId: currentUser.uid,
                    receiverId: currentChatUser,
                    type: 'audio',
                    status: 'calling',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref('calls/' + currentCallId).set(callData);
                
                // Set timeout for call (30 seconds)
                setTimeout(() => {
                    if (currentCallId && !isCallActive) {
                        cancelCall();
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Error starting audio call:', error);
                alert('Failed to start call: ' + error.message);
            }
        }

        // Start Video Call
        async function startVideoCall() {
            if (!currentChatUser) {
                alert('Please select a user to call');
                return;
            }

            if (isCallActive) {
                alert('You are already in a call');
                return;
            }

            try {
                currentCallType = 'video';
                await initializeCall('video');
                showOutgoingCall();
                
                // Create call record in database
                currentCallId = database.ref('calls').push().key;
                const callData = {
                    callId: currentCallId,
                    callerId: currentUser.uid,
                    receiverId: currentChatUser,
                    type: 'video',
                    status: 'calling',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref('calls/' + currentCallId).set(callData);
                
                // Set timeout for call (30 seconds)
                setTimeout(() => {
                    if (currentCallId && !isCallActive) {
                        cancelCall();
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Error starting video call:', error);
                alert('Failed to start call: ' + error.message);
            }
        }

        // Initialize Call (Get user media and create peer connection)
        async function initializeCall(type) {
            try {
                console.log('🎯 Initializing call with type:', type);
                
                // Get user media with proper constraints
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: type === 'video' ? {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    } : false
                };
                
                console.log('📱 Requesting media with constraints:', constraints);
                
                try {
                    localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('✅ Got local stream:', localStream);
                    
                    // Set local video immediately for video calls
                    if (type === 'video') {
                        const localVideo = document.getElementById('localVideo');
                        if (localVideo) {
                            localVideo.srcObject = localStream;
                            localVideo.muted = true; // Prevent feedback
                            localVideo.play().catch(e => console.log('Local video play error:', e));
                            console.log('✅ Local video stream set');
                        }
                    }
                    
                } catch (mediaError) {
                    console.error("Media permission error: ", mediaError);
                    alert("Camera ya mic access allow karo. Please allow camera and microphone access.");
                    throw mediaError;
                }
                
                // Create peer connection
                localPeerConnection = new RTCPeerConnection(rtcConfiguration);
                console.log('🔗 Created peer connection');
                
                // Add local stream tracks to peer connection
                localStream.getTracks().forEach(track => {
                    console.log('➕ Adding track to peer connection:', track.kind);
                    localPeerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream - FIXED VERSION
                localPeerConnection.ontrack = function(event) {
                    console.log('📺 Received remote stream:', event.streams[0]);
                    remoteStream = event.streams[0];
                    
                    // Set remote video for video calls
                    if (currentCallType === 'video') {
                        const remoteVideo = document.getElementById('remoteVideo');
                        if (remoteVideo) {
                            remoteVideo.srcObject = remoteStream;
                            remoteVideo.autoplay = true;
                            remoteVideo.playsInline = true;
                            remoteVideo.play().then(() => {
                                console.log('✅ Remote video playing successfully');
                            }).catch(e => {
                                console.log('Remote video play error:', e);
                                // Try to play again after a short delay
                                setTimeout(() => {
                                    remoteVideo.play().catch(e2 => console.log('Second attempt failed:', e2));
                                }, 1000);
                            });
                        }
                    }
                    
                    // Set remote audio for both audio and video calls
                    const remoteAudio = document.getElementById('remoteAudio');
                    if (remoteAudio) {
                        remoteAudio.srcObject = remoteStream;
                        remoteAudio.autoplay = true;
                        remoteAudio.play().then(() => {
                            console.log('✅ Remote audio playing successfully');
                        }).catch(e => {
                            console.log('Remote audio play error:', e);
                            // Try to play again after a short delay
                            setTimeout(() => {
                                remoteAudio.play().catch(e2 => console.log('Audio second attempt failed:', e2));
                            }, 1000);
                        });
                    }
                };
                
                // Handle ICE candidates - FIXED VERSION
                localPeerConnection.onicecandidate = (event) => {
                    if (event.candidate && currentCallId) {
                        console.log("🧊 Sending ICE candidate: ", event.candidate);
                        
                        // Save ICE candidate to Firebase for signaling
                        const candidateData = {
                            type: 'ice-candidate',
                            candidate: {
                                candidate: event.candidate.candidate,
                                sdpMLineIndex: event.candidate.sdpMLineIndex,
                                sdpMid: event.candidate.sdpMid
                            }
                        };
                        
                        sendSignalingData(candidateData);
                    } else if (!event.candidate) {
                        console.log("🧊 ICE gathering completed");
                    }
                };
                
                // Handle connection state changes
                localPeerConnection.onconnectionstatechange = () => {
                    console.log('🔗 Connection state:', localPeerConnection.connectionState);
                    if (localPeerConnection.connectionState === 'connected') {
                        console.log('✅ Call connected successfully');
                        startCallTimer();
                    } else if (localPeerConnection.connectionState === 'disconnected' || 
                              localPeerConnection.connectionState === 'failed') {
                        console.log('❌ Call connection failed or disconnected');
                        endCall();
                    }
                };
                
                // Handle ICE connection state changes
                localPeerConnection.oniceconnectionstatechange = () => {
                    console.log('🧊 ICE connection state:', localPeerConnection.iceConnectionState);
                };
                
                console.log('✅ Call initialization completed');
                
            } catch (error) {
                console.error('❌ Error initializing call:', error);
                throw error;
            }
        }

        // Handle Incoming Call
        async function handleIncomingCall(callData) {
            currentCallId = callData.callId;
            currentCallType = callData.type;
            
            // Get caller info
            const callerSnapshot = await database.ref('users/' + callData.callerId).once('value');
            const callerData = callerSnapshot.val();
            
            if (callerData) {
                document.getElementById('incomingCallerImage').src = callerData.photoURL;
                document.getElementById('incomingCallerName').textContent = callerData.username;
                document.getElementById('incomingCallType').textContent = callData.type;
                
                showIncomingCall();
                
                // Play ringtone (if audio is supported)
                playRingtone();
            }
        }

        // Accept Call
        async function acceptCall() {
            try {
                console.log('🎯 Accepting call...');
                
                // Initialize call
                await initializeCall(currentCallType);
                
                // Update call status
                await database.ref('calls/' + currentCallId).update({
                    status: 'accepted'
                });
                
                console.log('✅ Call status updated to accepted');
                
                // Wait a moment for the offer to arrive
                setTimeout(async () => {
                    try {
                        // Create answer
                        const offer = await getStoredOffer();
                        console.log('📥 Retrieved offer:', offer);
                        
                        if (offer) {
                            await localPeerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                            console.log('✅ Remote description set');
                            
                            const answer = await localPeerConnection.createAnswer();
                            await localPeerConnection.setLocalDescription(answer);
                            console.log('✅ Answer created and set');
                            
                            // Send answer
                            await sendSignalingData({
                                type: 'answer',
                                answer: answer
                            });
                            console.log('📤 Answer sent');
                        }
                        
                        showActiveCall();
                        isCallActive = true;
                        
                    } catch (error) {
                        console.error('Error in delayed accept process:', error);
                        rejectCall();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error accepting call:', error);
                rejectCall();
            }
        }

        // Reject Call
        async function rejectCall() {
            if (currentCallId) {
                await database.ref('calls/' + currentCallId).update({
                    status: 'rejected'
                });
            }
            
            cleanupCall();
            hideCallModal();
        }

        // Cancel Call
        async function cancelCall() {
            if (currentCallId) {
                await database.ref('calls/' + currentCallId).update({
                    status: 'cancelled'
                });
            }
            
            cleanupCall();
            hideCallModal();
        }

        // End Call
        async function endCall() {
            if (currentCallId) {
                await database.ref('calls/' + currentCallId).update({
                    status: 'ended'
                });
            }
            
            cleanupCall();
            hideCallModal();
        }

        // Handle Call Status Changes
        async function handleCallStatusChange(callData) {
            console.log('📞 Call status changed:', callData.status);
            
            switch (callData.status) {
                case 'accepted':
                    if (callData.callerId === currentUser.uid) {
                        console.log('📞 Caller side - creating offer...');
                        
                        try {
                            // Caller side - create offer
                            const offer = await localPeerConnection.createOffer({
                                offerToReceiveAudio: true,
                                offerToReceiveVideo: currentCallType === 'video'
                            });
                            await localPeerConnection.setLocalDescription(offer);
                            console.log('✅ Offer created and set');
                            
                            await sendSignalingData({
                                type: 'offer',
                                offer: offer
                            });
                            console.log('📤 Offer sent');
                            
                            showActiveCall();
                            isCallActive = true;
                            
                        } catch (error) {
                            console.error('Error creating offer:', error);
                            endCall();
                        }
                    }
                    break;
                    
                case 'rejected':
                case 'cancelled':
                case 'ended':
                    cleanupCall();
                    hideCallModal();
                    break;
            }
        }

        // Handle Signaling Data
        async function handleSignalingData(signalingData) {
            try {
                console.log('📡 Handling signaling data:', signalingData.type);
                
                if (!localPeerConnection) {
                    console.log('⚠️ No peer connection available');
                    return;
                }
                
                switch (signalingData.type) {
                    case 'offer':
                        console.log('📥 Processing offer...');
                        await localPeerConnection.setRemoteDescription(new RTCSessionDescription(signalingData.offer));
                        console.log('✅ Offer processed');
                        break;
                        
                    case 'answer':
                        console.log('📥 Processing answer...');
                        await localPeerConnection.setRemoteDescription(new RTCSessionDescription(signalingData.answer));
                        console.log('✅ Answer processed');
                        break;
                        
                    case 'ice-candidate':
                        console.log('📥 Processing ICE candidate...');
                        await localPeerConnection.addIceCandidate(new RTCIceCandidate(signalingData.candidate));
                        console.log('✅ ICE candidate processed');
                        break;
                }
                
                // Remove processed signaling data
                database.ref('signaling/' + signalingData.id).remove();
                
            } catch (error) {
                console.error('Error handling signaling data:', error);
            }
        }

        // Send Signaling Data
        async function sendSignalingData(data) {
            if (!currentCallId) return;
            
            const signalingId = database.ref('signaling').push().key;
            const signalingData = {
                id: signalingId,
                callId: currentCallId,
                senderId: currentUser.uid,
                receiverId: currentChatUser,
                ...data,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            await database.ref('signaling/' + signalingId).set(signalingData);
        }

        // Get Stored Offer (for receiver)
        async function getStoredOffer() {
            const signalingSnapshot = await database.ref('signaling')
                .orderByChild('callId')
                .equalTo(currentCallId)
                .once('value');
            
            let offer = null;
            signalingSnapshot.forEach((childSnapshot) => {
                const data = childSnapshot.val();
                if (data.type === 'offer') {
                    offer = data.offer;
                }
            });
            
            return offer;
        }

        // Toggle Mute
        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;
                    
                    const muteBtn = document.getElementById('muteBtn');
                    muteBtn.innerHTML = isMuted ? '🔇' : '🎤';
                    muteBtn.className = isMuted ? 
                        'bg-red-500 text-white p-3 rounded-full hover:bg-red-600 transition-colors' :
                        'bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600 transition-colors';
                }
            }
        }

        // Toggle Video
        function toggleVideo() {
            if (localStream && currentCallType === 'video') {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoEnabled = videoTrack.enabled;
                    
                    const videoBtn = document.getElementById('videoBtn');
                    videoBtn.innerHTML = isVideoEnabled ? '📹' : '📷';
                    videoBtn.className = isVideoEnabled ? 
                        'bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600 transition-colors' :
                        'bg-red-500 text-white p-3 rounded-full hover:bg-red-600 transition-colors';
                }
            }
        }

        // Show Call Modals
        function showIncomingCall() {
            document.getElementById('callModal').classList.remove('hidden');
            document.getElementById('incomingCall').classList.remove('hidden');
            document.getElementById('outgoingCall').classList.add('hidden');
            document.getElementById('activeCall').classList.add('hidden');
        }

        function showOutgoingCall() {
            // Get receiver info
            database.ref('users/' + currentChatUser).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('outgoingCallerImage').src = userData.photoURL;
                    document.getElementById('outgoingCallerName').textContent = userData.username;
                    document.getElementById('outgoingCallIcon').textContent = currentCallType === 'video' ? '📹' : '📞';
                }
            });
            
            document.getElementById('callModal').classList.remove('hidden');
            document.getElementById('incomingCall').classList.add('hidden');
            document.getElementById('outgoingCall').classList.remove('hidden');
            document.getElementById('activeCall').classList.add('hidden');
        }

        function showActiveCall() {
            console.log('📺 Showing active call UI...');
            
            // Get other user info
            const otherUserId = currentChatUser;
            database.ref('users/' + otherUserId).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('activeCallerImage').src = userData.photoURL;
                    document.getElementById('activeCallerName').textContent = userData.username;
                }
            });
            
            // Show/hide video elements
            const videoContainer = document.getElementById('videoContainer');
            const videoBtn = document.getElementById('videoBtn');
            
            if (currentCallType === 'video') {
                console.log('📹 Setting up video call UI...');
                videoContainer.classList.remove('hidden');
                videoBtn.classList.remove('hidden');
                
                // Set local video
                const localVideo = document.getElementById('localVideo');
                if (localVideo && localStream) {
                    localVideo.srcObject = localStream;
                    localVideo.play().catch(e => console.log('Local video play error:', e));
                    console.log('✅ Local video set');
                }
                
                // Set remote video if available
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo && remoteStream) {
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.play().catch(e => console.log('Remote video play error:', e));
                    console.log('✅ Remote video set');
                }
            } else {
                console.log('🎵 Setting up audio call UI...');
                videoContainer.classList.add('hidden');
                videoBtn.classList.add('hidden');
            }
            
            document.getElementById('callModal').classList.remove('hidden');
            document.getElementById('incomingCall').classList.add('hidden');
            document.getElementById('outgoingCall').classList.add('hidden');
            document.getElementById('activeCall').classList.remove('hidden');
        }

        function hideCallModal() {
            document.getElementById('callModal').classList.add('hidden');
            document.getElementById('incomingCall').classList.add('hidden');
            document.getElementById('outgoingCall').classList.add('hidden');
            document.getElementById('activeCall').classList.add('hidden');
        }

        // Call Timer
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Date.now() - callStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('callDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopCallTimer() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
        }

        // Cleanup Call
        function cleanupCall() {
            // Stop timer
            stopCallTimer();
            
            // Close peer connection
            if (localPeerConnection) {
                localPeerConnection.close();
                localPeerConnection = null;
            }
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Clear remote stream
            remoteStream = null;
            
            // Reset variables
            currentCallId = null;
            currentCallType = null;
            isCallActive = false;
            isMuted = false;
            isVideoEnabled = true;
            callStartTime = null;
            
            // Clear video elements
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            if (localVideo) localVideo.srcObject = null;
            if (remoteVideo) remoteVideo.srcObject = null;
        }

        // Play Ringtone (simple beep sound)
        function playRingtone() {
            // Create a simple beep sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
                
                // Repeat every 2 seconds while call is incoming
                const ringtoneInterval = setInterval(() => {
                    if (!document.getElementById('incomingCall').classList.contains('hidden')) {
                        const newOscillator = audioContext.createOscillator();
                        const newGainNode = audioContext.createGain();
                        
                        newOscillator.connect(newGainNode);
                        newGainNode.connect(audioContext.destination);
                        
                        newOscillator.frequency.value = 800;
                        newOscillator.type = 'sine';
                        
                        newGainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        newGainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                        
                        newOscillator.start(audioContext.currentTime);
                        newOscillator.stop(audioContext.currentTime + 1);
                    } else {
                        clearInterval(ringtoneInterval);
                    }
                }, 2000);
                
            } catch (error) {
                console.log('Could not play ringtone:', error);
            }
        }

        // Custom Alert System
        function showCustomAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.custom-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'custom-alert fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg max-w-sm transform transition-all duration-300 translate-x-full';
            
            let bgColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = '✅';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = '❌';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    icon = '⚠️';
                    break;
                default:
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    icon = 'ℹ️';
            }
            
            alertDiv.className += ` ${bgColor} ${textColor}`;
            alertDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-lg">${icon}</span>
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                        ✕
                    </button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Animate in
            setTimeout(() => {
                alertDiv.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (alertDiv.parentElement) {
                            alertDiv.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (isCallActive) {
                endCall();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96493bd7a0df91ec',t:'MTc1MzQyMTA5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
