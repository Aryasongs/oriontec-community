<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrioBuzz - Social Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 25%, #4facfe 50%, #00f2fe 75%, #43e97b 100%);
        }
        .gradient-text {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 25%, #4facfe 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .buzz-card {
            transition: all 0.3s ease;
        }
        .buzz-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .sidebar-item {
            transition: all 0.3s ease;
        }
        .sidebar-item:hover {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1));
            transform: translateX(5px);
        }
        .modal-backdrop {
            backdrop-filter: blur(10px);
        }
        .verified-badge {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            margin-left: 4px;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold gradient-text mb-2">OrioBuzz</h1>
                <p class="text-gray-600">Connect with the world</p>
            </div>
            <button id="googleSignIn" class="w-full bg-white border-2 border-gray-300 rounded-full py-3 px-6 flex items-center justify-center hover:bg-gray-50 transition-all duration-300 shadow-lg">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Bar -->
        <div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-2xl font-bold gradient-text">OrioBuzz</h1>
                <div class="flex items-center space-x-4">
                    <img id="topBarUserImage" class="w-8 h-8 rounded-full border-2 border-pink-300" src="" alt="User">
                    <span id="topBarUsername" class="font-medium text-gray-700"></span>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto flex flex-col lg:flex-row">
            <!-- Left Sidebar - Desktop -->
            <div class="hidden lg:block w-64 bg-white h-screen sticky top-16 border-r border-gray-200 p-6">
                <nav class="space-y-4">
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showHome()">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">üè†</span>
                            <span class="font-medium">Home</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showNotifications()">
                        <div class="flex items-center space-x-3 relative">
                            <span class="text-xl">üîî</span>
                            <span class="font-medium">Notifications</span>
                            <span id="notificationBadgeDesktop" class="hidden absolute -top-1 left-5 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showMessages()">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">üí¨</span>
                            <span class="font-medium">Messages</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showProfile()">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">üë§</span>
                            <span class="font-medium">Profile</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="showSettings()">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <span class="font-medium">Settings</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="openBuzzModal()">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">‚úçÔ∏è</span>
                            <span class="font-medium">Create Buzz</span>
                        </div>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl cursor-pointer" onclick="logout()">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">üö™</span>
                            <span class="font-medium">Logout</span>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Mobile Search Bar -->
            <div class="lg:hidden bg-white border-b border-gray-200 p-4">
                <input type="text" id="mobileSearchInput" placeholder="Search users..." class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" oninput="mobileSearchUsers()">
                <div id="mobileSearchResults" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                    <!-- Mobile search results will appear here -->
                </div>
            </div>

            <!-- Mobile Bottom Navigation -->
            <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
                <div class="flex justify-around py-2">
                    <button onclick="showHome()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <span class="text-xl">üè†</span>
                        <span class="text-xs">Home</span>
                    </button>
                    <button onclick="showNotifications()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500 relative">
                        <span class="text-xl">üîî</span>
                        <span class="text-xs">Notifications</span>
                        <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    <button onclick="showMessages()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <span class="text-xl">üí¨</span>
                        <span class="text-xs">Messages</span>
                    </button>
                    <button onclick="showProfile()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <span class="text-xl">üë§</span>
                        <span class="text-xs">Profile</span>
                    </button>
                    <button onclick="openBuzzModal()" class="flex flex-col items-center p-2 text-gray-600 hover:text-pink-500">
                        <span class="text-xl">‚úçÔ∏è</span>
                        <span class="text-xs">Create</span>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 lg:max-w-2xl">
                <!-- Home Feed -->
                <div id="homeFeed" class="p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Latest Buzz</h2>
                    <div id="buzzFeed" class="space-y-4 lg:space-y-6">
                        <!-- Buzz posts will be loaded here -->
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profilePage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <div class="bg-white rounded-2xl shadow-lg p-4 lg:p-8 mb-6">
                        <div class="flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-6">
                            <img id="profileImage" class="w-20 h-20 lg:w-24 lg:h-24 rounded-full border-4 border-pink-300 mx-auto sm:mx-0" src="" alt="Profile">
                            <div class="flex-1 text-center sm:text-left">
                                <div class="flex items-center justify-center sm:justify-start space-x-2 mb-2">
                                    <h2 id="profileName" class="text-xl lg:text-2xl font-bold"></h2>
                                    <img id="profileVerified" src="https://community.oriontec.xyz/verify.png" alt="Verified" class="hidden verified-badge">
                                </div>
                                <p id="profileUsername" class="text-gray-600 mb-2"></p>
                                <p id="profileLocation" class="text-gray-500 text-sm mb-2">üìç <span id="locationText">Location not set</span></p>
                                <p id="profileBio" class="text-gray-700 mb-4"></p>
                                <div class="flex justify-center sm:justify-start space-x-4 mb-4">
                                    <span onclick="showFollowersPage('following')" class="text-sm cursor-pointer hover:text-pink-500"><strong id="followingCount">0</strong> Following</span>
                                    <span onclick="showFollowersPage('followers')" class="text-sm cursor-pointer hover:text-pink-500"><strong id="followersCount">0</strong> Followers</span>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="openEditProfile()" class="gradient-bg text-white px-4 lg:px-6 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                                        Edit Profile
                                    </button>
                                    <button onclick="openProfileSettings()" class="border border-gray-300 text-gray-700 px-4 lg:px-6 py-2 rounded-full hover:bg-gray-50 transition-colors text-sm lg:text-base">
                                        ‚öôÔ∏è Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4 mb-6">
                        <button id="buzzTab" onclick="showBuzzTab()" class="px-4 py-2 rounded-full bg-pink-500 text-white">Buzz</button>
                        <button id="repliesTab" onclick="showRepliesTab()" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700">Replies</button>
                        <button id="resharesTab" onclick="showResharesTab()" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700">Reshares</button>
                    </div>
                    <div id="userBuzzFeed" class="space-y-4 lg:space-y-6">
                        <!-- User's buzz posts will be loaded here -->
                    </div>
                    <div id="userRepliesFeed" class="hidden space-y-4 lg:space-y-6">
                        <!-- User's replies will be loaded here -->
                    </div>
                    <div id="userResharesFeed" class="hidden space-y-4 lg:space-y-6">
                        <!-- User's reshares will be loaded here -->
                    </div>
                </div>

                <!-- Notifications Page -->
                <div id="notificationsPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Notifications</h2>
                    <div id="notificationsFeed" class="space-y-4">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>

                <!-- Messages Page -->
                <div id="messagesPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Messages</h2>
                    <div class="flex h-96 bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div class="w-1/3 border-r border-gray-200">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="font-bold text-lg">Conversations</h3>
                            </div>
                            <div id="conversationsList" class="overflow-y-auto h-full">
                                <!-- Conversations will be loaded here -->
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col">
                            <div id="chatArea" class="hidden flex flex-col h-full">
                                <div class="flex items-center space-x-3 p-4 border-b border-gray-200 bg-gray-50">
                                    <div class="relative">
                                        <img id="chatUserImage" class="w-10 h-10 rounded-full border-2 border-pink-300" src="" alt="User">
                                        <div id="chatUserOnlineIndicator" class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <h4 id="chatUserName" class="font-bold"></h4>
                                        <p id="chatUserStatus" class="text-sm text-gray-500">Offline</p>
                                    </div>
                                    <button onclick="shareProfile(currentChatUser)" class="text-gray-500 hover:text-pink-500 transition-colors">
                                        üîó
                                    </button>
                                </div>
                                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                                    <!-- Messages will appear here -->
                                </div>
                                <div id="typingIndicator" class="hidden px-4 py-2 text-sm text-gray-500 italic">
                                    <span id="typingUsername"></span> is typing...
                                </div>
                                <div class="p-4 border-t border-gray-200 bg-white">
                                    <div class="flex space-x-2">
                                        <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" oninput="handleTyping()">
                                        <button id="sendMessageBtn" class="gradient-bg text-white px-6 py-3 rounded-full hover:opacity-90 transition-opacity">
                                            <span class="hidden sm:inline">Send</span>
                                            <span class="sm:hidden">üì§</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="noChatSelected" class="flex items-center justify-center h-full text-gray-500">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">üí¨</div>
                                    <h3 class="text-xl font-bold mb-2">Select a conversation</h3>
                                    <p>Choose a conversation to start messaging</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 gradient-text">Settings</h2>
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Privacy Settings</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span>Private Account</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="privateAccount" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Show Online Status</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="showOnlineStatus" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Notification Settings</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span>Push Notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="pushNotifications" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Email Notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="emailNotifications" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Verification</h3>
                            <div class="space-y-3">
                                <button onclick="openVerificationModal()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl">
                                    ‚úÖ Get Verified
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Account Actions</h3>
                            <div class="space-y-3">
                                <button onclick="exportData()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl">
                                    üì• Export My Data
                                </button>
                                <button onclick="openAccountSwitcher()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl">
                                    üîÑ Switch Account
                                </button>
                                <button onclick="logout()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl">
                                    üö™ Logout
                                </button>
                                <button onclick="deactivateAccount()" class="w-full text-left p-3 hover:bg-gray-50 rounded-xl text-red-600">
                                    ‚ö†Ô∏è Deactivate Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Followers Page -->
                <div id="followersPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <button onclick="goBack()" class="text-pink-500 hover:text-pink-700">‚Üê Back</button>
                        <h2 id="followersTitle" class="text-xl lg:text-2xl font-bold gradient-text">Followers</h2>
                    </div>
                    <div class="flex space-x-4 mb-6">
                        <button id="followersTab" onclick="showFollowersTab()" class="px-4 py-2 rounded-full bg-pink-500 text-white">Followers</button>
                        <button id="followingTab" onclick="showFollowingTab()" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700">Following</button>
                    </div>
                    <div id="followersContent" class="space-y-4">
                        <!-- Followers/Following list will be loaded here -->
                    </div>
                </div>

                <!-- Hashtag Page -->
                <div id="hashtagPage" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <button onclick="goBackFromHashtag()" class="text-pink-500 hover:text-pink-700">‚Üê Back</button>
                        <div>
                            <h2 id="hashtagTitle" class="text-xl lg:text-2xl font-bold gradient-text">#hashtag</h2>
                            <p id="hashtagCount" class="text-sm text-gray-600">0 posts</p>
                        </div>
                    </div>
                    <div id="hashtagFeed" class="space-y-4 lg:space-y-6">
                        <!-- Hashtag posts will be loaded here -->
                    </div>
                </div>

                <!-- Other User Profile Page -->
                <div id="otherUserProfile" class="hidden p-4 lg:p-6 pb-20 lg:pb-6">
                    <div class="bg-white rounded-2xl shadow-lg p-4 lg:p-8 mb-6">
                        <div class="flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-6">
                            <img id="otherProfileImage" class="w-20 h-20 lg:w-24 lg:h-24 rounded-full border-4 border-pink-300 mx-auto sm:mx-0" src="" alt="Profile">
                            <div class="flex-1 text-center sm:text-left">
                                <div class="flex items-center justify-center sm:justify-start space-x-2 mb-2">
                                    <h2 id="otherProfileName" class="text-xl lg:text-2xl font-bold"></h2>
                                    <img id="otherProfileVerified" src="https://community.oriontec.xyz/verify.png" alt="Verified" class="hidden verified-badge">
                                </div>
                                <p id="otherProfileUsername" class="text-gray-600 mb-2"></p>
                                <p id="otherProfileLocation" class="text-gray-500 text-sm mb-2">üìç <span id="otherLocationText">Location not set</span></p>
                                <p id="otherProfileBio" class="text-gray-700 mb-4"></p>
                                <div class="flex justify-center sm:justify-start space-x-4 mb-4">
                                    <span onclick="showOtherUserFollowersPage('following')" class="text-sm cursor-pointer hover:text-pink-500"><strong id="otherFollowingCount">0</strong> Following</span>
                                    <span onclick="showOtherUserFollowersPage('followers')" class="text-sm cursor-pointer hover:text-pink-500"><strong id="otherFollowersCount">0</strong> Followers</span>
                                </div>
                                <div class="flex justify-center sm:justify-start space-x-3">
                                    <button id="followBtn" onclick="toggleFollow()" class="gradient-bg text-white px-4 lg:px-6 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                                        Follow
                                    </button>
                                    <button onclick="startChatWithUser()" class="border border-pink-500 text-pink-500 px-4 lg:px-6 py-2 rounded-full hover:bg-pink-50 transition-colors text-sm lg:text-base">
                                        üí¨ Message
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-lg lg:text-xl font-bold mb-4">Buzz Posts</h3>
                    <div id="otherUserBuzzFeed" class="space-y-4 lg:space-y-6">
                        <!-- Other user's buzz posts will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - Desktop & Tablet -->
            <div class="hidden md:block w-full md:w-80 bg-white h-screen sticky top-16 border-l border-gray-200 p-4 lg:p-6">
                <div class="mb-6">
                    <input type="text" id="searchInput" placeholder="Search users..." class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" oninput="searchUsers()">
                    <div id="searchResults" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                        <!-- Search results will appear here -->
                    </div>
                </div>
                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Verified Users</h3>
                    <div id="verifiedUsers" class="space-y-3">
                        <!-- Verified users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Buzz Modal -->
    <div id="buzzModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Create Buzz</h3>
                <button onclick="closeBuzzModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div class="flex items-start space-x-3 lg:space-x-4 mb-4">
                <img id="modalUserImage" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300" src="" alt="User">
                <div class="flex-1 relative">
                    <textarea id="buzzContent" placeholder="What's buzzing? Use #hashtags and @mentions" class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" rows="4" oninput="handleBuzzInput()"></textarea>
                    <div id="hashtagSuggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-xl shadow-lg max-h-40 overflow-y-auto z-10">
                        <!-- Hashtag suggestions will appear here -->
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <button class="text-gray-400 cursor-not-allowed flex items-center space-x-2 text-sm lg:text-base" disabled>
                    <span>üì∑</span>
                    <span>Add Image - Coming Soon</span>
                </button>
            </div>
            <div class="flex justify-end">
                <button id="postBuzzBtn" onclick="postBuzz()" class="gradient-bg text-white px-6 lg:px-8 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    Post Buzz
                </button>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Get Verified ‚úÖ</h3>
                <button onclick="closeVerificationModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Full Name *</label>
                    <input type="text" id="verifyName" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Age *</label>
                    <input type="number" id="verifyAge" min="13" max="100" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Category *</label>
                    <select id="verifyCategory" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" required>
                        <option value="">Select Category</option>
                        <option value="professional">Professional</option>
                        <option value="business">Business</option>
                        <option value="creator">Content Creator</option>
                        <option value="public_figure">Public Figure</option>
                        <option value="organization">Organization</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Verification Link *</label>
                    <div class="flex">
                        <span class="bg-gray-100 px-3 py-3 border border-r-0 border-gray-300 rounded-l-xl text-sm">www.orintec.xyz/</span>
                        <input type="text" id="verifyLink" placeholder="your-username" class="flex-1 p-3 border border-gray-300 rounded-r-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" required>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Your username must appear on this link for verification</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl">
                    <h4 class="font-medium text-blue-800 mb-2">Verification Requirements:</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>‚Ä¢ Your name must appear on the provided link</li>
                        <li>‚Ä¢ Link will be checked within 5 minutes</li>
                        <li>‚Ä¢ You'll receive a notification about the result</li>
                        <li>‚Ä¢ Verification is free and permanent</li>
                    </ul>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="submitVerification()" class="gradient-bg text-white px-6 lg:px-8 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    Submit for Verification
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Profile Settings</h3>
                <button onclick="closeProfileSettings()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Account Settings</h3>
                    <div class="space-y-3">
                        <button onclick="openEditProfile(); closeProfileSettings();" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl flex items-center space-x-3">
                            <span>‚úèÔ∏è</span>
                            <span>Edit Profile</span>
                        </button>
                        <button onclick="openVerificationModal(); closeProfileSettings();" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl flex items-center space-x-3">
                            <span>‚úÖ</span>
                            <span>Get Verified</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Privacy Settings</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Private Account</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profilePrivateAccount" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Show Online Status</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profileShowOnlineStatus" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Notification Settings</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Push Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profilePushNotifications" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Email Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="profileEmailNotifications" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4">
                    <h3 class="font-bold mb-4 text-sm lg:text-base">Account Actions</h3>
                    <div class="space-y-3">
                        <button onclick="exportData()" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl flex items-center space-x-3">
                            <span>üì•</span>
                            <span>Export My Data</span>
                        </button>
                        <button onclick="deactivateAccount()" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl text-red-600 flex items-center space-x-3">
                            <span>‚ö†Ô∏è</span>
                            <span>Deactivate Account</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="saveProfileSettings()" class="gradient-bg text-white px-6 lg:px-8 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Comments</h3>
                <button onclick="closeCommentModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div id="commentsContainer" class="space-y-4 mb-6 max-h-60 overflow-y-auto">
                <!-- Comments will be loaded here -->
            </div>
            <div class="flex items-start space-x-3">
                <img id="commentUserImage" class="w-8 h-8 rounded-full border-2 border-pink-300" src="" alt="User">
                <div class="flex-1">
                    <textarea id="commentContent" placeholder="Write a comment..." class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" rows="2"></textarea>
                    <div class="flex justify-end mt-2">
                        <button onclick="postComment()" class="gradient-bg text-white px-4 py-2 rounded-full hover:opacity-90 transition-opacity text-sm">
                            Post Comment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Report Buzz</h3>
                <button onclick="closeReportModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 text-sm">Why are you reporting this buzz?</p>
                <div class="space-y-3">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="spam" class="text-pink-500">
                        <span>Spam or misleading content</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="harassment" class="text-pink-500">
                        <span>Harassment or bullying</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="hate" class="text-pink-500">
                        <span>Hate speech or discrimination</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="violence" class="text-pink-500">
                        <span>Violence or threats</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="inappropriate" class="text-pink-500">
                        <span>Inappropriate content</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="copyright" class="text-pink-500">
                        <span>Copyright violation</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reportReason" value="other" class="text-pink-500">
                        <span>Other</span>
                    </label>
                </div>
                <textarea id="reportDetails" placeholder="Additional details (optional)" class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" rows="3"></textarea>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="submitReport()" class="bg-red-500 text-white px-6 py-2 rounded-full hover:bg-red-600 transition-colors text-sm">
                    Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Account Switcher Modal -->
    <div id="accountSwitcherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Switch Account</h3>
                <button onclick="closeAccountSwitcher()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div id="savedAccountsList" class="space-y-3 mb-6">
                <!-- Saved accounts will be loaded here -->
            </div>
            <div class="border-t pt-4">
                <button onclick="addNewAccount()" class="w-full gradient-bg text-white px-6 py-3 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    ‚ûï Add New Account
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-4 lg:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h3 class="text-lg lg:text-xl font-bold">Edit Profile</h3>
                <button onclick="closeEditProfile()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Display Name</label>
                    <input type="text" id="editDisplayName" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" placeholder="Your display name">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="editName" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" onchange="checkUsernameAvailability()" placeholder="username (no spaces)">
                    <p id="usernameStatus" class="text-xs mt-1"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bio</label>
                    <textarea id="editBio" class="w-full p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Location</label>
                    <input type="text" id="editLocation" placeholder="Enter your location" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Website</label>
                    <input type="url" id="editWebsite" placeholder="https://yourwebsite.com" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm lg:text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Profile Photo</label>
                    <button class="w-full p-3 border border-gray-300 rounded-xl bg-gray-100 text-gray-400 text-sm cursor-not-allowed" disabled>
                        Coming Soon - Photo Upload
                    </button>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="updateProfile()" class="gradient-bg text-white px-6 lg:px-8 py-2 rounded-full hover:opacity-90 transition-opacity text-sm lg:text-base">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "chat-d647c.firebaseapp.com",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: ". ",
            appId: "1:. :web:7248a0983dcf0d45a87418"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        let currentUser = null;
        let currentChatUser = null;
        let currentViewingUser = null;
        let lastPage = 'home';
        let currentFollowersUserId = null;

        // Authentication State Observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                saveUserToDatabase(user);
                showMainApp();
                loadBuzzFeed();
                loadVerifiedUsers();
                updateOnlineStatus(true);
                handleURLHash();
            } else {
                showLoginScreen();
                updateOnlineStatus(false);
            }
        });

        // URL Hash Navigation
        function handleURLHash() {
            const hash = window.location.hash.substring(1);
            if (hash.startsWith('buzz')) {
                const buzzId = hash.replace('buzz', '');
                openBuzzFromURL(buzzId);
            } else if (hash.startsWith('profile')) {
                const userId = hash.replace('profile', '');
                viewUserProfile(userId);
            } else if (hash === 'home') {
                showHome();
            }
        }

        // Listen for hash changes
        window.addEventListener('hashchange', handleURLHash);

        // Open buzz from URL
        function openBuzzFromURL(buzzId) {
            database.ref('buzz/' + buzzId).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    showHome();
                    // Scroll to buzz after a short delay
                    setTimeout(() => {
                        const buzzElement = document.querySelector(`[data-buzz-id="${buzzId}"]`);
                        if (buzzElement) {
                            buzzElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            buzzElement.style.border = '2px solid #f093fb';
                            setTimeout(() => {
                                buzzElement.style.border = '';
                            }, 3000);
                        }
                    }, 500);
                }
            });
        }

        // Share Buzz
        function shareBuzz(buzzId) {
            const url = window.location.origin + window.location.pathname + '#buzz' + buzzId;
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this buzz on OrioBuzz',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Buzz link copied to clipboard!');
                });
            }
        }

        // Share Profile
        function shareProfile(userId) {
            const url = window.location.origin + window.location.pathname + '#profile' + userId;
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this profile on OrioBuzz',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Profile link copied to clipboard!');
                });
            }
        }

        // Online Status Management
        function updateOnlineStatus(isOnline) {
            if (!currentUser) return;
            
            const userStatusRef = database.ref('userStatus/' + currentUser.uid);
            if (isOnline) {
                userStatusRef.set({
                    online: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Set offline when user disconnects
                userStatusRef.onDisconnect().set({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                userStatusRef.set({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Get user online status
        function getUserOnlineStatus(userId, callback) {
            database.ref('userStatus/' + userId).on('value', (snapshot) => {
                const status = snapshot.val();
                callback(status);
            });
        }

        // Google Sign In
        document.getElementById('googleSignIn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                console.error('Sign in error:', error);
            });
        });

        // Generate unique random username
        async function generateRandomUsername() {
            const adjectives = ['Cool', 'Smart', 'Happy', 'Bright', 'Swift', 'Bold', 'Kind', 'Wise', 'Fun', 'Nice'];
            const nouns = ['User', 'Buzz', 'Star', 'Wave', 'Fire', 'Sky', 'Moon', 'Sun', 'Wind', 'Rock'];
            
            let username;
            let isUnique = false;
            let attempts = 0;
            
            while (!isUnique && attempts < 10) {
                const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
                const randomNum = Math.floor(Math.random() * 10000);
                username = (randomAdj + randomNoun + randomNum).toLowerCase();
                
                // Check if username already exists
                const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
                if (!usersSnapshot.exists()) {
                    isUnique = true;
                } else {
                    attempts++;
                }
            }
            
            return username;
        }

        // Extract hashtags from content
        function extractHashtags(content) {
            const hashtagRegex = /#(\w+)/g;
            const hashtags = [];
            let match;
            while ((match = hashtagRegex.exec(content)) !== null) {
                hashtags.push(match[1].toLowerCase());
            }
            return [...new Set(hashtags)]; // Remove duplicates
        }

        // Extract mentions from content
        function extractMentions(content) {
            const mentionRegex = /@(\w+)/g;
            const mentions = [];
            let match;
            while ((match = mentionRegex.exec(content)) !== null) {
                mentions.push(match[1].toLowerCase());
            }
            return [...new Set(mentions)]; // Remove duplicates
        }

        // Process content for display with clickable hashtags and mentions
        function processContentForDisplay(content) {
            // Make hashtags clickable (blue color)
            content = content.replace(/#(\w+)/g, '<span class="text-blue-500 cursor-pointer hover:text-blue-700 font-medium" onclick="showHashtagPage(\'$1\')">#$1</span>');
            
            // Make mentions clickable (blue color)
            content = content.replace(/@(\w+)/g, '<span class="text-blue-500 cursor-pointer hover:text-blue-700 font-medium" onclick="viewUserByUsername(\'$1\')">@$1</span>');
            
            return content;
        }

        // Show hashtag page
        function showHashtagPage(hashtag) {
            hideAllPages();
            document.getElementById('hashtagPage').classList.remove('hidden');
            document.getElementById('hashtagTitle').textContent = '#' + hashtag;
            
            // Load hashtag posts count
            database.ref('hashtags/' + hashtag.toLowerCase()).once('value').then((snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('hashtagCount').textContent = count + ' post' + (count !== 1 ? 's' : '');
            });
            
            loadHashtagPosts(hashtag.toLowerCase());
        }

        // Load hashtag posts
        function loadHashtagPosts(hashtag) {
            const hashtagPostsRef = database.ref('hashtagPosts/' + hashtag);
            hashtagPostsRef.once('value').then((snapshot) => {
                const hashtagFeed = document.getElementById('hashtagFeed');
                hashtagFeed.innerHTML = '';
                
                if (!snapshot.exists()) {
                    hashtagFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No posts found for this hashtag</p>';
                    return;
                }
                
                const buzzIds = Object.keys(snapshot.val());
                const buzzPromises = buzzIds.map(buzzId => 
                    database.ref('buzz/' + buzzId).once('value')
                );
                
                Promise.all(buzzPromises).then((buzzSnapshots) => {
                    const buzzes = buzzSnapshots
                        .map(snapshot => snapshot.val())
                        .filter(buzz => buzz !== null)
                        .sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (buzzes.length === 0) {
                        hashtagFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No posts found for this hashtag</p>';
                        return;
                    }
                    
                    buzzes.forEach((buzz) => {
                        const buzzElement = createBuzzElement(buzz);
                        hashtagFeed.appendChild(buzzElement);
                    });
                });
            });
        }

        // View user by username
        async function viewUserByUsername(username) {
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username.toLowerCase()).once('value');
            
            if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                const userId = Object.keys(users)[0];
                viewUserProfile(userId);
            } else {
                alert('User not found');
            }
        }

        // Go back from hashtag page
        function goBackFromHashtag() {
            showHome();
        }

        // Remove mention from buzz
        async function removeMention(buzzId) {
            if (!currentUser) return;
            
            if (confirm('Remove your mention from this buzz?')) {
                const buzzRef = database.ref('buzz/' + buzzId);
                const buzzSnapshot = await buzzRef.once('value');
                const buzzData = buzzSnapshot.val();
                
                if (buzzData && buzzData.mentions) {
                    // Remove current user's username from mentions array
                    const updatedMentions = buzzData.mentions.filter(mention => mention !== currentUser.username);
                    
                    // Update content to remove the mention
                    let updatedContent = buzzData.originalContent || buzzData.content;
                    const mentionRegex = new RegExp(`@${currentUser.username}\\b`, 'gi');
                    updatedContent = updatedContent.replace(mentionRegex, '');
                    
                    // Process content for display again
                    const processedContent = processContentForDisplay(updatedContent);
                    
                    // Update the buzz
                    await buzzRef.update({
                        mentions: updatedMentions,
                        content: processedContent,
                        originalContent: updatedContent
                    });
                    
                    // Reload the feed
                    loadBuzzFeed();
                    
                    alert('Your mention has been removed from this buzz');
                }
            }
        }

        // Generate colorful avatar with initials
        function generateAvatar(name) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'];
            const initial = name ? name.charAt(0).toUpperCase() : 'U';
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            // Draw circle background
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(50, 50, 50, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw initial
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initial, 50, 50);
            
            return canvas.toDataURL();
        }

        // Save user to database
        async function saveUserToDatabase(user) {
            const userRef = database.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');
            
            if (!snapshot.exists()) {
                const displayName = user.displayName || await generateRandomUsername();
                const username = await generateRandomUsername();
                const photoURL = user.photoURL || generateAvatar(displayName);
                
                await userRef.set({
                    uid: user.uid,
                    displayName: displayName,
                    username: username,
                    email: user.email,
                    photoURL: photoURL,
                    bio: '',
                    verified: false,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                // Update existing user if they don't have a photo or display name
                const userData = snapshot.val();
                const updates = {};
                
                if (!userData.photoURL || userData.photoURL === '') {
                    updates.photoURL = generateAvatar(userData.displayName || userData.username);
                }
                
                if (!userData.displayName) {
                    updates.displayName = userData.username;
                }
                
                if (Object.keys(updates).length > 0) {
                    await userRef.update(updates);
                }
            }
        }

        // Show/Hide Screens
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateTopBar();
        }

        function updateTopBar() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('topBarUserImage').src = userData.photoURL;
                        document.getElementById('topBarUsername').textContent = userData.displayName || userData.username;
                        document.getElementById('modalUserImage').src = userData.photoURL;
                    }
                });
            }
        }

        // Search Users
        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then((snapshot) => {
                searchResults.innerHTML = '';
                let hasResults = false;
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    if (user.uid !== currentUser.uid && 
                        (user.username.toLowerCase().includes(searchTerm) || 
                         user.email.toLowerCase().includes(searchTerm))) {
                        
                        hasResults = true;
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-3 p-3 hover:bg-gray-100 cursor-pointer';
                        userDiv.onclick = () => {
                            viewUserProfile(user.uid);
                            searchResults.classList.add('hidden');
                            document.getElementById('searchInput').value = '';
                        };
                        
                        userDiv.innerHTML = `
                            <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${user.photoURL}" alt="User">
                            <div class="flex-1">
                                <div class="flex items-center space-x-1">
                                    <span class="font-medium text-sm">${user.username}</span>
                                    ${user.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                                </div>
                                <p class="text-xs text-gray-600">${user.bio || 'OrioBuzz user'}</p>
                            </div>
                        `;
                        searchResults.appendChild(userDiv);
                    }
                });
                
                if (!hasResults) {
                    searchResults.innerHTML = '<p class="p-3 text-gray-500 text-sm">No users found</p>';
                }
                
                searchResults.classList.remove('hidden');
            });
        }

        // Mobile Search Users
        function mobileSearchUsers() {
            const searchTerm = document.getElementById('mobileSearchInput').value.trim().toLowerCase();
            const searchResults = document.getElementById('mobileSearchResults');
            
            if (searchTerm.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then((snapshot) => {
                searchResults.innerHTML = '';
                let hasResults = false;
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    if (user.uid !== currentUser.uid && 
                        (user.username.toLowerCase().includes(searchTerm) || 
                         user.email.toLowerCase().includes(searchTerm))) {
                        
                        hasResults = true;
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-3 p-3 hover:bg-gray-100 cursor-pointer';
                        userDiv.onclick = () => {
                            viewUserProfile(user.uid);
                            searchResults.classList.add('hidden');
                            document.getElementById('mobileSearchInput').value = '';
                        };
                        
                        userDiv.innerHTML = `
                            <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${user.photoURL}" alt="User">
                            <div class="flex-1">
                                <div class="flex items-center space-x-1">
                                    <span class="font-medium text-sm">${user.username}</span>
                                    ${user.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                                </div>
                                <p class="text-xs text-gray-600">${user.bio || 'OrioBuzz user'}</p>
                            </div>
                        `;
                        searchResults.appendChild(userDiv);
                    }
                });
                
                if (!hasResults) {
                    searchResults.innerHTML = '<p class="p-3 text-gray-500 text-sm">No users found</p>';
                }
                
                searchResults.classList.remove('hidden');
            });
        }

        // Hide search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            const mobileSearchResults = document.getElementById('mobileSearchResults');
            
            if (searchInput && searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
            
            if (mobileSearchInput && mobileSearchResults && !mobileSearchInput.contains(e.target) && !mobileSearchResults.contains(e.target)) {
                mobileSearchResults.classList.add('hidden');
            }
        });

        // Navigation
        function showHome() {
            hideAllPages();
            document.getElementById('homeFeed').classList.remove('hidden');
            loadBuzzFeed();
        }

        function showProfile() {
            hideAllPages();
            document.getElementById('profilePage').classList.remove('hidden');
            loadUserProfile();
            loadUserBuzz();
        }

        function showNotifications() {
            hideAllPages();
            document.getElementById('notificationsPage').classList.remove('hidden');
            loadNotifications();
            clearNotificationBadge();
        }

        // Removed duplicate showMessages function - using the one with message input initialization

        function showSettings() {
            hideAllPages();
            document.getElementById('settingsPage').classList.remove('hidden');
            loadSettings();
        }

        function hideAllPages() {
            document.getElementById('homeFeed').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
            document.getElementById('notificationsPage').classList.add('hidden');
            document.getElementById('messagesPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            document.getElementById('otherUserProfile').classList.add('hidden');
            document.getElementById('followersPage').classList.add('hidden');
            document.getElementById('hashtagPage').classList.add('hidden');
        }

        // Followers Page Functions
        function showFollowersPage(type) {
            lastPage = 'profile';
            currentFollowersUserId = currentUser.uid;
            hideAllPages();
            document.getElementById('followersPage').classList.remove('hidden');
            document.getElementById('followersTitle').textContent = type === 'followers' ? 'Followers' : 'Following';
            
            if (type === 'followers') {
                showFollowersTab();
            } else {
                showFollowingTab();
            }
        }

        function showOtherUserFollowersPage(type) {
            lastPage = 'otherProfile';
            currentFollowersUserId = currentViewingUser;
            hideAllPages();
            document.getElementById('followersPage').classList.remove('hidden');
            document.getElementById('followersTitle').textContent = type === 'followers' ? 'Followers' : 'Following';
            
            if (type === 'followers') {
                showFollowersTab();
            } else {
                showFollowingTab();
            }
        }

        function showFollowersTab() {
            document.getElementById('followersTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('followingTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            loadFollowersList('followers');
        }

        function showFollowingTab() {
            document.getElementById('followingTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('followersTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            loadFollowersList('following');
        }

        function loadFollowersList(type) {
            if (!currentFollowersUserId) return;
            
            const ref = database.ref(type + '/' + currentFollowersUserId);
            ref.once('value').then((snapshot) => {
                const followersContent = document.getElementById('followersContent');
                followersContent.innerHTML = '';
                
                if (!snapshot.exists()) {
                    followersContent.innerHTML = `<p class="text-gray-500 text-center py-8">No ${type} yet</p>`;
                    return;
                }
                
                const userIds = Object.keys(snapshot.val());
                userIds.forEach(userId => {
                    database.ref('users/' + userId).once('value').then((userSnapshot) => {
                        const userData = userSnapshot.val();
                        if (userData) {
                            const userElement = createFollowerElement(userData);
                            followersContent.appendChild(userElement);
                        }
                    });
                });
            });
        }

        function createFollowerElement(userData) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4';
            
            div.innerHTML = `
                <img class="w-12 h-12 rounded-full border-2 border-pink-300" src="${userData.photoURL}" alt="User">
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span onclick="viewUserProfile('${userData.uid}')" class="font-bold cursor-pointer hover:text-pink-500">${userData.username}</span>
                        ${userData.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                    </div>
                    <p class="text-gray-600 text-sm">${userData.bio || 'OrioBuzz user'}</p>
                </div>
                ${userData.uid !== currentUser.uid ? `
                    <button onclick="toggleFollowFromList('${userData.uid}', this)" class="px-4 py-2 rounded-full text-sm transition-colors" id="followBtn-${userData.uid}">
                        Follow
                    </button>
                ` : ''}
            `;
            
            // Check follow status
            if (userData.uid !== currentUser.uid) {
                checkFollowStatusForButton(userData.uid);
            }
            
            return div;
        }

        function checkFollowStatusForButton(userId) {
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            followRef.once('value').then((snapshot) => {
                const followBtn = document.getElementById('followBtn-' + userId);
                if (followBtn) {
                    if (snapshot.exists()) {
                        followBtn.textContent = 'Following';
                        followBtn.className = 'px-4 py-2 rounded-full text-sm bg-gray-500 text-white transition-colors';
                    } else {
                        followBtn.textContent = 'Follow';
                        followBtn.className = 'px-4 py-2 rounded-full text-sm gradient-bg text-white transition-colors';
                    }
                }
            });
        }

        function toggleFollowFromList(userId, button) {
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            const followerRef = database.ref('followers/' + userId + '/' + currentUser.uid);
            
            followRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Unfollow
                    followRef.remove();
                    followerRef.remove();
                    button.textContent = 'Follow';
                    button.className = 'px-4 py-2 rounded-full text-sm gradient-bg text-white transition-colors';
                } else {
                    // Follow
                    followRef.set(true);
                    followerRef.set(true);
                    button.textContent = 'Following';
                    button.className = 'px-4 py-2 rounded-full text-sm bg-gray-500 text-white transition-colors';
                    
                    // Create notification
                    database.ref('users/' + currentUser.uid).once('value').then((userSnapshot) => {
                        const userData = userSnapshot.val();
                        createNotification(userId, 'follow', userData.username + ' started following you');
                    });
                }
            });
        }

        function goBack() {
            if (lastPage === 'profile') {
                showProfile();
            } else if (lastPage === 'otherProfile') {
                viewUserProfile(currentViewingUser);
            } else {
                showHome();
            }
        }

        // Load user profile
        function loadUserProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('profileImage').src = userData.photoURL;
                    document.getElementById('profileName').textContent = userData.displayName || userData.username;
                    document.getElementById('profileUsername').textContent = '@' + userData.username;
                    document.getElementById('profileBio').textContent = userData.bio || 'No bio yet';
                    document.getElementById('locationText').textContent = userData.location || 'Location not set';
                    
                    // Load follower counts
                    loadFollowerCounts(currentUser.uid);
                    
                    if (userData.verified) {
                        document.getElementById('profileVerified').classList.remove('hidden');
                    } else {
                        document.getElementById('profileVerified').classList.add('hidden');
                    }
                }
            });
        }

        // Load follower counts
        function loadFollowerCounts(userId) {
            const followersRef = database.ref('followers/' + userId);
            const followingRef = database.ref('following/' + userId);
            
            followersRef.once('value').then((snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                document.getElementById('followersCount').textContent = count;
                if (document.getElementById('otherFollowersCount')) {
                    document.getElementById('otherFollowersCount').textContent = count;
                }
            });
            
            followingRef.once('value').then((snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                document.getElementById('followingCount').textContent = count;
                if (document.getElementById('otherFollowingCount')) {
                    document.getElementById('otherFollowingCount').textContent = count;
                }
            });
        }

        // Buzz Modal Functions
        function openBuzzModal() {
            document.getElementById('buzzModal').classList.remove('hidden');
        }

        function closeBuzzModal() {
            document.getElementById('buzzModal').classList.add('hidden');
            document.getElementById('buzzContent').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
        }

        // Post Buzz
        async function postBuzz() {
            const content = document.getElementById('buzzContent').value.trim();
            
            if (!content) return;

            const buzzId = database.ref('buzz').push().key;

            // Get user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();

            // Extract hashtags and mentions
            const hashtags = extractHashtags(content);
            const mentions = extractMentions(content);

            // Create buzz object
            const buzzData = {
                buzzId: buzzId,
                uid: currentUser.uid,
                username: userData.username,
                displayName: userData.displayName || userData.username,
                userImage: userData.photoURL,
                verified: userData.verified || false,
                content: processContentForDisplay(content),
                originalContent: content,
                hashtags: hashtags,
                mentions: mentions,
                imageURL: null,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: {},
                rebuzzes: {}
            };

            // Save to database
            database.ref('buzz/' + buzzId).set(buzzData).then(() => {
                // Save hashtags to hashtags collection
                hashtags.forEach(hashtag => {
                    const hashtagRef = database.ref('hashtags/' + hashtag);
                    hashtagRef.transaction((currentCount) => {
                        return (currentCount || 0) + 1;
                    });
                    
                    // Add buzz to hashtag posts
                    database.ref('hashtagPosts/' + hashtag + '/' + buzzId).set(true);
                });

                // Create notifications for mentions
                mentions.forEach(async (mention) => {
                    const mentionedUserSnapshot = await database.ref('users').orderByChild('username').equalTo(mention).once('value');
                    if (mentionedUserSnapshot.exists()) {
                        const mentionedUsers = mentionedUserSnapshot.val();
                        Object.keys(mentionedUsers).forEach(userId => {
                            if (userId !== currentUser.uid) {
                                createNotification(userId, 'mention', `${userData.displayName || userData.username} mentioned you in a buzz`);
                            }
                        });
                    }
                });

                closeBuzzModal();
                loadBuzzFeed();
            });
        }

        // Load Buzz Feed with Smart Algorithm
        function loadBuzzFeed() {
            const buzzRef = database.ref('buzz').orderByChild('timestamp');
            buzzRef.on('value', (snapshot) => {
                const buzzFeed = document.getElementById('buzzFeed');
                buzzFeed.innerHTML = '';
                
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.push(childSnapshot.val());
                });
                
                // Apply smart algorithm
                applySmartFeedAlgorithm(buzzes).then(sortedBuzzes => {
                    sortedBuzzes.forEach((buzz) => {
                        const buzzElement = createBuzzElement(buzz);
                        buzzFeed.appendChild(buzzElement);
                    });
                });
            });
        }

        // Smart Feed Algorithm
        async function applySmartFeedAlgorithm(buzzes) {
            if (!currentUser) return buzzes.reverse();
            
            // Get user's following list
            const followingSnapshot = await database.ref('following/' + currentUser.uid).once('value');
            const following = followingSnapshot.exists() ? Object.keys(followingSnapshot.val()) : [];
            
            // Get user's interactions (likes, comments, rebuzzes)
            const userInteractions = await getUserInteractions();
            
            // Score each buzz
            const scoredBuzzes = buzzes.map(buzz => {
                let score = 0;
                const buzzAge = Date.now() - buzz.timestamp;
                
                // Base score from timestamp (newer = higher)
                score += Math.max(0, 1000 - (buzzAge / 3600000)); // Decrease over hours
                
                // Following boost (highest priority)
                if (following.includes(buzz.uid)) {
                    score += 5000;
                }
                
                // Interaction history boost
                if (userInteractions.likedUsers.includes(buzz.uid)) {
                    score += 2000;
                }
                if (userInteractions.commentedUsers.includes(buzz.uid)) {
                    score += 2500;
                }
                if (userInteractions.rebuzzedUsers.includes(buzz.uid)) {
                    score += 2200;
                }
                
                // Engagement boost
                const likesCount = buzz.likes ? Object.keys(buzz.likes).length : 0;
                const rebuzzesCount = buzz.rebuzzes ? Object.keys(buzz.rebuzzes).length : 0;
                const commentsCount = buzz.comments ? Object.keys(buzz.comments).length : 0;
                
                score += likesCount * 10;
                score += rebuzzesCount * 15;
                score += commentsCount * 20;
                
                // Verified user boost
                if (buzz.verified) {
                    score += 500;
                }
                
                return { ...buzz, score };
            });
            
            // Sort by score (highest first)
            return scoredBuzzes.sort((a, b) => b.score - a.score);
        }

        // Get User Interactions
        async function getUserInteractions() {
            const interactions = {
                likedUsers: [],
                commentedUsers: [],
                rebuzzedUsers: []
            };
            
            // Get all buzzes and check user's interactions
            const buzzSnapshot = await database.ref('buzz').once('value');
            buzzSnapshot.forEach(childSnapshot => {
                const buzz = childSnapshot.val();
                
                if (buzz.likes && buzz.likes[currentUser.uid]) {
                    if (!interactions.likedUsers.includes(buzz.uid)) {
                        interactions.likedUsers.push(buzz.uid);
                    }
                }
                
                if (buzz.rebuzzes && buzz.rebuzzes[currentUser.uid]) {
                    if (!interactions.rebuzzedUsers.includes(buzz.uid)) {
                        interactions.rebuzzedUsers.push(buzz.uid);
                    }
                }
                
                if (buzz.comments) {
                    Object.values(buzz.comments).forEach(comment => {
                        if (comment.uid === currentUser.uid && !interactions.commentedUsers.includes(buzz.uid)) {
                            interactions.commentedUsers.push(buzz.uid);
                        }
                    });
                }
            });
            
            return interactions;
        }

        // Profile Tab Functions
        function showBuzzTab() {
            document.getElementById('buzzTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('repliesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('resharesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            
            document.getElementById('userBuzzFeed').classList.remove('hidden');
            document.getElementById('userRepliesFeed').classList.add('hidden');
            document.getElementById('userResharesFeed').classList.add('hidden');
        }

        function showRepliesTab() {
            document.getElementById('repliesTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('buzzTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('resharesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            
            document.getElementById('userBuzzFeed').classList.add('hidden');
            document.getElementById('userRepliesFeed').classList.remove('hidden');
            document.getElementById('userResharesFeed').classList.add('hidden');
            
            loadUserReplies();
        }

        function showResharesTab() {
            document.getElementById('resharesTab').className = 'px-4 py-2 rounded-full bg-pink-500 text-white';
            document.getElementById('buzzTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            document.getElementById('repliesTab').className = 'px-4 py-2 rounded-full bg-gray-200 text-gray-700';
            
            document.getElementById('userBuzzFeed').classList.add('hidden');
            document.getElementById('userRepliesFeed').classList.add('hidden');
            document.getElementById('userResharesFeed').classList.remove('hidden');
            
            loadUserReshares();
        }

        // Load User Buzz
        function loadUserBuzz() {
            if (!currentUser) return;
            
            const buzzRef = database.ref('buzz').orderByChild('uid').equalTo(currentUser.uid);
            buzzRef.on('value', (snapshot) => {
                const userBuzzFeed = document.getElementById('userBuzzFeed');
                userBuzzFeed.innerHTML = '';
                
                const buzzes = [];
                snapshot.forEach((childSnapshot) => {
                    buzzes.push(childSnapshot.val());
                });
                
                buzzes.reverse().forEach((buzz) => {
                    const buzzElement = createBuzzElement(buzz);
                    userBuzzFeed.appendChild(buzzElement);
                });
            });
        }

        // Load User Replies
        function loadUserReplies() {
            if (!currentUser) return;
            
            const buzzRef = database.ref('buzz');
            buzzRef.on('value', (snapshot) => {
                const userRepliesFeed = document.getElementById('userRepliesFeed');
                userRepliesFeed.innerHTML = '';
                
                const userReplies = [];
                
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.comments) {
                        Object.values(buzz.comments).forEach(comment => {
                            if (comment.uid === currentUser.uid) {
                                userReplies.push({
                                    ...buzz,
                                    userComment: comment,
                                    isReply: true
                                });
                            }
                        });
                    }
                });
                
                // Sort by comment timestamp
                userReplies.sort((a, b) => b.userComment.timestamp - a.userComment.timestamp);
                
                if (userReplies.length === 0) {
                    userRepliesFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No replies yet</p>';
                    return;
                }
                
                userReplies.forEach((reply) => {
                    const replyElement = createReplyElement(reply);
                    userRepliesFeed.appendChild(replyElement);
                });
            });
        }

        // Load User Reshares
        function loadUserReshares() {
            if (!currentUser) return;
            
            const buzzRef = database.ref('buzz');
            buzzRef.on('value', (snapshot) => {
                const userResharesFeed = document.getElementById('userResharesFeed');
                userResharesFeed.innerHTML = '';
                
                const userReshares = [];
                
                snapshot.forEach((childSnapshot) => {
                    const buzz = childSnapshot.val();
                    if (buzz.rebuzzes && buzz.rebuzzes[currentUser.uid]) {
                        userReshares.push({
                            ...buzz,
                            isReshare: true
                        });
                    }
                });
                
                // Sort by timestamp
                userReshares.sort((a, b) => b.timestamp - a.timestamp);
                
                if (userReshares.length === 0) {
                    userResharesFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No reshares yet</p>';
                    return;
                }
                
                userReshares.forEach((reshare) => {
                    const reshareElement = createReshareElement(reshare);
                    userResharesFeed.appendChild(reshareElement);
                });
            });
        }

        // Create Reply Element
        function createReplyElement(reply) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl shadow-lg p-4 lg:p-6 border-l-4 border-blue-500';
            
            div.innerHTML = `
                <div class="mb-3">
                    <span class="text-sm text-blue-600 font-medium">üí¨ You replied to</span>
                </div>
                <div class="flex items-start space-x-3 lg:space-x-4 mb-4">
                    <img class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300 flex-shrink-0" src="${reply.userImage}" alt="User">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2 flex-wrap">
                            <span class="font-bold text-sm lg:text-base truncate">${reply.username}</span>
                            ${reply.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">' : ''}
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">${formatTimestamp(reply.timestamp)}</span>
                        </div>
                        <p class="text-gray-800 text-sm lg:text-base break-words">${reply.content}</p>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-xl p-3 ml-8">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="font-medium text-sm">Your reply:</span>
                        <span class="text-gray-500 text-xs">${formatTimestamp(reply.userComment.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-800">${reply.userComment.content}</p>
                </div>
            `;
            
            return div;
        }

        // Create Reshare Element
        function createReshareElement(reshare) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-2xl shadow-lg p-4 lg:p-6 border-l-4 border-green-500';
            
            div.innerHTML = `
                <div class="mb-3">
                    <span class="text-sm text-green-600 font-medium">üîÅ You reshared</span>
                </div>
                <div class="flex items-start space-x-3 lg:space-x-4">
                    <img class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300 flex-shrink-0" src="${reshare.userImage}" alt="User">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2 flex-wrap">
                            <span class="font-bold text-sm lg:text-base truncate">${reshare.username}</span>
                            ${reshare.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">' : ''}
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">${formatTimestamp(reshare.timestamp)}</span>
                        </div>
                        <p class="text-gray-800 mb-3 text-sm lg:text-base break-words">${reshare.content}</p>
                        ${reshare.imageURL ? `<img class="w-full max-w-md rounded-xl mb-3" src="${reshare.imageURL}" alt="Buzz image">` : ''}
                    </div>
                </div>
            `;
            
            return div;
        }

        // Create Buzz Element
        function createBuzzElement(buzz) {
            const div = document.createElement('div');
            div.className = 'buzz-card bg-white rounded-2xl shadow-lg p-4 lg:p-6';
            div.setAttribute('data-buzz-id', buzz.buzzId);
            
            const likesCount = buzz.likes ? Object.keys(buzz.likes).length : 0;
            const rebuzzesCount = buzz.rebuzzes ? Object.keys(buzz.rebuzzes).length : 0;
            const isLiked = buzz.likes && currentUser && buzz.likes[currentUser.uid];
            const isRebuzzed = buzz.rebuzzes && currentUser && buzz.rebuzzes[currentUser.uid];
            
            div.innerHTML = `
                <div class="flex items-start space-x-3 lg:space-x-4">
                    <div class="relative">
                        <img class="w-10 h-10 lg:w-12 lg:h-12 rounded-full border-2 border-pink-300 flex-shrink-0" src="${buzz.userImage}" alt="User">
                        <div id="onlineIndicator-${buzz.uid}" class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2 flex-wrap">
                            <span onclick="viewUserProfile('${buzz.uid}')" class="font-bold text-sm lg:text-base truncate cursor-pointer hover:text-pink-500 transition-colors">${buzz.displayName || buzz.username}</span>
                            ${buzz.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">' : ''}
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">@${buzz.username}</span>
                            <span class="text-gray-500 text-xs lg:text-sm flex-shrink-0">${formatTimestamp(buzz.timestamp)}</span>
                        </div>
                        <p class="text-gray-800 mb-3 text-sm lg:text-base break-words">${buzz.content}</p>
                        ${buzz.mentions && buzz.mentions.includes(currentUser.username) ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 mb-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-yellow-800">You were mentioned in this buzz</span>
                                    <button onclick="removeMention('${buzz.buzzId}')" class="text-xs text-red-600 hover:text-red-800">Remove mention</button>
                                </div>
                            </div>
                        ` : ''}
                        ${buzz.imageURL ? `<img class="w-full max-w-md rounded-xl mb-3" src="${buzz.imageURL}" alt="Buzz image">` : ''}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4 lg:space-x-6">
                                <button onclick="toggleLike('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 ${isLiked ? 'text-red-500' : 'text-gray-500'} hover:text-red-500 transition-colors text-sm lg:text-base">
                                    <span>${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                    <span id="likes-${buzz.buzzId}">${likesCount}</span>
                                </button>
                                <button onclick="toggleRebuzz('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 ${isRebuzzed ? 'text-green-500' : 'text-gray-500'} hover:text-green-500 transition-colors text-sm lg:text-base">
                                    <span>üîÅ</span>
                                    <span id="rebuzzes-${buzz.buzzId}">${rebuzzesCount}</span>
                                </button>
                                <button onclick="openCommentModal('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 text-gray-500 hover:text-blue-500 transition-colors text-sm lg:text-base">
                                    <span>üí¨</span>
                                    <span id="comments-${buzz.buzzId}">${buzz.comments ? Object.keys(buzz.comments).length : 0}</span>
                                </button>
                                <button onclick="shareBuzz('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 text-gray-500 hover:text-purple-500 transition-colors text-sm lg:text-base">
                                    <span>üîó</span>
                                    <span class="hidden sm:inline">Share</span>
                                </button>
                                <button onclick="openReportModal('${buzz.buzzId}')" class="flex items-center space-x-1 lg:space-x-2 text-gray-500 hover:text-red-500 transition-colors text-sm lg:text-base">
                                    <span>üö®</span>
                                    <span class="hidden sm:inline">Report</span>
                                </button>
                            </div>
                            ${buzz.uid === currentUser.uid ? `<button onclick="deleteBuzz('${buzz.buzzId}')" class="text-red-500 hover:text-red-700 transition-colors text-sm lg:text-base">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Update online status for this user
            getUserOnlineStatus(buzz.uid, (status) => {
                updateUserOnlineIndicator(buzz.uid, status);
            });
            
            return div;
        }

        // Toggle Like
        function toggleLike(buzzId) {
            if (!currentUser) return;
            
            const likeRef = database.ref(`buzz/${buzzId}/likes/${currentUser.uid}`);
            likeRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    likeRef.remove();
                } else {
                    likeRef.set(true);
                    
                    // Get buzz author and create notification
                    database.ref(`buzz/${buzzId}`).once('value').then((buzzSnapshot) => {
                        const buzz = buzzSnapshot.val();
                        if (buzz && buzz.uid !== currentUser.uid) {
                            createNotification(buzz.uid, 'like', currentUser.displayName + ' liked your buzz');
                        }
                    });
                }
            });
        }

        // Toggle Rebuzz
        function toggleRebuzz(buzzId) {
            if (!currentUser) return;
            
            const rebuzzRef = database.ref(`buzz/${buzzId}/rebuzzes/${currentUser.uid}`);
            rebuzzRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    rebuzzRef.remove();
                } else {
                    rebuzzRef.set(true);
                    
                    // Get buzz author and create notification
                    database.ref(`buzz/${buzzId}`).once('value').then((buzzSnapshot) => {
                        const buzz = buzzSnapshot.val();
                        if (buzz && buzz.uid !== currentUser.uid) {
                            createNotification(buzz.uid, 'rebuzz', currentUser.displayName + ' rebuzzed your post');
                        }
                    });
                }
            });
        }

        // Load Verified Users
        function loadVerifiedUsers() {
            const usersRef = database.ref('users').orderByChild('verified').equalTo(true);
            usersRef.on('value', (snapshot) => {
                const verifiedUsersDiv = document.getElementById('verifiedUsers');
                verifiedUsersDiv.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    if (user.uid !== currentUser.uid) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-xl cursor-pointer';
                        userDiv.innerHTML = `
                            <img class="w-8 h-8 lg:w-10 lg:h-10 rounded-full border-2 border-pink-300 flex-shrink-0" src="${user.photoURL}" alt="User">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-1">
                                    <span class="font-medium text-sm lg:text-base truncate">${user.username}</span>
                                    <img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge flex-shrink-0">
                                </div>
                                <p class="text-xs lg:text-sm text-gray-600 truncate">${user.bio || 'Verified user'}</p>
                            </div>
                        `;
                        verifiedUsersDiv.appendChild(userDiv);
                    }
                });
            });
        }

        // Profile Settings Functions
        function openProfileSettings() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('profilePrivateAccount').checked = userData.private || false;
                    document.getElementById('profileShowOnlineStatus').checked = userData.showOnlineStatus !== false;
                    document.getElementById('profilePushNotifications').checked = userData.pushNotifications !== false;
                    document.getElementById('profileEmailNotifications').checked = userData.emailNotifications || false;
                }
            });
            
            document.getElementById('profileSettingsModal').classList.remove('hidden');
        }

        function closeProfileSettings() {
            document.getElementById('profileSettingsModal').classList.add('hidden');
        }

        function saveProfileSettings() {
            if (!currentUser) return;
            
            const settings = {
                private: document.getElementById('profilePrivateAccount').checked,
                showOnlineStatus: document.getElementById('profileShowOnlineStatus').checked,
                pushNotifications: document.getElementById('profilePushNotifications').checked,
                emailNotifications: document.getElementById('profileEmailNotifications').checked
            };
            
            database.ref('users/' + currentUser.uid).update(settings).then(() => {
                closeProfileSettings();
                alert('Settings saved successfully!');
            });
        }

        // Edit Profile Functions
        function openEditProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('editName').value = userData.username;
                    document.getElementById('editBio').value = userData.bio || '';
                    document.getElementById('editLocation').value = userData.location || '';
                }
            });
            
            document.getElementById('editProfileModal').classList.remove('hidden');
        }

        function closeEditProfile() {
            document.getElementById('editProfileModal').classList.add('hidden');
        }

        async function updateProfile() {
            if (!currentUser) return;
            
            const name = document.getElementById('editName').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            
            // Get current user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();
            let photoURL = userData.photoURL;
            
            // If no photo exists, generate avatar with new name
            if (!photoURL || photoURL.startsWith('data:')) {
                photoURL = generateAvatar(name);
            }
            
            // Update user data
            const updates = {
                username: name,
                bio: bio,
                location: location,
                photoURL: photoURL
            };
            
            database.ref('users/' + currentUser.uid).update(updates).then(() => {
                closeEditProfile();
                loadUserProfile();
                updateTopBar();
            });
        }

        // Account Switcher Functions
        function openAccountSwitcher() {
            document.getElementById('accountSwitcherModal').classList.remove('hidden');
            loadSavedAccounts();
        }

        function closeAccountSwitcher() {
            document.getElementById('accountSwitcherModal').classList.add('hidden');
        }

        function loadSavedAccounts() {
            const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
            const accountsList = document.getElementById('savedAccountsList');
            accountsList.innerHTML = '';

            if (savedAccounts.length === 0) {
                accountsList.innerHTML = '<p class="text-gray-500 text-center py-4">No saved accounts</p>';
                return;
            }

            savedAccounts.forEach((account, index) => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors';
                
                const isCurrentAccount = currentUser && account.uid === currentUser.uid;
                
                accountDiv.innerHTML = `
                    <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${account.photoURL}" alt="User">
                    <div class="flex-1">
                        <h4 class="font-medium">${account.username}</h4>
                        <p class="text-sm text-gray-600">${account.email}</p>
                        ${isCurrentAccount ? '<span class="text-xs text-green-600">Current Account</span>' : ''}
                    </div>
                    <div class="flex space-x-2">
                        ${!isCurrentAccount ? `<button onclick="switchToAccount(${index})" class="text-sm bg-pink-500 text-white px-3 py-1 rounded-full hover:bg-pink-600">Switch</button>` : ''}
                        <button onclick="removeAccount(${index})" class="text-sm text-red-500 hover:text-red-700">Remove</button>
                    </div>
                `;
                
                accountsList.appendChild(accountDiv);
            });
        }

        function switchToAccount(index) {
            const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
            const account = savedAccounts[index];
            
            if (account) {
                // Sign out current user and sign in with saved account
                auth.signOut().then(() => {
                    // This would require implementing custom token authentication
                    // For now, we'll redirect to login
                    alert('Please sign in with the account: ' + account.email);
                    closeAccountSwitcher();
                });
            }
        }

        function removeAccount(index) {
            if (confirm('Remove this account from saved accounts?')) {
                const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
                savedAccounts.splice(index, 1);
                localStorage.setItem('oriobuzz_accounts', JSON.stringify(savedAccounts));
                loadSavedAccounts();
            }
        }

        function addNewAccount() {
            closeAccountSwitcher();
            logout();
        }

        function saveCurrentAccount() {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    const savedAccounts = JSON.parse(localStorage.getItem('oriobuzz_accounts') || '[]');
                    
                    // Check if account already exists
                    const existingIndex = savedAccounts.findIndex(acc => acc.uid === currentUser.uid);
                    
                    const accountData = {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        username: userData.username,
                        photoURL: userData.photoURL
                    };
                    
                    if (existingIndex >= 0) {
                        savedAccounts[existingIndex] = accountData;
                    } else {
                        savedAccounts.push(accountData);
                    }
                    
                    localStorage.setItem('oriobuzz_accounts', JSON.stringify(savedAccounts));
                }
            });
        }

        // Utility Functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            return Math.floor(diff / 86400000) + 'd';
        }

        function logout() {
            // Save current account before logout
            saveCurrentAccount();
            auth.signOut();
        }

        // Delete Buzz
        function deleteBuzz(buzzId) {
            if (confirm('Are you sure you want to delete this buzz?')) {
                database.ref('buzz/' + buzzId).remove().then(() => {
                    loadBuzzFeed();
                    loadUserBuzz();
                });
            }
        }

        // View User Profile
        function viewUserProfile(userId) {
            if (userId === currentUser.uid) {
                showProfile();
                return;
            }
            
            currentViewingUser = userId;
            hideAllPages();
            document.getElementById('otherUserProfile').classList.remove('hidden');
            loadOtherUserProfile(userId);
            loadOtherUserBuzz(userId);
        }

        // Load Other User Profile
        function loadOtherUserProfile(userId) {
            const userRef = database.ref('users/' + userId);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('otherProfileImage').src = userData.photoURL;
                    document.getElementById('otherProfileName').textContent = userData.displayName || userData.username;
                    document.getElementById('otherProfileUsername').textContent = '@' + userData.username;
                    document.getElementById('otherProfileBio').textContent = userData.bio || 'No bio yet';
                    document.getElementById('otherLocationText').textContent = userData.location || 'Location not set';
                    
                    // Load follower counts
                    loadFollowerCounts(userId);
                    
                    // Check if following
                    checkFollowStatus(userId);
                    
                    // Check online status
                    getUserOnlineStatus(userId, (status) => {
                        updateUserOnlineIndicator(userId, status);
                    });
                    
                    if (userData.verified) {
                        document.getElementById('otherProfileVerified').classList.remove('hidden');
                    } else {
                        document.getElementById('otherProfileVerified').classList.add('hidden');
                    }

                    // Add share profile button
                    const shareBtn = document.createElement('button');
                    shareBtn.onclick = () => shareProfile(userId);
                    shareBtn.className = 'border border-gray-300 text-gray-700 px-4 lg:px-6 py-2 rounded-full hover:bg-gray-50 transition-colors text-sm lg:text-base';
                    shareBtn.innerHTML = 'üîó Share';
                    
                    const buttonContainer = document.querySelector('#otherUserProfile .flex.space-x-3');
                    if (buttonContainer && !buttonContainer.querySelector('.share-profile-btn')) {
                        shareBtn.classList.add('share-profile-btn');
                        buttonContainer.appendChild(shareBtn);
                    }
                }
            });
        }

        // Update user online indicator
        function updateUserOnlineIndicator(userId, status) {
            const indicator = document.getElementById('onlineIndicator-' + userId);
            if (indicator) {
                if (status && status.online) {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                    indicator.title = 'Online';
                } else {
                    indicator.className = 'w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                    if (status && status.lastSeen) {
                        indicator.title = 'Last seen ' + formatTimestamp(status.lastSeen);
                    } else {
                        indicator.title = 'Offline';
                    }
                }
            }
        }

        // Load Other User Buzz
        function loadOtherUserBuzz(userId) {
            // First check if user account is private
            database.ref('users/' + userId).once('value').then((userSnapshot) => {
                const userData = userSnapshot.val();
                const isPrivate = userData && userData.private;
                
                if (isPrivate) {
                    // Check if current user is following
                    database.ref('following/' + currentUser.uid + '/' + userId).once('value').then((followSnapshot) => {
                        const isFollowing = followSnapshot.exists();
                        
                        const otherUserBuzzFeed = document.getElementById('otherUserBuzzFeed');
                        
                        if (!isFollowing) {
                            // Show private account message
                            otherUserBuzzFeed.innerHTML = `
                                <div class="bg-gray-100 rounded-2xl p-8 text-center">
                                    <div class="text-6xl mb-4">üîí</div>
                                    <h3 class="text-xl font-bold mb-2">This Account is Private</h3>
                                    <p class="text-gray-600 mb-4">Follow ${userData.username} to see their buzz posts</p>
                                    <button onclick="toggleFollow()" class="gradient-bg text-white px-6 py-2 rounded-full hover:opacity-90 transition-opacity">
                                        Follow
                                    </button>
                                </div>
                            `;
                            return;
                        }
                    });
                }
                
                // Load buzz posts (either public account or following private account)
                const buzzRef = database.ref('buzz').orderByChild('uid').equalTo(userId);
                buzzRef.on('value', (snapshot) => {
                    const otherUserBuzzFeed = document.getElementById('otherUserBuzzFeed');
                    
                    // Don't overwrite private message if user is not following
                    if (isPrivate && otherUserBuzzFeed.innerHTML.includes('This Account is Private')) {
                        return;
                    }
                    
                    otherUserBuzzFeed.innerHTML = '';
                    
                    const buzzes = [];
                    snapshot.forEach((childSnapshot) => {
                        buzzes.push(childSnapshot.val());
                    });
                    
                    if (buzzes.length === 0) {
                        otherUserBuzzFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No buzz posts yet</p>';
                        return;
                    }
                    
                    buzzes.reverse().forEach((buzz) => {
                        const buzzElement = createBuzzElement(buzz);
                        otherUserBuzzFeed.appendChild(buzzElement);
                    });
                });
            });
        }

        // Check Follow Status
        function checkFollowStatus(userId) {
            const followRef = database.ref('following/' + currentUser.uid + '/' + userId);
            followRef.once('value').then((snapshot) => {
                const followBtn = document.getElementById('followBtn');
                if (snapshot.exists()) {
                    followBtn.textContent = 'Following';
                    followBtn.classList.remove('gradient-bg');
                    followBtn.classList.add('bg-gray-500');
                } else {
                    followBtn.textContent = 'Follow';
                    followBtn.classList.add('gradient-bg');
                    followBtn.classList.remove('bg-gray-500');
                }
            });
        }

        // Toggle Follow
        function toggleFollow() {
            if (!currentViewingUser) return;
            
            const followRef = database.ref('following/' + currentUser.uid + '/' + currentViewingUser);
            const followerRef = database.ref('followers/' + currentViewingUser + '/' + currentUser.uid);
            
            followRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Unfollow
                    followRef.remove();
                    followerRef.remove();
                    createNotification(currentViewingUser, 'unfollow', currentUser.displayName + ' unfollowed you');
                } else {
                    // Follow
                    followRef.set(true);
                    followerRef.set(true);
                    createNotification(currentViewingUser, 'follow', currentUser.displayName + ' started following you');
                }
                checkFollowStatus(currentViewingUser);
                loadFollowerCounts(currentViewingUser);
            });
        }

        // Start Chat
        function startChat() {
            if (!currentViewingUser) return;
            
            currentChatUser = currentViewingUser;
            showMessages();
            openChat(currentViewingUser);
        }

        // Start Chat with User
        function startChatWithUser() {
            if (!currentViewingUser) return;
            
            currentChatUser = currentViewingUser;
            showMessages();
            openChat(currentViewingUser);
        }

        // Load Notifications
        function loadNotifications() {
            if (!currentUser) return;
            
            const notificationsRef = database.ref('notifications/' + currentUser.uid).orderByChild('timestamp');
            notificationsRef.on('value', (snapshot) => {
                const notificationsFeed = document.getElementById('notificationsFeed');
                notificationsFeed.innerHTML = '';
                
                const notifications = [];
                snapshot.forEach((childSnapshot) => {
                    notifications.push(childSnapshot.val());
                });
                
                if (notifications.length === 0) {
                    notificationsFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No notifications yet</p>';
                    return;
                }
                
                notifications.reverse().forEach((notification) => {
                    const notificationElement = createNotificationElement(notification);
                    notificationsFeed.appendChild(notificationElement);
                });
            });
        }

        // Create Notification Element
        function createNotificationElement(notification) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow-lg p-4 hover:bg-gray-50 transition-colors';
            
            let icon = 'üîî';
            if (notification.type === 'like') icon = '‚ù§Ô∏è';
            if (notification.type === 'rebuzz') icon = 'üîÅ';
            if (notification.type === 'follow') icon = 'üë§';
            if (notification.type === 'comment') icon = 'üí¨';
            
            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <span class="text-2xl">${icon}</span>
                    <div class="flex-1">
                        <p class="text-sm lg:text-base">${notification.message}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatTimestamp(notification.timestamp)}</p>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Create Notification
        function createNotification(userId, type, message) {
            if (userId === currentUser.uid) return; // Don't notify yourself
            
            const notificationId = database.ref('notifications/' + userId).push().key;
            const notificationData = {
                id: notificationId,
                type: type,
                message: message,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            };
            
            database.ref('notifications/' + userId + '/' + notificationId).set(notificationData);
            updateNotificationBadge(userId);
        }

        // Update Notification Badge
        function updateNotificationBadge(userId) {
            if (userId !== currentUser.uid) return;
            
            const notificationsRef = database.ref('notifications/' + userId).orderByChild('read').equalTo(false);
            notificationsRef.once('value').then((snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                const badge = document.getElementById('notificationBadge');
                const badgeDesktop = document.getElementById('notificationBadgeDesktop');
                
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                    badgeDesktop.textContent = count;
                    badgeDesktop.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                    badgeDesktop.classList.add('hidden');
                }
            });
        }

        // Clear Notification Badge
        function clearNotificationBadge() {
            if (!currentUser) return;
            
            const notificationsRef = database.ref('notifications/' + currentUser.uid);
            notificationsRef.once('value').then((snapshot) => {
                const updates = {};
                snapshot.forEach((childSnapshot) => {
                    updates[childSnapshot.key + '/read'] = true;
                });
                notificationsRef.update(updates);
            });
            
            document.getElementById('notificationBadge').classList.add('hidden');
            document.getElementById('notificationBadgeDesktop').classList.add('hidden');
        }

        // Load Conversations
        function loadConversations() {
            if (!currentUser) return;
            
            const conversationsRef = database.ref('conversations').orderByChild('participants/' + currentUser.uid).equalTo(true);
            conversationsRef.on('value', (snapshot) => {
                const conversationsList = document.getElementById('conversationsList');
                conversationsList.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const conversation = childSnapshot.val();
                    const otherUserId = Object.keys(conversation.participants).find(id => id !== currentUser.uid);
                    
                    if (otherUserId) {
                        database.ref('users/' + otherUserId).once('value').then((userSnapshot) => {
                            const userData = userSnapshot.val();
                            if (userData) {
                                const conversationElement = createConversationElement(conversation, userData, otherUserId);
                                conversationsList.appendChild(conversationElement);
                            }
                        });
                    }
                });
            });
        }

        // Create Conversation Element
        function createConversationElement(conversation, userData, userId) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-xl cursor-pointer border-b border-gray-100';
            div.onclick = () => openChat(userId);
            
            const lastMessagePreview = conversation.lastMessage ? 
                (conversation.lastMessage.length > 30 ? 
                    conversation.lastMessage.substring(0, 30) + '...' : 
                    conversation.lastMessage) : 
                'Start a conversation';
            
            div.innerHTML = `
                <div class="relative">
                    <img class="w-10 h-10 rounded-full border-2 border-pink-300" src="${userData.photoURL}" alt="User">
                    <div id="conversationOnline-${userId}" class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <h4 class="font-medium text-sm truncate">${userData.displayName || userData.username}</h4>
                        <span class="text-xs text-gray-400">${conversation.lastMessageTime ? formatTimestamp(conversation.lastMessageTime) : ''}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate">${lastMessagePreview}</p>
                </div>
            `;
            
            // Update online status
            getUserOnlineStatus(userId, (status) => {
                const indicator = document.getElementById('conversationOnline-' + userId);
                if (indicator) {
                    if (status && status.online) {
                        indicator.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                    } else {
                        indicator.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                    }
                }
            });
            
            return div;
        }

        // Open Chat
        function openChat(userId) {
            currentChatUser = userId;
            
            database.ref('users/' + userId).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('chatUserImage').src = userData.photoURL;
                    document.getElementById('chatUserName').textContent = userData.username;
                    
                    // Update online status
                    getUserOnlineStatus(userId, (status) => {
                        const statusElement = document.getElementById('chatUserStatus');
                        const indicatorElement = document.getElementById('chatUserOnlineIndicator');
                        
                        if (status && status.online) {
                            statusElement.textContent = 'Online';
                            statusElement.className = 'text-sm text-green-500';
                            indicatorElement.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                        } else {
                            statusElement.textContent = status && status.lastSeen ? 
                                'Last seen ' + formatTimestamp(status.lastSeen) : 'Offline';
                            statusElement.className = 'text-sm text-gray-500';
                            indicatorElement.className = 'absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                        }
                    });
                    
                    document.getElementById('noChatSelected').classList.add('hidden');
                    document.getElementById('chatArea').classList.remove('hidden');
                    
                    loadMessages(userId);
                    listenForTyping(userId);
                }
            });
        }

        // Handle typing indicator
        let typingTimeout;
        function handleTyping() {
            if (!currentChatUser) return;
            
            const conversationId = [currentUser.uid, currentChatUser].sort().join('_');
            
            // Show typing indicator for other user
            database.ref('typing/' + conversationId + '/' + currentUser.uid).set({
                typing: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Clear typing indicator after 3 seconds
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                database.ref('typing/' + conversationId + '/' + currentUser.uid).remove();
            }, 3000);
        }

        // Listen for typing indicator
        function listenForTyping(userId) {
            const conversationId = [currentUser.uid, userId].sort().join('_');
            
            database.ref('typing/' + conversationId + '/' + userId).on('value', (snapshot) => {
                const typingData = snapshot.val();
                const typingIndicator = document.getElementById('typingIndicator');
                const typingUsername = document.getElementById('typingUsername');
                
                if (typingData && typingData.typing) {
                    database.ref('users/' + userId).once('value').then((userSnapshot) => {
                        const userData = userSnapshot.val();
                        if (userData) {
                            typingUsername.textContent = userData.username;
                            typingIndicator.classList.remove('hidden');
                        }
                    });
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });
        }

        // Load Messages
        function loadMessages(userId) {
            const conversationId = [currentUser.uid, userId].sort().join('_');
            const messagesRef = database.ref('messages/' + conversationId).orderByChild('timestamp');
            
            messagesRef.on('value', (snapshot) => {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    const messageElement = createMessageElement(message);
                    messagesContainer.appendChild(messageElement);
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // Create Message Element
        function createMessageElement(message) {
            const div = document.createElement('div');
            const isOwn = message.senderId === currentUser.uid;
            
            div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} items-end space-x-2 mb-3`;
            
            if (isOwn) {
                div.innerHTML = `
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-4 py-2 rounded-2xl rounded-br-md shadow-lg">
                            <p class="text-sm break-words">${message.text}</p>
                        </div>
                        <div class="flex items-center justify-end space-x-1 mt-1">
                            <p class="text-xs text-gray-500">${formatTimestamp(message.timestamp)}</p>
                            <span class="text-xs ${message.read ? 'text-blue-500' : 'text-gray-400'}">${message.read ? '‚úì‚úì' : '‚úì'}</span>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 overflow-hidden">
                        <img class="w-full h-full object-cover" src="${message.senderImage || generateAvatar(message.senderName || 'User')}" alt="User">
                    </div>
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-white border border-gray-200 text-gray-800 px-4 py-2 rounded-2xl rounded-bl-md shadow-sm">
                            <p class="text-sm break-words">${message.text}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 ml-2">${formatTimestamp(message.timestamp)}</p>
                    </div>
                `;
            }
            
            return div;
        }

        // Send Message - Completely Fixed
        function sendMessage() {
            console.log('üöÄ Send message function called');
            
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) {
                console.error('‚ùå Message input not found');
                return;
            }
            
            const messageText = messageInput.value.trim();
            console.log('üìù Message text:', messageText);
            
            if (!messageText) {
                console.log('‚ö†Ô∏è No message text');
                return;
            }
            
            if (!currentChatUser) {
                console.log('‚ö†Ô∏è No chat user selected');
                alert('Please select a user to chat with');
                return;
            }
            
            if (!currentUser) {
                console.log('‚ö†Ô∏è No current user');
                alert('Please login first');
                return;
            }
            
            console.log('‚úÖ All checks passed, sending message...');
            
            // Create conversation ID
            const conversationId = [currentUser.uid, currentChatUser].sort().join('_');
            console.log('üí¨ Conversation ID:', conversationId);
            
            // Get user data first
            database.ref('users/' + currentUser.uid).once('value').then((userSnapshot) => {
                const userData = userSnapshot.val();
                console.log('üë§ User data:', userData);
                
                if (!userData) {
                    console.error('‚ùå No user data found');
                    return;
                }
                
                // Create message data
                const messageData = {
                    senderId: currentUser.uid,
                    receiverId: currentChatUser,
                    senderName: userData.username || userData.displayName || 'User',
                    senderImage: userData.photoURL || '',
                    text: messageText,
                    timestamp: Date.now(),
                    read: false
                };
                
                console.log('üì§ Sending message data:', messageData);
                
                // Save message to database
                const messageRef = database.ref('messages/' + conversationId).push();
                messageRef.set(messageData).then(() => {
                    console.log('‚úÖ Message saved successfully');
                    
                    // Clear input
                    messageInput.value = '';
                    
                    // Update conversation
                    const conversationData = {
                        participants: {
                            [currentUser.uid]: true,
                            [currentChatUser]: true
                        },
                        lastMessage: messageText,
                        lastMessageTime: Date.now(),
                        lastMessageSender: currentUser.uid
                    };
                    
                    database.ref('conversations/' + conversationId).set(conversationData).then(() => {
                        console.log('‚úÖ Conversation updated');
                        
                        // Create notification
                        createNotification(currentChatUser, 'message', `${userData.username || 'Someone'} sent you a message`);
                        
                        // Remove typing indicator
                        database.ref('typing/' + conversationId + '/' + currentUser.uid).remove();
                        
                    }).catch((error) => {
                        console.error('‚ùå Error updating conversation:', error);
                    });
                    
                }).catch((error) => {
                    console.error('‚ùå Error saving message:', error);
                    alert('Failed to send message: ' + error.message);
                });
                
            }).catch((error) => {
                console.error('‚ùå Error getting user data:', error);
                alert('Failed to get user data: ' + error.message);
            });
        }

        // Initialize message input with better event handling
        function initializeMessageInput() {
            console.log('üîß Initializing message input...');
            
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendMessageBtn');
            
            if (!messageInput) {
                console.log('‚ö†Ô∏è Message input not found during initialization');
                return;
            }
            
            if (!sendBtn) {
                console.log('‚ö†Ô∏è Send button not found during initialization');
                return;
            }
            
            // Remove any existing event listeners by cloning elements
            const newInput = messageInput.cloneNode(true);
            const newBtn = sendBtn.cloneNode(true);
            
            messageInput.parentNode.replaceChild(newInput, messageInput);
            sendBtn.parentNode.replaceChild(newBtn, sendBtn);
            
            // Add fresh event listeners to input
            newInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    console.log('‚å®Ô∏è Enter key pressed - sending message');
                    sendMessage();
                }
            });
            
            newInput.addEventListener('input', function() {
                handleTyping();
            });
            
            // Add click event listener to send button
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('üñ±Ô∏è Send button clicked - sending message');
                sendMessage();
            });
            
            console.log('‚úÖ Message input and send button initialized successfully');
        }
        
        // Show Messages with proper initialization
        function showMessages() {
            console.log('üì± Showing messages page...');
            hideAllPages();
            document.getElementById('messagesPage').classList.remove('hidden');
            loadConversations();
            
            // Initialize message input after DOM is ready
            setTimeout(() => {
                initializeMessageInput();
            }, 200);
        }

        // Load Settings
        function loadSettings() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('privateAccount').checked = userData.private || false;
                    document.getElementById('showOnlineStatus').checked = userData.showOnlineStatus !== false;
                    document.getElementById('pushNotifications').checked = userData.pushNotifications !== false;
                    document.getElementById('emailNotifications').checked = userData.emailNotifications || false;
                }
            });
        }

        // Verification Functions
        function openVerificationModal() {
            document.getElementById('verificationModal').classList.remove('hidden');
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.add('hidden');
            // Clear form
            document.getElementById('verifyName').value = '';
            document.getElementById('verifyAge').value = '';
            document.getElementById('verifyCategory').value = '';
            document.getElementById('verifyLink').value = '';
        }

        function submitVerification() {
            const name = document.getElementById('verifyName').value.trim();
            const age = document.getElementById('verifyAge').value;
            const category = document.getElementById('verifyCategory').value;
            const link = document.getElementById('verifyLink').value.trim();
            
            if (!name || !age || !category || !link) {
                alert('Please fill all required fields');
                return;
            }
            
            if (age < 13) {
                alert('You must be at least 13 years old to get verified');
                return;
            }
            
            // Special names that get instant verification
            const instantVerifyNames = ['oriontec', 'dozera', 'gursharn arya', 'orry', 'anmol sunda'];
            const isInstantVerify = instantVerifyNames.some(specialName => 
                name.toLowerCase().includes(specialName.toLowerCase())
            );
            
            const verificationData = {
                uid: currentUser.uid,
                name: name,
                age: age,
                category: category,
                link: 'www.orintec.xyz/' + link,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            };
            
            // Save verification request
            database.ref('verificationRequests/' + currentUser.uid).set(verificationData);
            
            closeVerificationModal();
            
            if (isInstantVerify) {
                // Instant verification for special names
                setTimeout(() => {
                    database.ref('users/' + currentUser.uid).update({ verified: true });
                    createNotification(currentUser.uid, 'verification', 'üéâ Congratulations! Your verification request has been approved. You are now verified!');
                    database.ref('verificationRequests/' + currentUser.uid).update({ status: 'approved' });
                }, 2000); // 2 seconds
            } else {
                // Regular verification process - simulate link checking
                setTimeout(() => {
                    // Simulate checking if username appears on the link
                    // In real implementation, this would make an actual HTTP request
                    const linkContainsUsername = Math.random() > 0.7; // 30% success rate for demo
                    
                    if (linkContainsUsername) {
                        database.ref('users/' + currentUser.uid).update({ verified: true });
                        createNotification(currentUser.uid, 'verification', 'üéâ Congratulations! Your verification request has been approved. You are now verified!');
                        database.ref('verificationRequests/' + currentUser.uid).update({ status: 'approved' });
                    } else {
                        createNotification(currentUser.uid, 'verification', '‚ùå Your verification request has been rejected. Your username was not found on the provided link. Please try again with a valid link.');
                        database.ref('verificationRequests/' + currentUser.uid).update({ status: 'rejected' });
                    }
                }, 300000); // 5 minutes
            }
            
            alert('Verification request submitted! You will receive a notification about the result.');
        }

        // Export Data
        function exportData() {
            if (!currentUser) return;
            
            const userData = {
                profile: {},
                buzzes: [],
                followers: [],
                following: []
            };
            
            // Get user data
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                userData.profile = snapshot.val();
                
                // Get user's buzzes
                return database.ref('buzz').orderByChild('uid').equalTo(currentUser.uid).once('value');
            }).then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    userData.buzzes.push(childSnapshot.val());
                });
                
                // Create and download file
                const dataStr = JSON.stringify(userData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'oriobuzz-data.json';
                link.click();
                URL.revokeObjectURL(url);
            });
        }

        // Deactivate Account
        function deactivateAccount() {
            if (confirm('Are you sure you want to deactivate your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    // Delete user data
                    database.ref('users/' + currentUser.uid).remove();
                    database.ref('buzz').orderByChild('uid').equalTo(currentUser.uid).once('value').then((snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            childSnapshot.ref.remove();
                        });
                    });
                    
                    // Sign out
                    auth.signOut();
                }
            }
        }

        // Comment Modal Functions
        let currentCommentBuzzId = null;

        function openCommentModal(buzzId) {
            currentCommentBuzzId = buzzId;
            document.getElementById('commentModal').classList.remove('hidden');
            
            // Set user image
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('commentUserImage').src = userData.photoURL;
                    }
                });
            }
            
            loadComments(buzzId);
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.add('hidden');
            document.getElementById('commentContent').value = '';
            currentCommentBuzzId = null;
        }

        function loadComments(buzzId) {
            const commentsRef = database.ref('buzz/' + buzzId + '/comments');
            commentsRef.on('value', (snapshot) => {
                const commentsContainer = document.getElementById('commentsContainer');
                commentsContainer.innerHTML = '';
                
                if (!snapshot.exists()) {
                    commentsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No comments yet</p>';
                    return;
                }
                
                const comments = [];
                snapshot.forEach((childSnapshot) => {
                    comments.push(childSnapshot.val());
                });
                
                comments.sort((a, b) => a.timestamp - b.timestamp);
                
                comments.forEach((comment) => {
                    const commentElement = createCommentElement(comment);
                    commentsContainer.appendChild(commentElement);
                });
            });
        }

        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'flex items-start space-x-3 p-3 bg-gray-50 rounded-xl';
            
            div.innerHTML = `
                <img class="w-8 h-8 rounded-full border-2 border-pink-300" src="${comment.userImage}" alt="User">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="font-medium text-sm">${comment.username}</span>
                        ${comment.verified ? '<img src="https://community.oriontec.xyz/verify.png" alt="Verified" class="verified-badge">' : ''}
                        <span class="text-gray-500 text-xs">${formatTimestamp(comment.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-800">${comment.content}</p>
                </div>
            `;
            
            return div;
        }

        async function postComment() {
            const content = document.getElementById('commentContent').value.trim();
            
            if (!content || !currentCommentBuzzId) return;

            // Get user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();

            const commentId = database.ref('buzz/' + currentCommentBuzzId + '/comments').push().key;

            const commentData = {
                commentId: commentId,
                uid: currentUser.uid,
                username: userData.username,
                userImage: userData.photoURL,
                verified: userData.verified || false,
                content: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Save comment
            database.ref('buzz/' + currentCommentBuzzId + '/comments/' + commentId).set(commentData).then(() => {
                document.getElementById('commentContent').value = '';
                
                // Create notification for buzz author
                database.ref('buzz/' + currentCommentBuzzId).once('value').then((buzzSnapshot) => {
                    const buzz = buzzSnapshot.val();
                    if (buzz && buzz.uid !== currentUser.uid) {
                        createNotification(buzz.uid, 'comment', userData.username + ' commented on your buzz');
                    }
                });
            });
        }

        // Report Modal Functions
        let currentReportBuzzId = null;

        function openReportModal(buzzId) {
            currentReportBuzzId = buzzId;
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('reportDetails').value = '';
            // Clear radio buttons
            const radioButtons = document.querySelectorAll('input[name="reportReason"]');
            radioButtons.forEach(radio => radio.checked = false);
            currentReportBuzzId = null;
        }

        async function submitReport() {
            const selectedReason = document.querySelector('input[name="reportReason"]:checked');
            const details = document.getElementById('reportDetails').value.trim();
            
            if (!selectedReason || !currentReportBuzzId) {
                alert('Please select a reason for reporting');
                return;
            }

            const reportId = database.ref('reports').push().key;
            const reportData = {
                reportId: reportId,
                buzzId: currentReportBuzzId,
                reporterId: currentUser.uid,
                reason: selectedReason.value,
                details: details,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            };

            // Save report
            await database.ref('reports/' + reportId).set(reportData);

            // Check if buzz should be auto-deleted (50+ reports)
            const reportsRef = database.ref('reports').orderByChild('buzzId').equalTo(currentReportBuzzId);
            reportsRef.once('value').then((snapshot) => {
                const reportCount = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                
                if (reportCount >= 50) {
                    // Auto-delete buzz
                    database.ref('buzz/' + currentReportBuzzId).remove();
                    
                    // Notify buzz author
                    database.ref('buzz/' + currentReportBuzzId).once('value').then((buzzSnapshot) => {
                        const buzz = buzzSnapshot.val();
                        if (buzz) {
                            createNotification(buzz.uid, 'moderation', 'Your buzz has been removed due to multiple reports');
                        }
                    });
                }
            });

            closeReportModal();
            alert('Report submitted successfully. Thank you for helping keep OrioBuzz safe!');
        }

        // Real-time updates for likes, rebuzzes, and comments
        database.ref('buzz').on('child_changed', (snapshot) => {
            const buzz = snapshot.val();
            const likesElement = document.getElementById(`likes-${buzz.buzzId}`);
            const rebuzzesElement = document.getElementById(`rebuzzes-${buzz.buzzId}`);
            const commentsElement = document.getElementById(`comments-${buzz.buzzId}`);
            
            if (likesElement) {
                const likesCount = buzz.likes ? Object.keys(buzz.likes).length : 0;
                likesElement.textContent = likesCount;
            }
            
            if (rebuzzesElement) {
                const rebuzzesCount = buzz.rebuzzes ? Object.keys(buzz.rebuzzes).length : 0;
                rebuzzesElement.textContent = rebuzzesCount;
            }
            
            if (commentsElement) {
                const commentsCount = buzz.comments ? Object.keys(buzz.comments).length : 0;
                commentsElement.textContent = commentsCount;
            }
        });

        // Handle buzz input for hashtag suggestions
        function handleBuzzInput() {
            const content = document.getElementById('buzzContent').value;
            const cursorPosition = document.getElementById('buzzContent').selectionStart;
            const textBeforeCursor = content.substring(0, cursorPosition);
            const lastHashtag = textBeforeCursor.match(/#(\w*)$/);
            
            if (lastHashtag) {
                const hashtagPrefix = lastHashtag[1];
                showHashtagSuggestions(hashtagPrefix);
            } else {
                hideHashtagSuggestions();
            }
        }

        // Show hashtag suggestions
        function showHashtagSuggestions(prefix) {
            database.ref('hashtags').once('value').then((snapshot) => {
                const suggestions = document.getElementById('hashtagSuggestions');
                suggestions.innerHTML = '';
                
                if (snapshot.exists()) {
                    const hashtags = Object.keys(snapshot.val());
                    const filteredHashtags = hashtags.filter(hashtag => 
                        hashtag.toLowerCase().startsWith(prefix.toLowerCase())
                    ).slice(0, 5);
                    
                    if (filteredHashtags.length > 0) {
                        filteredHashtags.forEach(hashtag => {
                            const div = document.createElement('div');
                            div.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm';
                            div.textContent = '#' + hashtag;
                            div.onclick = () => selectHashtag(hashtag);
                            suggestions.appendChild(div);
                        });
                        suggestions.classList.remove('hidden');
                    } else {
                        hideHashtagSuggestions();
                    }
                } else {
                    hideHashtagSuggestions();
                }
            });
        }

        // Hide hashtag suggestions
        function hideHashtagSuggestions() {
            document.getElementById('hashtagSuggestions').classList.add('hidden');
        }

        // Select hashtag from suggestions
        function selectHashtag(hashtag) {
            const textarea = document.getElementById('buzzContent');
            const content = textarea.value;
            const cursorPosition = textarea.selectionStart;
            const textBeforeCursor = content.substring(0, cursorPosition);
            const textAfterCursor = content.substring(cursorPosition);
            
            // Replace the partial hashtag with the selected one
            const newTextBefore = textBeforeCursor.replace(/#\w*$/, '#' + hashtag + ' ');
            textarea.value = newTextBefore + textAfterCursor;
            
            // Set cursor position after the hashtag
            const newCursorPosition = newTextBefore.length;
            textarea.setSelectionRange(newCursorPosition, newCursorPosition);
            textarea.focus();
            
            hideHashtagSuggestions();
        }

        // Check username availability
        async function checkUsernameAvailability() {
            const username = document.getElementById('editName').value.trim().toLowerCase();
            const statusElement = document.getElementById('usernameStatus');
            
            if (!username) {
                statusElement.textContent = '';
                return;
            }
            
            // Validate username format
            if (!/^[a-z0-9_]+$/.test(username)) {
                statusElement.textContent = 'Username can only contain lowercase letters, numbers, and underscores';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            if (username.length < 3) {
                statusElement.textContent = 'Username must be at least 3 characters long';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            if (username.length > 20) {
                statusElement.textContent = 'Username must be less than 20 characters';
                statusElement.className = 'text-xs mt-1 text-red-500';
                return;
            }
            
            // Check if username is already taken
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
            
            if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                const userIds = Object.keys(users);
                
                // Check if it's the current user's username
                if (userIds.length === 1 && userIds[0] === currentUser.uid) {
                    statusElement.textContent = 'This is your current username';
                    statusElement.className = 'text-xs mt-1 text-blue-500';
                } else {
                    statusElement.textContent = '‚ùå Username already taken - try another one';
                    statusElement.className = 'text-xs mt-1 text-red-500';
                }
            } else {
                statusElement.textContent = '‚úÖ Username available';
                statusElement.className = 'text-xs mt-1 text-green-500';
            }
        }

        // Update profile with website
        async function updateProfile() {
            if (!currentUser) return;
            
            const displayName = document.getElementById('editDisplayName').value.trim();
            const username = document.getElementById('editName').value.trim().toLowerCase().replace(/\s+/g, '');
            const bio = document.getElementById('editBio').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            const website = document.getElementById('editWebsite').value.trim();
            
            // Validate required fields
            if (!username) {
                alert('Username is required');
                return;
            }
            
            // Validate username format
            if (!/^[a-z0-9_]+$/.test(username)) {
                alert('Username can only contain lowercase letters, numbers, and underscores');
                return;
            }
            
            if (username.length < 3) {
                alert('Username must be at least 3 characters long');
                return;
            }
            
            if (username.length > 20) {
                alert('Username must be less than 20 characters');
                return;
            }
            
            // Check if username is available
            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
            if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                const userIds = Object.keys(users);
                if (userIds.length > 0 && userIds[0] !== currentUser.uid) {
                    alert('‚ùå Username already taken. Please choose a different one.');
                    return;
                }
            }
            
            // Validate website URL if provided
            if (website && !website.startsWith('http://') && !website.startsWith('https://')) {
                alert('Website URL must start with http:// or https://');
                return;
            }
            
            // Get current user data
            const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();
            let photoURL = userData.photoURL;
            
            // If no photo exists, generate avatar with new display name
            if (!photoURL || photoURL.startsWith('data:')) {
                photoURL = generateAvatar(displayName || username);
            }
            
            // Update user data
            const updates = {
                displayName: displayName || username,
                username: username,
                bio: bio,
                location: location,
                website: website,
                photoURL: photoURL
            };
            
            try {
                await database.ref('users/' + currentUser.uid).update(updates);
                closeEditProfile();
                loadUserProfile();
                updateTopBar();
                alert('‚úÖ Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('‚ùå Failed to update profile. Please try again.');
            }
        }

        // Load user profile with website
        function loadUserProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('profileImage').src = userData.photoURL;
                    document.getElementById('profileName').textContent = userData.displayName || userData.username;
                    document.getElementById('profileUsername').textContent = '@' + userData.username;
                    document.getElementById('profileBio').textContent = userData.bio || 'No bio yet';
                    document.getElementById('locationText').textContent = userData.location || 'Location not set';
                    
                    // Add website link if exists
                    const locationElement = document.getElementById('profileLocation');
                    if (userData.website) {
                        locationElement.innerHTML = `
                            üìç <span>${userData.location || 'Location not set'}</span><br>
                            üåê <a href="${userData.website}" target="_blank" class="text-blue-500 hover:text-blue-700">${userData.website}</a>
                        `;
                    } else {
                        locationElement.innerHTML = `üìç <span id="locationText">${userData.location || 'Location not set'}</span>`;
                    }
                    
                    // Load follower counts
                    loadFollowerCounts(currentUser.uid);
                    
                    if (userData.verified) {
                        document.getElementById('profileVerified').classList.remove('hidden');
                    } else {
                        document.getElementById('profileVerified').classList.add('hidden');
                    }
                }
            });
        }

        // Open edit profile with website
        function openEditProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('editDisplayName').value = userData.displayName || '';
                    document.getElementById('editName').value = userData.username || '';
                    document.getElementById('editBio').value = userData.bio || '';
                    document.getElementById('editLocation').value = userData.location || '';
                    document.getElementById('editWebsite').value = userData.website || '';
                }
            });
            
            document.getElementById('editProfileModal').classList.remove('hidden');
        }

        // Send message with URL preview
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChatUser) return;
            
            const conversationId = [currentUser.uid, currentChatUser].sort().join('_');
            const messageId = database.ref('messages/' + conversationId).push().key;
            
            // Get URL preview if message contains URL
            const urlPreview = await extractURLPreview(messageText);
            
            const messageData = {
                id: messageId,
                senderId: currentUser.uid,
                receiverId: currentChatUser,
                text: messageText,
                urlPreview: urlPreview,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save message
            database.ref('messages/' + conversationId + '/' + messageId).set(messageData);
            
            // Update conversation
            const conversationData = {
                participants: {
                    [currentUser.uid]: true,
                    [currentChatUser]: true
                },
                lastMessage: messageText,
                lastMessageTime: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref('conversations/' + conversationId).set(conversationData);
            
            messageInput.value = '';
        }

        // Create Message Element with URL preview
        function createMessageElement(message) {
            const div = document.createElement('div');
            const isOwn = message.senderId === currentUser.uid;
            
            div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} items-end space-x-2`;
            
            // URL Preview HTML for messages
            let urlPreviewHTML = '';
            if (message.urlPreview) {
                urlPreviewHTML = `
                    <div class="border border-gray-200 rounded-lg p-2 mt-2 cursor-pointer hover:bg-gray-50" onclick="openURL('${message.urlPreview.url}')">
                        ${message.urlPreview.image ? `<img class="w-full h-20 object-cover rounded mb-1" src="${message.urlPreview.image}" alt="Preview">` : ''}
                        <h5 class="font-medium text-xs text-gray-800">${message.urlPreview.title}</h5>
                        <p class="text-xs text-gray-600">${message.urlPreview.domain}</p>
                    </div>
                `;
            }
            
            if (isOwn) {
                div.innerHTML = `
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-4 py-2 rounded-2xl rounded-br-md shadow-lg">
                            <p class="text-sm break-words">${message.text}</p>
                            ${urlPreviewHTML}
                        </div>
                        <div class="flex items-center justify-end space-x-1 mt-1">
                            <p class="text-xs text-gray-500">${formatTimestamp(message.timestamp)}</p>
                            <span class="text-xs ${message.read ? 'text-blue-500' : 'text-gray-400'}">${message.read ? '‚úì‚úì' : '‚úì'}</span>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 overflow-hidden">
                        <img class="w-full h-full object-cover" src="${message.senderImage || ''}" alt="User">
                    </div>
                    <div class="max-w-xs lg:max-w-md">
                        <div class="bg-white border border-gray-200 text-gray-800 px-4 py-2 rounded-2xl rounded-bl-md shadow-sm">
                            <p class="text-sm break-words">${message.text}</p>
                            ${urlPreviewHTML}
                        </div>
                        <p class="text-xs text-gray-500 mt-1 ml-2">${formatTimestamp(message.timestamp)}</p>
                    </div>
                `;
            }
            
            return div;
        }

        // Listen for notifications
        if (currentUser) {
            database.ref('notifications/' + currentUser.uid).on('child_added', () => {
                updateNotificationBadge(currentUser.uid);
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9648a97bc3c891b8',t:'MTc1MzQxNTEwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
