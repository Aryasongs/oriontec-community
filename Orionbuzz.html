<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oriobuzz - Social Media Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Font and base styles */
        * {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .buzz-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
            transform: translateZ(0);
            will-change: transform, box-shadow;
        }
        
        .buzz-card:active {
            transform: scale(0.98);
            border-left-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }
        
        @media (hover: hover) {
            .buzz-card:hover {
                border-left-color: #10b981;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
            }
            
            .buzz-actions {
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .buzz-card:hover .buzz-actions {
                opacity: 1;
            }
        }
        
        @media (hover: none) {
            .buzz-actions {
                opacity: 1;
            }
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .story-template-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .story-template-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .story-template-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .story-template-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .story-template-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .story-template-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        
        .like-animation {
            animation: likeHeart 0.6s ease-in-out;
        }
        
        @keyframes likeHeart {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #ef4444; }
            100% { transform: scale(1); }
        }
        
        /* Mobile-optimized button styles */
        .mobile-btn {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateZ(0);
            will-change: transform, background-color;
        }
        
        .mobile-btn:active {
            transform: scale(0.95);
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .mobile-btn-primary {
            background: linear-gradient(135deg, #10b981, #ec4899);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .mobile-btn-primary:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
        
        .floating-heart {
            animation: floatUp 1s ease-out forwards;
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        
        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        
        .modal-content {
            transform: translateZ(0);
            will-change: transform;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            border-radius: 20px 20px 0 0;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .story-ring {
            background: linear-gradient(45deg, #10b981, #ec4899, #8b5cf6, #06b6d4);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .notification-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .post-grid-item {
            transition: transform 0.2s ease;
        }
        
        .post-grid-item:hover {
            transform: scale(1.05);
        }
        
        .profile-image-placeholder {
            background: linear-gradient(135deg, #10b981, #ec4899);
        }
        
        .coming-soon-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        /* Custom Verified Badge */
        .verified-badge {
            background: linear-gradient(45deg, #10b981, #06b6d4);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            position: relative;
        }
        
        .verified-badge::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, #10b981, #06b6d4, #8b5cf6);
            border-radius: 50%;
            z-index: -1;
            animation: verifiedGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes verifiedGlow {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.1); }
        }
        
        .online-indicator {
            width: 12px;
            height: 12px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            right: 0;
            animation: onlinePulse 2s infinite;
        }
        
        @keyframes onlinePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            space-x: 1;
        }
        
        .typing-dot {
            width: 4px;
            height: 4px;
            background: #10b981;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .post-composer {
            transition: all 0.3s ease;
        }
        
        .post-composer.focused {
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }
        
        .character-count {
            transition: color 0.3s ease;
        }
        
        .character-count.warning {
            color: #f59e0b;
        }
        
        .character-count.danger {
            color: #ef4444;
        }
        
        .blocked-user {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        
        .private-account {
            position: relative;
        }
        
        .private-account::after {
            content: 'üîí';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
        }
        
        .location-tag {
            background: linear-gradient(45deg, #10b981, #06b6d4);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .mood-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        
        .mood-happy { background: #10b981; }
        .mood-sad { background: #6b7280; }
        .mood-excited { background: #f59e0b; }
        .mood-love { background: #ec4899; }
        
        .account-switcher {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .post-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .post-item:hover .post-actions {
            opacity: 1;
        }
        
        .engagement-stats {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
        }
        
        .trending-topic {
            background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
            border-left: 3px solid #10b981;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .activity-indicator {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: activityPulse 2s infinite;
        }
        
        @keyframes activityPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Skeleton loading states */
        .skeleton-buzz {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        .skeleton-text {
            height: 16px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin: 8px 0;
        }
        
        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }
        
        .pulse-loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .route-transition {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Responsive spacing and typography */
        @media (max-width: 640px) {
            .container-mobile {
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .text-responsive {
                font-size: 16px;
                line-height: 1.5;
            }
            
            .buzz-card {
                margin-bottom: 8px;
                border-radius: 16px;
                padding: 16px;
            }
            
            .nav-mobile {
                padding: 12px 16px;
                border-radius: 0;
            }
            
            .modal-mobile {
                border-radius: 24px 24px 0 0;
                max-height: 90vh;
            }
        }
        
        /* Smooth scrolling for mobile */
        .scroll-smooth {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Pull-to-refresh indicator */
        .pull-indicator {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #10b981;
            font-size: 14px;
            opacity: 0;
            transform: translateY(-60px);
            transition: all 0.3s ease;
        }
        
        .pull-indicator.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Improved touch targets */
        .touch-target {
            min-height: 48px;
            min-width: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Swipe gestures */
        .swipeable {
            touch-action: pan-x;
        }
        
        /* Loading states */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2aDGTKSbkeFnG5aAPPVGkGk3-JOsfbDQ",
            authDomain: "dozeranews.firebaseapp.com",
            projectId: "dozeranews",
            storageBucket: "dozeranews.firebasestorage.app",
            messagingSenderId: "162732208376",
            appId: "1:162732208376:web:6a0fe4df447b2e9a090b0d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
    </script>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-green-400 via-pink-500 to-purple-600 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-green-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-comments text-white text-3xl"></i>
                </div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-green-500 to-pink-500 bg-clip-text text-transparent">Oriobuzz</h1>
                <p class="text-gray-600 mt-2">Connect, Share, Discover</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="signInWithGoogle()" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors">
                    <i class="fab fa-google"></i>
                    <span>Continue with Google</span>
                </button>
                
                <button onclick="signInWithTwitter()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors">
                    <i class="fab fa-twitter"></i>
                    <span>Continue with Twitter</span>
                </button>
                
                <button onclick="signInWithGitHub()" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors">
                    <i class="fab fa-github"></i>
                    <span>Continue with GitHub</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="mainApp" class="hidden min-h-screen bg-gray-50">
        <!-- Top Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 nav-mobile">
            <div class="flex items-center justify-between container-mobile">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-pink-500 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-comments text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-green-500 to-pink-500 bg-clip-text text-transparent">Oriobuzz</h1>
                        <div class="activity-indicator"></div>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div class="flex-1 max-w-sm mx-4">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search..." 
                               class="w-full bg-gray-100 rounded-full py-3 px-4 pl-12 pr-12 focus:outline-none focus:ring-2 focus:ring-green-500 focus:bg-white transition-all text-responsive">
                        <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                        <button onclick="clearSearch()" id="clearSearchBtn" class="hidden absolute right-4 top-3.5 text-gray-400 hover:text-gray-600 touch-target">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center space-x-1">
                    <!-- Location -->
                    <button onclick="detectLocation()" class="mobile-btn text-gray-600 hover:text-green-500">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    
                    <!-- Profile -->
                    <button onclick="showProfile()" class="relative mobile-btn">
                        <div class="w-10 h-10 profile-image-placeholder rounded-full flex items-center justify-center text-white font-bold shadow-md">
                            <span id="userInitial">U</span>
                            <div id="onlineStatus" class="online-indicator"></div>
                        </div>
                        <div id="notificationBadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full notification-badge flex items-center justify-center">
                            <span class="text-xs text-white font-bold">!</span>
                        </div>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Stories Section -->
        <div class="bg-white border-b border-gray-200 container-mobile py-4">
            <div class="flex space-x-4 overflow-x-auto pb-2 scroll-smooth">
                <!-- Add Story Button -->
                <div class="flex-shrink-0 text-center">
                    <button onclick="showStoryCreator()" class="w-18 h-18 bg-gradient-to-r from-green-500 to-pink-500 rounded-full flex items-center justify-center text-white text-2xl relative shadow-lg mobile-btn-primary">
                        <i class="fas fa-plus"></i>
                        <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-white rounded-full flex items-center justify-center shadow-md">
                            <i class="fas fa-plus text-green-500 text-xs"></i>
                        </div>
                    </button>
                    <p class="text-xs mt-2 text-gray-600 font-medium">Your Story</p>
                </div>
                
                <!-- Stories -->
                <div id="storiesContainer" class="flex space-x-4">
                    <!-- Stories will be populated here -->
                </div>
            </div>
        </div>

        <!-- Trending Hashtags -->
        <div class="bg-white border-b border-gray-200 p-4">
            <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-fire text-orange-500 mr-2"></i>
                Trending
            </h3>
            <div class="flex flex-wrap gap-2" id="trendingHashtags">
                <!-- Trending hashtags will be populated here -->
            </div>
        </div>

        <!-- Post Composer -->
        <div class="bg-white border-b border-gray-200 container-mobile py-4 post-composer" id="postComposer">
            <div class="flex space-x-4">
                <div class="w-12 h-12 profile-image-placeholder rounded-full flex items-center justify-center text-white font-bold relative shadow-md">
                    <span id="composerUserInitial">U</span>
                    <div class="mood-indicator mood-happy" id="currentMood"></div>
                </div>
                <div class="flex-1">
                    <div class="relative">
                        <textarea id="postText" placeholder="What's buzzing today?" 
                                  class="w-full resize-none border-none outline-none text-lg placeholder-gray-500 text-responsive min-h-[80px]" 
                                  rows="3" maxlength="280"></textarea>
                        <div id="typingIndicator" class="hidden typing-indicator absolute bottom-2 right-2">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    
                    <!-- Post Options -->
                    <div class="flex items-center justify-between mt-4">
                        <div class="flex space-x-1">
                            <!-- Mood Selector -->
                            <div class="relative">
                                <button onclick="showMoodSelector()" class="mobile-btn text-green-500">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <div id="moodSelector" class="hidden absolute top-full left-0 bg-white border rounded-xl shadow-lg p-3 z-10 modal-content">
                                    <button onclick="setMood('happy')" class="block w-full text-left p-3 hover:bg-gray-50 rounded-lg transition-colors">üòä Happy</button>
                                    <button onclick="setMood('excited')" class="block w-full text-left p-3 hover:bg-gray-50 rounded-lg transition-colors">üéâ Excited</button>
                                    <button onclick="setMood('love')" class="block w-full text-left p-3 hover:bg-gray-50 rounded-lg transition-colors">‚ù§Ô∏è Love</button>
                                    <button onclick="setMood('sad')" class="block w-full text-left p-3 hover:bg-gray-50 rounded-lg transition-colors">üò¢ Sad</button>
                                </div>
                            </div>
                            
                            <button onclick="addLocation()" class="mobile-btn text-green-500">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                            <button onclick="addHashtag()" class="mobile-btn text-green-500">
                                <i class="fas fa-hashtag"></i>
                            </button>
                            <button onclick="addMention()" class="mobile-btn text-green-500">
                                <i class="fas fa-at"></i>
                            </button>
                            
                            <!-- Privacy Selector -->
                            <div class="relative">
                                <button onclick="showPrivacySelector()" class="mobile-btn text-green-500">
                                    <i class="fas fa-globe" id="privacyIcon"></i>
                                </button>
                                <div id="privacySelector" class="hidden absolute top-full left-0 bg-white border rounded-xl shadow-lg p-3 z-10 modal-content">
                                    <button onclick="setPrivacy('public')" class="block w-full text-left p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                        <i class="fas fa-globe mr-3"></i>Public
                                    </button>
                                    <button onclick="setPrivacy('followers')" class="block w-full text-left p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                        <i class="fas fa-users mr-3"></i>Followers
                                    </button>
                                    <button onclick="setPrivacy('private')" class="block w-full text-left p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                        <i class="fas fa-lock mr-3"></i>Private
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <span id="characterCount" class="text-sm text-gray-500 character-count font-medium">0/280</span>
                            <button onclick="createBuzz()" id="buzzButton" class="mobile-btn-primary px-6 py-3 rounded-full font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Buzz
                            </button>
                        </div>
                    </div>
                    
                    <!-- Location Tag -->
                    <div id="locationTag" class="hidden mt-2">
                        <span class="location-tag">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="locationText">Location</span>
                            <button onclick="removeLocation()" class="ml-1 hover:text-red-300">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pull to Refresh Indicator -->
        <div id="pullIndicator" class="pull-indicator">
            <i class="fas fa-arrow-down mr-2"></i>
            <span>Pull to refresh</span>
        </div>

        <!-- Feed -->
        <div id="feedContainer" class="pb-24 scroll-smooth" style="scroll-padding-top: 100px;">
            <!-- Posts will be populated here -->
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 backdrop-filter backdrop-blur-lg bg-opacity-95">
            <div class="flex justify-around py-3 safe-area-inset-bottom">
                <button onclick="showFeed()" class="flex flex-col items-center py-2 px-4 text-green-500 mobile-btn rounded-xl" id="homeBtn">
                    <i class="fas fa-home text-xl mb-1"></i>
                    <span class="text-xs font-medium">Home</span>
                </button>
                <button onclick="showSearch()" class="flex flex-col items-center py-2 px-4 text-gray-400 mobile-btn rounded-xl" id="searchBtn">
                    <i class="fas fa-search text-xl mb-1"></i>
                    <span class="text-xs font-medium">Search</span>
                </button>
                <button onclick="showNotifications()" class="flex flex-col items-center py-2 px-4 text-gray-400 relative mobile-btn rounded-xl" id="notificationsBtn">
                    <i class="fas fa-bell text-xl mb-1"></i>
                    <span class="text-xs font-medium">Alerts</span>
                    <div id="notificationDot" class="hidden absolute top-1 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                </button>
                <button onclick="showProfile()" class="flex flex-col items-center py-2 px-4 text-gray-400 mobile-btn rounded-xl" id="profileBtn">
                    <i class="fas fa-user text-xl mb-1"></i>
                    <span class="text-xs font-medium">Profile</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 modal-backdrop z-50">
        <div class="bg-white h-full overflow-y-auto modal-content modal-mobile">
            <!-- Profile Header -->
            <div class="bg-gradient-to-r from-green-500 to-pink-500 container-mobile py-6 text-white relative">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="closeProfile()" class="text-white mobile-btn">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <button onclick="showSettings()" class="text-white mobile-btn">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <div class="w-20 h-20 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-2xl font-bold">
                            <span id="profileUserInitial">U</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center">
                            <h2 id="profileUsername" class="text-xl font-bold mr-2">Username</h2>
                            <div id="verifiedBadge" class="verified-badge hidden">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <p id="profileHandle" class="opacity-80">@username</p>
                        <div class="flex items-center mt-1">
                            <i class="fas fa-map-marker-alt text-sm opacity-80 mr-1"></i>
                            <span id="profileLocation" class="text-sm opacity-80">Location</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-4">
                    <div class="text-center">
                        <p class="font-bold text-lg" id="postsCount">0</p>
                        <p class="text-sm opacity-80">Posts</p>
                    </div>
                    <button onclick="showFollowers()" class="text-center">
                        <p class="font-bold text-lg" id="followersCount">0</p>
                        <p class="text-sm opacity-80">Followers</p>
                    </button>
                    <button onclick="showFollowing()" class="text-center">
                        <p class="font-bold text-lg" id="followingCount">0</p>
                        <p class="text-sm opacity-80">Following</p>
                    </button>
                </div>
            </div>
            
            <!-- Profile Grid -->
            <div class="p-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-th text-green-500 mr-2"></i>
                    Posts
                </h3>
                <div class="grid grid-cols-3 gap-1" id="profileGrid">
                    <!-- User's posts will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="bg-white h-full overflow-y-auto slide-up">
            <div class="p-4 border-b">
                <div class="flex items-center justify-between">
                    <button onclick="closeSettings()" class="text-xl">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-xl font-bold">Settings</h2>
                    <div></div>
                </div>
            </div>
            
            <div class="p-4 space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold mb-3 flex items-center">
                        <i class="fas fa-user-edit text-green-500 mr-2"></i>
                        Profile Settings
                    </h3>
                    <input type="text" id="usernameInput" placeholder="Display Name" class="w-full p-3 border rounded-lg mb-3 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <input type="text" id="locationInput" placeholder="Location" class="w-full p-3 border rounded-lg mb-3 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <button onclick="updateProfile()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>Update Profile
                    </button>
                </div>
                
                <button onclick="signOut()" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="bg-white h-full overflow-y-auto slide-up">
            <div class="p-4 border-b sticky top-0 bg-white">
                <div class="flex items-center justify-between">
                    <button onclick="closeComments()" class="text-xl">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-xl font-bold">Comments</h2>
                    <div></div>
                </div>
            </div>
            
            <div id="commentsContainer" class="p-4 space-y-4">
                <!-- Comments will be populated here -->
            </div>
            
            <!-- Comment Input -->
            <div class="sticky bottom-0 bg-white border-t p-4">
                <div class="flex space-x-2">
                    <input type="text" id="commentInput" placeholder="Add a comment..." 
                           class="flex-1 p-3 border rounded-full px-4 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <button onclick="postComment()" class="bg-gradient-to-r from-green-500 to-pink-500 text-white px-4 py-2 rounded-full">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Followers/Following Modal -->
    <div id="followModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="bg-white h-full overflow-y-auto slide-up">
            <div class="p-4 border-b sticky top-0 bg-white">
                <div class="flex items-center justify-between">
                    <button onclick="closeFollowModal()" class="text-xl">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 id="followModalTitle" class="text-xl font-bold">Followers</h2>
                    <div></div>
                </div>
            </div>
            
            <div id="followList" class="p-4 space-y-3">
                <!-- Follow list will be populated here -->
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="bg-white h-full overflow-y-auto slide-up">
            <div class="p-4 border-b sticky top-0 bg-white">
                <div class="flex items-center justify-between">
                    <button onclick="closeNotifications()" class="text-xl">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-xl font-bold">Notifications</h2>
                    <button onclick="markAllNotificationsRead()" class="text-green-500 text-sm">
                        Mark all read
                    </button>
                </div>
            </div>
            
            <div id="notificationsList" class="p-4 space-y-3">
                <!-- Notifications will be populated here -->
            </div>
        </div>
    </div>

    <!-- Public Profile View Modal -->
    <div id="publicProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="bg-white h-full overflow-y-auto route-transition">
            <!-- Public Profile Header -->
            <div class="bg-gradient-to-r from-green-500 to-pink-500 p-4 text-white relative">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="closePublicProfile()" class="text-white text-xl">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="flex space-x-2">
                        <button onclick="shareProfile()" class="text-white">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <div class="w-20 h-20 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-2xl font-bold">
                            <span id="publicProfileInitial">U</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center">
                            <h2 id="publicProfileUsername" class="text-xl font-bold mr-2">Username</h2>
                            <div id="publicVerifiedBadge" class="verified-badge hidden">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <p id="publicProfileHandle" class="opacity-80">@username</p>
                        <div class="flex items-center mt-1">
                            <i class="fas fa-map-marker-alt text-sm opacity-80 mr-1"></i>
                            <span id="publicProfileLocation" class="text-sm opacity-80">Location</span>
                        </div>
                        <div class="flex items-center mt-1">
                            <i class="fas fa-calendar text-sm opacity-80 mr-1"></i>
                            <span id="publicProfileJoined" class="text-sm opacity-80">Joined</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-4">
                    <div class="text-center">
                        <p class="font-bold text-lg" id="publicPostsCount">0</p>
                        <p class="text-sm opacity-80">Buzzes</p>
                    </div>
                    <div class="text-center">
                        <p class="font-bold text-lg" id="publicFollowersCount">0</p>
                        <p class="text-sm opacity-80">Followers</p>
                    </div>
                    <div class="text-center">
                        <p class="font-bold text-lg" id="publicFollowingCount">0</p>
                        <p class="text-sm opacity-80">Following</p>
                    </div>
                </div>
                
                <div class="mt-4 flex space-x-2" id="publicProfileActions">
                    <!-- Follow/Unfollow buttons will be added here -->
                </div>
            </div>
            
            <!-- Public Profile Buzzes -->
            <div class="p-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-comments text-green-500 mr-2"></i>
                    Recent Buzzes
                </h3>
                <div id="publicProfileBuzzes">
                    <!-- User's buzzes will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentPostId = null;
        let unsubscribeListeners = [];
        let currentLocation = null;
        let currentMood = 'happy';
        let postPrivacy = 'public';
        let isTyping = false;
        let typingTimeout = null;

        // Authentication functions
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            
            auth.signInWithPopup(provider).then((result) => {
                currentUser = result.user;
                initializeUser();
                showMainApp();
            }).catch((error) => {
                console.error('Google sign-in error:', error);
                showToast('Sign-in failed. Please try again.', 'error');
            });
        }

        function signInWithTwitter() {
            const provider = new firebase.auth.TwitterAuthProvider();
            provider.addScope('email');
            
            auth.signInWithPopup(provider).then((result) => {
                currentUser = result.user;
                initializeUser();
                showMainApp();
            }).catch((error) => {
                console.error('Twitter sign-in error:', error);
                showToast('Sign-in failed. Please try again.', 'error');
            });
        }

        function signInWithGitHub() {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('user:email');
            
            auth.signInWithPopup(provider).then((result) => {
                currentUser = result.user;
                initializeUser();
                showMainApp();
            }).catch((error) => {
                console.error('GitHub sign-in error:', error);
                showToast('Sign-in failed. Please try again.', 'error');
            });
        }

        function signOut() {
            // Unsubscribe from all listeners
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
            
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                closeSettings();
            });
        }

        // Initialize user data in Firestore
        function initializeUser() {
            if (currentUser) {
                const initial = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'U';
                document.getElementById('userInitial').textContent = initial;
                document.getElementById('composerUserInitial').textContent = initial;
                document.getElementById('profileUserInitial').textContent = initial;
                document.getElementById('profileUsername').textContent = currentUser.displayName || 'User';
                document.getElementById('profileHandle').textContent = `@${currentUser.email.split('@')[0]}`;
                
                // Create/update user document in Firestore
                const userRef = db.collection('users').doc(currentUser.uid);
                userRef.set({
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || 'User',
                    email: currentUser.email,
                    photoURL: currentUser.photoURL || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    verified: false,
                    followers: [],
                    following: [],
                    location: '',
                    bio: '',
                    isPrivate: false,
                    showOnlineStatus: true,
                    blockedUsers: [],
                    emailNotifications: false,
                    pushNotifications: true,
                    postsCount: 0,
                    followersCount: 0,
                    followingCount: 0
                }, { merge: true }).then(() => {
                    console.log('User data saved to Firestore');
                    setupNotificationListener();
                    loadUserProfile();
                }).catch((error) => {
                    console.error('Error saving user data:', error);
                });
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadFeed();
            loadTrendingHashtags();
            updateNavigation('home');
        }

        // Buzz functions - All data stored in Firestore
        function createBuzz() {
            const buzzText = document.getElementById('postText').value.trim();
            if (!buzzText || !currentUser) return;

            const buzz = {
                text: buzzText,
                author: {
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || 'User',
                    email: currentUser.email,
                    photoURL: currentUser.photoURL || ''
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likes: [],
                comments: [],
                retweets: [],
                mood: currentMood,
                privacy: postPrivacy,
                location: currentLocation,
                buzzId: generateBuzzId(),
                type: 'buzz',
                likesCount: 0,
                commentsCount: 0,
                retweetsCount: 0
            };

            // Save buzz to Firestore
            db.collection('posts').add(buzz).then((docRef) => {
                console.log('Buzz created with ID:', docRef.id);
                
                // Update user's posts count
                db.collection('users').doc(currentUser.uid).update({
                    postsCount: firebase.firestore.FieldValue.increment(1)
                });
                
                // Clear form
                document.getElementById('postText').value = '';
                document.getElementById('characterCount').textContent = '0/280';
                document.getElementById('buzzButton').disabled = true;
                resetBuzzComposer();
                
                // Create notification for followers
                createNotificationForFollowers('new_buzz', {
                    buzzId: docRef.id,
                    buzzText: buzz.text.substring(0, 50) + '...'
                });
                
                showToast('Buzz shared successfully!', 'success');
            }).catch((error) => {
                console.error('Error creating buzz:', error);
                showToast('Failed to share buzz. Please try again.', 'error');
            });
        }
        
        function generateBuzzId() {
            return 'buzz_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function resetBuzzComposer() {
            currentLocation = null;
            document.getElementById('locationTag').classList.add('hidden');
            document.getElementById('postComposer').classList.remove('focused');
            
            // Reset selectors
            document.getElementById('moodSelector').classList.add('hidden');
            document.getElementById('privacySelector').classList.add('hidden');
        }

        // Load feed from Firestore
        function loadFeed() {
            showSkeletonFeed();
            
            const unsubscribe = db.collection('posts')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot((querySnapshot) => {
                    const feedContainer = document.getElementById('feedContainer');
                    feedContainer.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        feedContainer.innerHTML = `
                            <div class="text-center py-8">
                                <i class="fas fa-comments text-4xl text-gray-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-700 mb-2">No buzzes yet</h3>
                                <p class="text-gray-500">Be the first to share something!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const buzz = doc.data();
                        const buzzElement = createBuzzElement(doc.id, buzz);
                        feedContainer.appendChild(buzzElement);
                    });
                });
            
            unsubscribeListeners.push(unsubscribe);
        }

        function showSkeletonFeed() {
            const feedContainer = document.getElementById('feedContainer');
            feedContainer.innerHTML = '';
            
            // Add skeleton buzzes
            for (let i = 0; i < 5; i++) {
                const skeletonBuzz = document.createElement('div');
                skeletonBuzz.className = 'skeleton-buzz';
                skeletonBuzz.innerHTML = `
                    <div class="flex space-x-3">
                        <div class="skeleton-avatar"></div>
                        <div class="flex-1">
                            <div class="skeleton-text short"></div>
                            <div class="skeleton-text long"></div>
                            <div class="skeleton-text medium"></div>
                            <div class="flex space-x-4 mt-3">
                                <div class="skeleton-text" style="width: 60px; height: 12px;"></div>
                                <div class="skeleton-text" style="width: 60px; height: 12px;"></div>
                                <div class="skeleton-text" style="width: 60px; height: 12px;"></div>
                            </div>
                        </div>
                    </div>
                `;
                feedContainer.appendChild(skeletonBuzz);
            }
        }

        function createBuzzElement(buzzId, buzz) {
            const buzzDiv = document.createElement('div');
            buzzDiv.className = 'bg-white border-b border-gray-200 p-4 buzz-card';
            
            const initial = buzz.author.displayName ? buzz.author.displayName.charAt(0).toUpperCase() : 'U';
            const isLiked = currentUser && buzz.likes && buzz.likes.includes(currentUser.uid);
            const likeCount = buzz.likesCount || (buzz.likes ? buzz.likes.length : 0);
            const commentCount = buzz.commentsCount || (buzz.comments ? buzz.comments.length : 0);
            const isOwnBuzz = currentUser && buzz.author.uid === currentUser.uid;
            const username = buzz.author.email.split('@')[0];
            
            const moodEmoji = {
                'happy': 'üòä',
                'excited': 'üéâ',
                'love': '‚ù§Ô∏è',
                'sad': 'üò¢'
            };
            
            const privacyIcon = buzz.privacy === 'public' ? 'fas fa-globe' : 
                              buzz.privacy === 'followers' ? 'fas fa-users' : 'fas fa-lock';
            
            buzzDiv.innerHTML = `
                <div class="flex space-x-3">
                    <button onclick="showUserProfile('${buzz.author.uid}')" class="w-10 h-10 profile-image-placeholder rounded-full flex items-center justify-center text-white font-bold relative hover:opacity-80 transition-opacity">
                        ${initial}
                        ${buzz.mood ? `<div class="mood-indicator mood-${buzz.mood}" title="${buzz.mood}"></div>` : ''}
                    </button>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <button onclick="showUserProfile('${buzz.author.uid}')" class="font-semibold hover:text-green-500 transition-colors">${buzz.author.displayName || 'User'}</button>
                            <button onclick="showUserProfile('${buzz.author.uid}')" class="text-gray-500 text-sm hover:text-green-500 transition-colors">@${username}</button>
                            <span class="text-gray-500 text-sm">¬∑</span>
                            <span class="text-gray-500 text-sm">${formatTimestamp(buzz.timestamp)}</span>
                            <i class="${privacyIcon} text-gray-400 text-xs" title="${buzz.privacy}"></i>
                            ${buzz.mood ? `<span class="text-sm" title="${buzz.mood}">${moodEmoji[buzz.mood] || ''}</span>` : ''}
                        </div>
                        
                        <p class="mt-2 text-gray-800">${formatPostText(buzz.text)}</p>
                        
                        ${buzz.location ? `
                            <div class="mt-2">
                                <span class="location-tag">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${buzz.location}
                                </span>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between mt-3">
                            <div class="flex items-center space-x-6 text-gray-500">
                                <button onclick="showComments('${buzzId}')" class="flex items-center space-x-1 hover:text-green-500 transition-colors">
                                    <i class="far fa-comment"></i>
                                    <span>${commentCount}</span>
                                </button>
                                <button onclick="toggleLike('${buzzId}')" class="flex items-center space-x-1 hover:text-red-500 transition-colors ${isLiked ? 'text-red-500' : ''}" id="like-btn-${buzzId}">
                                    <i class="fa${isLiked ? 's' : 'r'} fa-heart"></i>
                                    <span class="like-count-${buzzId}">${likeCount}</span>
                                </button>
                                <button onclick="sharePost('${buzzId}')" class="hover:text-blue-500 transition-colors" title="Share">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                            
                            <div class="buzz-actions flex items-center space-x-2">
                                ${isOwnBuzz ? `<button onclick="deleteBuzz('${buzzId}')" class="hover:text-red-500 transition-colors text-xs" title="Delete"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        </div>
                        
                        ${(likeCount > 0 || commentCount > 0) ? `
                            <div class="engagement-stats mt-2">
                                <div class="flex items-center space-x-4 text-xs text-gray-600">
                                    ${likeCount > 0 ? `<span><i class="fas fa-heart text-red-500 mr-1"></i>${likeCount} likes</span>` : ''}
                                    ${commentCount > 0 ? `<span><i class="fas fa-comment text-green-500 mr-1"></i>${commentCount} comments</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return buzzDiv;
        }

        // Like functionality with Firestore
        function toggleLike(buzzId) {
            if (!currentUser) return;
            
            const buzzRef = db.collection('posts').doc(buzzId);
            
            db.runTransaction((transaction) => {
                return transaction.get(buzzRef).then((doc) => {
                    if (!doc.exists) {
                        throw new Error('Buzz does not exist!');
                    }
                    
                    const buzz = doc.data();
                    const likes = buzz.likes || [];
                    const isLiked = likes.includes(currentUser.uid);
                    
                    let newLikes;
                    let newLikesCount;
                    
                    if (isLiked) {
                        newLikes = likes.filter(uid => uid !== currentUser.uid);
                        newLikesCount = (buzz.likesCount || 0) - 1;
                    } else {
                        newLikes = [...likes, currentUser.uid];
                        newLikesCount = (buzz.likesCount || 0) + 1;
                        
                        // Add like animation
                        const likeBtn = document.getElementById(`like-btn-${buzzId}`);
                        if (likeBtn) {
                            likeBtn.classList.add('like-animation');
                            setTimeout(() => likeBtn.classList.remove('like-animation'), 600);
                        }
                        
                        // Create notification for buzz author
                        if (buzz.author.uid !== currentUser.uid) {
                            createNotification(buzz.author.uid, 'like', {
                                buzzId: buzzId,
                                buzzText: buzz.text.substring(0, 50) + '...'
                            });
                        }
                    }
                    
                    transaction.update(buzzRef, { 
                        likes: newLikes,
                        likesCount: Math.max(0, newLikesCount)
                    });
                });
            }).then(() => {
                console.log('Like updated successfully');
            }).catch((error) => {
                console.error('Error updating like:', error);
            });
        }

        // Follow system with Firestore
        function toggleFollow(userId) {
            if (!currentUser || userId === currentUser.uid) return;
            
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            const targetUserRef = db.collection('users').doc(userId);
            
            db.runTransaction((transaction) => {
                return transaction.get(currentUserRef).then((currentUserDoc) => {
                    return transaction.get(targetUserRef).then((targetUserDoc) => {
                        if (!currentUserDoc.exists || !targetUserDoc.exists) {
                            throw new Error('User does not exist!');
                        }
                        
                        const currentUserData = currentUserDoc.data();
                        const targetUserData = targetUserDoc.data();
                        
                        const currentFollowing = currentUserData.following || [];
                        const targetFollowers = targetUserData.followers || [];
                        
                        const isFollowing = currentFollowing.includes(userId);
                        
                        if (isFollowing) {
                            // Unfollow
                            const newFollowing = currentFollowing.filter(id => id !== userId);
                            const newFollowers = targetFollowers.filter(id => id !== currentUser.uid);
                            
                            transaction.update(currentUserRef, {
                                following: newFollowing,
                                followingCount: Math.max(0, newFollowing.length)
                            });
                            transaction.update(targetUserRef, {
                                followers: newFollowers,
                                followersCount: Math.max(0, newFollowers.length)
                            });
                        } else {
                            // Follow
                            const newFollowing = [...currentFollowing, userId];
                            const newFollowers = [...targetFollowers, currentUser.uid];
                            
                            transaction.update(currentUserRef, {
                                following: newFollowing,
                                followingCount: newFollowing.length
                            });
                            transaction.update(targetUserRef, {
                                followers: newFollowers,
                                followersCount: newFollowers.length
                            });
                            
                            // Create notification
                            createNotification(userId, 'follow', {
                                followerId: currentUser.uid
                            });
                        }
                        
                        return !isFollowing;
                    });
                });
            }).then((nowFollowing) => {
                showToast(nowFollowing ? 'Following user' : 'Unfollowed user', 'success');
                
                // Refresh profile if viewing
                if (!document.getElementById('publicProfileModal').classList.contains('hidden')) {
                    loadPublicProfileData(userId);
                }
            }).catch((error) => {
                console.error('Follow/unfollow error:', error);
                showToast('Failed to update follow status', 'error');
            });
        }

        // Show user profile
        function showUserProfile(userId) {
            if (userId === currentUser.uid) {
                showProfile();
                return;
            }
            
            document.getElementById('publicProfileModal').classList.remove('hidden');
            loadPublicProfileData(userId);
        }

        function loadPublicProfileData(userId) {
            db.collection('users').doc(userId).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    const initial = userData.displayName ? userData.displayName.charAt(0).toUpperCase() : 'U';
                    const username = userData.email.split('@')[0];
                    
                    document.getElementById('publicProfileInitial').textContent = initial;
                    document.getElementById('publicProfileUsername').textContent = userData.displayName || 'User';
                    document.getElementById('publicProfileHandle').textContent = `@${username}`;
                    document.getElementById('publicProfileLocation').textContent = userData.location || 'Location not set';
                    
                    if (userData.createdAt) {
                        const joinDate = userData.createdAt.toDate();
                        document.getElementById('publicProfileJoined').textContent = `Joined ${joinDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
                    }
                    
                    if (userData.verified) {
                        document.getElementById('publicVerifiedBadge').classList.remove('hidden');
                    }
                    
                    // Load counts
                    document.getElementById('publicFollowersCount').textContent = userData.followersCount || 0;
                    document.getElementById('publicFollowingCount').textContent = userData.followingCount || 0;
                    document.getElementById('publicPostsCount').textContent = userData.postsCount || 0;
                    
                    // Add follow/unfollow button
                    const actionsContainer = document.getElementById('publicProfileActions');
                    if (currentUser && currentUser.uid !== userId) {
                        const isFollowing = userData.followers && userData.followers.includes(currentUser.uid);
                        actionsContainer.innerHTML = `
                            <button onclick="toggleFollow('${userId}')" class="flex-1 ${isFollowing ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-500 hover:bg-green-600'} text-white py-2 px-4 rounded-lg transition-colors">
                                ${isFollowing ? 'Unfollow' : 'Follow'}
                            </button>
                        `;
                    } else {
                        actionsContainer.innerHTML = '';
                    }
                    
                    // Load user's buzzes
                    loadPublicProfileBuzzes(userId);
                } else {
                    showProfileNotFound();
                }
            }).catch((error) => {
                console.error('Error loading profile:', error);
                showProfileNotFound();
            });
        }

        function loadPublicProfileBuzzes(userId) {
            db.collection('posts')
                .where('author.uid', '==', userId)
                .where('privacy', '==', 'public')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    const profileBuzzes = document.getElementById('publicProfileBuzzes');
                    profileBuzzes.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        profileBuzzes.innerHTML = '<p class="text-center text-gray-500 py-8">No public buzzes yet</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const buzz = doc.data();
                        const buzzElement = createBuzzElement(doc.id, buzz);
                        profileBuzzes.appendChild(buzzElement);
                    });
                });
        }

        function showProfileNotFound() {
            const profileBuzzes = document.getElementById('publicProfileBuzzes');
            profileBuzzes.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Profile not found</h3>
                    <p class="text-gray-500">This user doesn't exist or has been deactivated.</p>
                </div>
            `;
        }

        function closePublicProfile() {
            document.getElementById('publicProfileModal').classList.add('hidden');
        }

        // Comments functionality with Firestore
        function showComments(buzzId) {
            currentPostId = buzzId;
            document.getElementById('commentsModal').classList.remove('hidden');
            loadComments(buzzId);
        }

        function closeComments() {
            document.getElementById('commentsModal').classList.add('hidden');
            currentPostId = null;
        }

        function loadComments(buzzId) {
            const unsubscribe = db.collection('posts').doc(buzzId).collection('comments')
                .orderBy('timestamp', 'desc')
                .onSnapshot((querySnapshot) => {
                    const commentsContainer = document.getElementById('commentsContainer');
                    commentsContainer.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        commentsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No comments yet</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const comment = doc.data();
                        const commentElement = createCommentElement(doc.id, comment);
                        commentsContainer.appendChild(commentElement);
                    });
                });
            
            unsubscribeListeners.push(unsubscribe);
        }

        function createCommentElement(commentId, comment) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'flex space-x-3 p-3 bg-gray-50 rounded-lg';
            
            const initial = comment.author.displayName ? comment.author.displayName.charAt(0).toUpperCase() : 'U';
            const isLiked = comment.likes && comment.likes.includes(currentUser.uid);
            const likeCount = comment.likes ? comment.likes.length : 0;
            const isOwnComment = comment.author.uid === currentUser.uid;
            
            commentDiv.innerHTML = `
                <button onclick="showUserProfile('${comment.author.uid}')" class="w-8 h-8 profile-image-placeholder rounded-full flex items-center justify-center text-white font-bold text-sm hover:opacity-80 transition-opacity">
                    ${initial}
                </button>
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <button onclick="showUserProfile('${comment.author.uid}')" class="font-semibold text-sm hover:text-green-500 transition-colors">${comment.author.displayName || 'User'}</button>
                        <span class="text-gray-500 text-xs">${formatTimestamp(comment.timestamp)}</span>
                        ${isOwnComment ? '<button onclick="deleteComment(\'' + commentId + '\')" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash text-xs"></i></button>' : ''}
                    </div>
                    <p class="mt-1 text-sm text-gray-800">${comment.text}</p>
                    <div class="flex items-center space-x-4 mt-2">
                        <button onclick="toggleCommentLike('${commentId}')" class="flex items-center space-x-1 text-xs hover:text-red-500 transition-colors ${isLiked ? 'text-red-500' : 'text-gray-500'}">
                            <i class="fa${isLiked ? 's' : 'r'} fa-heart"></i>
                            <span>${likeCount}</span>
                        </button>
                    </div>
                </div>
            `;
            
            return commentDiv;
        }

        function postComment() {
            const commentText = document.getElementById('commentInput').value.trim();
            if (!commentText || !currentUser || !currentPostId) return;

            const comment = {
                text: commentText,
                author: {
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || 'User',
                    email: currentUser.email
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likes: []
            };

            // Add comment to Firestore
            db.collection('posts').doc(currentPostId).collection('comments').add(comment).then(() => {
                document.getElementById('commentInput').value = '';
                
                // Update comment count in main buzz
                db.collection('posts').doc(currentPostId).update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                });
                
                // Get buzz data for notification
                db.collection('posts').doc(currentPostId).get().then((doc) => {
                    if (doc.exists) {
                        const buzz = doc.data();
                        if (buzz.author.uid !== currentUser.uid) {
                            createNotification(buzz.author.uid, 'comment', {
                                buzzId: currentPostId,
                                buzzText: buzz.text.substring(0, 50) + '...',
                                commentText: commentText
                            });
                        }
                    }
                });
            }).catch((error) => {
                console.error('Error posting comment:', error);
                showToast('Failed to post comment', 'error');
            });
        }

        function toggleCommentLike(commentId) {
            if (!currentUser || !currentPostId) return;
            
            const commentRef = db.collection('posts').doc(currentPostId).collection('comments').doc(commentId);
            
            db.runTransaction((transaction) => {
                return transaction.get(commentRef).then((doc) => {
                    if (!doc.exists) {
                        throw new Error('Comment does not exist!');
                    }
                    
                    const comment = doc.data();
                    const likes = comment.likes || [];
                    const isLiked = likes.includes(currentUser.uid);
                    
                    const newLikes = isLiked 
                        ? likes.filter(uid => uid !== currentUser.uid)
                        : [...likes, currentUser.uid];
                    
                    transaction.update(commentRef, { likes: newLikes });
                });
            }).catch((error) => {
                console.error('Error updating comment like:', error);
            });
        }

        function deleteComment(commentId) {
            if (confirm('Are you sure you want to delete this comment?')) {
                db.collection('posts').doc(currentPostId).collection('comments').doc(commentId).delete().then(() => {
                    // Update comment count
                    db.collection('posts').doc(currentPostId).update({
                        commentsCount: firebase.firestore.FieldValue.increment(-1)
                    });
                }).catch((error) => {
                    console.error('Error deleting comment:', error);
                });
            }
        }

        // Profile functions
        function showProfile() {
            document.getElementById('profileModal').classList.remove('hidden');
            loadUserProfile();
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function loadUserProfile() {
            if (!currentUser) return;
            
            // Load user data from Firestore
            db.collection('users').doc(currentUser.uid).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    document.getElementById('followersCount').textContent = userData.followersCount || 0;
                    document.getElementById('followingCount').textContent = userData.followingCount || 0;
                    document.getElementById('postsCount').textContent = userData.postsCount || 0;
                    
                    if (userData.verified) {
                        document.getElementById('verifiedBadge').classList.remove('hidden');
                    }
                    
                    if (userData.location) {
                        document.getElementById('profileLocation').textContent = userData.location;
                    }
                }
            });
            
            // Load user's posts for profile grid
            db.collection('posts')
                .where('author.uid', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get()
                .then((querySnapshot) => {
                    const profileGrid = document.getElementById('profileGrid');
                    profileGrid.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        profileGrid.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-500">No posts yet</div>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const post = doc.data();
                        const gridItem = document.createElement('div');
                        gridItem.className = 'aspect-square bg-gray-200 rounded-lg flex flex-col items-center justify-center text-xs p-2 cursor-pointer hover:opacity-80 transition-opacity post-grid-item';
                        
                        const likeCount = post.likesCount || 0;
                        const commentCount = post.commentsCount || 0;
                        
                        gridItem.innerHTML = `
                            <p class="text-center text-gray-700 mb-2 line-clamp-3">${post.text.substring(0, 50)}${post.text.length > 50 ? '...' : ''}</p>
                            <div class="flex space-x-2 text-gray-500">
                                <span><i class="far fa-heart"></i> ${likeCount}</span>
                                <span><i class="far fa-comment"></i> ${commentCount}</span>
                            </div>
                        `;
                        
                        gridItem.onclick = () => showComments(doc.id);
                        profileGrid.appendChild(gridItem);
                    });
                });
        }

        // Followers/Following functions
        function showFollowers() {
            document.getElementById('followModalTitle').textContent = 'Followers';
            document.getElementById('followModal').classList.remove('hidden');
            loadFollowList('followers');
        }

        function showFollowing() {
            document.getElementById('followModalTitle').textContent = 'Following';
            document.getElementById('followModal').classList.remove('hidden');
            loadFollowList('following');
        }

        function closeFollowModal() {
            document.getElementById('followModal').classList.add('hidden');
        }

        function loadFollowList(type) {
            db.collection('users').doc(currentUser.uid).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    const userIds = userData[type] || [];
                    const followList = document.getElementById('followList');
                    followList.innerHTML = '';
                    
                    if (userIds.length === 0) {
                        followList.innerHTML = '<p class="text-center text-gray-500">No users found</p>';
                        return;
                    }
                    
                    userIds.forEach(userId => {
                        db.collection('users').doc(userId).get().then((userDoc) => {
                            if (userDoc.exists) {
                                const user = userDoc.data();
                                const userElement = createFollowUserElement(userId, user);
                                followList.appendChild(userElement);
                            }
                        });
                    });
                }
            });
        }

        function createFollowUserElement(userId, user) {
            const userDiv = document.createElement('div');
            userDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            
            const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
            
            userDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <button onclick="showUserProfile('${userId}')" class="w-10 h-10 profile-image-placeholder rounded-full flex items-center justify-center text-white font-bold hover:opacity-80 transition-opacity">
                        ${initial}
                    </button>
                    <div>
                        <button onclick="showUserProfile('${userId}')" class="font-semibold hover:text-green-500 transition-colors">${user.displayName || 'User'}</button>
                        <p class="text-sm text-gray-500">@${user.email.split('@')[0]}</p>
                    </div>
                </div>
                <button onclick="toggleFollow('${userId}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded-full text-sm transition-colors">
                    Following
                </button>
            `;
            
            return userDiv;
        }

        // Settings functions
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            
            // Pre-fill current values
            document.getElementById('usernameInput').value = currentUser.displayName || '';
            
            db.collection('users').doc(currentUser.uid).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    document.getElementById('locationInput').value = userData.location || '';
                }
            });
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function updateProfile() {
            const username = document.getElementById('usernameInput').value.trim();
            const location = document.getElementById('locationInput').value.trim();
            
            if (!currentUser) return;
            
            const updates = {};
            if (username) updates.displayName = username;
            if (location) updates.location = location;
            
            db.collection('users').doc(currentUser.uid).update(updates).then(() => {
                showToast('Profile updated successfully!', 'success');
                if (username) {
                    currentUser.displayName = username;
                    initializeUser();
                }
                loadUserProfile();
            }).catch((error) => {
                console.error('Error updating profile:', error);
                showToast('Failed to update profile', 'error');
            });
        }

        // Notification functions
        function setupNotificationListener() {
            const unsubscribe = db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .where('read', '==', false)
                .onSnapshot((querySnapshot) => {
                    const unreadCount = querySnapshot.size;
                    const notificationBadge = document.getElementById('notificationBadge');
                    const notificationDot = document.getElementById('notificationDot');
                    
                    if (unreadCount > 0) {
                        notificationBadge.classList.remove('hidden');
                        notificationDot.classList.remove('hidden');
                    } else {
                        notificationBadge.classList.add('hidden');
                        notificationDot.classList.add('hidden');
                    }
                });
            
            unsubscribeListeners.push(unsubscribe);
        }

        function createNotification(userId, type, data) {
            const notification = {
                userId: userId,
                type: type,
                data: data,
                from: {
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || 'User',
                    email: currentUser.email
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            };
            
            db.collection('notifications').add(notification);
        }

        function createNotificationForFollowers(type, data) {
            db.collection('users').doc(currentUser.uid).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    const followers = userData.followers || [];
                    
                    followers.forEach(followerId => {
                        createNotification(followerId, type, data);
                    });
                }
            });
        }

        function showNotifications() {
            document.getElementById('notificationsModal').classList.remove('hidden');
            loadNotifications();
            updateNavigation('notifications');
        }

        function closeNotifications() {
            document.getElementById('notificationsModal').classList.add('hidden');
        }

        function loadNotifications() {
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get()
                .then((querySnapshot) => {
                    const notificationsList = document.getElementById('notificationsList');
                    notificationsList.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        notificationsList.innerHTML = '<p class="text-center text-gray-500">No notifications yet</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const notification = doc.data();
                        const notificationElement = createNotificationElement(doc.id, notification);
                        notificationsList.appendChild(notificationElement);
                    });
                });
        }

        function createNotificationElement(notificationId, notification) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `p-3 rounded-lg ${notification.read ? 'bg-gray-50' : 'bg-blue-50'} cursor-pointer hover:bg-gray-100 transition-colors`;
            
            let message = '';
            let icon = '';
            
            switch (notification.type) {
                case 'like':
                    icon = '<i class="fas fa-heart text-red-500"></i>';
                    message = `${notification.from.displayName} liked your buzz`;
                    break;
                case 'comment':
                    icon = '<i class="fas fa-comment text-green-500"></i>';
                    message = `${notification.from.displayName} commented on your buzz`;
                    break;
                case 'follow':
                    icon = '<i class="fas fa-user-plus text-blue-500"></i>';
                    message = `${notification.from.displayName} started following you`;
                    break;
                case 'new_buzz':
                    icon = '<i class="fas fa-plus text-green-500"></i>';
                    message = `${notification.from.displayName} shared a new buzz`;
                    break;
            }
            
            notificationDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-xl">${icon}</div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                        <p class="text-xs text-gray-500">${formatTimestamp(notification.timestamp)}</p>
                    </div>
                    ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                </div>
            `;
            
            notificationDiv.onclick = () => {
                markNotificationRead(notificationId);
                if (notification.type === 'like' || notification.type === 'comment') {
                    closeNotifications();
                    showComments(notification.data.buzzId);
                }
            };
            
            return notificationDiv;
        }

        function markNotificationRead(notificationId) {
            db.collection('notifications').doc(notificationId).update({ read: true });
        }

        function markAllNotificationsRead() {
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .where('read', '==', false)
                .get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    querySnapshot.forEach((doc) => {
                        batch.update(doc.ref, { read: true });
                    });
                    return batch.commit();
                })
                .then(() => {
                    loadNotifications();
                });
        }

        // Utility functions
        function deleteBuzz(buzzId) {
            if (confirm('Are you sure you want to delete this buzz?')) {
                db.collection('posts').doc(buzzId).delete().then(() => {
                    // Update user's posts count
                    db.collection('users').doc(currentUser.uid).update({
                        postsCount: firebase.firestore.FieldValue.increment(-1)
                    });
                    showToast('Buzz deleted', 'success');
                }).catch((error) => {
                    console.error('Error deleting buzz:', error);
                    showToast('Failed to delete buzz', 'error');
                });
            }
        }

        function sharePost(postId) {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this buzz on Oriobuzz',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showToast('Link copied to clipboard!', 'success');
                });
            }
        }

        function formatPostText(text) {
            // Format hashtags
            text = text.replace(/#(\w+)/g, '<span class="text-green-500 font-semibold cursor-pointer" onclick="searchHashtag(\'#$1\')">#$1</span>');
            // Format mentions
            text = text.replace(/@(\w+)/g, '<span class="text-blue-500 font-semibold cursor-pointer" onclick="searchMention(\'@$1\')">@$1</span>');
            return text;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'now';
            const now = new Date();
            const postTime = timestamp.toDate();
            const diffMs = now - postTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        function loadTrendingHashtags() {
            // Load trending hashtags from recent posts
            db.collection('posts')
                .where('timestamp', '>', new Date(Date.now() - 24 * 60 * 60 * 1000))
                .get()
                .then((querySnapshot) => {
                    const hashtagCount = {};
                    
                    querySnapshot.forEach((doc) => {
                        const post = doc.data();
                        const hashtags = post.text.match(/#\w+/g) || [];
                        hashtags.forEach(hashtag => {
                            hashtagCount[hashtag] = (hashtagCount[hashtag] || 0) + 1;
                        });
                    });
                    
                    const trending = Object.entries(hashtagCount)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5)
                        .map(([hashtag]) => hashtag);
                    
                    const trendingContainer = document.getElementById('trendingHashtags');
                    trendingContainer.innerHTML = trending.map(tag => 
                        `<span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-green-200 transition-colors" onclick="searchHashtag('${tag}')">${tag}</span>`
                    ).join('');
                    
                    // Add default trends if no trending hashtags
                    if (trending.length === 0) {
                        trendingContainer.innerHTML = `
                            <span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-green-200 transition-colors" onclick="searchHashtag('#oriobuzz')">#oriobuzz</span>
                            <span class="bg-pink-100 text-pink-600 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-pink-200 transition-colors" onclick="searchHashtag('#trending')">#trending</span>
                            <span class="bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-purple-200 transition-colors" onclick="searchHashtag('#social')">#social</span>
                        `;
                    }
                });
        }

        function searchHashtag(hashtag) {
            document.getElementById('searchInput').value = hashtag;
            performSearch();
            updateNavigation('search');
        }

        function searchMention(mention) {
            document.getElementById('searchInput').value = mention;
            performSearch();
            updateNavigation('search');
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) return;
            
            // Search posts containing the query
            db.collection('posts')
                .get()
                .then((querySnapshot) => {
                    const feedContainer = document.getElementById('feedContainer');
                    feedContainer.innerHTML = '<div class="p-4 text-center text-gray-500"><i class="fas fa-search mr-2"></i>Search Results</div>';
                    
                    let hasResults = false;
                    
                    querySnapshot.forEach((doc) => {
                        const post = doc.data();
                        if (post.text.toLowerCase().includes(query) || 
                            post.author.displayName.toLowerCase().includes(query) ||
                            post.author.email.toLowerCase().includes(query)) {
                            const postElement = createBuzzElement(doc.id, post);
                            feedContainer.appendChild(postElement);
                            hasResults = true;
                        }
                    });
                    
                    if (!hasResults) {
                        feedContainer.innerHTML = '<div class="p-4 text-center text-gray-500"><i class="fas fa-search mr-2"></i>No results found</div>';
                    }
                });
        }

        // Post composer functions
        function showMoodSelector() {
            const selector = document.getElementById('moodSelector');
            selector.classList.toggle('hidden');
            document.getElementById('privacySelector').classList.add('hidden');
        }

        function setMood(mood) {
            currentMood = mood;
            const moodIndicator = document.getElementById('currentMood');
            moodIndicator.className = `mood-indicator mood-${mood}`;
            document.getElementById('moodSelector').classList.add('hidden');
        }

        function showPrivacySelector() {
            const selector = document.getElementById('privacySelector');
            selector.classList.toggle('hidden');
            document.getElementById('moodSelector').classList.add('hidden');
        }

        function setPrivacy(privacy) {
            postPrivacy = privacy;
            const icon = document.getElementById('privacyIcon');
            icon.className = privacy === 'public' ? 'fas fa-globe' : 
                           privacy === 'followers' ? 'fas fa-users' : 'fas fa-lock';
            document.getElementById('privacySelector').classList.add('hidden');
        }

        function addLocation() {
            const currentText = document.getElementById('postText').value;
            const location = prompt('Add location:');
            if (location) {
                currentLocation = location;
                document.getElementById('locationText').textContent = location;
                document.getElementById('locationTag').classList.remove('hidden');
            }
        }

        function removeLocation() {
            currentLocation = null;
            document.getElementById('locationTag').classList.add('hidden');
        }

        function addHashtag() {
            const currentText = document.getElementById('postText').value;
            const hashtag = prompt('Add hashtag (without #):');
            if (hashtag) {
                document.getElementById('postText').value = currentText + ` #${hashtag}`;
                updateCharacterCount();
            }
        }

        function addMention() {
            const currentText = document.getElementById('postText').value;
            const mention = prompt('Mention user (without @):');
            if (mention) {
                document.getElementById('postText').value = currentText + ` @${mention}`;
                updateCharacterCount();
            }
        }

        function updateCharacterCount() {
            const text = document.getElementById('postText').value;
            const count = text.length;
            const countElement = document.getElementById('characterCount');
            const buzzButton = document.getElementById('buzzButton');
            
            countElement.textContent = `${count}/280`;
            
            if (count > 240) {
                countElement.classList.add('warning');
            } else {
                countElement.classList.remove('warning');
            }
            
            if (count > 270) {
                countElement.classList.add('danger');
            } else {
                countElement.classList.remove('danger');
            }
            
            buzzButton.disabled = count === 0 || count > 280;
        }

        // Navigation functions
        function showFeed() {
            loadFeed();
            updateNavigation('home');
        }

        function showSearch() {
            document.getElementById('searchInput').focus();
            updateNavigation('search');
        }

        function updateNavigation(active) {
            const navButtons = {
                'home': document.getElementById('homeBtn'),
                'search': document.getElementById('searchBtn'),
                'notifications': document.getElementById('notificationsBtn'),
                'profile': document.getElementById('profileBtn')
            };
            
            Object.values(navButtons).forEach(btn => {
                btn.classList.remove('text-green-500');
                btn.classList.add('text-gray-400');
            });
            
            if (navButtons[active]) {
                navButtons[active].classList.add('text-green-500');
                navButtons[active].classList.remove('text-gray-400');
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            loadFeed();
        }

        function detectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        showToast('Location detected successfully', 'success');
                    },
                    (error) => {
                        showToast('Location access denied', 'error');
                    }
                );
            } else {
                showToast('Geolocation not supported', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white font-semibold ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } slide-up`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Mobile touch interactions
        let startY = 0;
        let currentY = 0;
        let pullDistance = 0;
        let isPulling = false;
        
        function initializePullToRefresh() {
            const feedContainer = document.getElementById('feedContainer');
            const pullIndicator = document.getElementById('pullIndicator');
            
            feedContainer.addEventListener('touchstart', (e) => {
                if (feedContainer.scrollTop === 0) {
                    startY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });
            
            feedContainer.addEventListener('touchmove', (e) => {
                if (!isPulling) return;
                
                currentY = e.touches[0].clientY;
                pullDistance = currentY - startY;
                
                if (pullDistance > 0 && feedContainer.scrollTop === 0) {
                    e.preventDefault();
                    
                    if (pullDistance > 60) {
                        pullIndicator.classList.add('active');
                        pullIndicator.innerHTML = '<i class="fas fa-sync-alt mr-2"></i><span>Release to refresh</span>';
                    } else {
                        pullIndicator.classList.remove('active');
                        pullIndicator.innerHTML = '<i class="fas fa-arrow-down mr-2"></i><span>Pull to refresh</span>';
                    }
                    
                    feedContainer.style.transform = `translateY(${Math.min(pullDistance * 0.5, 30)}px)`;
                }
            }, { passive: false });
            
            feedContainer.addEventListener('touchend', () => {
                if (isPulling && pullDistance > 60) {
                    pullIndicator.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Refreshing...</span>';
                    
                    setTimeout(() => {
                        loadFeed();
                        pullIndicator.classList.remove('active');
                        pullIndicator.innerHTML = '<i class="fas fa-arrow-down mr-2"></i><span>Pull to refresh</span>';
                        feedContainer.style.transform = '';
                        showToast('Feed refreshed!', 'success');
                    }, 1000);
                } else {
                    pullIndicator.classList.remove('active');
                    feedContainer.style.transform = '';
                }
                
                isPulling = false;
                pullDistance = 0;
            }, { passive: true });
        }
        
        // Haptic feedback for mobile
        function hapticFeedback(type = 'light') {
            if (navigator.vibrate) {
                switch(type) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(20);
                        break;
                    case 'heavy':
                        navigator.vibrate([30, 10, 30]);
                        break;
                }
            }
        }
        
        // Enhanced mobile interactions
        function addMobileInteractions() {
            // Add haptic feedback to buttons
            document.querySelectorAll('.mobile-btn, .mobile-btn-primary').forEach(btn => {
                btn.addEventListener('touchstart', () => hapticFeedback('light'), { passive: true });
            });
            
            // Smooth scroll to top on nav tap
            document.getElementById('homeBtn').addEventListener('dblclick', () => {
                document.getElementById('feedContainer').scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                hapticFeedback('medium');
            });
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const value = e.target.value;
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (value.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        document.getElementById('postText').addEventListener('input', function(e) {
            updateCharacterCount();
            
            const text = e.target.value;
            const composer = document.getElementById('postComposer');
            
            if (text.length > 0) {
                composer.classList.add('focused');
                
                // Show typing indicator
                if (!isTyping) {
                    isTyping = true;
                    document.getElementById('typingIndicator').classList.remove('hidden');
                }
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    isTyping = false;
                    document.getElementById('typingIndicator').classList.add('hidden');
                }, 1000);
            } else {
                composer.classList.remove('focused');
            }
        });

        document.getElementById('postText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                createBuzz();
            }
        });

        document.getElementById('commentInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                postComment();
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#moodSelector') && !e.target.closest('[onclick="showMoodSelector()"]')) {
                document.getElementById('moodSelector').classList.add('hidden');
            }
            if (!e.target.closest('#privacySelector') && !e.target.closest('[onclick="showPrivacySelector()"]')) {
                document.getElementById('privacySelector').classList.add('hidden');
            }
        });

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                initializeUser();
                showMainApp();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Oriobuzz app initialized with Firestore integration');
            
            // Initialize mobile features
            initializePullToRefresh();
            addMobileInteractions();
            
            // Add viewport meta tag for better mobile experience
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
            }
            
            // Prevent zoom on input focus (iOS)
            document.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('focus', () => {
                    input.style.fontSize = '16px';
                });
                input.addEventListener('blur', () => {
                    input.style.fontSize = '';
                });
            });
            
            // Add safe area support
            if (CSS.supports('padding: env(safe-area-inset-top)')) {
                document.body.style.paddingTop = 'env(safe-area-inset-top)';
                document.body.style.paddingBottom = 'env(safe-area-inset-bottom)';
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96efdbd2857f598f',t:'MTc1NTE2ODI4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
