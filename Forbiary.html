<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forbiary - Professional Knowledge Platform</title>
    <meta name="description" content="Forbiary is a collaborative knowledge-sharing platform where users can create, edit, and moderate articles on various topics with Wikipedia-style functionality.">
    <meta name="keywords" content="knowledge sharing, wiki, articles, collaboration, education, research">
    <link rel="canonical" href="https://forbiary.com/">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Forbiary - Professional Knowledge Platform">
    <meta property="og:description" content="Collaborative knowledge-sharing platform with Wikipedia-style functionality">
    <meta property="og:url" content="https://forbiary.com/">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://forbiary.com/og-image.jpg">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Forbiary - Professional Knowledge Platform">
    <meta name="twitter:description" content="Collaborative knowledge-sharing platform with Wikipedia-style functionality">
    <meta name="twitter:image" content="https://forbiary.com/og-image.jpg">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Forbiary",
        "description": "Collaborative knowledge-sharing platform",
        "url": "https://forbiary.com/",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://forbiary.com/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Lato, Helvetica, Arial, sans-serif;
            background: #f6f6f6;
            margin: 0;
            padding: 0;
        }
        
        .wiki-header {
            background: #fff;
            border-bottom: 1px solid #a2a9b1;
            padding: 0;
        }
        
        .wiki-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #a2a9b1;
            padding: 8px 0;
        }
        
        .wiki-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .wiki-logo {
            font-size: 20px;
            font-weight: bold;
            color: #0645ad;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .wiki-search {
            flex: 1;
            max-width: 400px;
            margin: 0 15px;
            min-width: 200px;
        }
        
        .wiki-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .wiki-nav-links {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .wiki-nav-links a {
            color: #0645ad;
            text-decoration: none;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 2px;
            white-space: nowrap;
        }
        
        .wiki-nav-links a:hover {
            background: #eaecf0;
        }
        
        .wiki-content {
            background: #fff;
            margin: 15px auto;
            padding: 15px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            max-width: 1200px;
        }
        
        .wiki-article {
            line-height: 1.6;
            color: #222;
        }
        
        .wiki-article h1 {
            font-size: 28px;
            font-weight: normal;
            border-bottom: 3px solid #a2a9b1;
            padding-bottom: 8px;
            margin-bottom: 20px;
            color: #000;
        }
        
        .wiki-article h2 {
            font-size: 22px;
            font-weight: normal;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 4px;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        .wiki-article h3 {
            font-size: 18px;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        
        .wiki-infobox {
            width: 100%;
            max-width: 300px;
            margin: 0 0 20px 0;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .wiki-toc {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin: 20px 0;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        
        .wiki-edit-btn {
            background: #0645ad;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .wiki-edit-btn:hover {
            background: #0b0080;
        }
        
        .wiki-tabs {
            border-bottom: 1px solid #a2a9b1;
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .wiki-tab {
            display: inline-block;
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-bottom: none;
            cursor: pointer;
            margin-right: 2px;
            min-width: 120px;
            text-align: center;
        }
        
        .wiki-tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
        }
        
        .wiki-sidebar {
            width: 100%;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .wiki-main-content {
            width: 100%;
        }
        
        .edit-summary {
            width: 100%;
            padding: 8px;
            border: 1px solid #a2a9b1;
            margin: 10px 0;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .CodeMirror {
            border: 1px solid #a2a9b1;
            height: 300px;
        }
        
        .ql-editor {
            min-height: 300px;
            border: 1px solid #a2a9b1;
        }
        
        .pending-edit {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .moderator-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .edit-history {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            border-top: 1px solid #a2a9b1;
            padding-top: 15px;
        }
        
        .diff-added {
            background: #d4edda;
            color: #155724;
        }
        
        .diff-removed {
            background: #f8d7da;
            color: #721c24;
        }

        .category-card:hover > div {
            background: #eaecf0 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-left {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .mobile-menu {
            display: block;
            background: #0645ad;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 16px;
        }

        .nav-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border-top: 1px solid #a2a9b1;
            z-index: 1000;
        }

        .nav-dropdown.show {
            display: block;
        }

        .nav-dropdown .wiki-nav-links {
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 10px;
        }

        .nav-dropdown .wiki-nav-links a {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin: 20px 0;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 8px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
        }

        .search-select {
            padding: 8px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            min-width: 120px;
        }

        .internal-link {
            color: #0645ad;
            text-decoration: none;
            border-bottom: 1px dotted #0645ad;
        }

        .internal-link:hover {
            background: #f0f8ff;
        }

        .related-articles {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0645ad;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Desktop navigation styles */
        @media (min-width: 769px) {
            .mobile-menu {
                display: none;
            }
            
            .nav-dropdown {
                display: none !important;
            }
            
            #desktopNavLinks {
                display: flex;
            }
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #desktopNavLinks {
                display: none;
            }
            .wiki-container {
                padding: 0 10px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
            }

            .wiki-search {
                margin: 0;
                max-width: none;
                width: 100%;
            }

            .header-right {
                width: 100%;
                justify-content: center;
            }

            .mobile-menu {
                display: block;
            }

            .wiki-nav-links {
                display: none;
            }

            .wiki-nav {
                position: relative;
            }

            .wiki-content {
                margin: 10px;
                padding: 10px;
            }

            .wiki-article h1 {
                font-size: 24px;
            }

            .wiki-article h2 {
                font-size: 20px;
            }

            .wiki-article h3 {
                font-size: 16px;
            }

            .wiki-sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
                float: none;
            }

            .wiki-main-content {
                margin-left: 0;
            }

            .wiki-infobox {
                float: none;
                width: 100%;
                margin: 0 0 20px 0;
            }

            .wiki-toc {
                width: 100%;
                box-sizing: border-box;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-actions {
                justify-content: stretch;
            }

            .form-actions button {
                flex: 1;
                min-width: 0;
            }

            .edit-actions {
                justify-content: stretch;
            }

            .edit-actions button {
                flex: 1;
                min-width: 0;
            }

            .search-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: 0;
                width: 100%;
            }

            .search-select {
                min-width: 0;
                width: 100%;
            }

            .user-info {
                justify-content: center;
                text-align: center;
            }

            .user-info img {
                width: 28px !important;
                height: 28px !important;
            }

            .user-info span {
                font-size: 13px;
            }

            .CodeMirror {
                height: 250px;
            }

            .ql-editor {
                min-height: 250px;
            }

            .pending-edit {
                padding: 10px;
            }

            .article-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .wiki-edit-btn {
                margin: 2px;
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        /* Tablet Styles */
        @media (min-width: 769px) and (max-width: 1024px) {
            .wiki-container {
                padding: 0 15px;
            }

            .wiki-content {
                margin: 15px;
                padding: 15px;
            }

            .wiki-sidebar {
                width: 180px;
                padding: 12px;
            }

            .wiki-main-content {
                margin-left: 210px;
            }

            .wiki-infobox {
                width: 250px;
                margin: 0 0 15px 15px;
            }

            .form-grid {
                gap: 15px;
            }

            .search-input {
                min-width: 200px;
            }
        }

        /* Desktop Styles */
        @media (min-width: 1025px) {
            .wiki-container {
                padding: 0 20px;
            }

            .wiki-content {
                margin: 20px auto;
                padding: 20px;
            }

            .wiki-sidebar {
                width: 200px;
                padding: 15px;
                margin-right: 20px;
                float: left;
            }

            .wiki-main-content {
                margin-left: 240px;
            }

            .wiki-infobox {
                float: right;
                width: 300px;
                margin: 0 0 20px 20px;
            }

            .CodeMirror {
                height: 400px;
            }

            .ql-editor {
                min-height: 400px;
            }
        }

        /* Large Desktop Styles */
        @media (min-width: 1200px) {
            .wiki-article h1 {
                font-size: 32px;
            }

            .wiki-article h2 {
                font-size: 24px;
            }

            .wiki-article h3 {
                font-size: 20px;
            }
        }

        /* Profile Page Styles */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .profile-stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        /* Print Styles */
        @media print {
            .wiki-header,
            .wiki-nav,
            .wiki-sidebar,
            .wiki-edit-btn,
            .form-actions,
            .edit-actions {
                display: none !important;
            }

            .wiki-content {
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }

            .wiki-main-content {
                margin-left: 0;
            }

            body {
                background: white;
            }
        }
        /* Internal Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            width: 100%;
        }

        .notification {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #007bff;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            position: relative;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #28a745;
        }

        .notification.error {
            border-left-color: #dc3545;
        }

        .notification.warning {
            border-left-color: #ffc107;
        }

        .notification.info {
            border-left-color: #17a2b8;
        }

        .notification-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            color: #333;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
            font-size: 14px;
        }

        .notification-message {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            margin-right: 20px;
        }

        @media (max-width: 768px) {
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Internal Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
    <!-- Wikipedia-style Header -->
    <header class="wiki-header">
        <div class="wiki-container">
            <div class="header-content">
                <div class="header-left">
                    <a href="#" onclick="showHome()" class="wiki-logo">
                        <i class="fas fa-book-open" style="margin-right: 8px;"></i>Forbiary
                    </a>
                </div>
                <div class="wiki-search">
                    <input type="text" id="mainSearchInput" placeholder="Search Forbiary..." onkeypress="if(event.key==='Enter') searchFromHeader()">
                </div>
                <div class="header-right">
                    <div id="userInfoDesktop" style="display:none;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img id="userPhotoDesktop" style="width: 32px; height: 32px; border-radius: 50%;" src="" alt="">
                            <span id="userNameDesktop" style="font-size: 14px; color: #0645ad;"></span>
                            <span id="moderatorBadgeDesktop" class="moderator-badge" style="display:none;">Moderator</span>
                            <button onclick="signOut()" style="color: #d33; font-size: 14px; background: none; border: none; cursor: pointer; padding: 4px 8px; margin-left: 8px;">Sign Out</button>
                        </div>
                    </div>
                    <button onclick="signInWithGoogle()" id="loginBtnDesktop" class="wiki-edit-btn">
                        <i class="fab fa-google" style="margin-right: 5px;"></i>Sign In
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Wikipedia-style Navigation -->
    <nav class="wiki-nav">
        <div class="wiki-container">
            <button class="mobile-menu" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i> Menu
            </button>
            <div class="wiki-nav-links" id="desktopNavLinks">
                <a href="#" onclick="showHome()">Main page</a>
                <a href="#" onclick="showSearch()">Browse articles</a>
                <a href="#" onclick="showWrite()">Create article</a>
                <a href="#" onclick="showBecomeModerator()">Become moderator</a>
                <a href="#" onclick="showCategories()">Categories</a>
                <a href="#" onclick="showMyDrafts()" id="userSectionDesktop" style="display:none;">My Drafts</a>
                <a href="#" onclick="showProfile()" id="profileSectionDesktop" style="display:none;">My Profile</a>
                <a href="#" onclick="showModerate()" id="moderatorSectionDesktop1" style="display:none; color: #28a745;">Moderate Articles</a>
                <a href="#" onclick="showPendingEdits()" id="moderatorSectionDesktop2" style="display:none; color: #28a745;">Pending Edits</a>
            </div>
            <div class="nav-dropdown" id="mobileNavDropdown">
                <div class="wiki-nav-links">
                    <a href="#" onclick="showHome(); closeMobileMenu()">Main page</a>
                    <a href="#" onclick="showSearch(); closeMobileMenu()">Browse articles</a>
                    <a href="#" onclick="showWrite(); closeMobileMenu()">Create article</a>
                    <a href="#" onclick="showBecomeModerator(); closeMobileMenu()">Become moderator</a>
                    <a href="#" onclick="showCategories(); closeMobileMenu()">Categories</a>
                    <div style="border-top: 1px solid #ddd; margin: 10px 0; padding-top: 10px;" id="userSection" style="display:none;">
                        <a href="#" onclick="showMyDrafts(); closeMobileMenu()">My Drafts</a>
                        <a href="#" onclick="showProfile(); closeMobileMenu()">My Profile</a>
                    </div>
                    <div style="border-top: 1px solid #ddd; margin: 10px 0; padding-top: 10px;" id="moderatorSection" style="display:none;">
                        <a href="#" onclick="showModerate(); closeMobileMenu()" style="color: #28a745;">Moderate Articles</a>
                        <a href="#" onclick="showPendingEdits(); closeMobileMenu()" style="color: #28a745;">Pending Edits</a>
                    </div>
                    <div style="border-top: 1px solid #ddd; margin: 10px 0; padding-top: 10px;">
                        <div id="userInfoMobile" style="display:none; padding: 8px 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <img id="userPhotoMobile" style="width: 24px; height: 24px; border-radius: 50%;" src="" alt="">
                                <span id="userNameMobile" style="font-size: 14px; color: #0645ad;"></span>
                                <span id="moderatorBadgeMobile" class="moderator-badge" style="display:none;">Moderator</span>
                            </div>
                            <button onclick="signOut(); closeMobileMenu()" style="color: #d33; font-size: 14px; background: none; border: none; cursor: pointer; padding: 4px 0;">Sign Out</button>
                        </div>
                        <a href="#" onclick="signInWithGoogle(); closeMobileMenu()" id="loginBtnMobile">
                            <i class="fab fa-google" style="margin-right: 5px;"></i>Sign In
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Home Page -->
        <div id="homePage">
            <div class="wiki-content">
                <div class="wiki-sidebar">
                    <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #a2a9b1; padding-bottom: 5px;">Navigation</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showHome()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Main page</a></li>
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showSearch()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Browse articles</a></li>
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showWrite()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Create article</a></li>
                        <li style="margin-bottom: 8px;"><a href="#" onclick="showBecomeModerator()" style="color: #0645ad; text-decoration: none; font-size: 14px;">Become moderator</a></li>
                    </ul>
                    
                    <h3 style="font-size: 16px; font-weight: bold; margin: 20px 0 15px 0; border-bottom: 1px solid #a2a9b1; padding-bottom: 5px;">Categories</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Technology')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Technology</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Business')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Business</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Science')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Science</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('History')" style="color: #0645ad; text-decoration: none; font-size: 13px;">History</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Health')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Health</a></li>
                        <li style="margin-bottom: 5px;"><a href="#" onclick="filterByCategory('Education')" style="color: #0645ad; text-decoration: none; font-size: 13px;">Education</a></li>
                    </ul>
                </div>
                
                <div class="wiki-main-content">
                    <div class="wiki-article">
                        <h1>Welcome to Forbiary</h1>
                        <p><strong>Forbiary</strong> is a collaborative knowledge-sharing platform inspired by Wikipedia, where users can create, edit, and moderate articles on various topics. Anyone can contribute and become a moderator to help maintain quality content.</p>
                        
                        <div class="wiki-toc">
                            <strong>Contents</strong>
                            <ol style="margin: 10px 0 0 20px;">
                                <li><a href="#getting-started" style="color: #0645ad; text-decoration: none;">Getting Started</a></li>
                                <li><a href="#recent-articles" style="color: #0645ad; text-decoration: none;">Recent Articles</a></li>
                                <li><a href="#how-to-contribute" style="color: #0645ad; text-decoration: none;">How to Contribute</a></li>
                                <li><a href="#moderation" style="color: #0645ad; text-decoration: none;">Moderation System</a></li>
                            </ol>
                        </div>
                        
                        <h2 id="getting-started">Getting Started</h2>
                        <p>To start contributing to Forbiary, you need to sign in with your Google account. Once signed in, you can:</p>
                        <ul>
                            <li>Create new articles on any topic</li>
                            <li>Edit existing articles to improve them</li>
                            <li>Apply to become a moderator</li>
                            <li>Review and approve edits from other users</li>
                        </ul>
                        
                        <h2 id="recent-articles">Recent Articles</h2>
                        <div id="recentArticles" style="margin: 20px 0;">
                            <!-- Recent articles will be loaded here -->
                        </div>
                        
                        <h2 id="how-to-contribute">How to Contribute</h2>
                        <p>Contributing to Forbiary is easy and open to everyone:</p>
                        <ol>
                            <li><strong>Sign in</strong> with your Google account</li>
                            <li><strong>Create</strong> new articles or <strong>edit</strong> existing ones</li>
                            <li><strong>Submit</strong> your changes for review</li>
                            <li><strong>Moderators</strong> will review and approve quality content</li>
                        </ol>
                        
                        <h2 id="moderation">Moderation System</h2>
                        <p>Forbiary uses a community-driven moderation system where any user can apply to become a moderator. Moderators help maintain quality by reviewing article edits and ensuring content meets our standards.</p>
                        
                        <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; margin: 20px 0;">
                            <strong>Quick Actions:</strong><br>
                            <a href="#" onclick="showSearch()" style="color: #0645ad; margin-right: 15px;">Browse Articles</a>
                            <a href="#" onclick="showWrite()" style="color: #0645ad; margin-right: 15px;">Create Article</a>
                            <a href="#" onclick="showBecomeModerator()" style="color: #0645ad;">Become Moderator</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="searchPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Browse Articles</h1>
                    <div class="search-controls">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by title, tags, or content...">
                        <select id="categoryFilter" class="search-select">
                            <option value="">All Categories</option>
                            <option value="Technology">Technology</option>
                            <option value="Business">Business</option>
                            <option value="Science">Science</option>
                            <option value="History">History</option>
                            <option value="Health">Health</option>
                            <option value="Education">Education</option>
                        </select>
                        <button onclick="searchArticles()" class="wiki-edit-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="searchResults">
                        <!-- Search results will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Become Moderator Page -->
        <div id="becomeModeratorPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Become a Moderator</h1>
                    <p>Moderators help maintain the quality of Forbiary by reviewing article edits and ensuring content meets our community standards.</p>
                    
                    <h2>Requirements</h2>
                    <ul>
                        <li>Active Google account</li>
                        <li>Understanding of community guidelines</li>
                        <li>Commitment to fair and unbiased moderation</li>
                    </ul>
                    
                    <h2>Responsibilities</h2>
                    <ul>
                        <li>Review pending article edits</li>
                        <li>Approve or reject changes based on quality</li>
                        <li>Help maintain community standards</li>
                        <li>Assist other users when needed</li>
                    </ul>
                    
                    <div id="moderatorApplication" style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; margin: 20px 0;">
                        <h3>Apply to Become a Moderator</h3>
                        <p>Fill out the form below to become a moderator instantly:</p>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Why do you want to become a moderator?</label>
                            <textarea id="moderatorReason" rows="4" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="Explain why you want to help moderate content on Forbiary..."></textarea>
                        </div>
                        <button onclick="applyForModerator()" class="wiki-edit-btn" style="background: #28a745;">
                            <i class="fas fa-user-shield"></i> Become Moderator
                        </button>
                        <div id="applicationStatus" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Page -->
        <div id="categoriesPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Categories</h1>
                    <p>Browse articles by category to find content that interests you.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div class="category-card" onclick="filterByCategory('Technology')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-microchip" style="margin-right: 8px;"></i>Technology
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Articles about software, hardware, AI, and digital innovations</p>
                                <div id="techCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Business')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-briefcase" style="margin-right: 8px;"></i>Business
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Entrepreneurship, finance, management, and business strategies</p>
                                <div id="businessCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Science')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-flask" style="margin-right: 8px;"></i>Science
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Research, discoveries, and scientific breakthroughs</p>
                                <div id="scienceCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('History')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-landmark" style="margin-right: 8px;"></i>History
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Historical events, figures, and cultural heritage</p>
                                <div id="historyCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Health')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-heartbeat" style="margin-right: 8px;"></i>Health
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Medical research, wellness, and healthcare topics</p>
                                <div id="healthCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="filterByCategory('Education')">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 10px 0; color: #0645ad; font-size: 18px;">
                                    <i class="fas fa-graduation-cap" style="margin-right: 8px;"></i>Education
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 14px;">Learning resources, academic research, and educational methods</p>
                                <div id="educationCount" style="margin-top: 10px; font-size: 12px; color: #999;">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Edits Page -->
        <div id="pendingEditsPage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Pending Edits</h1>
                    <p>Review and approve edits submitted by community members.</p>
                    <div id="pendingEditsList">
                        <!-- Pending edits will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- User Profile Page -->
        <div id="profilePage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>User Profile</h1>
                    <div id="profileContent">
                        <!-- Profile content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Write/Edit Article Page -->
        <div id="writePage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1 id="writePageTitle">Create New Article</h1>
                    
                    <div class="wiki-tabs">
                        <div class="wiki-tab active" onclick="switchEditMode('visual')" id="visualTab">Visual Editor</div>
                        <div class="wiki-tab" onclick="switchEditMode('code')" id="codeTab">Source Code</div>
                    </div>
                    
                    <form id="articleForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Article Title</label>
                            <input type="text" id="articleTitle" required style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="Enter article title">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Summary</label>
                            <textarea id="articleSummary" required rows="3" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="Brief summary of the article"></textarea>
                        </div>

                        <div class="form-grid">
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Category</label>
                                <select id="articleCategory" required style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px; box-sizing: border-box;">
                                    <option value="">Select Category</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Business">Business</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Health">Health</option>
                                    <option value="Education">Education</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tags</label>
                                <input type="text" id="articleTags" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px; box-sizing: border-box;" placeholder="Comma-separated tags">
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">References</label>
                            <textarea id="articleReferences" rows="3" style="width: 100%; padding: 8px; border: 1px solid #a2a9b1; border-radius: 2px;" placeholder="URLs, books, or other sources (one per line)"></textarea>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Article Content</label>
                            <div id="visualEditor" style="display: block;">
                                <div id="editor"></div>
                            </div>
                            <div id="codeEditor" style="display: none;">
                                <textarea id="codeTextarea" style="width: 100%; height: 400px; font-family: monospace; padding: 10px; border: 1px solid #a2a9b1;"></textarea>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Edit Summary</label>
                            <input type="text" id="editSummary" class="edit-summary" placeholder="Briefly describe your changes..." style="width: 100%;">
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="showHome()" style="padding: 8px 16px; border: 1px solid #a2a9b1; background: #f8f9fa; border-radius: 2px; cursor: pointer;">Cancel</button>
                            <button type="button" onclick="previewArticle()" style="padding: 8px 16px; border: 1px solid #a2a9b1; background: #f8f9fa; border-radius: 2px; cursor: pointer;">Preview</button>
                            <button type="submit" class="wiki-edit-btn">
                                <i class="fas fa-save"></i> <span id="submitButtonText">Submit for Review</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Moderate Page -->
        <div id="moderatePage" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <h1>Article Moderation</h1>
                    <p>Review recent articles and suggest improvements or deletions if content is inappropriate or false.</p>
                    
                    <div class="wiki-tabs">
                        <div class="wiki-tab active" onclick="switchModeratorTab('recent')" id="recentTab">Recent Articles</div>
                        <div class="wiki-tab" onclick="switchModeratorTab('notifications')" id="notificationsTab">Notifications <span id="notificationBadge" style="background: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; margin-left: 5px; display: none;"></span></div>
                        <div class="wiki-tab" onclick="switchModeratorTab('suggestions')" id="suggestionsTab">My Suggestions</div>
                    </div>
                    
                    <div id="recentArticlesTab" style="display: block;">
                        <div id="recentArticlesList">
                            <!-- Recent articles will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="notificationsTab" style="display: none;">
                        <div id="moderatorNotifications">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="suggestionsTab" style="display: none;">
                        <div id="moderatorSuggestions">
                            <!-- Moderator suggestions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Article Reader -->
        <div id="articleReader" style="display:none;">
            <div class="wiki-content">
                <div class="wiki-article">
                    <div id="articleContent">
                        <!-- Article content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebase Configuration - Real Firebase Database
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "auth.oriontec.xyz",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:7248a0983dcf0d45a87418",
            measurementId: "G-5RFLRYTLCN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const realtimeDb = firebase.database();

        // Internal Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Information'
            };

            notification.innerHTML = `
                <button class="notification-close" onclick="closeNotification(this)">&times;</button>
                <div class="notification-title">${titles[type] || 'Notification'}</div>
                <div class="notification-message">${message}</div>
            `;

            container.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(notification.querySelector('.notification-close'));
                }, duration);
            }
        }

        function closeNotification(closeBtn) {
            const notification = closeBtn.parentElement;
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 300);
        }

        // Initialize Quill Editor
        let quill;
        
        // Current user and admin status
        let currentUser = null;
        let isAdmin = false;
        let isModerator = false;
        let currentEditingArticleId = null;
        let currentEditMode = 'visual';
        
        // SEO and metadata management
        let siteArticles = new Map(); // Cache for internal linking
        let relatedArticles = new Map(); // Related articles cache

        // Admin emails (you can modify this list)
        const adminEmails = ['admin@forbiary.com', 'moderator@forbiary.com'];

        // Mobile menu functions
        function toggleMobileMenu() {
            const dropdown = document.getElementById('mobileNavDropdown');
            dropdown.classList.toggle('show');
        }

        function closeMobileMenu() {
            const dropdown = document.getElementById('mobileNavDropdown');
            dropdown.classList.remove('show');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('mobileNavDropdown');
            const menuButton = document.querySelector('.mobile-menu');
            
            if (!dropdown.contains(event.target) && !menuButton.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                // Mobile UI
                document.getElementById('loginBtnMobile').style.display = 'none';
                document.getElementById('userInfoMobile').style.display = 'block';
                document.getElementById('userNameMobile').textContent = user.displayName;
                document.getElementById('userPhotoMobile').src = user.photoURL;
                
                // Desktop UI
                document.getElementById('loginBtnDesktop').style.display = 'none';
                document.getElementById('userInfoDesktop').style.display = 'block';
                document.getElementById('userNameDesktop').textContent = user.displayName;
                document.getElementById('userPhotoDesktop').src = user.photoURL;

                // Show user sections
                document.getElementById('userSection').style.display = 'block';
                document.getElementById('userSectionDesktop').style.display = 'inline-block';
                document.getElementById('profileSectionDesktop').style.display = 'inline-block';

                // Check if user is admin or moderator
                isAdmin = adminEmails.includes(user.email);
                await checkModeratorStatus();
                
                if (isAdmin || isModerator) {
                    // Mobile moderator UI
                    document.getElementById('moderatorSection').style.display = 'block';
                    document.getElementById('moderatorBadgeMobile').style.display = 'inline-block';
                    
                    // Desktop moderator UI
                    document.getElementById('moderatorSectionDesktop1').style.display = 'inline-block';
                    document.getElementById('moderatorSectionDesktop2').style.display = 'inline-block';
                    document.getElementById('moderatorBadgeDesktop').style.display = 'inline-block';
                }

                // Initialize editor if on write page
                if (document.getElementById('writePage').style.display !== 'none') {
                    setTimeout(() => initializeEditor(), 100);
                }
            } else {
                currentUser = null;
                isAdmin = false;
                isModerator = false;
                
                // Mobile UI
                document.getElementById('loginBtnMobile').style.display = 'block';
                document.getElementById('userInfoMobile').style.display = 'none';
                document.getElementById('userSection').style.display = 'none';
                document.getElementById('moderatorSection').style.display = 'none';
                document.getElementById('moderatorBadgeMobile').style.display = 'none';
                
                // Desktop UI
                document.getElementById('loginBtnDesktop').style.display = 'block';
                document.getElementById('userInfoDesktop').style.display = 'none';
                document.getElementById('userSectionDesktop').style.display = 'none';
                document.getElementById('profileSectionDesktop').style.display = 'none';
                document.getElementById('moderatorSectionDesktop1').style.display = 'none';
                document.getElementById('moderatorSectionDesktop2').style.display = 'none';
                document.getElementById('moderatorBadgeDesktop').style.display = 'none';
            }
        });

        // Sign in with Google
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                showNotification('🎉 Welcome to Forbiary! You are now signed in.', 'success');
            } catch (error) {
                showNotification('Sign in failed: ' + error.message, 'error');
            }
        }

        // Sign out
        async function signOut() {
            try {
                await auth.signOut();
                showNotification('You have been signed out successfully', 'info');
            } catch (error) {
                showNotification('Sign out failed: ' + error.message, 'error');
            }
        }

        // Navigation functions
        function showHome() {
            hideAllPages();
            document.getElementById('homePage').style.display = 'block';
            loadRecentArticles();
            updatePageMetadata('Forbiary - Professional Knowledge Platform', 'Collaborative knowledge-sharing platform where users can create, edit, and moderate articles on various topics with Wikipedia-style functionality.');
            window.location.hash = '';
        }

        function showSearch() {
            hideAllPages();
            document.getElementById('searchPage').style.display = 'block';
            loadAllArticles();
            updatePageMetadata('Browse Articles - Forbiary', 'Search and browse all articles on Forbiary knowledge platform.');
        }

        // Show drafts for current user
        function showMyDrafts() {
            if (!currentUser) {
                showNotification('Please sign in to view your drafts', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('searchPage').style.display = 'block';
            document.getElementById('searchPage').querySelector('h1').textContent = 'My Drafts';
            loadUserDrafts();
            updatePageMetadata('My Drafts - Forbiary', 'View your draft articles on Forbiary.');
        }

        // Load user drafts
        async function loadUserDrafts() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('articles')
                    .where('uid', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();

                const container = document.getElementById('searchResults');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No drafts found. <a href="#" onclick="showWrite()" style="color: #0645ad;">Create your first article</a></p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const article = doc.data();
                    const draftCard = createDraftCard(doc.id, article);
                    container.appendChild(draftCard);
                });
            } catch (error) {
                console.error('Error loading drafts:', error);
            }
        }

        // Create draft card
        function createDraftCard(id, article) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-bottom: 15px;';

            const date = article.timestamp ? new Date(article.timestamp.toDate ? article.timestamp.toDate() : article.timestamp).toLocaleDateString() : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">${article.title}</h3>
                        <p style="margin: 0 0 8px 0; color: #666; line-height: 1.4;">${article.summary}</p>
                        <div style="font-size: 14px; color: #666;">
                            <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 8px;">${article.category}</span>
                            <span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 8px;">DRAFT</span>
                            Created ${date}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="showWrite('${id}')" class="wiki-edit-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="viewDraft('${id}')" class="wiki-edit-btn" style="background: #6c757d;">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button onclick="deleteDraft('${id}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // View draft
        async function viewDraft(articleId) {
            try {
                const doc = await db.collection('articles').doc(articleId).get();
                
                if (!doc.exists) {
                    showNotification('Draft not found', 'error');
                    return;
                }

                const article = doc.data();
                
                if (article.status !== 'pending') {
                    showNotification('This is not a draft', 'warning');
                    return;
                }

                // Check if user owns this draft
                if (currentUser && article.uid !== currentUser.uid && !isAdmin && !isModerator) {
                    showNotification('You can only view your own drafts', 'warning');
                    return;
                }

                hideAllPages();
                document.getElementById('articleReader').style.display = 'block';
                
                const date = article.timestamp ? new Date(article.timestamp.toDate ? article.timestamp.toDate() : article.timestamp).toLocaleDateString() : 'Recently';
                const tagsHtml = article.tags.map(tag => 
                    `<span class="inline-block bg-gray-100 text-gray-800 text-sm px-3 py-1 rounded-full mr-2">${tag}</span>`
                ).join('');

                document.getElementById('articleContent').innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #856404;"><i class="fas fa-exclamation-triangle"></i> Draft Preview</h3>
                        <p style="margin: 0; color: #856404;">This article is currently in draft status and pending moderator approval.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div class="article-meta">
                            <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-size: 14px;">${article.category}</span>
                            <span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 3px; font-size: 14px; margin-left: 8px;">DRAFT</span>
                        </div>
                        <h1>${article.title}</h1>
                        <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                            By <strong>${article.author}</strong> • ${date}
                        </div>
                        <p style="font-size: 16px; color: #333; margin-bottom: 20px; font-style: italic;">${article.summary}</p>
                        <div style="margin-bottom: 20px;">${tagsHtml}</div>
                    </div>
                    
                    <div style="line-height: 1.6; margin-bottom: 30px;">
                        ${article.content}
                    </div>
                    
                    <div class="edit-actions" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #a2a9b1;">
                        <button onclick="showMyDrafts()" class="wiki-edit-btn">
                            <i class="fas fa-arrow-left"></i> Back to Drafts
                        </button>
                        <button onclick="showWrite('${articleId}')" class="wiki-edit-btn">
                            <i class="fas fa-edit"></i> Edit Draft
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading draft:', error);
                showNotification('Error loading draft', 'error');
            }
        }

        // Delete draft with internal confirmation
        async function deleteDraft(articleId) {
            if (!currentUser) return;
            
            // Create custom confirmation dialog
            const confirmDelete = await showConfirmDialog(
                'Delete Draft', 
                'Are you sure you want to delete this draft? This action cannot be undone.',
                'Delete',
                'Cancel'
            );
            
            if (confirmDelete) {
                try {
                    // Check ownership
                    const doc = await db.collection('articles').doc(articleId).get();
                    if (doc.exists) {
                        const article = doc.data();
                        if (article.uid !== currentUser.uid && !isAdmin && !isModerator) {
                            showNotification('You can only delete your own drafts', 'warning');
                            return;
                        }
                    }

                    // Remove from localStorage
                    localStorage.removeItem(`articles_${articleId}`);
                    
                    // Update collection
                    const collectionData = JSON.parse(localStorage.getItem('collection_articles') || '[]');
                    const updatedCollection = collectionData.filter(item => item.id !== articleId);
                    localStorage.setItem('collection_articles', JSON.stringify(updatedCollection));
                    
                    showNotification('Draft deleted successfully', 'success');
                    loadUserDrafts();
                } catch (error) {
                    showNotification('Error deleting draft: ' + error.message, 'error');
                }
            }
        }

        // Custom confirmation dialog
        function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    border-radius: 8px;
                    padding: 24px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    animation: dialogIn 0.2s ease-out;
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333;">${title}</h3>
                    <p style="margin: 0 0 24px 0; color: #666; line-height: 1.5;">${message}</p>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="cancelBtn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; cursor: pointer;">${cancelText}</button>
                        <button id="confirmBtn" style="padding: 8px 16px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">${confirmText}</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Add animation styles
                const dialogStyle = document.createElement('style');
                dialogStyle.textContent = `
                    @keyframes dialogIn {
                        from { transform: scale(0.9); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(dialogStyle);
                
                // Handle buttons
                dialog.querySelector('#confirmBtn').onclick = () => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(dialogStyle);
                    resolve(true);
                };
                
                dialog.querySelector('#cancelBtn').onclick = () => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(dialogStyle);
                    resolve(false);
                };
                
                // Handle overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        document.head.removeChild(dialogStyle);
                        resolve(false);
                    }
                };
            });
        }

        async function showWrite(articleId = null) {
            if (articleId) {
                // For editing existing articles - check if article is locked
                try {
                    const doc = await db.collection('articles').doc(articleId).get();
                    if (doc.exists && doc.data().locked) {
                        showNotification('This article is locked and cannot be edited', 'warning');
                        showHome();
                        return;
                    }
                } catch (error) {
                    console.error('Error checking article lock status:', error);
                }

                hideAllPages();
                document.getElementById('writePage').style.display = 'block';
                currentEditingArticleId = articleId;
                document.getElementById('writePageTitle').textContent = 'Edit Article';
                document.getElementById('submitButtonText').textContent = 'Submit Edit';
                updatePageMetadata('Edit Article - Forbiary', 'Edit an existing article on Forbiary knowledge platform.');
                
                // Initialize editor first, then load content
                setTimeout(() => {
                    initializeEditor();
                    setTimeout(() => loadArticleForEditing(articleId), 300);
                }, 100);
            } else {
                // For creating new articles - check if user is signed in
                if (!currentUser) {
                    showNotification('Please sign in to create articles', 'warning');
                    return;
                }
                
                hideAllPages();
                document.getElementById('writePage').style.display = 'block';
                currentEditingArticleId = null;
                document.getElementById('writePageTitle').textContent = 'Create New Article';
                document.getElementById('submitButtonText').textContent = 'Submit for Review';
                updatePageMetadata('Create Article - Forbiary', 'Create a new article on Forbiary knowledge platform.');
                clearForm();
                setTimeout(() => initializeEditor(), 100);
            }
        }

        function showModerate() {
            if (!currentUser || (!isAdmin && !isModerator)) {
                showNotification('Access denied. Moderator privileges required', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('moderatePage').style.display = 'block';
            loadRecentArticlesForModerators();
            updatePageMetadata('Moderate Articles - Forbiary', 'Review and moderate recent articles on Forbiary.');
        }

        function showBecomeModerator() {
            hideAllPages();
            document.getElementById('becomeModeratorPage').style.display = 'block';
            updatePageMetadata('Become Moderator - Forbiary', 'Apply to become a moderator on Forbiary knowledge platform.');
        }

        function showCategories() {
            hideAllPages();
            document.getElementById('categoriesPage').style.display = 'block';
            loadCategoryCounts();
            updatePageMetadata('Categories - Forbiary', 'Browse articles by category on Forbiary knowledge platform.');
        }

        function showPendingEdits() {
            if (!currentUser || (!isAdmin && !isModerator)) {
                showNotification('Access denied. Moderator privileges required', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('pendingEditsPage').style.display = 'block';
            loadPendingEdits();
            updatePageMetadata('Pending Edits - Forbiary', 'Review pending edits on Forbiary knowledge platform.');
        }

        function showProfile() {
            if (!currentUser) {
                showNotification('Please sign in to view your profile', 'warning');
                return;
            }
            hideAllPages();
            document.getElementById('profilePage').style.display = 'block';
            loadUserProfile();
            updatePageMetadata('My Profile - Forbiary', 'View your profile and contribution statistics on Forbiary.');
        }

        function hideAllPages() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('searchPage').style.display = 'none';
            document.getElementById('writePage').style.display = 'none';
            document.getElementById('moderatePage').style.display = 'none';
            document.getElementById('articleReader').style.display = 'none';
            document.getElementById('becomeModeratorPage').style.display = 'none';
            document.getElementById('categoriesPage').style.display = 'none';
            document.getElementById('pendingEditsPage').style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';
        }

        // Initialize Quill editor with enhanced toolbar
        function initializeEditor() {
            if (quill) {
                quill.setContents([]);
                return;
            }
            
            // Wait for DOM to be ready
            setTimeout(() => {
                const editorElement = document.getElementById('editor');
                if (editorElement) {
                    quill = new Quill('#editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                [{ 'font': ['serif', 'monospace', 'arial', 'times-new-roman', 'helvetica'] }],
                                [{ 'size': ['small', false, 'large', 'huge'] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'script': 'sub'}, { 'script': 'super' }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'direction': 'rtl' }],
                                [{ 'align': [] }],
                                ['link'],
                                ['blockquote', 'code-block'],
                                ['formula'],
                                ['clean']
                            ]
                        },
                        placeholder: 'Write your article content here... Use [[Article Name]] for internal links',
                        formats: ['header', 'font', 'size', 'bold', 'italic', 'underline', 'strike', 'color', 'background', 'script', 'list', 'bullet', 'indent', 'direction', 'align', 'link', 'image', 'video', 'blockquote', 'code-block', 'formula']
                    });

                    // Add internal linking functionality
                    quill.on('text-change', function(delta, oldDelta, source) {
                        if (source === 'user') {
                            detectInternalLinks();
                        }
                    });

                    // Add custom toolbar buttons
                    const toolbar = quill.getModule('toolbar');
                    
                    // Add internal link button
                    const internalLinkBtn = document.createElement('button');
                    internalLinkBtn.innerHTML = '<i class="fas fa-link"></i> Internal Link';
                    internalLinkBtn.onclick = () => insertInternalLink();
                    internalLinkBtn.style.cssText = 'margin-left: 10px; padding: 5px 10px; background: #0645ad; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;';
                    
                    const toolbarContainer = document.querySelector('.ql-toolbar');
                    if (toolbarContainer) {
                        toolbarContainer.appendChild(internalLinkBtn);
                    }
                }
            }, 100);
        }

        // Insert internal link
        function insertInternalLink() {
            const range = quill.getSelection();
            if (range) {
                const text = prompt('Enter article title to link to:');
                if (text) {
                    quill.insertText(range.index, `[[${text}]]`, 'user');
                }
            }
        }

        // Switch moderator tabs
        function switchModeratorTab(tab) {
            // Hide all tabs
            document.getElementById('recentArticlesTab').style.display = 'none';
            document.getElementById('notificationsTab').style.display = 'none';
            document.getElementById('suggestionsTab').style.display = 'none';
            
            // Remove active class from all tabs
            document.getElementById('recentTab').classList.remove('active');
            document.getElementById('notificationsTab').classList.remove('active');
            document.getElementById('suggestionsTab').classList.remove('active');
            
            // Show selected tab and mark as active
            if (tab === 'recent') {
                document.getElementById('recentArticlesTab').style.display = 'block';
                document.getElementById('recentTab').classList.add('active');
                loadRecentArticlesForModerators();
            } else if (tab === 'notifications') {
                document.getElementById('notificationsTab').style.display = 'block';
                document.getElementById('notificationsTab').classList.add('active');
                loadModeratorNotifications();
            } else if (tab === 'suggestions') {
                document.getElementById('suggestionsTab').style.display = 'block';
                document.getElementById('suggestionsTab').classList.add('active');
                loadModeratorSuggestions();
            }
        }

        // Switch between visual and code editing modes
        function switchEditMode(mode) {
            currentEditMode = mode;
            
            if (mode === 'visual') {
                document.getElementById('visualTab').classList.add('active');
                document.getElementById('codeTab').classList.remove('active');
                document.getElementById('visualEditor').style.display = 'block';
                document.getElementById('codeEditor').style.display = 'none';
                
                // Sync content from code to visual
                const codeContent = document.getElementById('codeTextarea').value;
                if (codeContent && quill) {
                    quill.root.innerHTML = codeContent;
                }
            } else {
                document.getElementById('visualTab').classList.remove('active');
                document.getElementById('codeTab').classList.add('active');
                document.getElementById('visualEditor').style.display = 'none';
                document.getElementById('codeEditor').style.display = 'block';
                
                // Sync content from visual to code
                if (quill) {
                    document.getElementById('codeTextarea').value = quill.root.innerHTML;
                }
            }
        }

        // Check if user is a moderator
        async function checkModeratorStatus() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('moderators').doc(currentUser.uid).get();
                isModerator = doc.exists && doc.data().status === 'approved';
            } catch (error) {
                console.error('Error checking moderator status:', error);
            }
        }

        // Apply to become a moderator
        async function applyForModerator() {
            if (!currentUser) {
                showNotification('Please sign in first', 'warning');
                return;
            }

            const reason = document.getElementById('moderatorReason').value;
            if (!reason.trim()) {
                showNotification('Please provide a reason for becoming a moderator', 'warning');
                return;
            }

            try {
                showNotification('Processing your moderator application...', 'info', 2000);
                
                await db.collection('moderators').doc(currentUser.uid).set({
                    email: currentUser.email,
                    name: currentUser.displayName,
                    reason: reason,
                    appliedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'approved' // Auto-approve as requested
                });

                isModerator = true;
                document.getElementById('moderatorSection').style.display = 'block';
                document.getElementById('moderatorBadgeMobile').style.display = 'inline-block';
                document.getElementById('moderatorSectionDesktop1').style.display = 'inline-block';
                document.getElementById('moderatorSectionDesktop2').style.display = 'inline-block';
                document.getElementById('moderatorBadgeDesktop').style.display = 'inline-block';
                
                document.getElementById('applicationStatus').innerHTML = '<div style="color: #28a745; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin-top: 15px;"><i class="fas fa-check-circle"></i> You are now a moderator! You can now moderate articles and lock/unlock them.</div>';
                
                showNotification('Congratulations! You are now a moderator', 'success');
            } catch (error) {
                showNotification('Error applying for moderator: ' + error.message, 'error');
            }
        }

        // Clear form
        function clearForm() {
            try {
                const titleElement = document.getElementById('articleTitle');
                const summaryElement = document.getElementById('articleSummary');
                const categoryElement = document.getElementById('articleCategory');
                const tagsElement = document.getElementById('articleTags');
                const referencesElement = document.getElementById('articleReferences');
                const editSummaryElement = document.getElementById('editSummary');
                const codeTextareaElement = document.getElementById('codeTextarea');

                if (titleElement) titleElement.value = '';
                if (summaryElement) summaryElement.value = '';
                if (categoryElement) categoryElement.value = '';
                if (tagsElement) tagsElement.value = '';
                if (referencesElement) referencesElement.value = '';
                if (editSummaryElement) editSummaryElement.value = '';
                if (codeTextareaElement) codeTextareaElement.value = '';
                
                if (quill && quill.setContents) {
                    try {
                        quill.setContents([]);
                    } catch (quillError) {
                        console.warn('Error clearing Quill editor:', quillError);
                    }
                }
            } catch (error) {
                console.error('Error clearing form:', error);
            }
        }

        // Load article for editing
        async function loadArticleForEditing(articleId) {
            try {
                const doc = await db.collection('articles').doc(articleId).get();
                if (!doc.exists) {
                    alert('Article not found');
                    return;
                }
                
                const article = doc.data();
                
                // Safely populate form fields
                const titleElement = document.getElementById('articleTitle');
                const summaryElement = document.getElementById('articleSummary');
                const categoryElement = document.getElementById('articleCategory');
                const tagsElement = document.getElementById('articleTags');
                const referencesElement = document.getElementById('articleReferences');
                const codeTextareaElement = document.getElementById('codeTextarea');

                if (titleElement) titleElement.value = article.title || '';
                if (summaryElement) summaryElement.value = article.summary || '';
                if (categoryElement) categoryElement.value = article.category || '';
                if (tagsElement) tagsElement.value = (article.tags || []).join(', ');
                if (referencesElement) referencesElement.value = (article.references || []).join('\n');
                if (codeTextareaElement) codeTextareaElement.value = article.content || '';
                
                // Safely populate Quill editor
                if (quill && quill.root) {
                    try {
                        quill.root.innerHTML = article.content || '';
                    } catch (quillError) {
                        console.warn('Error loading content into Quill editor:', quillError);
                        if (codeTextareaElement) codeTextareaElement.value = article.content || '';
                    }
                }
                
            } catch (error) {
                console.error('Error loading article for editing:', error);
                alert('Error loading article for editing: ' + (error.message || 'Unknown error'));
            }
        }

        // Preview article
        function previewArticle() {
            const title = document.getElementById('articleTitle').value;
            const summary = document.getElementById('articleSummary').value;
            const content = currentEditMode === 'visual' ? quill.root.innerHTML : document.getElementById('codeTextarea').value;
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>Preview: ${title}</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        h1 { border-bottom: 3px solid #a2a9b1; padding-bottom: 8px; }
                        h2 { border-bottom: 1px solid #a2a9b1; padding-bottom: 4px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p><strong>Summary:</strong> ${summary}</p>
                    <hr>
                    ${content}
                </body>
                </html>
            `);
        }

        // Search from header
        function searchFromHeader() {
            const searchTerm = document.getElementById('mainSearchInput').value;
            document.getElementById('searchInput').value = searchTerm;
            showSearch();
            searchArticles();
        }

        // Filter by category
        function filterByCategory(category) {
            document.getElementById('categoryFilter').value = category;
            showSearch();
            searchArticles();
        }

        // Get user IP address (simplified for demo)
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        // Check if IP is banned
        async function checkIPBan(ip) {
            try {
                const doc = await db.collection('bannedIPs').doc(ip).get();
                if (doc.exists) {
                    const banData = doc.data();
                    const banExpiry = banData.expiresAt.toDate();
                    return new Date() < banExpiry;
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        // Ban IP address
        async function banIP(ip, reason = 'False information') {
            if (!isAdmin && !isModerator) return;
            
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 5); // 5 months ban
            
            try {
                await db.collection('bannedIPs').doc(ip).set({
                    reason: reason,
                    bannedBy: currentUser.displayName,
                    bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: firebase.firestore.Timestamp.fromDate(expiryDate)
                });
                
                alert(`IP ${ip} has been banned for 5 months.`);
            } catch (error) {
                console.error('Error banning IP:', error);
            }
        }

        // Update page metadata for SEO
        function updatePageMetadata(title, description, keywords = '', canonicalUrl = '') {
            // Update title
            document.title = title;
            
            // Update meta description
            let metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.setAttribute('content', description);
            }
            
            // Update keywords if provided
            if (keywords) {
                let metaKeywords = document.querySelector('meta[name="keywords"]');
                if (!metaKeywords) {
                    metaKeywords = document.createElement('meta');
                    metaKeywords.setAttribute('name', 'keywords');
                    document.head.appendChild(metaKeywords);
                }
                metaKeywords.setAttribute('content', keywords);
            }
            
            // Update canonical URL
            let canonical = document.querySelector('link[rel="canonical"]');
            if (canonical) {
                canonical.setAttribute('href', canonicalUrl || window.location.href);
            }
            
            // Update Open Graph tags
            updateOpenGraphTags(title, description, canonicalUrl || window.location.href);
        }

        // Update Open Graph tags
        function updateOpenGraphTags(title, description, url) {
            const ogTags = [
                { property: 'og:title', content: title },
                { property: 'og:description', content: description },
                { property: 'og:url', content: url },
                { property: 'og:type', content: 'article' }
            ];
            
            ogTags.forEach(tag => {
                let ogTag = document.querySelector(`meta[property="${tag.property}"]`);
                if (ogTag) {
                    ogTag.setAttribute('content', tag.content);
                }
            });
        }

        // Generate SEO keywords automatically
        function generateSEOKeywords(title, summary, content, tags) {
            const commonWords = ['the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'this', 'that', 'these', 'those', 'a', 'an'];
            
            // Extract text from HTML content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            // Combine all text sources
            const allText = `${title} ${summary} ${textContent}`.toLowerCase();
            
            // Extract meaningful words
            const words = allText.match(/\b[a-zA-Z]{3,}\b/g) || [];
            const wordFreq = {};
            
            words.forEach(word => {
                if (!commonWords.includes(word)) {
                    wordFreq[word] = (wordFreq[word] || 0) + 1;
                }
            });
            
            // Sort by frequency and get top keywords
            const sortedWords = Object.entries(wordFreq)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 15)
                .map(([word]) => word);
            
            // Combine with user tags
            const allKeywords = [...new Set([...tags, ...sortedWords])];
            
            return allKeywords.slice(0, 20).join(', ');
        }

        // Generate SEO description
        function generateSEODescription(summary, content) {
            if (summary && summary.length > 50) {
                return summary.length > 160 ? summary.substring(0, 157) + '...' : summary;
            }
            
            // Extract from content if summary is too short
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            const sentences = textContent.split(/[.!?]+/).filter(s => s.trim().length > 20);
            if (sentences.length > 0) {
                const description = sentences[0].trim();
                return description.length > 160 ? description.substring(0, 157) + '...' : description;
            }
            
            return summary || 'Read this article on Forbiary knowledge platform.';
        }

        // Notify moderators about new article
        async function notifyModeratorsNewArticle(articleId, articleData) {
            try {
                await db.collection('moderatorNotifications').add({
                    type: 'new_article',
                    articleId: articleId,
                    articleTitle: articleData.title,
                    author: articleData.author,
                    category: articleData.category,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false,
                    message: `New article "${articleData.title}" published by ${articleData.author}`
                });
            } catch (error) {
                console.error('Error notifying moderators:', error);
            }
        }

        // Generate structured data for article
        function generateArticleStructuredData(article, articleId) {
            const structuredData = {
                "@context": "https://schema.org",
                "@type": "Article",
                "headline": article.title,
                "description": article.summary,
                "author": {
                    "@type": "Person",
                    "name": article.author
                },
                "datePublished": article.timestamp ? article.timestamp.toDate().toISOString() : new Date().toISOString(),
                "dateModified": article.lastEditedAt ? article.lastEditedAt.toDate().toISOString() : article.timestamp ? article.timestamp.toDate().toISOString() : new Date().toISOString(),
                "publisher": {
                    "@type": "Organization",
                    "name": "Forbiary",
                    "url": "https://forbiary.com"
                },
                "mainEntityOfPage": {
                    "@type": "WebPage",
                    "@id": `https://forbiary.com/#${articleId}`
                },
                "articleSection": article.category,
                "keywords": article.tags.join(', '),
                "url": `https://forbiary.com/#${articleId}`
            };
            
            // Remove existing structured data
            const existingScript = document.querySelector('script[type="application/ld+json"][data-article]');
            if (existingScript) {
                existingScript.remove();
            }
            
            // Add new structured data
            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.setAttribute('data-article', 'true');
            script.textContent = JSON.stringify(structuredData);
            document.head.appendChild(script);
        }

        // Detect and create internal links
        function detectInternalLinks() {
            if (!quill) return;
            
            const text = quill.getText();
            const words = text.split(/\s+/);
            
            // Simple internal linking - look for article titles in text
            siteArticles.forEach((articleData, articleId) => {
                const title = articleData.title.toLowerCase();
                words.forEach((word, index) => {
                    if (word.toLowerCase().includes(title) && word.length > 3) {
                        // This is a simplified version - in a real implementation,
                        // you'd want more sophisticated text processing
                    }
                });
            });
        }

        // Load articles for internal linking cache
        async function loadArticlesForLinking() {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .get();
                
                siteArticles.clear();
                snapshot.forEach(doc => {
                    siteArticles.set(doc.id, doc.data());
                });
            } catch (error) {
                console.error('Error loading articles for linking:', error);
            }
        }

        // Submit article or edit
        document.getElementById('articleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = document.querySelector('#articleForm button[type="submit"]');
            if (!submitBtn) {
                console.error('Submit button not found');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;

            try {
                // Check if user is signed in for new articles
                if (!currentEditingArticleId && !currentUser) {
                    showNotification('Please sign in to create articles', 'warning');
                    return;
                }

                // Get and validate form elements
                const titleElement = document.getElementById('articleTitle');
                const summaryElement = document.getElementById('articleSummary');
                const categoryElement = document.getElementById('articleCategory');
                const tagsElement = document.getElementById('articleTags');
                const referencesElement = document.getElementById('articleReferences');
                const editSummaryElement = document.getElementById('editSummary');
                const codeTextareaElement = document.getElementById('codeTextarea');

                if (!titleElement || !summaryElement || !categoryElement || !tagsElement || 
                    !referencesElement || !editSummaryElement || !codeTextareaElement) {
                    throw new Error('Form elements not properly initialized');
                }

                // Get form values safely
                const title = titleElement.value ? titleElement.value.trim() : '';
                const summary = summaryElement.value ? summaryElement.value.trim() : '';
                const category = categoryElement.value ? categoryElement.value.trim() : '';
                const tagsValue = tagsElement.value ? tagsElement.value.trim() : '';
                const referencesValue = referencesElement.value ? referencesElement.value.trim() : '';
                const editSummary = editSummaryElement.value ? editSummaryElement.value.trim() : '';

                // Process tags and references
                const tags = tagsValue ? tagsValue.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                const references = referencesValue ? referencesValue.split('\n').map(ref => ref.trim()).filter(ref => ref) : [];
                
                // Get content based on current edit mode
                let htmlContent = '';
                try {
                    if (currentEditMode === 'visual' && quill && quill.root) {
                        htmlContent = quill.root.innerHTML || '';
                    } else {
                        htmlContent = codeTextareaElement.value || '';
                    }
                } catch (contentError) {
                    console.error('Error getting content:', contentError);
                    htmlContent = codeTextareaElement.value || '';
                }

                // Comprehensive field validation
                const validationErrors = [];
                
                if (!title) {
                    validationErrors.push('Article title is required');
                }
                if (title.length > 200) {
                    validationErrors.push('Article title must be less than 200 characters');
                }
                if (!summary) {
                    validationErrors.push('Article summary is required');
                }
                if (summary.length > 500) {
                    validationErrors.push('Article summary must be less than 500 characters');
                }
                if (!category) {
                    validationErrors.push('Please select a category');
                }
                if (!htmlContent || htmlContent.trim() === '<p><br></p>' || htmlContent.trim() === '' || htmlContent.trim() === '<p></p>') {
                    validationErrors.push('Article content is required');
                }
                if (htmlContent.length > 50000) {
                    validationErrors.push('Article content is too long (maximum 50,000 characters)');
                }

                if (validationErrors.length > 0) {
                    showNotification('Please fix the following errors:<br><br>• ' + validationErrors.join('<br>• '), 'error', 8000);
                    return;
                }

                // Get user IP for tracking
                let userIP = 'unknown';
                try {
                    userIP = await getUserIP();
                    const isBanned = await checkIPBan(userIP);
                    
                    if (isBanned) {
                        showNotification('Your IP address has been banned for submitting false information. Ban will expire in 5 months.', 'error');
                        return;
                    }
                } catch (ipError) {
                    console.warn('Could not get user IP:', ipError);
                }

                // Prepare article data
                const articleData = {
                    title,
                    summary,
                    category,
                    tags,
                    references,
                    content: htmlContent,
                    editSummary: editSummary || 'No summary provided',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: new Date().toISOString(),
                    authorIP: userIP
                };

                if (currentEditingArticleId) {
                    // Update existing article directly
                    const seoKeywords = generateSEOKeywords(title, summary, htmlContent, tags);
                    const seoDescription = generateSEODescription(summary, htmlContent);
                    
                    // Get original article for edit history
                    const originalDoc = await db.collection('articles').doc(currentEditingArticleId).get();
                    const originalArticle = originalDoc.exists ? originalDoc.data() : {};
                    
                    const updatedArticleData = {
                        ...articleData,
                        lastEditedBy: currentUser.displayName,
                        lastEditedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        // SEO Metadata
                        seoKeywords,
                        seoDescription,
                        seoTitle: `${title} - Forbiary`,
                        canonicalUrl: `https://forbiary.com/#${currentEditingArticleId}`,
                        editHistory: firebase.firestore.FieldValue.arrayUnion({
                            editor: currentUser.displayName,
                            editSummary: editSummary || 'No summary provided',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            previousTitle: originalArticle.title || '',
                            previousSummary: originalArticle.summary || ''
                        })
                    };

                    // Update article in Firestore
                    await db.collection('articles').doc(currentEditingArticleId).update(updatedArticleData);
                    
                    // Update in Realtime Database as backup
                    try {
                        await realtimeDb.ref('articles').child(currentEditingArticleId).update({
                            ...updatedArticleData,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            lastEditedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    } catch (realtimeError) {
                        console.warn('Could not save to Realtime Database:', realtimeError);
                    }

                    showNotification('🎉 Article updated successfully! Your changes are now live.', 'success');
                } else {
                    // Create new article
                    const seoKeywords = generateSEOKeywords(title, summary, htmlContent, tags);
                    const seoDescription = generateSEODescription(summary, htmlContent);
                    
                    const newArticleData = {
                        ...articleData,
                        author: currentUser.displayName,
                        authorEmail: currentUser.email,
                        uid: currentUser.uid,
                        status: 'approved', // Published immediately
                        editHistory: [],
                        locked: false,
                        viewCount: 0,
                        lastViewed: firebase.firestore.FieldValue.serverTimestamp(),
                        // SEO Metadata
                        seoKeywords,
                        seoDescription,
                        seoTitle: `${title} - Forbiary`
                    };

                    // Submit to Firestore
                    const articleRef = await db.collection('articles').add(newArticleData);
                    
                    // Update with canonical URL
                    await db.collection('articles').doc(articleRef.id).update({
                        canonicalUrl: `https://forbiary.com/#${articleRef.id}`
                    });

                    // Submit to Realtime Database as backup
                    try {
                        await realtimeDb.ref('articles').child(articleRef.id).set({
                            ...newArticleData,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            lastViewed: firebase.database.ServerValue.TIMESTAMP,
                            canonicalUrl: `https://forbiary.com/#${articleRef.id}`
                        });
                    } catch (realtimeError) {
                        console.warn('Could not save to Realtime Database:', realtimeError);
                    }

                    // Notify moderators about new article
                    try {
                        await notifyModeratorsNewArticle(articleRef.id, {
                            title,
                            author: currentUser.displayName,
                            category,
                            timestamp: new Date()
                        });
                    } catch (notifyError) {
                        console.warn('Could not notify moderators:', notifyError);
                    }

                    showNotification('🎉 Article published successfully! Your article is now live on Forbiary.', 'success', 6000);
                    
                    // Auto-refresh recent articles and redirect to home
                    setTimeout(() => {
                        loadRecentArticles();
                        showHome();
                    }, 1500);
                }

                // Clear form and redirect
                clearForm();
                showHome();
                
            } catch (error) {
                console.error('Submission error:', error);
                
                // Show user-friendly error message
                let errorMessage = 'An error occurred while submitting your article. ';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'You do not have permission to perform this action.';
                } else if (error.code === 'network-request-failed') {
                    errorMessage += 'Network error. Please check your internet connection and try again.';
                } else if (error.code === 'quota-exceeded') {
                    errorMessage += 'Storage quota exceeded. Please try again later.';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Please try again or contact support if the problem persists.';
                }
                
                showNotification(errorMessage, 'error', 8000);
                
            } finally {
                // Always reset button state
                try {
                    if (submitBtn) {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (resetError) {
                    console.error('Error resetting button:', resetError);
                }
            }
        });

        // Load recent articles
        async function loadRecentArticles() {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .orderBy('timestamp', 'desc')
                    .limit(6)
                    .get();

                const container = document.getElementById('recentArticles');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No articles published yet.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const article = doc.data();
                    const articleLink = createArticleLink(doc.id, article);
                    container.appendChild(articleLink);
                });
            } catch (error) {
                console.error('Error loading recent articles:', error);
            }
        }

        // Create article link for lists
        function createArticleLink(id, article) {
            const link = document.createElement('div');
            link.style.marginBottom = '10px';
            
            const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';
            
            link.innerHTML = `
                <div style="border-bottom: 1px solid #eee; padding-bottom: 8px;">
                    <a href="#" onclick="openArticle('${id}')" style="color: #0645ad; text-decoration: none; font-weight: bold; font-size: 16px;">${article.title}</a>
                    <div style="font-size: 14px; color: #666; margin-top: 4px;">
                        <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 8px;">${article.category}</span>
                        By ${article.author} • ${date}
                    </div>
                    <p style="font-size: 14px; color: #333; margin: 8px 0 0 0; line-height: 1.4;">${article.summary}</p>
                </div>
            `;
            
            return link;
        }

        // Load all articles for search
        async function loadAllArticles() {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .orderBy('timestamp', 'desc')
                    .get();

                displaySearchResults(snapshot);
            } catch (error) {
                console.error('Error loading articles:', error);
            }
        }

        // Search articles
        async function searchArticles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            try {
                let query = db.collection('articles').where('status', '==', 'approved');
                
                if (categoryFilter) {
                    query = query.where('category', '==', categoryFilter);
                }

                const snapshot = await query.get();
                
                let filteredDocs = [];
                snapshot.forEach(doc => {
                    const article = doc.data();
                    const matchesSearch = !searchTerm || 
                        article.title.toLowerCase().includes(searchTerm) ||
                        article.summary.toLowerCase().includes(searchTerm) ||
                        article.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                    
                    if (matchesSearch) {
                        filteredDocs.push({ id: doc.id, data: article });
                    }
                });

                displaySearchResults({ docs: filteredDocs });
            } catch (error) {
                console.error('Error searching articles:', error);
            }
        }

        // Display search results
        function displaySearchResults(snapshot) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            const docs = snapshot.docs || snapshot;

            if (docs.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No articles found.</p>';
                return;
            }

            docs.forEach(item => {
                const doc = item.id ? item : { id: item.id, data: () => item.data };
                const article = item.data || doc.data();
                const articleLink = createArticleLink(item.id || doc.id, article);
                container.appendChild(articleLink);
            });
        }

        // Open article
        async function openArticle(articleId) {
            try {
                const doc = await db.collection('articles').doc(articleId).get();
                
                if (!doc.exists) {
                    showNotification('Article not found', 'error');
                    return;
                }

                const article = doc.data();
                
                if (article.status !== 'approved') {
                    showNotification('Article is not available', 'warning');
                    return;
                }

                // Update view count
                try {
                    await db.collection('articles').doc(articleId).update({
                        viewCount: firebase.firestore.FieldValue.increment(1),
                        lastViewed: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating view count:', error);
                }

                hideAllPages();
                document.getElementById('articleReader').style.display = 'block';
                
                // Update SEO metadata for article
                const canonicalUrl = `https://forbiary.com/#${articleId}`;
                updatePageMetadata(
                    article.seoTitle || `${article.title} - Forbiary`,
                    article.seoDescription || article.summary,
                    article.seoKeywords || article.tags.join(', '),
                    canonicalUrl
                );
                
                // Generate structured data
                generateArticleStructuredData(article, articleId);
                
                const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';
                const tagsHtml = article.tags.map(tag => 
                    `<span class="inline-block bg-gray-100 text-gray-800 text-sm px-3 py-1 rounded-full mr-2">${tag}</span>`
                ).join('');

                const referencesHtml = article.references.length > 0 ? 
                    `<div class="mt-8 p-6 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">References</h3>
                        <ul class="space-y-2">
                            ${article.references.map(ref => `<li class="text-sm text-gray-600">• ${ref}</li>`).join('')}
                        </ul>
                    </div>` : '';

                const isLocked = article.locked || false;
                const editButton = !isLocked ? `<button onclick="showWrite('${articleId}')" class="wiki-edit-btn" style="float: right;"><i class="fas fa-edit"></i> Edit</button>` : 
                    `<span style="float: right; background: #dc3545; color: white; padding: 8px 16px; border-radius: 2px; font-size: 14px;"><i class="fas fa-lock"></i> Locked</span>`;
                
                const lockButton = (isAdmin || isModerator) ? 
                    `<button onclick="${isLocked ? 'unlockArticle' : 'lockArticle'}('${articleId}')" class="wiki-edit-btn" style="background: ${isLocked ? '#28a745' : '#dc3545'};">
                        <i class="fas fa-${isLocked ? 'unlock' : 'lock'}"></i> ${isLocked ? 'Unlock' : 'Lock'} Article
                    </button>` : '';

                const editHistoryHtml = article.editHistory && article.editHistory.length > 0 ? 
                    `<div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; margin: 20px 0; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Edit History</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${article.editHistory.slice(-10).reverse().map(edit => 
                                `<div style="padding: 5px 0; border-bottom: 1px solid #eee; font-size: 14px;">
                                    <strong>${edit.editor}</strong> - ${edit.editSummary || 'No summary'} 
                                    <span style="color: #666;">(${edit.timestamp ? new Date(edit.timestamp.toDate()).toLocaleDateString() : 'Recently'})</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>` : '';

                // Generate related articles
                const relatedArticlesHtml = await generateRelatedArticles(article, articleId);
                
                document.getElementById('articleContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        ${editButton}
                        <div class="article-meta">
                            <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-size: 14px;">${article.category}</span>
                            ${isLocked ? '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 3px; font-size: 14px; margin-left: 8px;"><i class="fas fa-lock"></i> Locked</span>' : ''}
                        </div>
                        <h1>${article.title}</h1>
                        <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                            By <strong>${article.author}</strong> • ${date}
                        </div>
                        <p style="font-size: 16px; color: #333; margin-bottom: 20px; font-style: italic;">${article.summary}</p>
                        <div style="margin-bottom: 20px;">${tagsHtml}</div>
                    </div>
                    
                    <div style="line-height: 1.6; margin-bottom: 30px;">
                        ${article.content}
                    </div>
                    
                    ${relatedArticlesHtml}
                    ${editHistoryHtml}
                    ${referencesHtml}
                    
                    <div class="edit-actions" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #a2a9b1;">
                        <button onclick="showHome()" class="wiki-edit-btn">
                            <i class="fas fa-arrow-left"></i> Back to Home
                        </button>
                        <button onclick="copyArticleLink('${articleId}')" class="wiki-edit-btn" style="background: #f8f9fa; color: #333;">
                            <i class="fas fa-share"></i> Share Article
                        </button>
                        ${!isLocked ? `<button onclick="showWrite('${articleId}')" class="wiki-edit-btn"><i class="fas fa-edit"></i> Edit Article</button>` : ''}
                        ${lockButton}
                    </div>
                `;

                window.location.hash = articleId;
            } catch (error) {
                console.error('Error loading article:', error);
                alert('Error loading article');
            }
        }

        // Generate related articles
        async function generateRelatedArticles(currentArticle, currentArticleId) {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .where('category', '==', currentArticle.category)
                    .limit(10)
                    .get();

                let relatedArticles = [];
                snapshot.forEach(doc => {
                    if (doc.id !== currentArticleId) {
                        const article = doc.data();
                        // Calculate relevance based on shared tags
                        const sharedTags = currentArticle.tags.filter(tag => 
                            article.tags.some(articleTag => articleTag.toLowerCase() === tag.toLowerCase())
                        );
                        
                        if (sharedTags.length > 0 || article.category === currentArticle.category) {
                            relatedArticles.push({
                                id: doc.id,
                                ...article,
                                relevance: sharedTags.length
                            });
                        }
                    }
                });

                // Sort by relevance and take top 5
                relatedArticles.sort((a, b) => b.relevance - a.relevance);
                relatedArticles = relatedArticles.slice(0, 5);

                if (relatedArticles.length === 0) {
                    return '';
                }

                const relatedHtml = relatedArticles.map(article => 
                    `<div style="margin-bottom: 8px;">
                        <a href="#" onclick="openArticle('${article.id}')" class="internal-link" style="font-size: 14px;">${article.title}</a>
                        <div style="font-size: 12px; color: #666;">${article.summary.substring(0, 100)}...</div>
                    </div>`
                ).join('');

                return `
                    <div class="related-articles">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px;">Related Articles</h3>
                        ${relatedHtml}
                    </div>
                `;
            } catch (error) {
                console.error('Error generating related articles:', error);
                return '';
            }
        }

        // Copy article link
        function copyArticleLink(articleId) {
            const link = `${window.location.origin}${window.location.pathname}#${articleId}`;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('Article link copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy link to clipboard', 'error');
            });
        }

        // Lock article
        async function lockArticle(articleId) {
            if (!isAdmin && !isModerator) {
                showNotification('Only moderators can lock articles', 'warning');
                return;
            }

            const confirmLock = await showConfirmDialog(
                'Lock Article', 
                'Are you sure you want to lock this article? This will prevent all users from editing it.',
                'Lock Article',
                'Cancel'
            );
            
            if (confirmLock) {
                try {
                    await db.collection('articles').doc(articleId).update({
                        locked: true,
                        lockedBy: currentUser.displayName,
                        lockedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('Article locked successfully!', 'success');
                    openArticle(articleId); // Refresh the article view
                } catch (error) {
                    showNotification('Error locking article: ' + error.message, 'error');
                }
            }
        }

        // Unlock article
        async function unlockArticle(articleId) {
            if (!isAdmin && !isModerator) {
                showNotification('Only moderators can unlock articles', 'warning');
                return;
            }

            const confirmUnlock = await showConfirmDialog(
                'Unlock Article', 
                'Are you sure you want to unlock this article? This will allow users to edit it again.',
                'Unlock Article',
                'Cancel'
            );
            
            if (confirmUnlock) {
                try {
                    await db.collection('articles').doc(articleId).update({
                        locked: false,
                        unlockedBy: currentUser.displayName,
                        unlockedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('Article unlocked successfully!', 'success');
                    openArticle(articleId); // Refresh the article view
                } catch (error) {
                    showNotification('Error unlocking article: ' + error.message, 'error');
                }
            }
        }

        // Load recent articles for moderators
        async function loadRecentArticlesForModerators() {
            if (!isAdmin && !isModerator) return;

            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'approved')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                const container = document.getElementById('recentArticlesList');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No recent articles.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const article = doc.data();
                    const articleCard = createModeratorReviewCard(doc.id, article);
                    container.appendChild(articleCard);
                });
            } catch (error) {
                console.error('Error loading recent articles:', error);
            }
        }

        // Load moderator notifications
        async function loadModeratorNotifications() {
            if (!isAdmin && !isModerator) return;

            try {
                const snapshot = await db.collection('moderatorNotifications')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();

                const container = document.getElementById('moderatorNotifications');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No notifications.</p>';
                    return;
                }

                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const notification = doc.data();
                    if (!notification.read) unreadCount++;
                    
                    const notificationCard = createNotificationCard(doc.id, notification);
                    container.appendChild(notificationCard);
                });

                // Update notification badge
                const badge = document.getElementById('notificationBadge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Load moderator suggestions
        async function loadModeratorSuggestions() {
            if (!currentUser || (!isAdmin && !isModerator)) return;

            try {
                const snapshot = await db.collection('moderatorSuggestions')
                    .where('moderatorId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .get();

                const container = document.getElementById('moderatorSuggestions');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">You haven\'t made any suggestions yet.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const suggestion = doc.data();
                    const suggestionCard = createSuggestionCard(doc.id, suggestion);
                    container.appendChild(suggestionCard);
                });
            } catch (error) {
                console.error('Error loading suggestions:', error);
            }
        }

        // Create moderator review card for recent articles
        function createModeratorReviewCard(id, article) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; margin-bottom: 20px;';

            const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';
            const timeAgo = article.timestamp ? getTimeAgo(article.timestamp.toDate()) : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">
                            <a href="#" onclick="openArticle('${id}')" style="color: #0645ad; text-decoration: none;">${article.title}</a>
                        </h3>
                        <p style="margin: 0 0 8px 0; color: #666; line-height: 1.4;">${article.summary}</p>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <span>By <strong>${article.author}</strong> • ${timeAgo} • ${article.category}</span>
                            ${article.viewCount ? ` • ${article.viewCount} views` : ''}
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            <strong>SEO Keywords:</strong> ${article.seoKeywords || 'Auto-generated'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="suggestImprovement('${id}')" class="wiki-edit-btn" style="background: #17a2b8;">
                            <i class="fas fa-lightbulb"></i> Suggest
                        </button>
                        <button onclick="deleteArticle('${id}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button onclick="openArticle('${id}')" class="wiki-edit-btn" style="background: #6c757d;">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Create notification card
        function createNotificationCard(id, notification) {
            const card = document.createElement('div');
            const isUnread = !notification.read;
            card.style.cssText = `background: ${isUnread ? '#fff3cd' : '#f8f9fa'}; border: 1px solid ${isUnread ? '#ffeaa7' : '#a2a9b1'}; padding: 15px; border-radius: 4px; margin-bottom: 15px;`;

            const date = notification.timestamp ? new Date(notification.timestamp.toDate()).toLocaleDateString() : 'Recently';
            const timeAgo = notification.timestamp ? getTimeAgo(notification.timestamp.toDate()) : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="font-size: 16px; color: #333; margin-bottom: 5px;">
                            ${isUnread ? '<strong>' : ''}${notification.message}${isUnread ? '</strong>' : ''}
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            ${timeAgo} • ${notification.type === 'new_article' ? 'New Article' : 'Notification'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${notification.articleId ? `<button onclick="openArticle('${notification.articleId}')" class="wiki-edit-btn" style="background: #6c757d; font-size: 12px; padding: 4px 8px;">View</button>` : ''}
                        ${isUnread ? `<button onclick="markNotificationRead('${id}')" class="wiki-edit-btn" style="background: #28a745; font-size: 12px; padding: 4px 8px;">Mark Read</button>` : ''}
                    </div>
                </div>
            `;

            return card;
        }

        // Create suggestion card
        function createSuggestionCard(id, suggestion) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; border-radius: 4px; margin-bottom: 15px;';

            const date = suggestion.timestamp ? new Date(suggestion.timestamp.toDate()).toLocaleDateString() : 'Recently';
            const timeAgo = suggestion.timestamp ? getTimeAgo(suggestion.timestamp.toDate()) : 'Recently';

            const statusColor = suggestion.status === 'implemented' ? '#28a745' : 
                               suggestion.status === 'rejected' ? '#dc3545' : '#ffc107';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="font-size: 16px; color: #333; margin-bottom: 5px;">
                            <strong>${suggestion.type === 'improvement' ? 'Improvement' : 'Deletion'} Suggestion</strong>
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            Article: <a href="#" onclick="openArticle('${suggestion.articleId}')" style="color: #0645ad;">${suggestion.articleTitle}</a>
                        </div>
                        <div style="font-size: 14px; color: #333; margin-bottom: 8px;">
                            ${suggestion.suggestion}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ${timeAgo} • Status: <span style="color: ${statusColor}; font-weight: bold;">${suggestion.status.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // Get time ago helper
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        // Create moderation card
        function createModerationCard(id, article) {
            const card = document.createElement('div');
            card.style.cssText = 'background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 4px; margin-bottom: 20px;';

            const date = article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">${article.title}</h3>
                        <p style="margin: 0 0 8px 0; color: #666; line-height: 1.4;">${article.summary}</p>
                        <div style="font-size: 14px; color: #666;">
                            <span>By <strong>${article.author}</strong> • ${date} • ${article.category}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="approveArticle('${id}')" class="wiki-edit-btn" style="background: #28a745;">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button onclick="rejectArticle('${id}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
                <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">Article Content Preview:</h4>
                    <div style="max-height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.6; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                        ${article.content.length > 1500 ? article.content.substring(0, 1500) + '...<br><br><em style="color: #666;">[Content truncated - Full article available after approval]</em>' : article.content}
                    </div>
                </div>
            `;

            return card;
        }

        // Approve article
        async function approveArticle(articleId) {
            if (!isAdmin && !isModerator) return;

            try {
                await db.collection('articles').doc(articleId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: currentUser.displayName
                });
                
                showNotification('Article approved successfully!', 'success');
                loadPendingArticles();
            } catch (error) {
                showNotification('Error approving article: ' + error.message, 'error');
            }
        }

        // Reject article
        async function rejectArticle(articleId) {
            if (!isAdmin && !isModerator) return;

            const confirmReject = await showConfirmDialog(
                'Reject Article', 
                'Are you sure you want to reject this article?',
                'Reject',
                'Cancel'
            );
            
            if (confirmReject) {
                try {
                    await db.collection('articles').doc(articleId).update({
                        status: 'rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rejectedBy: currentUser.displayName
                    });
                    
                    showNotification('Article rejected', 'info');
                    loadPendingArticles();
                } catch (error) {
                    showNotification('Error rejecting article: ' + error.message, 'error');
                }
            }
        }

        // Load category counts
        async function loadCategoryCounts() {
            const categories = ['Technology', 'Business', 'Science', 'History', 'Health', 'Education'];
            
            for (const category of categories) {
                try {
                    const snapshot = await db.collection('articles')
                        .where('status', '==', 'approved')
                        .where('category', '==', category)
                        .get();
                    
                    const count = snapshot.size;
                    const elementId = category.toLowerCase() + 'Count';
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `${count} article${count !== 1 ? 's' : ''}`;
                    }
                } catch (error) {
                    console.error(`Error loading ${category} count:`, error);
                    const elementId = category.toLowerCase() + 'Count';
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = 'Error loading count';
                    }
                }
            }
        }

        // Load pending edits
        async function loadPendingEdits() {
            if (!isAdmin && !isModerator) return;

            try {
                const snapshot = await db.collection('edits')
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();

                const container = document.getElementById('pendingEditsList');
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No pending edits.</p>';
                    return;
                }

                for (const doc of snapshot.docs) {
                    const edit = doc.data();
                    const editCard = await createEditCard(doc.id, edit);
                    container.appendChild(editCard);
                }
            } catch (error) {
                console.error('Error loading pending edits:', error);
            }
        }

        // Create edit card
        async function createEditCard(editId, edit) {
            const card = document.createElement('div');
            card.className = 'pending-edit';

            // Get original article
            let originalArticle = null;
            try {
                const articleDoc = await db.collection('articles').doc(edit.articleId).get();
                originalArticle = articleDoc.exists ? articleDoc.data() : null;
            } catch (error) {
                console.error('Error loading original article:', error);
            }

            const date = edit.timestamp ? new Date(edit.timestamp.toDate()).toLocaleDateString() : 'Recently';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px;">${edit.title}</h3>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            Edited by <strong>${edit.editor}</strong> • ${date}
                            ${edit.editorIP ? ` • IP: ${edit.editorIP}` : ''}
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <strong>Edit Summary:</strong> ${edit.editSummary || 'No summary provided'}
                        </div>
                        ${originalArticle ? `<div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <strong>Original Article:</strong> <a href="#" onclick="openArticle('${edit.articleId}')" style="color: #0645ad;">${originalArticle.title}</a>
                        </div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="approveEdit('${editId}')" class="wiki-edit-btn" style="background: #28a745;">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button onclick="rejectEdit('${editId}')" class="wiki-edit-btn" style="background: #dc3545;">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        ${edit.editorIP && edit.editorIP !== 'unknown' ? `<button onclick="banIP('${edit.editorIP}', 'False information in edit')" class="wiki-edit-btn" style="background: #6c757d;">
                            <i class="fas fa-ban"></i> Ban IP
                        </button>` : ''}
                    </div>
                </div>
                <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">Edited Content Preview:</h4>
                    <div style="max-height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.6; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                        ${edit.content.length > 1500 ? edit.content.substring(0, 1500) + '...<br><br><em style="color: #666;">[Content truncated - Full content available after approval]</em>' : edit.content}
                    </div>
                </div>
            `;

            return card;
        }

        // Approve edit
        async function approveEdit(editId) {
            if (!isAdmin && !isModerator) return;

            try {
                const editDoc = await db.collection('edits').doc(editId).get();
                if (!editDoc.exists) return;

                const edit = editDoc.data();

                // Update the original article
                await db.collection('articles').doc(edit.articleId).update({
                    title: edit.title,
                    summary: edit.summary,
                    category: edit.category,
                    tags: edit.tags,
                    references: edit.references,
                    content: edit.content,
                    lastEditedBy: edit.editor,
                    lastEditedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    editHistory: firebase.firestore.FieldValue.arrayUnion({
                        editor: edit.editor,
                        editSummary: edit.editSummary,
                        timestamp: edit.timestamp
                    })
                });

                // Mark edit as approved
                await db.collection('edits').doc(editId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: currentUser.displayName
                });

                showNotification('Edit approved successfully!', 'success');
                loadPendingEdits();
            } catch (error) {
                showNotification('Error approving edit: ' + error.message, 'error');
            }
        }

        // Reject edit
        async function rejectEdit(editId) {
            if (!isAdmin && !isModerator) return;

            const confirmReject = await showConfirmDialog(
                'Reject Edit', 
                'Are you sure you want to reject this edit?',
                'Reject',
                'Cancel'
            );
            
            if (confirmReject) {
                try {
                    await db.collection('edits').doc(editId).update({
                        status: 'rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rejectedBy: currentUser.displayName
                    });

                    showNotification('Edit rejected', 'info');
                    loadPendingEdits();
                } catch (error) {
                    showNotification('Error rejecting edit: ' + error.message, 'error');
                }
            }
        }

        // Suggest improvement for article
        async function suggestImprovement(articleId) {
            if (!currentUser || (!isAdmin && !isModerator)) return;

            const suggestion = prompt('Enter your suggestion for improving this article:');
            if (!suggestion || !suggestion.trim()) return;

            try {
                const articleDoc = await db.collection('articles').doc(articleId).get();
                const article = articleDoc.data();

                await db.collection('moderatorSuggestions').add({
                    articleId: articleId,
                    articleTitle: article.title,
                    moderatorId: currentUser.uid,
                    moderatorName: currentUser.displayName,
                    type: 'improvement',
                    suggestion: suggestion.trim(),
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('Suggestion submitted successfully!', 'success');
            } catch (error) {
                showNotification('Error submitting suggestion: ' + error.message, 'error');
            }
        }

        // Delete article
        async function deleteArticle(articleId) {
            if (!currentUser || (!isAdmin && !isModerator)) return;

            const reason = prompt('Enter reason for deleting this article (required):');
            if (!reason || !reason.trim()) return;

            const confirmDelete = await showConfirmDialog(
                'Delete Article', 
                'Are you sure you want to delete this article? This action cannot be undone.',
                'Delete',
                'Cancel'
            );
            
            if (confirmDelete) {
                try {
                    const articleDoc = await db.collection('articles').doc(articleId).get();
                    const article = articleDoc.data();

                    // Log the deletion
                    await db.collection('moderatorSuggestions').add({
                        articleId: articleId,
                        articleTitle: article.title,
                        moderatorId: currentUser.uid,
                        moderatorName: currentUser.displayName,
                        type: 'deletion',
                        suggestion: reason.trim(),
                        status: 'implemented',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Delete the article
                    await db.collection('articles').doc(articleId).delete();

                    showNotification('Article deleted successfully!', 'success');
                    loadRecentArticlesForModerators();
                } catch (error) {
                    showNotification('Error deleting article: ' + error.message, 'error');
                }
            }
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                await db.collection('moderatorNotifications').doc(notificationId).update({
                    read: true,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                loadModeratorNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Handle URL hash for direct article links
        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                openArticle(hash);
            } else {
                showHome();
            }
        }

        // Add demo articles on first load
        function addDemoArticles() {
            const demoArticles = [
                {
                    title: "Artificial Intelligence Revolution",
                    summary: "Exploring the transformative impact of AI on modern society and future possibilities.",
                    category: "Technology",
                    tags: ["AI", "Machine Learning", "Technology", "Future"],
                    references: ["https://example.com/ai-research", "MIT Technology Review"],
                    content: `<h2>Introduction</h2><p>Artificial Intelligence (AI) has emerged as one of the most transformative technologies of the 21st century. From <strong>machine learning</strong> algorithms to <em>neural networks</em>, AI is reshaping industries and redefining human capabilities.</p><h2>Key Applications</h2><ul><li>Healthcare diagnostics</li><li>Autonomous vehicles</li><li>Natural language processing</li><li>Computer vision</li></ul><blockquote>AI is not just a technology; it's a paradigm shift that will define the future of human civilization.</blockquote><h2>Future Implications</h2><p>As AI continues to evolve, we must consider both the <span style="color: rgb(230, 0, 0);">challenges</span> and <span style="color: rgb(0, 138, 0);">opportunities</span> it presents for society.</p>`,
                    author: "Tech Expert",
                    authorEmail: "tech@forbiary.com",
                    uid: "demo-tech-user",
                    status: "approved",
                    locked: false,
                    editHistory: [],
                    seoKeywords: "artificial intelligence, AI, machine learning, neural networks, technology, future, automation, healthcare, autonomous vehicles",
                    seoDescription: "Exploring the transformative impact of AI on modern society and future possibilities including healthcare, autonomous vehicles, and more.",
                    seoTitle: "Artificial Intelligence Revolution - Forbiary",
                    viewCount: 42
                },
                {
                    title: "Climate Change Solutions",
                    summary: "Comprehensive overview of innovative approaches to combat climate change and environmental challenges.",
                    category: "Science",
                    tags: ["Climate", "Environment", "Sustainability", "Green Technology"],
                    references: ["IPCC Reports", "Nature Climate Change Journal"],
                    content: `<h2>The Challenge</h2><p>Climate change represents one of the most pressing challenges of our time. Rising global temperatures, extreme weather events, and environmental degradation require <strong>immediate action</strong>.</p><h2>Renewable Energy Solutions</h2><ol><li><strong>Solar Power</strong> - Harnessing the sun's energy</li><li><strong>Wind Energy</strong> - Utilizing wind currents</li><li><strong>Hydroelectric Power</strong> - Water-based energy generation</li></ol><h2>Carbon Capture Technologies</h2><p>Innovative technologies are being developed to <em>capture and store carbon dioxide</em> from the atmosphere, helping to reduce greenhouse gas concentrations.</p><blockquote>The time for action is now. Every degree matters, every year matters, and every choice matters.</blockquote>`,
                    author: "Climate Scientist",
                    authorEmail: "climate@forbiary.com",
                    uid: "demo-climate-user",
                    status: "approved",
                    locked: false,
                    editHistory: [],
                    seoKeywords: "climate change, environment, sustainability, renewable energy, solar power, wind energy, carbon capture, green technology, global warming",
                    seoDescription: "Comprehensive overview of innovative approaches to combat climate change including renewable energy solutions and carbon capture technologies.",
                    seoTitle: "Climate Change Solutions - Forbiary",
                    viewCount: 28
                },
                {
                    title: "Digital Marketing Strategies",
                    summary: "Essential digital marketing techniques for modern businesses to reach and engage customers effectively.",
                    category: "Business",
                    tags: ["Marketing", "Digital", "Business", "Strategy"],
                    references: ["Harvard Business Review", "Marketing Land"],
                    content: `<h2>Introduction to Digital Marketing</h2><p>In today's digital age, businesses must adapt their marketing strategies to reach customers where they spend most of their time - <strong>online</strong>.</p><h2>Key Strategies</h2><ul><li><strong>Search Engine Optimization (SEO)</strong></li><li><em>Social Media Marketing</em></li><li>Content Marketing</li><li>Email Marketing</li><li>Pay-Per-Click Advertising</li></ul><h2>Measuring Success</h2><p>Effective digital marketing requires continuous monitoring and optimization. Key metrics include:</p><ol><li>Conversion rates</li><li>Customer acquisition cost</li><li>Return on investment (ROI)</li></ol><blockquote>The best marketing doesn't feel like marketing.</blockquote>`,
                    author: "Marketing Pro",
                    authorEmail: "marketing@forbiary.com",
                    uid: "demo-marketing-user",
                    status: "approved",
                    locked: false,
                    editHistory: [],
                    seoKeywords: "digital marketing, SEO, social media marketing, content marketing, email marketing, PPC, business strategy, online marketing, customer engagement",
                    seoDescription: "Essential digital marketing techniques for modern businesses including SEO, social media, content marketing, and customer engagement strategies.",
                    seoTitle: "Digital Marketing Strategies - Forbiary",
                    viewCount: 35
                }
            ];

            // Check if demo articles already exist
            const existingArticles = JSON.parse(localStorage.getItem('collection_articles') || '[]');
            if (existingArticles.length === 0) {
                demoArticles.forEach((article, index) => {
                    const id = `demo_article_${index + 1}`;
                    const articleData = {
                        ...article,
                        id: id,
                        timestamp: new Date(Date.now() - (index * 24 * 60 * 60 * 1000)), // Stagger dates
                        createdAt: new Date(Date.now() - (index * 24 * 60 * 60 * 1000)).toISOString()
                    };
                    
                    localStorage.setItem(`articles_${id}`, JSON.stringify(articleData));
                    existingArticles.push(articleData);
                });
                
                localStorage.setItem('collection_articles', JSON.stringify(existingArticles));
            }
        }

        // Load user profile with points system
        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                // Get user's articles
                const articlesSnapshot = await db.collection('articles')
                    .where('uid', '==', currentUser.uid)
                    .get();

                // Get user's edits
                const editsSnapshot = await db.collection('edits')
                    .where('editorUid', '==', currentUser.uid)
                    .get();

                // Calculate statistics
                let totalArticles = 0;
                let approvedArticles = 0;
                let rejectedArticles = 0;
                let pendingArticles = 0;

                articlesSnapshot.forEach(doc => {
                    const article = doc.data();
                    totalArticles++;
                    if (article.status === 'approved') approvedArticles++;
                    else if (article.status === 'rejected') rejectedArticles++;
                    else if (article.status === 'pending') pendingArticles++;
                });

                let totalEdits = 0;
                let approvedEdits = 0;
                let rejectedEdits = 0;
                let pendingEdits = 0;

                editsSnapshot.forEach(doc => {
                    const edit = doc.data();
                    totalEdits++;
                    if (edit.status === 'approved') approvedEdits++;
                    else if (edit.status === 'rejected') rejectedEdits++;
                    else if (edit.status === 'pending') pendingEdits++;
                });

                // Calculate points
                const points = calculateUserPoints(approvedArticles, rejectedArticles, approvedEdits, rejectedEdits);
                
                // Get user's profile data or create default
                let profileData = {
                    joinedAt: currentUser.metadata.creationTime,
                    totalContributions: totalArticles + totalEdits,
                    points: points
                };

                try {
                    const profileDoc = await db.collection('userProfiles').doc(currentUser.uid).get();
                    if (profileDoc.exists) {
                        profileData = { ...profileData, ...profileDoc.data() };
                    } else {
                        // Create profile document
                        await db.collection('userProfiles').doc(currentUser.uid).set({
                            ...profileData,
                            email: currentUser.email,
                            name: currentUser.displayName,
                            photoURL: currentUser.photoURL,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                } catch (error) {
                    console.error('Error loading profile data:', error);
                }

                displayUserProfile(profileData, {
                    totalArticles,
                    approvedArticles,
                    rejectedArticles,
                    pendingArticles,
                    totalEdits,
                    approvedEdits,
                    rejectedEdits,
                    pendingEdits,
                    points
                });

            } catch (error) {
                console.error('Error loading user profile:', error);
                document.getElementById('profileContent').innerHTML = '<p style="color: #dc3545;">Error loading profile data.</p>';
            }
        }

        // Calculate user points based on contributions
        function calculateUserPoints(approvedArticles, rejectedArticles, approvedEdits, rejectedEdits) {
            let points = 0;
            
            // Article points
            points += approvedArticles * 10; // +10 for each approved article
            points -= rejectedArticles * 5;  // -5 for each rejected article
            
            // Edit points
            points += approvedEdits * 5;     // +5 for each approved edit
            points -= rejectedEdits * 2;     // -2 for each rejected edit
            
            return points;
        }

        // Display user profile
        function displayUserProfile(profileData, stats) {
            const joinedDate = new Date(profileData.joinedAt).toLocaleDateString();
            const pointsColor = stats.points >= 0 ? '#007bff' : '#dc3545'; // Blue for positive, red for negative
            const pointsSign = stats.points >= 0 ? '+' : '';

            const profileHTML = `
                <div class="profile-grid">
                    <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 20px; border-radius: 8px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img src="${currentUser.photoURL}" alt="Profile Photo" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px;">
                            <h2 style="margin: 0 0 5px 0; font-size: 24px; color: #333;">${currentUser.displayName}</h2>
                            <p style="margin: 0; color: #666; font-size: 14px;">${currentUser.email}</p>
                            ${isModerator ? '<span class="moderator-badge" style="margin-top: 10px; display: inline-block;">Moderator</span>' : ''}
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 6px;">
                            <div style="font-size: 32px; font-weight: bold; color: ${pointsColor}; margin-bottom: 5px;">
                                ${pointsSign}${stats.points}
                            </div>
                            <div style="font-size: 14px; color: #666;">Contribution Points</div>
                        </div>
                        
                        <div style="margin-top: 20px; font-size: 14px; color: #666;">
                            <div style="margin-bottom: 8px;"><strong>Joined:</strong> ${joinedDate}</div>
                            <div style="margin-bottom: 8px;"><strong>Total Contributions:</strong> ${profileData.totalContributions}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #333;">Contribution Statistics</h3>
                        
                        <div class="profile-stats-grid">
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; border-radius: 6px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 8px;">
                                    <i class="fas fa-file-alt" style="margin-right: 8px; color: #007bff;"></i>Articles
                                </h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Total:</span>
                                    <strong>${stats.totalArticles}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #28a745;">✓ Approved:</span>
                                    <strong style="color: #28a745;">${stats.approvedArticles} (+${stats.approvedArticles * 10})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #dc3545;">✗ Rejected:</span>
                                    <strong style="color: #dc3545;">${stats.rejectedArticles} (${stats.rejectedArticles * -5})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #ffc107;">⏳ Pending:</span>
                                    <strong style="color: #ffc107;">${stats.pendingArticles}</strong>
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; border-radius: 6px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 8px;">
                                    <i class="fas fa-edit" style="margin-right: 8px; color: #17a2b8;"></i>Edits
                                </h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Total:</span>
                                    <strong>${stats.totalEdits}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #28a745;">✓ Approved:</span>
                                    <strong style="color: #28a745;">${stats.approvedEdits} (+${stats.approvedEdits * 5})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #dc3545;">✗ Rejected:</span>
                                    <strong style="color: #dc3545;">${stats.rejectedEdits} (${stats.rejectedEdits * -2})</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #ffc107;">⏳ Pending:</span>
                                    <strong style="color: #ffc107;">${stats.pendingEdits}</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #e9ecef; border: 1px solid #ced4da; padding: 15px; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">
                                <i class="fas fa-calculator" style="margin-right: 8px; color: #6c757d;"></i>Points Breakdown
                            </h4>
                            <div style="font-size: 14px; color: #666;">
                                <div style="margin-bottom: 5px;">• Approved Articles: ${stats.approvedArticles} × 10 = <span style="color: #28a745;">+${stats.approvedArticles * 10}</span></div>
                                <div style="margin-bottom: 5px;">• Rejected Articles: ${stats.rejectedArticles} × -5 = <span style="color: #dc3545;">${stats.rejectedArticles * -5}</span></div>
                                <div style="margin-bottom: 5px;">• Approved Edits: ${stats.approvedEdits} × 5 = <span style="color: #28a745;">+${stats.approvedEdits * 5}</span></div>
                                <div style="margin-bottom: 10px;">• Rejected Edits: ${stats.rejectedEdits} × -2 = <span style="color: #dc3545;">${stats.rejectedEdits * -2}</span></div>
                                <hr style="margin: 10px 0;">
                                <div style="font-size: 16px; font-weight: bold;">
                                    Total Points: <span style="color: ${pointsColor};">${pointsSign}${stats.points}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #333;">Recent Activity</h3>
                    <div id="recentActivity">
                        <div class="loading-spinner" style="margin: 20px auto; display: block;"></div>
                    </div>
                </div>
            `;

            document.getElementById('profileContent').innerHTML = profileHTML;
            
            // Load recent activity
            loadUserRecentActivity();
        }

        // Load user's recent activity
        async function loadUserRecentActivity() {
            if (!currentUser) return;

            try {
                const activities = [];

                // Get recent articles
                const articlesSnapshot = await db.collection('articles')
                    .where('uid', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();

                articlesSnapshot.forEach(doc => {
                    const article = doc.data();
                    activities.push({
                        type: 'article',
                        title: article.title,
                        status: article.status,
                        timestamp: article.timestamp,
                        id: doc.id
                    });
                });

                // Get recent edits
                const editsSnapshot = await db.collection('edits')
                    .where('editorUid', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();

                editsSnapshot.forEach(doc => {
                    const edit = doc.data();
                    activities.push({
                        type: 'edit',
                        title: edit.title,
                        status: edit.status,
                        timestamp: edit.timestamp,
                        articleId: edit.articleId,
                        editSummary: edit.editSummary
                    });
                });

                // Sort by timestamp
                activities.sort((a, b) => {
                    const aTime = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const bTime = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return bTime - aTime;
                });

                // Display activities
                const activityContainer = document.getElementById('recentActivity');
                if (activities.length === 0) {
                    activityContainer.innerHTML = '<p style="color: #666; text-align: center;">No recent activity.</p>';
                    return;
                }

                const activityHTML = activities.slice(0, 10).map(activity => {
                    const timeAgo = getTimeAgo(activity.timestamp ? activity.timestamp.toDate() : new Date());
                    const statusColor = activity.status === 'approved' ? '#28a745' : 
                                       activity.status === 'rejected' ? '#dc3545' : '#ffc107';
                    const statusIcon = activity.status === 'approved' ? '✓' : 
                                      activity.status === 'rejected' ? '✗' : '⏳';

                    return `
                        <div style="background: #f8f9fa; border: 1px solid #a2a9b1; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; color: #333; margin-bottom: 5px;">
                                        <i class="fas fa-${activity.type === 'article' ? 'file-alt' : 'edit'}" style="margin-right: 8px; color: ${activity.type === 'article' ? '#007bff' : '#17a2b8'};"></i>
                                        ${activity.type === 'article' ? 'Created Article' : 'Edited Article'}: 
                                        <strong>${activity.title}</strong>
                                    </div>
                                    ${activity.editSummary ? `<div style="font-size: 14px; color: #666; margin-bottom: 5px;">Summary: ${activity.editSummary}</div>` : ''}
                                    <div style="font-size: 14px; color: #666;">
                                        ${timeAgo} • Status: <span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${activity.status.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div>
                                    ${activity.type === 'article' && activity.id ? 
                                        `<button onclick="openArticle('${activity.id}')" class="wiki-edit-btn" style="font-size: 12px; padding: 4px 8px;">View</button>` : 
                                        activity.articleId ? 
                                        `<button onclick="openArticle('${activity.articleId}')" class="wiki-edit-btn" style="font-size: 12px; padding: 4px 8px;">View</button>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                activityContainer.innerHTML = activityHTML;

            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = '<p style="color: #dc3545;">Error loading recent activity.</p>';
            }
        }

        // Initialize app
        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('load', () => {
            // Add demo articles
            addDemoArticles();
            
            // Load articles for internal linking
            loadArticlesForLinking();
            
            if (window.location.hash) {
                handleHashChange();
            } else {
                showHome();
            }
        });

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchArticles();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'965a59d8e6635524',t:'MTc1MzYwMDU4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
