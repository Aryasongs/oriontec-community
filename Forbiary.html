<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forbiary - Knowledge Sharing Platform</title>
    <meta name="description" content="Forbiary - A professional knowledge-sharing platform combining Wikipedia's structure with Forbes' elegance">
    <meta name="keywords" content="knowledge, articles, encyclopedia, wiki, forbiary">
    <link rel="canonical" href="https://forbiary.web.app">
    <meta property="og:title" content="Forbiary - Knowledge Sharing Platform">
    <meta property="og:description" content="A professional knowledge-sharing platform combining Wikipedia's structure with Forbes' elegance">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://forbiary.web.app">
    <meta property="og:image" content="https://forbiary.web.app/forbiary-logo.png">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Forbiary",
        "url": "https://forbiary.web.app",
        "description": "A professional knowledge-sharing platform combining Wikipedia's structure with Forbes' elegance",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://forbiary.web.app?search={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Merriweather', serif;
            background-color: #f8f9fa;
            color: #202122;
        }
        
        .serif-font {
            font-family: 'Merriweather', serif;
        }
        
        .article-content h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 0.25rem;
        }
        
        .article-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 0.25rem;
        }
        
        .article-content h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .article-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .article-content ul, .article-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .article-content ul {
            list-style-type: disc;
        }
        
        .article-content ol {
            list-style-type: decimal;
        }
        
        .article-content a {
            color: #0645ad;
            text-decoration: none;
        }
        
        .article-content a:hover {
            text-decoration: underline;
        }
        
        .article-content table {
            border-collapse: collapse;
            margin: 1rem 0;
            width: 100%;
        }
        
        .article-content table th, .article-content table td {
            border: 1px solid #a2a9b1;
            padding: 0.5rem;
        }
        
        .article-content table th {
            background-color: #eaecf0;
        }
        
        .article-content blockquote {
            border-left: 3px solid #c8ccd1;
            padding-left: 1rem;
            color: #54595d;
            font-style: italic;
            margin: 1rem 0;
        }
        
        .article-content code {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 0.1rem 0.3rem;
            border: 1px solid #eaecf0;
            border-radius: 2px;
        }
        
        .ql-editor {
            min-height: 300px;
            font-family: 'Merriweather', serif;
        }
        
        .sidebar {
            transition: transform 0.3s ease;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar.closed {
            transform: translateX(-100%);
        }
        
        @media (min-width: 768px) {
            .sidebar.closed {
                transform: translateX(0);
            }
        }
        
        .drawer {
            transition: transform 0.3s ease;
        }
        
        .drawer.open {
            transform: translateX(0);
        }
        
        .drawer.closed {
            transform: translateX(100%);
        }
        
        .edit-history-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .edit-history-panel.open {
            max-height: 500px;
        }
        
        .locked-banner {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        
        .flagged-banner {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .banned-banner {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .wiki-link {
            color: #0645ad;
            text-decoration: none;
            border-bottom: 1px dotted #0645ad;
        }
        
        .wiki-link:hover {
            text-decoration: underline;
        }
        
        .wiki-link-missing {
            color: #ba0000;
            text-decoration: none;
            border-bottom: 1px dotted #ba0000;
        }
        
        .wiki-link-missing:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="bg-white shadow-md fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="#" class="flex-shrink-0" id="logo-link">
                        <h1 class="text-2xl font-bold serif-font">Forbiary</h1>
                    </a>
                </div>
                <div class="flex-1 flex items-center justify-center px-2 lg:ml-6 lg:justify-center">
                    <div class="max-w-lg w-full">
                        <label for="search" class="sr-only">Search</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input id="search" name="search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Search articles" type="search">
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <button id="menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Drawer Menu -->
    <div id="drawer" class="drawer closed fixed right-0 top-0 w-64 h-full bg-white shadow-lg z-50 transform">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold serif-font">Menu</h2>
                <button id="close-drawer" class="text-gray-500 hover:text-gray-700">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <nav class="space-y-1">
                <a href="#" class="menu-item block px-3 py-2 rounded-md text-base font-medium text-gray-900 hover:bg-gray-100" data-page="main">Main Page</a>
                <a href="#" class="menu-item block px-3 py-2 rounded-md text-base font-medium text-gray-900 hover:bg-gray-100" data-page="browse">Browse Articles</a>
                <a href="#" class="menu-item block px-3 py-2 rounded-md text-base font-medium text-gray-900 hover:bg-gray-100" data-page="create">Create Article</a>
                <a href="#" class="menu-item block px-3 py-2 rounded-md text-base font-medium text-gray-900 hover:bg-gray-100" data-page="become-moderator">Become Moderator</a>
                <a href="#" class="menu-item block px-3 py-2 rounded-md text-base font-medium text-gray-900 hover:bg-gray-100" data-page="categories">Categories</a>
                <a href="#" id="auth-link" class="block px-3 py-2 rounded-md text-base font-medium text-gray-900 hover:bg-gray-100">Sign In</a>
            </nav>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="pt-16 flex min-h-screen">
        <!-- Sidebar (visible on desktop) -->
        <aside class="sidebar closed md:block hidden w-64 bg-white border-r border-gray-200 fixed h-full overflow-y-auto pt-4">
            <div class="px-4 py-2">
                <h2 class="text-lg font-bold mb-4 serif-font">Categories</h2>
                <ul class="space-y-1" id="categories-list">
                    <li><a href="#" class="block px-2 py-1 text-blue-700 hover:underline">Science</a></li>
                    <li><a href="#" class="block px-2 py-1 text-blue-700 hover:underline">Technology</a></li>
                    <li><a href="#" class="block px-2 py-1 text-blue-700 hover:underline">History</a></li>
                    <li><a href="#" class="block px-2 py-1 text-blue-700 hover:underline">Arts</a></li>
                    <li><a href="#" class="block px-2 py-1 text-blue-700 hover:underline">Philosophy</a></li>
                    <li><a href="#" class="block px-2 py-1 text-blue-700 hover:underline">Business</a></li>
                </ul>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 md:ml-64 bg-gray-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div id="content-area">
                    <!-- Content will be loaded here dynamically -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "auth.oriontec.xyz",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: ".",
            appId: "1:.:web:7248a0983dcf0d45a87418",
            measurementId: "G-5RFLRYTLCN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let currentArticleId = null;
        let editor = null;
        let isModerator = false;
        let bannedIPs = [];
        let sitemapData = [];
        let allArticleTitles = [];
        
        // DOM Elements
        const contentArea = document.getElementById('content-area');
        const menuButton = document.getElementById('menu-button');
        const drawer = document.getElementById('drawer');
        const closeDrawer = document.getElementById('close-drawer');
        const authLink = document.getElementById('auth-link');
        const logoLink = document.getElementById('logo-link');
        const menuItems = document.querySelectorAll('.menu-item');
        const searchInput = document.getElementById('search');
        
        // Event Listeners
        menuButton.addEventListener('click', () => {
            drawer.classList.remove('closed');
            drawer.classList.add('open');
        });
        
        closeDrawer.addEventListener('click', () => {
            drawer.classList.remove('open');
            drawer.classList.add('closed');
        });
        
        logoLink.addEventListener('click', (e) => {
            e.preventDefault();
            loadMainPage();
        });
        
        menuItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.target.getAttribute('data-page');
                
                // Close drawer on mobile
                drawer.classList.remove('open');
                drawer.classList.add('closed');
                
                switch(page) {
                    case 'main':
                        loadMainPage();
                        break;
                    case 'browse':
                        loadBrowsePage();
                        break;
                    case 'create':
                        if (currentUser) {
                            loadCreateArticlePage();
                        } else {
                            showLoginPrompt('create an article');
                        }
                        break;
                    case 'become-moderator':
                        loadBecomeModerator();
                        break;
                    case 'categories':
                        loadCategoriesPage();
                        break;
                }
            });
        });
        
        // Search functionality
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    loadSearchResults(searchTerm);
                }
            }
        });
        
        // Authentication
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            
            if (user) {
                authLink.textContent = 'Sign Out';
                
                // Check if user is a moderator
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().isModerator) {
                        isModerator = true;
                    } else {
                        isModerator = false;
                    }
                });
                
                // Create user document if it doesn't exist
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (!doc.exists) {
                        db.collection('users').doc(user.uid).set({
                            displayName: user.displayName || 'Anonymous',
                            email: user.email,
                            photoURL: user.photoURL || '',
                            isModerator: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            } else {
                authLink.textContent = 'Sign In';
                isModerator = false;
            }
        });
        
        authLink.addEventListener('click', (e) => {
            e.preventDefault();
            
            if (currentUser) {
                // Sign out
                auth.signOut().then(() => {
                    console.log('Signed out');
                    loadMainPage();
                }).catch((error) => {
                    console.error('Sign out error:', error);
                });
            } else {
                // Sign in with Google
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).then((result) => {
                    console.log('Signed in:', result.user);
                    loadMainPage();
                }).catch((error) => {
                    console.error('Sign in error:', error);
                });
            }
        });
        
        // SEO Functions
        function updateMetadata(article) {
            // Update page title
            document.title = `${article.title} - Forbiary`;
            
            // Update meta description
            let metaDescription = document.querySelector('meta[name="description"]');
            if (!metaDescription) {
                metaDescription = document.createElement('meta');
                metaDescription.setAttribute('name', 'description');
                document.head.appendChild(metaDescription);
            }
            metaDescription.setAttribute('content', article.summary);
            
            // Update meta keywords
            let metaKeywords = document.querySelector('meta[name="keywords"]');
            if (!metaKeywords) {
                metaKeywords = document.createElement('meta');
                metaKeywords.setAttribute('name', 'keywords');
                document.head.appendChild(metaKeywords);
            }
            metaKeywords.setAttribute('content', article.tags.join(', '));
            
            // Update canonical URL
            let canonicalLink = document.querySelector('link[rel="canonical"]');
            if (!canonicalLink) {
                canonicalLink = document.createElement('link');
                canonicalLink.setAttribute('rel', 'canonical');
                document.head.appendChild(canonicalLink);
            }
            canonicalLink.setAttribute('href', `https://forbiary.web.app#article/${article.id}`);
            
            // Update Open Graph tags
            updateOpenGraphTags(article);
            
            // Update JSON-LD structured data
            updateStructuredData(article);
        }
        
        function updateOpenGraphTags(article) {
            // og:title
            let ogTitle = document.querySelector('meta[property="og:title"]');
            if (!ogTitle) {
                ogTitle = document.createElement('meta');
                ogTitle.setAttribute('property', 'og:title');
                document.head.appendChild(ogTitle);
            }
            ogTitle.setAttribute('content', article.title);
            
            // og:description
            let ogDescription = document.querySelector('meta[property="og:description"]');
            if (!ogDescription) {
                ogDescription = document.createElement('meta');
                ogDescription.setAttribute('property', 'og:description');
                document.head.appendChild(ogDescription);
            }
            ogDescription.setAttribute('content', article.summary);
            
            // og:type
            let ogType = document.querySelector('meta[property="og:type"]');
            if (!ogType) {
                ogType = document.createElement('meta');
                ogType.setAttribute('property', 'og:type');
                document.head.appendChild(ogType);
            }
            ogType.setAttribute('content', 'article');
            
            // og:url
            let ogUrl = document.querySelector('meta[property="og:url"]');
            if (!ogUrl) {
                ogUrl = document.createElement('meta');
                ogUrl.setAttribute('property', 'og:url');
                document.head.appendChild(ogUrl);
            }
            ogUrl.setAttribute('content', `https://forbiary.web.app#article/${article.id}`);
            
            // og:image (placeholder for now)
            let ogImage = document.querySelector('meta[property="og:image"]');
            if (!ogImage) {
                ogImage = document.createElement('meta');
                ogImage.setAttribute('property', 'og:image');
                document.head.appendChild(ogImage);
            }
            ogImage.setAttribute('content', 'https://forbiary.web.app/forbiary-logo.png');
        }
        
        function updateStructuredData(article) {
            let scriptElement = document.querySelector('script[type="application/ld+json"]');
            if (!scriptElement) {
                scriptElement = document.createElement('script');
                scriptElement.setAttribute('type', 'application/ld+json');
                document.head.appendChild(scriptElement);
            }
            
            const structuredData = {
                "@context": "https://schema.org",
                "@type": "Article",
                "headline": article.title,
                "description": article.summary,
                "author": {
                    "@type": "Person",
                    "name": article.authorName
                },
                "publisher": {
                    "@type": "Organization",
                    "name": "Forbiary",
                    "logo": {
                        "@type": "ImageObject",
                        "url": "https://forbiary.web.app/forbiary-logo.png"
                    }
                },
                "datePublished": article.createdAt ? new Date(article.createdAt.toDate()).toISOString() : new Date().toISOString(),
                "dateModified": article.updatedAt ? new Date(article.updatedAt.toDate()).toISOString() : new Date().toISOString(),
                "mainEntityOfPage": {
                    "@type": "WebPage",
                    "@id": `https://forbiary.web.app#article/${article.id}`
                },
                "keywords": article.tags.join(', ')
            };
            
            scriptElement.textContent = JSON.stringify(structuredData);
        }
        
        function updateSitemap() {
            db.collection('articles')
                .where('status', '==', 'approved')
                .get()
                .then((querySnapshot) => {
                    sitemapData = [];
                    
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        sitemapData.push({
                            id: doc.id,
                            title: article.title,
                            lastmod: article.updatedAt ? new Date(article.updatedAt.toDate()).toISOString() : new Date().toISOString()
                        });
                    });
                    
                    // In a real implementation, this would generate and upload a sitemap.xml file
                    console.log('Sitemap updated with', sitemapData.length, 'articles');
                })
                .catch((error) => {
                    console.error('Error updating sitemap:', error);
                });
        }
        
        // Load all article titles for internal linking
        function loadAllArticleTitles() {
            db.collection('articles')
                .where('status', '==', 'approved')
                .get()
                .then((querySnapshot) => {
                    allArticleTitles = [];
                    
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        allArticleTitles.push({
                            id: doc.id,
                            title: article.title
                        });
                    });
                    
                    console.log('Loaded', allArticleTitles.length, 'article titles for internal linking');
                })
                .catch((error) => {
                    console.error('Error loading article titles:', error);
                });
        }
        
        // Process internal links in content
        function processInternalLinks(content) {
            // Match [[Article Title]] pattern
            const wikiLinkRegex = /\[\[(.*?)\]\]/g;
            
            return content.replace(wikiLinkRegex, (match, articleTitle) => {
                // Find article with matching title
                const article = allArticleTitles.find(a => a.title.toLowerCase() === articleTitle.toLowerCase());
                
                if (article) {
                    // Article exists, create link
                    return `<a href="#article/${article.id}" class="wiki-link">${articleTitle}</a>`;
                } else {
                    // Article doesn't exist, create red link
                    return `<a href="#create?title=${encodeURIComponent(articleTitle)}" class="wiki-link-missing">${articleTitle}</a>`;
                }
            });
        }
        
        // IP Banning System
        function checkIfBanned() {
            const bannedIPs = JSON.parse(localStorage.getItem('bannedIPs') || '[]');
            const currentIP = 'user-' + (currentUser ? currentUser.uid : 'anonymous'); // Simulating IP with user ID
            
            const banned = bannedIPs.find(ban => ban.ip === currentIP && new Date(ban.until) > new Date());
            
            if (banned) {
                return {
                    isBanned: true,
                    until: new Date(banned.until)
                };
            }
            
            return { isBanned: false };
        }
        
        function banUser(reason) {
            const currentIP = 'user-' + (currentUser ? currentUser.uid : 'anonymous'); // Simulating IP with user ID
            const banUntil = new Date();
            banUntil.setMonth(banUntil.getMonth() + 5); // 5 month ban
            
            const bannedIPs = JSON.parse(localStorage.getItem('bannedIPs') || '[]');
            bannedIPs.push({
                ip: currentIP,
                reason: reason,
                until: banUntil.toISOString()
            });
            
            localStorage.setItem('bannedIPs', JSON.stringify(bannedIPs));
            
            return {
                isBanned: true,
                until: banUntil
            };
        }
        
        // Page Loading Functions
        function loadMainPage() {
            // Reset metadata to default
            document.title = 'Forbiary - Knowledge Sharing Platform';
            
            // Check if user is banned
            const banStatus = checkIfBanned();
            let bannerHTML = '';
            
            if (banStatus.isBanned) {
                bannerHTML = `
                    <div class="banned-banner mb-6">
                        <p class="font-bold">Your account has been temporarily banned</p>
                        <p>You are banned from submitting content until ${new Date(banStatus.until).toLocaleDateString()}.</p>
                    </div>
                `;
            }
            
            contentArea.innerHTML = `
                ${bannerHTML}
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-4 serif-font">Welcome to Forbiary</h1>
                    <p class="text-lg mb-4">The professional knowledge-sharing platform that combines Wikipedia's structure with Forbes' elegance.</p>
                    <div class="flex flex-wrap gap-4">
                        <button id="browse-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                            Browse Articles
                        </button>
                        <button id="create-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded">
                            Create Article
                        </button>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 serif-font">Featured Articles</h2>
                    <div id="featured-articles" class="grid md:grid-cols-2 gap-6">
                        <p class="text-gray-500">Loading featured articles...</p>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 serif-font">Recent Updates</h2>
                    <div id="recent-updates" class="space-y-4">
                        <p class="text-gray-500">Loading recent updates...</p>
                    </div>
                </div>
            `;
            
            document.getElementById('browse-btn').addEventListener('click', loadBrowsePage);
            document.getElementById('create-btn').addEventListener('click', () => {
                if (banStatus.isBanned) {
                    alert('You are currently banned from submitting content.');
                    return;
                }
                
                if (currentUser) {
                    loadCreateArticlePage();
                } else {
                    showLoginPrompt('create an article');
                }
            });
            
            // Load featured articles
            db.collection('articles')
                .where('status', '==', 'approved')
                .where('featured', '==', true)
                .limit(4)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        document.getElementById('featured-articles').innerHTML = `
                            <p class="text-gray-500">No featured articles yet.</p>
                        `;
                        return;
                    }
                    
                    let articlesHTML = '';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        article.id = doc.id; // Add ID to article object
                        
                        articlesHTML += `
                            <div class="border rounded-lg overflow-hidden">
                                <div class="p-4">
                                    <h3 class="text-xl font-bold mb-2 serif-font">
                                        <a href="#article/${doc.id}" class="text-blue-700 hover:underline">${article.title}</a>
                                    </h3>
                                    <p class="text-gray-600 mb-2">${article.summary}</p>
                                    <div class="flex items-center text-sm text-gray-500">
                                        <span>By ${article.authorName}</span>
                                        <span class="mx-2">•</span>
                                        <span>${new Date(article.createdAt.toDate()).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('featured-articles').innerHTML = articlesHTML;
                    
                    // Add event listeners to article links
                    document.querySelectorAll('#featured-articles a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const articleId = e.target.getAttribute('href').split('/')[1];
                            loadArticlePage(articleId);
                        });
                    });
                })
                .catch((error) => {
                    console.error('Error getting featured articles:', error);
                    document.getElementById('featured-articles').innerHTML = `
                        <p class="text-red-500">Error loading featured articles.</p>
                    `;
                });
            
            // Load recent updates with real-time listener
            const recentUpdatesListener = db.collection('articles')
                .where('status', '==', 'approved')
                .orderBy('updatedAt', 'desc')
                .limit(5)
                .onSnapshot((querySnapshot) => {
                    if (querySnapshot.empty) {
                        document.getElementById('recent-updates').innerHTML = `
                            <p class="text-gray-500">No recent updates.</p>
                        `;
                        return;
                    }
                    
                    let updatesHTML = '';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        article.id = doc.id; // Add ID to article object
                        
                        updatesHTML += `
                            <div class="border-b pb-4">
                                <h3 class="text-lg font-bold mb-1 serif-font">
                                    <a href="#article/${doc.id}" class="text-blue-700 hover:underline">${article.title}</a>
                                </h3>
                                <div class="flex items-center text-sm text-gray-500">
                                    <span>Updated ${new Date(article.updatedAt.toDate()).toLocaleDateString()}</span>
                                    <span class="mx-2">•</span>
                                    <span>${article.category}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('recent-updates').innerHTML = updatesHTML;
                    
                    // Add event listeners to article links
                    document.querySelectorAll('#recent-updates a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const articleId = e.target.getAttribute('href').split('/')[1];
                            loadArticlePage(articleId);
                        });
                    });
                }, (error) => {
                    console.error('Error getting recent updates:', error);
                    document.getElementById('recent-updates').innerHTML = `
                        <p class="text-red-500">Error loading recent updates.</p>
                    `;
                });
                
            // Load all article titles for internal linking
            loadAllArticleTitles();
            
            // Update sitemap
            updateSitemap();
            
            // Clean up listener when navigating away
            window.addEventListener('hashchange', () => {
                recentUpdatesListener();
            }, { once: true });
        }
        
        function loadBrowsePage() {
            // Reset metadata to default
            document.title = 'Browse Articles - Forbiary';
            
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-4 serif-font">Browse Articles</h1>
                    
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button class="category-filter px-3 py-1 rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200" data-category="all">All</button>
                            <button class="category-filter px-3 py-1 rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" data-category="Science">Science</button>
                            <button class="category-filter px-3 py-1 rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" data-category="Technology">Technology</button>
                            <button class="category-filter px-3 py-1 rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" data-category="History">History</button>
                            <button class="category-filter px-3 py-1 rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" data-category="Arts">Arts</button>
                            <button class="category-filter px-3 py-1 rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" data-category="Philosophy">Philosophy</button>
                            <button class="category-filter px-3 py-1 rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" data-category="Business">Business</button>
                        </div>
                    </div>
                    
                    <div id="articles-list" class="space-y-6">
                        <p class="text-gray-500">Loading articles...</p>
                    </div>
                </div>
            `;
            
            // Add event listeners to category filters
            document.querySelectorAll('.category-filter').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Update active state
                    document.querySelectorAll('.category-filter').forEach(btn => {
                        btn.classList.remove('bg-blue-100', 'text-blue-800');
                        btn.classList.add('bg-gray-100', 'text-gray-800');
                    });
                    e.target.classList.remove('bg-gray-100', 'text-gray-800');
                    e.target.classList.add('bg-blue-100', 'text-blue-800');
                    
                    // Filter articles
                    const category = e.target.getAttribute('data-category');
                    loadArticlesList(category);
                });
            });
            
            // Load all articles by default
            loadArticlesList('all');
        }
        
        function loadArticlesList(category) {
            const articlesList = document.getElementById('articles-list');
            articlesList.innerHTML = `<p class="text-gray-500">Loading articles...</p>`;
            
            let query = db.collection('articles').where('status', '==', 'approved');
            
            if (category !== 'all') {
                query = query.where('category', '==', category);
            }
            
            query.orderBy('updatedAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        articlesList.innerHTML = `
                            <p class="text-gray-500">No articles found in this category.</p>
                        `;
                        return;
                    }
                    
                    let articlesHTML = '';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        article.id = doc.id; // Add ID to article object
                        
                        articlesHTML += `
                            <div class="border-b pb-6">
                                <h2 class="text-2xl font-bold mb-2 serif-font">
                                    <a href="#article/${doc.id}" class="text-blue-700 hover:underline">${article.title}</a>
                                </h2>
                                <p class="text-gray-600 mb-3">${article.summary}</p>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded">${article.category}</span>
                                    ${article.tags.map(tag => `<span class="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded">${tag}</span>`).join('')}
                                </div>
                                <div class="flex items-center text-sm text-gray-500">
                                    <span>By ${article.authorName}</span>
                                    <span class="mx-2">•</span>
                                    <span>Updated ${new Date(article.updatedAt.toDate()).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    articlesList.innerHTML = articlesHTML;
                    
                    // Add event listeners to article links
                    document.querySelectorAll('#articles-list a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const articleId = e.target.getAttribute('href').split('/')[1];
                            loadArticlePage(articleId);
                        });
                    });
                })
                .catch((error) => {
                    console.error('Error getting articles:', error);
                    articlesList.innerHTML = `
                        <p class="text-red-500">Error loading articles.</p>
                    `;
                });
        }
        
        function loadSearchResults(searchTerm) {
            // Update page title
            document.title = `Search: ${searchTerm} - Forbiary`;
            
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-4 serif-font">Search Results: "${searchTerm}"</h1>
                    <div id="search-results" class="space-y-6">
                        <p class="text-gray-500">Searching...</p>
                    </div>
                </div>
            `;
            
            // Perform search (simple implementation - in a real app, use Firestore queries or Algolia)
            db.collection('articles')
                .where('status', '==', 'approved')
                .get()
                .then((querySnapshot) => {
                    const searchResults = [];
                    const searchTermLower = searchTerm.toLowerCase();
                    
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        article.id = doc.id;
                        
                        // Check if search term is in title, summary, or content
                        if (
                            article.title.toLowerCase().includes(searchTermLower) ||
                            article.summary.toLowerCase().includes(searchTermLower) ||
                            article.content.toLowerCase().includes(searchTermLower) ||
                            article.tags.some(tag => tag.toLowerCase().includes(searchTermLower))
                        ) {
                            searchResults.push(article);
                        }
                    });
                    
                    if (searchResults.length === 0) {
                        document.getElementById('search-results').innerHTML = `
                            <p class="text-gray-500">No results found for "${searchTerm}".</p>
                        `;
                        return;
                    }
                    
                    let resultsHTML = '';
                    searchResults.forEach((article) => {
                        resultsHTML += `
                            <div class="border-b pb-6">
                                <h2 class="text-2xl font-bold mb-2 serif-font">
                                    <a href="#article/${article.id}" class="text-blue-700 hover:underline">${article.title}</a>
                                </h2>
                                <p class="text-gray-600 mb-3">${article.summary}</p>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded">${article.category}</span>
                                    ${article.tags.map(tag => `<span class="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded">${tag}</span>`).join('')}
                                </div>
                                <div class="flex items-center text-sm text-gray-500">
                                    <span>By ${article.authorName}</span>
                                    <span class="mx-2">•</span>
                                    <span>Updated ${new Date(article.updatedAt.toDate()).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('search-results').innerHTML = resultsHTML;
                    
                    // Add event listeners to article links
                    document.querySelectorAll('#search-results a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const articleId = e.target.getAttribute('href').split('/')[1];
                            loadArticlePage(articleId);
                        });
                    });
                })
                .catch((error) => {
                    console.error('Error searching articles:', error);
                    document.getElementById('search-results').innerHTML = `
                        <p class="text-red-500">Error searching articles.</p>
                    `;
                });
        }
        
        function loadArticlePage(articleId) {
            currentArticleId = articleId;
            
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <p class="text-gray-500">Loading article...</p>
                </div>
            `;
            
            // Set up real-time listener for article
            const articleListener = db.collection('articles').doc(articleId).onSnapshot((doc) => {
                if (!doc.exists) {
                    contentArea.innerHTML = `
                        <div class="bg-white shadow rounded-lg p-6 mb-6">
                            <h1 class="text-3xl font-bold mb-4 serif-font">Article Not Found</h1>
                            <p>The article you're looking for doesn't exist or has been removed.</p>
                            <button id="back-to-browse" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                Back to Browse
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('back-to-browse').addEventListener('click', loadBrowsePage);
                    return;
                }
                
                const article = doc.data();
                article.id = doc.id; // Add ID to article object
                
                // Update page metadata for SEO
                updateMetadata(article);
                
                // Process internal links in content
                const processedContent = processInternalLinks(article.content);
                
                let statusBanner = '';
                if (article.isLocked) {
                    statusBanner = `
                        <div class="locked-banner p-4 mb-6">
                            <p class="font-bold">This article is locked</p>
                            <p>This article has been locked by a moderator and cannot be edited at this time.</p>
                        </div>
                    `;
                } else if (article.isFlagged) {
                    statusBanner = `
                        <div class="flagged-banner p-4 mb-6">
                            <p class="font-bold">This article has been flagged</p>
                            <p>This article has been flagged for review by a moderator.</p>
                        </div>
                    `;
                }
                
                // Check if user is banned
                const banStatus = checkIfBanned();
                if (banStatus.isBanned) {
                    statusBanner += `
                        <div class="banned-banner mb-6">
                            <p class="font-bold">Your account has been temporarily banned</p>
                            <p>You are banned from submitting content until ${new Date(banStatus.until).toLocaleDateString()}.</p>
                        </div>
                    `;
                }
                
                contentArea.innerHTML = `
                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        ${statusBanner}
                        
                        <h1 class="text-3xl font-bold mb-2 serif-font">${article.title}</h1>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded">${article.category}</span>
                            ${article.tags.map(tag => `<span class="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded">${tag}</span>`).join('')}
                        </div>
                        
                        <div class="flex items-center mb-6 text-sm text-gray-500">
                            <span>By ${article.authorName}</span>
                            <span class="mx-2">•</span>
                            <span>Created ${new Date(article.createdAt.toDate()).toLocaleDateString()}</span>
                            <span class="mx-2">•</span>
                            <span>Updated ${new Date(article.updatedAt.toDate()).toLocaleDateString()}</span>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-lg font-semibold italic">${article.summary}</p>
                        </div>
                        
                        <div class="article-content prose max-w-none mb-8">
                            ${processedContent}
                        </div>
                        
                        <div class="border-t pt-4 flex flex-wrap gap-4">
                            <button id="edit-article" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded ${(article.isLocked || banStatus.isBanned) ? 'opacity-50 cursor-not-allowed' : ''}">
                                Edit Article
                            </button>
                            <button id="view-history" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded">
                                View Edit History
                            </button>
                            ${isModerator ? `
                                <button id="toggle-lock" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded">
                                    ${article.isLocked ? 'Unlock Article' : 'Lock Article'}
                                </button>
                                <button id="toggle-flag" class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded">
                                    ${article.isFlagged ? 'Remove Flag' : 'Flag Article'}
                                </button>
                                <button id="toggle-featured" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded">
                                    ${article.featured ? 'Remove from Featured' : 'Mark as Featured'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div id="edit-history-panel" class="edit-history-panel bg-white shadow rounded-lg overflow-hidden mb-6">
                        <div class="p-6">
                            <h2 class="text-2xl font-bold mb-4 serif-font">Edit History</h2>
                            <div id="edit-history-content" class="space-y-4">
                                <p class="text-gray-500">Loading edit history...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4 serif-font">Related Articles</h2>
                        <div id="related-articles" class="grid md:grid-cols-2 gap-4">
                            <p class="text-gray-500">Loading related articles...</p>
                        </div>
                    </div>
                `;
                
                // Edit Article Button
                const editArticleBtn = document.getElementById('edit-article');
                editArticleBtn.addEventListener('click', () => {
                    if (article.isLocked) {
                        alert('This article is locked and cannot be edited at this time.');
                        return;
                    }
                    
                    if (banStatus.isBanned) {
                        alert('You are currently banned from submitting content.');
                        return;
                    }
                    
                    if (currentUser) {
                        loadEditArticlePage(articleId);
                    } else {
                        showLoginPrompt('edit this article');
                    }
                });
                
                // View History Button
                const viewHistoryBtn = document.getElementById('view-history');
                const editHistoryPanel = document.getElementById('edit-history-panel');
                
                viewHistoryBtn.addEventListener('click', () => {
                    if (editHistoryPanel.classList.contains('open')) {
                        editHistoryPanel.classList.remove('open');
                    } else {
                        editHistoryPanel.classList.add('open');
                        loadEditHistory(articleId);
                    }
                });
                
                // Moderator Controls
                if (isModerator) {
                    // Toggle Lock Button
                    const toggleLockBtn = document.getElementById('toggle-lock');
                    toggleLockBtn.addEventListener('click', () => {
                        const newLockStatus = !article.isLocked;
                        
                        db.collection('articles').doc(articleId).update({
                            isLocked: newLockStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            // Add to edit history
                            db.collection('articles').doc(articleId).collection('history').add({
                                action: newLockStatus ? 'locked' : 'unlocked',
                                userId: currentUser.uid,
                                userName: currentUser.displayName || 'Anonymous',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }).catch((error) => {
                            console.error('Error updating article lock status:', error);
                            alert('Error updating article lock status.');
                        });
                    });
                    
                    // Toggle Flag Button
                    const toggleFlagBtn = document.getElementById('toggle-flag');
                    toggleFlagBtn.addEventListener('click', () => {
                        const newFlagStatus = !article.isFlagged;
                        
                        db.collection('articles').doc(articleId).update({
                            isFlagged: newFlagStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            // Add to edit history
                            db.collection('articles').doc(articleId).collection('history').add({
                                action: newFlagStatus ? 'flagged' : 'unflagged',
                                userId: currentUser.uid,
                                userName: currentUser.displayName || 'Anonymous',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }).catch((error) => {
                            console.error('Error updating article flag status:', error);
                            alert('Error updating article flag status.');
                        });
                    });
                    
                    // Toggle Featured Button
                    const toggleFeaturedBtn = document.getElementById('toggle-featured');
                    toggleFeaturedBtn.addEventListener('click', () => {
                        const newFeaturedStatus = !article.featured;
                        
                        db.collection('articles').doc(articleId).update({
                            featured: newFeaturedStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            // Add to edit history
                            db.collection('articles').doc(articleId).collection('history').add({
                                action: newFeaturedStatus ? 'featured' : 'unfeatured',
                                userId: currentUser.uid,
                                userName: currentUser.displayName || 'Anonymous',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Update sitemap
                            updateSitemap();
                        }).catch((error) => {
                            console.error('Error updating article featured status:', error);
                            alert('Error updating article featured status.');
                        });
                    });
                }
                
                // Load related articles
                loadRelatedArticles(article);
                
            }, (error) => {
                console.error('Error getting article:', error);
                contentArea.innerHTML = `
                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <h1 class="text-3xl font-bold mb-4 serif-font">Error</h1>
                        <p>There was an error loading the article.</p>
                        <button id="back-to-browse" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                            Back to Browse
                        </button>
                    </div>
                `;
                
                document.getElementById('back-to-browse').addEventListener('click', loadBrowsePage);
            });
            
            // Clean up listener when navigating away
            window.addEventListener('hashchange', () => {
                articleListener();
            }, { once: true });
        }
        
        function loadRelatedArticles(article) {
            const relatedArticlesContainer = document.getElementById('related-articles');
            
            // Find articles with matching tags or category
            db.collection('articles')
                .where('status', '==', 'approved')
                .where('id', '!=', article.id)
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    const allArticles = [];
                    querySnapshot.forEach((doc) => {
                        const relatedArticle = doc.data();
                        relatedArticle.id = doc.id;
                        allArticles.push(relatedArticle);
                    });
                    
                    // Score articles by relevance (shared tags and category)
                    const scoredArticles = allArticles.map(relatedArticle => {
                        let score = 0;
                        
                        // Same category
                        if (relatedArticle.category === article.category) {
                            score += 5;
                        }
                        
                        // Shared tags
                        const sharedTags = relatedArticle.tags.filter(tag => article.tags.includes(tag));
                        score += sharedTags.length * 3;
                        
                        return {
                            article: relatedArticle,
                            score: score
                        };
                    });
                    
                    // Sort by score and take top 4
                    const topRelated = scoredArticles
                        .filter(item => item.score > 0)
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 4);
                    
                    if (topRelated.length === 0) {
                        relatedArticlesContainer.innerHTML = `
                            <p class="text-gray-500">No related articles found.</p>
                        `;
                        return;
                    }
                    
                    let relatedHTML = '';
                    topRelated.forEach(item => {
                        const relatedArticle = item.article;
                        relatedHTML += `
                            <div class="border rounded-lg overflow-hidden">
                                <div class="p-4">
                                    <h3 class="text-lg font-bold mb-1 serif-font">
                                        <a href="#article/${relatedArticle.id}" class="text-blue-700 hover:underline">${relatedArticle.title}</a>
                                    </h3>
                                    <p class="text-gray-600 text-sm mb-2">${relatedArticle.summary.substring(0, 100)}${relatedArticle.summary.length > 100 ? '...' : ''}</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${relatedArticle.tags.slice(0, 3).map(tag => `<span class="px-2 py-0.5 bg-gray-100 text-gray-800 text-xs rounded">${tag}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    relatedArticlesContainer.innerHTML = relatedHTML;
                    
                    // Add event listeners to article links
                    document.querySelectorAll('#related-articles a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const articleId = e.target.getAttribute('href').split('/')[1];
                            loadArticlePage(articleId);
                        });
                    });
                })
                .catch((error) => {
                    console.error('Error getting related articles:', error);
                    relatedArticlesContainer.innerHTML = `
                        <p class="text-red-500">Error loading related articles.</p>
                    `;
                });
        }
        
        function loadEditHistory(articleId) {
            const editHistoryContent = document.getElementById('edit-history-content');
            
            db.collection('articles').doc(articleId).collection('history')
                .orderBy('timestamp', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        editHistoryContent.innerHTML = `
                            <p class="text-gray-500">No edit history available.</p>
                        `;
                        return;
                    }
                    
                    let historyHTML = '';
                    querySnapshot.forEach((doc) => {
                        const historyItem = doc.data();
                        const timestamp = historyItem.timestamp ? new Date(historyItem.timestamp.toDate()) : new Date();
                        
                        historyHTML += `
                            <div class="border-b pb-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-medium">${historyItem.userName}</span>
                                        <span class="text-gray-600">${getActionDescription(historyItem.action)}</span>
                                    </div>
                                    <span class="text-sm text-gray-500">${timestamp.toLocaleString()}</span>
                                </div>
                                ${historyItem.comment ? `<p class="mt-1 text-gray-600">"${historyItem.comment}"</p>` : ''}
                            </div>
                        `;
                    });
                    
                    editHistoryContent.innerHTML = historyHTML;
                })
                .catch((error) => {
                    console.error('Error getting edit history:', error);
                    editHistoryContent.innerHTML = `
                        <p class="text-red-500">Error loading edit history.</p>
                    `;
                });
        }
        
        function getActionDescription(action) {
            switch(action) {
                case 'created':
                    return ' created this article';
                case 'edited':
                    return ' edited this article';
                case 'locked':
                    return ' locked this article';
                case 'unlocked':
                    return ' unlocked this article';
                case 'flagged':
                    return ' flagged this article';
                case 'unflagged':
                    return ' removed the flag from this article';
                case 'approved':
                    return ' approved this article';
                case 'rejected':
                    return ' rejected this article';
                case 'featured':
                    return ' marked this article as featured';
                case 'unfeatured':
                    return ' removed this article from featured';
                default:
                    return ` ${action} this article`;
            }
        }
        
        function loadCreateArticlePage() {
            // Check if user is banned
            const banStatus = checkIfBanned();
            if (banStatus.isBanned) {
                contentArea.innerHTML = `
                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <div class="banned-banner mb-6">
                            <p class="font-bold">Your account has been temporarily banned</p>
                            <p>You are banned from submitting content until ${new Date(banStatus.until).toLocaleDateString()}.</p>
                        </div>
                        
                        <h1 class="text-3xl font-bold mb-4 serif-font">Create Article</h1>
                        <p>You cannot create articles while your account is banned.</p>
                        <button id="back-to-main" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                            Back to Main Page
                        </button>
                    </div>
                `;
                
                document.getElementById('back-to-main').addEventListener('click', loadMainPage);
                return;
            }
            
            if (!currentUser) {
                showLoginPrompt('create an article');
                return;
            }
            
            // Check URL parameters for pre-filled title
            const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
            const prefillTitle = urlParams.get('title') || '';
            
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-6 serif-font">Create New Article</h1>
                    
                    <form id="create-article-form">
                        <div class="mb-4">
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="title" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="${prefillTitle}" required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="summary" class="block text-sm font-medium text-gray-700 mb-1">Summary</label>
                            <textarea id="summary" name="summary" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="category" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select a category</option>
                                    <option value="Science">Science</option>
                                    <option value="Technology">Technology</option>
                                    <option value="History">History</option>
                                    <option value="Arts">Arts</option>
                                    <option value="Philosophy">Philosophy</option>
                                    <option value="Business">Business</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
                                <input type="text" id="tags" name="tags" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. physics, quantum, theory">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="editor" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                            <p class="text-sm text-gray-500 mb-2">Use [[Article Title]] to link to other articles.</p>
                            <div id="editor" class="border border-gray-300 rounded-md"></div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-create" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Submit Article
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Initialize Quill editor
            editor = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'Write your article content here...'
            });
            
            // Cancel button
            document.getElementById('cancel-create').addEventListener('click', loadMainPage);
            
            // Form submission
            document.getElementById('create-article-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const title = document.getElementById('title').value;
                const summary = document.getElementById('summary').value;
                const category = document.getElementById('category').value;
                const tagsInput = document.getElementById('tags').value;
                const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
                const content = editor.root.innerHTML;
                
                // Validate form
                if (!title || !summary || !category || !content) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                // Create article
                const articleData = {
                    title,
                    summary,
                    category,
                    tags,
                    content,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || 'Anonymous',
                    authorPhoto: currentUser.photoURL || '',
                    status: isModerator ? 'approved' : 'pending',
                    isLocked: false,
                    isFlagged: false,
                    featured: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                db.collection('articles').add(articleData)
                    .then((docRef) => {
                        // Add to edit history
                        db.collection('articles').doc(docRef.id).collection('history').add({
                            action: 'created',
                            userId: currentUser.uid,
                            userName: currentUser.displayName || 'Anonymous',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Update article titles for internal linking
                        allArticleTitles.push({
                            id: docRef.id,
                            title: title
                        });
                        
                        // Update sitemap
                        updateSitemap();
                        
                        alert('Article submitted successfully!');
                        loadArticlePage(docRef.id);
                    })
                    .catch((error) => {
                        console.error('Error adding article:', error);
                        alert('Error submitting article. Please try again.');
                    });
            });
        }
        
        function loadEditArticlePage(articleId) {
            // Check if user is banned
            const banStatus = checkIfBanned();
            if (banStatus.isBanned) {
                alert('You are currently banned from submitting content.');
                return;
            }
            
            if (!currentUser) {
                showLoginPrompt('edit this article');
                return;
            }
            
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-6 serif-font">Edit Article</h1>
                    <p class="text-gray-500">Loading article...</p>
                </div>
            `;
            
            db.collection('articles').doc(articleId).get()
                .then((doc) => {
                    if (!doc.exists) {
                        contentArea.innerHTML = `
                            <div class="bg-white shadow rounded-lg p-6 mb-6">
                                <h1 class="text-3xl font-bold mb-4 serif-font">Article Not Found</h1>
                                <p>The article you're trying to edit doesn't exist or has been removed.</p>
                                <button id="back-to-browse" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                    Back to Browse
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('back-to-browse').addEventListener('click', loadBrowsePage);
                        return;
                    }
                    
                    const article = doc.data();
                    
                    if (article.isLocked && !isModerator) {
                        contentArea.innerHTML = `
                            <div class="bg-white shadow rounded-lg p-6 mb-6">
                                <div class="locked-banner p-4 mb-6">
                                    <p class="font-bold">This article is locked</p>
                                    <p>This article has been locked by a moderator and cannot be edited at this time.</p>
                                </div>
                                
                                <h1 class="text-3xl font-bold mb-4 serif-font">${article.title}</h1>
                                <p>You cannot edit this article because it has been locked.</p>
                                <button id="back-to-article" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                    Back to Article
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('back-to-article').addEventListener('click', () => loadArticlePage(articleId));
                        return;
                    }
                    
                    contentArea.innerHTML = `
                        <div class="bg-white shadow rounded-lg p-6 mb-6">
                            <h1 class="text-3xl font-bold mb-6 serif-font">Edit Article</h1>
                            
                            <form id="edit-article-form">
                                <div class="mb-4">
                                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                    <input type="text" id="title" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="${article.title}" required>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="summary" class="block text-sm font-medium text-gray-700 mb-1">Summary</label>
                                    <textarea id="summary" name="summary" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>${article.summary}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                        <select id="category" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                            <option value="">Select a category</option>
                                            <option value="Science" ${article.category === 'Science' ? 'selected' : ''}>Science</option>
                                            <option value="Technology" ${article.category === 'Technology' ? 'selected' : ''}>Technology</option>
                                            <option value="History" ${article.category === 'History' ? 'selected' : ''}>History</option>
                                            <option value="Arts" ${article.category === 'Arts' ? 'selected' : ''}>Arts</option>
                                            <option value="Philosophy" ${article.category === 'Philosophy' ? 'selected' : ''}>Philosophy</option>
                                            <option value="Business" ${article.category === 'Business' ? 'selected' : ''}>Business</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
                                        <input type="text" id="tags" name="tags" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="${article.tags.join(', ')}" placeholder="e.g. physics, quantum, theory">
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="editor" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                                    <p class="text-sm text-gray-500 mb-2">Use [[Article Title]] to link to other articles.</p>
                                    <div id="editor" class="border border-gray-300 rounded-md"></div>
                                </div>
                                
                                <div class="mb-6">
                                    <label for="edit-comment" class="block text-sm font-medium text-gray-700 mb-1">Edit Comment</label>
                                    <textarea id="edit-comment" name="edit-comment" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Briefly describe your changes"></textarea>
                                </div>
                                
                                <div class="flex justify-end space-x-4">
                                    <button type="button" id="cancel-edit" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        Cancel
                                    </button>
                                    <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;
                    
                    // Initialize Quill editor
                    editor = new Quill('#editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                ['blockquote', 'code-block'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'script': 'sub'}, { 'script': 'super' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                ['link', 'image'],
                                ['clean']
                            ]
                        }
                    });
                    
                    // Set editor content
                    editor.root.innerHTML = article.content;
                    
                    // Cancel button
                    document.getElementById('cancel-edit').addEventListener('click', () => loadArticlePage(articleId));
                    
                    // Form submission
                    document.getElementById('edit-article-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        
                        const title = document.getElementById('title').value;
                        const summary = document.getElementById('summary').value;
                        const category = document.getElementById('category').value;
                        const tagsInput = document.getElementById('tags').value;
                        const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
                        const content = editor.root.innerHTML;
                        const editComment = document.getElementById('edit-comment').value;
                        
                        // Validate form
                        if (!title || !summary || !category || !content) {
                            alert('Please fill in all required fields.');
                            return;
                        }
                        
                        // Check for misleading content (simplified implementation)
                        const misleadingContentCheck = checkForMisleadingContent(content, article.content);
                        if (misleadingContentCheck.isMisleading) {
                            const confirmContinue = confirm('Warning: Your edit contains potentially misleading content. If you continue to submit misleading content, your account may be banned. Do you want to continue?');
                            if (!confirmContinue) {
                                return;
                            }
                            
                            // Track misleading edits in localStorage
                            const misleadingEdits = JSON.parse(localStorage.getItem('misleadingEdits') || '[]');
                            misleadingEdits.push({
                                userId: currentUser.uid,
                                articleId: articleId,
                                timestamp: new Date().toISOString()
                            });
                            localStorage.setItem('misleadingEdits', JSON.stringify(misleadingEdits));
                            
                            // Check if user should be banned (5+ misleading edits)
                            if (misleadingEdits.filter(edit => edit.userId === currentUser.uid).length >= 5) {
                                banUser('Repeatedly submitting misleading content');
                                alert('Your account has been banned for repeatedly submitting misleading content.');
                                loadMainPage();
                                return;
                            }
                        }
                        
                        // Update article
                        const articleData = {
                            title,
                            summary,
                            category,
                            tags,
                            content,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // If not the original author and not a moderator, set status to pending
                        if (article.authorId !== currentUser.uid && !isModerator) {
                            articleData.status = 'pending';
                        }
                        
                        db.collection('articles').doc(articleId).update(articleData)
                            .then(() => {
                                // Add to edit history
                                db.collection('articles').doc(articleId).collection('history').add({
                                    action: 'edited',
                                    userId: currentUser.uid,
                                    userName: currentUser.displayName || 'Anonymous',
                                    comment: editComment,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                // Update article titles for internal linking if title changed
                                if (title !== article.title) {
                                    const index = allArticleTitles.findIndex(a => a.id === articleId);
                                    if (index !== -1) {
                                        allArticleTitles[index].title = title;
                                    }
                                }
                                
                                // Update sitemap
                                updateSitemap();
                                
                                alert('Article updated successfully!');
                                loadArticlePage(articleId);
                            })
                            .catch((error) => {
                                console.error('Error updating article:', error);
                                alert('Error updating article. Please try again.');
                            });
                    });
                })
                .catch((error) => {
                    console.error('Error getting article:', error);
                    contentArea.innerHTML = `
                        <div class="bg-white shadow rounded-lg p-6 mb-6">
                            <h1 class="text-3xl font-bold mb-4 serif-font">Error</h1>
                            <p>There was an error loading the article for editing.</p>
                            <button id="back-to-browse" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                Back to Browse
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('back-to-browse').addEventListener('click', loadBrowsePage);
                });
        }
        
        // Simple check for misleading content (in a real app, this would be more sophisticated)
        function checkForMisleadingContent(newContent, oldContent) {
            // This is a simplified implementation
            // In a real app, you might use AI or more sophisticated algorithms
            
            // Check if content length decreased significantly
            if (oldContent && newContent.length < oldContent.length * 0.5) {
                return {
                    isMisleading: true,
                    reason: 'Content length decreased significantly'
                };
            }
            
            // Check for potentially misleading keywords
            const misleadingKeywords = ['fake', 'hoax', 'conspiracy', 'illuminati', 'flat earth'];
            for (const keyword of misleadingKeywords) {
                if (newContent.toLowerCase().includes(keyword) && !oldContent.toLowerCase().includes(keyword)) {
                    return {
                        isMisleading: true,
                        reason: `Content contains potentially misleading keyword: ${keyword}`
                    };
                }
            }
            
            return { isMisleading: false };
        }
        
        function loadBecomeModerator() {
            if (!currentUser) {
                showLoginPrompt('apply to become a moderator');
                return;
            }
            
            // Check if user is banned
            const banStatus = checkIfBanned();
            if (banStatus.isBanned) {
                contentArea.innerHTML = `
                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <div class="banned-banner mb-6">
                            <p class="font-bold">Your account has been temporarily banned</p>
                            <p>You are banned from submitting content until ${new Date(banStatus.until).toLocaleDateString()}.</p>
                        </div>
                        
                        <h1 class="text-3xl font-bold mb-4 serif-font">Become a Moderator</h1>
                        <p>You cannot apply to become a moderator while your account is banned.</p>
                        <button id="back-to-main" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                            Back to Main Page
                        </button>
                    </div>
                `;
                
                document.getElementById('back-to-main').addEventListener('click', loadMainPage);
                return;
            }
            
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-4 serif-font">Become a Moderator</h1>
                    
                    <p class="mb-4">Moderators play a crucial role in maintaining the quality and integrity of content on Forbiary. As a moderator, you'll have the ability to:</p>
                    
                    <ul class="list-disc pl-6 mb-6 space-y-2">
                        <li>Approve or reject article submissions</li>
                        <li>Lock articles to prevent further editing</li>
                        <li>Flag articles for review</li>
                        <li>View complete edit history</li>
                        <li>Help maintain content quality standards</li>
                    </ul>
                    
                    <form id="moderator-application-form" class="space-y-6">
                        <div>
                            <label for="experience" class="block text-sm font-medium text-gray-700 mb-1">Relevant Experience</label>
                            <textarea id="experience" name="experience" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Describe any relevant experience you have with content moderation, writing, or editing." required></textarea>
                        </div>
                        
                        <div>
                            <label for="motivation" class="block text-sm font-medium text-gray-700 mb-1">Motivation</label>
                            <textarea id="motivation" name="motivation" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Why do you want to become a moderator on Forbiary?" required></textarea>
                        </div>
                        
                        <div>
                            <label for="time-commitment" class="block text-sm font-medium text-gray-700 mb-1">Time Commitment</label>
                            <select id="time-commitment" name="time-commitment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Select an option</option>
                                <option value="1-3">1-3 hours per week</option>
                                <option value="4-7">4-7 hours per week</option>
                                <option value="8+">8+ hours per week</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="agree-guidelines" name="agree-guidelines" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" required>
                                <span class="ml-2 text-sm text-gray-700">I agree to follow Forbiary's moderation guidelines and code of conduct.</span>
                            </label>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Submit Application
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Form submission
            document.getElementById('moderator-application-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const experience = document.getElementById('experience').value;
                const motivation = document.getElementById('motivation').value;
                const timeCommitment = document.getElementById('time-commitment').value;
                const agreeGuidelines = document.getElementById('agree-guidelines').checked;
                
                if (!experience || !motivation || !timeCommitment || !agreeGuidelines) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                // Submit application
                db.collection('moderatorApplications').add({
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Anonymous',
                    userEmail: currentUser.email,
                    experience,
                    motivation,
                    timeCommitment,
                    status: 'pending',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    contentArea.innerHTML = `
                        <div class="bg-white shadow rounded-lg p-6 mb-6">
                            <h1 class="text-3xl font-bold mb-4 serif-font">Application Submitted</h1>
                            
                            <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-green-700">
                                            Your application to become a moderator has been submitted successfully.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="mb-4">Thank you for your interest in becoming a moderator on Forbiary. Our team will review your application and get back to you soon.</p>
                            
                            <p class="mb-6">In the meantime, you can continue to contribute to Forbiary by creating and editing articles.</p>
                            
                            <div class="flex">
                                <button id="back-to-main" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                    Back to Main Page
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('back-to-main').addEventListener('click', loadMainPage);
                })
                .catch((error) => {
                    console.error('Error submitting application:', error);
                    alert('Error submitting application. Please try again.');
                });
            });
        }
        
        function loadCategoriesPage() {
            // Update page title
            document.title = 'Categories - Forbiary';
            
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-6 serif-font">Categories</h1>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="categories-grid">
                        <p class="text-gray-500">Loading categories...</p>
                    </div>
                </div>
            `;
            
            // Get all categories with article counts
            db.collection('articles')
                .where('status', '==', 'approved')
                .get()
                .then((querySnapshot) => {
                    const categories = {
                        'Science': 0,
                        'Technology': 0,
                        'History': 0,
                        'Arts': 0,
                        'Philosophy': 0,
                        'Business': 0
                    };
                    
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        if (article.category && categories.hasOwnProperty(article.category)) {
                            categories[article.category]++;
                        }
                    });
                    
                    let categoriesHTML = '';
                    for (const [category, count] of Object.entries(categories)) {
                        categoriesHTML += `
                            <div class="border rounded-lg overflow-hidden">
                                <div class="p-6">
                                    <h2 class="text-xl font-bold mb-2 serif-font">${category}</h2>
                                    <p class="text-gray-600 mb-4">${count} articles</p>
                                    <button class="category-btn text-blue-600 hover:text-blue-800 font-medium" data-category="${category}">
                                        Browse Articles
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('categories-grid').innerHTML = categoriesHTML;
                    
                    // Add event listeners to category buttons
                    document.querySelectorAll('.category-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const category = e.target.getAttribute('data-category');
                            loadBrowsePage();
                            
                            // Wait for browse page to load, then click the category filter
                            setTimeout(() => {
                                document.querySelector(`.category-filter[data-category="${category}"]`).click();
                            }, 100);
                        });
                    });
                })
                .catch((error) => {
                    console.error('Error getting categories:', error);
                    document.getElementById('categories-grid').innerHTML = `
                        <p class="text-red-500">Error loading categories.</p>
                    `;
                });
        }
        
        function showLoginPrompt(action) {
            contentArea.innerHTML = `
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold mb-4 serif-font">Sign In Required</h1>
                    
                    <p class="mb-6">You need to sign in to ${action}.</p>
                    
                    <div class="flex space-x-4">
                        <button id="login-prompt-signin" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                            Sign In with Google
                        </button>
                        <button id="login-prompt-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('login-prompt-signin').addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).then((result) => {
                    console.log('Signed in:', result.user);
                    loadMainPage();
                }).catch((error) => {
                    console.error('Sign in error:', error);
                });
            });
            
            document.getElementById('login-prompt-cancel').addEventListener('click', loadMainPage);
        }
        
        // Generate robots.txt content
        function generateRobotsTxt() {
            return `User-agent: *
Allow: /
Sitemap: https://forbiary.web.app/sitemap.xml`;
        }
        
        // Generate sitemap.xml content
        function generateSitemapXml() {
            let sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
        <loc>https://forbiary.web.app/</loc>
        <lastmod>${new Date().toISOString()}</lastmod>
        <changefreq>daily</changefreq>
        <priority>1.0</priority>
    </url>`;
            
            sitemapData.forEach(article => {
                sitemap += `
    <url>
        <loc>https://forbiary.web.app/#article/${article.id}</loc>
        <lastmod>${article.lastmod}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>`;
            });
            
            sitemap += `
</urlset>`;
            
            return sitemap;
        }
        
        // Initialize the app
        function init() {
            // Check URL hash for article ID
            const hash = window.location.hash;
            if (hash && hash.startsWith('#article/')) {
                const articleId = hash.split('/')[1];
                loadArticlePage(articleId);
            } else if (hash && hash.startsWith('#create')) {
                loadCreateArticlePage();
            } else {
                loadMainPage();
            }
            
            // Listen for hash changes
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash;
                if (hash && hash.startsWith('#article/')) {
                    const articleId = hash.split('/')[1];
                    loadArticlePage(articleId);
                } else if (hash && hash.startsWith('#create')) {
                    loadCreateArticlePage();
                }
            });
            
            // Load all article titles for internal linking
            loadAllArticleTitles();
            
            // Update sitemap
            updateSitemap();
            
            console.log('Robots.txt content:', generateRobotsTxt());
        }
        
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9659a527a33e4832',t:'MTc1MzU5MzE4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
