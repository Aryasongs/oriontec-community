<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forbiary - The Knowledge Platform</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --main-bg-color: #f6f6f6;
            --content-bg-color: #ffffff;
            --border-color: #a7d7f9;
            --link-color: #0645ad;
            --link-visited: #0b0080;
            --text-color: #202122;
            --heading-color: #000000;
            --sidebar-width: 250px;
            --header-height: 60px;
            --menu-bg: #f8f9fa;
            --menu-hover: #eaecf0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: var(--main-bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--content-bg-color);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            top: 0;
            left: 0;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar-logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 10px;
        }

        .sidebar-nav a {
            color: var(--link-color);
            text-decoration: none;
            display: block;
            padding: 8px 10px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .sidebar-nav a:hover {
            background-color: var(--border-color);
        }

        .sidebar-nav .nav-section {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
            padding-left: 10px;
            color: #555;
            border-bottom: 1px solid #eee;
        }

        .main-content {
            flex: 1;
            padding: 0;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--content-bg-color);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-toggle {
            font-size: 24px;
            cursor: pointer;
            color: var(--link-color);
            display: flex;
            align-items: center;
        }

        .header-logo {
            font-size: 20px;
            font-weight: bold;
            margin-left: 15px;
        }

        .header-search {
            flex: 1;
            max-width: 500px;
            margin: 0 20px;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
        }

        .search-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--link-color);
            cursor: pointer;
        }

        .user-controls {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
        }

        .content-wrapper {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content {
            background-color: var(--content-bg-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 3px;
            margin-bottom: 20px;
        }

        .article-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .article-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 3px 3px 0 0;
            background-color: var(--main-bg-color);
        }

        .article-tab.active {
            border-color: var(--border-color);
            background-color: var(--content-bg-color);
            position: relative;
        }

        .article-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background-color: var(--content-bg-color);
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--heading-color);
            margin-bottom: 15px;
        }

        h1 {
            font-size: 28px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        h2 {
            font-size: 22px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 3px;
        }

        p {
            margin-bottom: 15px;
        }

        a {
            color: var(--link-color);
            text-decoration: none;
        }

        a:visited {
            color: var(--link-visited);
        }

        a:hover {
            text-decoration: underline;
        }

        .article-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .article-tags {
            display: flex;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .article-tag {
            background-color: #eaf3ff;
            padding: 3px 8px;
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .button {
            padding: 8px 15px;
            background-color: var(--link-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .button:hover {
            background-color: var(--link-visited);
        }

        .button-secondary {
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .button-secondary:hover {
            background-color: #eaecf0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 14px;
        }

        .editor-container {
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }

        .hidden {
            display: none !important;
        }

        .article-list {
            list-style: none;
        }

        .article-list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .article-list-item:hover {
            background-color: #f8f9fa;
        }

        .article-list-title {
            font-weight: bold;
            color: var(--link-color);
            font-size: 18px;
            margin-bottom: 5px;
        }

        .article-list-summary {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .article-list-meta {
            font-size: 12px;
            color: #888;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .article-list-meta span {
            display: flex;
            align-items: center;
        }

        .article-list-meta i {
            margin-right: 5px;
        }

        .tabs-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab-button {
            padding: 10px 15px;
            background-color: var(--main-bg-color);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 3px 3px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }

        .tab-button.active {
            background-color: var(--content-bg-color);
            border-bottom: 1px solid var(--content-bg-color);
            margin-bottom: -1px;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: var(--content-bg-color);
            border: 1px solid var(--border-color);
            border-top: none;
        }

        .tab-content.active {
            display: block;
        }

        .edit-history {
            margin-top: 20px;
            font-size: 14px;
        }

        .edit-history-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .edit-history-item:last-child {
            border-bottom: none;
        }

        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .category-card {
            background-color: var(--content-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .category-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--link-color);
        }

        .category-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .category-count {
            font-size: 12px;
            color: #666;
        }

        .moderator-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-footer {
            margin-top: 20px;
            text-align: center;
        }

        .article-contributors {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .contributor-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .contributor {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .contributor img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .article-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-button {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-button:hover {
            background-color: #eaecf0;
        }

        .action-button i {
            margin-right: 5px;
        }

        .locked-notice {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 3px;
            display: flex;
            align-items: center;
        }

        .locked-notice i {
            margin-right: 10px;
            font-size: 18px;
        }

        .related-articles {
            margin-top: 30px;
        }

        .related-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .related-item {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 10px;
            transition: background-color 0.2s;
        }

        .related-item:hover {
            background-color: #eaecf0;
        }

        .related-title {
            font-weight: bold;
            color: var(--link-color);
            margin-bottom: 5px;
        }

        .related-summary {
            font-size: 12px;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            border-radius: 3px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1100;
            transition: transform 0.3s, opacity 0.3s;
            transform: translateY(-100px);
            opacity: 0;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--content-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            z-index: 1000;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 15px;
            display: block;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
            text-decoration: none;
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--link-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .ql-editor {
            min-height: 200px;
        }

        .ql-toolbar.ql-snow {
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }

        .ql-container.ql-snow {
            border-bottom-left-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }

            .header-search {
                margin: 0 10px;
            }

            .content-wrapper {
                padding: 10px;
            }

            .content {
                padding: 15px;
            }

            .category-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .related-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .article-actions {
                flex-direction: column;
                gap: 5px;
            }

            .article-tabs {
                overflow-x: auto;
            }
        }

        @media (min-width: 769px) {
            .main-content {
                margin-left: 0;
            }
        }

        @media (min-width: 1200px) {
            .content-wrapper {
                max-width: 1000px;
            }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-logo">Forbiary</div>
            <ul class="sidebar-nav">
                <li><a href="#" id="nav-home"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" id="nav-browse"><i class="fas fa-book"></i> Browse Articles</a></li>
                <li><a href="#" id="nav-create"><i class="fas fa-edit"></i> Create Article</a></li>
                <li><a href="#" id="nav-categories"><i class="fas fa-tags"></i> Categories</a></li>
                <li><a href="#" id="nav-become-moderator"><i class="fas fa-user-shield"></i> Become Moderator</a></li>
                
                <div class="nav-section">Account</div>
                <li class="logged-out"><a href="#" id="nav-login"><i class="fas fa-sign-in-alt"></i> Log In</a></li>
                <li class="logged-in hidden"><a href="#" id="nav-profile"><i class="fas fa-user"></i> My Profile</a></li>
                <li class="logged-in hidden"><a href="#" id="nav-my-articles"><i class="fas fa-file-alt"></i> My Articles</a></li>
                <li class="moderator-only hidden"><a href="#" id="nav-moderate"><i class="fas fa-tasks"></i> Moderation Dashboard</a></li>
                <li class="logged-in hidden"><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> Log Out</a></li>
                
                <div class="nav-section">Help</div>
                <li><a href="#" id="nav-about"><i class="fas fa-info-circle"></i> About Forbiary</a></li>
                <li><a href="#" id="nav-guidelines"><i class="fas fa-clipboard-list"></i> Guidelines</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                    <div class="header-logo">Forbiary</div>
                </div>
                
                <div class="header-search">
                    <input type="text" class="search-box" id="search-box" placeholder="Search Forbiary...">
                    <button class="search-button" id="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="user-controls">
                    <button class="button logged-out" id="header-login-btn">Log In</button>
                    <div class="user-dropdown logged-in hidden">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="user-avatar">
                        <div class="dropdown-menu" id="user-dropdown">
                            <a href="#" class="dropdown-item" id="dropdown-profile">My Profile</a>
                            <a href="#" class="dropdown-item" id="dropdown-articles">My Articles</a>
                            <a href="#" class="dropdown-item moderator-only hidden" id="dropdown-moderate">Moderation Dashboard</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" id="dropdown-logout">Log Out</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-wrapper">
                <!-- Home Page -->
                <div id="page-home" class="page">
                    <div class="content">
                        <h1>Welcome to Forbiary</h1>
                        <p>Forbiary is an AI-assisted, professional knowledge-sharing platform inspired by the functionality of Wikipedia and the elegance of Forbes.</p>
                        
                        <h2>Featured Articles</h2>
                        <div id="featured-articles">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <span>Loading featured articles...</span>
                            </div>
                        </div>
                        
                        <h2>Recent Articles</h2>
                        <div id="recent-articles">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <span>Loading recent articles...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Browse Articles Page -->
                <div id="page-browse" class="page hidden">
                    <div class="content">
                        <h1>Browse Articles</h1>
                        
                        <div class="tabs-container">
                            <div class="tab-buttons">
                                <div class="tab-button active" data-tab="latest">Latest</div>
                                <div class="tab-button" data-tab="popular">Popular</div>
                                <div class="tab-button" data-tab="trending">Trending</div>
                            </div>
                            
                            <div id="tab-latest" class="tab-content active">
                                <div id="latest-articles">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading latest articles...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tab-popular" class="tab-content">
                                <div id="popular-articles">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading popular articles...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tab-trending" class="tab-content">
                                <div id="trending-articles">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading trending articles...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Login Page -->
                <div id="page-login" class="page hidden">
                    <div class="content">
                        <h1>Log In to Forbiary</h1>
                        <p>Please log in with your Google account to contribute to Forbiary.</p>
                        <div style="text-align: center; margin-top: 20px;">
                            <button id="google-login" class="button">
                                <i class="fab fa-google"></i> Log in with Google
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Create Article Page -->
                <div id="page-create" class="page hidden">
                    <div class="content">
                        <h1>Create New Article</h1>
                        <form id="article-form">
                            <div class="form-group">
                                <label for="article-title">Title</label>
                                <input type="text" id="article-title" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="article-summary">Summary</label>
                                <textarea id="article-summary" class="form-control" rows="2" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="article-category">Category</label>
                                <select id="article-category" class="form-control" required>
                                    <option value="">Select a category</option>
                                    <option value="tech">Technology</option>
                                    <option value="business">Business</option>
                                    <option value="science">Science</option>
                                    <option value="history">History</option>
                                    <option value="arts">Arts</option>
                                    <option value="health">Health</option>
                                    <option value="sports">Sports</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="education">Education</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="article-tags">Tags (comma separated)</label>
                                <input type="text" id="article-tags" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="article-content">Content</label>
                                <div id="editor-container" class="editor-container"></div>
                            </div>
                            <div class="form-group">
                                <label for="article-references">References (URLs or books, one per line)</label>
                                <textarea id="article-references" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Image Upload (Coming Soon)</label>
                                <input type="file" disabled class="form-control">
                                <small>This feature will be available soon.</small>
                            </div>
                            <button type="submit" class="button">Submit Article</button>
                        </form>
                    </div>
                </div>

                <!-- Categories Page -->
                <div id="page-categories" class="page hidden">
                    <div class="content">
                        <h1>Categories</h1>
                        <p>Browse articles by category.</p>
                        
                        <div class="category-list" id="category-list">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <span>Loading categories...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Become Moderator Page -->
                <div id="page-become-moderator" class="page hidden">
                    <div class="content">
                        <div class="moderator-form">
                            <h1 class="form-title">Become a Moderator</h1>
                            <p>Join our team of moderators to help maintain the quality of content on Forbiary. No approval needed - just fill out this form!</p>
                            
                            <form id="moderator-form">
                                <div class="form-group">
                                    <label for="mod-name">Full Name</label>
                                    <input type="text" id="mod-name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="mod-email">Email Address</label>
                                    <input type="email" id="mod-email" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="mod-reason">Why do you want to be a moderator?</label>
                                    <textarea id="mod-reason" class="form-control" rows="3" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="mod-experience">Do you have any experience with content moderation?</label>
                                    <textarea id="mod-experience" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="mod-topics">What topics are you knowledgeable about?</label>
                                    <input type="text" id="mod-topics" class="form-control" placeholder="e.g., Technology, History, Science">
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="mod-guidelines" required>
                                        I agree to follow Forbiary's moderation guidelines
                                    </label>
                                </div>
                                <div class="form-footer">
                                    <button type="submit" class="button">Submit Application</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Article View Page -->
                <div id="page-article" class="page hidden">
                    <div class="content">
                        <div id="article-locked" class="locked-notice hidden">
                            <i class="fas fa-lock"></i>
                            <span>This article has been locked by moderators and cannot be edited.</span>
                        </div>
                        
                        <div class="article-tabs">
                            <div class="article-tab active" id="tab-read">Read</div>
                            <div class="article-tab" id="tab-edit">Edit</div>
                            <div class="article-tab" id="tab-history">History</div>
                            <div class="article-tab" id="tab-discuss">Discuss</div>
                        </div>
                        
                        <div id="article-view" class="tab-content active">
                            <h1 id="view-title">Article Title</h1>
                            <div class="article-meta">
                                By <span id="view-author">Author</span> on <span id="view-date">Date</span> â€¢ 
                                Category: <span id="view-category">Category</span>
                            </div>
                            
                            <div id="view-content"></div>
                            
                            <div class="article-tags" id="view-tags"></div>
                            
                            <div class="article-contributors">
                                <h3>Contributors</h3>
                                <div class="contributor-list" id="view-contributors"></div>
                            </div>
                            
                            <div class="article-actions">
                                <button class="action-button" id="btn-share">
                                    <i class="fas fa-share-alt"></i> Share
                                </button>
                                <button class="action-button" id="btn-cite">
                                    <i class="fas fa-quote-right"></i> Cite
                                </button>
                                <button class="action-button moderator-only hidden" id="btn-lock">
                                    <i class="fas fa-lock"></i> Lock Article
                                </button>
                                <button class="action-button moderator-only hidden" id="btn-unlock">
                                    <i class="fas fa-unlock"></i> Unlock Article
                                </button>
                            </div>
                            
                            <div class="related-articles">
                                <h3>Related Articles</h3>
                                <div class="related-list" id="related-articles"></div>
                            </div>
                        </div>
                        
                        <div id="article-edit" class="tab-content">
                            <form id="edit-form">
                                <div class="form-group">
                                    <label for="edit-title">Title</label>
                                    <input type="text" id="edit-title" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-summary">Summary</label>
                                    <textarea id="edit-summary" class="form-control" rows="2" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="edit-category">Category</label>
                                    <select id="edit-category" class="form-control" required>
                                        <option value="">Select a category</option>
                                        <option value="tech">Technology</option>
                                        <option value="business">Business</option>
                                        <option value="science">Science</option>
                                        <option value="history">History</option>
                                        <option value="arts">Arts</option>
                                        <option value="health">Health</option>
                                        <option value="sports">Sports</option>
                                        <option value="entertainment">Entertainment</option>
                                        <option value="education">Education</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-tags">Tags (comma separated)</label>
                                    <input type="text" id="edit-tags" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="edit-content">Content</label>
                                    <div id="edit-editor-container" class="editor-container"></div>
                                </div>
                                <div class="form-group">
                                    <label for="edit-references">References (URLs or books, one per line)</label>
                                    <textarea id="edit-references" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="edit-reason">Edit Summary (briefly describe your changes)</label>
                                    <input type="text" id="edit-reason" class="form-control" placeholder="e.g., Fixed typos, Added new information">
                                </div>
                                <button type="submit" class="button">Submit Edit</button>
                            </form>
                        </div>
                        
                        <div id="article-history" class="tab-content">
                            <h2>Edit History</h2>
                            <div id="history-list">
                                <div class="loading-container">
                                    <div class="loading-spinner"></div>
                                    <span>Loading history...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="article-discuss" class="tab-content">
                            <h2>Discussion</h2>
                            <p>This feature is coming soon. You will be able to discuss this article with other users.</p>
                        </div>
                    </div>
                </div>

                <!-- Moderation Page -->
                <div id="page-moderate" class="page hidden moderator-only">
                    <div class="content">
                        <h1>Moderation Dashboard</h1>
                        
                        <div class="tabs-container">
                            <div class="tab-buttons">
                                <div class="tab-button active" data-tab="pending">Pending Articles</div>
                                <div class="tab-button" data-tab="pending-edits">Pending Edits</div>
                                <div class="tab-button" data-tab="reports">Reported Content</div>
                                <div class="tab-button" data-tab="banned">Banned IPs</div>
                            </div>
                            
                            <div id="tab-pending" class="tab-content active">
                                <h2>Pending Articles</h2>
                                <div id="pending-articles">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading pending articles...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tab-pending-edits" class="tab-content">
                                <h2>Pending Edits</h2>
                                <div id="pending-edits">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading pending edits...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tab-reports" class="tab-content">
                                <h2>Reported Content</h2>
                                <div id="reported-content">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading reported content...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tab-banned" class="tab-content">
                                <h2>Banned IPs</h2>
                                <div id="banned-ips">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading banned IPs...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Results Page -->
                <div id="page-search" class="page hidden">
                    <div class="content">
                        <h1>Search Results</h1>
                        <div id="search-results">
                            <p>Enter a search term above to find articles.</p>
                        </div>
                    </div>
                </div>

                <!-- Category Articles Page -->
                <div id="page-category" class="page hidden">
                    <div class="content">
                        <h1 id="category-title">Category</h1>
                        <div id="category-articles">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <span>Loading articles...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="page-profile" class="page hidden logged-in">
                    <div class="content">
                        <h1>My Profile</h1>
                        <div id="profile-info">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <span>Loading profile...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Articles Page -->
                <div id="page-my-articles" class="page hidden logged-in">
                    <div class="content">
                        <h1>My Articles</h1>
                        <div class="tabs-container">
                            <div class="tab-buttons">
                                <div class="tab-button active" data-tab="my-published">Published</div>
                                <div class="tab-button" data-tab="my-pending">Pending</div>
                                <div class="tab-button" data-tab="my-drafts">Drafts</div>
                            </div>
                            
                            <div id="tab-my-published" class="tab-content active">
                                <div id="my-published-articles">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading published articles...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tab-my-pending" class="tab-content">
                                <div id="my-pending-articles">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading pending articles...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tab-my-drafts" class="tab-content">
                                <div id="my-draft-articles">
                                    <div class="loading-container">
                                        <div class="loading-spinner"></div>
                                        <span>Loading drafts...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "auth.oriontec.xyz",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: ".",
            appId: "1:.:web:7248a0983dcf0d45a87418",
            measurementId: "G-5RFLRYTLCN"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let isModerator = false;
        let editor = null;
        let editEditor = null;
        let currentArticleId = null;
        let currentArticleData = null;
        let userIP = null;

        // DOM Elements
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        const moderatorElements = document.querySelectorAll('.moderator-only');
        const loggedInElements = document.querySelectorAll('.logged-in');
        const loggedOutElements = document.querySelectorAll('.logged-out');
        const notification = document.getElementById('notification');
        
        // Get user IP for anonymous edits
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                userIP = data.ip;
            })
            .catch(error => {
                console.error("Error getting IP:", error);
                userIP = "unknown";
            });
        
        // Initialize Quill editors
        document.addEventListener('DOMContentLoaded', function() {
            editor = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'direction': 'rtl' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });
            
            editEditor = new Quill('#edit-editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'direction': 'rtl' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });
        });

        // Authentication state observer
        auth.onAuthStateChanged(function(user) {
            if (user) {
                currentUser = user;
                checkIfModerator(user.uid);
                showLoggedInUI(user);
                loadUserData();
            } else {
                currentUser = null;
                isModerator = false;
                showLoggedOutUI();
            }
            
            // Check if there's an article ID in the URL hash
            checkUrlHash();
        });

        // Check if user is moderator
        function checkIfModerator(uid) {
            db.collection('users').doc(uid).get().then((doc) => {
                if (doc.exists && doc.data().role === 'moderator') {
                    isModerator = true;
                    showModeratorUI();
                } else {
                    isModerator = false;
                    hideModeratorUI();
                }
            }).catch((error) => {
                console.error("Error checking moderator status:", error);
            });
        }

        // UI state functions
        function showLoggedInUI(user) {
            loggedInElements.forEach(el => el.classList.remove('hidden'));
            loggedOutElements.forEach(el => el.classList.add('hidden'));
            
            // Update user avatar
            const avatarElements = document.querySelectorAll('.user-avatar');
            avatarElements.forEach(el => {
                el.src = user.photoURL || 'https://via.placeholder.com/32';
                el.alt = user.displayName || 'User';
            });
        }

        function showLoggedOutUI() {
            loggedInElements.forEach(el => el.classList.add('hidden'));
            loggedOutElements.forEach(el => el.classList.remove('hidden'));
        }

        function showModeratorUI() {
            moderatorElements.forEach(el => el.classList.remove('hidden'));
        }

        function hideModeratorUI() {
            moderatorElements.forEach(el => el.classList.add('hidden'));
        }

        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = isError ? 'notification error show' : 'notification show';
            
            setTimeout(() => {
                notification.className = notification.className.replace('show', '');
            }, 3000);
        }

        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.id.replace('nav-', '');
                navigateTo(target);
                closeSidebar();
            });
        });

        function navigateTo(page) {
            pages.forEach(p => p.classList.add('hidden'));
            
            if (page === 'login' && currentUser) {
                document.getElementById('page-home').classList.remove('hidden');
                return;
            }
            
            if ((page === 'create' || page === 'moderate' || page === 'profile' || page === 'my-articles') && !currentUser) {
                document.getElementById('page-login').classList.remove('hidden');
                return;
            }
            
            if (page === 'moderate' && !isModerator) {
                document.getElementById('page-home').classList.remove('hidden');
                showNotification('You need to be a moderator to access this page.', true);
                return;
            }
            
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            if (page === 'home') {
                loadFeaturedArticles();
                loadRecentArticles();
            } else if (page === 'browse') {
                loadLatestArticles();
            } else if (page === 'categories') {
                loadCategories();
            } else if (page === 'moderate' && isModerator) {
                loadPendingArticles();
            } else if (page === 'profile' && currentUser) {
                loadUserProfile();
            } else if (page === 'my-articles' && currentUser) {
                loadMyArticles();
            }
        }

        // Sidebar toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            toggleSidebar();
        });

        document.getElementById('sidebar-overlay').addEventListener('click', function() {
            closeSidebar();
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // User dropdown
        document.getElementById('user-avatar').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('user-dropdown').classList.toggle('show');
        });

        // Close dropdown when clicking elsewhere
        document.addEventListener('click', function() {
            document.getElementById('user-dropdown').classList.remove('show');
        });

        // Dropdown menu items
        document.getElementById('dropdown-profile').addEventListener('click', function(e) {
            e.preventDefault();
            navigateTo('profile');
        });

        document.getElementById('dropdown-articles').addEventListener('click', function(e) {
            e.preventDefault();
            navigateTo('my-articles');
        });

        document.getElementById('dropdown-moderate').addEventListener('click', function(e) {
            e.preventDefault();
            navigateTo('moderate');
        });

        document.getElementById('dropdown-logout').addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                navigateTo('home');
                showNotification('You have been logged out.');
            }).catch((error) => {
                console.error("Error during logout:", error);
                showNotification('Error during logout. Please try again.', true);
            });
        });

        // Header login button
        document.getElementById('header-login-btn').addEventListener('click', function() {
            navigateTo('login');
        });

        // Login functionality
        document.getElementById('google-login').addEventListener('click', function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                // Create or update user in Firestore
                const user = result.user;
                db.collection('users').doc(user.uid).set({
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                navigateTo('home');
                showNotification('Welcome to Forbiary!');
            }).catch((error) => {
                console.error("Error during login:", error);
                showNotification('Login failed. Please try again.', true);
            });
        });

        // Logout functionality
        document.getElementById('nav-logout').addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                navigateTo('home');
                showNotification('You have been logged out.');
            }).catch((error) => {
                console.error("Error during logout:", error);
                showNotification('Error during logout. Please try again.', true);
            });
        });

        // Article submission
        document.getElementById('article-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showNotification('Please log in to submit an article.', true);
                navigateTo('login');
                return;
            }
            
            const title = document.getElementById('article-title').value;
            const summary = document.getElementById('article-summary').value;
            const category = document.getElementById('article-category').value;
            const tags = document.getElementById('article-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const content = editor.root.innerHTML;
            const references = document.getElementById('article-references').value;
            
            // Generate metadata
            const metadata = generateMetadata(title, summary, tags, category);
            
            // Check if title already exists
            db.collection('articles').where('titleLower', '==', title.toLowerCase()).get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        showNotification('An article with this title already exists. Please choose a different title.', true);
                        return;
                    }
                    
                    // Create new article
                    db.collection('articles').add({
                        title: title,
                        titleLower: title.toLowerCase(),
                        summary: summary,
                        category: category,
                        tags: tags,
                        content: content,
                        references: references,
                        authorId: currentUser.uid,
                        authorName: currentUser.displayName,
                        authorPhoto: currentUser.photoURL,
                        status: 'pending',
                        isLocked: false,
                        views: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        metadata: metadata,
                        contributors: [{
                            id: currentUser.uid,
                            name: currentUser.displayName,
                            photo: currentUser.photoURL,
                            type: 'author'
                        }],
                        history: [{
                            type: 'creation',
                            userId: currentUser.uid,
                            userName: currentUser.displayName,
                            userPhoto: currentUser.photoURL,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }]
                    })
                    .then((docRef) => {
                        showNotification('Article submitted for review!');
                        document.getElementById('article-form').reset();
                        editor.setText('');
                        navigateTo('home');
                    })
                    .catch((error) => {
                        console.error("Error adding article:", error);
                        showNotification('Error submitting article. Please try again.', true);
                    });
                })
                .catch((error) => {
                    console.error("Error checking for duplicate title:", error);
                    showNotification('Error checking title. Please try again.', true);
                });
        });

        // Generate metadata for SEO
        function generateMetadata(title, summary, tags, category) {
            const canonicalUrl = `https://forbiary.web.app/#${title.toLowerCase().replace(/\s+/g, '-')}`;
            
            return {
                title: title,
                description: summary.substring(0, 160),
                canonicalUrl: canonicalUrl,
                keywords: tags.join(', '),
                ogTitle: title,
                ogDescription: summary.substring(0, 160),
                ogUrl: canonicalUrl,
                ogType: 'article',
                ogImage: 'https://forbiary.web.app/logo.png',
                schemaType: 'Article',
                category: category
            };
        }

        // Become moderator form submission
        document.getElementById('moderator-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('mod-name').value;
            const email = document.getElementById('mod-email').value;
            const reason = document.getElementById('mod-reason').value;
            const experience = document.getElementById('mod-experience').value;
            const topics = document.getElementById('mod-topics').value;
            
            // If user is logged in, use their account
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    role: 'moderator',
                    moderatorApplication: {
                        name: name,
                        email: email,
                        reason: reason,
                        experience: experience,
                        topics: topics,
                        appliedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }
                })
                .then(() => {
                    showNotification('You are now a moderator!');
                    isModerator = true;
                    showModeratorUI();
                    document.getElementById('moderator-form').reset();
                    navigateTo('home');
                })
                .catch((error) => {
                    console.error("Error becoming moderator:", error);
                    showNotification('Error processing your application. Please try again.', true);
                });
            } else {
                // For non-logged in users, prompt to login first
                showNotification('Please log in to become a moderator.', true);
                
                // Store form data in session storage
                sessionStorage.setItem('modName', name);
                sessionStorage.setItem('modEmail', email);
                sessionStorage.setItem('modReason', reason);
                sessionStorage.setItem('modExperience', experience);
                sessionStorage.setItem('modTopics', topics);
                
                navigateTo('login');
            }
        });

        // Load featured articles
        function loadFeaturedArticles() {
            const featuredContainer = document.getElementById('featured-articles');
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .orderBy('views', 'desc')
                .limit(5)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        featuredContainer.innerHTML = '<p>No featured articles yet.</p>';
                        return;
                    }
                    
                    let html = '<ul class="article-list">';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <a href="#${doc.id}" class="article-list-title">${article.title}</a>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                    <span><i class="fas fa-eye"></i> ${article.views || 0} views</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    featuredContainer.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error loading featured articles:", error);
                    featuredContainer.innerHTML = '<p>Error loading articles. Please try again.</p>';
                });
        }

        // Load recent articles
        function loadRecentArticles() {
            const recentContainer = document.getElementById('recent-articles');
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .orderBy('updatedAt', 'desc')
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        recentContainer.innerHTML = '<p>No articles yet.</p>';
                        return;
                    }
                    
                    let html = '<ul class="article-list">';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const date = article.updatedAt ? new Date(article.updatedAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <a href="#${doc.id}" class="article-list-title">${article.title}</a>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    recentContainer.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error loading recent articles:", error);
                    recentContainer.innerHTML = '<p>Error loading articles. Please try again.</p>';
                });
        }

        // Load latest articles
        function loadLatestArticles() {
            const latestContainer = document.getElementById('latest-articles');
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        latestContainer.innerHTML = '<p>No articles yet.</p>';
                        return;
                    }
                    
                    let html = '<ul class="article-list">';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <a href="#${doc.id}" class="article-list-title">${article.title}</a>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                    <span><i class="fas fa-eye"></i> ${article.views || 0} views</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    latestContainer.innerHTML = html;
                    
                    // Also load popular and trending
                    loadPopularArticles();
                    loadTrendingArticles();
                })
                .catch((error) => {
                    console.error("Error loading latest articles:", error);
                    latestContainer.innerHTML = '<p>Error loading articles. Please try again.</p>';
                });
        }

        // Load popular articles
        function loadPopularArticles() {
            const popularContainer = document.getElementById('popular-articles');
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .orderBy('views', 'desc')
                .limit(20)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        popularContainer.innerHTML = '<p>No articles yet.</p>';
                        return;
                    }
                    
                    let html = '<ul class="article-list">';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <a href="#${doc.id}" class="article-list-title">${article.title}</a>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                    <span><i class="fas fa-eye"></i> ${article.views || 0} views</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    popularContainer.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error loading popular articles:", error);
                    popularContainer.innerHTML = '<p>Error loading articles. Please try again.</p>';
                });
        }

        // Load trending articles (recent with high views)
        function loadTrendingArticles() {
            const trendingContainer = document.getElementById('trending-articles');
            
            // Get articles from the last 7 days
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .where('createdAt', '>=', oneWeekAgo)
                .orderBy('createdAt', 'desc')
                .orderBy('views', 'desc')
                .limit(20)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        trendingContainer.innerHTML = '<p>No trending articles this week.</p>';
                        return;
                    }
                    
                    let html = '<ul class="article-list">';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <a href="#${doc.id}" class="article-list-title">${article.title}</a>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                    <span><i class="fas fa-eye"></i> ${article.views || 0} views</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    trendingContainer.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error loading trending articles:", error);
                    trendingContainer.innerHTML = '<p>Error loading articles. Please try again.</p>';
                });
        }

        // Load categories
        function loadCategories() {
            const categoryContainer = document.getElementById('category-list');
            
            // Define categories with icons
            const categories = [
                { id: 'tech', name: 'Technology', icon: 'fas fa-microchip' },
                { id: 'business', name: 'Business', icon: 'fas fa-briefcase' },
                { id: 'science', name: 'Science', icon: 'fas fa-flask' },
                { id: 'history', name: 'History', icon: 'fas fa-landmark' },
                { id: 'arts', name: 'Arts', icon: 'fas fa-palette' },
                { id: 'health', name: 'Health', icon: 'fas fa-heartbeat' },
                { id: 'sports', name: 'Sports', icon: 'fas fa-football-ball' },
                { id: 'entertainment', name: 'Entertainment', icon: 'fas fa-film' },
                { id: 'education', name: 'Education', icon: 'fas fa-graduation-cap' },
                { id: 'other', name: 'Other', icon: 'fas fa-folder' }
            ];
            
            // Get article counts for each category
            const categoryCounts = {};
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach(doc => {
                        const category = doc.data().category;
                        categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                    });
                    
                    let html = '';
                    categories.forEach(category => {
                        const count = categoryCounts[category.id] || 0;
                        html += `
                            <div class="category-card" onclick="loadCategoryArticles('${category.id}', '${category.name}')">
                                <div class="category-icon"><i class="${category.icon}"></i></div>
                                <div class="category-name">${category.name}</div>
                                <div class="category-count">${count} articles</div>
                            </div>
                        `;
                    });
                    
                    categoryContainer.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error loading categories:", error);
                    categoryContainer.innerHTML = '<p>Error loading categories. Please try again.</p>';
                });
        }

        // Load articles by category
        function loadCategoryArticles(categoryId, categoryName) {
            const categoryTitle = document.getElementById('category-title');
            const categoryArticles = document.getElementById('category-articles');
            
            categoryTitle.textContent = categoryName;
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .where('category', '==', categoryId)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        categoryArticles.innerHTML = `<p>No articles in the ${categoryName} category yet.</p>`;
                        return;
                    }
                    
                    let html = '<ul class="article-list">';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <a href="#${doc.id}" class="article-list-title">${article.title}</a>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-eye"></i> ${article.views || 0} views</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    categoryArticles.innerHTML = html;
                    
                    // Show category page
                    pages.forEach(p => p.classList.add('hidden'));
                    document.getElementById('page-category').classList.remove('hidden');
                })
                .catch((error) => {
                    console.error("Error loading category articles:", error);
                    categoryArticles.innerHTML = '<p>Error loading articles. Please try again.</p>';
                });
        }

        // Get category name from ID
        function getCategoryName(categoryId) {
            const categories = {
                'tech': 'Technology',
                'business': 'Business',
                'science': 'Science',
                'history': 'History',
                'arts': 'Arts',
                'health': 'Health',
                'sports': 'Sports',
                'entertainment': 'Entertainment',
                'education': 'Education',
                'other': 'Other'
            };
            
            return categories[categoryId] || 'Unknown';
        }

        // Load pending articles for moderation
        function loadPendingArticles() {
            const pendingContainer = document.getElementById('pending-articles');
            
            db.collection('articles')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        pendingContainer.innerHTML = '<p>No pending articles.</p>';
                        return;
                    }
                    
                    let html = '<ul class="article-list">';
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <div class="article-list-title">${article.title}</div>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="button" onclick="viewArticleForModeration('${doc.id}')">View</button>
                                    <button class="button" onclick="approveArticle('${doc.id}')">Approve</button>
                                    <button class="button button-secondary" onclick="rejectArticle('${doc.id}')">Reject</button>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    pendingContainer.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error loading pending articles:", error);
                    pendingContainer.innerHTML = '<p>Error loading articles. Please try again.</p>';
                });
        }

        // View article for moderation
        function viewArticleForModeration(articleId) {
            window.location.hash = articleId;
        }

        // Approve article
        function approveArticle(articleId) {
            if (!isModerator) {
                showNotification("You don't have permission to approve articles.", true);
                return;
            }
            
            db.collection('articles').doc(articleId).update({
                status: 'approved',
                approvedBy: currentUser.uid,
                approvedByName: currentUser.displayName,
                approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                history: firebase.firestore.FieldValue.arrayUnion({
                    type: 'approval',
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userPhoto: currentUser.photoURL,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            })
            .then(() => {
                showNotification("Article approved!");
                loadPendingArticles();
            })
            .catch((error) => {
                console.error("Error approving article:", error);
                showNotification("Error approving article. Please try again.", true);
            });
        }

        // Reject article
        function rejectArticle(articleId) {
            if (!isModerator) {
                showNotification("You don't have permission to reject articles.", true);
                return;
            }
            
            const reason = prompt("Please provide a reason for rejection:");
            if (!reason) return;
            
            db.collection('articles').doc(articleId).update({
                status: 'rejected',
                rejectedBy: currentUser.uid,
                rejectedByName: currentUser.displayName,
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                rejectionReason: reason,
                history: firebase.firestore.FieldValue.arrayUnion({
                    type: 'rejection',
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userPhoto: currentUser.photoURL,
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            })
            .then(() => {
                showNotification("Article rejected.");
                loadPendingArticles();
            })
            .catch((error) => {
                console.error("Error rejecting article:", error);
                showNotification("Error rejecting article. Please try again.", true);
            });
        }

        // Check URL hash for article ID
        function checkUrlHash() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                loadArticle(hash);
            }
        }

        // Load article by ID
        function loadArticle(articleId) {
            currentArticleId = articleId;
            
            db.collection('articles').doc(articleId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const article = doc.data();
                        currentArticleData = article;
                        
                        // Only show approved articles to non-moderators
                        if (article.status !== 'approved' && !isModerator) {
                            showNotification("This article is not available for viewing.", true);
                            navigateTo('home');
                            return;
                        }
                        
                        // Update view count
                        db.collection('articles').doc(articleId).update({
                            views: firebase.firestore.FieldValue.increment(1)
                        }).catch(error => console.error("Error updating view count:", error));
                        
                        // Display article
                        document.getElementById('view-title').textContent = article.title;
                        document.getElementById('view-author').textContent = article.authorName;
                        document.getElementById('view-date').textContent = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        document.getElementById('view-category').textContent = getCategoryName(article.category);
                        document.getElementById('view-content').innerHTML = article.content;
                        
                        // Check if article is locked
                        if (article.isLocked) {
                            document.getElementById('article-locked').classList.remove('hidden');
                            document.getElementById('tab-edit').classList.add('hidden');
                            document.getElementById('btn-unlock').classList.remove('hidden');
                            document.getElementById('btn-lock').classList.add('hidden');
                        } else {
                            document.getElementById('article-locked').classList.add('hidden');
                            document.getElementById('tab-edit').classList.remove('hidden');
                            document.getElementById('btn-unlock').classList.add('hidden');
                            document.getElementById('btn-lock').classList.remove('hidden');
                        }
                        
                        // Display tags
                        const tagsContainer = document.getElementById('view-tags');
                        tagsContainer.innerHTML = '';
                        if (article.tags && article.tags.length > 0) {
                            article.tags.forEach(tag => {
                                const tagEl = document.createElement('span');
                                tagEl.className = 'article-tag';
                                tagEl.textContent = tag;
                                tagsContainer.appendChild(tagEl);
                            });
                        }
                        
                        // Display contributors
                        const contributorsContainer = document.getElementById('view-contributors');
                        contributorsContainer.innerHTML = '';
                        if (article.contributors && article.contributors.length > 0) {
                            article.contributors.forEach(contributor => {
                                const contributorEl = document.createElement('div');
                                contributorEl.className = 'contributor';
                                contributorEl.innerHTML = `
                                    <img src="${contributor.photo || 'https://via.placeholder.com/20'}" alt="${contributor.name}">
                                    <span>${contributor.name}</span>
                                `;
                                contributorsContainer.appendChild(contributorEl);
                            });
                        }
                        
                        // Load edit form data
                        document.getElementById('edit-title').value = article.title;
                        document.getElementById('edit-summary').value = article.summary;
                        document.getElementById('edit-category').value = article.category;
                        document.getElementById('edit-tags').value = article.tags ? article.tags.join(', ') : '';
                        document.getElementById('edit-references').value = article.references || '';
                        editEditor.root.innerHTML = article.content;
                        
                        // Load history
                        loadArticleHistory(articleId);
                        
                        // Load related articles
                        loadRelatedArticles(article.tags, article.category, articleId);
                        
                        // Update document title for SEO
                        document.title = `${article.title} - Forbiary`;
                        
                        // Show article page
                        pages.forEach(p => p.classList.add('hidden'));
                        document.getElementById('page-article').classList.remove('hidden');
                        
                        // Set active tab to read
                        document.getElementById('tab-read').classList.add('active');
                        document.getElementById('tab-edit').classList.remove('active');
                        document.getElementById('tab-history').classList.remove('active');
                        document.getElementById('tab-discuss').classList.remove('active');
                        document.getElementById('article-view').classList.add('active');
                        document.getElementById('article-edit').classList.remove('active');
                        document.getElementById('article-history').classList.remove('active');
                        document.getElementById('article-discuss').classList.remove('active');
                    } else {
                        showNotification("Article not found.", true);
                        navigateTo('home');
                    }
                })
                .catch((error) => {
                    console.error("Error loading article:", error);
                    showNotification("Error loading article. Please try again.", true);
                    navigateTo('home');
                });
        }

        // Load related articles
        function loadRelatedArticles(tags, category, currentId) {
            const relatedContainer = document.getElementById('related-articles');
            relatedContainer.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><span>Loading related articles...</span></div>';
            
            // First try to find articles with matching tags
            db.collection('articles')
                .where('status', '==', 'approved')
                .where('category', '==', category)
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    const relatedArticles = [];
                    
                    querySnapshot.forEach(doc => {
                        if (doc.id !== currentId) {
                            const article = doc.data();
                            
                            // Calculate relevance score based on matching tags
                            let relevanceScore = 0;
                            if (article.tags && tags) {
                                article.tags.forEach(tag => {
                                    if (tags.includes(tag)) {
                                        relevanceScore += 1;
                                    }
                                });
                            }
                            
                            relatedArticles.push({
                                id: doc.id,
                                title: article.title,
                                summary: article.summary,
                                relevanceScore: relevanceScore
                            });
                        }
                    });
                    
                    // Sort by relevance score
                    relatedArticles.sort((a, b) => b.relevanceScore - a.relevanceScore);
                    
                    // Display top 4 related articles
                    if (relatedArticles.length === 0) {
                        relatedContainer.innerHTML = '<p>No related articles found.</p>';
                        return;
                    }
                    
                    let html = '';
                    relatedArticles.slice(0, 4).forEach(article => {
                        html += `
                            <div class="related-item">
                                <a href="#${article.id}" class="related-title">${article.title}</a>
                                <div class="related-summary">${article.summary.substring(0, 100)}${article.summary.length > 100 ? '...' : ''}</div>
                            </div>
                        `;
                    });
                    
                    relatedContainer.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error loading related articles:", error);
                    relatedContainer.innerHTML = '<p>Error loading related articles.</p>';
                });
        }

        // Load article history
        function loadArticleHistory(articleId) {
            const historyContainer = document.getElementById('history-list');
            
            db.collection('articles').doc(articleId).get()
                .then((doc) => {
                    if (doc.exists && doc.data().history) {
                        const history = doc.data().history;
                        if (history.length === 0) {
                            historyContainer.innerHTML = '<p>No history available.</p>';
                            return;
                        }
                        
                        let html = '';
                        history.forEach((entry, index) => {
                            const date = entry.timestamp ? new Date(entry.timestamp.toDate()).toLocaleString() : 'Unknown date';
                            let action = '';
                            let details = '';
                            
                            switch(entry.type) {
                                case 'creation':
                                    action = 'Created article';
                                    break;
                                case 'edit':
                                    action = 'Edited article';
                                    details = entry.reason ? `<div><strong>Reason:</strong> ${entry.reason}</div>` : '';
                                    break;
                                case 'approval':
                                    action = 'Approved article';
                                    break;
                                case 'rejection':
                                    action = 'Rejected article';
                                    details = entry.reason ? `<div><strong>Reason:</strong> ${entry.reason}</div>` : '';
                                    break;
                                case 'lock':
                                    action = 'Locked article';
                                    details = entry.reason ? `<div><strong>Reason:</strong> ${entry.reason}</div>` : '';
                                    break;
                                case 'unlock':
                                    action = 'Unlocked article';
                                    break;
                                default:
                                    action = entry.type;
                            }
                            
                            const userPhoto = entry.userPhoto || 'https://via.placeholder.com/32';
                            
                            html += `
                                <div class="edit-history-item">
                                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                        <img src="${userPhoto}" alt="${entry.userName}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 10px;">
                                        <strong>${entry.userName || 'Unknown user'}</strong>
                                    </div>
                                    <div>${action} - ${date}</div>
                                    ${details}
                                </div>
                            `;
                        });
                        
                        historyContainer.innerHTML = html;
                    } else {
                        historyContainer.innerHTML = '<p>No history available.</p>';
                    }
                })
                .catch((error) => {
                    console.error("Error loading article history:", error);
                    historyContainer.innerHTML = '<p>Error loading history.</p>';
                });
        }

        // Article tabs functionality
        document.getElementById('tab-read').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('tab-edit').classList.remove('active');
            document.getElementById('tab-history').classList.remove('active');
            document.getElementById('tab-discuss').classList.remove('active');
            document.getElementById('article-view').classList.add('active');
            document.getElementById('article-edit').classList.remove('active');
            document.getElementById('article-history').classList.remove('active');
            document.getElementById('article-discuss').classList.remove('active');
        });

        document.getElementById('tab-edit').addEventListener('click', function() {
            // Check if article is locked
            if (currentArticleData && currentArticleData.isLocked) {
                showNotification("This article is locked and cannot be edited.", true);
                return;
            }
            
            this.classList.add('active');
            document.getElementById('tab-read').classList.remove('active');
            document.getElementById('tab-history').classList.remove('active');
            document.getElementById('tab-discuss').classList.remove('active');
            document.getElementById('article-edit').classList.add('active');
            document.getElementById('article-view').classList.remove('active');
            document.getElementById('article-history').classList.remove('active');
            document.getElementById('article-discuss').classList.remove('active');
            
            // If user is not logged in, show login prompt
            if (!currentUser) {
                const loginPrompt = document.createElement('div');
                loginPrompt.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p>You need to log in to edit this article.</p>
                        <button id="edit-login-btn" class="button">Log In</button>
                        <p style="margin-top: 10px; font-size: 14px;">
                            You can continue editing without logging in, but your changes will be tracked by IP address.
                        </p>
                        <button id="edit-anonymous-btn" class="button button-secondary">Continue as Anonymous</button>
                    </div>
                `;
                
                document.getElementById('article-edit').innerHTML = '';
                document.getElementById('article-edit').appendChild(loginPrompt);
                
                document.getElementById('edit-login-btn').addEventListener('click', function() {
                    navigateTo('login');
                });
                
                document.getElementById('edit-anonymous-btn').addEventListener('click', function() {
                    document.getElementById('article-edit').innerHTML = '';
                    document.getElementById('article-edit').appendChild(document.getElementById('edit-form'));
                });
            }
        });

        document.getElementById('tab-history').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('tab-read').classList.remove('active');
            document.getElementById('tab-edit').classList.remove('active');
            document.getElementById('tab-discuss').classList.remove('active');
            document.getElementById('article-history').classList.add('active');
            document.getElementById('article-view').classList.remove('active');
            document.getElementById('article-edit').classList.remove('active');
            document.getElementById('article-discuss').classList.remove('active');
        });

        document.getElementById('tab-discuss').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('tab-read').classList.remove('active');
            document.getElementById('tab-edit').classList.remove('active');
            document.getElementById('tab-history').classList.remove('active');
            document.getElementById('article-discuss').classList.add('active');
            document.getElementById('article-view').classList.remove('active');
            document.getElementById('article-edit').classList.remove('active');
            document.getElementById('article-history').classList.remove('active');
        });

        // Edit article submission
        document.getElementById('edit-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentArticleId) {
                showNotification("No article selected for editing.", true);
                return;
            }
            
            // Check if article is locked
            if (currentArticleData && currentArticleData.isLocked) {
                showNotification("This article is locked and cannot be edited.", true);
                return;
            }
            
            const title = document.getElementById('edit-title').value;
            const summary = document.getElementById('edit-summary').value;
            const category = document.getElementById('edit-category').value;
            const tags = document.getElementById('edit-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const content = editEditor.root.innerHTML;
            const references = document.getElementById('edit-references').value;
            const reason = document.getElementById('edit-reason').value || 'No reason provided';
            
            // Generate metadata
            const metadata = generateMetadata(title, summary, tags, category);
            
            // Check if title changed and if it already exists
            db.collection('articles').doc(currentArticleId).get()
                .then((doc) => {
                    if (!doc.exists) {
                        showNotification("Article not found.", true);
                        return;
                    }
                    
                    const originalTitle = doc.data().title;
                    
                    // If title changed, check for duplicates
                    if (title.toLowerCase() !== originalTitle.toLowerCase()) {
                        return db.collection('articles')
                            .where('titleLower', '==', title.toLowerCase())
                            .get()
                            .then((querySnapshot) => {
                                if (!querySnapshot.empty) {
                                    showNotification("An article with this title already exists. Please choose a different title.", true);
                                    throw new Error("Duplicate title");
                                }
                                return doc;
                            });
                    }
                    
                    return doc;
                })
                .then((doc) => {
                    const originalData = doc.data();
                    
                    // For moderators, apply changes directly
                    if (isModerator) {
                        return db.collection('articles').doc(currentArticleId).update({
                            title: title,
                            titleLower: title.toLowerCase(),
                            summary: summary,
                            category: category,
                            tags: tags,
                            content: content,
                            references: references,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            metadata: metadata,
                            history: firebase.firestore.FieldValue.arrayUnion({
                                type: 'edit',
                                userId: currentUser ? currentUser.uid : 'anonymous',
                                userName: currentUser ? currentUser.displayName : 'Anonymous (' + userIP + ')',
                                userPhoto: currentUser ? currentUser.photoURL : null,
                                reason: reason,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            })
                        })
                        .then(() => {
                            // Add user to contributors if not already there
                            if (currentUser) {
                                const contributors = originalData.contributors || [];
                                const existingContributor = contributors.find(c => c.id === currentUser.uid);
                                
                                if (!existingContributor) {
                                    return db.collection('articles').doc(currentArticleId).update({
                                        contributors: firebase.firestore.FieldValue.arrayUnion({
                                            id: currentUser.uid,
                                            name: currentUser.displayName,
                                            photo: currentUser.photoURL,
                                            type: 'editor'
                                        })
                                    });
                                }
                            }
                        })
                        .then(() => {
                            showNotification("Article updated successfully!");
                            loadArticle(currentArticleId);
                        });
                    }
                    
                    // For regular users, submit edit for review
                    return db.collection('edits').add({
                        articleId: currentArticleId,
                        originalTitle: originalData.title,
                        title: title,
                        titleLower: title.toLowerCase(),
                        summary: summary,
                        category: category,
                        tags: tags,
                        content: content,
                        references: references,
                        editorId: currentUser ? currentUser.uid : 'anonymous',
                        editorName: currentUser ? currentUser.displayName : 'Anonymous (' + userIP + ')',
                        editorPhoto: currentUser ? currentUser.photoURL : null,
                        reason: reason,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        ipAddress: userIP
                    })
                    .then(() => {
                        // Update article with pending edit flag
                        return db.collection('articles').doc(currentArticleId).update({
                            hasPendingEdits: true,
                            history: firebase.firestore.FieldValue.arrayUnion({
                                type: 'edit-submission',
                                userId: currentUser ? currentUser.uid : 'anonymous',
                                userName: currentUser ? currentUser.displayName : 'Anonymous (' + userIP + ')',
                                userPhoto: currentUser ? currentUser.photoURL : null,
                                reason: reason,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            })
                        });
                    })
                    .then(() => {
                        showNotification("Edit submitted for review!");
                        loadArticle(currentArticleId);
                    });
                })
                .catch((error) => {
                    if (error.message !== "Duplicate title") {
                        console.error("Error submitting edit:", error);
                        showNotification("Error submitting edit. Please try again.", true);
                    }
                });
        });

        // Lock/Unlock article
        document.getElementById('btn-lock').addEventListener('click', function() {
            if (!isModerator) {
                showNotification("You don't have permission to lock articles.", true);
                return;
            }
            
            const reason = prompt("Please provide a reason for locking this article:");
            if (!reason) return;
            
            db.collection('articles').doc(currentArticleId).update({
                isLocked: true,
                lockedBy: currentUser.uid,
                lockedByName: currentUser.displayName,
                lockedAt: firebase.firestore.FieldValue.serverTimestamp(),
                lockReason: reason,
                history: firebase.firestore.FieldValue.arrayUnion({
                    type: 'lock',
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userPhoto: currentUser.photoURL,
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            })
            .then(() => {
                showNotification("Article locked successfully.");
                loadArticle(currentArticleId);
            })
            .catch((error) => {
                console.error("Error locking article:", error);
                showNotification("Error locking article. Please try again.", true);
            });
        });

        document.getElementById('btn-unlock').addEventListener('click', function() {
            if (!isModerator) {
                showNotification("You don't have permission to unlock articles.", true);
                return;
            }
            
            db.collection('articles').doc(currentArticleId).update({
                isLocked: false,
                unlockedBy: currentUser.uid,
                unlockedByName: currentUser.displayName,
                unlockedAt: firebase.firestore.FieldValue.serverTimestamp(),
                history: firebase.firestore.FieldValue.arrayUnion({
                    type: 'unlock',
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userPhoto: currentUser.photoURL,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            })
            .then(() => {
                showNotification("Article unlocked successfully.");
                loadArticle(currentArticleId);
            })
            .catch((error) => {
                console.error("Error unlocking article:", error);
                showNotification("Error unlocking article. Please try again.", true);
            });
        });

        // Share article
        document.getElementById('btn-share').addEventListener('click', function() {
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('view-title').textContent,
                    text: currentArticleData.summary,
                    url: url
                })
                .then(() => console.log('Successful share'))
                .catch((error) => console.log('Error sharing:', error));
            } else {
                // Fallback for browsers that don't support navigator.share
                navigator.clipboard.writeText(url)
                    .then(() => {
                        showNotification("Link copied to clipboard!");
                    })
                    .catch(err => {
                        console.error('Could not copy text: ', err);
                        showNotification("Failed to copy link.", true);
                    });
            }
        });

        // Cite article
        document.getElementById('btn-cite').addEventListener('click', function() {
            const title = document.getElementById('view-title').textContent;
            const author = document.getElementById('view-author').textContent;
            const date = document.getElementById('view-date').textContent;
            const url = window.location.href;
            
            const citation = `${author}. (${new Date().getFullYear()}). "${title}". Forbiary. Retrieved ${new Date().toLocaleDateString()}, from ${url}`;
            
            navigator.clipboard.writeText(citation)
                .then(() => {
                    showNotification("Citation copied to clipboard!");
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                    showNotification("Failed to copy citation.", true);
                });
        });

        // Search functionality
        document.getElementById('search-button').addEventListener('click', function() {
            const query = document.getElementById('search-box').value.trim();
            if (query) {
                searchArticles(query);
            }
        });

        document.getElementById('search-box').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    searchArticles(query);
                }
            }
        });

        function searchArticles(query) {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><span>Searching for "' + query + '"...</span></div>';
            
            // Navigate to search page
            pages.forEach(p => p.classList.add('hidden'));
            document.getElementById('page-search').classList.remove('hidden');
            
            // Perform search (title and tags)
            const queryLower = query.toLowerCase();
            
            db.collection('articles')
                .where('status', '==', 'approved')
                .get()
                .then((querySnapshot) => {
                    const results = [];
                    
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        
                        // Check title
                        if (article.title.toLowerCase().includes(queryLower)) {
                            results.push({id: doc.id, ...article, matchType: 'title'});
                            return;
                        }
                        
                        // Check tags
                        if (article.tags && article.tags.some(tag => tag.toLowerCase().includes(queryLower))) {
                            results.push({id: doc.id, ...article, matchType: 'tag'});
                            return;
                        }
                        
                        // Check category
                        if (article.category && article.category.toLowerCase().includes(queryLower)) {
                            results.push({id: doc.id, ...article, matchType: 'category'});
                            return;
                        }
                        
                        // Check summary (lower priority)
                        if (article.summary && article.summary.toLowerCase().includes(queryLower)) {
                            results.push({id: doc.id, ...article, matchType: 'summary'});
                            return;
                        }
                    });
                    
                    if (results.length === 0) {
                        searchResults.innerHTML = '<p>No results found for "' + query + '".</p>';
                        return;
                    }
                    
                    let html = `<h2>Search Results for "${query}"</h2><ul class="article-list">`;
                    results.forEach((article) => {
                        let matchInfo = '';
                        switch(article.matchType) {
                            case 'title':
                                matchInfo = 'Matched in title';
                                break;
                            case 'tag':
                                matchInfo = 'Matched in tags';
                                break;
                            case 'category':
                                matchInfo = 'Matched in category';
                                break;
                            case 'summary':
                                matchInfo = 'Matched in summary';
                                break;
                        }
                        
                        const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                        
                        html += `
                            <li class="article-list-item">
                                <a href="#${article.id}" class="article-list-title">${article.title}</a>
                                <div class="article-list-summary">${article.summary}</div>
                                <div class="article-list-meta">
                                    <span><i class="fas fa-user"></i> ${article.authorName}</span>
                                    <span><i class="fas fa-calendar"></i> ${date}</span>
                                    <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                    <span><i class="fas fa-search"></i> ${matchInfo}</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    searchResults.innerHTML = html;
                })
                .catch((error) => {
                    console.error("Error searching articles:", error);
                    searchResults.innerHTML = '<p>Error searching articles. Please try again.</p>';
                });
        }

        // Load user data
        function loadUserData() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (!doc.exists) {
                        // Create user document if it doesn't exist
                        db.collection('users').doc(currentUser.uid).set({
                            displayName: currentUser.displayName,
                            email: currentUser.email,
                            photoURL: currentUser.photoURL,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // Update last login
                        db.collection('users').doc(currentUser.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Check if user is a moderator
                        if (doc.data().role === 'moderator') {
                            isModerator = true;
                            showModeratorUI();
                        }
                    }
                    
                    // Check if there's pending moderator application data
                    if (sessionStorage.getItem('modName')) {
                        db.collection('users').doc(currentUser.uid).update({
                            role: 'moderator',
                            moderatorApplication: {
                                name: sessionStorage.getItem('modName'),
                                email: sessionStorage.getItem('modEmail'),
                                reason: sessionStorage.getItem('modReason'),
                                experience: sessionStorage.getItem('modExperience'),
                                topics: sessionStorage.getItem('modTopics'),
                                appliedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        })
                        .then(() => {
                            showNotification('You are now a moderator!');
                            isModerator = true;
                            showModeratorUI();
                            
                            // Clear session storage
                            sessionStorage.removeItem('modName');
                            sessionStorage.removeItem('modEmail');
                            sessionStorage.removeItem('modReason');
                            sessionStorage.removeItem('modExperience');
                            sessionStorage.removeItem('modTopics');
                        })
                        .catch((error) => {
                            console.error("Error becoming moderator:", error);
                            showNotification('Error processing your application. Please try again.', true);
                        });
                    }
                })
                .catch((error) => {
                    console.error("Error loading user data:", error);
                });
        }

        // Load user profile
        function loadUserProfile() {
            if (!currentUser) return;
            
            const profileInfo = document.getElementById('profile-info');
            
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (!doc.exists) {
                        profileInfo.innerHTML = '<p>Profile not found.</p>';
                        return;
                    }
                    
                    const userData = doc.data();
                    const joinDate = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString() : 'Unknown';
                    const lastLogin = userData.lastLogin ? new Date(userData.lastLogin.toDate()).toLocaleDateString() : 'Unknown';
                    
                    let html = `
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <img src="${userData.photoURL || 'https://via.placeholder.com/100'}" alt="${userData.displayName}" style="width: 100px; height: 100px; border-radius: 50%; margin-right: 20px;">
                            <div>
                                <h2>${userData.displayName}</h2>
                                <p>${userData.email}</p>
                                <p>Joined: ${joinDate}</p>
                                <p>Last login: ${lastLogin}</p>
                                ${userData.role === 'moderator' ? '<p><span class="article-tag"><i class="fas fa-shield-alt"></i> Moderator</span></p>' : ''}
                            </div>
                        </div>
                    `;
                    
                    // Get user's articles
                    db.collection('articles')
                        .where('authorId', '==', currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .get()
                        .then((querySnapshot) => {
                            html += '<h2>My Articles</h2>';
                            
                            if (querySnapshot.empty) {
                                html += '<p>You have not created any articles yet.</p>';
                            } else {
                                html += '<ul class="article-list">';
                                querySnapshot.forEach((doc) => {
                                    const article = doc.data();
                                    const date = article.createdAt ? new Date(article.createdAt.toDate()).toLocaleString() : 'Unknown date';
                                    
                                    html += `
                                        <li class="article-list-item">
                                            <a href="#${doc.id}" class="article-list-title">${article.title}</a>
                                            <div class="article-list-summary">${article.summary}</div>
                                            <div class="article-list-meta">
                                                <span><i class="fas fa-calendar"></i> ${date}</span>
                                                <span><i class="fas fa-folder"></i> ${getCategoryName(article.category)}</span>
                                                <span><i class="fas fa-eye"></i> ${article.views || 0} views</span>
                                                <span><i class="fas fa-check-circle"></i> ${article.status}</span>
                                            </div>
                                        </li>
                                    `;
                                });
                                html += '</ul>';
                            }
                            
                            // Get user's contributions
                            db.collection('articles')
                                .where('contributors', 'array-contains', { id: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL, type: 'editor' })
                                .orderBy('updatedAt', 'desc')
                                .get()
                                .then((querySnapshot) => {
                                    html += '<h2>My Contributions</h2>';
                                    
                                    if (querySnapshot.empty) {
                                        html += '<p>You have not contributed to any articles yet.</p>';
                                    } else {
                                        html += '<ul class="article-list">';
                                        querySnapshot.forEach((doc) => {<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96597680a0721c69',t:'MTc1MzU5MTI3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
