<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Portal - Candidate Chat</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-badge {
            animation: pulse 2s infinite;
        }
        .highlighted-wrong {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .loading-dots {
            animation: loadingDots 1.5s infinite;
        }
        @keyframes loadingDots {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-xl">üèõÔ∏è</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Interview Portal</h1>
                        <p class="text-sm text-gray-600">Candidate Chat System</p>
                    </div>
                </div>
                <div class="text-right">
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Disconnected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <!-- Application ID Input Section -->
        <div id="loginSection" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üìã</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Enter Application Details</h2>
                <p class="text-gray-600">Please enter your Application ID or Acknowledgment Number</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Application ID / Acknowledgment Number</label>
                    <input type="text" id="applicationId" placeholder="Enter Application ID or Acknowledgment Number" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">You can use either your Application ID or Acknowledgment Number</p>
                </div>
                
                <button onclick="connectToChat()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                    <span id="connectButtonText">Connect to Officer</span>
                    <div id="loadingSpinner" class="hidden inline-block ml-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    </div>
                </button>
            </div>
            
            <!-- Validation Message -->
            <div id="validationMessage" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
        </div>

        <!-- Application Status Card -->
        <div id="statusCard" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Application Status</h3>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Candidate Name:</span>
                            <span id="candidateName" class="font-semibold text-blue-600"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Application ID:</span>
                            <span id="displayAppId" class="font-semibold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Acknowledgment No:</span>
                            <span id="acknowledgmentNumber" class="font-semibold text-blue-600"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span id="applicationStatus" class="px-3 py-1 rounded-full text-sm font-medium status-badge">Pending Review</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Created Date:</span>
                            <span id="createdDate" class="text-sm text-gray-500"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Last Updated:</span>
                            <span id="lastUpdated" class="text-sm text-gray-500"></span>
                        </div>
                    </div>
                </div>
                <div>
                    <div id="interviewDetails" class="hidden">
                        <h4 class="font-semibold text-gray-800 mb-2">Interview Details</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Location:</span>
                                <span id="interviewLocation"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Officer:</span>
                                <span id="assignedOfficer"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Date:</span>
                                <span id="interviewDate"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Application History -->
            <div id="applicationHistory" class="mt-6">
                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">üìã Application History</h4>
                <div id="historyTimeline" class="space-y-3">
                    <!-- History items will be populated here -->
                </div>
            </div>
            
            <!-- Office Notice -->
            <div id="officeNotice" class="hidden mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg">
                <div class="flex items-start">
                    <span class="text-yellow-600 mr-2">üì¢</span>
                    <div>
                        <h4 class="font-semibold text-yellow-800">Office Notice</h4>
                        <p id="noticeText" class="text-yellow-700 mt-1"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="chatInterface" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Chat Header -->
            <div class="bg-blue-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="font-bold">üë®‚Äçüíº</span>
                        </div>
                        <div>
                            <h3 class="font-semibold">Interview Officer</h3>
                            <p class="text-sm text-blue-200" id="officerStatus">Online</p>
                        </div>
                    </div>
                    <button onclick="disconnectChat()" class="text-blue-200 hover:text-white">
                        <span class="text-xl">‚úï</span>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="h-96 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <!-- Messages will be populated here -->
            </div>

            <!-- Message Input -->
            <div class="border-t bg-white p-4">
                <div class="flex space-x-3">
                    <input type="text" id="messageInput" placeholder="Type your message..." 
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Chartsheet Section -->
        <div id="chartsheetSection" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 mt-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">üìä Interview Chartsheet</h3>
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    Interview Completed
                </span>
            </div>
            
            <div id="chartsheetContent" class="space-y-6">
                <!-- Chartsheet content will be populated here -->
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                <div class="flex items-start">
                    <span class="text-blue-600 mr-2">‚ÑπÔ∏è</span>
                    <div>
                        <h4 class="font-semibold text-blue-800">Important Notice</h4>
                        <p class="text-blue-700 mt-1">This chartsheet has been prepared by the interview officer. Please review all details carefully.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "chat-d647c.firebaseapp.com",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:7248a0983dcf0d45a87418",
            measurementId: "G-5RFLRYTLCN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();

        let currentApplicationId = '';
        let messagesListener = null;

        // Connect to chat with Application ID or Acknowledgment Number
        async function connectToChat() {
            const inputValue = document.getElementById('applicationId').value.trim();
            if (!inputValue) {
                showValidationMessage('Please enter your Application ID or Acknowledgment Number', 'error');
                return;
            }

            // Show loading state
            showLoadingState(true);
            hideValidationMessage();

            try {
                let applicationData = null;
                let actualAppId = null;

                // First, try to find by Application ID
                const appDoc = await db.collection('applications').doc(inputValue).get();
                
                if (appDoc.exists) {
                    applicationData = appDoc.data();
                    actualAppId = inputValue;
                } else {
                    // If not found by Application ID, search by Acknowledgment Number
                    const acknowledgmentQuery = await db.collection('applications')
                        .where('acknowledgmentNumber', '==', inputValue)
                        .limit(1)
                        .get();
                    
                    if (!acknowledgmentQuery.empty) {
                        const doc = acknowledgmentQuery.docs[0];
                        applicationData = doc.data();
                        actualAppId = doc.id;
                    }
                }

                if (!applicationData) {
                    // Show invalid message for non-existent applications
                    showValidationMessage('‚ùå Invalid Application ID or Acknowledgment Number. Please check and try again.', 'error');
                    showLoadingState(false);
                    return;
                } else {
                    // Validate existing application
                    if (applicationData.validatedByFirestore) {
                        showValidationMessage('‚úÖ Application validated successfully!', 'success');
                    } else {
                        showValidationMessage('‚ö†Ô∏è Application found but needs validation', 'warning');
                    }
                }

                currentApplicationId = actualAppId;
                
                // Hide login section and show chat interface
                setTimeout(() => {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('statusCard').classList.remove('hidden');
                    document.getElementById('chatInterface').classList.remove('hidden');
                    
                    loadApplicationStatus();
                    initializeChat();
                    updateConnectionStatus('Connected', 'green');
                    showLoadingState(false);
                }, 1500);

            } catch (error) {
                console.error('Error connecting:', error);
                showValidationMessage('‚ùå Error connecting to system. Please try again.', 'error');
                showLoadingState(false);
            }
        }

        // Generate acknowledgment number
        function generateAcknowledgmentNumber() {
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `ACK${timestamp}${random}`;
        }

        // Show validation message
        function showValidationMessage(message, type) {
            const messageDiv = document.getElementById('validationMessage');
            messageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                messageDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            
            messageDiv.textContent = message;
        }

        // Hide validation message
        function hideValidationMessage() {
            document.getElementById('validationMessage').classList.add('hidden');
        }

        // Show loading state
        function showLoadingState(show) {
            const buttonText = document.getElementById('connectButtonText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (show) {
                buttonText.textContent = 'Validating...';
                spinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'Connect to Officer';
                spinner.classList.add('hidden');
            }
        }

        // Load application status
        async function loadApplicationStatus() {
            try {
                const appDoc = await db.collection('applications').doc(currentApplicationId).get();
                const appData = appDoc.data();

                // Update basic information
                document.getElementById('candidateName').textContent = appData.candidateName || 'N/A';
                document.getElementById('displayAppId').textContent = currentApplicationId;
                document.getElementById('acknowledgmentNumber').textContent = appData.acknowledgmentNumber || 'Not Generated';
                
                // Update status badge
                const statusElement = document.getElementById('applicationStatus');
                const status = appData.status || 'pending_review';
                
                statusElement.textContent = getStatusText(status);
                statusElement.className = `px-3 py-1 rounded-full text-sm font-medium status-badge ${getStatusColor(status)}`;

                // Update dates
                if (appData.createdAt) {
                    document.getElementById('createdDate').textContent = 
                        appData.createdAt.toDate().toLocaleDateString();
                }
                if (appData.lastUpdated) {
                    document.getElementById('lastUpdated').textContent = 
                        appData.lastUpdated.toDate().toLocaleString();
                }

                // Show interview details if scheduled
                if (appData.interviewScheduled && appData.interviewDetails) {
                    document.getElementById('interviewDetails').classList.remove('hidden');
                    document.getElementById('interviewLocation').textContent = appData.interviewDetails.location || 'TBD';
                    document.getElementById('assignedOfficer').textContent = appData.interviewDetails.officer || 'TBD';
                    document.getElementById('interviewDate').textContent = appData.interviewDetails.date || 'TBD';
                }

                // Display application history
                displayApplicationHistory(appData);

                // Show office notice if exists
                if (appData.officeNotice) {
                    document.getElementById('officeNotice').classList.remove('hidden');
                    document.getElementById('noticeText').textContent = appData.officeNotice;
                }

                // Show chartsheet if available
                if (appData.chartsheet && appData.interviewCompleted) {
                    displayChartsheet(appData.chartsheet);
                }

                // Listen for real-time updates
                db.collection('applications').doc(currentApplicationId).onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        loadApplicationStatus();
                        
                        // Check for new chartsheet
                        if (data.chartsheet && data.interviewCompleted && !document.getElementById('chartsheetSection').classList.contains('hidden')) {
                            displayChartsheet(data.chartsheet);
                        } else if (data.chartsheet && data.interviewCompleted) {
                            displayChartsheet(data.chartsheet);
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading application status:', error);
            }
        }

        // Get status text
        function getStatusText(status) {
            const statusMap = {
                'pending_review': 'Pending Review',
                'approved': 'Approved',
                'rejected': 'Rejected',
                'frozen': 'Frozen - Clarification Required',
                'interview_scheduled': 'Interview Scheduled'
            };
            return statusMap[status] || 'Unknown';
        }

        // Get status color
        function getStatusColor(status) {
            const colorMap = {
                'pending_review': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800',
                'frozen': 'bg-blue-100 text-blue-800',
                'interview_scheduled': 'bg-purple-100 text-purple-800'
            };
            return colorMap[status] || 'bg-gray-100 text-gray-800';
        }

        // Initialize chat
        async function initializeChat() {
            const chatRef = rtdb.ref(`chats/${currentApplicationId}/messages`);
            
            // Listen for new messages
            messagesListener = chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
            });

            // Get candidate name and send personalized welcome message
            try {
                const appDoc = await db.collection('applications').doc(currentApplicationId).get();
                const appData = appDoc.data();
                const candidateName = appData.candidateName || `Candidate_${currentApplicationId}`;
                
                // Send personalized welcome message
                setTimeout(() => {
                    displayMessage({
                        text: `Welcome ${candidateName}! You are successfully connected to the interview portal.`,
                        sender: 'system',
                        timestamp: Date.now(),
                        isWelcome: true
                    });
                    
                    // Send waiting message
                    setTimeout(() => {
                        displayMessage({
                            text: `Please wait, we are connecting you with an officer. You will be notified once the officer joins the chat.`,
                            sender: 'system',
                            timestamp: Date.now(),
                            isWaiting: true,
                            messageId: 'waiting_officer'
                        });
                    }, 1500);
                }, 1000);
                
                // Listen for officer connection status
                listenForOfficerConnection();
                
            } catch (error) {
                console.error('Error getting candidate name:', error);
                // Fallback welcome message
                setTimeout(() => {
                    displayMessage({
                        text: `Welcome! You are connected with Application ID: ${currentApplicationId}. An officer will assist you shortly.`,
                        sender: 'system',
                        timestamp: Date.now()
                    });
                }, 1000);
            }
        }

        // Send message with improved error handling
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentApplicationId) return;

            const message = {
                text: messageText,
                sender: 'candidate',
                senderId: currentApplicationId,
                timestamp: Date.now(),
                highlighted: false
            };

            try {
                // Use Firebase database push with better error handling
                const messagesRef = rtdb.ref(`chats/${currentApplicationId}/messages`);
                await messagesRef.push(message);
                messageInput.value = '';
                
                // Also update last activity
                await rtdb.ref(`chats/${currentApplicationId}/lastActivity`).set(Date.now());
                
            } catch (error) {
                console.error('Error sending message:', error);
                
                // Try alternative method if first fails
                try {
                    const messageId = Date.now().toString();
                    await rtdb.ref(`chats/${currentApplicationId}/messages/${messageId}`).set(message);
                    messageInput.value = '';
                } catch (secondError) {
                    console.error('Second attempt failed:', secondError);
                    
                    // Show user-friendly error with retry option
                    if (confirm('Message failed to send. Would you like to try again?')) {
                        sendMessage();
                    }
                }
            }
        }

        // Listen for officer connection
        function listenForOfficerConnection() {
            const officerStatusRef = rtdb.ref(`chats/${currentApplicationId}/officerConnected`);
            
            officerStatusRef.on('value', (snapshot) => {
                const officerConnected = snapshot.val();
                
                if (officerConnected) {
                    // Remove waiting message when officer connects
                    removeWaitingMessage();
                    
                    // Send officer connected message
                    displayMessage({
                        text: `‚úÖ An officer has joined the chat. You can now start your interview discussion.`,
                        sender: 'system',
                        timestamp: Date.now(),
                        isOfficerConnected: true
                    });
                    
                    // Update officer status in header
                    document.getElementById('officerStatus').textContent = 'Online - Connected';
                }
            });
        }

        // Remove waiting message
        function removeWaitingMessage() {
            const waitingMessage = document.querySelector('[data-message-id="waiting_officer"]');
            if (waitingMessage) {
                waitingMessage.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => {
                    waitingMessage.remove();
                }, 500);
            }
        }

        // Display message
        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';

            // Add message ID for tracking if provided
            if (message.messageId) {
                messageDiv.setAttribute('data-message-id', message.messageId);
            }

            const isCandidate = message.sender === 'candidate';
            const isSystem = message.sender === 'system';
            const isHighlighted = message.highlighted;
            const isWaiting = message.isWaiting;
            const isWelcome = message.isWelcome;
            const isOfficerConnected = message.isOfficerConnected;

            let senderName = 'Officer';
            let bgColor = 'bg-gray-100';
            let textAlign = 'text-left';
            let icon = '';

            if (isCandidate) {
                senderName = 'You';
                bgColor = 'bg-blue-100';
                textAlign = 'text-right ml-auto';
                icon = 'üë§';
            } else if (isSystem) {
                senderName = 'System';
                bgColor = 'bg-green-100';
                textAlign = 'text-center mx-auto';
                
                if (isWelcome) {
                    bgColor = 'bg-blue-100';
                    icon = 'üëã';
                } else if (isWaiting) {
                    bgColor = 'bg-yellow-100';
                    icon = '‚è≥';
                } else if (isOfficerConnected) {
                    bgColor = 'bg-green-100';
                    icon = '‚úÖ';
                } else {
                    icon = 'üîî';
                }
            } else {
                icon = 'üë®‚Äçüíº';
            }

            if (isHighlighted) {
                bgColor = 'bg-red-100 border-l-4 border-red-500';
                messageDiv.classList.add('highlighted-wrong');
            }

            // Add loading animation for waiting message
            const loadingDots = isWaiting ? '<span class="loading-dots">...</span>' : '';

            messageDiv.innerHTML = `
                <div class="max-w-xs md:max-w-md ${textAlign}">
                    <div class="${bgColor} rounded-lg p-3 shadow-sm">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-semibold text-gray-600 flex items-center">
                                <span class="mr-1">${icon}</span>
                                ${senderName}
                            </span>
                            <span class="text-xs text-gray-500">${new Date(message.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-gray-800">${message.text}${loadingDots}</p>
                        ${isHighlighted ? '<p class="text-xs text-red-600 mt-1">‚ö†Ô∏è This answer needs clarification</p>' : ''}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Disconnect chat
        function disconnectChat() {
            if (messagesListener) {
                rtdb.ref(`chats/${currentApplicationId}/messages`).off('child_added', messagesListener);
            }
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('statusCard').classList.add('hidden');
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('applicationId').value = '';
            currentApplicationId = '';
            updateConnectionStatus('Disconnected', 'gray');
        }

        // Update connection status
        function updateConnectionStatus(status, color) {
            const statusElement = document.getElementById('connectionStatus');
            const colorMap = {
                'green': 'bg-green-500',
                'gray': 'bg-gray-400',
                'red': 'bg-red-500'
            };
            
            statusElement.innerHTML = `
                <div class="w-3 h-3 ${colorMap[color]} rounded-full"></div>
                <span class="text-sm text-gray-600">${status}</span>
            `;
        }

        // Display chartsheet
        function displayChartsheet(chartsheetData) {
            const chartsheetSection = document.getElementById('chartsheetSection');
            const chartsheetContent = document.getElementById('chartsheetContent');
            
            chartsheetSection.classList.remove('hidden');
            
            let chartsheetHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-800 border-b pb-2">Personal Information</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Candidate Name:</span>
                                <span class="font-medium">${chartsheetData.candidateName || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Application ID:</span>
                                <span class="font-medium">${chartsheetData.applicationId || currentApplicationId}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Interview Date:</span>
                                <span class="font-medium">${chartsheetData.interviewDate || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Interview Officer:</span>
                                <span class="font-medium">${chartsheetData.interviewOfficer || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-800 border-b pb-2">Interview Results</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Overall Score:</span>
                                <span class="font-bold text-lg ${getScoreColor(chartsheetData.overallScore)}">${chartsheetData.overallScore || 'N/A'}/100</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Final Result:</span>
                                <span class="px-2 py-1 rounded text-xs font-medium ${getResultColor(chartsheetData.finalResult)}">${chartsheetData.finalResult || 'Pending'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Recommendation:</span>
                                <span class="font-medium">${chartsheetData.recommendation || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add questions and answers if available
            if (chartsheetData.questionsAnswers && chartsheetData.questionsAnswers.length > 0) {
                chartsheetHTML += `
                    <div class="mt-6">
                        <h4 class="font-semibold text-gray-800 border-b pb-2 mb-4">Interview Questions & Answers</h4>
                        <div class="space-y-4">
                `;
                
                chartsheetData.questionsAnswers.forEach((qa, index) => {
                    const scoreColor = qa.score >= 7 ? 'text-green-600' : qa.score >= 5 ? 'text-yellow-600' : 'text-red-600';
                    chartsheetHTML += `
                        <div class="border rounded-lg p-4 ${qa.highlighted ? 'bg-red-50 border-red-200' : 'bg-gray-50'}">
                            <div class="flex justify-between items-start mb-2">
                                <h5 class="font-medium text-gray-800">Question ${index + 1}</h5>
                                <span class="text-sm font-semibold ${scoreColor}">${qa.score || 0}/10</span>
                            </div>
                            <p class="text-gray-700 mb-2"><strong>Q:</strong> ${qa.question}</p>
                            <p class="text-gray-600 mb-2"><strong>A:</strong> ${qa.answer}</p>
                            ${qa.officerComment ? `<p class="text-sm text-blue-600"><strong>Officer Comment:</strong> ${qa.officerComment}</p>` : ''}
                            ${qa.highlighted ? '<p class="text-xs text-red-600 mt-1">‚ö†Ô∏è This answer was highlighted for review</p>' : ''}
                        </div>
                    `;
                });
                
                chartsheetHTML += `
                        </div>
                    </div>
                `;
            }
            
            // Add officer's final comments
            if (chartsheetData.finalComments) {
                chartsheetHTML += `
                    <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Officer's Final Comments</h4>
                        <p class="text-blue-700">${chartsheetData.finalComments}</p>
                    </div>
                `;
            }
            
            chartsheetContent.innerHTML = chartsheetHTML;
        }
        
        // Get score color
        function getScoreColor(score) {
            if (score >= 70) return 'text-green-600';
            if (score >= 50) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        // Get result color
        function getResultColor(result) {
            if (result === 'Selected' || result === 'Passed') return 'bg-green-100 text-green-800';
            if (result === 'Rejected' || result === 'Failed') return 'bg-red-100 text-red-800';
            if (result === 'Waitlist') return 'bg-yellow-100 text-yellow-800';
            return 'bg-gray-100 text-gray-800';
        }

        // Display application history
        function displayApplicationHistory(appData) {
            const historyTimeline = document.getElementById('historyTimeline');
            let historyHTML = '';
            
            // Create history events based on application data
            const historyEvents = [];
            
            // Application created
            if (appData.createdAt) {
                historyEvents.push({
                    date: appData.createdAt.toDate(),
                    title: 'Application Submitted',
                    description: `Application ${currentApplicationId} was successfully submitted`,
                    icon: 'üìù',
                    color: 'bg-blue-100 text-blue-800'
                });
            }
            
            // Acknowledgment generated
            if (appData.acknowledgmentNumber) {
                historyEvents.push({
                    date: appData.createdAt ? appData.createdAt.toDate() : new Date(),
                    title: 'Acknowledgment Generated',
                    description: `Acknowledgment Number: ${appData.acknowledgmentNumber}`,
                    icon: 'üé´',
                    color: 'bg-green-100 text-green-800'
                });
            }
            
            // Status changes
            if (appData.statusHistory && appData.statusHistory.length > 0) {
                appData.statusHistory.forEach(statusChange => {
                    historyEvents.push({
                        date: statusChange.timestamp.toDate(),
                        title: `Status Changed to ${getStatusText(statusChange.status)}`,
                        description: statusChange.reason || 'Status updated by system',
                        icon: getStatusIcon(statusChange.status),
                        color: getStatusHistoryColor(statusChange.status)
                    });
                });
            } else {
                // Default status entry
                historyEvents.push({
                    date: appData.lastUpdated ? appData.lastUpdated.toDate() : new Date(),
                    title: `Current Status: ${getStatusText(appData.status)}`,
                    description: 'Application is under review',
                    icon: getStatusIcon(appData.status),
                    color: getStatusHistoryColor(appData.status)
                });
            }
            
            // Interview scheduled
            if (appData.interviewScheduled && appData.interviewDetails) {
                historyEvents.push({
                    date: appData.interviewDetails.scheduledDate ? new Date(appData.interviewDetails.scheduledDate) : new Date(),
                    title: 'Interview Scheduled',
                    description: `Interview scheduled with ${appData.interviewDetails.officer || 'Officer'} at ${appData.interviewDetails.location || 'TBD'}`,
                    icon: 'üìÖ',
                    color: 'bg-purple-100 text-purple-800'
                });
            }
            
            // Interview completed
            if (appData.interviewCompleted) {
                historyEvents.push({
                    date: appData.interviewCompletedDate ? appData.interviewCompletedDate.toDate() : new Date(),
                    title: 'Interview Completed',
                    description: 'Interview has been completed successfully',
                    icon: '‚úÖ',
                    color: 'bg-green-100 text-green-800'
                });
            }
            
            // Chartsheet generated
            if (appData.chartsheet) {
                historyEvents.push({
                    date: appData.chartsheetGeneratedDate ? appData.chartsheetGeneratedDate.toDate() : new Date(),
                    title: 'Chartsheet Generated',
                    description: `Final result: ${appData.chartsheet.finalResult || 'Pending'}`,
                    icon: 'üìä',
                    color: 'bg-indigo-100 text-indigo-800'
                });
            }
            
            // Sort events by date (newest first)
            historyEvents.sort((a, b) => b.date - a.date);
            
            // Generate HTML for history timeline
            historyEvents.forEach((event, index) => {
                historyHTML += `
                    <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 ${event.color} rounded-full flex items-center justify-center text-sm">
                                ${event.icon}
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h5 class="text-sm font-medium text-gray-900">${event.title}</h5>
                                <span class="text-xs text-gray-500">${event.date.toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${event.description}</p>
                            <span class="text-xs text-gray-400">${event.date.toLocaleTimeString()}</span>
                        </div>
                    </div>
                `;
            });
            
            if (historyHTML === '') {
                historyHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <span class="text-2xl">üìã</span>
                        <p class="mt-2">No history available yet</p>
                    </div>
                `;
            }
            
            historyTimeline.innerHTML = historyHTML;
        }
        
        // Get status icon
        function getStatusIcon(status) {
            const iconMap = {
                'pending_review': '‚è≥',
                'approved': '‚úÖ',
                'rejected': '‚ùå',
                'frozen': 'üîí',
                'interview_scheduled': 'üìÖ'
            };
            return iconMap[status] || 'üìÑ';
        }
        
        // Get status history color
        function getStatusHistoryColor(status) {
            const colorMap = {
                'pending_review': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800',
                'frozen': 'bg-blue-100 text-blue-800',
                'interview_scheduled': 'bg-purple-100 text-purple-800'
            };
            return colorMap[status] || 'bg-gray-100 text-gray-800';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('Ready to Connect', 'gray');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96825a7065c08ae1',t:'MTc1NDAyMDAzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Officer Portal - Interview Management</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        .chat-notification {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen">
    <!-- Login Section -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full mx-4">
            <div class="bg-white rounded-xl shadow-2xl p-8">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl text-white">üë®‚Äçüíº</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">Admin Officer Portal</h1>
                    <p class="text-gray-600 mt-2">Interview Management System</p>
                </div>
                
                <form onsubmit="adminLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="adminEmail" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="Enter your admin email">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="adminPassword" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="Enter your password">
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                        <span id="loginButtonText">Login to Admin Panel</span>
                        <div id="loginSpinner" class="hidden inline-block ml-2">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        </div>
                    </button>
                </form>
                
                <div id="loginError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b-4 border-indigo-600">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-xl">üë®‚Äçüíº</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Admin Officer Portal</h1>
                            <p class="text-sm text-gray-600">Interview Management System</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-800">Welcome, Officer</p>
                            <p class="text-xs text-gray-500" id="currentTime"></p>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Stats -->
        <div class="container mx-auto px-4 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Applications</p>
                            <p class="text-3xl font-bold text-indigo-600" id="totalApplications">0</p>
                        </div>
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">üìã</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Pending Review</p>
                            <p class="text-3xl font-bold text-yellow-600" id="pendingApplications">0</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">‚è≥</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Active Chats</p>
                            <p class="text-3xl font-bold text-green-600" id="activeChats">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">üí¨</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Interviews Today</p>
                            <p class="text-3xl font-bold text-purple-600" id="interviewsToday">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">üéØ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="showTab('applications')" id="applicationsTab" 
                                class="py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600">
                            Applications Management
                        </button>
                        <button onclick="showTab('chats')" id="chatsTab"
                                class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Active Chats
                        </button>
                        <button onclick="showTab('interviews')" id="interviewsTab"
                                class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Interview Management
                        </button>
                    </nav>
                </div>

                <!-- Applications Tab -->
                <div id="applicationsContent" class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Applications Management</h3>
                        <div class="flex space-x-3">
                            <select id="statusFilter" onchange="filterApplications()" 
                                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Status</option>
                                <option value="pending_review">Pending Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="frozen">Frozen</option>
                                <option value="interview_scheduled">Interview Scheduled</option>
                            </select>
                            <input type="text" id="searchApplications" placeholder="Search applications..." 
                                   onkeyup="searchApplications()"
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Candidate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Applications will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Chats Tab -->
                <div id="chatsContent" class="hidden p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Active Chat Sessions</h3>
                        <button onclick="refreshChats()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                            Refresh Chats
                        </button>
                    </div>
                    
                    <div id="activeChatsList" class="space-y-4">
                        <!-- Active chats will be populated here -->
                    </div>
                </div>

                <!-- Interviews Tab -->
                <div id="interviewsContent" class="hidden p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Interview Management</h3>
                        <button onclick="scheduleNewInterview()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                            Schedule New Interview
                        </button>
                    </div>
                    
                    <div id="interviewsList" class="space-y-4">
                        <!-- Interviews will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
            <div class="bg-indigo-600 text-white p-4 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Chat with Candidate</h3>
                    <p class="text-sm text-indigo-200" id="chatCandidateInfo">Application ID: </p>
                </div>
                <button onclick="closeChatModal()" class="text-indigo-200 hover:text-white">
                    <span class="text-2xl">√ó</span>
                </button>
            </div>
            
            <div id="chatMessages" class="h-96 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <!-- Chat messages will be populated here -->
            </div>
            
            <div class="border-t bg-white">
                <!-- Advanced Chat Controls -->
                <div class="bg-gray-50 px-4 py-2 border-b">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600">Chat Controls:</span>
                            <button onclick="toggleChatTimer()" id="timerButton"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                                Start Timer
                            </button>
                            <span id="chatTimer" class="font-mono text-blue-600 font-semibold">00:00:00</span>
                            <button onclick="pauseChat()" id="pauseButton"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs">
                                Pause Chat
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-600">Quick Score:</span>
                            <select id="quickScore" onchange="assignQuickScore()" class="px-2 py-1 border rounded text-xs">
                                <option value="">Select Score</option>
                                <option value="10">Excellent (10/10)</option>
                                <option value="9">Very Good (9/10)</option>
                                <option value="8">Good (8/10)</option>
                                <option value="7">Average (7/10)</option>
                                <option value="6">Below Average (6/10)</option>
                                <option value="5">Poor (5/10)</option>
                                <option value="0">No Score</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Message Input Area -->
                <div class="p-4">
                    <div class="flex space-x-3 mb-3">
                        <input type="text" id="officerMessageInput" placeholder="Type your message..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               onkeypress="handleOfficerKeyPress(event)">
                        <button onclick="sendOfficerMessage()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition duration-200">
                            Send
                        </button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="highlightLastMessage()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            üî¥ Highlight Last
                        </button>
                        <button onclick="correctLastMessage()" 
                                class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                            ‚úèÔ∏è Correct Answer
                        </button>
                        <button onclick="scoreLastMessage()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                            ‚≠ê Score Answer
                        </button>
                        <button onclick="addOfficerNote()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm">
                            üìù Add Note
                        </button>
                        <button onclick="sendQuickResponse()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                            ‚ö° Quick Response
                        </button>
                        <button onclick="endInterview()" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                            üèÅ End Interview
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "chat-d647c.firebaseapp.com",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:7248a0983dcf0d45a87418",
            measurementId: "G-5RFLRYTLCN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Admin credentials (private)
        const ADMIN_EMAIL = 'sgursharn076@gmail.com';
        const ADMIN_PASSWORD = '7973804008';

        let currentChatId = '';
        let chatMessagesListener = null;
        let applicationsData = [];
        let chatTimer = null;
        let chatStartTime = null;
        let chatPaused = false;
        let totalPausedTime = 0;
        let pauseStartTime = null;
        let currentQuestionScore = null;
        let interviewNotes = [];

        // Admin login
        function adminLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            // Show loading state
            document.getElementById('loginButtonText').textContent = 'Authenticating...';
            document.getElementById('loginSpinner').classList.remove('hidden');
            
            // Validate credentials
            setTimeout(() => {
                if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                    // Successful login
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminDashboard').classList.add('fade-in');
                    
                    // Initialize dashboard
                    initializeDashboard();
                    updateCurrentTime();
                    setInterval(updateCurrentTime, 1000);
                    
                } else {
                    // Failed login
                    showLoginError('Invalid email or password. Please try again.');
                }
                
                // Reset button state
                document.getElementById('loginButtonText').textContent = 'Login to Admin Panel';
                document.getElementById('loginSpinner').classList.add('hidden');
            }, 1500);
        }

        // Show login error
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString();
        }

        // Initialize dashboard
        async function initializeDashboard() {
            await loadDashboardStats();
            await loadApplications();
            await loadActiveChats();
            
            // Set up real-time listeners
            setupRealTimeListeners();
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const applicationsSnapshot = await db.collection('applications').get();
                const applications = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                document.getElementById('totalApplications').textContent = applications.length;
                
                const pendingCount = applications.filter(app => app.status === 'pending_review').length;
                document.getElementById('pendingApplications').textContent = pendingCount;
                
                // Count active chats (simplified)
                const activeChatsCount = applications.filter(app => app.status !== 'rejected').length;
                document.getElementById('activeChats').textContent = activeChatsCount;
                
                // Count interviews today (simplified)
                const today = new Date().toDateString();
                const interviewsToday = applications.filter(app => 
                    app.interviewScheduled && 
                    app.interviewDetails && 
                    new Date(app.interviewDetails.date).toDateString() === today
                ).length;
                document.getElementById('interviewsToday').textContent = interviewsToday;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load applications
        async function loadApplications() {
            try {
                const applicationsSnapshot = await db.collection('applications').orderBy('createdAt', 'desc').get();
                applicationsData = applicationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                displayApplications(applicationsData);
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        // Display applications in table
        function displayApplications(applications) {
            const tableBody = document.getElementById('applicationsTableBody');
            let tableHTML = '';
            
            applications.forEach(app => {
                const createdDate = app.createdAt ? app.createdAt.toDate().toLocaleDateString() : 'N/A';
                const statusBadge = getStatusBadge(app.status);
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${app.id}</div>
                            <div class="text-sm text-gray-500">${app.acknowledgmentNumber || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${app.candidateName || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${createdDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="viewApplication('${app.id}')" class="text-indigo-600 hover:text-indigo-900">View</button>
                            <button onclick="joinChat('${app.id}')" class="text-green-600 hover:text-green-900">Chat</button>
                            <button onclick="updateStatus('${app.id}')" class="text-blue-600 hover:text-blue-900">Update</button>
                        </td>
                    </tr>
                `;
            });
            
            if (tableHTML === '') {
                tableHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No applications found
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const statusMap = {
                'pending_review': { text: 'Pending Review', class: 'bg-yellow-100 text-yellow-800' },
                'approved': { text: 'Approved', class: 'bg-green-100 text-green-800' },
                'rejected': { text: 'Rejected', class: 'bg-red-100 text-red-800' },
                'frozen': { text: 'Frozen', class: 'bg-blue-100 text-blue-800' },
                'interview_scheduled': { text: 'Interview Scheduled', class: 'bg-purple-100 text-purple-800' }
            };
            
            const statusInfo = statusMap[status] || { text: 'Unknown', class: 'bg-gray-100 text-gray-800' };
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        // Filter applications
        function filterApplications() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchApplications').value.toLowerCase();
            
            let filteredApps = applicationsData;
            
            if (statusFilter !== 'all') {
                filteredApps = filteredApps.filter(app => app.status === statusFilter);
            }
            
            if (searchTerm) {
                filteredApps = filteredApps.filter(app => 
                    app.id.toLowerCase().includes(searchTerm) ||
                    (app.candidateName && app.candidateName.toLowerCase().includes(searchTerm)) ||
                    (app.acknowledgmentNumber && app.acknowledgmentNumber.toLowerCase().includes(searchTerm))
                );
            }
            
            displayApplications(filteredApps);
        }

        // Search applications
        function searchApplications() {
            filterApplications();
        }

        // Show tab
        function showTab(tabName) {
            // Hide all tab contents
            document.getElementById('applicationsContent').classList.add('hidden');
            document.getElementById('chatsContent').classList.add('hidden');
            document.getElementById('interviewsContent').classList.add('hidden');
            
            // Remove active class from all tabs
            document.getElementById('applicationsTab').className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700';
            document.getElementById('chatsTab').className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700';
            document.getElementById('interviewsTab').className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700';
            
            // Show selected tab content and activate tab
            if (tabName === 'applications') {
                document.getElementById('applicationsContent').classList.remove('hidden');
                document.getElementById('applicationsTab').className = 'py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600';
            } else if (tabName === 'chats') {
                document.getElementById('chatsContent').classList.remove('hidden');
                document.getElementById('chatsTab').className = 'py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600';
                loadActiveChats();
            } else if (tabName === 'interviews') {
                document.getElementById('interviewsContent').classList.remove('hidden');
                document.getElementById('interviewsTab').className = 'py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600';
                loadInterviews();
            }
        }

        // Load active chats
        async function loadActiveChats() {
            try {
                const chatsContainer = document.getElementById('activeChatsList');
                let chatsHTML = '';
                
                // Get applications that might have active chats
                const applications = applicationsData.filter(app => app.status !== 'rejected');
                
                for (const app of applications) {
                    // Check if there are messages in this chat
                    const messagesSnapshot = await rtdb.ref(`chats/${app.id}/messages`).limitToLast(1).once('value');
                    
                    if (messagesSnapshot.exists()) {
                        const lastMessage = Object.values(messagesSnapshot.val())[0];
                        const lastMessageTime = new Date(lastMessage.timestamp).toLocaleString();
                        
                        chatsHTML += `
                            <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                            <span class="text-indigo-600 font-semibold">${app.candidateName ? app.candidateName.charAt(0) : 'C'}</span>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">${app.candidateName || 'Candidate'}</h4>
                                            <p class="text-sm text-gray-500">Application ID: ${app.id}</p>
                                            <p class="text-xs text-gray-400">Last message: ${lastMessageTime}</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <span class="w-3 h-3 bg-green-500 rounded-full pulse-dot"></span>
                                        <button onclick="joinChat('${app.id}')" 
                                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                            Join Chat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                if (chatsHTML === '') {
                    chatsHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="text-4xl">üí¨</span>
                            <p class="mt-2">No active chats found</p>
                        </div>
                    `;
                }
                
                chatsContainer.innerHTML = chatsHTML;
            } catch (error) {
                console.error('Error loading active chats:', error);
            }
        }

        // Join chat
        async function joinChat(applicationId) {
            currentChatId = applicationId;
            
            // Get application data
            const app = applicationsData.find(a => a.id === applicationId);
            document.getElementById('chatCandidateInfo').textContent = 
                `Application ID: ${applicationId} - ${app ? app.candidateName || 'Candidate' : 'Candidate'}`;
            
            // Set officer as connected
            await rtdb.ref(`chats/${applicationId}/officerConnected`).set(true);
            
            // Show chat modal
            document.getElementById('chatModal').classList.remove('hidden');
            
            // Load chat messages
            loadChatMessages(applicationId);
        }

        // Load chat messages
        function loadChatMessages(applicationId) {
            const chatMessagesContainer = document.getElementById('chatMessages');
            chatMessagesContainer.innerHTML = '';
            
            // Listen for messages
            if (chatMessagesListener) {
                rtdb.ref(`chats/${currentChatId}/messages`).off('child_added', chatMessagesListener);
            }
            
            chatMessagesListener = rtdb.ref(`chats/${applicationId}/messages`).on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayChatMessage(message, snapshot.key);
            });
        }

        // Display chat message
        function displayChatMessage(message, messageKey) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.setAttribute('data-message-key', messageKey);

            const isCandidate = message.sender === 'candidate';
            const isSystem = message.sender === 'system';
            const isOfficer = message.sender === 'officer';
            const isHighlighted = message.highlighted;

            let senderName = 'System';
            let bgColor = 'bg-gray-100';
            let textAlign = 'text-left';
            let icon = 'üîî';

            if (isCandidate) {
                senderName = 'Candidate';
                bgColor = 'bg-blue-100';
                textAlign = 'text-left';
                icon = 'üë§';
            } else if (isOfficer) {
                senderName = 'Officer (You)';
                bgColor = 'bg-green-100';
                textAlign = 'text-right ml-auto';
                icon = 'üë®‚Äçüíº';
            } else if (isSystem) {
                senderName = 'System';
                bgColor = 'bg-gray-100';
                textAlign = 'text-center mx-auto';
                icon = 'üîî';
            }

            if (isHighlighted) {
                bgColor = 'bg-red-100 border-l-4 border-red-500';
            }

            // Special styling for different message types
            let specialBadge = '';
            if (message.isCorrection) {
                specialBadge = '<span class="inline-block bg-orange-500 text-white text-xs px-2 py-1 rounded-full ml-2">Correction</span>';
            } else if (message.isScore) {
                specialBadge = '<span class="inline-block bg-green-500 text-white text-xs px-2 py-1 rounded-full ml-2">Score</span>';
            } else if (message.isPrivateNote) {
                specialBadge = '<span class="inline-block bg-purple-500 text-white text-xs px-2 py-1 rounded-full ml-2">Private Note</span>';
                bgColor = 'bg-purple-50 border-l-4 border-purple-400';
            } else if (message.isQuickResponse) {
                specialBadge = '<span class="inline-block bg-blue-500 text-white text-xs px-2 py-1 rounded-full ml-2">Quick</span>';
            }

            messageDiv.innerHTML = `
                <div class="max-w-xs md:max-w-md ${textAlign}">
                    <div class="${bgColor} rounded-lg p-3 shadow-sm">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-semibold text-gray-600 flex items-center">
                                <span class="mr-1">${icon}</span>
                                ${senderName}
                                ${specialBadge}
                            </span>
                            <span class="text-xs text-gray-500">${new Date(message.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-gray-800">${message.text}</p>
                        ${isHighlighted ? '<p class="text-xs text-red-600 mt-1">‚ö†Ô∏è Highlighted for review</p>' : ''}
                        ${message.scoreValue ? `<p class="text-xs text-green-600 mt-1">‚≠ê Score: ${message.scoreValue}/10</p>` : ''}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send officer message
        async function sendOfficerMessage() {
            const messageInput = document.getElementById('officerMessageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChatId) return;

            const message = {
                text: messageText,
                sender: 'officer',
                senderId: 'admin_officer',
                timestamp: Date.now(),
                highlighted: false
            };

            try {
                // Use Firebase database push with better error handling
                const messagesRef = rtdb.ref(`chats/${currentChatId}/messages`);
                await messagesRef.push(message);
                messageInput.value = '';
                
                // Also update last activity
                await rtdb.ref(`chats/${currentChatId}/lastActivity`).set(Date.now());
                
            } catch (error) {
                console.error('Error sending message:', error);
                
                // Try alternative method if first fails
                try {
                    const messageId = Date.now().toString();
                    await rtdb.ref(`chats/${currentChatId}/messages/${messageId}`).set(message);
                    messageInput.value = '';
                } catch (secondError) {
                    console.error('Second attempt failed:', secondError);
                    
                    // Show user-friendly error with retry option
                    if (confirm('Message failed to send. Would you like to try again?')) {
                        sendOfficerMessage();
                    }
                }
            }
        }

        // Handle officer key press
        function handleOfficerKeyPress(event) {
            if (event.key === 'Enter') {
                sendOfficerMessage();
            }
        }

        // Highlight last message
        async function highlightLastMessage() {
            if (!currentChatId) return;
            
            try {
                // Get the last candidate message
                const messagesSnapshot = await rtdb.ref(`chats/${currentChatId}/messages`)
                    .orderByChild('sender')
                    .equalTo('candidate')
                    .limitToLast(1)
                    .once('value');
                
                if (messagesSnapshot.exists()) {
                    const messages = messagesSnapshot.val();
                    const messageKey = Object.keys(messages)[0];
                    
                    // Update the message to be highlighted
                    await rtdb.ref(`chats/${currentChatId}/messages/${messageKey}`).update({
                        highlighted: true
                    });
                    
                    alert('Last candidate message has been highlighted for review.');
                } else {
                    alert('No candidate messages found to highlight.');
                }
            } catch (error) {
                console.error('Error highlighting message:', error);
                alert('Error highlighting message. Please try again.');
            }
        }

        // Close chat modal
        function closeChatModal() {
            document.getElementById('chatModal').classList.add('hidden');
            
            // Disconnect officer
            if (currentChatId) {
                rtdb.ref(`chats/${currentChatId}/officerConnected`).set(false);
            }
            
            // Clean up listener
            if (chatMessagesListener) {
                rtdb.ref(`chats/${currentChatId}/messages`).off('child_added', chatMessagesListener);
                chatMessagesListener = null;
            }
            
            // Reset chat variables
            if (chatTimer) {
                clearInterval(chatTimer);
                chatTimer = null;
            }
            chatStartTime = null;
            chatPaused = false;
            totalPausedTime = 0;
            pauseStartTime = null;
            currentQuestionScore = null;
            interviewNotes = [];
            
            // Reset UI elements
            document.getElementById('timerButton').textContent = 'Start Timer';
            document.getElementById('timerButton').className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs';
            document.getElementById('chatTimer').textContent = '00:00:00';
            document.getElementById('pauseButton').textContent = 'Pause Chat';
            document.getElementById('pauseButton').className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs';
            document.getElementById('quickScore').value = '';
            
            currentChatId = '';
        }

        // View application details
        function viewApplication(applicationId) {
            const app = applicationsData.find(a => a.id === applicationId);
            if (app) {
                alert(`Application Details:\n\nID: ${app.id}\nCandidate: ${app.candidateName || 'N/A'}\nStatus: ${app.status}\nAcknowledgment: ${app.acknowledgmentNumber || 'N/A'}\nCreated: ${app.createdAt ? app.createdAt.toDate().toLocaleString() : 'N/A'}`);
            }
        }

        // Update application status
        async function updateStatus(applicationId) {
            const newStatus = prompt('Enter new status:\n- pending_review\n- approved\n- rejected\n- frozen\n- interview_scheduled');
            
            if (newStatus && ['pending_review', 'approved', 'rejected', 'frozen', 'interview_scheduled'].includes(newStatus)) {
                try {
                    await db.collection('applications').doc(applicationId).update({
                        status: newStatus,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Status updated successfully!');
                    loadApplications();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Error updating status:', error);
                    alert('Error updating status. Please try again.');
                }
            } else if (newStatus) {
                alert('Invalid status. Please use one of the provided options.');
            }
        }

        // Load interviews
        function loadInterviews() {
            const interviewsList = document.getElementById('interviewsList');
            const scheduledInterviews = applicationsData.filter(app => app.interviewScheduled);
            
            let interviewsHTML = '';
            
            scheduledInterviews.forEach(app => {
                const interviewDate = app.interviewDetails ? app.interviewDetails.date : 'TBD';
                const interviewLocation = app.interviewDetails ? app.interviewDetails.location : 'TBD';
                const assignedOfficer = app.interviewDetails ? app.interviewDetails.officer : 'TBD';
                
                interviewsHTML += `
                    <div class="bg-white border rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-900">${app.candidateName || 'Candidate'}</h4>
                                <p class="text-sm text-gray-500">Application ID: ${app.id}</p>
                                <p class="text-sm text-gray-500">Date: ${interviewDate}</p>
                                <p class="text-sm text-gray-500">Location: ${interviewLocation}</p>
                                <p class="text-sm text-gray-500">Officer: ${assignedOfficer}</p>
                            </div>
                            <div class="space-x-2">
                                <button onclick="joinChat('${app.id}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    Start Interview
                                </button>
                                <button onclick="completeInterview('${app.id}')" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                    Complete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (interviewsHTML === '') {
                interviewsHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-4xl">üìÖ</span>
                        <p class="mt-2">No scheduled interviews found</p>
                    </div>
                `;
            }
            
            interviewsList.innerHTML = interviewsHTML;
        }

        // Complete interview
        async function completeInterview(applicationId) {
            const finalResult = prompt('Enter final result (Selected/Rejected/Waitlist):');
            const overallScore = prompt('Enter overall score (0-100):');
            
            if (finalResult && overallScore) {
                try {
                    const chartsheet = {
                        applicationId: applicationId,
                        candidateName: applicationsData.find(a => a.id === applicationId)?.candidateName || 'N/A',
                        interviewDate: new Date().toLocaleDateString(),
                        interviewOfficer: 'Admin Officer',
                        overallScore: parseInt(overallScore),
                        finalResult: finalResult,
                        recommendation: finalResult === 'Selected' ? 'Recommended for selection' : 'Not recommended',
                        finalComments: 'Interview completed by admin officer'
                    };
                    
                    await db.collection('applications').doc(applicationId).update({
                        interviewCompleted: true,
                        interviewCompletedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        chartsheet: chartsheet,
                        status: finalResult === 'Selected' ? 'approved' : 'rejected',
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Interview completed and chartsheet generated!');
                    loadApplications();
                    loadInterviews();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Error completing interview:', error);
                    alert('Error completing interview. Please try again.');
                }
            }
        }

        // Schedule new interview
        function scheduleNewInterview() {
            const applicationId = prompt('Enter Application ID to schedule interview:');
            if (applicationId) {
                const app = applicationsData.find(a => a.id === applicationId);
                if (app) {
                    const interviewDate = prompt('Enter interview date (YYYY-MM-DD):');
                    const interviewLocation = prompt('Enter interview location:');
                    const assignedOfficer = prompt('Enter assigned officer name:') || 'Admin Officer';
                    
                    if (interviewDate && interviewLocation) {
                        db.collection('applications').doc(applicationId).update({
                            interviewScheduled: true,
                            interviewDetails: {
                                date: interviewDate,
                                location: interviewLocation,
                                officer: assignedOfficer,
                                scheduledDate: new Date().toISOString()
                            },
                            status: 'interview_scheduled',
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            alert('Interview scheduled successfully!');
                            loadApplications();
                            loadInterviews();
                            loadDashboardStats();
                        }).catch(error => {
                            console.error('Error scheduling interview:', error);
                            alert('Error scheduling interview. Please try again.');
                        });
                    }
                } else {
                    alert('Application not found!');
                }
            }
        }

        // Refresh chats
        function refreshChats() {
            loadActiveChats();
        }

        // Setup real-time listeners
        function setupRealTimeListeners() {
            // Listen for new applications
            db.collection('applications').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        loadApplications();
                        loadDashboardStats();
                    }
                });
            });
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clean up listeners
                if (chatMessagesListener) {
                    rtdb.ref(`chats/${currentChatId}/messages`).off('child_added', chatMessagesListener);
                }
                
                // Reset form
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                
                // Show login section
                document.getElementById('adminDashboard').classList.add('hidden');
                document.getElementById('loginSection').classList.remove('hidden');
            }
        }

        // Toggle chat timer
        function toggleChatTimer() {
            const timerButton = document.getElementById('timerButton');
            const timerDisplay = document.getElementById('chatTimer');
            
            if (!chatTimer) {
                // Start timer
                chatStartTime = Date.now();
                totalPausedTime = 0;
                timerButton.textContent = 'Stop Timer';
                timerButton.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs';
                
                chatTimer = setInterval(() => {
                    if (!chatPaused) {
                        const elapsed = Date.now() - chatStartTime - totalPausedTime;
                        const hours = Math.floor(elapsed / 3600000);
                        const minutes = Math.floor((elapsed % 3600000) / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        
                        timerDisplay.textContent = 
                            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
                
                // Send timer start message
                sendSystemMessage('‚è∞ Interview timer started');
            } else {
                // Stop timer
                clearInterval(chatTimer);
                chatTimer = null;
                timerButton.textContent = 'Start Timer';
                timerButton.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs';
                
                // Send timer stop message
                const finalTime = timerDisplay.textContent;
                sendSystemMessage(`‚è∞ Interview timer stopped. Total time: ${finalTime}`);
            }
        }

        // Pause/Resume chat
        function pauseChat() {
            const pauseButton = document.getElementById('pauseButton');
            
            if (!chatPaused) {
                // Pause chat
                chatPaused = true;
                pauseStartTime = Date.now();
                pauseButton.textContent = 'Resume Chat';
                pauseButton.className = 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs';
                
                sendSystemMessage('‚è∏Ô∏è Chat paused by officer');
            } else {
                // Resume chat
                chatPaused = false;
                totalPausedTime += Date.now() - pauseStartTime;
                pauseButton.textContent = 'Pause Chat';
                pauseButton.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs';
                
                sendSystemMessage('‚ñ∂Ô∏è Chat resumed by officer');
            }
        }

        // Assign quick score
        function assignQuickScore() {
            const scoreSelect = document.getElementById('quickScore');
            const score = scoreSelect.value;
            
            if (score) {
                currentQuestionScore = parseInt(score);
                const scoreText = score === '0' ? 'No Score' : `${score}/10`;
                sendSystemMessage(`‚≠ê Officer assigned score: ${scoreText} for the last answer`);
                scoreSelect.value = '';
            }
        }

        // Correct last message
        async function correctLastMessage() {
            if (!currentChatId) return;
            
            const correction = prompt('Enter the correct answer or clarification:');
            if (correction) {
                const message = {
                    text: `‚úèÔ∏è Correction/Clarification: ${correction}`,
                    sender: 'officer',
                    senderId: 'admin_officer',
                    timestamp: Date.now(),
                    highlighted: false,
                    isCorrection: true
                };
                
                try {
                    await rtdb.ref(`chats/${currentChatId}/messages`).push(message);
                    
                    // Add to interview notes
                    interviewNotes.push({
                        type: 'correction',
                        text: correction,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Error sending correction:', error);
                }
            }
        }

        // Score last message
        async function scoreLastMessage() {
            if (!currentChatId) return;
            
            const score = prompt('Enter score for the last answer (0-10):');
            if (score && !isNaN(score) && score >= 0 && score <= 10) {
                const message = {
                    text: `‚≠ê Score assigned: ${score}/10 for the previous answer`,
                    sender: 'officer',
                    senderId: 'admin_officer',
                    timestamp: Date.now(),
                    highlighted: false,
                    isScore: true,
                    scoreValue: parseInt(score)
                };
                
                try {
                    await rtdb.ref(`chats/${currentChatId}/messages`).push(message);
                    
                    // Add to interview notes
                    interviewNotes.push({
                        type: 'score',
                        score: parseInt(score),
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Error sending score:', error);
                }
            } else if (score) {
                alert('Please enter a valid score between 0 and 10');
            }
        }

        // Add officer note
        async function addOfficerNote() {
            if (!currentChatId) return;
            
            const note = prompt('Enter your private note (visible only to officers):');
            if (note) {
                const message = {
                    text: `üìù Officer Note: ${note}`,
                    sender: 'officer',
                    senderId: 'admin_officer',
                    timestamp: Date.now(),
                    highlighted: false,
                    isPrivateNote: true
                };
                
                try {
                    await rtdb.ref(`chats/${currentChatId}/messages`).push(message);
                    
                    // Add to interview notes
                    interviewNotes.push({
                        type: 'note',
                        text: note,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Error sending note:', error);
                }
            }
        }

        // Send quick response
        async function sendQuickResponse() {
            const responses = [
                'Thank you for your answer.',
                'Please elaborate on that.',
                'Can you give me a specific example?',
                'That\'s interesting. Tell me more.',
                'How would you handle this situation?',
                'What is your experience with this?',
                'Please explain your thought process.',
                'Good. Let\'s move to the next question.'
            ];
            
            const selectedResponse = prompt(`Select a quick response:\n\n${responses.map((r, i) => `${i + 1}. ${r}`).join('\n')}\n\nEnter number (1-${responses.length}) or type custom message:`);
            
            if (selectedResponse) {
                let messageText = '';
                const responseNum = parseInt(selectedResponse);
                
                if (responseNum >= 1 && responseNum <= responses.length) {
                    messageText = responses[responseNum - 1];
                } else {
                    messageText = selectedResponse;
                }
                
                const message = {
                    text: messageText,
                    sender: 'officer',
                    senderId: 'admin_officer',
                    timestamp: Date.now(),
                    highlighted: false,
                    isQuickResponse: true
                };
                
                try {
                    await rtdb.ref(`chats/${currentChatId}/messages`).push(message);
                } catch (error) {
                    console.error('Error sending quick response:', error);
                }
            }
        }

        // End interview
        async function endInterview() {
            if (!currentChatId) return;
            
            if (confirm('Are you sure you want to end this interview? This will generate the final chartsheet.')) {
                // Stop timer if running
                if (chatTimer) {
                    toggleChatTimer();
                }
                
                // Send end interview message
                sendSystemMessage('üèÅ Interview ended by officer. Generating final report...');
                
                // Generate comprehensive chartsheet
                await generateFinalChartsheet();
                
                // Close chat modal
                setTimeout(() => {
                    closeChatModal();
                    alert('Interview completed successfully! Chartsheet has been generated.');
                }, 2000);
            }
        }

        // Send system message
        async function sendSystemMessage(text) {
            if (!currentChatId) return;
            
            const message = {
                text: text,
                sender: 'system',
                senderId: 'system',
                timestamp: Date.now(),
                highlighted: false,
                isSystemMessage: true
            };
            
            try {
                await rtdb.ref(`chats/${currentChatId}/messages`).push(message);
            } catch (error) {
                console.error('Error sending system message:', error);
            }
        }

        // Generate final chartsheet
        async function generateFinalChartsheet() {
            try {
                // Get all chat messages
                const messagesSnapshot = await rtdb.ref(`chats/${currentChatId}/messages`).once('value');
                const messages = messagesSnapshot.val() || {};
                
                // Calculate interview duration
                const timerDisplay = document.getElementById('chatTimer');
                const interviewDuration = timerDisplay.textContent;
                
                // Extract Q&A pairs and scores
                const questionsAnswers = [];
                const messageArray = Object.values(messages);
                let currentQuestion = null;
                let totalScore = 0;
                let scoredAnswers = 0;
                
                messageArray.forEach((message, index) => {
                    if (message.sender === 'officer' && message.text.includes('?')) {
                        currentQuestion = message.text;
                    } else if (message.sender === 'candidate' && currentQuestion) {
                        const qa = {
                            question: currentQuestion,
                            answer: message.text,
                            highlighted: message.highlighted || false,
                            timestamp: message.timestamp
                        };
                        
                        // Look for score in next few messages
                        for (let i = index + 1; i < Math.min(index + 5, messageArray.length); i++) {
                            const nextMsg = messageArray[i];
                            if (nextMsg.isScore && nextMsg.scoreValue !== undefined) {
                                qa.score = nextMsg.scoreValue;
                                totalScore += nextMsg.scoreValue;
                                scoredAnswers++;
                                break;
                            }
                        }
                        
                        questionsAnswers.push(qa);
                        currentQuestion = null;
                    }
                });
                
                // Calculate overall score
                const overallScore = scoredAnswers > 0 ? Math.round((totalScore / scoredAnswers) * 10) : 0;
                
                // Determine final result
                let finalResult = 'Pending';
                if (overallScore >= 70) finalResult = 'Selected';
                else if (overallScore >= 50) finalResult = 'Waitlist';
                else finalResult = 'Rejected';
                
                // Get application data
                const app = applicationsData.find(a => a.id === currentChatId);
                
                // Create comprehensive chartsheet
                const chartsheet = {
                    applicationId: currentChatId,
                    candidateName: app?.candidateName || 'N/A',
                    interviewDate: new Date().toLocaleDateString(),
                    interviewTime: new Date().toLocaleTimeString(),
                    interviewDuration: interviewDuration,
                    interviewOfficer: 'Admin Officer',
                    overallScore: overallScore,
                    finalResult: finalResult,
                    questionsAnswers: questionsAnswers,
                    interviewNotes: interviewNotes,
                    totalQuestions: questionsAnswers.length,
                    scoredAnswers: scoredAnswers,
                    highlightedAnswers: questionsAnswers.filter(qa => qa.highlighted).length,
                    recommendation: finalResult === 'Selected' ? 'Strongly recommended for selection' : 
                                  finalResult === 'Waitlist' ? 'Conditionally recommended' : 'Not recommended',
                    finalComments: `Interview conducted successfully. Candidate answered ${questionsAnswers.length} questions with an average score of ${scoredAnswers > 0 ? (totalScore/scoredAnswers).toFixed(1) : 'N/A'}/10.`,
                    generatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Update application with chartsheet
                await db.collection('applications').doc(currentChatId).update({
                    interviewCompleted: true,
                    interviewCompletedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    chartsheet: chartsheet,
                    status: finalResult === 'Selected' ? 'approved' : finalResult === 'Waitlist' ? 'frozen' : 'rejected',
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('Chartsheet generated successfully');
                
            } catch (error) {
                console.error('Error generating chartsheet:', error);
                alert('Error generating chartsheet. Please try again.');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-focus on email input
            document.getElementById('adminEmail').focus();
        });
    </script>
</body>
</html>
